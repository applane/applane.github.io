(function(){"use strict";class xl{_callback;_targets=new Set;constructor(e){this._callback=e,window.addEventListener("resize",this._onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}_onWindowResize(){const e=[];for(const t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}class Nl{_callback;_elements=[];_timer=null;constructor(e){this._callback=e,window.addEventListener("resize",()=>this._check,!0),document.addEventListener("scroll",()=>this._check,!0)}_check(){this._timer||(this._timer=setTimeout(()=>{this._doCheck(),this._timer=null},100))}observe(e){this._elements.indexOf(e)>=0||(this._elements.push(e),this._check())}unobserve(e){this._elements=this._elements.filter(t=>t!==e)}_doCheck(){const e=[];for(const t of this._elements){const s=t.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&e.push({target:t,isIntersecting:!0})}e.length&&this._callback(e,this)}}typeof Symbol.dispose>"u"&&(Symbol.dispose=Symbol("Symbol.dispose")),typeof window<"u"&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=xl),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=Nl),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...a){this.innerHTML="",this.append(...a)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(a,e){return this.replace(new RegExp(a,"g"),e)});var Oe;(function(a){a[a.General=0]="General",a[a.Format=1]="Format",a[a.AlphaTex=2]="AlphaTex"})(Oe||(Oe={}));class Ve extends Error{type;constructor(e,t="",s){super(t??"",{cause:s}),this.type=e}}class Ei{static version="1.7.1";static date="2025-12-02T16:54:46.381Z";static commit="e487b958158892679a115693547661dc49a78e16";static print(e){e(`alphaTab ${Ei.version}`),e(`commit: ${Ei.commit}`),e(`build date: ${Ei.date}`)}}var Z;(function(a){a[a.PPP=0]="PPP",a[a.PP=1]="PP",a[a.P=2]="P",a[a.MP=3]="MP",a[a.MF=4]="MF",a[a.F=5]="F",a[a.FF=6]="FF",a[a.FFF=7]="FFF",a[a.PPPP=8]="PPPP",a[a.PPPPP=9]="PPPPP",a[a.PPPPPP=10]="PPPPPP",a[a.FFFF=11]="FFFF",a[a.FFFFF=12]="FFFFF",a[a.FFFFFF=13]="FFFFFF",a[a.SF=14]="SF",a[a.SFP=15]="SFP",a[a.SFPP=16]="SFPP",a[a.FP=17]="FP",a[a.RF=18]="RF",a[a.RFZ=19]="RFZ",a[a.SFZ=20]="SFZ",a[a.SFFZ=21]="SFFZ",a[a.FZ=22]="FZ",a[a.N=23]="N",a[a.PF=24]="PF",a[a.SFZP=25]="SFZP"})(Z||(Z={}));class x{static QuarterTime=960;static _minVelocity=15;static VelocityIncrement=16;static ticksToMillis(e,t){return e*(6e4/(t*x.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*x.QuarterTime))|0}static toTicks(e){return x.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),x.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+(e/4|0)*3:e+(e/2|0)}static applyTuplet(e,t,s){return e*s/t|0}static removeTuplet(e,t,s){return e*t/s|0}static dynamicToVelocity(e,t=0){let s=1;switch(e){case Z.PPP:s=x._minVelocity+0*x.VelocityIncrement;break;case Z.PP:s=x._minVelocity+1*x.VelocityIncrement;break;case Z.P:s=x._minVelocity+2*x.VelocityIncrement;break;case Z.MP:s=x._minVelocity+3*x.VelocityIncrement;break;case Z.MF:s=x._minVelocity+4*x.VelocityIncrement;break;case Z.F:s=x._minVelocity+5*x.VelocityIncrement;break;case Z.FF:s=x._minVelocity+6*x.VelocityIncrement;break;case Z.FFF:s=x._minVelocity+7*x.VelocityIncrement;break;case Z.PPPP:s=10;break;case Z.PPPPP:s=5;break;case Z.PPPPPP:s=3;break;case Z.FFFF:s=x._minVelocity+8*x.VelocityIncrement;break;case Z.FFFFF:s=x._minVelocity+9*x.VelocityIncrement;break;case Z.FFFFFF:s=x._minVelocity+10*x.VelocityIncrement;break;case Z.SF:case Z.SFP:case Z.SFZP:case Z.SFPP:case Z.SFZ:case Z.FZ:s=x._minVelocity+6*x.VelocityIncrement;break;case Z.FP:s=x._minVelocity+5*x.VelocityIncrement;break;case Z.RF:case Z.RFZ:case Z.SFFZ:s=x._minVelocity+5*x.VelocityIncrement;break;case Z.N:s=1;break;case Z.PF:s=x._minVelocity+(4.5*x.VelocityIncrement|0);break}return s+=t*x.VelocityIncrement,Math.min(Math.max(s,1),127)}}var De;(function(a){a[a.Tempo=0]="Tempo",a[a.Volume=1]="Volume",a[a.Instrument=2]="Instrument",a[a.Balance=3]="Balance",a[a.SyncPoint=4]="SyncPoint",a[a.Bank=4]="Bank"})(De||(De={}));class Ur{barOccurence=0;millisecondOffset=0}class Ye{isLinear=!1;type=De.Tempo;value=0;syncPointValue;ratioPosition=0;text="";isVisible=!0;static buildTempoAutomation(e,t,s,i,r=!0){(i<1||i>5)&&(i=2);const n=new Float32Array([1,.5,1,1.5,2,3]),o=new Ye;return o.type=De.Tempo,o.isLinear=e,o.ratioPosition=t,o.value=s*n[i],o.isVisible=r,o}static buildInstrumentAutomation(e,t,s){const i=new Ye;return i.type=De.Instrument,i.isLinear=e,i.ratioPosition=t,i.value=s,i}}class H{static MaxPosition=60;static MaxValue=12;offset;value;constructor(e=0,t=0){this.offset=e,this.value=t}}var ze;(function(a){a[a.Default=0]="Default",a[a.Gradual=1]="Gradual",a[a.Fast=2]="Fast"})(ze||(ze={}));var q;(function(a){a[a.None=0]="None",a[a.Custom=1]="Custom",a[a.Bend=2]="Bend",a[a.Release=3]="Release",a[a.BendRelease=4]="BendRelease",a[a.Hold=5]="Hold",a[a.Prebend=6]="Prebend",a[a.PrebendBend=7]="PrebendBend",a[a.PrebendRelease=8]="PrebendRelease"})(q||(q={}));var Y;(function(a){a[a.None=0]="None",a[a.BrushUp=1]="BrushUp",a[a.BrushDown=2]="BrushDown",a[a.ArpeggioUp=3]="ArpeggioUp",a[a.ArpeggioDown=4]="ArpeggioDown"})(Y||(Y={}));var Lt;(function(a){a[a.None=0]="None",a[a.Crescendo=1]="Crescendo",a[a.Decrescendo=2]="Decrescendo"})(Lt||(Lt={}));var y;(function(a){a[a.QuadrupleWhole=-4]="QuadrupleWhole",a[a.DoubleWhole=-2]="DoubleWhole",a[a.Whole=1]="Whole",a[a.Half=2]="Half",a[a.Quarter=4]="Quarter",a[a.Eighth=8]="Eighth",a[a.Sixteenth=16]="Sixteenth",a[a.ThirtySecond=32]="ThirtySecond",a[a.SixtyFourth=64]="SixtyFourth",a[a.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",a[a.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"})(y||(y={}));var $;(function(a){a[a.None=0]="None",a[a.OnBeat=1]="OnBeat",a[a.BeforeBeat=2]="BeforeBeat",a[a.BendGrace=3]="BendGrace"})($||($={}));var tt;(function(a){a[a.None=0]="None",a[a.Normal=1]="Normal",a[a.Heavy=2]="Heavy",a[a.Tenuto=3]="Tenuto"})(tt||(tt={}));var j;(function(a){a[a.Unknown=-2]="Unknown",a[a.NoOrDead=-1]="NoOrDead",a[a.Thumb=0]="Thumb",a[a.IndexFinger=1]="IndexFinger",a[a.MiddleFinger=2]="MiddleFinger",a[a.AnnularFinger=3]="AnnularFinger",a[a.LittleFinger=4]="LittleFinger"})(j||(j={}));var Q;(function(a){a[a.None=0]="None",a[a.Natural=1]="Natural",a[a.Artificial=2]="Artificial",a[a.Pinch=3]="Pinch",a[a.Tap=4]="Tap",a[a.Semi=5]="Semi",a[a.Feedback=6]="Feedback"})(Q||(Q={}));var re;(function(a){a[a.Default=0]="Default",a[a.ForceNone=1]="ForceNone",a[a.ForceNatural=2]="ForceNatural",a[a.ForceSharp=3]="ForceSharp",a[a.ForceDoubleSharp=4]="ForceDoubleSharp",a[a.ForceFlat=5]="ForceFlat",a[a.ForceDoubleFlat=6]="ForceDoubleFlat"})(re||(re={}));var ae;(function(a){a[a._15ma=0]="_15ma",a[a._8va=1]="_8va",a[a.Regular=2]="Regular",a[a._8vb=3]="_8vb",a[a._15mb=4]="_15mb"})(ae||(ae={}));var dt;(function(a){a[a.None=0]="None",a[a.IntoFromBelow=1]="IntoFromBelow",a[a.IntoFromAbove=2]="IntoFromAbove"})(dt||(dt={}));var ne;(function(a){a[a.None=0]="None",a[a.Shift=1]="Shift",a[a.Legato=2]="Legato",a[a.OutUp=3]="OutUp",a[a.OutDown=4]="OutDown",a[a.PickSlideDown=5]="PickSlideDown",a[a.PickSlideUp=6]="PickSlideUp"})(ne||(ne={}));var be;(function(a){a[a.None=0]="None",a[a.Slight=1]="Slight",a[a.Wide=2]="Wide"})(be||(be={}));var ks;(function(a){a[a.Hidden=0]="Hidden",a[a.ShowWithBeams=1]="ShowWithBeams",a[a.ShowWithBars=2]="ShowWithBars",a[a.Automatic=3]="Automatic"})(ks||(ks={}));var Cs;(function(a){a[a.ScoreDefault=0]="ScoreDefault",a[a.ScoreForcePiano=1]="ScoreForcePiano",a[a.SingleNoteEffectBand=2]="SingleNoteEffectBand",a[a.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano"})(Cs||(Cs={}));var Et;(function(a){a[a.GuitarPro=0]="GuitarPro",a[a.SongBook=1]="SongBook"})(Et||(Et={}));var fe;(function(a){a[a.ScoreTitle=0]="ScoreTitle",a[a.ScoreSubTitle=1]="ScoreSubTitle",a[a.ScoreArtist=2]="ScoreArtist",a[a.ScoreAlbum=3]="ScoreAlbum",a[a.ScoreWords=4]="ScoreWords",a[a.ScoreMusic=5]="ScoreMusic",a[a.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",a[a.ScoreCopyright=7]="ScoreCopyright",a[a.GuitarTuning=8]="GuitarTuning",a[a.TrackNames=9]="TrackNames",a[a.ChordDiagrams=10]="ChordDiagrams",a[a.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",a[a.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",a[a.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",a[a.EffectAlternateEndings=14]="EffectAlternateEndings",a[a.EffectCapo=15]="EffectCapo",a[a.EffectChordNames=16]="EffectChordNames",a[a.EffectCrescendo=17]="EffectCrescendo",a[a.EffectDynamics=18]="EffectDynamics",a[a.EffectFadeIn=19]="EffectFadeIn",a[a.EffectFermata=20]="EffectFermata",a[a.EffectFingering=21]="EffectFingering",a[a.EffectHarmonics=22]="EffectHarmonics",a[a.EffectLetRing=23]="EffectLetRing",a[a.EffectLyrics=24]="EffectLyrics",a[a.EffectMarker=25]="EffectMarker",a[a.EffectOttavia=26]="EffectOttavia",a[a.EffectPalmMute=27]="EffectPalmMute",a[a.EffectPickSlide=28]="EffectPickSlide",a[a.EffectPickStroke=29]="EffectPickStroke",a[a.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",a[a.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",a[a.EffectTap=32]="EffectTap",a[a.EffectTempo=33]="EffectTempo",a[a.EffectText=34]="EffectText",a[a.EffectTrill=35]="EffectTrill",a[a.EffectTripletFeel=36]="EffectTripletFeel",a[a.EffectWhammyBar=37]="EffectWhammyBar",a[a.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",a[a.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",a[a.EffectLeftHandTap=40]="EffectLeftHandTap",a[a.EffectFreeTime=41]="EffectFreeTime",a[a.EffectSustainPedal=42]="EffectSustainPedal",a[a.EffectGolpe=43]="EffectGolpe",a[a.EffectWahPedal=44]="EffectWahPedal",a[a.EffectBeatBarre=45]="EffectBeatBarre",a[a.EffectNoteOrnament=46]="EffectNoteOrnament",a[a.EffectRasgueado=47]="EffectRasgueado",a[a.EffectDirections=48]="EffectDirections",a[a.EffectBeatTimer=49]="EffectBeatTimer"})(fe||(fe={}));class zr{notationMode=Et.GuitarPro;fingeringMode=Cs.ScoreDefault;elements=new Map;static defaultElements=new Map([[fe.ZerosOnDiveWhammys,!1]]);rhythmMode=ks.Automatic;rhythmHeight=15;transpositionPitches=[];displayTranspositionPitches=[];smallGraceTabNotes=!0;extendBendArrowsOnTiedNotes=!0;extendLineEffectsToBeatEnd=!1;slurHeight=5;isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):zr.defaultElements.has(e)?zr.defaultElements.get(e):!0}}class Ji{_factory;_value=void 0;get hasValue(){return this._value!==void 0}constructor(e){this._factory=e}get value(){return this._value===void 0&&(this._value=this._factory()),this._value}reset(){this._value=void 0}}var Es;(function(a){a[a.None=0]="None",a[a.Debug=1]="Debug",a[a.Info=2]="Info",a[a.Warning=3]="Warning",a[a.Error=4]="Error"})(Es||(Es={}));class $i{static logLevel=Es.Info;static _format(e,t){return`[AlphaTab][${e}] ${t}`}debug(e,t,...s){console.debug($i._format(e,t),...s)}warning(e,t,...s){console.warn($i._format(e,t),...s)}info(e,t,...s){console.info($i._format(e,t),...s)}error(e,t,...s){console.error($i._format(e,t),...s)}}class E{static logLevel=Es.Info;static log=new $i;static _shouldLog(e){return E.logLevel!==Es.None&&e>=E.logLevel}static debug(e,t,...s){E._shouldLog(Es.Debug)&&E.log.debug(e,t,...s)}static warning(e,t,...s){E._shouldLog(Es.Warning)&&E.log.warning(e,t,...s)}static info(e,t,...s){E._shouldLog(Es.Info)&&E.log.info(e,t,...s)}static error(e,t,...s){E._shouldLog(Es.Error)&&E.log.error(e,t,...s)}}var vi;(function(a){a[a.NoBrackets=0]="NoBrackets",a[a.GroupStaves=1]="GroupStaves",a[a.GroupSimilarInstruments=2]="GroupSimilarInstruments"})(vi||(vi={}));var lt;(function(a){a[a.Hidden=0]="Hidden",a[a.FirstSystem=1]="FirstSystem",a[a.AllSystems=2]="AllSystems"})(lt||(lt={}));var Wt;(function(a){a[a.FullName=0]="FullName",a[a.ShortName=1]="ShortName"})(Wt||(Wt={}));var Ot;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical"})(Ot||(Ot={}));class Pl{hideDynamics=!1;bracketExtendMode=vi.GroupStaves;useSystemSignSeparator=!1;globalDisplayTuning=!0;perTrackDisplayTuning=null;globalDisplayChordDiagramsOnTop=!0;perTrackChordDiagramsOnTop=null;singleTrackTrackNamePolicy=lt.FirstSystem;multiTrackTrackNamePolicy=lt.FirstSystem;firstSystemTrackNameMode=Wt.ShortName;otherSystemsTrackNameMode=Wt.ShortName;firstSystemTrackNameOrientation=Ot.Vertical;otherSystemsTrackNameOrientation=Ot.Vertical;multiTrackMultiBarRest=!1;perTrackMultiBarRest=null}class Rn{masterBars=[];opening=null;get openings(){const e=this.opening;return e?[e]:[]}closings=[];get isOpened(){return this.opening?.isRepeatStart===!0}isClosed=!1;addMasterBar(e){this.opening===null&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}}class qi{colors=new Map}var Te;(function(a){a[a.Neutral=0]="Neutral",a[a.C3=1]="C3",a[a.C4=2]="C4",a[a.F4=3]="F4",a[a.G2=4]="G2"})(Te||(Te={}));var _t;(function(a){a[a.None=0]="None",a[a.Simple=1]="Simple",a[a.FirstOfDouble=2]="FirstOfDouble",a[a.SecondOfDouble=3]="SecondOfDouble"})(_t||(_t={}));var He;(function(a){a[a.Cb=-7]="Cb",a[a.Gb=-6]="Gb",a[a.Db=-5]="Db",a[a.Ab=-4]="Ab",a[a.Eb=-3]="Eb",a[a.Bb=-2]="Bb",a[a.F=-1]="F",a[a.C=0]="C",a[a.G=1]="G",a[a.D=2]="D",a[a.A=3]="A",a[a.E=4]="E",a[a.B=5]="B",a[a.FSharp=6]="FSharp",a[a.CSharp=7]="CSharp"})(He||(He={}));var Qt;(function(a){a[a.Major=0]="Major",a[a.Minor=1]="Minor"})(Qt||(Qt={}));var qe;(function(a){a[a.Down=0]="Down",a[a.Hold=1]="Hold",a[a.Up=2]="Up"})(qe||(qe={}));class ci{ratioPosition=0;pedalType=qe.Down;bar;nextPedalMarker=null;previousPedalMarker=null}var Pe;(function(a){a[a.StandardNotationRepeats=0]="StandardNotationRepeats",a[a.GuitarTabsRepeats=1]="GuitarTabsRepeats",a[a.SlashRepeats=2]="SlashRepeats",a[a.NumberedRepeats=3]="NumberedRepeats",a[a.StandardNotationBarNumber=4]="StandardNotationBarNumber",a[a.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",a[a.SlashBarNumber=6]="SlashBarNumber",a[a.NumberedBarNumber=7]="NumberedBarNumber",a[a.StandardNotationBarLines=8]="StandardNotationBarLines",a[a.GuitarTabsBarLines=9]="GuitarTabsBarLines",a[a.SlashBarLines=10]="SlashBarLines",a[a.NumberedBarLines=11]="NumberedBarLines",a[a.StandardNotationClef=12]="StandardNotationClef",a[a.GuitarTabsClef=13]="GuitarTabsClef",a[a.StandardNotationKeySignature=14]="StandardNotationKeySignature",a[a.NumberedKeySignature=15]="NumberedKeySignature",a[a.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",a[a.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",a[a.SlashTimeSignature=18]="SlashTimeSignature",a[a.NumberedTimeSignature=19]="NumberedTimeSignature",a[a.StandardNotationStaffLine=20]="StandardNotationStaffLine",a[a.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",a[a.SlashStaffLine=22]="SlashStaffLine",a[a.NumberedStaffLine=23]="NumberedStaffLine"})(Pe||(Pe={}));class Cl extends qi{}var ce;(function(a){a[a.Automatic=0]="Automatic",a[a.Dashed=1]="Dashed",a[a.Dotted=2]="Dotted",a[a.Heavy=3]="Heavy",a[a.HeavyHeavy=4]="HeavyHeavy",a[a.HeavyLight=5]="HeavyLight",a[a.LightHeavy=6]="LightHeavy",a[a.LightLight=7]="LightLight",a[a.None=8]="None",a[a.Regular=9]="Regular",a[a.Short=10]="Short",a[a.Tick=11]="Tick"})(ce||(ce={}));class Kt{static _globalBarId=0;static resetIds(){Kt._globalBarId=0}id=Kt._globalBarId++;index=0;nextBar=null;previousBar=null;clef=Te.G2;clefOttava=ae.Regular;staff;voices=[];simileMark=_t.None;_filledVoices=new Set([0]);get isMultiVoice(){return this._filledVoices.size>1}get filledVoices(){return this._filledVoices}displayScale=1;displayWidth=-1;sustainPedals=[];get masterBar(){return this.staff.track.score.masterBars[this.index]}_isEmpty=!0;_isRestOnly=!0;get isEmpty(){return this._isEmpty}get hasChanges(){return this.index===0||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava?!0:this.simileMark!==_t.None||this.sustainPedals.length>0||this.barLineLeft!==ce.Automatic||this.barLineRight!==ce.Automatic}get isRestOnly(){return this._isRestOnly}barLineLeft=ce.Automatic;barLineRight=ce.Automatic;keySignature=He.C;keySignatureType=Qt.Major;getActualBarLineLeft(e){return Kt._actualBarLine(this,!1,e)}getActualBarLineRight(){return Kt._actualBarLine(this,!0,!1)}static _automaticToActualType(e,t,s){let i;return t?e.isRepeatEnd?i=ce.LightHeavy:e.nextMasterBar?e.isFreeTime?i=ce.Dashed:e.isDoubleBar?i=ce.LightLight:i=ce.Regular:i=ce.LightHeavy:e.isRepeatStart?i=ce.HeavyLight:s?i=ce.Regular:i=ce.None,i}static _actualBarLine(e,t,s){const i=e.masterBar,r=t?e.barLineRight:e.barLineLeft;let n;return r===ce.Automatic?n=Kt._automaticToActualType(i,t,s):n=r,n}style;addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,t=null){this._filledVoices.clear(),this._filledVoices.add(0),this._isEmpty=!0,this._isRestOnly=!0;for(let i=0,r=this.voices.length;i<r;i++){const n=this.voices[i];n.finish(e,t),n.isEmpty||(this._isEmpty=!1,this._filledVoices.add(i)),n.isRestOnly||(this._isRestOnly=!1)}const s=this.sustainPedals;if(s.length>0){let i=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(i=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1],i.pedalType===qe.Up&&(i=null));const r=i!==null&&i.pedalType!==qe.Up;for(const n of s){if(i&&i.pedalType!==qe.Up){if(i.bar===this&&n.ratioPosition<=i.ratioPosition)continue;i.nextPedalMarker=n,n.previousPedalMarker=i}r&&n.pedalType===qe.Down&&(n.pedalType=qe.Hold),n.bar=this,this.sustainPedals.push(n),i=n}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const i=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(i.pedalType!==qe.Up){const r=new ci;r.ratioPosition=0,r.bar=this,r.pedalType=qe.Hold,this.sustainPedals.push(r),i.nextPedalMarker=r,r.previousPedalMarker=i}}}calculateDuration(){let e=0;for(const t of this.voices){const s=t.calculateDuration();s>e&&(e=s)}return e}}class qa{beats=[];id="empty";isComplete=!1;addBeat(e){e.graceIndex=this.beats.length,e.graceGroup=this,this.beats.push(e)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}var lr;(function(a){a[a.Glyphs=0]="Glyphs"})(lr||(lr={}));class El extends qi{}let hs=class In{_beatLookup;_isEmpty=!0;_isRestOnly=!0;static _globalVoiceId=0;static resetIds(){In._globalVoiceId=0}id=In._globalVoiceId++;index=0;bar;beats=[];get isEmpty(){return this._isEmpty}style;forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}_chain(e,t=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){const s=this.bar.nextBar.voices[this.index];s.beats.length>0&&(e.nextBeat=s.beats[0]),e.nextBeat.previousBeat=e}e.chain(t)}}addGraceBeat(e){if(this.beats.length===0){this.addBeat(e);return}const t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,t=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let s=null;for(let n=0;n<this.beats.length;n++){const o=this.beats[n];o.index=n,this._chain(o,t),o.graceType===$.None?(o.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new qa),s.addBeat(o)),o.isEmpty||(this._isEmpty=!1),o.isRest||(this._isRestOnly=!1)}let i=0,r=0;for(let n=0;n<this.beats.length;n++){const o=this.beats[n];if(o.index=n,o.finish(e,t),o.graceType===$.None){if(o.graceGroup){const l=o.graceGroup.beats[0],h=o.graceGroup.beats[o.graceGroup.beats.length-1];if(l.graceType!==$.BendGrace){const c=h.playbackStart+h.playbackDuration-l.playbackStart;switch(l.graceType){case $.BeforeBeat:l.previousBeat?(l.previousBeat.playbackDuration-=c,l.previousBeat.voice===this?r=l.previousBeat.playbackStart+l.previousBeat.playbackDuration:r=-c):r=-c;for(const d of o.graceGroup.beats)this._beatLookup.delete(d.playbackStart),d.playbackStart=r,this._beatLookup.set(d.playbackStart,o),r+=d.playbackDuration;break;case $.OnBeat:o.playbackDuration-=c,h.voice===this?r=h.playbackStart+h.playbackDuration:r=-c;break}}}o.displayStart=i,o.playbackStart=r,this._beatLookup.set(o.playbackStart,o)}else o.displayStart=i,o.playbackStart=r;o.fermata?this.bar.masterBar.addFermata(o.playbackStart,o.fermata):o.fermata=this.bar.masterBar.getFermata(o),o.finishTuplet(),o.graceGroup&&o.graceGroup.finish(),i+=o.displayDuration,r+=o.playbackDuration}}calculateDuration(){if(this.isEmpty||this.beats.length===0)return 0;const e=this.beats[this.beats.length-1],t=this.beats[0];return e.playbackStart+e.playbackDuration-t.playbackStart}};var X;(function(a){a[a.Left=0]="Left",a[a.Center=1]="Center",a[a.Right=2]="Right"})(X||(X={}));var Re;(function(a){a[a.Top=0]="Top",a[a.Middle=1]="Middle",a[a.Bottom=2]="Bottom",a[a.Alphabetic=3]="Alphabetic"})(Re||(Re={}));class Yr{width;height;constructor(e,t){this.width=e,this.height=t}}class rt{static fillMusicFontSymbolSafe(e,t,s,i,r,n){e.settings.display.resources.engravingSettings.hasSymbol(r)&&e.fillMusicFontSymbol(t,s,i,r,n)}static fillMusicFontSymbolsSafe(e,t,s,i,r,n){const o=r.filter(l=>e.settings.display.resources.engravingSettings.hasSymbol(l));o.length!==0&&e.fillMusicFontSymbols(t,s,i,o,n)}}var O;(function(a){a[a.Title=0]="Title",a[a.SubTitle=1]="SubTitle",a[a.Artist=2]="Artist",a[a.Album=3]="Album",a[a.Words=4]="Words",a[a.Music=5]="Music",a[a.WordsAndMusic=6]="WordsAndMusic",a[a.Transcriber=7]="Transcriber",a[a.Copyright=8]="Copyright",a[a.CopyrightSecondLine=9]="CopyrightSecondLine",a[a.ChordDiagramList=10]="ChordDiagramList"})(O||(O={}));class is{template;isVisible;textAlign;constructor(e="",t=void 0,s=X.Left){this.template=e,this.isVisible=t,this.textAlign=s}static equals(e,t){const s=e.isVisible!==void 0?e.isVisible:!0,i=t.isVisible!==void 0?t.isVisible:!0;return!(s!==i||e.template!==t.template||e.textAlign!==t.textAlign)}buildText(e){let t=!1,s=!1;const i=this.template.replace(is._placeholderPattern,(r,n)=>{s=!0;let o="";switch(n){case"TITLE":o=e.title;break;case"SUBTITLE":o=e.subTitle;break;case"ARTIST":o=e.artist;break;case"ALBUM":o=e.album;break;case"WORDS":case"WORDSMUSIC":o=e.words;break;case"MUSIC":o=e.music;break;case"TABBER":o=e.tab;break;case"COPYRIGHT":o=e.copyright;break;default:o="";break}return o&&(t=!0),o});return s&&!t?"":i}static _placeholderPattern=/%([^%]+)%/g}class Di extends qi{headerAndFooter=new Map;static defaultHeaderAndFooter=new Map([[O.Title,new is("%TITLE%",void 0,X.Center)],[O.SubTitle,new is("%SUBTITLE%",void 0,X.Center)],[O.Artist,new is("%ARTIST%",void 0,X.Center)],[O.Album,new is("%ALBUM%",void 0,X.Center)],[O.Words,new is("Words by %WORDS%",void 0,X.Left)],[O.Music,new is("Music by %MUSIC%",void 0,X.Right)],[O.WordsAndMusic,new is("Words & Music by %MUSIC%",void 0,X.Right)],[O.Transcriber,new is("Tabbed by %TABBER%",!1,X.Right)],[O.Copyright,new is("%COPYRIGHT%",void 0,X.Center)],[O.CopyrightSecondLine,new is("All Rights Reserved - International Copyright Secured",!0,X.Center)]])}class Ws{_currentRepeatGroup=null;_openedRepeatGroups=[];_properlyOpenedRepeatGroups=0;static resetIds(){Kt.resetIds(),wt.resetIds(),hs.resetIds(),mt.resetIds()}album="";artist="";copyright="";instructions="";music="";notices="";subTitle="";title="";words="";tab="";get tempo(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].value:120}get tempoLabel(){return this.masterBars.length&&this.masterBars[0].tempoAutomations.length>0?this.masterBars[0].tempoAutomations[0].text:""}masterBars=[];tracks=[];defaultSystemsLayout=3;systemsLayout=[];stylesheet=new Pl;backingTrack;style;rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const e of this.masterBars)this._addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,this.masterBars.length!==0&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this._addMasterBarToRepeatGroups(e),this.masterBars.push(e)}_addMasterBarToRepeatGroups(e){e.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new Rn,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new Rn,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){const t=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(e,t)}applyFlatSyncPoints(e){for(const t of this.masterBars)t.syncPoints=void 0;for(const t of e){const s=new Ye;s.ratioPosition=Math.min(1,Math.max(0,t.barPosition)),s.type=De.SyncPoint,s.syncPointValue=new Ur,s.syncPointValue.millisecondOffset=t.millisecondOffset,s.syncPointValue.barOccurence=t.barOccurence,t.barIndex<this.masterBars.length&&this.masterBars[t.barIndex].addSyncPoint(s)}for(const t of this.masterBars)t.syncPoints&&t.syncPoints.sort((s,i)=>{const r=s.syncPointValue.barOccurence-i.syncPointValue.barOccurence;return r!==0?r:s.ratioPosition-i.ratioPosition})}exportFlatSyncPoints(){const e=[];for(const t of this.masterBars){const s=t.syncPoints;if(s)for(const i of s)e.push({barIndex:t.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return e}}var Be;(function(a){a[a.NoTripletFeel=0]="NoTripletFeel",a[a.Triplet16th=1]="Triplet16th",a[a.Triplet8th=2]="Triplet8th",a[a.Dotted16th=3]="Dotted16th",a[a.Dotted8th=4]="Dotted8th",a[a.Scottish16th=5]="Scottish16th",a[a.Scottish8th=6]="Scottish8th"})(Be||(Be={}));class Os{static MaxAlternateEndings=8;alternateEndings=0;nextMasterBar=null;previousMasterBar=null;index=0;get hasChanges(){return this.index===0?!1:this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel?!0:this.alternateEndings!==0||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||this.fermata!==null&&this.fermata.size>0||this.directions!==null&&this.directions.size>0||this.isAnacrusis}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}isDoubleBar=!1;isRepeatStart=!1;get isRepeatEnd(){return this.repeatCount>0}repeatCount=0;repeatGroup;timeSignatureNumerator=4;timeSignatureDenominator=4;timeSignatureCommon=!1;isFreeTime=!1;tripletFeel=Be.NoTripletFeel;section=null;get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}tempoAutomations=[];syncPoints;score;fermata=null;start=0;isAnacrusis=!1;displayScale=1;displayWidth=-1;directions=null;calculateDuration(e=!0){if(this.isAnacrusis&&e){let t=0;for(const s of this.score.tracks)for(const i of s.staves){const r=this.index<i.bars.length?i.bars[this.index].calculateDuration():0;r>t&&(t=r)}return t}return this.timeSignatureNumerator*x.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let s=this.fermata;s===null&&(s=new Map,this.fermata=s),s.set(e,t)}addDirection(e){this.directions==null&&(this.directions=new Set),this.directions.add(e)}getFermata(e){const t=this.fermata;return t===null?null:t.has(e.playbackStart)?t.get(e.playbackStart):e.index===0&&t.has(0)?t.get(0):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}}class oe{static DefaultChannelCount=17;static MetronomeChannel=oe.DefaultChannelCount-1;static MetronomeKey=33;static AudioChannels=2;static MinVolume=0;static MinProgram=0;static MaxProgram=127;static MinPlaybackSpeed=.125;static MaxPlaybackSpeed=8;static PercussionChannel=9;static PercussionBank=128;static MaxPitchWheel=16384;static MaxPitchWheel20=4294967296;static DefaultPitchWheel=oe.MaxPitchWheel/2;static MicroBufferCount=32;static MicroBufferSize=64}var u;(function(a){a[a.None=-1]="None",a[a.Space=32]="Space",a[a.Brace=57344]="Brace",a[a.BracketTop=57347]="BracketTop",a[a.BracketBottom=57348]="BracketBottom",a[a.SystemDivider=57351]="SystemDivider",a[a.GClef=57424]="GClef",a[a.GClef15mb=57425]="GClef15mb",a[a.GClef8vb=57426]="GClef8vb",a[a.GClef8va=57427]="GClef8va",a[a.GClef15ma=57428]="GClef15ma",a[a.CClef=57436]="CClef",a[a.CClef8vb=57437]="CClef8vb",a[a.FClef=57442]="FClef",a[a.FClef15mb=57443]="FClef15mb",a[a.FClef8vb=57444]="FClef8vb",a[a.FClef8va=57445]="FClef8va",a[a.FClef15ma=57446]="FClef15ma",a[a.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",a[a.SixStringTabClef=57453]="SixStringTabClef",a[a.FourStringTabClef=57454]="FourStringTabClef",a[a.Clef8=57469]="Clef8",a[a.Clef15=57470]="Clef15",a[a.TimeSig0=57472]="TimeSig0",a[a.TimeSig1=57473]="TimeSig1",a[a.TimeSig2=57474]="TimeSig2",a[a.TimeSig3=57475]="TimeSig3",a[a.TimeSig4=57476]="TimeSig4",a[a.TimeSig5=57477]="TimeSig5",a[a.TimeSig6=57478]="TimeSig6",a[a.TimeSig7=57479]="TimeSig7",a[a.TimeSig8=57480]="TimeSig8",a[a.TimeSig9=57481]="TimeSig9",a[a.TimeSigCommon=57482]="TimeSigCommon",a[a.TimeSigCutCommon=57483]="TimeSigCutCommon",a[a.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",a[a.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",a[a.NoteheadWhole=57506]="NoteheadWhole",a[a.NoteheadHalf=57507]="NoteheadHalf",a[a.NoteheadBlack=57508]="NoteheadBlack",a[a.NoteheadNull=57509]="NoteheadNull",a[a.NoteheadXOrnate=57514]="NoteheadXOrnate",a[a.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",a[a.NoteheadPlusWhole=57517]="NoteheadPlusWhole",a[a.NoteheadPlusHalf=57518]="NoteheadPlusHalf",a[a.NoteheadPlusBlack=57519]="NoteheadPlusBlack",a[a.NoteheadSquareWhite=57528]="NoteheadSquareWhite",a[a.NoteheadSquareBlack=57529]="NoteheadSquareBlack",a[a.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",a[a.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",a[a.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",a[a.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",a[a.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",a[a.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",a[a.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",a[a.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",a[a.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",a[a.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",a[a.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",a[a.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",a[a.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",a[a.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",a[a.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",a[a.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",a[a.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",a[a.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",a[a.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",a[a.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",a[a.NoteheadCircleX=57523]="NoteheadCircleX",a[a.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",a[a.NoteheadXWhole=57511]="NoteheadXWhole",a[a.NoteheadXHalf=57512]="NoteheadXHalf",a[a.NoteheadXBlack=57513]="NoteheadXBlack",a[a.NoteheadParenthesis=57550]="NoteheadParenthesis",a[a.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",a[a.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",a[a.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",a[a.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",a[a.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",a[a.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",a[a.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",a[a.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",a[a.NoteheadCircledBlack=57572]="NoteheadCircledBlack",a[a.NoteheadCircledHalf=57573]="NoteheadCircledHalf",a[a.NoteheadCircledWhole=57574]="NoteheadCircledWhole",a[a.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",a[a.NoteheadCircleSlash=57591]="NoteheadCircleSlash",a[a.NoteheadHeavyX=57592]="NoteheadHeavyX",a[a.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",a[a.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",a[a.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",a[a.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",a[a.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",a[a.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",a[a.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",a[a.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",a[a.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",a[a.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",a[a.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",a[a.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",a[a.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",a[a.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",a[a.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",a[a.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",a[a.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",a[a.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",a[a.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",a[a.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",a[a.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",a[a.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",a[a.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",a[a.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",a[a.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",a[a.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",a[a.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",a[a.NoteQuarterUp=57813]="NoteQuarterUp",a[a.Note8thUp=57815]="Note8thUp",a[a.MetNoteQuarterUp=60581]="MetNoteQuarterUp",a[a.MetNote8thUp=60583]="MetNote8thUp",a[a.MetAugmentationDot=60599]="MetAugmentationDot",a[a.ArrowheadBlackUp=60280]="ArrowheadBlackUp",a[a.ArrowheadBlackDown=60284]="ArrowheadBlackDown",a[a.AugmentationDot=57831]="AugmentationDot",a[a.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",a[a.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",a[a.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",a[a.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",a[a.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",a[a.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",a[a.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",a[a.TextAugmentationDot=57852]="TextAugmentationDot",a[a.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",a[a.TextTuplet3LongStem=57858]="TextTuplet3LongStem",a[a.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",a[a.Tremolo3=57890]="Tremolo3",a[a.Tremolo2=57889]="Tremolo2",a[a.Tremolo1=57888]="Tremolo1",a[a.Flag8thUp=57920]="Flag8thUp",a[a.Flag8thDown=57921]="Flag8thDown",a[a.Flag16thUp=57922]="Flag16thUp",a[a.Flag16thDown=57923]="Flag16thDown",a[a.Flag32ndUp=57924]="Flag32ndUp",a[a.Flag32ndDown=57925]="Flag32ndDown",a[a.Flag64thUp=57926]="Flag64thUp",a[a.Flag64thDown=57927]="Flag64thDown",a[a.Flag128thUp=57928]="Flag128thUp",a[a.Flag128thDown=57929]="Flag128thDown",a[a.Flag256thUp=57930]="Flag256thUp",a[a.Flag256thDown=57931]="Flag256thDown",a[a.AccidentalFlat=57952]="AccidentalFlat",a[a.AccidentalNatural=57953]="AccidentalNatural",a[a.AccidentalSharp=57954]="AccidentalSharp",a[a.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",a[a.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",a[a.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",a[a.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",a[a.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",a[a.RepeatDot=57412]="RepeatDot",a[a.Segno=57415]="Segno",a[a.Coda=57416]="Coda",a[a.ArticAccentAbove=58528]="ArticAccentAbove",a[a.ArticAccentBelow=58529]="ArticAccentBelow",a[a.ArticStaccatoAbove=58530]="ArticStaccatoAbove",a[a.ArticStaccatoBelow=58531]="ArticStaccatoBelow",a[a.ArticTenutoAbove=58532]="ArticTenutoAbove",a[a.ArticTenutoBelow=58533]="ArticTenutoBelow",a[a.ArticMarcatoAbove=58540]="ArticMarcatoAbove",a[a.ArticMarcatoBelow=58541]="ArticMarcatoBelow",a[a.FermataAbove=58560]="FermataAbove",a[a.FermataShortAbove=58564]="FermataShortAbove",a[a.FermataLongAbove=58566]="FermataLongAbove",a[a.RestLonga=58593]="RestLonga",a[a.RestDoubleWhole=58594]="RestDoubleWhole",a[a.RestWhole=58595]="RestWhole",a[a.RestHalf=58596]="RestHalf",a[a.RestQuarter=58597]="RestQuarter",a[a.Rest8th=58598]="Rest8th",a[a.Rest16th=58599]="Rest16th",a[a.Rest32nd=58600]="Rest32nd",a[a.Rest64th=58601]="Rest64th",a[a.Rest128th=58602]="Rest128th",a[a.Rest256th=58603]="Rest256th",a[a.RestHBarLeft=58607]="RestHBarLeft",a[a.RestHBarMiddle=58608]="RestHBarMiddle",a[a.RestHBarRight=58609]="RestHBarRight",a[a.Repeat1Bar=58624]="Repeat1Bar",a[a.Repeat2Bars=58625]="Repeat2Bars",a[a.Ottava=58640]="Ottava",a[a.OttavaAlta=58641]="OttavaAlta",a[a.OttavaBassaVb=58652]="OttavaBassaVb",a[a.Quindicesima=58644]="Quindicesima",a[a.QuindicesimaAlta=58645]="QuindicesimaAlta",a[a.DynamicPPPPPP=58663]="DynamicPPPPPP",a[a.DynamicPPPPP=58664]="DynamicPPPPP",a[a.DynamicPPPP=58665]="DynamicPPPP",a[a.DynamicPPP=58666]="DynamicPPP",a[a.DynamicPP=58667]="DynamicPP",a[a.DynamicPiano=58656]="DynamicPiano",a[a.DynamicMP=58668]="DynamicMP",a[a.DynamicMF=58669]="DynamicMF",a[a.DynamicPF=58670]="DynamicPF",a[a.DynamicForte=58658]="DynamicForte",a[a.DynamicFF=58671]="DynamicFF",a[a.DynamicFFF=58672]="DynamicFFF",a[a.DynamicFFFF=58673]="DynamicFFFF",a[a.DynamicFFFFF=58674]="DynamicFFFFF",a[a.DynamicFFFFFF=58675]="DynamicFFFFFF",a[a.DynamicFortePiano=58676]="DynamicFortePiano",a[a.DynamicNiente=58662]="DynamicNiente",a[a.DynamicSforzando1=58678]="DynamicSforzando1",a[a.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",a[a.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",a[a.DynamicSforzato=58681]="DynamicSforzato",a[a.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",a[a.DynamicSforzatoFF=58683]="DynamicSforzatoFF",a[a.DynamicRinforzando1=58684]="DynamicRinforzando1",a[a.DynamicRinforzando2=58685]="DynamicRinforzando2",a[a.DynamicForzando=58677]="DynamicForzando",a[a.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",a[a.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",a[a.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",a[a.OrnamentTrill=58726]="OrnamentTrill",a[a.OrnamentTurn=58727]="OrnamentTurn",a[a.OrnamentTurnInverted=58728]="OrnamentTurnInverted",a[a.OrnamentShortTrill=58732]="OrnamentShortTrill",a[a.OrnamentMordent=58733]="OrnamentMordent",a[a.StringsDownBow=58896]="StringsDownBow",a[a.StringsUpBow=58898]="StringsUpBow",a[a.KeyboardPedalPed=58960]="KeyboardPedalPed",a[a.KeyboardPedalUp=58965]="KeyboardPedalUp",a[a.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",a[a.GuitarString0=59443]="GuitarString0",a[a.GuitarString1=59444]="GuitarString1",a[a.GuitarString2=59445]="GuitarString2",a[a.GuitarString3=59446]="GuitarString3",a[a.GuitarString4=59447]="GuitarString4",a[a.GuitarString5=59448]="GuitarString5",a[a.GuitarString6=59449]="GuitarString6",a[a.GuitarString7=59450]="GuitarString7",a[a.GuitarString8=59451]="GuitarString8",a[a.GuitarString9=59452]="GuitarString9",a[a.GuitarOpenPedal=59453]="GuitarOpenPedal",a[a.GuitarClosePedal=59455]="GuitarClosePedal",a[a.GuitarGolpe=59458]="GuitarGolpe",a[a.GuitarFadeIn=59459]="GuitarFadeIn",a[a.GuitarFadeOut=59460]="GuitarFadeOut",a[a.GuitarVolumeSwell=59461]="GuitarVolumeSwell",a[a.FretboardFilledCircle=59480]="FretboardFilledCircle",a[a.FretboardX=59481]="FretboardX",a[a.FretboardO=59482]="FretboardO",a[a.Tuplet0=59520]="Tuplet0",a[a.Tuplet1=59521]="Tuplet1",a[a.Tuplet2=59522]="Tuplet2",a[a.Tuplet3=59523]="Tuplet3",a[a.Tuplet4=59524]="Tuplet4",a[a.Tuplet5=59525]="Tuplet5",a[a.Tuplet6=59526]="Tuplet6",a[a.Tuplet7=59527]="Tuplet7",a[a.Tuplet8=59528]="Tuplet8",a[a.Tuplet9=59529]="Tuplet9",a[a.TupletColon=59530]="TupletColon",a[a.WiggleTrill=60068]="WiggleTrill",a[a.GuitarVibratoStroke=60082]="GuitarVibratoStroke",a[a.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",a[a.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",a[a.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",a[a.WiggleSawtooth=60091]="WiggleSawtooth",a[a.OctaveBaselineM=60565]="OctaveBaselineM",a[a.OctaveBaselineB=60563]="OctaveBaselineB",a[a.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",a[a.Fingering0=60688]="Fingering0",a[a.Fingering1=60689]="Fingering1",a[a.Fingering2=60690]="Fingering2",a[a.Fingering3=60691]="Fingering3",a[a.Fingering4=60692]="Fingering4",a[a.Fingering5=60693]="Fingering5",a[a.FingeringPLower=60695]="FingeringPLower",a[a.FingeringTLower=60696]="FingeringTLower",a[a.FingeringILower=60697]="FingeringILower",a[a.FingeringMLower=60698]="FingeringMLower",a[a.FingeringALower=60699]="FingeringALower",a[a.FingeringCLower=60700]="FingeringCLower"})(u||(u={}));var K;(function(a){a[a.None=0]="None",a[a.Natural=1]="Natural",a[a.Sharp=2]="Sharp",a[a.Flat=3]="Flat",a[a.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",a[a.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",a[a.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",a[a.DoubleSharp=7]="DoubleSharp",a[a.DoubleFlat=8]="DoubleFlat"})(K||(K={}));class vl{note=null;tone=new Wn;octave=0;get realValue(){return this.octave*12+this.tone.noteValue}}class Wn{noteValue;accidentalMode;constructor(e=0,t=re.Default){this.noteValue=e,this.accidentalMode=t}}class L{static getIndex(e){return e<0?0:Math.log2(e)|0}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return e===0}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let s=0;s<t.tracks.length;s++){if(s<e.notation.displayTranspositionPitches.length)for(const i of t.tracks[s].staves)i.displayTranspositionPitch=-e.notation.displayTranspositionPitches[s];if(s<e.notation.transpositionPitches.length)for(const i of t.tracks[s].staves)i.transpositionPitch=-e.notation.transpositionPitches[s]}}static isTuning(e){return!!L.parseTuning(e)}static tuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]);static parseTuning(e){let t="",s="";for(let n=0;n<e.length;n++){const o=e.charCodeAt(n);if(o>=48&&o<=57){if(!t)return null;s+=String.fromCharCode(o)}else if(t.length===0)if(L.tuningLetters.has(o))t+=String.fromCharCode(o);else return null;else t+=String.fromCharCode(o)}if(!s||!t)return null;const i=new vl;i.octave=Number.parseInt(s,10)+1,i.note=t.toLowerCase();const r=L.getToneForText(i.note);return r===null?null:(i.tone=r,i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i)}static getTuningForText(e){const t=L.parseTuning(e);return t?t.realValue:-1}static getToneForText(e){const t=e.substring(0,1),s=e.substring(1);let i,r;switch(t.toLowerCase()){case"c":i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11;break;default:return null}if(!L.accidentalModeMapping.has(s))return null;switch(r=L.parseAccidentalMode(s),r){case re.Default:break;case re.ForceNone:break;case re.ForceNatural:break;case re.ForceSharp:i++;break;case re.ForceDoubleSharp:i+=2;break;case re.ForceFlat:i--;break;case re.ForceDoubleFlat:i-=2;break}return new Wn(i,r)}static reverseAccidentalModeMapping=new Map([[re.Default,"d"],[re.ForceNone,"forcenone"],[re.ForceNatural,"forcenatural"],[re.ForceSharp,"#"],[re.ForceDoubleSharp,"x"],[re.ForceFlat,"b"],[re.ForceDoubleFlat,"bb"]]);static accidentalModeMapping=new Map([["default",re.Default],["d",re.Default],["",re.Default],["forcenone",re.ForceNone],["-",re.ForceNone],["forcenatural",re.ForceNatural],["n",re.ForceNatural],["forcesharp",re.ForceSharp],["#",re.ForceSharp],["forcedoublesharp",re.ForceDoubleSharp],["##",re.ForceDoubleSharp],["x",re.ForceDoubleSharp],["forceflat",re.ForceFlat],["b",re.ForceFlat],["forcedoubleflat",re.ForceDoubleFlat],["bb",re.ForceDoubleFlat]]);static parseAccidentalMode(e){const t=e.toLowerCase();return L.accidentalModeMapping.has(t)?L.accidentalModeMapping.get(t):re.Default}static newGuid(){return`${Math.floor((1+Math.random())*65536).toString(16).substring(1)+Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}-${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}${Math.floor((1+Math.random())*65536).toString(16).substring(1)}`}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let s="";const i="0123456789ABCDEF";do s=String.fromCharCode(i.charCodeAt(e&15))+s,e=e>>4;while(e>0);for(;s.length<t;)s=`0${s}`;return s}static getAlternateEndingsList(e){const t=[];for(let s=0;s<Os.MaxAlternateEndings;s++)(e&1<<s)!==0&&t.push(s);return t}static deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(e,t,s){return e<=t?t:e>=s?s:e}static buildMultiBarRestInfo(e,t,s){if(!e)return null;const i=e[0].score.stylesheet;if(!(e.length>1?i.multiTrackMultiBarRest:i.perTrackMultiBarRest?.has(e[0].index)===!0))return null;const n=new Map,o=e[0].score;let l=t,h=o.tempo;for(;l<=s;){const c=l;let d=null;for(;l<=s;){const f=o.masterBars[l];let p=!1;for(const m of f.tempoAutomations)m.value!==h&&(p=!0),h=m.value;if(f.alternateEndings||f.isRepeatStart&&f.index!==c||f.isFreeTime||f.isAnacrusis||f.section!==null||f.index!==c&&p||f.fermata!==null&&f.fermata.size>0||f.directions!==null&&f.directions.size>0||c>t&&f.previousMasterBar&&(f.timeSignatureCommon!==f.previousMasterBar.timeSignatureCommon||f.timeSignatureNumerator!==f.previousMasterBar.timeSignatureNumerator||f.timeSignatureDenominator!==f.previousMasterBar.timeSignatureDenominator||f.tripletFeel!==f.previousMasterBar.tripletFeel))break;let g=!0;for(const m of e){for(const b of m.staves){const S=b.bars[f.index];if(!S.isRestOnly){g=!1;break}if(S.index>0&&(S.keySignature!==S.previousBar.keySignature||S.keySignatureType!==S.previousBar.keySignatureType)){g=!1;break}}if(!g)break}if(!g||(l++,f.index>c&&(d===null?d=[f.index]:d.push(f.index)),f.isRepeatEnd))break}d?n.set(c,d):l++}return n}static computeFirstDisplayedBarIndex(e,t){let s=t.display.startBar;return s--,s=Math.min(e.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(e,t,s){let i=t.display.barCount;return i<0&&(i=e.masterBars.length),i=s+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(e,t){let s=e.style;e.style||(s=new Di,e.style=s);let i;if(s.headerAndFooter.has(t))i=s.headerAndFooter.get(t);else{if(i=new is,Di.defaultHeaderAndFooter.has(t)){const r=Di.defaultHeaderAndFooter.get(t);i.template=r.template,i.textAlign=r.textAlign}s.headerAndFooter.set(t,i)}return i}static consolidate(e){if(e.masterBars.length===0){const s=new Os;e.addMasterBar(s);const i=new Ye;i.isLinear=!1,i.type=De.Tempo,i.value=e.tempo,s.tempoAutomations.push(i);const r=new Kt;e.tracks[0].staves[0].addBar(r);const n=new hs;r.addVoice(n);const o=new wt;o.isEmpty=!0,n.addBeat(o);return}const t=new Set([oe.PercussionChannel]);for(const s of e.tracks){if(s.staves.length===1&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=oe.PercussionChannel,s.playbackInfo.secondaryChannel=oe.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==oe.PercussionChannel)for(;t.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(t.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==oe.PercussionChannel)for(;t.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;t.add(s.playbackInfo.secondaryChannel)}for(const i of s.staves){for(const n of i.bars)for(const o of n.voices)if(o.isEmpty&&o.beats.length===0){const l=new wt;l.isEmpty=!0,o.addBeat(l)}const r=i.bars.length===0?1:i.bars[0].voices.length;for(;i.bars.length<e.masterBars.length;){const n=new Kt;i.addBar(n);const o=n.previousBar;o&&(n.clef=o.clef,n.clefOttava=o.clefOttava,n.keySignature=n.previousBar.keySignature,n.keySignatureType=n.previousBar.keySignatureType);for(let l=0;l<r;l++){const h=new hs;n.addVoice(h);const c=new wt;c.isEmpty=!0,h.addBeat(c)}}}}if(e.masterBars.length>0&&!e.masterBars[0].tempoAutomations.find(i=>i.type===De.Tempo&&i.ratioPosition===0)){const i=new Ye;i.isLinear=!1,i.type=De.Tempo,i.value=e.tempo,i.text=e.tempoLabel,i.isVisible=!1,e.masterBars[0].tempoAutomations.push(i)}}static trimEmptyBarsAtEnd(e){for(;e.masterBars.length>1;){const t=e.masterBars.length-1,s=e.masterBars[t];if(s.hasChanges)return;for(const i of e.tracks)for(const r of i.staves)if(t<r.bars.length){const n=r.bars[t];if(!n.isEmpty||n.hasChanges)return}for(const i of e.tracks)for(const r of i.staves)if(t<r.bars.length){const n=r.bars[t];r.bars.pop(),n.previousBar.nextBar=null}e.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static _allMusicFontSymbols=[];static getAllMusicFontSymbols(){return L._allMusicFontSymbols.length===0&&(L._allMusicFontSymbols=Object.values(u).filter(e=>typeof e=="number").map(e=>e)),L._allMusicFontSymbols}static displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]);static flooredDivision(e,t){return e-t*Math.floor(e/t)}static _translateKeyTransposeTable(e){const t=[];for(const s of e){const i=[];t.push(i);for(const r of s){const n=Number.parseInt(r.charAt(0),10)*(r.charAt(1)==="b"?-1:1);i.push(n)}}return t}static _keyTransposeTable=L._translateKeyTransposeTable([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]);static transposeKey(e,t){if(t===0)return e;if(t<0){const i=L._keyTransposeTable[-t].indexOf(e);return i===-1?e:i-7}else return L._keyTransposeTable[t][e+7]}static _keySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]];static accidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1];static computeAccidental(e,t,s,i,r=null){const o=e+7,l=s%12,h=o<7?K.Flat:K.Sharp,c=L._keySignatureLookup[o][l],d=L.accidentalNotes[l];let f=K.None;if(i)switch(f=d?h:K.Natural,f){case K.Natural:f=K.NaturalQuarterNoteUp;break;case K.Sharp:f=K.SharpQuarterNoteUp;break;case K.Flat:f=K.FlatQuarterNoteUp;break}else{switch(t){case re.ForceSharp:f=K.Sharp;break;case re.ForceDoubleSharp:f=K.DoubleSharp;break;case re.ForceFlat:f=K.Flat;break;case re.ForceDoubleFlat:f=K.DoubleFlat;break;default:d?f=h:c&&(f=K.Natural);break}f!==K.None?r!=null?r===f&&(f=K.None):c&&f===h&&(f=K.None):r!==null&&(r===K.Natural?f=K.None:f=K.Natural)}return f}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}}var kt;(function(a){a[a.None=0]="None",a[a.Up=1]="Up",a[a.Down=2]="Down"})(kt||(kt={}));var Ge;(function(a){a[a.Above=0]="Above",a[a.Inside=1]="Inside",a[a.Below=2]="Below",a[a.Outside=3]="Outside"})(Ge||(Ge={}));class J{elementType;staffLine;noteHeadDefault;noteHeadHalf;noteHeadWhole;techniqueSymbol;techniqueSymbolPlacement;outputMidiNumber;constructor(e="",t=0,s=0,i=u.None,r=u.None,n=u.None,o=u.None,l=Ge.Inside){this.elementType=e,this.outputMidiNumber=s,this.staffLine=t,this.noteHeadDefault=i,this.noteHeadHalf=r!==u.None?r:i,this.noteHeadWhole=n!==u.None?n:i,this.techniqueSymbol=o,this.techniqueSymbolPlacement=l}getSymbol(e){switch(e){case y.Whole:return this.noteHeadWhole;case y.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class ht{static _gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]];static articulationFromElementVariation(e,t){return e<ht._gp6ElementAndVariationToArticulation.length?(t>=ht._gp6ElementAndVariationToArticulation.length&&(t=0),ht._gp6ElementAndVariationToArticulation[e][t]):38}static instrumentArticulations=new Map([[38,new J("snare",3,38,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[37,new J("snare",3,37,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[91,new J("snare",3,38,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[42,new J("hiHat",-1,42,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[92,new J("hiHat",-1,46,u.NoteheadCircleSlash,u.NoteheadCircleSlash,u.NoteheadCircleSlash)],[46,new J("hiHat",-1,46,u.NoteheadCircleX,u.NoteheadCircleX,u.NoteheadCircleX)],[44,new J("hiHat",9,44,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[35,new J("kickDrum",8,35,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[36,new J("kickDrum",7,36,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[50,new J("tom",1,50,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[48,new J("tom",2,48,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[47,new J("tom",4,47,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[45,new J("tom",5,45,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[43,new J("tom",6,43,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[93,new J("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.PictEdgeOfCymbal,Ge.Below)],[51,new J("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[53,new J("ride",0,53,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[94,new J("ride",0,51,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,Ge.Above)],[55,new J("splash",-2,55,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[95,new J("splash",-2,55,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,Ge.Below)],[52,new J("china",-3,52,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat)],[96,new J("china",-3,52,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat,u.NoteheadHeavyXHat)],[49,new J("crash",-2,49,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX)],[97,new J("crash",-2,49,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX,u.ArticStaccatoAbove,Ge.Below)],[57,new J("crash",-1,57,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX)],[98,new J("crash",-1,57,u.NoteheadHeavyX,u.NoteheadHeavyX,u.NoteheadHeavyX,u.ArticStaccatoAbove,Ge.Below)],[99,new J("cowbell",1,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[100,new J("cowbell",1,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[56,new J("cowbell",0,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[101,new J("cowbell",0,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[102,new J("cowbell",-1,56,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpWhole)],[103,new J("cowbell",-1,56,u.NoteheadXBlack,u.NoteheadXHalf,u.NoteheadXWhole)],[77,new J("woodblock",-9,77,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[76,new J("woodblock",-10,76,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[60,new J("bongo",-4,60,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[104,new J("bongo",-5,60,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,Ge.Inside)],[105,new J("bongo",-6,60,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[61,new J("bongo",-7,61,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[106,new J("bongo",-8,61,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,Ge.Inside)],[107,new J("bongo",-16,61,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[66,new J("timbale",10,66,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[65,new J("timbale",9,65,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[68,new J("agogo",12,68,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[67,new J("agogo",11,67,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[64,new J("conga",17,64,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[108,new J("conga",16,64,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[109,new J("conga",15,64,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,Ge.Inside)],[63,new J("conga",14,63,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[110,new J("conga",13,63,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[62,new J("conga",19,62,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.NoteheadParenthesis,Ge.Inside)],[72,new J("whistle",-11,72,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[71,new J("whistle",-17,71,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[73,new J("guiro",38,73,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[74,new J("guiro",37,74,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[86,new J("surdo",36,86,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[87,new J("surdo",35,87,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadParenthesis,Ge.Inside)],[54,new J("tambourine",3,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack)],[111,new J("tambourine",2,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.StringsUpBow,Ge.Below)],[112,new J("tambourine",1,54,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.NoteheadTriangleUpBlack,u.StringsDownBow,Ge.Below)],[113,new J("tambourine",-7,54,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[79,new J("cuica",30,79,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[78,new J("cuica",29,78,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[58,new J("vibraslap",28,58,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[81,new J("triangle",27,81,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[80,new J("triangle",26,80,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadParenthesis,Ge.Inside)],[114,new J("grancassa",25,43,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[115,new J("piatti",18,49,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[116,new J("piatti",24,49,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[69,new J("cabasa",23,69,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[117,new J("cabasa",22,69,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,Ge.Below)],[85,new J("castanets",21,85,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[75,new J("claves",20,75,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[70,new J("maraca",-12,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[118,new J("maraca",-13,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,Ge.Below)],[119,new J("maraca",-14,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[120,new J("maraca",-15,70,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,Ge.Below)],[82,new J("shaker",-23,54,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[122,new J("shaker",-24,54,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,Ge.Below)],[84,new J("bellTree",-18,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[123,new J("bellTree",-19,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole,u.StringsUpBow,Ge.Below)],[83,new J("jingleBell",-20,53,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[124,new J("unpitched",-21,62,u.NoteheadNull,u.NoteheadNull,u.NoteheadNull,u.GuitarGolpe,Ge.Above)],[125,new J("unpitched",-22,62,u.NoteheadNull,u.NoteheadNull,u.NoteheadNull,u.GuitarGolpe,Ge.Below)],[39,new J("handClap",3,39,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[40,new J("snare",3,40,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[31,new J("snare",3,40,u.NoteheadSlashedBlack2,u.NoteheadSlashedBlack2,u.NoteheadSlashedBlack2)],[41,new J("tom",5,41,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole)],[59,new J("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.PictEdgeOfCymbal,Ge.Below)],[126,new J("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[127,new J("ride",2,59,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite,u.NoteheadDiamondWhite)],[29,new J("ride",2,59,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack,u.ArticStaccatoAbove,Ge.Above)],[30,new J("crash",-3,49,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[33,new J("snare",3,37,u.NoteheadXBlack,u.NoteheadXBlack,u.NoteheadXBlack)],[34,new J("snare",3,38,u.NoteheadBlack,u.NoteheadBlack,u.NoteheadBlack)]]);static instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);static getArticulationName(e){const t=ht.getArticulation(e);let s=e.percussionArticulation;t&&(s=t.outputMidiNumber);for(const[i,r]of ht.instrumentArticulationNames)if(r===s)return i;return"unknown"}static getArticulation(e){const t=e.percussionArticulation;if(t<0)return null;const s=e.beat.voice.bar.staff.track.percussionArticulations;return t<s.length?s[t]:ht.getArticulationByInputMidiNumber(t)}static getElementAndVariation(e){const t=ht.getArticulation(e);if(!t)return[-1,-1];for(let s=0;s<ht._gp6ElementAndVariationToArticulation.length;s++){const i=ht._gp6ElementAndVariationToArticulation[s];for(let r=0;r<i.length;r++)if(ht.getArticulationByInputMidiNumber(i[r])?.outputMidiNumber===t.outputMidiNumber)return[s,r]}return[-1,-1]}static getArticulationByInputMidiNumber(e){return ht.instrumentArticulations.has(e)?ht.instrumentArticulations.get(e):null}}var je;(function(a){a[a.None=0]="None",a[a.InvertedTurn=1]="InvertedTurn",a[a.Turn=2]="Turn",a[a.UpperMordent=3]="UpperMordent",a[a.LowerMordent=4]="LowerMordent"})(je||(je={}));class di{tieDestinationNoteId=-1;tieOriginNoteId=-1;slurDestinationNoteId=-1;slurOriginNoteId=-1;hammerPullDestinationNoteId=-1;hammerPullOriginNoteId=-1;slideTargetNoteId=-1;slideOriginNoteId=-1}var Vt;(function(a){a[a.Effects=0]="Effects",a[a.StandardNotationNoteHead=1]="StandardNotationNoteHead",a[a.StandardNotationAccidentals=2]="StandardNotationAccidentals",a[a.StandardNotationEffects=3]="StandardNotationEffects",a[a.GuitarTabFretNumber=4]="GuitarTabFretNumber",a[a.GuitarTabEffects=5]="GuitarTabEffects",a[a.SlashNoteHead=6]="SlashNoteHead",a[a.SlashEffects=7]="SlashEffects",a[a.NumberedNumber=8]="NumberedNumber",a[a.NumberedAccidentals=9]="NumberedAccidentals",a[a.NumberedEffects=10]="NumberedEffects"})(Vt||(Vt={}));class On extends qi{noteHead;noteHeadCenterOnStem}class mt{static globalNoteId=0;static resetIds(){mt.globalNoteId=0}id=mt.globalNoteId++;index=0;accentuated=tt.None;bendType=q.None;bendStyle=ze.Default;bendOrigin=null;isContinuedBend=!1;bendPoints=null;maxBendPoint=null;get hasBend(){return this.bendPoints!==null&&this.bendType!==q.None}get isStringed(){return this.string>=0}fret=-1;string=-1;showStringNumber=!1;get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}octave=-1;tone=-1;get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?ht.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?ht.getElementAndVariation(this)[1]:-1}percussionArticulation=-1;isVisible=!0;isLeftHandTapped=!1;isHammerPullOrigin=!1;get isHammerPullDestination(){return!!this.hammerPullOrigin}hammerPullOrigin=null;hammerPullDestination=null;get isSlurOrigin(){return!!this.slurDestination}isSlurDestination=!1;slurOrigin=null;slurDestination=null;get isHarmonic(){return this.harmonicType!==Q.None}harmonicType=Q.None;harmonicValue=0;isGhost=!1;isLetRing=!1;letRingDestination=null;isPalmMute=!1;palmMuteDestination=null;isDead=!1;isStaccato=!1;slideInType=dt.None;slideOutType=ne.None;slideTarget=null;slideOrigin=null;vibrato=be.None;tieOrigin=null;tieDestination=null;isTieDestination=!1;get isTieOrigin(){return this.tieDestination!==null}leftHandFinger=j.Unknown;rightHandFinger=j.Unknown;get isFingering(){return this.leftHandFinger!==j.Unknown||this.rightHandFinger!==j.Unknown}trillValue=-1;get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}trillSpeed=y.ThirtySecond;durationPercent=1;accidentalMode=re.Default;beat;dynamics=Z.F;isEffectSlurOrigin=!1;hasEffectSlur=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;ornament=je.None;style;get stringTuning(){return this.beat.voice.bar.staff.capo+mt.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,t){const s=e?this.beat.voice.bar.staff.transpositionPitch:0;if(t){let i=this.calculateRealValue(e,!1);return this.isStringed&&(this.harmonicType===Q.Natural?i=this.harmonicPitch+this.stringTuning-s:i+=this.harmonicPitch),i}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?this.octave*12+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===Q.None||!this.isStringed)return 0;const e=this.harmonicValue;return L.isAlmostEqualTo(e,2.4)?36:L.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==Q.Natural&&this.harmonicType!==Q.None&&(e-=this.harmonicPitch),this.beat.ottava){case ae._15ma:e-=24;break;case ae._8va:e-=12;break;case ae.Regular:break;case ae._8vb:e+=12;break;case ae._15mb:e+=24;break}switch(this.beat.voice.bar.clefOttava){case ae._15ma:e-=24;break;case ae._8va:e-=12;break;case ae.Regular:break;case ae._8vb:e+=12;break;case ae._15mb:e+=24;break}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!==0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!==0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!==0:this.beat.isContinuedWhammy?this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!==0:!1}addBendPoint(e){let t=this.bendPoints;t===null&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===q.None&&(this.bendType=q.Custom)}finish(e,t=null){const s=new Ji(()=>mt.nextNoteOnSameLine(this)),i=e&&e.notation.notationMode===Et.SongBook;if(this.isTieDestination&&(this.chain(t),i&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(!s.value||!s.value.isLetRing?this.letRingDestination=this:this.letRingDestination=s.value,i&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(!s.value||!s.value.isPalmMute?this.palmMuteDestination=this:this.palmMuteDestination=s.value),this.isHammerPullOrigin){const l=mt.findHammerPullDestination(this);l?(this.hammerPullDestination=l,l.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case ne.Shift:case ne.Legato:this.slideTarget||(this.slideTarget=s.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=ne.None;break}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===ne.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===kt.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const n=this.bendPoints,o=n!=null&&n.length>0;if(o){const l=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=l}else this.bendType=q.None;if(o&&this.bendType===q.Custom){if(n.length===4){const l=n[0],h=n[1],c=n[2],d=n[3];h.value===c.value?d.value>l.value?h.value>d.value?this.bendType=q.BendRelease:!this.isContinuedBend&&l.value>0?(this.bendType=q.PrebendBend,n.splice(2,1),n.splice(1,1)):(this.bendType=q.Bend,n.splice(2,1),n.splice(1,1)):d.value<l.value?this.isContinuedBend?(this.bendType=q.Release,n.splice(2,1),n.splice(1,1)):(this.bendType=q.PrebendRelease,n.splice(2,1),n.splice(1,1)):h.value>l.value?this.bendType=q.BendRelease:l.value>0&&!this.isContinuedBend?(this.bendType=q.Prebend,n.splice(2,1),n.splice(1,1)):(this.bendType=q.Hold,n.splice(2,1),n.splice(1,1)):E.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(n.length===2){const l=n[0],h=n[1];h.value>l.value?!this.isContinuedBend&&l.value>0?this.bendType=q.PrebendBend:this.bendType=q.Bend:h.value<l.value?this.isContinuedBend?this.bendType=q.Release:this.bendType=q.PrebendRelease:l.value>0&&!this.isContinuedBend?this.bendType=q.Prebend:this.bendType=q.Hold}}this.initialBendValue>0&&(this.accidentalMode=re.Default)}static _maxOffsetForSameLineSearch=3;static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+mt._maxOffsetForSameLineSearch;){const s=t.getNoteOnString(e.string);if(s)return s;t=t.nextBeat}return null}static findHammerPullDestination(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+mt._maxOffsetForSameLineSearch;){let s=t.getNoteOnString(e.string);if(s)return s;for(let i=e.string;i>0;i--)if(s=t.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=e.string;i<=e.beat.voice.bar.staff.tuning.length;i++)if(s=t.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}t=t.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-mt._maxOffsetForSameLineSearch;){if(e.isStringed){const s=t.getNoteOnString(e.string);if(s)return s}else if(e.octave===-1&&e.tone===-1){if(e.index<t.notes.length)return t.notes[e.index]}else{const s=t.getNoteWithRealValue(e.realValue);if(s)return s}t=t.previousBeat}return null}static _noteIdLookupKey="NoteIdLookup";_noteIdBag=null;chain(e=null){if(e!==null)if(this._noteIdBag!==null){let t;e.has(mt._noteIdLookupKey)?t=e.get(mt._noteIdLookupKey):(t=new Map,e.set(mt._noteIdLookupKey,t)),(this._noteIdBag.hammerPullDestinationNoteId!==-1||this._noteIdBag.tieDestinationNoteId!==-1||this._noteIdBag.slurDestinationNoteId!==-1||this._noteIdBag.slideTargetNoteId!==-1)&&t.set(this.id,this),this._noteIdBag.hammerPullOriginNoteId!==-1&&(this.hammerPullOrigin=t.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),this._noteIdBag.tieOriginNoteId!==-1&&(this.tieOrigin=t.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),this._noteIdBag.slurOriginNoteId!==-1&&(this.slurOrigin=t.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),this._noteIdBag.slideOriginNoteId!==-1&&(this.slideOrigin=t.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&this.tieOrigin===null)return;const t=this.tieOrigin??mt.findTieOrigin(this);t?(t.tieDestination=this,this.tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){this.tieDestination!==null&&e.set("tiedestinationnoteid",this.tieDestination.id),this.tieOrigin!==null&&e.set("tieoriginnoteid",this.tieOrigin.id),this.slurDestination!==null&&e.set("slurdestinationnoteid",this.slurDestination.id),this.slurOrigin!==null&&e.set("sluroriginnoteid",this.slurOrigin.id),this.hammerPullOrigin!==null&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),this.hammerPullDestination!==null&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),this.slideTarget!==null&&e.set("slidetargetnoteid",this.slideTarget.id),this.slideOrigin!==null&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.hammerPullDestinationNoteId=t,!0;case"slidetargetnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.slideTargetNoteId=t,!0;case"slideoriginnoteid":return this._noteIdBag==null&&(this._noteIdBag=new di),this._noteIdBag.slideOriginNoteId=t,!0}return!1}}class vs{static _halfTicks=1920;static _quarterTicks=960;static _eighthTicks=480;static _sixteenthTicks=240;static _thirtySecondTicks=120;static _sixtyFourthTicks=60;static _oneHundredTwentyEighthTicks=30;static _twoHundredFiftySixthTicks=15;static _allTicks=[vs._halfTicks,vs._quarterTicks,vs._eighthTicks,vs._sixteenthTicks,vs._thirtySecondTicks,vs._sixtyFourthTicks,vs._oneHundredTwentyEighthTicks,vs._twoHundredFiftySixthTicks];_isEqualLengthTuplet=!0;totalDuration=0;beats=[];voice;isFull=!1;constructor(e){this.voice=e}check(e){if(this.beats.length===0)return this.beats.push(e),this.totalDuration+=e.playbackDuration,!0;if(e.graceType!==$.None)return!0;if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const t=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const s of vs._allTicks)if(this.totalDuration===s*t){this.isFull=!0;break}}return!0}}var Le;(function(a){a[a.None=0]="None",a[a.Custom=1]="Custom",a[a.Dive=2]="Dive",a[a.Dip=3]="Dip",a[a.Hold=4]="Hold",a[a.Predive=5]="Predive",a[a.PrediveDive=6]="PrediveDive"})(Le||(Le={}));var Ht;(function(a){a[a.None=0]="None",a[a.Thumb=1]="Thumb",a[a.Finger=2]="Finger"})(Ht||(Ht={}));var ut;(function(a){a[a.None=0]="None",a[a.FadeIn=1]="FadeIn",a[a.FadeOut=2]="FadeOut",a[a.VolumeSwell=3]="VolumeSwell"})(ut||(ut={}));var Jt;(function(a){a[a.None=0]="None",a[a.Open=1]="Open",a[a.Closed=2]="Closed"})(Jt||(Jt={}));var ps;(function(a){a[a.None=0]="None",a[a.Full=1]="Full",a[a.Half=2]="Half"})(ps||(ps={}));var ie;(function(a){a[a.None=0]="None",a[a.Ii=1]="Ii",a[a.Mi=2]="Mi",a[a.MiiTriplet=3]="MiiTriplet",a[a.MiiAnapaest=4]="MiiAnapaest",a[a.PmpTriplet=5]="PmpTriplet",a[a.PmpAnapaest=6]="PmpAnapaest",a[a.PeiTriplet=7]="PeiTriplet",a[a.PeiAnapaest=8]="PeiAnapaest",a[a.PaiTriplet=9]="PaiTriplet",a[a.PaiAnapaest=10]="PaiAnapaest",a[a.AmiTriplet=11]="AmiTriplet",a[a.AmiAnapaest=12]="AmiAnapaest",a[a.Ppp=13]="Ppp",a[a.Amii=14]="Amii",a[a.Amip=15]="Amip",a[a.Eami=16]="Eami",a[a.Eamii=17]="Eamii",a[a.Peami=18]="Peami"})(ie||(ie={}));var Xe;(function(a){a[a.Auto=0]="Auto",a[a.ForceSplitToNext=1]="ForceSplitToNext",a[a.ForceMergeWithNext=2]="ForceMergeWithNext",a[a.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"})(Xe||(Xe={}));var Je;(function(a){a[a.Effects=0]="Effects",a[a.StandardNotationStem=1]="StandardNotationStem",a[a.StandardNotationFlags=2]="StandardNotationFlags",a[a.StandardNotationBeams=3]="StandardNotationBeams",a[a.StandardNotationTuplet=4]="StandardNotationTuplet",a[a.StandardNotationEffects=5]="StandardNotationEffects",a[a.StandardNotationRests=6]="StandardNotationRests",a[a.GuitarTabStem=7]="GuitarTabStem",a[a.GuitarTabFlags=8]="GuitarTabFlags",a[a.GuitarTabBeams=9]="GuitarTabBeams",a[a.GuitarTabTuplet=10]="GuitarTabTuplet",a[a.GuitarTabEffects=11]="GuitarTabEffects",a[a.GuitarTabRests=12]="GuitarTabRests",a[a.SlashStem=13]="SlashStem",a[a.SlashFlags=14]="SlashFlags",a[a.SlashBeams=15]="SlashBeams",a[a.SlashTuplet=16]="SlashTuplet",a[a.SlashRests=17]="SlashRests",a[a.SlashEffects=18]="SlashEffects",a[a.NumberedDuration=19]="NumberedDuration",a[a.NumberedEffects=20]="NumberedEffects",a[a.NumberedRests=21]="NumberedRests",a[a.NumberedTuplet=22]="NumberedTuplet"})(Je||(Je={}));class Dl extends qi{}class wt{static _globalBeatId=0;static resetIds(){wt._globalBeatId=0}id=wt._globalBeatId++;index=0;previousBeat=null;nextBeat=null;get isLastOfVoice(){return this.index===this.voice.beats.length-1}voice;notes=[];noteStringLookup=new Map;noteValueLookup=new Map;isEmpty=!1;whammyStyle=ze.Default;ottava=ae.Regular;fermata=null;isLegatoOrigin=!1;get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}minNote=null;maxNote=null;maxStringNote=null;minStringNote=null;duration=y.Quarter;get isRest(){return this.isEmpty||!this.deadSlapped&&this.notes.length===0}get isFullBarRest(){return this.isRest&&this.voice.beats.length===1&&this.duration===y.Whole}isLetRing=!1;isPalmMute=!1;automations=[];dots=0;get fadeIn(){return this.fade===ut.FadeIn}set fadeIn(e){this.fade=e?ut.FadeIn:ut.None}fade=ut.None;lyrics=null;get hasRasgueado(){return this.rasgueado!==ie.None}pop=!1;slap=!1;tap=!1;text=null;slashed=!1;deadSlapped=!1;brushType=Y.None;brushDuration=0;tupletDenominator=-1;tupletNumerator=-1;get hasTuplet(){return!(this.tupletDenominator===-1&&this.tupletNumerator===-1)&&!(this.tupletDenominator===1&&this.tupletNumerator===1)}tupletGroup=null;isContinuedWhammy=!1;whammyBarType=Le.None;whammyBarPoints=null;maxWhammyPoint=null;minWhammyPoint=null;get hasWhammyBar(){return this.whammyBarPoints!==null&&this.whammyBarType!==Le.None}vibrato=be.None;chordId=null;get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}graceType=$.None;graceGroup=null;graceIndex=-1;pickStroke=kt.None;get isTremolo(){return!!this.tremoloSpeed}tremoloSpeed=null;crescendo=Lt.None;displayStart=0;get displayEnd(){return this.displayStart+this.displayDuration}playbackStart=0;displayDuration=0;playbackDuration=0;overrideDisplayDuration;golpe=Ht.None;get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}dynamics=Z.F;invertBeamDirection=!1;preferredBeamDirection=null;isEffectSlurOrigin=!1;get isEffectSlurDestination(){return!!this.effectSlurOrigin}effectSlurOrigin=null;effectSlurDestination=null;beamingMode=Xe.Auto;wahPedal=Jt.None;barreFret=-1;barreShape=ps.None;get isBarre(){return this.barreShape!==ps.None&&this.barreFret>=0}rasgueado=ie.None;showTimer=!1;timer=null;style;addWhammyBarPoint(e){let t=this.whammyBarPoints;t===null&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===Le.None&&(this.whammyBarType=Le.Custom)}removeWhammyBarPoint(e){const t=this.whammyBarPoints;if(t===null||e<0||e>=t.length)return;t.splice(e,1);const s=t[e];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const i of t)(!this.maxWhammyPoint||i.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=i)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const i of t)(!this.minWhammyPoint||i.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=i)}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){const t=this.notes.indexOf(e);t>=0&&(this.notes.splice(t,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let t=0,s=this.automations.length;t<s;t++){const i=this.automations[t];if(i.type===e)return i}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}_calculateDuration(){if(this.overrideDisplayDuration!==void 0)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=x.toTicks(this.duration);return this.dots===2?e=x.applyDot(e,!0):this.dots===1&&(e=x.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=x.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){const e=this._calculateDuration();switch(this.playbackDuration=e,this.graceType){case $.BeforeBeat:case $.OnBeat:switch(this.duration){case y.Sixteenth:this.playbackDuration=x.toTicks(y.SixtyFourth);break;case y.ThirtySecond:this.playbackDuration=x.toTicks(y.OneHundredTwentyEighth);break;default:this.playbackDuration=x.toTicks(y.ThirtySecond);break}this.displayDuration=0;break;case $.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;const t=this.previousBeat;t&&t.graceType===$.BendGrace&&(this.playbackDuration=t.playbackDuration);break}}finishTuplet(){const e=this.previousBeat;let t=e?e.tupletGroup:null;(this.hasTuplet||this.graceType!==$.None&&t)&&((!e||!t||!t.check(this))&&(t=new vs(this.voice),t.check(this)),this.tupletGroup=t);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const r of this.automations)r.ratioPosition===0&&(r.ratioPosition=this.playbackStart/s),r.type!==De.Tempo&&i.push(r);this.automations=i}finish(e,t=null){switch(this.getAutomation(De.Instrument)===null&&this.index===0&&this.voice.index===0&&this.voice.bar.index===0&&this.voice.bar.staff.index===0&&this.automations.push(Ye.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case $.OnBeat:case $.BeforeBeat:const c=this.graceGroup.beats.length;c===1?this.duration=y.Eighth:c===2?this.duration=y.Sixteenth:this.duration=y.ThirtySecond;break}this.brushType===Y.None&&(this.brushDuration=0);const s=e?e.notation.notationMode:Et.GuitarPro;let i=this.text==="grad"||this.text==="grad.";i&&s===Et.SongBook&&(this.text="");let r=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let n=0,o=!1;for(let c=0,d=this.notes.length;c<d;c++){const f=this.notes[c];if(f.dynamics=this.dynamics,f.finish(e,t),f.isLetRing&&(this.isLetRing=!0),f.isPalmMute&&(this.isPalmMute=!0),s===Et.SongBook&&f.hasBend&&this.graceType!==$.BendGrace){if(!f.isTieOrigin)switch(f.bendType){case q.Bend:case q.PrebendRelease:case q.PrebendBend:r=!0;break}i||f.bendStyle===ze.Gradual?(i=!0,f.bendStyle=ze.Gradual,r=!1):f.bendStyle=ze.Fast}f.isVisible&&(n++,(!this.minNote||f.realValue<this.minNote.realValue)&&(this.minNote=f),(!this.maxNote||f.realValue>this.maxNote.realValue)&&(this.maxNote=f),(!this.minStringNote||f.string<this.minStringNote.string)&&(this.minStringNote=f),(!this.maxStringNote||f.string>this.maxStringNote.string)&&(this.maxStringNote=f),f.hasEffectSlur&&(o=!0))}if(o&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&n===0&&(this.isEmpty=!0),!this.isRest&&(!this.isLetRing||!this.isPalmMute)){let c=this.previousBeat;for(;c&&c.isRest;)this.isLetRing||(c.isLetRing=!1),this.isPalmMute||(c.isPalmMute=!1),c=c.previousBeat}else this.isRest&&this.previousBeat&&e&&e.notation.notationMode===Et.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));const l=this.whammyBarPoints,h=l!==null&&l.length>0;if(h){const c=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=c}else this.whammyBarType=Le.None;if(h&&this.whammyBarType===Le.Custom){if(s===Et.SongBook&&(this.whammyStyle=i?ze.Gradual:ze.Fast),l.length===4){const c=l[0],d=l[1],f=l[2],p=l[3];d.value===f.value&&(c.value<d.value&&d.value<p.value||c.value>d.value&&d.value>p.value?(c.value!==0&&!this.isContinuedWhammy?this.whammyBarType=Le.PrediveDive:this.whammyBarType=Le.Dive,l.splice(2,1),l.splice(1,1)):c.value>d.value&&d.value<p.value||c.value<d.value&&d.value>p.value?(this.whammyBarType=Le.Dip,(d.offset===f.offset||s===Et.SongBook)&&l.splice(2,1)):c.value===d.value&&d.value===p.value&&(c.value!==0&&!this.isContinuedWhammy?this.whammyBarType=Le.Predive:this.whammyBarType=Le.Hold,l.splice(2,1),l.splice(1,1)))}else if(l.length===2){const c=l[0],d=l[1];c.value<d.value||c.value>d.value?c.value!==0&&!this.isContinuedWhammy?this.whammyBarType=Le.PrediveDive:this.whammyBarType=Le.Dive:c.value===d.value&&(c.value!==0&&!this.isContinuedWhammy?this.whammyBarType=Le.Predive:this.whammyBarType=Le.Hold)}}if(this.updateDurations(),r){const c=Qa.clone(this);c.id=wt._globalBeatId++,c.pickStroke=kt.None;for(let d=0,f=c.notes.length;d<f;d++){const p=c.notes[d],g=this.notes[d];if(p.bendType=q.None,p.maxBendPoint=null,p.bendPoints=null,p.bendStyle=ze.Default,p.id=mt.globalNoteId++,g.isTieOrigin&&(p.tieDestination=g.tieDestination,g.tieDestination.tieOrigin=p),g.isTieDestination&&(p.tieOrigin=g.tieOrigin?g.tieOrigin:null,g.tieOrigin.tieDestination=p),g.hasBend&&g.isTieOrigin){const m=mt.findTieOrigin(g);if(m&&m.hasBend){p.bendType=q.Hold;const b=g.bendPoints[g.bendPoints.length-1];p.addBendPoint(new H(0,b.value)),p.addBendPoint(new H(H.MaxPosition,b.value))}}p.isTieDestination=!0}this.graceType=$.BendGrace,this.graceGroup=new qa,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,c),c.graceGroup=new qa,c.graceGroup.addBeat(this),c.graceGroup.isComplete=!0,c.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(const t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}}class Vn{static clone(e){const t=new H;return t.offset=e.offset,t.value=e.value,t}}class Hn{static clone(e){const t=new mt;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints){t.bendPoints=[];for(const s of e.bendPoints)t.addBendPoint(Vn.clone(s))}return t.fret=e.fret,t.string=e.string,t.showStringNumber=e.showStringNumber,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.ornament=e.ornament,t}}class Ll{static clone(e){const t=new Ur;return t.barOccurence=e.barOccurence,t.millisecondOffset=e.millisecondOffset,t}}class Fl{static clone(e){const t=new Ye;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.syncPointValue=e.syncPointValue?Ll.clone(e.syncPointValue):void 0,t.ratioPosition=e.ratioPosition,t.text=e.text,t.isVisible=e.isVisible,t}}class Qa{static clone(e){const t=new wt;t.index=e.index,t.notes=[];for(const s of e.notes)t.addNote(Hn.clone(s));t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[];for(const s of e.automations)t.automations.push(Fl.clone(s));if(t.dots=e.dots,t.fade=e.fade,t.lyrics=e.lyrics?e.lyrics.slice():null,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.slashed=e.slashed,t.deadSlapped=e.deadSlapped,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,e.whammyBarPoints){t.whammyBarPoints=[];for(const s of e.whammyBarPoints)t.addWhammyBarPoint(Vn.clone(s))}return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.overrideDisplayDuration=e.overrideDisplayDuration,t.golpe=e.golpe,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t.wahPedal=e.wahPedal,t.barreFret=e.barreFret,t.barreShape=e.barreShape,t.rasgueado=e.rasgueado,t.showTimer=e.showTimer,t.timer=e.timer,t}}class U{static _reverse(e){const t=new Map;for(const[s,i]of e)t.has(i)||t.set(i,s);return t}static whammyType=new Map([["custom",1],["dive",2],["dip",3],["hold",4],["predive",5],["predivedive",6]]);static whammyTypeReversed=U._reverse(U.whammyType);static bendStyle=new Map([["default",0],["gradual",1],["fast",2]]);static bendStyleReversed=U._reverse(U.bendStyle);static graceType=new Map([["onbeat",1],["beforebeat",2],["bendgrace",3],["ob",1],["bb",2],["b",3]]);static graceTypeReversed=U._reverse(U.graceType);static fermataType=new Map([["short",0],["medium",1],["long",2]]);static fermataTypeReversed=U._reverse(U.fermataType);static alphaTexAccidentalMode=new Map([["auto",0],["explicit",1]]);static alphaTexAccidentalModeReversed=U._reverse(U.alphaTexAccidentalMode);static noteAccidentalMode=new Map([["default",0],["forcenone",1],["forcenatural",2],["forcesharp",3],["forcedoublesharp",4],["forceflat",5],["forcedoubleflat",6],["d",0],["-",1],["n",2],["#",3],["##",4],["x",4],["b",5],["bb",6]]);static noteAccidentalModeReversed=U._reverse(U.noteAccidentalMode);static barreShape=new Map([["full",1],["half",2]]);static barreShapeReversed=U._reverse(U.barreShape);static ottavia=new Map([["15ma",0],["8va",1],["regular",2],["8vb",3],["15mb",4],["15ma",0],["8va",1],["8vb",3],["15mb",4]]);static ottaviaReversed=U._reverse(U.ottavia);static rasgueado=new Map([["ii",1],["mi",2],["miitriplet",3],["miianapaest",4],["pmptriplet",5],["pmpanapaest",6],["peitriplet",7],["peianapaest",8],["paitriplet",9],["paianapaest",10],["amitriplet",11],["amianapaest",12],["ppp",13],["amii",14],["amip",15],["eami",16],["eamii",17],["peami",18]]);static rasgueadoReversed=U._reverse(U.rasgueado);static dynamicValue=new Map([["ppp",0],["pp",1],["p",2],["mp",3],["mf",4],["f",5],["ff",6],["fff",7],["pppp",8],["ppppp",9],["pppppp",10],["ffff",11],["fffff",12],["ffffff",13],["sf",14],["sfp",15],["sfpp",16],["fp",17],["rf",18],["rfz",19],["sfz",20],["sffz",21],["fz",22],["n",23],["pf",24],["sfzp",25]]);static dynamicValueReversed=U._reverse(U.dynamicValue);static bracketExtendMode=new Map([["nobrackets",0],["groupstaves",1],["groupsimilarinstruments",2]]);static bracketExtendModeReversed=U._reverse(U.bracketExtendMode);static trackNamePolicy=new Map([["hidden",0],["firstsystem",1],["allsystems",2]]);static trackNamePolicyReversed=U._reverse(U.trackNamePolicy);static trackNameOrientation=new Map([["horizontal",0],["vertical",1]]);static trackNameOrientationReversed=U._reverse(U.trackNameOrientation);static trackNameMode=new Map([["fullname",0],["shortname",1]]);static trackNameModeReversed=U._reverse(U.trackNameMode);static textAlign=new Map([["left",0],["center",1],["right",2]]);static textAlignReversed=U._reverse(U.textAlign);static bendType=new Map([["custom",1],["bend",2],["release",3],["bendrelease",4],["hold",5],["prebend",6],["prebendbend",7],["prebendrelease",8]]);static bendTypeReversed=U._reverse(U.bendType);static keySignature=new Map([["cb",-7],["gb",-6],["db",-5],["ab",-4],["eb",-3],["bb",-2],["f",-1],["c",0],["g",1],["d",2],["a",3],["e",4],["b",5],["f#",6],["c#",7],["cbmajor",-7],["abminor",-7],["gbmajor",-6],["ebminor",-6],["dbmajor",-5],["bbminor",-5],["abmajor",-4],["fminor",-4],["ebmajor",-3],["cminor",-3],["bbmajor",-2],["gminor",-2],["fmajor",-1],["dminor",-1],["cmajor",0],["aminor",0],["gmajor",1],["eminor",1],["dmajor",2],["bminor",2],["amajor",3],["f#minor",3],["emajor",4],["c#minor",4],["bmajor",5],["g#minor",5],["f#major",6],["d#minor",6],["f#",6],["c#major",7],["a#minor",7],["c#",7]]);static keySignatureReversed=U._reverse(U.keySignature);static keySignatureType=new Map([["major",0],["minor",1],["cb",0],["cbmajor",0],["gb",0],["gbmajor",0],["db",0],["dbmajor",0],["ab",0],["abmajor",0],["eb",0],["ebmajor",0],["bb",0],["bbmajor",0],["f",0],["fmajor",0],["c",0],["cmajor",0],["g",0],["gmajor",0],["d",0],["dmajor",0],["a",0],["amajor",0],["e",0],["emajor",0],["b",0],["bmajor",0],["f#",0],["f#major",0],["c#",0],["c#major",0],["abminor",1],["ebminor",1],["bbminor",1],["fminor",1],["cminor",1],["gminor",1],["dminor",1],["aminor",1],["eminor",1],["bminor",1],["f#minor",1],["c#minor",1],["g#minor",1],["d#minor",1],["a#minor",1]]);static keySignatureTypeReversed=U._reverse(U.keySignatureType);static clef=new Map([["neutral",0],["c3",1],["c4",2],["f4",3],["g2",4],["n",0],["alto",1],["tenor",2],["bass",3],["treble",4]]);static clefReversed=U._reverse(U.clef);static tripletFeel=new Map([["none",0],["triplet16th",1],["triplet8th",2],["dotted16th",3],["dotted8th",4],["scottish16th",5],["scottish8th",6],["none",0],["no",0],["notripletfeel",0],["t16",1],["triplet-16th",1],["t8",2],["triplet-8th",2],["d16",3],["dotted-16th",3],["d8",4],["dotted-8th",4],["s16",5],["scottish-16th",5],["s8",6],["scottish-8th",6]]);static tripletFeelReversed=U._reverse(U.tripletFeel);static barLineStyle=new Map([["automatic",0],["dashed",1],["dotted",2],["heavy",3],["heavyheavy",4],["heavylight",5],["lightheavy",6],["lightlight",7],["none",8],["regular",9],["short",10],["tick",11]]);static barLineStyleReversed=U._reverse(U.barLineStyle);static simileMark=new Map([["none",0],["simple",1],["firstofdouble",2],["secondofdouble",3]]);static simileMarkReversed=U._reverse(U.simileMark);static direction=new Map([["fine",0],["segno",1],["segnosegno",2],["coda",3],["doublecoda",4],["dacapo",5],["dacapoalcoda",6],["dacapoaldoublecoda",7],["dacapoalfine",8],["dalsegno",9],["dalsegnoalcoda",10],["dalsegnoaldoublecoda",11],["dalsegnoalfine",12],["dalsegnosegno",13],["dalsegnosegnoalcoda",14],["dalsegnosegnoaldoublecoda",15],["dalsegnosegnoalfine",16],["dacoda",17],["dadoublecoda",18]]);static directionReversed=U._reverse(U.direction);static keySignaturesMinorReversed=new Map([[-7,"abminor"],[-6,"ebminor"],[-5,"bbminor"],[-4,"fminor"],[-3,"cminor"],[-2,"gminor"],[-1,"dminor"],[0,"aminor"],[1,"eminor"],[2,"bminor"],[3,"f#minor"],[4,"c#minor"],[5,"g#minor"],[6,"d#minor"],[7,"a#minor"]]);static keySignaturesMajorReversed=new Map([[-7,"cb"],[-6,"gb"],[-5,"db"],[-4,"ab"],[-3,"eb"],[-2,"bb"],[-1,"f"],[0,"c"],[1,"g"],[2,"d"],[3,"a"],[4,"e"],[5,"b"],[6,"f#"],[7,"c#"]])}class Ae{static _param(e){return e?{expectedTypes:new Set(e[0]),parseMode:e[1],allowedValues:e.length>2&&e[2]&&e[2].length>0?new Set(e[2]):void 0,reservedIdentifiers:e.length>3&&e[3]&&e[3].length>0?new Set(e[3]):void 0}:null}static _simple(e){return e==null?null:e.map(t=>({isStrict:t.length>0&&t[0]===null,parameters:t.map(Ae._param).filter(s=>s!==null)}))}static _metaProps(e){return new Map(e.map(t=>[t[0],t[1]===null?null:new Map(t[1].map(s=>[s[0],Ae._simple(s[1])]))]))}static _props(e){return new Map(e.map(t=>[t[0],Ae._simple(t[1])]))}static _signatures(e){return new Map(e.map(t=>[t[0],Ae._simple(t[1])]))}static scoreMetaDataSignatures=Ae._signatures([["title",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["subtitle",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["artist",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["album",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["words",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["music",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["wordsandmusic",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["copyright",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["copyright2",[[[[17],0],[[10,17],1,["left","center","right"]]]]],["instructions",[[[[17,10],0]]]],["notices",[[[[17,10],0]]]],["tab",[[[[17,10],0],[[17],1],[[10,17],1,["left","center","right"]]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",[[[[10,17],0,["nobrackets","groupstaves","groupsimilarinstruments"]]]]],["singletracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["multitracktracknamepolicy",[[[[10,17],0,["hidden","firstsystem","allsystems"]]]]],["firstsystemtracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["othersystemstracknamemode",[[[[10,17],0,["fullname","shortname"]]]]],["firstsystemtracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]],["othersystemstracknameorientation",[[[[10,17],0,["horizontal","vertical"]]]]]]);static staffMetaDataSignatures=Ae._signatures([["tuning",[[[[10,17],0,["piano","none","voice"]]],[[[10,17],5]]]],["chord",[[[[17,10],0],[[10,17,16],5]]]],["capo",[[[[16],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["articulation",[[[[10],0,["defaults"]]],[[[17,10],0],[[16],0]]]],["displaytranspose",[[[[16],0]]]],["transpose",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]]]);static structuralMetaDataSignatures=Ae._signatures([["track",[[[[17],1],[[17],1]]]],["staff",null],["voice",null]]);static barMetaDataSignatures=Ae._signatures([["ts",[[[[10,17],0,["common"]]],[[[16],0],[[16],0]]]],["ro",null],["rc",[[[[16],0]]]],["ae",[[[[16,13],4]]]],["ks",[[[[10,17],0,["cb","gb","db","ab","eb","bb","f","c","g","d","a","e","b","f#","c#","cbmajor","abminor","gbmajor","ebminor","dbmajor","bbminor","abmajor","fminor","ebmajor","cminor","bbmajor","gminor","fmajor","dminor","cmajor","aminor","gmajor","eminor","dmajor","bminor","amajor","f#minor","emajor","c#minor","bmajor","g#minor","f#major","d#minor","f#","c#major","a#minor","c#"]]]]],["clef",[[[[10,16,17],0,["neutral","c3","c4","f4","g2","n","alto","tenor","bass","treble"]]]]],["ottava",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["tempo",[[[[16],2],[[17],1]],[null,[[16],2],[[17],0],[[16],1],[[10],1,["hide"]]]]],["tf",[[[[10,16,17],0,["none","triplet16th","triplet8th","dotted16th","dotted8th","scottish16th","scottish8th","none","no","notripletfeel","t16","triplet-16th","t8","triplet-8th","d16","dotted-16th","d8","dotted-8th","s16","scottish-16th","s8","scottish-8th"]]]]],["ac",null],["section",[[[[17,10],0]],[[[17,10],0],[[17,10],0,null,["x","-","r"]]]]],["jump",[[[[10,17],0,["fine","segno","segnosegno","coda","doublecoda","dacapo","dacapoalcoda","dacapoaldoublecoda","dacapoalfine","dalsegno","dalsegnoalcoda","dalsegnoaldoublecoda","dalsegnoalfine","dalsegnosegno","dalsegnosegnoalcoda","dalsegnosegnoaldoublecoda","dalsegnosegnoalfine","dacoda","dadoublecoda"]]]]],["ft",null],["simile",[[[[10,17],0,["none","simple","firstofdouble","secondofdouble"]]]]],["barlineleft",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["barlineright",[[[[10,17],0,["automatic","dashed","dotted","heavy","heavyheavy","heavylight","lightheavy","lightlight","none","regular","short","tick"]]]]],["scale",[[[[16],2]]]],["width",[[[[16],2]]]],["sync",[[[[16],0],[[16],0],[[16],0],[[16],3]]]],["accidentals",[[[[10,17],0,["auto","explicit"]]]]],["spd",[[[[16],2]]]],["sph",[[[[16],2]]]],["spu",[[[[16],2]]]],["db",null]]);static metaDataProperties=Ae._metaProps([["track",[["color",[[[[17],0]]]],["systemslayout",[[[[16],5]]]],["defaultsystemslayout",[[[[16],0]]]],["solo",null],["mute",null],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["multibarrest",null]]],["staff",[["score",[[[[16],1]]]],["tabs",null],["slash",null],["numbered",null]]],["voice",null],["title",null],["subtitle",null],["artist",null],["album",null],["words",null],["music",null],["wordsandmusic",null],["copyright",null],["copyright2",null],["instructions",null],["notices",null],["tab",null],["systemslayout",null],["defaultsystemslayout",null],["showdynamics",null],["hidedynamics",null],["usesystemsignseparator",null],["multibarrest",null],["bracketextendmode",null],["singletracktracknamepolicy",null],["multitracktracknamepolicy",null],["firstsystemtracknamemode",null],["othersystemstracknamemode",null],["firstsystemtracknameorientation",null],["othersystemstracknameorientation",null],["tuning",[["hide",null],["label",[[[[17],0]]]]]],["chord",[["firstfret",[[[[16],0]]]],["barre",[[[[16],5]]]],["showdiagram",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showfingering",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]],["showname",[[],[[[17],0,["true","false"]]],[[[10],0,["true","false"]]],[[[16],0,["1","0"]]]]]]],["capo",null],["lyrics",null],["articulation",null],["displaytranspose",null],["transpose",null],["instrument",null],["ts",null],["ro",null],["rc",null],["ae",null],["ks",null],["clef",null],["ottava",null],["tempo",null],["tf",null],["ac",null],["section",null],["jump",null],["ft",null],["simile",null],["barlineleft",null],["barlineright",null],["scale",null],["width",null],["sync",null],["accidentals",null],["spd",null],["sph",null],["spu",null],["db",null]]);static metaDataSignatures=[Ae.scoreMetaDataSignatures,Ae.staffMetaDataSignatures,Ae.structuralMetaDataSignatures,Ae.barMetaDataSignatures];static durationChangeProperties=Ae._props([["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]]]);static beatProperties=Ae._props([["f",null],["fo",null],["vs",null],["v",null],["vw",null],["s",null],["p",null],["tt",null],["d",null],["dd",null],["su",null],["sd",null],["cre",null],["dec",null],["spd",null],["sph",null],["spu",null],["spe",null],["slashed",null],["ds",null],["glpf",null],["glpt",null],["waho",null],["wahc",null],["legatoorigin",null],["timer",null],["tu",[[[[16],0,["3","5","6","7","9","10","12"]]],[[[16],0],[[16],0]]]],["txt",[[[[17,10],0]]]],["lyrics",[[[[17],0]],[[[16],0],[[17],0]]]],["tb",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["tbe",[[[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","dive","dip","hold","predive","predivedive"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["bu",[[[[16],1]]]],["bd",[[[[16],1]]]],["au",[[[[16],1]]]],["ad",[[[[16],1]]]],["ch",[[[[17,10],0]]]],["gr",[[[[10,17],1,["onbeat","beforebeat","bendgrace","ob","bb","b"]]]]],["dy",[[[[10,17],0,["ppp","pp","p","mp","mf","f","ff","fff","pppp","ppppp","pppppp","ffff","fffff","ffffff","sf","sfp","sfpp","fp","rf","rfz","sfz","sffz","fz","n","pf","sfzp"]]]]],["tempo",[[[[16],0],[[10],1,["hide"]]],[[[16],0],[[17],0],[[10],1,["hide"]]]]],["volume",[[[[16],0]]]],["balance",[[[[16],0]]]],["tp",[[[[16],0,["8","16","32"]]]]],["barre",[[[[16],0],[[10,17],1,["full","half"]]]]],["rasg",[[[[10,17],0,["ii","mi","miitriplet","miianapaest","pmptriplet","pmpanapaest","peitriplet","peianapaest","paitriplet","paianapaest","amitriplet","amianapaest","ppp","amii","amip","eami","eamii","peami"]]]]],["ot",[[[[10,17],0,["15ma","8va","regular","8vb","15mb","15ma","8va","8vb","15mb"]]]]],["instrument",[[[[16],0]],[[[17,10],0]],[[[10],0,["percussion"]]]]],["bank",[[[[16],0]]]],["fermata",[[[[10,17],0,["short","medium","long"]],[[16],3]]]],["beam",[[[[10,17],0,["invert","up","down","auto","split","merge","splitsecondary"]]]]]]);static noteProperties=Ae._props([["nh",null],["ah",[[[[16],1]]]],["th",[[[[16],1]]]],["ph",[[[[16],1]]]],["sh",[[[[16],1]]]],["fh",[[[[16],1]]]],["v",null],["vw",null],["sl",null],["ss",null],["sib",null],["sia",null],["sou",null],["sod",null],["psu",null],["psd",null],["h",null],["lht",null],["g",null],["ac",null],["hac",null],["ten",null],["tr",[[[[16],0],[[16],1,["16","32","64"]]]]],["pm",null],["st",null],["lr",null],["x",null],["t",null],["turn",null],["iturn",null],["umordent",null],["lmordent",null],["string",null],["hide",null],["b",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["be",[[[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[16],5]],[[[10,17],0,["default","gradual","fast"]],[[16],5]],[[[10,17],0,["custom","bend","release","bendrelease","hold","prebend","prebendbend","prebendrelease"]],[[10,17],0,["default","gradual","fast"]],[[16],5]]]],["lf",[[[[16],0,["1","2","3","4","5"]]]]],["rf",[[[[16],0,["1","2","3","4","5"]]]]],["acc",[[[[10,17],0,["default","forcenone","forcenatural","forcesharp","forcedoublesharp","forceflat","forcedoubleflat","d","-","n","#","##","x","b","bb"]]]]],["slur",[[[[17],0]],[[[10],0]]]],["-",null]])}var D;(function(a){a[a.Dot=0]="Dot",a[a.Backslash=1]="Backslash",a[a.DoubleBackslash=2]="DoubleBackslash",a[a.Pipe=3]="Pipe",a[a.LBrace=4]="LBrace",a[a.RBrace=5]="RBrace",a[a.LParen=6]="LParen",a[a.RParen=7]="RParen",a[a.Colon=8]="Colon",a[a.Asterisk=9]="Asterisk",a[a.Ident=10]="Ident",a[a.Tag=11]="Tag",a[a.Meta=12]="Meta",a[a.Arguments=13]="Arguments",a[a.Props=14]="Props",a[a.Prop=15]="Prop",a[a.Number=16]="Number",a[a.String=17]="String",a[a.Score=18]="Score",a[a.Bar=19]="Bar",a[a.Beat=20]="Beat",a[a.Duration=21]="Duration",a[a.NoteList=22]="NoteList",a[a.Note=23]="Note"})(D||(D={}));var he;(function(a){a[a.Hint=0]="Hint",a[a.Warning=1]="Warning",a[a.Error=2]="Error"})(he||(he={}));var ue;(function(a){a[a.AT001=1]="AT001",a[a.AT002=2]="AT002",a[a.AT003=3]="AT003",a[a.AT004=4]="AT004",a[a.AT005=5]="AT005",a[a.AT006=6]="AT006",a[a.AT200=200]="AT200",a[a.AT201=201]="AT201",a[a.AT202=202]="AT202",a[a.AT203=203]="AT203",a[a.AT204=204]="AT204",a[a.AT205=205]="AT205",a[a.AT206=206]="AT206",a[a.AT207=207]="AT207",a[a.AT208=208]="AT208",a[a.AT209=209]="AT209",a[a.AT210=210]="AT210",a[a.AT211=211]="AT211",a[a.AT212=212]="AT212",a[a.AT213=213]="AT213",a[a.AT214=214]="AT214",a[a.AT215=215]="AT215",a[a.AT216=216]="AT216",a[a.AT217=217]="AT217",a[a.AT218=218]="AT218",a[a.AT219=219]="AT219",a[a.AT220=220]="AT220",a[a.AT300=300]="AT300",a[a.AT301=301]="AT301",a[a.AT302=302]="AT302",a[a.AT303=303]="AT303",a[a.AT304=304]="AT304",a[a.AT305=305]="AT305",a[a.AT306=306]="AT306",a[a.AT400=400]="AT400"})(ue||(ue={}));class Ka{_hasErrors=!1;items=[];get errors(){return this.items.filter(e=>e.severity===he.Error)}get hasErrors(){return this._hasErrors}push(e){this.items.push(e),e.severity===he.Error&&(this._hasErrors=!0)}[Symbol.iterator](){return this.items[Symbol.iterator]()}}var Xr;(function(a){a[a.Auto=0]="Auto",a[a.Explicit=1]="Explicit"})(Xr||(Xr={}));var Gt;(function(a){a[a.Pitched=0]="Pitched",a[a.Fretted=1]="Fretted",a[a.Articulation=2]="Articulation"})(Gt||(Gt={}));var Bt;(function(a){a[a.Required=0]="Required",a[a.Optional=1]="Optional",a[a.RequiredAsFloat=2]="RequiredAsFloat",a[a.OptionalAsFloat=3]="OptionalAsFloat",a[a.RequiredAsValueList=4]="RequiredAsValueList",a[a.ValueListWithoutParenthesis=5]="ValueListWithoutParenthesis"})(Bt||(Bt={}));class de{static _conversionBuffer=new ArrayBuffer(8);static _conversionByteArray=new Uint8Array(de._conversionBuffer);static _dataView=new DataView(de._conversionBuffer);static float64ToBytes(e){return de._dataView.setFloat64(0,e,!0),de._conversionByteArray}static bytesToInt64LE(e){de._conversionByteArray.set(e,0);const t=de._dataView.getBigInt64(0,!0);return t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER?Number(t):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(e){return de._conversionByteArray.set(e,0),de._dataView.getFloat64(0,!0)}static bytesToFloat32LE(e){return de._conversionByteArray.set(e,0),de._dataView.getFloat32(0,!0)}static float32BEToBytes(e){return de._dataView.setFloat32(0,e,!1),de._conversionByteArray.slice(0,4)}static uint16ToInt16(e){return de._dataView.setUint16(0,e,!0),de._dataView.getInt16(0,!0)}static int16ToUint32(e){return de._dataView.setInt16(0,e,!0),de._dataView.getUint32(0,!0)}static int32ToUint16(e){return de._dataView.setInt32(0,e,!0),de._dataView.getUint16(0,!0)}static int32ToInt16(e){return de._dataView.setInt32(0,e,!0),de._dataView.getInt16(0,!0)}static int32ToUint32(e){return de._dataView.setInt32(0,e,!0),de._dataView.getUint32(0,!0)}static uint8ToInt8(e){return de._dataView.setUint8(0,e),de._dataView.getInt8(0)}}class B{static readInt32BE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte(),r=e.readByte();return t<<24|s<<16|i<<8|r}static readFloat32BE(e){const t=new Uint8Array(4);return e.read(t,0,t.length),t.reverse(),de.bytesToFloat32LE(t)}static readFloat64BE(e){const t=new Uint8Array(8);return e.read(t,0,t.length),t.reverse(),de.bytesToFloat64LE(t)}static readInt32LE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readInt64LE(e){const t=new Uint8Array(8);return e.read(t,0,t.length),de.bytesToInt64LE(t)}static readUInt32LE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static decodeUInt32LE(e,t){const s=e[t],i=e[t+1],r=e[t+2];return e[t+3]<<24|r<<16|i<<8|s}static readUInt16LE(e){const t=e.readByte(),s=e.readByte();return de.int32ToUint16(s<<8|t)}static readInt16LE(e){const t=e.readByte(),s=e.readByte();return de.int32ToInt16(s<<8|t)}static readUInt32BE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte(),r=e.readByte();return de.int32ToUint32(t<<24|s<<16|i<<8|r)}static readUInt16BE(e){const t=e.readByte(),s=e.readByte();return de.int32ToInt16(t<<8|s)}static readInt16BE(e){const t=e.readByte(),s=e.readByte();return de.int32ToInt16(t<<8|s)}static readByteArray(e,t){const s=new Uint8Array(t);return e.read(s,0,t),s}static read8BitChars(e,t){const s=new Uint8Array(t);return e.read(s,0,s.length),B.toString(s,"utf-8")}static read8BitString(e){let t="",s=e.readByte();for(;s!==0;)t+=String.fromCharCode(s),s=e.readByte();return t}static read8BitStringLength(e,t){let s="",i=-1;for(let n=0;n<t;n++){const o=e.readByte();o===0&&i===-1&&(i=n),s+=String.fromCharCode(o)}const r=s;return i>=0?r.substr(0,i):r}static readSInt8(e){const t=e.readByte();return((t&255)>>7)*-256+(t&255)}static readInt24(e,t){let s=e[t]|e[t+1]<<8|e[t+2]<<16;return(s&8388608)===8388608&&(s=s|255<<24),s}static readInt16(e,t){return de.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){const s=B._detectEncoding(e);return s&&(t=s),t||(t="utf-8"),new TextDecoder(t).decode(e.buffer)}static _detectEncoding(e){return e.length>2&&e[0]===254&&e[1]===255?"utf-16be":e.length>2&&e[0]===255&&e[1]===254?"utf-16le":e.length>4&&e[0]===0&&e[1]===0&&e[2]===254&&e[3]===255?"utf-32be":e.length>4&&e[0]===255&&e[1]===254&&e[2]===0&&e[3]===0?"utf-32le":null}static stringToBytes(e){return new TextEncoder().encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeInt32LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeFloat32BE(e,t){const s=de.float32BEToBytes(t);e.write(s,0,s.length)}static*iterateCodepoints(e){let t=0;for(;t<e.length;){let s=e.charCodeAt(t);B.isLeadingSurrogate(s)&&t+1<e.length&&(t++,s=(s-55296)*1024+(e.charCodeAt(t)-56320)+65536),t++,yield s}}static isLeadingSurrogate(e){return e>=55296&&e<=56319}static isTrailingSurrogate(e){return e>=56320&&e<=57343}}class at{static _eof=0;_codepoints;_codepoint=at._eof;_offset=0;_line=1;_col=1;fatalError=!1;_tokenStart={line:0,col:0,offset:0};_leadingComments;_trailingCommentNode;_previousToken;_peekedToken;lexerDiagnostics=new Ka;constructor(e){this._codepoints=[...B.iterateCodepoints(e)],this._offset=0,this._line=1,this._col=1,this._codepoint=this._codepoints.length>0?this._codepoints[0]:at._eof}peekToken(){if(this.fatalError)return;let e=this._peekedToken;return e||(e=this._readToken(),this._peekedToken=e,e)}extendToFloat(e){if(this._codepoint!==46||this._offset+1>=this._codepoints.length||!at._isDigit(this._codepoints[this._offset+1]))return e;let t=this._offset+2;for(;t<this._codepoints.length&&at._isDigit(this._codepoints[t]);)t++;if(t<this._codepoints.length&&at._isIdentifierCharacter(this._codepoints[t]))return e;const s=t-this._offset-1;return this._offset+=s,this._col+=s,this._nextCodepoint(),e.end=this._currentLexerLocation(),e.value=Number.parseFloat(String.fromCodePoint(...this._codepoints.slice(e.start.offset,e.end.offset))),e}advance(){this._previousToken=this._peekedToken,this._peekedToken=void 0}_nextCodepoint(){const e=this._codepoints;let t=this._offset;if(t<e.length-1){e[t]===10?(this._trailingCommentNode=void 0,++this._line,this._col=1):++this._col,++t;const i=e[t];return this._codepoint=i,this._offset=t,i}else this._codepoint!==at._eof&&(this._codepoint=at._eof,++this._col,this._offset=e.length);return at._eof}previousTokenEndLocation(){return this._previousToken?.end??this._currentLexerLocation()}currentTokenLocation(){return this._peekedToken?.start??this._currentLexerLocation()}_currentLexerLocation(){return{line:this._line,col:this._col,offset:this._offset}}_readToken(){for(this._leadingComments=void 0;this._codepoint!==at._eof&&!this.fatalError;)if(this._tokenStart=this._currentLexerLocation(),at._terminalTokens.has(this._codepoint)){const e=at._terminalTokens.get(this._codepoint)(this);if(e)return this._trailingCommentNode=e,e}else if(at._isIdentifierCharacter(this._codepoint)){const e=this._numberOrIdentifier();return this._trailingCommentNode=e,e}else this._codepoint=this._nextCodepoint()}_comment(){this._codepoint=this._nextCodepoint(),this._codepoint===47?this._singleLineComment():this._codepoint===42?this._multiLineComment():(this.lexerDiagnostics.push({code:ue.AT001,message:`Unexpected character at comment start, expected '//' or '/*' but found '/${String.fromCodePoint(this._codepoint)}'`,severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0)}static _terminalTokens=new Map([[47,e=>e._comment()],[34,e=>e._string()],[39,e=>e._string()],[45,e=>e._numberOrIdentifier()],[46,e=>e._token({nodeType:D.Dot})],[58,e=>e._token({nodeType:D.Colon})],[40,e=>e._token({nodeType:D.LParen})],[41,e=>e._token({nodeType:D.RParen})],[123,e=>e._token({nodeType:D.LBrace})],[125,e=>e._token({nodeType:D.RBrace})],[124,e=>e._token({nodeType:D.Pipe})],[42,e=>e._token({nodeType:D.Asterisk})],[92,e=>e._metaCommand()],[9,e=>e._whitespace()],[10,e=>e._whitespace()],[11,e=>e._whitespace()],[13,e=>e._whitespace()],[32,e=>e._whitespace()]]);_metaCommand(){const e=this._currentLexerLocation();this._codepoint=this._nextCodepoint();let t,s;this._codepoint===92?(this._codepoint=this._nextCodepoint(),s=this._currentLexerLocation(),t={nodeType:D.DoubleBackslash,start:e,end:s}):(s=this._currentLexerLocation(),t={nodeType:D.Backslash,start:e,end:s});let i="";for(;at._isIdentifierCharacter(this._codepoint);)i+=String.fromCodePoint(this._codepoint),this._codepoint=this._nextCodepoint();if(i.length===0){this.lexerDiagnostics.push({code:ue.AT002,message:"Missing identifier after meta data start",severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()});return}return{nodeType:D.Tag,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),prefix:t,tag:{nodeType:D.Ident,text:i,start:s,end:this._currentLexerLocation()}}}_token(e){return e.leadingComments=this._leadingComments,e.start=this._tokenStart,this._codepoint=this._nextCodepoint(),e.end=this._currentLexerLocation(),e}_string(){const e=this._codepoint;this._codepoint=this._nextCodepoint();let t="",s=-1;for(;this._codepoint!==e&&this._codepoint!==at._eof;){let r=-1;if(this._codepoint===92)if(this._codepoint=this._nextCodepoint(),this._codepoint===92)r=92;else if(this._codepoint===e)r=e;else if(this._codepoint===82||this._codepoint===114)r=13;else if(this._codepoint===78||this._codepoint===110)r=10;else if(this._codepoint===84||this._codepoint===116)r=9;else if(this._codepoint===117){let n="";for(let o=0;o<4;o++){if(this._codepoint=this._nextCodepoint(),this._codepoint===at._eof){this.lexerDiagnostics.push({code:ue.AT003,message:"Unexpected end of file. Need 4 hex characters on a \\uXXXX escape sequence",severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}n+=String.fromCodePoint(this._codepoint)}if(r=Number.parseInt(n,16),Number.isNaN(r)){this.lexerDiagnostics.push({code:ue.AT004,message:"Invalid unicode value. Need 4 hex characters on a \\uXXXX escape sequence.",severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}}else{this.lexerDiagnostics.push({code:ue.AT005,message:`Unsupported escape sequence. Expected '\\n', '\\r', '\\t', or '\\uXXXX' but found '\\${String.fromCodePoint(this._codepoint)}'.`,severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}else r=this._codepoint;B.isLeadingSurrogate(s)&&B.isTrailingSurrogate(r)?(r=(s-55296)*1024+(r-56320)+65536,t+=String.fromCodePoint(r)):B.isLeadingSurrogate(r)||(B.isLeadingSurrogate(s)&&(t+=String.fromCodePoint(s)),r>0&&(t+=String.fromCodePoint(r))),s=r,this._codepoint=this._nextCodepoint()}if(this._codepoint===at._eof){this.lexerDiagnostics.push({code:ue.AT006,message:"Unexpected end of file. String not closed.",severity:he.Error,start:this._tokenStart,end:this._currentLexerLocation()}),this.fatalError=!0;return}const i={nodeType:D.String,text:t,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation()};return this._codepoint=this._nextCodepoint(),i}_multiLineComment(){const e=this._trailingCommentNode,t={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!0};for(;this._codepoint!==at._eof;)if(this._codepoint===42)if(this._codepoint=this._nextCodepoint(),this._codepoint===47){this._codepoint=this._nextCodepoint();break}else t.text+=`*${String.fromCodePoint(this._codepoint)}`,t.end.line=this._line,t.end.col=this._col,t.end.offset=this._offset;else this._codepoint=this._nextCodepoint(),t.text+=String.fromCodePoint(this._codepoint),t.end.line=this._line,t.end.col=this._col,t.end.offset=this._offset;e?(e.trailingComments??=[],e.trailingComments.push(t)):(this._leadingComments??=[],this._leadingComments.push(t))}_numberOrIdentifier(){let e="",t=!0,s=this._codepoint;s===45&&(e+=String.fromCodePoint(s),s=this._nextCodepoint(),at._isDigit(s)||(t=!1));let i=!0;do t?at._isDigit(s)?(e+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):at._isIdentifierCharacter(s)?(t=!1,e+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):i=!1:at._isIdentifierCharacter(s)?(e+=String.fromCodePoint(s),s=this._nextCodepoint(),i=!0):i=!1;while(i);return t?{nodeType:D.Number,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),value:Number.parseInt(e,10)}:{nodeType:D.Ident,leadingComments:this._leadingComments,start:this._tokenStart,end:this._currentLexerLocation(),text:e}}_singleLineComment(){const e=this._trailingCommentNode,t={start:this._tokenStart,end:this._currentLexerLocation(),text:"",multiLine:!1};let s=this._codepoint;for(;s!==at._eof&&(s=this._nextCodepoint(),s!==10&&s!==at._eof);)t.text+=String.fromCodePoint(s),t.end.line=this._line,t.end.col=this._col,t.end.offset=this._offset;e?(e.trailingComments??=[],e.trailingComments.push(t)):(this._leadingComments??=[],this._leadingComments.push(t))}_whitespace(){let e=this._codepoint;for(;at._isWhiteSpace(e);)e===10&&(this._trailingCommentNode=void 0),e=this._nextCodepoint()}static _isDigit(e){return e>=48&&e<=57}static _buildNonIdentifierChars(){const e=new Set;for(const t of at._terminalTokens.keys())e.add(t);return e.delete(45),e.add(at._eof),e}static _nonIdentifierChars=at._buildNonIdentifierChars();static _isIdentifierCharacter(e){return!at._nonIdentifierChars.has(e)}static _isWhiteSpace(e){return e===32||e===10||e===13||e===9||e===11}}var Qi;(function(a){a[a.ForModelImport=0]="ForModelImport",a[a.Full=1]="Full"})(Qi||(Qi={}));class Gn{lexer;_scoreNode;_metaDataReader=xt.instance;mode=Qi.ForModelImport;get lexerDiagnostics(){return this.lexer.lexerDiagnostics}parserDiagnostics=new Ka;addParserDiagnostic(e){this.parserDiagnostics.push(e)}unexpectedToken(e,t,s){e?this.addParserDiagnostic({code:ue.AT202,message:`Unexpected '${D[e.nodeType]}' token. Expected one of following: ${t.map(i=>D[i]).join(",")}`,severity:he.Error,start:e.start,end:e.end}):this.addParserDiagnostic({code:ue.AT203,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation(),severity:he.Error,message:"Unexpected end of file."}),s&&(this.lexer.fatalError=!0)}constructor(e){this.lexer=new at(e)}read(){return this._score(),this._scoreNode}_score(){this._scoreNode={nodeType:D.Score,bars:[],start:this.lexer.currentTokenLocation()};try{this._bars()}finally{this._scoreNode.end=this.lexer.previousTokenEndLocation()}}_bars(){let e=this.lexer.peekToken();for(;e;)this._bar(),e=this.lexer.peekToken()}_bar(){const e={nodeType:D.Bar,metaData:[],beats:[],pipe:void 0,start:this.lexer.currentTokenLocation()};this._scoreNode.bars.push(e);try{this._barMetaData(e),this._barBeats(e);const t=this.lexer.peekToken();t?.nodeType===D.Pipe&&(e.pipe=t,this.lexer.advance()),(e.metaData.length>0||e.beats.length>0||e.pipe)&&(e.end=this.lexer.previousTokenEndLocation())}finally{e.end=this.lexer.previousTokenEndLocation()}}_barMetaData(e){let t=this.lexer.peekToken();for(;t&&(t.nodeType===D.Tag||t.nodeType===D.Dot);)t.nodeType===D.Dot?(this.lexer.advance(),this.addParserDiagnostic({code:ue.AT400,message:"The dots separating score metadata, score contents and the sync points can be removed.",severity:he.Hint,start:t.start,end:t.end})):this._metaData(e.metaData),t=this.lexer.peekToken()}_barBeats(e){let t=this.lexer.peekToken();for(;t&&t.nodeType!==D.Pipe&&t.nodeType!==D.Dot&&t.nodeType!==D.Tag;){const s=this._beat();s&&e.beats.push(s),t=this.lexer.peekToken()}}_beat(){const e={nodeType:D.Beat,durationChange:void 0,notes:void 0,rest:void 0,beatEffects:void 0,beatMultiplier:void 0,beatMultiplierValue:void 0,start:this.lexer.peekToken()?.start};try{if(this._beatDurationChange(e),this._beatContent(e),!e.notes&&!e.rest)return e;this._beatDuration(e),this._beatMultiplier(e),e.beatEffects=this._properties(t=>this._metaDataReader.readBeatPropertyArguments(this,t)),e.beatMultiplierValue!==void 0&&e.beatEffects?.openBrace&&this.addParserDiagnostic({code:ue.AT304,message:"The beat multiplier should be specified after the beat effects.",severity:he.Warning,start:e.beatMultiplier.start,end:e.beatMultiplierValue.end}),this._beatMultiplier(e)}finally{e.end=this.lexer.previousTokenEndLocation()}return e}_beatDuration(e){const t=this.lexer.peekToken();if(t?.nodeType!==D.Dot)return;e.durationDot=t,this.lexer.advance();const s=this.lexer.peekToken();if(s?.nodeType===D.Number){e.durationValue=s,this.lexer.advance();return}else if(s?.nodeType===D.Tag){e.durationDot=void 0;return}else if(s)this.unexpectedToken(s,[D.Number],!0);else return}_beatDurationChange(e){const t=this.lexer.peekToken();if(t?.nodeType!==D.Colon)return;this.lexer.advance();const s={nodeType:D.Duration,colon:t,value:void 0,properties:void 0,start:t.start};e.durationChange=s;try{const i=this.lexer.peekToken();if(!i||i.nodeType!==D.Number){this.addParserDiagnostic({code:ue.AT201,message:"Missing duration value after ':'.",severity:he.Error,start:t.start,end:t.end});return}this.lexer.advance(),s.value=i,s.properties=this._properties(r=>this._metaDataReader.readDurationChangePropertyArguments(this,r))}finally{s.end=this.lexer.previousTokenEndLocation()}}_beatContent(e){const t=this.lexer.peekToken();if(t)if(t.nodeType===D.Ident&&t.text==="r")e.rest=t,this.lexer.advance();else if(t.nodeType===D.LParen)e.notes=this._noteList(t);else{const s=this._note(t);s&&(e.notes={nodeType:D.NoteList,openParenthesis:void 0,notes:[s],closeParenthesis:void 0,start:s.start,end:s.end})}}_beatMultiplier(e){const t=this.lexer.peekToken();if(!t||t.nodeType!==D.Asterisk)return;this.lexer.advance(),e.beatMultiplier=t;const s=this.lexer.peekToken();if(!s||s.nodeType!==D.Number){this.addParserDiagnostic({code:ue.AT200,message:"Missing beat multiplier value after '*'.",severity:he.Error,start:e.beatMultiplier.start,end:e.beatMultiplier.end});return}e.beatMultiplierValue=s,this.lexer.advance()}_noteList(e){const t={nodeType:D.NoteList,openParenthesis:void 0,notes:[],closeParenthesis:void 0,start:this.lexer.currentTokenLocation()};try{t.openParenthesis=e,this.lexer.advance();let s=this.lexer.peekToken();for(;s&&s.nodeType!==D.RParen;){const r=this._note(s);if(r)t.notes.push(r);else break;s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===D.RParen?(t.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:ue.AT206,message:"Unexpected end of file. Group not closed.",severity:he.Error,start:i?.start??this.lexer.currentTokenLocation(),end:i?.end??this.lexer.currentTokenLocation()})}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_note(e){const t={nodeType:D.Note,noteValue:{nodeType:D.Ident,text:""},start:e.start};try{let s=!1;switch(e.nodeType){case D.Number:t.noteValue=e,this.lexer.advance(),s=!0;break;case D.String:switch(t.noteValue=e,this.lexer.advance(),t.noteValue.text){case"x":case"-":s=!0;break}break;case D.Ident:switch(t.noteValue=e,this.lexer.advance(),t.noteValue.text){case"x":case"-":s=!0;break}break;default:this.unexpectedToken(e,[D.Number,D.String,D.Ident],!0);return}if(s){const i=this.lexer.peekToken();if(i?.nodeType===D.Dot){const r=i;this.lexer.advance();const n=this.lexer.peekToken();if(!n){this.unexpectedToken(n,[D.Number],!0);return}if(n.nodeType===D.Tag)return t;if(n.nodeType===D.Number)t.noteStringDot=r,t.noteString=n,this.lexer.advance();else{this.unexpectedToken(n,[D.Number],!0);return}}}t.noteEffects=this._properties(i=>this._metaDataReader.readNotePropertyArguments(this,i))}finally{t.end=this.lexer.previousTokenEndLocation()}return t}_metaData(e){const t=this.lexer.peekToken();if(!t||t.nodeType!==D.Tag)return;const s={nodeType:D.Meta,tag:t,start:t.start,properties:void 0,propertiesBeforeArguments:!1};this.lexer.advance(),e.push(s);try{this.lexer.peekToken()?.nodeType===D.LBrace?(s.propertiesBeforeArguments=!0,s.properties=this._properties(r=>this._metaDataReader.readMetaDataPropertyArguments(this,s.tag,r)),s.arguments=this.argumentList(),s.arguments||(s.arguments=this._metaDataReader.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&(this.addParserDiagnostic({code:ue.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:he.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end}),this.addParserDiagnostic({code:ue.AT302,message:"Metadata arguments should be placed before metadata properties.",severity:he.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})))):(s.arguments=this.argumentList(),s.arguments||(s.arguments=this._metaDataReader.readMetaDataArguments(this,s.tag),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:ue.AT301,message:"Metadata arguments should be wrapped into parenthesis.",severity:he.Warning,start:s.arguments?.start??s.start,end:s.arguments?.end??s.end})),s.properties=this._properties(r=>this._metaDataReader.readMetaDataPropertyArguments(this,s.tag,r)))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_properties(e){const t=this.lexer.peekToken();if(!t||t.nodeType!==D.LBrace)return;const s={nodeType:D.Props,openBrace:t,properties:[],closeBrace:void 0,start:t.start};this.lexer.advance();try{let i=this.lexer.peekToken();for(;i?.nodeType===D.Ident;)s.properties.push(this._property(i,e)),i=this.lexer.peekToken();const r=this.lexer.peekToken();r?.nodeType===D.RBrace?(s.closeBrace=r,this.lexer.advance()):this.addParserDiagnostic({code:ue.AT206,message:"Unexpected end of file. Group not closed.",severity:he.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{s.end=this.lexer.previousTokenEndLocation()}return s}_property(e,t){const s={nodeType:D.Prop,property:e,arguments:void 0};this.lexer.advance(),s.start=s.property.start;try{s.arguments=this.argumentList(),s.arguments||(s.arguments=t(s),s.arguments&&s.arguments.arguments.length>1&&this.addParserDiagnostic({code:ue.AT303,message:"Property args should be wrapped into parenthesis.",severity:he.Warning,start:s.arguments.start,end:s.arguments.end}))}finally{s.end=this.lexer.previousTokenEndLocation()}return s}argumentList(){const e=this.lexer.peekToken();if(e?.nodeType!==D.LParen)return;const t={nodeType:D.Arguments,openParenthesis:e,arguments:[],closeParenthesis:void 0,start:e.start};this.lexer.advance();try{let s=this.lexer.peekToken();for(;s&&s?.nodeType!==D.RParen;){switch(s.nodeType){case D.Ident:t.arguments.push(s),this.lexer.advance();break;case D.String:t.arguments.push(s),this.lexer.advance();break;case D.Number:t.arguments.push(this.lexer.extendToFloat(s)),this.lexer.advance();break;default:this.unexpectedToken(s,[D.Ident,D.String,D.Number],!1),this.lexer.advance();break}s=this.lexer.peekToken()}const i=this.lexer.peekToken();i?.nodeType===D.RParen?(t.closeParenthesis=i,this.lexer.advance()):this.addParserDiagnostic({code:ue.AT206,message:"Unexpected end of file. Group not closed.",severity:he.Error,start:this.lexer.currentTokenLocation(),end:this.lexer.currentTokenLocation()})}finally{t.end=this.lexer.previousTokenEndLocation()}return t}}class _{static ident(e){return{nodeType:D.Ident,text:e}}static string(e){return{nodeType:D.String,text:e}}static number(e){return{nodeType:D.Number,value:e}}static meta(e,t,s){return{nodeType:D.Meta,tag:{nodeType:D.Tag,prefix:{nodeType:D.Backslash},tag:{nodeType:D.Ident,text:e}},arguments:t,properties:s,propertiesBeforeArguments:!1}}static identMeta(e,t){return _.meta(e,_.identValue(t))}static numberMeta(e,t){return _.meta(e,_.numberValue(t))}static args(e,t=void 0){const s={nodeType:D.Arguments,arguments:e.filter(r=>r!==void 0)};if((t===void 0?s.arguments.length>1:t)&&(s.openParenthesis={nodeType:D.LParen},s.closeParenthesis={nodeType:D.RParen}),s.arguments.length!==0)return s}static stringValue(e){return _.args([_.string(e)])}static identValue(e){return _.args([_.ident(e)])}static numberValue(e){return _.args([_.number(e)])}static props(e){const t={nodeType:D.Props,properties:[],openBrace:{nodeType:D.LBrace},closeBrace:{nodeType:D.RBrace}};for(const s of e)s&&t.properties.push({nodeType:D.Prop,property:_.ident(s[0]),arguments:s[1]});return t}static prop(e,t,s){e.push({nodeType:D.Prop,property:_.ident(t),arguments:s})}}class xt{static instance=new xt;static _argumentTypes=new Set([D.LParen,D.String,D.Ident,D.Number]);readMetaDataArguments(e,t){const s=t.tag.text.toLowerCase();for(const i of Ae.metaDataSignatures)if(i.has(s)){const r=i.get(s);return r?this._readArguments(e,r):void 0}e.addParserDiagnostic({code:ue.AT204,message:`Unrecognized metadata '${t.tag.text}'.`,severity:he.Error,start:t.start,end:t.end}),e.lexer.fatalError=!0}readMetaDataPropertyArguments(e,t,s){const i=t.tag.text.toLowerCase();if(!Ae.metaDataProperties.has(i))return;const r=Ae.metaDataProperties.get(i);return this._readPropertyArguments(e,[r],s)}readBeatPropertyArguments(e,t){return this._readPropertyArguments(e,[Ae.beatProperties],t)}readDurationChangePropertyArguments(e,t){return this._readPropertyArguments(e,[Ae.durationChangeProperties],t)}readNotePropertyArguments(e,t){return this._readPropertyArguments(e,[Ae.noteProperties,Ae.beatProperties],t)}_readPropertyArguments(e,t,s){const i=s.property.text.toLowerCase(),r=new Set([D.Ident,D.RBrace]);for(const o of t)if(o.has(i)){const l=o.get(i);if(l)return this._readArguments(e,l,r);this._skipRemainingArguments(e,[],r);return}let n=e.lexer.peekToken();for(;n&&n.nodeType!==D.Ident&&n.nodeType!==D.RBrace;)e.lexer.advance(),n=e.lexer.peekToken();e.addParserDiagnostic({code:ue.AT205,message:`Unrecognized property '${s.property.text}'.`,severity:he.Error,start:s.property.start,end:n?.start??e.lexer.currentTokenLocation()})}_readArguments(e,t,s){if(t.length===1&&t[0].parameters.length===0)return;const i=[],r=e.lexer.peekToken()?.start,n=s!==void 0,o=new Map(t.map((c,d)=>[d,{signature:c,parameterIndex:0,parameterHasValues:!1,parameterValueMatches:0}])),l=this._filterCandidates(e,o,i,s),h=this._validateArguments(e,o,i,s,t,r);return n&&this._skipRemainingArguments(e,t,s),this._createArgumentList(i,r,e.lexer.previousTokenEndLocation(),h,l)}_validateArguments(e,t,s,i,r,n){const o=e.lexer.peekToken();let l=!1;return t.size!==1&&o===void 0?(e.addParserDiagnostic({code:ue.AT203,start:e.lexer.currentTokenLocation(),end:e.lexer.currentTokenLocation(),severity:he.Error,message:"Unexpected end of file."}),l=!0):t.size===0&&(o!==void 0&&s.length===0&&i&&!i.has(o.nodeType)&&(s.push(e.lexer.peekToken()),e.lexer.advance()),e.addParserDiagnostic({code:ue.AT219,message:`Error parsing arguments: no overload matched arguments ${xt.generateSignaturesFromArguments(s)}. Signatures:
${xt.generateSignatures(r)}`,severity:he.Error,start:n,end:e.lexer.previousTokenEndLocation()}),l=!0),l}_createArgumentList(e,t,s,i,r){if(e.length===0)return;const n=_.args(e,!1);return n.start=t,n.end=s,n.validated=!i,r&&(r.length>1&&xt.sortCandidates(r),n.signatureCandidateIndices=r.map(o=>o[0])),n}_filterCandidates(e,t,s,i){const r=e.mode===Qi.Full,n=(c,d)=>{const f=t.get(d);if(c.nodeType===D.LParen){const p=e.argumentList();if(p)for(const g of p.arguments)r&&(g.parameterIndices||(g.parameterIndices=new Map),g.parameterIndices.set(d,f.parameterIndex)),s.push(g)}else{const p=c;r&&(p.parameterIndices||(p.parameterIndices=new Map),p.parameterIndices.set(d,f.parameterIndex)),(s.length===0||s[s.length-1]!==p)&&(s.push(p),e.lexer.advance())}},o=c=>{e.lexer.extendToFloat(c)},l=xt._argumentTypes;for(;t.size>1||t.size>0&&!xt._hasExactMatch(t);){const c=e.lexer.peekToken();if(!c||!l.has(c.nodeType)||!xt.filterSignatureCandidates(t,c,i!==void 0&&i.has(c.nodeType),n,o))break}const h=e.mode===Qi.Full?Array.from(t.entries()):void 0;return xt.filterIncompleteCandidates(t),h}static sortCandidates(e){e.length<2||e.sort((t,s)=>{const i=Math.abs(t[1].parameterIndex-t[1].signature.parameters.length),r=Math.abs(s[1].parameterIndex-s[1].signature.parameters.length);if(i===r){const n=t[1].parameterValueMatches;return s[1].parameterValueMatches-n}return i-r})}_skipRemainingArguments(e,t,s){const i=e.lexer.currentTokenLocation();let r=e.lexer.peekToken(),n=!1;const o=xt._argumentTypes;for(;r&&!s.has(r.nodeType);)o.has(r.nodeType)?(e.lexer.advance(),n=!0,r=e.lexer.peekToken()):r=void 0;n&&e.addParserDiagnostic({code:ue.AT220,message:`Error parsing arguments: unexpected additional arguments. Signatures:
${xt.generateSignatures(t)}`,severity:he.Error,start:i,end:e.lexer.previousTokenEndLocation()})}static _hasExactMatch(e){for(const t of e.values())if(t.parameterIndex===t.signature.parameters.length)return!0;return!1}static filterIncompleteCandidates(e){const t=new Set;for(const[s,i]of e)for(let r=i.parameterIndex;r<i.signature.parameters.length;r++)switch(i.signature.parameters[r].parseMode){case Bt.Required:case Bt.RequiredAsFloat:t.add(s);break}for(const s of t)e.delete(s)}static generateSignaturesFromArguments(e){return e?`(${e.map(t=>D[t.nodeType]).join(", ")})`:"()"}static generateSignatures(e,t){return e.length===0?"()":e.map((s,i)=>xt._generateSignature(s,t!==void 0&&t.size>1&&t.has(i))).join(`
`)}static _generateSignature(e,t){const s=t?" ~":"";return`(${e.parameters.map(xt._generateSignatureParameter).join(", ")})${s}`}static _generateSignatureParameter(e,t){const s=Array.from(e.expectedTypes);let i=`v${t}`;switch(e.parseMode){case Bt.Optional:case Bt.OptionalAsFloat:i+="?";break}if(e.allowedValues&&e.allowedValues.size<5){const r=Array.from(e.allowedValues);switch(s[0]){case D.String:i=r.map(n=>`"${n}"`).join("|");break;default:i=r.join("|");break}}else i=Array.from(e.expectedTypes).map(r=>D[r]).join("|");switch(e.parseMode){case Bt.RequiredAsValueList:case Bt.ValueListWithoutParenthesis:i+="[]";break}return i}static filterSignatureCandidates(e,t,s,i,r){const n=new Set;let o=!1;for(const[l,h]of e){let c=!1;for(;!c;){const d=h.parameterIndex<h.signature.parameters.length?h.signature.parameters[h.parameterIndex]:void 0;if(!d)s||n.add(l),c=!0;else if(h.signature.isStrict&&h.parameterIndex>0)n.add(l),c=!0;else if((d.expectedTypes.has(t.nodeType)||xt._isValueListMatch(t,d))&&xt._checkArgumentMatch(t,d,r))switch(c=!0,o=!0,i(t,l),d.allowedValues&&h.parameterValueMatches++,d.parseMode){case Bt.ValueListWithoutParenthesis:h.parameterHasValues=!0;break;case Bt.RequiredAsValueList:h.parameterIndex++,h.parameterHasValues=!1;break;default:h.parameterIndex++,h.parameterHasValues=!1;break}else switch(d.parseMode){case Bt.ValueListWithoutParenthesis:h.parameterIndex++,h.parameterHasValues=!1;break;case Bt.Required:case Bt.RequiredAsFloat:n.add(l),c=!0;break;case Bt.Optional:case Bt.OptionalAsFloat:h.parameterIndex++,h.parameterHasValues=!1;break;case Bt.RequiredAsValueList:h.parameterIndex++,h.parameterHasValues=!1;break}}}if(o)for(const l of n)e.delete(l);return o}static _checkArgumentMatch(e,t,s){switch(e.nodeType){case D.Ident:const i=e;return t?.allowedValues?t.allowedValues.has(i.text.toLowerCase()):t?.reservedIdentifiers?!t.reservedIdentifiers.has(i.text.toLowerCase()):!0;case D.String:const r=e;return t?.allowedValues?t.allowedValues.has(r.text.toLowerCase()):!0;case D.Number:switch(t?.parseMode??Bt.Optional){case Bt.RequiredAsFloat:case Bt.OptionalAsFloat:return s?.(e),!0;default:return!0}case D.LParen:return!0}return!1}static _isValueListMatch(e,t){return e.nodeType!==D.LParen?!1:t.expectedTypes.has(D.Arguments)||t.parseMode===Bt.ValueListWithoutParenthesis||t.parseMode===Bt.RequiredAsValueList}}var k;(function(a){a[a.Applied=0]="Applied",a[a.NotAppliedSemanticError=1]="NotAppliedSemanticError",a[a.NotAppliedUnrecognizedMarker=2]="NotAppliedUnrecognizedMarker"})(k||(k={}));var Vs;(function(a){a[a.AppliedNewTrack=0]="AppliedNewTrack",a[a.AppliedNewStaff=1]="AppliedNewStaff",a[a.AppliedNewVoice=2]="AppliedNewVoice",a[a.NotAppliedSemanticError=3]="NotAppliedSemanticError",a[a.NotAppliedUnrecognizedMarker=4]="NotAppliedUnrecognizedMarker"})(Vs||(Vs={}));class Zt{static _values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);static getValue(e){return Zt._values||(Zt._values=new Map),e=e.toLowerCase().replaceAll(" ",""),Zt._values.has(e)?Zt._values.get(e):0}static getName(e){for(const[t,s]of Zt._values)if(s===e)return t;return e.toString()}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||e===105||e===43}static isBass(e){return e>=32&&e<=39}static bankToLsbMsb(e){const t=e&127,s=e>>7&127;return[t,s]}}class ui{name="";firstFret=1;strings=[];barreFrets=[];staff;showName=!0;showDiagram=!0;showFingering=!0;get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}class Ft extends Ve{constructor(e){super(Oe.Format,e)}}class Ce{static BlackRgb="#000000";constructor(e,t,s,i=255){this.raw=(i&255)<<24|(e&255)<<16|(t&255)<<8|s&255,this.updateRgba()}updateRgba(){this.a===255?this.rgba=`#${L.toHexString(this.r,2)}${L.toHexString(this.g,2)}${L.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}raw=0;get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return this.raw&255}rgba;static random(e=100){return new Ce(Math.random()*255|0,Math.random()*255|0,Math.random()*255|0,e)}static fromJson(e){if(e instanceof Ce)return e;switch(typeof e){case"number":{const t=new Ce(0,0,0,0);return t.raw=e,t.updateRgba(),t}case"string":{const t=e;if(t.startsWith("#")){if(t.length===4)return new Ce(Number.parseInt(t[1],16)*17,Number.parseInt(t[2],16)*17,Number.parseInt(t[3],16)*17);if(t.length===5)return new Ce(Number.parseInt(t[1],16)*17,Number.parseInt(t[2],16)*17,Number.parseInt(t[3],16)*17,Number.parseInt(t[4],16)*17);if(t.length===7)return new Ce(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16));if(t.length===9)return new Ce(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16),Number.parseInt(t.substring(7,9),16))}else if(t.startsWith("rgba")||t.startsWith("rgb")){const s=t.indexOf("("),i=t.lastIndexOf(")");if(s===-1||i===-1)throw new Ft("No values specified for rgb/rgba function");const r=t.substring(s+1,i).split(",");if(r.length===3)return new Ce(Number.parseInt(r[0],10),Number.parseInt(r[1],10),Number.parseInt(r[2],10));if(r.length===4)return new Ce(Number.parseInt(r[0],10),Number.parseInt(r[1],10),Number.parseInt(r[2],10),Number.parseFloat(r[3])*255)}return null}}throw new Ft("Unsupported format for color")}static toJson(e){return e===null?null:e.raw}}var jt;(function(a){a[a.Short=0]="Short",a[a.Medium=1]="Medium",a[a.Long=2]="Long"})(jt||(jt={}));class hr{type=jt.Short;length=0}var Ut;(function(a){a[a.IgnoreSpaces=0]="IgnoreSpaces",a[a.Begin=1]="Begin",a[a.Text=2]="Text",a[a.Comment=3]="Comment",a[a.Dash=4]="Dash"})(Ut||(Ut={}));class $t{static _charCodeLF=10;static _charCodeTab=9;static _charCodeCR=13;static _charCodeSpace=32;static _charCodeBrackedClose=93;static _charCodeBrackedOpen=91;static _charCodeDash=45;startBar=0;text="";chunks;finish(e=!1){this.chunks=[],this._parse(this.text,0,this.chunks,e)}_parse(e,t,s,i){if(!e)return;let r=Ut.Begin,n=Ut.Begin,o=!1,l=0;for(;t<e.length;){const h=e.charCodeAt(t);switch(r){case Ut.IgnoreSpaces:switch(h){case $t._charCodeLF:case $t._charCodeCR:case $t._charCodeTab:break;case $t._charCodeSpace:if(!o){r=n;continue}break;default:o=!1,r=n;continue}break;case Ut.Begin:switch(h){case $t._charCodeBrackedOpen:r=Ut.Comment;break;default:l=t,r=Ut.Text;continue}break;case Ut.Comment:switch(h){case $t._charCodeBrackedClose:r=Ut.Begin;break}break;case Ut.Text:switch(h){case $t._charCodeDash:r=Ut.Dash;break;case $t._charCodeCR:case $t._charCodeLF:case $t._charCodeSpace:const c=e.substr(l,t-l);this._addChunk(c,i),r=Ut.IgnoreSpaces,n=Ut.Begin;break}break;case Ut.Dash:switch(h){case $t._charCodeDash:break;default:const c=e.substr(l,t-l);this._addChunk(c,i),o=!0,r=Ut.IgnoreSpaces,n=Ut.Begin;continue}break}t+=1}r===Ut.Text&&t!==l&&this._addChunk(e.substr(l,t-l),i)}_addChunk(e,t){e=this._prepareChunk(e),(!t||e.length>0&&e!=="-")&&this.chunks.push(e)}_prepareChunk(e){const t=e.split("+").join(" ");let s=t.length;for(;s>0&&t.charAt(s-1)==="_";)s--;return s!==t.length?t.substr(0,s):t}}class cr{marker="";text=""}class A{static _sevenStrings=[];static _sixStrings=[];static _fiveStrings=[];static _fourStrings=[];static _defaultTunings=new Map;static noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];static getTextForTuning(e,t){const s=A.getTextPartsForTuning(e);return t?s.join(""):s[0]}static getTextPartsForTuning(e,t=-1){const s=e/12|0,i=e%12;return[A.noteNames[i],(s+t).toString()]}static getDefaultTuningFor(e){if(A._defaultTunings.has(e)){const t=A._defaultTunings.get(e);return new A(t.name,t.tunings,t.isStandard)}return null}static getPresetsFor(e){switch(e){case 7:return A._sevenStrings;case 6:return A._sixStrings;case 5:return A._fiveStrings;case 4:return A._fourStrings}return[]}static initialize(){A._defaultTunings.set(7,new A("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),A._sevenStrings.push(A._defaultTunings.get(7)),A._defaultTunings.set(6,new A("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),A._sixStrings.push(A._defaultTunings.get(6)),A._sixStrings.push(new A("Guitar Tune down  step",[63,58,54,49,44,39],!1)),A._sixStrings.push(new A("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),A._sixStrings.push(new A("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),A._sixStrings.push(new A("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),A._sixStrings.push(new A("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),A._sixStrings.push(new A("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),A._sixStrings.push(new A("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),A._sixStrings.push(new A("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),A._sixStrings.push(new A("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),A._sixStrings.push(new A("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),A._sixStrings.push(new A("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),A._sixStrings.push(new A("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),A._sixStrings.push(new A("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),A._sixStrings.push(new A("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),A._sixStrings.push(new A("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),A._sixStrings.push(new A("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),A._sixStrings.push(new A("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),A._sixStrings.push(new A("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),A._sixStrings.push(new A("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),A._sixStrings.push(new A("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),A._sixStrings.push(new A("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),A._sixStrings.push(new A("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),A._sixStrings.push(new A("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),A._sixStrings.push(new A("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),A._sixStrings.push(new A("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),A._sixStrings.push(new A("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),A._sixStrings.push(new A("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),A._sixStrings.push(new A("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),A._sixStrings.push(new A("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),A._sixStrings.push(new A("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),A._defaultTunings.set(5,new A("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),A._fiveStrings.push(A._defaultTunings.get(5)),A._fiveStrings.push(new A("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),A._fiveStrings.push(new A("Banjo Open D Tuning",[62,57,54,50,69],!1)),A._fiveStrings.push(new A("Banjo Open G Tuning",[62,59,55,50,67],!1)),A._fiveStrings.push(new A("Banjo G Minor Tuning",[62,58,55,50,67],!1)),A._fiveStrings.push(new A("Banjo G Modal Tuning",[62,57,55,50,67],!1)),A._defaultTunings.set(4,new A("Bass Standard Tuning",[43,38,33,28],!0)),A._fourStrings.push(A._defaultTunings.get(4)),A._fourStrings.push(new A("Bass Tune down  step",[42,37,32,27],!1)),A._fourStrings.push(new A("Bass Tune down 1 step",[41,36,31,26],!1)),A._fourStrings.push(new A("Bass Tune down 2 step",[39,34,29,24],!1)),A._fourStrings.push(new A("Bass Dropped D Tuning",[43,38,33,26],!1)),A._fourStrings.push(new A("Ukulele C Tuning",[45,40,36,43],!1)),A._fourStrings.push(new A("Ukulele G Tuning",[52,47,43,38],!1)),A._fourStrings.push(new A("Mandolin Standard Tuning",[64,57,50,43],!1)),A._fourStrings.push(new A("Mandolin or Violin Tuning",[76,69,62,55],!1)),A._fourStrings.push(new A("Viola Tuning",[69,62,55,48],!1)),A._fourStrings.push(new A("Cello Tuning",[57,50,43,36],!1))}static findTuning(e){const t=A.getPresetsFor(e.length);for(let s=0,i=t.length;s<i;s++){const r=t[s];let n=!0;for(let o=0,l=e.length;o<l;o++)if(e[o]!==r.tunings[o]){n=!1;break}if(n)return new A(r.name,r.tunings,r.isStandard)}return null}isStandard;name;tunings;constructor(e="",t=null,s=!1){this.isStandard=s,this.name=e,this.tunings=t??[]}reset(){this.isStandard=!1,this.name="",this.tunings=[]}finish(){const e=A.findTuning(this.tunings);e&&(this.name.length===0&&(this.name=e.name),this.isStandard=e.isStandard)}}A.initialize();class Li{static DefaultStandardNotationLineCount=5;index=0;track;bars=[];chords=null;capo=0;transpositionPitch=0;displayTranspositionPitch=0;stringTuning=new A("",[],!1);get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}showSlash=!1;showNumbered=!1;showTablature=!0;showStandardNotation=!0;isPercussion=!1;standardNotationLineCount=Li.DefaultStandardNotationLineCount;_filledVoices=new Set([0]);get filledVoices(){return this._filledVoices}finish(e,t=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1,this.displayTranspositionPitch=0),this.stringTuning.finish();for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(e,t);for(const r of this.bars[s].filledVoices)this._filledVoices.add(r)}}addChord(e,t){t.staff=this;let s=this.chords;s===null&&(s=new Map,this.chords=s),s.set(e,t)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){const t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}class Un{volume=15;balance=8;port=1;program=0;bank=0;primaryChannel=0;secondaryChannel=0;isMute=!1;isSolo=!1}var Hs;(function(a){a[a.TrackName=0]="TrackName",a[a.BracesAndBrackets=1]="BracesAndBrackets",a[a.SystemSeparator=2]="SystemSeparator",a[a.StringTuning=3]="StringTuning"})(Hs||(Hs={}));class Ml extends qi{}class Gs{static _shortNameMaxLength=10;index=0;score;staves=[];playbackInfo=new Un;color=new Ce(200,0,0,255);name="";isVisibleOnMultiTrack=!0;shortName="";defaultSystemsLayout=3;systemsLayout=[];lineBreaks;get isPercussion(){return this.staves.some(e=>e.isPercussion)}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}percussionArticulations=[];style;ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new Li)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(e,t=null){this.shortName||(this.shortName=this.name,this.shortName.length>Gs._shortNameMaxLength&&(this.shortName=this.shortName.substr(0,Gs._shortNameMaxLength)));for(const s of this.staves)s.finish(e,t),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(e){for(const s of e)s.finish();const t=this.staves[0];for(let s=0;s<e.length;s++){const i=e[s];if(i.startBar>=0&&i.startBar<t.bars.length){let r=t.bars[i.startBar].voices[0].beats[0];for(let n=0;n<i.chunks.length&&r;n++){for(;r&&(r.isEmpty||r.isRest);)r=r.nextBeat;r&&(r.lyrics||(r.lyrics=new Array(e.length),r.lyrics.fill("")),r.lyrics[s]=i.chunks[n],r=r.nextBeat)}}}}}class fi{id=L.newGuid();x=0;y=0;width=0;height=0;totalWidth=0;totalHeight=0;firstMasterBarIndex=-1;lastMasterBarIndex=-1;renderResult=null}var $s;(function(a){a[a.Page=0]="Page",a[a.Horizontal=1]="Horizontal"})($s||($s={}));class ct{_listeners=[];_fireOnRegister;constructor(e=void 0){this._fireOnRegister=e}on(e){return this._listeners.push(e),this._fireOnRegister?.()&&e(),()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(const e of this._listeners)e()}}class ge{_listeners=[];_fireOnRegister;constructor(e=void 0){this._fireOnRegister=e}on(e){if(this._listeners.push(e),this._fireOnRegister){const t=this._fireOnRegister();t!==null&&e(t)}return()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(const t of this._listeners)t(e)}}class zn{masterBarBounds;visualBounds;realBounds;bar;beats=[];addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(const s of this.beats)if(!t||s.realBounds.x<e)t=s;else if(s.realBounds.x>e)break;return t}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.beats.sort((t,s)=>t.realBounds.x-s.realBounds.x);for(const t of this.beats)t.finish(e)}}class Yn{barBounds;visualBounds;onNotesX=0;realBounds;beat;notes=null;addNote(e){this.notes||(this.notes=[]),e.beatBounds=this,this.notes.push(e)}findNoteAtPos(e,t){const s=this.notes;if(!s)return null;for(const i of s){const r=i.noteHeadBounds.y+i.noteHeadBounds.h,n=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=e&&i.noteHeadBounds.y<=t&&e<=n&&t<=r)return i.note}return null}finish(e=1){if(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.onNotesX*=e,this.notes)for(const t of this.notes)t.finish(e)}}class Mt{x=0;y=0;w=0;h=0;scaleWith(e){this.x*=e,this.y*=e,this.w*=e,this.h*=e}}class Xn{index=0;isFirstOfLine=!1;visualBounds;realBounds;lineAlignedBounds;bars=[];staffSystemBounds=null;get staveGroupBounds(){return this.staffSystemBounds}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e){let t=null;const s=1e7;for(const i of this.bars){const r=i.findBeatAtPos(e);if(r&&(!t||t.realBounds.x<r.realBounds.x)){const n=Math.abs(r.realBounds.x-e);(!t||n<s)&&(t=r)}}return t?t.beat:null}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.lineAlignedBounds.scaleWith(e),this.bars.sort((t,s)=>t.realBounds.y<s.realBounds.y?-1:t.realBounds.y>s.realBounds.y?1:t.realBounds.x<s.realBounds.x?-1:t.realBounds.x>s.realBounds.x?1:0);for(const t of this.bars)t.finish(e)}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}}class dr{beatBounds;noteHeadBounds;note;finish(e=1){this.noteHeadBounds.scaleWith(e)}}class Jn{index=0;visualBounds;realBounds;bars=[];boundsLookup;finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e);for(const t of this.bars)t.finish(e)}addBar(e){this.boundsLookup.addMasterBar(e),e.staffSystemBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(const s of this.bars)if(!t||s.realBounds.x<e)t=s;else if(e>s.realBounds.x+s.realBounds.w)break;return t}}class rs{toJson(){const e={},t=[];e.staffSystems=t;for(const s of this.staffSystems){const i={};i.visualBounds=this._boundsToJson(s.visualBounds),i.realBounds=this._boundsToJson(s.realBounds),i.bars=[];for(const r of s.bars){const n={};n.lineAlignedBounds=this._boundsToJson(r.lineAlignedBounds),n.visualBounds=this._boundsToJson(r.visualBounds),n.realBounds=this._boundsToJson(r.realBounds),n.index=r.index,n.bars=[];for(const o of r.bars){const l={};l.visualBounds=this._boundsToJson(o.visualBounds),l.realBounds=this._boundsToJson(o.realBounds),l.beats=[];for(const h of o.beats){const c={};c.visualBounds=this._boundsToJson(h.visualBounds),c.realBounds=this._boundsToJson(h.realBounds),c.onNotesX=h.onNotesX;const d=c;if(d.beatIndex=h.beat.index,d.voiceIndex=h.beat.voice.index,d.barIndex=h.beat.voice.bar.index,d.staffIndex=h.beat.voice.bar.staff.index,d.trackIndex=h.beat.voice.bar.staff.track.index,h.notes){const f=[];c.notes=f;for(const p of h.notes){const g={},m=g;m.index=p.note.index,g.noteHeadBounds=this._boundsToJson(p.noteHeadBounds),f.push(g)}}l.beats.push(c)}n.bars.push(l)}i.bars.push(n)}t.push(i)}return e}static fromJson(e,t){const s=new rs,i=e.staffSystems;for(const r of i){const n=new Jn;n.visualBounds=rs._boundsFromJson(r.visualBounds),n.realBounds=rs._boundsFromJson(r.realBounds),s.addStaffSystem(n);for(const o of r.bars){const l=new Xn;l.index=o.index,l.isFirstOfLine=o.isFirstOfLine,l.lineAlignedBounds=rs._boundsFromJson(o.lineAlignedBounds),l.visualBounds=rs._boundsFromJson(o.visualBounds),l.realBounds=rs._boundsFromJson(o.realBounds),n.addBar(l);for(const h of o.bars){const c=new zn;c.visualBounds=rs._boundsFromJson(h.visualBounds),c.realBounds=rs._boundsFromJson(h.realBounds),l.addBar(c);for(const d of h.beats){const f=new Yn;f.visualBounds=rs._boundsFromJson(d.visualBounds),f.realBounds=rs._boundsFromJson(d.realBounds),f.onNotesX=d.onNotesX;const p=d;if(f.beat=t.tracks[p.trackIndex].staves[p.staffIndex].bars[p.barIndex].voices[p.voiceIndex].beats[p.beatIndex],d.notes){f.notes=[];for(const g of d.notes){const m=new dr,b=g;m.note=f.beat.notes[b.index],m.noteHeadBounds=rs._boundsFromJson(g.noteHeadBounds),f.addNote(m)}}c.addBeat(f)}}}}return s}static _boundsFromJson(e){const t=new Mt;return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}_boundsToJson(e){const t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}_beatLookup=new Map;_masterBarLookup=new Map;_currentStaffSystem=null;staffSystems=[];isFinished=!1;finish(e=1){for(const t of this.staffSystems)t.finish(e);this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,e.boundsLookup=this,this.staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),this._beatLookup.get(e.beat.id)?.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){const t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){const t=this.findBeats(e);return t?t[0]:null}findBeats(e){const t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let s=0,i=this.staffSystems.length-1,r=-1;for(;s<=i;){const l=(i+s)/2|0,h=this.staffSystems[l];if(t>=h.realBounds.y&&t<=h.realBounds.y+h.realBounds.h){r=l;break}t<h.realBounds.y?i=l-1:s=l+1}if(r===-1)return null;const o=this.staffSystems[r].findBarAtPos(e);return o?o.findBeatAtPos(e):null}getNoteAtPos(e,t,s){const i=this.findBeats(e);if(i)for(const r of i){const n=r.findNoteAtPos(t,s);if(n)return n}return null}}class ur{_currentLayoutMode=$s.Page;_currentRenderEngine=null;_renderedTracks=null;canvas=null;score=null;tracks=null;layout=null;settings;boundsLookup=null;width=0;constructor(e){this.settings=e,this._recreateCanvas(),this._recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}_recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine?(this.canvas?.destroy(),this.canvas=F.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0):!1}_recreateLayout(){return!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode?(this.layout=F.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0):!1}renderScore(e,t){try{this.score=e;let s=null;if(e!=null&&t!=null){if(!t)s=e.tracks.slice(0);else{s=[];for(const i of t)i>=0&&i<e.tracks.length&&s.push(e.tracks[i])}s.length===0&&e.tracks.length>0&&s.push(e.tracks[0])}this.tracks=s,this.render()}catch(s){this.error.trigger(s)}}renderTracks(e){e.length===0?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{const t=this.layout;t?(E.debug("Rendering",`Request render of lazy partial ${e}`),t.renderLazyPartial(e)):E.warning("Rendering",`Request render of lazy partial ${e} ignored, no layout exists`)}catch(t){this.error.trigger(t)}}render(){if(this.width===0){E.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);return}if(this.boundsLookup=new rs,this._recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,!this.tracks||this.tracks.length===0||!this.score)E.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this._onRenderFinished(),this.postRenderFinished.trigger(),E.debug("Rendering","Clearing finished");else{E.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){const t=this.tracks[e];E.debug("Rendering",`Track ${e}: ${t.name}`)}this.preRender.trigger(!1),this._recreateLayout(),this._layoutAndRender(),E.debug("Rendering","Rendering finished")}}resizeRender(){this._recreateLayout()||this._recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(E.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(E.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new rs,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this._onRenderFinished(),this.postRenderFinished.trigger()):E.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),E.debug("Rendering","Resize finished")}_layoutAndRender(){E.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this._onRenderFinished(),this.postRenderFinished.trigger()}preRender=new ge;renderFinished=new ge;partialRenderFinished=new ge;partialLayoutFinished=new ge;postRenderFinished=new ct;error=new ge;_onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);const e=new fi;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}var P;(function(a){a[a.Up=0]="Up",a[a.Down=1]="Down"})(P||(P={}));class ee{static instance=new ee;applyScoreMetaData(e,t,s){const i=this._checkArgumentTypes(e,[Ae.scoreMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"title":return t.title=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Title,s),k.Applied;case"subtitle":return t.subTitle=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.SubTitle,s),k.Applied;case"artist":return t.artist=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Artist,s),k.Applied;case"album":return t.album=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Album,s),k.Applied;case"words":return t.words=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Words,s),k.Applied;case"music":return t.music=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Music,s),k.Applied;case"copyright":return t.copyright=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Copyright,s),k.Applied;case"instructions":return t.instructions=s.arguments.arguments[0].text,k.Applied;case"notices":return t.notices=s.arguments.arguments[0].text,k.Applied;case"tab":return t.tab=s.arguments.arguments[0].text,this._headerFooterStyle(e,t,O.Transcriber,s),k.Applied;case"copyright2":return this._headerFooterStyle(e,t,O.CopyrightSecondLine,s,0),k.Applied;case"wordsandmusic":return this._headerFooterStyle(e,t,O.WordsAndMusic,s,0),k.Applied;case"defaultsystemslayout":return t.defaultSystemsLayout=s.arguments.arguments[0].value,k.Applied;case"systemslayout":for(const f of s.arguments.arguments)t.systemsLayout.push(f.value);return k.Applied;case"hidedynamics":return t.stylesheet.hideDynamics=!0,k.Applied;case"showdynamics":return t.stylesheet.hideDynamics=!1,k.Applied;case"bracketextendmode":const r=ee._parseEnumValue(e,s.arguments,"bracket extend mode",U.bracketExtendMode);return r===void 0?k.NotAppliedSemanticError:(t.stylesheet.bracketExtendMode=r,k.Applied);case"usesystemsignseparator":return t.stylesheet.useSystemSignSeparator=!0,k.Applied;case"multibarrest":return t.stylesheet.multiTrackMultiBarRest=!0,k.Applied;case"singletracktracknamepolicy":const n=ee._parseEnumValue(e,s.arguments,"track name policy",U.trackNamePolicy);return n===void 0?k.NotAppliedSemanticError:(t.stylesheet.singleTrackTrackNamePolicy=n,k.Applied);case"multitracktracknamepolicy":const o=ee._parseEnumValue(e,s.arguments,"track name policy",U.trackNamePolicy);return o===void 0?k.NotAppliedSemanticError:(t.stylesheet.multiTrackTrackNamePolicy=o,k.Applied);case"firstsystemtracknamemode":const l=ee._parseEnumValue(e,s.arguments,"track name mode",U.trackNameMode);return l===void 0?k.NotAppliedSemanticError:(t.stylesheet.firstSystemTrackNameMode=l,k.Applied);case"othersystemstracknamemode":const h=ee._parseEnumValue(e,s.arguments,"track name mode",U.trackNameMode);return h===void 0?k.NotAppliedSemanticError:(t.stylesheet.otherSystemsTrackNameMode=h,k.Applied);case"firstsystemtracknameorientation":const c=ee._parseEnumValue(e,s.arguments,"track name orientation",U.trackNameOrientation);return c===void 0?k.NotAppliedSemanticError:(t.stylesheet.firstSystemTrackNameOrientation=c,k.Applied);case"othersystemstracknameorientation":const d=ee._parseEnumValue(e,s.arguments,"track name orientation",U.trackNameOrientation);return d===void 0?k.NotAppliedSemanticError:(t.stylesheet.otherSystemsTrackNameOrientation=d,k.Applied);default:return k.NotAppliedUnrecognizedMarker}}_checkArgumentTypes(e,t,s,i,r){const n=t.find(l=>l.has(i));if(!n)return k.NotAppliedUnrecognizedMarker;const o=n.get(i);if(!o){r&&e.addSemanticDiagnostic({code:ue.AT300,message:"Expected no arguments, but found some.",start:r.start,end:r.end,severity:he.Warning});return}if(!this._validateArgumentTypes(e,o,s,r))return k.NotAppliedSemanticError}applyStaffMetaData(e,t,s){const i=this._checkArgumentTypes(e,[Ae.staffMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"capo":return t.capo=s.arguments.arguments[0].value,k.Applied;case"tuning":const r=[];let n=!1,o="";for(let f=0;f<s.arguments.arguments.length;f++){const p=s.arguments.arguments[f],g=p.text;switch(g){case"piano":case"none":case"voice":e.applyStaffNoteKind(t,Gt.Pitched),f=s.arguments.arguments.length;break;case"hide":n=!0,e.addSemanticDiagnostic({code:ue.AT305,message:"This value should be rather specified via the properties.",start:p.start,end:p.end,severity:he.Warning});break;default:const m=L.parseTuning(g);if(m)r.push(m.realValue);else if(f===s.arguments.arguments.length-1&&r.length>0)o=g,e.addSemanticDiagnostic({code:ue.AT305,message:"This value should be rather specified via the properties.",start:p.start,end:p.end,severity:he.Warning});else{const b=Array.from(L.tuningLetters).join(","),S=Array.from(L.accidentalModeMapping.keys()).join(",");e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected tuning value '${g}', expected: <note><accidental><octave> where <note>=oneOf(${b}) <accidental>=oneOf(${S}), <octave>=number`,start:p.start,end:p.end,severity:he.Error})}break}}return e.state.staffHasExplicitTuning.add(t),e.state.staffTuningApplied.delete(t),t.stringTuning=new A,t.stringTuning.tunings=r,t.stringTuning.name=o,this._tuningProperties(e,t,t.stringTuning,s),n&&(t.track.score.stylesheet.perTrackDisplayTuning||(t.track.score.stylesheet.perTrackDisplayTuning=new Map),t.track.score.stylesheet.perTrackDisplayTuning.set(t.track.index,!1)),k.Applied;case"instrument":return e.state.staffTuningApplied.delete(t),this._readTrackInstrument(e,t.track,s.arguments),k.Applied;case"bank":return t.track.playbackInfo.bank=s.arguments.arguments[0].value,k.Applied;case"lyrics":const l=new $t;return l.startBar=0,l.text="",s.arguments.arguments.length===2?(l.startBar=s.arguments.arguments[0].value,l.text=s.arguments.arguments[1].text):l.text=s.arguments.arguments[0].text,e.state.lyrics.get(t.track.index).push(l),k.Applied;case"chord":const h=new ui;this._chordProperties(e,h,s),h.name=s.arguments.arguments[0].text;for(let f=1;f<s.arguments.arguments.length;f++){const p=s.arguments.arguments[f];if(p.nodeType===D.Number)h.strings.push(p.value);else if(p.nodeType===D.Ident){const g=p.text;g==="x"?h.strings.push(-1):e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected chord value '${g}', expected: 'x'`,severity:he.Error,start:p.start,end:p.end})}}return t.addChord(ee._getChordId(t,h.name),h),k.Applied;case"articulation":const c=e.state.percussionArticulationNames,d=s.arguments.arguments[0].text;if(d==="defaults"){for(const[f,p]of ht.instrumentArticulationNames)c.set(f.toLowerCase(),p),c.set(L.toArticulationId(f),p);return k.Applied}if(s.arguments.arguments.length===2){const f=s.arguments.arguments[1].value;if(ht.instrumentArticulations.has(f))return c.set(d.toLowerCase(),f),k.Applied;{const p=Array.from(ht.instrumentArticulations.keys()).map(g=>`${g}`).join(",");return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected articulation value '${f}', expected: ${p}`,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end,severity:he.Error}),k.NotAppliedSemanticError}}return k.Applied;case"accidentals":return ee._handleAccidentalMode(e,s.arguments);case"displaytranspose":return t.displayTranspositionPitch=s.arguments.arguments[0].value*-1,e.state.staffHasExplicitDisplayTransposition.add(t),k.Applied;case"transpose":return t.transpositionPitch=s.arguments.arguments[0].value*-1,k.Applied;default:return k.NotAppliedUnrecognizedMarker}}applyBarMetaData(e,t,s){const i=this._checkArgumentTypes(e,[Ae.barMetaDataSignatures],s,s.tag.tag.text.toLowerCase(),s.arguments);if(i!==void 0)return i;switch(s.tag.tag.text.toLowerCase()){case"sync":const r=this._buildSyncPoint(s);return e.state.syncPoints.push(r),k.Applied;case"tempo":let n=0;const o=s.arguments.arguments[n++].value;let l="",h=!0,c=0;for(;n<s.arguments.arguments.length;){switch(s.arguments.arguments[n].nodeType){case D.Ident:case D.String:const w=s.arguments.arguments[n].text;w==="hide"?h=!1:l=w;break;case D.Number:c=s.arguments.arguments[n].value;break}n++}let d=t.masterBar.tempoAutomations.find(w=>w.ratioPosition===c);return d||(d=new Ye,t.masterBar.tempoAutomations.push(d)),d.isLinear=!1,d.type=De.Tempo,d.value=o,d.text=l,d.ratioPosition=c,d.isVisible=h,k.Applied;case"rc":return t.masterBar.repeatCount=s.arguments.arguments[0].value,k.Applied;case"ae":for(const w of s.arguments.arguments)if(w.nodeType===D.Number){const se=w.value;if(se<1||se>31)return e.addSemanticDiagnostic({code:ue.AT211,message:"Value is out of valid range. Allowed range: %s, Actual Value: %s",severity:he.Error,start:w.start,end:w.end}),k.NotAppliedSemanticError;t.masterBar.alternateEndings|=1<<se-1}else e.addSemanticDiagnostic({code:ue.AT202,message:`Unexpected '${D[w.nodeType]}' token. Expected one of following: ${D[D.Number]}`,severity:he.Error,start:w.start,end:w.end});return k.Applied;case"ts":switch(s.arguments.arguments[0].nodeType){case D.Number:t.masterBar.timeSignatureNumerator=s.arguments.arguments[0].value,t.masterBar.timeSignatureDenominator=s.arguments.arguments[1].value;break;case D.Ident:case D.String:const w=s.arguments.arguments[0].text;if(w.toLowerCase()==="common")t.masterBar.timeSignatureCommon=!0,t.masterBar.timeSignatureNumerator=4,t.masterBar.timeSignatureDenominator=4;else return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected time signature value '${w}', expected: common or two numbers`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),k.NotAppliedSemanticError;break}return k.Applied;case"ks":const f=ee._parseEnumValue(e,s.arguments,"key signature",U.keySignature);if(f===void 0)return k.NotAppliedSemanticError;const p=ee._parseEnumValue(e,s.arguments,"key signature type",U.keySignatureType);return p===void 0?k.NotAppliedSemanticError:(t.keySignature=f,t.keySignatureType=p,k.Applied);case"clef":switch(s.arguments.arguments[0].nodeType){case D.Ident:case D.String:const w=ee._parseEnumValue(e,s.arguments,"clef",U.clef);if(w===void 0)return k.NotAppliedSemanticError;t.clef=w;break;case D.Number:const se=s.arguments.arguments[0].value;switch(se){case 0:t.clef=Te.Neutral;break;case 43:t.clef=Te.G2;break;case 65:t.clef=Te.F4;break;case 48:t.clef=Te.C3;break;case 60:t.clef=Te.C4;break;default:return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected clef value '${se}', expected: ${Array.from(U.clef.keys()).join(",")}`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),k.NotAppliedSemanticError}break}return k.Applied;case"section":const g=new cr;return s.arguments.arguments.length===1?g.text=s.arguments.arguments[0].text:(g.marker=s.arguments.arguments[0].text,g.text=s.arguments.arguments[1].text),t.masterBar.section=g,k.Applied;case"tf":switch(s.arguments.arguments[0].nodeType){case D.Ident:case D.String:const w=ee._parseEnumValue(e,s.arguments,"triplet feel",U.tripletFeel);if(w===void 0)return k.NotAppliedSemanticError;t.masterBar.tripletFeel=w;break;case D.Number:const se=s.arguments.arguments[0].value;switch(se){case 0:t.masterBar.tripletFeel=Be.NoTripletFeel;break;case 1:t.masterBar.tripletFeel=Be.Triplet16th;break;case 2:t.masterBar.tripletFeel=Be.Triplet8th;break;case 3:t.masterBar.tripletFeel=Be.Dotted16th;break;case 4:t.masterBar.tripletFeel=Be.Dotted8th;break;case 5:t.masterBar.tripletFeel=Be.Scottish16th;break;case 6:t.masterBar.tripletFeel=Be.Scottish8th;break;default:return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected triplet feel value '${se}', expected: ${Array.from(U.tripletFeel.keys()).join(",")}`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),k.NotAppliedSemanticError}break}return k.Applied;case"barlineleft":const m=ee._parseEnumValue(e,s.arguments,"bar line",U.barLineStyle);return m===void 0?k.NotAppliedSemanticError:(t.barLineLeft=m,k.Applied);case"barlineright":const b=ee._parseEnumValue(e,s.arguments,"bar line",U.barLineStyle);return b===void 0?k.NotAppliedSemanticError:(t.barLineRight=b,k.Applied);case"accidentals":return ee._handleAccidentalMode(e,s.arguments);case"jump":const S=ee._parseEnumValue(e,s.arguments,"direction",U.direction);return S===void 0?k.NotAppliedSemanticError:(t.masterBar.addDirection(S),k.Applied);case"ottava":const T=ee._parseEnumValue(e,s.arguments,"clef ottava",U.ottavia);return T===void 0?k.NotAppliedSemanticError:(t.clefOttava=T,k.Applied);case"simile":const C=ee._parseEnumValue(e,s.arguments,"simile mark",U.simileMark);return C===void 0?k.NotAppliedSemanticError:(t.simileMark=C,k.Applied);case"width":return t.masterBar.displayWidth=s.arguments.arguments[0].value,t.displayWidth=t.masterBar.displayWidth,k.Applied;case"scale":return t.masterBar.displayScale=s.arguments.arguments[0].value,t.displayScale=t.masterBar.displayScale,k.Applied;case"spd":const v=new ci;return v.pedalType=qe.Down,v.ratioPosition=s.arguments.arguments[0].value,t.sustainPedals.push(v),k.Applied;case"spu":const G=new ci;return G.pedalType=qe.Up,G.ratioPosition=s.arguments.arguments[0].value,t.sustainPedals.push(G),k.Applied;case"sph":const W=new ci;return W.pedalType=qe.Hold,W.ratioPosition=s.arguments.arguments[0].value,t.sustainPedals.push(W),k.Applied;case"ft":return t.masterBar.isFreeTime=!0,k.Applied;case"ro":return t.masterBar.isRepeatStart=!0,k.Applied;case"ac":return t.masterBar.isAnacrusis=!0,k.Applied;case"db":return t.masterBar.isDoubleBar=!0,t.barLineRight=ce.LightLight,k.Applied;default:return k.NotAppliedUnrecognizedMarker}}static _handleAccidentalMode(e,t){const s=ee._parseEnumValue(e,t,"accidental mode",U.alphaTexAccidentalMode);return s===void 0?k.NotAppliedSemanticError:(e.state.accidentalMode=s,k.Applied)}static _getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}_buildSyncPoint(e){const t=e.arguments.arguments[0].value,s=e.arguments.arguments[1].value,i=e.arguments.arguments[2].value;let r=0;return e.arguments.arguments.length>3&&(r=e.arguments.arguments[3].value),{barIndex:t,barOccurence:s,barPosition:r,millisecondOffset:i}}_validateArgumentTypes(e,t,s,i){if(!i)return t.some(d=>d.parameters.length===0||!d.parameters.some(f=>f.parseMode===Bt.Required||f.parseMode===Bt.RequiredAsFloat||f.parseMode===Bt.RequiredAsValueList))?!0:(e.addSemanticDiagnostic({code:ue.AT219,message:`Error parsing arguments: no overload matched arguments ${xt.generateSignaturesFromArguments(void 0)}. Signatures: ${xt.generateSignatures(t)}`,severity:he.Error,start:s.start,end:s.end}),!1);if(i.validated)return!0;let r=!1;const n=new Map(t.map((c,d)=>[d,{signature:c,parameterIndex:0,parameterValueMatches:0,parameterHasValues:!1}])),o=e.parseMode===Qi.Full,l=o?(c,d)=>{const f=n.get(d),p=c;p.parameterIndices||(p.parameterIndices=new Map),p.parameterIndices.set(d,f.parameterIndex)}:(c,d)=>{};for(const c of i.arguments)if(xt.filterSignatureCandidates(n,c,!1,l),n.size===0)break;const h=o?Array.from(n.entries()):void 0;return xt.filterIncompleteCandidates(n),n.size===0&&(e.addSemanticDiagnostic({code:ue.AT219,message:`Error parsing arguments: no overload matched arguments ${xt.generateSignaturesFromArguments(i.arguments)}. Signatures:
${xt.generateSignatures(t)}`,severity:he.Error,start:i.start,end:i.end}),r=!0),h&&(xt.sortCandidates(h),i.signatureCandidateIndices=h.map(c=>c[0])),!r}_headerFooterStyle(e,t,s,i,r=1){const n=i.arguments.arguments.length-r;if(n<1)return;const o=L.getOrCreateHeaderFooterStyle(t,s);o.isVisible===void 0&&(o.isVisible=!0);const l=i.arguments.arguments[r].text;if(l?o.template=l:o.isVisible=!1,n<2)return;const h=ee._parseEnumValue(e,i.arguments,"textAlign",U.textAlign,r+1);h!==void 0&&(o.textAlign=h)}_readTrackInstrument(e,t,s){switch(s.arguments[0].nodeType){case D.Number:const i=s.arguments[0].value;i>=0&&i<=127?t.playbackInfo.program=i:e.addSemanticDiagnostic({code:ue.AT211,message:`Value is out of valid range. Allowed range: 0-127, Actual Value: ${i}`,start:s.arguments[0].start,end:s.arguments[0].end,severity:he.Error});break;case D.Ident:case D.String:const r=s.arguments[0].text.toLowerCase();if(r==="percussion"){for(const n of t.staves)e.applyStaffNoteKind(n,Gt.Articulation);t.playbackInfo.primaryChannel=oe.PercussionChannel,t.playbackInfo.secondaryChannel=oe.PercussionChannel}else t.playbackInfo.program=Zt.getValue(r);break}}_chordProperties(e,t,s){if(s.properties){for(const i of s.properties.properties)if(this._checkProperty(e,[Ae.metaDataProperties.get("chord")],i))switch(i.property.text.toLowerCase()){case"firstfret":t.firstFret=i.arguments.arguments[0].value;break;case"showdiagram":t.showDiagram=ee._booleanLikeValue(i.arguments.arguments,0);break;case"showfingering":t.showFingering=ee._booleanLikeValue(i.arguments.arguments,0);break;case"showname":t.showName=ee._booleanLikeValue(i.arguments.arguments,0);break;case"barre":t.barreFrets=i.arguments.arguments.map(r=>r.value);break}}}_tuningProperties(e,t,s,i){if(i.properties){for(const r of i.properties.properties)if(this._checkProperty(e,[Ae.metaDataProperties.get("tuning")],r))switch(r.property.text.toLowerCase()){case"hide":t.track.score.stylesheet.perTrackDisplayTuning||(t.track.score.stylesheet.perTrackDisplayTuning=new Map),t.track.score.stylesheet.perTrackDisplayTuning.set(t.track.index,!1);break;case"label":s.name=r.arguments.arguments[0].text;break}}}static _booleanLikeValue(e,t){if(t>=e.length)return!0;const s=e[t];switch(s.nodeType){case D.String:case D.Ident:return s.text!=="false";case D.Number:return s.value!==0;default:return!1}}applyStructuralMetaData(e,t){const s=this._checkArgumentTypes(e,[Ae.structuralMetaDataSignatures],t,t.tag.tag.text.toLowerCase(),t.arguments);if(s!==void 0)switch(s){case k.NotAppliedSemanticError:return Vs.NotAppliedSemanticError;case k.NotAppliedUnrecognizedMarker:return Vs.NotAppliedUnrecognizedMarker}switch(t.tag.tag.text.toLowerCase()){case"staff":const i=e.startNewStaff();return this._staffProperties(e,i,t),Vs.AppliedNewStaff;case"track":const r=e.startNewTrack();return t.arguments&&t.arguments.arguments.length>0&&(r.name=t.arguments.arguments[0].text,t.arguments.arguments.length>1&&(r.shortName=t.arguments.arguments[1].text)),this._trackProperties(e,r,t),Vs.AppliedNewTrack;case"voice":return e.startNewVoice(),Vs.AppliedNewVoice;default:return Vs.NotAppliedUnrecognizedMarker}}_checkProperty(e,t,s){const i=this._checkArgumentTypes(e,t,s,s.property.text.toLowerCase(),s.arguments);if(i!==void 0)switch(i){case k.Applied:case k.NotAppliedSemanticError:return!1;case k.NotAppliedUnrecognizedMarker:const r=t.flatMap(n=>Array.from(n.keys()));return e.addSemanticDiagnostic({code:ue.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${r}`,severity:he.Error,start:s.start,end:s.end}),!1}return!0}_staffProperties(e,t,s){if(!s.properties)return;let i=!1,r=!1,n=!1,o=!1;for(const l of s.properties.properties)if(this._checkProperty(e,[Ae.metaDataProperties.get("staff")],l))switch(l.property.text.toLowerCase()){case"score":i=!0,l.arguments&&l.arguments.arguments.length>0&&(t.standardNotationLineCount=l.arguments.arguments[0].value);break;case"tabs":r=!0;break;case"slash":n=!0;break;case"numbered":o=!0;break}(i||r||n||o)&&(t.showStandardNotation=i,t.showTablature=r,t.showSlash=n,t.showNumbered=o)}_trackProperties(e,t,s){if(s.properties){for(const i of s.properties.properties)if(this._checkProperty(e,[Ae.metaDataProperties.get("track")],i))switch(i.property.text.toLowerCase()){case"color":try{t.color=Ce.fromJson(i.arguments.arguments[0].text)}catch{e.addSemanticDiagnostic({code:ue.AT213,message:"Invalid format for color",severity:he.Error,start:i.arguments.arguments[0].start,end:i.arguments.arguments[0].end})}break;case"defaultsystemslayout":t.defaultSystemsLayout=i.arguments.arguments[0].value;break;case"systemslayout":t.systemsLayout=i.arguments.arguments.map(r=>r.value);break;case"volume":t.playbackInfo.volume=i.arguments.arguments[0].value;break;case"balance":t.playbackInfo.balance=i.arguments.arguments[0].value;break;case"mute":t.playbackInfo.isMute=!0;break;case"solo":t.playbackInfo.isSolo=!0;break;case"multibarrest":t.score.stylesheet.perTrackMultiBarRest||(t.score.stylesheet.perTrackMultiBarRest=new Set),t.score.stylesheet.perTrackMultiBarRest.add(t.index);break;case"instrument":this._readTrackInstrument(e,t,i.arguments);break;case"bank":t.playbackInfo.bank=i.arguments.arguments[0].value;break}}}applyBeatDurationProperty(e,t){const s=this._checkArgumentTypes(e,[Ae.durationChangeProperties],t,t.property.text.toLowerCase(),t.arguments);if(s!==void 0)return s;switch(t.property.text.toLowerCase()){case"tu":if(t.arguments.arguments.length===2)e.state.currentTupletNumerator=t.arguments.arguments[0].value,e.state.currentTupletDenominator=t.arguments.arguments[1].value;else{const i=t.arguments.arguments[0].value;e.state.currentTupletNumerator=i;const r=ee._getTupletDenominator(i);r<0?(e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected default tuplet value '${i}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:he.Error,start:t.arguments.arguments[0].start,end:t.arguments.arguments[0].end}),e.state.currentTupletNumerator=-1,e.state.currentTupletDenominator=-1):e.state.currentTupletDenominator=r}return k.Applied}return k.NotAppliedUnrecognizedMarker}static _getTupletDenominator(e){switch(e){case 3:return 2;case 5:return 4;case 6:return 4;case 7:return 4;case 9:return 8;case 10:return 8;case 11:return 8;case 12:return 8;default:return-1}}_allKnownBarMetaDataTags=void 0;get allKnownMetaDataTags(){if(!this._allKnownBarMetaDataTags){this._allKnownBarMetaDataTags=new Set;const e=[Ae.scoreMetaDataSignatures.keys(),Ae.structuralMetaDataSignatures.keys(),Ae.staffMetaDataSignatures.keys(),Ae.barMetaDataSignatures.keys()];for(const t of e)for(const s of t)this._allKnownBarMetaDataTags.add(s)}return this._allKnownBarMetaDataTags}_knownScoreMetaDataTags=void 0;get knownScoreMetaDataTags(){return this._knownScoreMetaDataTags||(this._knownScoreMetaDataTags=new Set(Ae.scoreMetaDataSignatures.keys())),this._knownScoreMetaDataTags}_knownStructuralMetaDataTags=void 0;get knownStructuralMetaDataTags(){return this._knownStructuralMetaDataTags||(this._knownStructuralMetaDataTags=new Set(Ae.structuralMetaDataSignatures.keys())),this._knownStructuralMetaDataTags}_knownBarMetaDataTags=void 0;get knownBarMetaDataTags(){return this._knownBarMetaDataTags||(this._knownBarMetaDataTags=new Set(Ae.barMetaDataSignatures.keys())),this._knownBarMetaDataTags}_knownStaffMetaDataTags=void 0;get knownStaffMetaDataTags(){return this._knownStaffMetaDataTags||(this._knownStaffMetaDataTags=new Set(Ae.staffMetaDataSignatures.keys())),this._knownStaffMetaDataTags}_knownBeatDurationProperties=void 0;get knownBeatDurationProperties(){return this._knownBeatDurationProperties||(this._knownBeatDurationProperties=new Set(Ae.durationChangeProperties.keys())),this._knownBeatDurationProperties}_knownBeatProperties=void 0;get knownBeatProperties(){return this._knownBeatProperties||(this._knownBeatProperties=new Set(Ae.beatProperties.keys())),this._knownBeatProperties}_knownNoteProperties=void 0;get knownNoteProperties(){return this._knownNoteProperties||(this._knownNoteProperties=new Set(Ae.noteProperties.keys())),this._knownNoteProperties}applyBeatProperty(e,t,s){const i=s.property.text.toLowerCase(),r=this._checkArgumentTypes(e,[Ae.beatProperties],s,i,s.arguments);if(r!==void 0)return r;switch(i){case"f":return t.fade=ut.FadeIn,k.Applied;case"fo":return t.fade=ut.FadeOut,k.Applied;case"vs":return t.fade=ut.VolumeSwell,k.Applied;case"v":return t.vibrato=be.Slight,k.Applied;case"vw":return t.vibrato=be.Wide,k.Applied;case"s":return t.slap=!0,k.Applied;case"p":return t.pop=!0,k.Applied;case"tt":return t.tap=!0,k.Applied;case"txt":return t.text=s.arguments.arguments[0].text,k.Applied;case"lyrics":let n=0,o="";for(s.arguments.arguments.length===2?(n=s.arguments.arguments[0].value,o=s.arguments.arguments[1].text):o=s.arguments.arguments[0].text,t.lyrics||(t.lyrics=[]);t.lyrics.length<=n;)t.lyrics.push("");return t.lyrics[n]=o,k.Applied;case"dd":return t.dots=2,k.Applied;case"d":return t.dots=1,k.Applied;case"su":return t.pickStroke=kt.Up,k.Applied;case"sd":return t.pickStroke=kt.Down,k.Applied;case"tu":if(s.arguments.arguments.length===2)t.tupletNumerator=s.arguments.arguments[0].value,t.tupletDenominator=s.arguments.arguments[1].value;else{const We=s.arguments.arguments[0].value;t.tupletNumerator=We;const qt=ee._getTupletDenominator(We);if(qt<0)return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected default tuplet value '${We}', expected: 3, 5, 6, 7, 9, 10, 11 or 12`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),t.tupletNumerator=-1,t.tupletDenominator=-1,k.NotAppliedSemanticError;t.tupletDenominator=qt}return k.Applied;case"tb":case"tbe":let l=0,h=!0,c=!1;for(;h;)switch(s.arguments.arguments[l].nodeType){case D.Ident:case D.String:const We=s.arguments.arguments[l].text.toLowerCase();if(U.whammyType.has(We))t.whammyBarType=U.whammyType.get(We),c=!0,l++;else if(U.bendStyle.has(We))t.whammyStyle=U.bendStyle.get(We),l++;else return c?ee._parseEnumValue(e,s.arguments,"whammy style",U.bendStyle,l):ee._parseEnumValue(e,s.arguments,"whammy type",U.whammyType,l),k.NotAppliedSemanticError;break;default:h=!1;break}const d=this._getBendPoints(e,s,l,i==="tbe");if(d)for(const We of d)t.addWhammyBarPoint(We);return k.Applied;case"bu":return ee._applyBrush(t,s,Y.BrushUp,.25),k.Applied;case"bd":return ee._applyBrush(t,s,Y.BrushDown,.25),k.Applied;case"au":return ee._applyBrush(t,s,Y.ArpeggioUp,1),k.Applied;case"ad":return ee._applyBrush(t,s,Y.ArpeggioDown,1),k.Applied;case"ch":const f=s.arguments.arguments[0].text,p=ee._getChordId(t.voice.bar.staff,f);if(!t.voice.bar.staff.hasChord(p)){const We=new ui;We.showDiagram=!1,We.name=f,t.voice.bar.staff.addChord(p,We)}return t.chordId=p,k.Applied;case"gr":if(s.arguments&&s.arguments.arguments.length>0){const We=ee._parseEnumValue(e,s.arguments,"whammy style",U.graceType);if(We===void 0)return k.NotAppliedSemanticError;t.graceType=We}else t.graceType=$.BeforeBeat;return k.Applied;case"dy":const g=ee._parseEnumValue(e,s.arguments,"dynamic",U.dynamicValue);return g===void 0?k.NotAppliedSemanticError:(t.dynamics=g,e.state.currentDynamics=g,k.Applied);case"cre":return t.crescendo=Lt.Crescendo,k.Applied;case"dec":return t.crescendo=Lt.Decrescendo,k.Applied;case"tempo":const m=s.arguments.arguments[0].value;let b="",S=!0;if(s.arguments.arguments.length>2){b=s.arguments.arguments[1].text;const We=s.arguments.arguments[2].text;if(We==="hide")S=!1;else return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected third tempo property value '${We}', expected: 'hide'`,severity:he.Error,start:s.arguments.arguments[2].start,end:s.arguments.arguments[2].end}),k.NotAppliedSemanticError}else s.arguments.arguments.length>1&&(b=s.arguments.arguments[1].text,b==="hide"&&(S=!1,b=""));const T=new Ye;return T.isLinear=!1,T.type=De.Tempo,T.value=m,T.text=b,T.isVisible=S,t.automations.push(T),t.voice.bar.masterBar.tempoAutomations.push(T),k.Applied;case"volume":const C=new Ye;return C.isLinear=!0,C.type=De.Volume,C.value=s.arguments.arguments[0].value,t.automations.push(C),k.Applied;case"balance":const v=new Ye;return v.isLinear=!0,v.type=De.Balance,v.value=L.clamp(s.arguments.arguments[0].value,0,16),t.automations.push(v),k.Applied;case"tp":if(t.tremoloSpeed=y.Eighth,s.arguments&&s.arguments.arguments.length>0){const We=s.arguments.arguments[0].value;switch(We){case 8:t.tremoloSpeed=y.Eighth;break;case 16:t.tremoloSpeed=y.Sixteenth;break;case 32:t.tremoloSpeed=y.ThirtySecond;break;default:return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected tremolo speed value '${We}, expected: 8, 16 or 32`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),k.NotAppliedSemanticError}}return k.Applied;case"spd":return ee._applySustainPedal(e,t,qe.Down),k.Applied;case"sph":return ee._applySustainPedal(e,t,qe.Hold),k.Applied;case"spu":return ee._applySustainPedal(e,t,qe.Up),k.Applied;case"spe":return ee._applySustainPedal(e,t,qe.Up,!0),k.Applied;case"slashed":return t.slashed=!0,k.Applied;case"ds":return t.deadSlapped=!0,t.notes.length===1&&t.notes[0].isDead&&t.removeNote(t.notes[0]),k.Applied;case"glpf":return t.golpe=Ht.Finger,k.Applied;case"glpt":return t.golpe=Ht.Thumb,k.Applied;case"waho":return t.wahPedal=Jt.Open,k.Applied;case"wahc":return t.wahPedal=Jt.Closed,k.Applied;case"barre":if(t.barreFret=s.arguments.arguments[0].value,t.barreShape=ps.Full,s.arguments.arguments.length>1){const We=ee._parseEnumValue(e,s.arguments,"barre shape",U.barreShape,1);if(We===void 0)return k.NotAppliedSemanticError;t.barreShape=We}return k.Applied;case"rasg":const G=ee._parseEnumValue(e,s.arguments,"rasgueado pattern",U.rasgueado);return G===void 0?k.NotAppliedSemanticError:(t.rasgueado=G,k.Applied);case"ot":const W=ee._parseEnumValue(e,s.arguments,"ottava",U.ottavia);return W===void 0?k.NotAppliedSemanticError:(t.ottava=W,k.Applied);case"legatoorigin":return t.isLegatoOrigin=!0,k.Applied;case"instrument":let w=0;switch(s.arguments.arguments[0].nodeType){case D.Ident:case D.String:w=Zt.getValue(s.arguments.arguments[0].text);break;case D.Number:w=s.arguments.arguments[0].value;break}const se=new Ye;return se.isLinear=!1,se.type=De.Instrument,se.value=w,t.automations.push(se),k.Applied;case"bank":const Ne=new Ye;return Ne.isLinear=!1,Ne.type=De.Bank,Ne.value=s.arguments.arguments[0].value,t.automations.push(Ne),k.Applied;case"fermata":const ye=ee._parseEnumValue(e,s.arguments,"fermata",U.fermataType);if(ye===void 0)return k.NotAppliedSemanticError;const te=new hr;return te.type=ye,s.arguments.arguments.length>1&&(te.length=s.arguments.arguments[1].value),t.fermata=te,k.Applied;case"beam":const Ke=s.arguments.arguments[0].text;switch(Ke.toLowerCase()){case"invert":t.invertBeamDirection=!0;break;case"up":t.preferredBeamDirection=P.Up;break;case"down":t.preferredBeamDirection=P.Down;break;case"auto":t.beamingMode=Xe.Auto;break;case"split":t.beamingMode=Xe.ForceSplitToNext;break;case"merge":t.beamingMode=Xe.ForceMergeWithNext;break;case"splitsecondary":t.beamingMode=Xe.ForceSplitOnSecondaryToNext;break;default:const We=["invert","up","down","auto","split","merge","splitsecondary"];return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected beam value '${Ke}', expected: ${We.join(",")}`,severity:he.Error,start:s.arguments.arguments[0].start,end:s.arguments.arguments[0].end}),k.NotAppliedSemanticError}return k.Applied;case"timer":return t.showTimer=!0,k.Applied}return k.NotAppliedUnrecognizedMarker}static _applySustainPedal(e,t,s,i=!1){const r=new ci;r.pedalType=s,i?r.ratioPosition=1:r.ratioPosition=.001*t.voice.bar.sustainPedals.length,e.state.sustainPedalToBeat.set(r,t),t.voice.bar.sustainPedals.push(r)}static _applyBrush(e,t,s,i){e.brushType=s,t.arguments&&t.arguments.arguments.length>0?e.brushDuration=t.arguments.arguments[0].value:(e.updateDurations(),e.brushDuration=e.playbackDuration*i/e.notes.length)}applyNoteProperty(e,t,s){const i=s.property.text.toLowerCase(),r=this._checkArgumentTypes(e,[Ae.noteProperties],s,i,s.arguments);if(r!==void 0)return r;switch(i){case"b":case"be":let n=0,o=!0,l=!1;for(;o;)switch(s.arguments.arguments[n].nodeType){case D.Ident:case D.String:const m=s.arguments.arguments[n].text.toLowerCase();if(U.bendType.has(m))t.bendType=U.bendType.get(m),l=!0,n++;else if(U.bendStyle.has(m))t.bendStyle=U.bendStyle.get(m),n++;else return l?ee._parseEnumValue(e,s.arguments,"bend style",U.bendStyle,n):ee._parseEnumValue(e,s.arguments,"bend type",U.bendType,n),k.NotAppliedSemanticError;break;default:o=!1;break}const h=this._getBendPoints(e,s,n,i==="be");if(h)for(const m of h)t.addBendPoint(m);return k.Applied;case"nh":return t.harmonicType=Q.Natural,t.harmonicValue=L.deltaFretToHarmonicValue(t.fret),k.Applied;case"ah":return t.harmonicType=Q.Artificial,t.harmonicValue=ee._harmonicValue(s.arguments,t.harmonicValue),k.Applied;case"th":return t.harmonicType=Q.Tap,t.harmonicValue=ee._harmonicValue(s.arguments,t.harmonicValue),k.Applied;case"ph":return t.harmonicType=Q.Pinch,t.harmonicValue=ee._harmonicValue(s.arguments,t.harmonicValue),k.Applied;case"sh":return t.harmonicType=Q.Semi,t.harmonicValue=ee._harmonicValue(s.arguments,t.harmonicValue),k.Applied;case"fh":return t.harmonicType=Q.Feedback,t.harmonicValue=ee._harmonicValue(s.arguments,t.harmonicValue),k.Applied;case"tr":const c=s.arguments.arguments[0].value;let d=y.Sixteenth;if(s.arguments.arguments.length>1){const m=s.arguments.arguments[1].value;switch(m){case 16:d=y.Sixteenth;break;case 32:d=y.ThirtySecond;break;case 64:d=y.SixtyFourth;break;default:return e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected trill duration value '${m}', expected: 16, 32 or 64`,severity:he.Error,start:s.arguments.arguments[1].start,end:s.arguments.arguments[1].end}),k.NotAppliedSemanticError}}return t.trillValue=c+t.stringTuning,t.trillSpeed=d,k.Applied;case"v":return t.vibrato=be.Slight,k.Applied;case"vw":return t.vibrato=be.Wide,k.Applied;case"sl":return t.slideOutType=ne.Legato,k.Applied;case"ss":return t.slideOutType=ne.Shift,k.Applied;case"sib":return t.slideInType=dt.IntoFromBelow,k.Applied;case"sia":return t.slideInType=dt.IntoFromAbove,k.Applied;case"sou":return t.slideOutType=ne.OutUp,k.Applied;case"sod":return t.slideOutType=ne.OutDown,k.Applied;case"psd":return t.slideOutType=ne.PickSlideDown,k.Applied;case"psu":return t.slideOutType=ne.PickSlideUp,k.Applied;case"h":return t.isHammerPullOrigin=!0,k.Applied;case"lht":return t.isLeftHandTapped=!0,k.Applied;case"g":return t.isGhost=!0,k.Applied;case"ac":return t.accentuated=tt.Normal,k.Applied;case"hac":return t.accentuated=tt.Heavy,k.Applied;case"ten":return t.accentuated=tt.Tenuto,k.Applied;case"pm":return t.isPalmMute=!0,k.Applied;case"st":return t.isStaccato=!0,k.Applied;case"lr":return t.isLetRing=!0,k.Applied;case"x":return t.isDead=!0,k.Applied;case"-":case"t":return t.isTieDestination=!0,k.Applied;case"lf":let f=j.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const m=ee._toFinger(e,s.arguments);if(m===void 0)return k.NotAppliedSemanticError;f=m}return t.leftHandFinger=f,k.Applied;case"rf":let p=j.Thumb;if(s.arguments&&s.arguments.arguments.length>0){const m=ee._toFinger(e,s.arguments);if(m===void 0)return k.NotAppliedSemanticError;p=m}return t.rightHandFinger=p,k.Applied;case"acc":return t.accidentalMode=L.parseAccidentalMode(s.arguments.arguments[0].text),k.Applied;case"turn":return t.ornament=je.Turn,k.Applied;case"iturn":return t.ornament=je.InvertedTurn,k.Applied;case"umordent":return t.ornament=je.UpperMordent,k.Applied;case"lmordent":return t.ornament=je.LowerMordent,k.Applied;case"string":return t.showStringNumber=!0,k.Applied;case"hide":return t.isVisible=!1,k.Applied;case"slur":const g=s.arguments.arguments[0].text;if(e.state.slurs.has(g)){const m=e.state.slurs.get(g);m.slurDestination=t,t.slurOrigin=m,t.isSlurDestination=!0}else e.state.slurs.set(g,t);return k.Applied;default:return this.applyBeatProperty(e,t.beat,s)}return k.NotAppliedUnrecognizedMarker}static _toFinger(e,t){const s=t.arguments[0].value;switch(s){case 1:return j.Thumb;case 2:return j.IndexFinger;case 3:return j.MiddleFinger;case 4:return j.AnnularFinger;case 5:return j.LittleFinger;default:e.addSemanticDiagnostic({code:ue.AT211,message:`Value is out of valid range. Allowed range: 1-5, Actual Value: ${s}`,start:t.arguments[0].start,end:t.arguments[0].end,severity:he.Error});return}}static _harmonicValue(e,t){return e&&(t=e.arguments[0].value),t}_getBendPoints(e,t,s,i){let r=t.arguments.arguments,n=r.length-s,o=t.arguments;n>0&&r[s].nodeType===D.Arguments&&(r=r[s].arguments,s=0,n=r.length,o=r[s]);const l=i?2:1;if(n%l!==0){const d=Math.ceil(n/l),f=d*l;e.addSemanticDiagnostic({code:ue.AT214,message:`The '${t.property.text}' effect needs ${l} arguments per item. With ${d} points, ${f} arguments are needed, only ${n} arguments found.`,severity:he.Error,start:o.end,end:o.end});return}const h=[];let c=s;for(;c<r.length;){let d=0,f=0;i?(d=r[c++].value,f=r[c++].value):(d=0,f=r[c++].value),h.push(new H(d,f))}if(h.length>0){if(h.length>60&&h.splice(60,h.length-60),i)h.sort((d,f)=>d.offset-f.offset);else{const d=h.length,f=H.MaxPosition/(d-1)|0;let p=0;for(;p<d;)h[p].offset=Math.min(H.MaxPosition,p*f),p++}return h}else return}static _parseEnumValue(e,t,s,i,r=0){if(r>=t.arguments.length)return;const n=t.arguments[r].text;if(i.has(n.toLowerCase()))return i.get(n.toLowerCase());e.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected ${s} value '${n}', expected: ${Array.from(i.keys()).join(",")}`,severity:he.Error,start:t.arguments[r].start,end:t.arguments[r].end})}static _defaultScore=new Ws;static _defaultTrack=new Gs;buildScoreMetaDataNodes(e){const t=[];return ee._buildScoreInfoMeta(t,"album",e,e.album,O.Album),ee._buildScoreInfoMeta(t,"artist",e,e.artist,O.Artist),ee._buildScoreInfoMeta(t,"copyright",e,e.copyright,O.Copyright),ee._buildScoreInfoMeta(t,"copyright2",e,void 0,O.CopyrightSecondLine),ee._buildScoreInfoMeta(t,"wordsandmusic",e,void 0,O.WordsAndMusic,!0),ee._buildScoreInfoMeta(t,"instructions",e,e.instructions,void 0),ee._buildScoreInfoMeta(t,"music",e,e.music,O.Music),ee._buildScoreInfoMeta(t,"notices",e,e.notices,void 0),ee._buildScoreInfoMeta(t,"subtitle",e,e.subTitle,O.SubTitle),ee._buildScoreInfoMeta(t,"title",e,e.title,O.Title),ee._buildScoreInfoMeta(t,"words",e,e.words,O.Words),ee._buildScoreInfoMeta(t,"tab",e,e.tab,O.Transcriber),e.defaultSystemsLayout!==ee._defaultScore.defaultSystemsLayout&&t.push(_.numberMeta("defaultSystemsLayout",e.defaultSystemsLayout)),e.systemsLayout.length>0&&t.push(_.meta("systemsLayout",_.args(e.systemsLayout.map(s=>_.number(s))))),ee._buildStyleSheetMetaData(t,e.stylesheet),t.length>0&&(t[0].leadingComments=[{text:"Score Metadata",multiLine:!1}]),t}static _buildStyleSheetMetaData(e,t){const s=e.length;t.hideDynamics&&e.push(_.meta("hideDynamics")),t.bracketExtendMode!==ee._defaultScore.stylesheet.bracketExtendMode&&e.push(_.identMeta("bracketExtendMode",U.bracketExtendModeReversed.get(t.bracketExtendMode))),t.useSystemSignSeparator&&e.push(_.meta("useSystemSignSeparator")),t.multiTrackMultiBarRest&&e.push(_.meta("multiBarRest")),t.singleTrackTrackNamePolicy!==ee._defaultScore.stylesheet.singleTrackTrackNamePolicy&&e.push(_.identMeta("singleTrackTrackNamePolicy",U.trackNamePolicyReversed.get(t.singleTrackTrackNamePolicy))),t.multiTrackTrackNamePolicy!==ee._defaultScore.stylesheet.multiTrackTrackNamePolicy&&e.push(_.identMeta("multiTrackTrackNamePolicy",U.trackNamePolicyReversed.get(t.multiTrackTrackNamePolicy))),t.firstSystemTrackNameMode!==ee._defaultScore.stylesheet.firstSystemTrackNameMode&&e.push(_.identMeta("firstSystemTrackNameMode",U.trackNameModeReversed.get(t.firstSystemTrackNameMode))),t.otherSystemsTrackNameMode!==ee._defaultScore.stylesheet.otherSystemsTrackNameMode&&e.push(_.identMeta("otherSystemsTrackNameMode",U.trackNameModeReversed.get(t.otherSystemsTrackNameMode))),t.firstSystemTrackNameOrientation!==ee._defaultScore.stylesheet.firstSystemTrackNameOrientation&&e.push(_.identMeta("firstSystemTrackNameOrientation",U.trackNameOrientationReversed.get(t.firstSystemTrackNameOrientation))),t.otherSystemsTrackNameOrientation!==ee._defaultScore.stylesheet.otherSystemsTrackNameOrientation&&e.push(_.identMeta("otherSystemsTrackNameOrientation",U.trackNameOrientationReversed.get(t.otherSystemsTrackNameOrientation))),s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:"Score Stylesheet"}])}static _buildScoreInfoMeta(e,t,s,i,r,n=!1){if(i!==void 0&&i.length===0&&!n)return;const o=[];if(i!==void 0&&o.push(_.string(i)),r!==void 0){const l=s.style&&s.style.headerAndFooter.has(r)?s.style.headerAndFooter.get(r):void 0,h=Di.defaultHeaderAndFooter.has(r)?Di.defaultHeaderAndFooter.get(r):void 0;l&&(!h||!is.equals(h,l))&&(o.push(_.string(l.isVisible===!1?"":l.template)),o.push(_.ident(U.textAlignReversed.get(l.textAlign))))}i===void 0&&o.length===0||i!==void 0&&i.length===0&&o.length===1||e.push(_.meta(t,_.args(o)))}buildSyncPointNodes(e){const t=[],s=e.exportFlatSyncPoints();for(const i of s)t.push(_.meta("sync",_.args([_.number(i.barIndex),_.number(i.barOccurence),_.number(i.millisecondOffset),i.barPosition>0?_.number(i.barPosition):void 0])));return t}buildBarMetaDataNodes(e,t,s,i){const r=[];if(ee._buildStructuralMetaDataNodes(t,e,r,i,s),!t)return r;s===0&&e.index===0&&e.track.index===0&&ee._buildMasterBarMetaDataNodes(r,t.masterBar);const n=r.length;s===0&&t.index===0&&e.index===0&&e.track.index===0&&r.push(_.identMeta("accidentals","auto")),(t.index===0||t.clef!==t.previousBar?.clef)&&r.push(_.identMeta("clef",U.clefReversed.get(t.clef))),(t.index===0&&t.clefOttava!==ae.Regular||t.clefOttava!==t.previousBar?.clefOttava)&&r.push(_.identMeta("ottava",U.ottaviaReversed.get(t.clefOttava))),(t.index===0&&t.simileMark!==_t.None||t.simileMark!==t.previousBar?.simileMark)&&r.push(_.identMeta("simile",U.simileMarkReversed.get(t.simileMark))),t.displayScale!==1&&r.push(_.numberMeta("scale",t.displayScale)),t.displayWidth>0&&r.push(_.numberMeta("width",t.displayWidth));for(const o of t.sustainPedals){let l="";switch(o.pedalType){case qe.Down:l="spd";break;case qe.Hold:l="sph";break;case qe.Up:l="spu";break}l&&r.push(_.numberMeta(l,o.ratioPosition))}if(t.barLineLeft!==ce.Automatic&&r.push(_.identMeta("barLineLeft",U.barLineStyleReversed.get(t.barLineLeft))),t.barLineRight!==ce.Automatic&&r.push(_.identMeta("barLineRight",U.barLineStyleReversed.get(t.barLineRight))),t.index===0||t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType){let o="";t.keySignatureType===Qt.Minor?o=U.keySignaturesMinorReversed.get(t.keySignature):o=U.keySignaturesMajorReversed.get(t.keySignature),r.push(_.identMeta("ks",o))}return n<r.length&&(r[n].leadingComments=[{multiLine:!1,text:`Bar ${t.index+1} Metadata`}]),r}static _buildStaffMetaDataNodes(e,t){const s=e.length;if(t.capo!==0&&e.push(_.numberMeta("capo",t.capo)),t.isPercussion)e.push(_.identMeta("articulation","defaults"));else if(t.isStringed){const r=_.meta("tuning",_.args(t.stringTuning.tunings.map(n=>_.ident(A.getTextForTuning(n,!0)))));e.push(r),t.track.score.stylesheet.perTrackDisplayTuning&&t.track.score.stylesheet.perTrackDisplayTuning.has(t.track.index)&&(r.properties=_.props([["hide",void 0]])),t.stringTuning.name.length>0&&(r.properties??=_.props([]),_.prop(r.properties.properties,"label",_.stringValue(t.stringTuning.name)))}t.transpositionPitch!==0&&e.push(_.numberMeta("transpose",-t.transpositionPitch));const i=L.displayTranspositionPitches.has(t.track.playbackInfo.program)?L.displayTranspositionPitches.get(t.track.playbackInfo.program):0;if(t.displayTranspositionPitch!==i&&e.push(_.numberMeta("displaytranspose",-t.displayTranspositionPitch)),t.chords!=null)for(const[r,n]of t.chords)e.push(ee._buildChordNode(n));s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:`Staff ${t.index+1} Metadata`}])}static _buildChordNode(e){const t=_.meta("chord",_.args([_.string(e.name)],!0),_.props([e.firstFret>=0?["firstfret",_.numberValue(e.firstFret)]:void 0,["showdiagram",_.identValue(e.showDiagram?"true":"false")],["showfingering",_.identValue(e.showFingering?"true":"false")],["showname",_.identValue(e.showName?"true":"false")],e.barreFrets.length>0?["barre",_.args(e.barreFrets.map(s=>_.number(s)))]:void 0]));for(let s=0;s<e.staff.tuning.length;s++)s<e.strings.length&&e.strings[s]>=0?t.arguments.arguments.push(_.number(e.strings[s])):t.arguments.arguments.push(_.ident("x"));return t}static _buildMasterBarMetaDataNodes(e,t){const s=e.length;if(t.alternateEndings!==0&&e.push(_.meta("ae",_.args(L.getAlternateEndingsList(t.alternateEndings).map(i=>_.number(i+1))))),t.isRepeatStart&&e.push(_.meta("ro")),t.isRepeatEnd&&e.push(_.numberMeta("rc",t.repeatCount)),(t.index===0||t.timeSignatureCommon!==t.previousMasterBar?.timeSignatureCommon||t.timeSignatureNumerator!==t.previousMasterBar.timeSignatureNumerator||t.timeSignatureDenominator!==t.previousMasterBar.timeSignatureDenominator)&&(t.timeSignatureCommon?e.push(_.identMeta("ts","common")):e.push(_.meta("ts",_.args([_.number(t.timeSignatureNumerator),_.number(t.timeSignatureDenominator)])))),(t.index>0&&t.tripletFeel!==t.previousMasterBar?.tripletFeel||t.index===0&&t.tripletFeel!==Be.NoTripletFeel)&&e.push(_.identMeta("tf",U.tripletFeelReversed.get(t.tripletFeel))),t.isFreeTime&&e.push(_.meta("ft")),t.section!=null&&e.push(_.meta("section",_.args([_.string(t.section.marker),_.string(t.section.text)]))),t.isAnacrusis&&e.push(_.meta("ac")),t.displayScale!==1&&e.push(_.numberMeta("scale",t.displayScale)),t.displayWidth>0&&e.push(_.numberMeta("width",t.displayWidth)),t.directions)for(const i of t.directions)e.push(_.identMeta("jump",U.directionReversed.get(i)));for(const i of t.tempoAutomations){const r=_.meta("tempo",_.args([_.number(i.value),i.text?_.string(i.text):void 0,i.ratioPosition>0?_.number(i.ratioPosition):void 0,i.isVisible?void 0:_.ident("hide")]));r.arguments.arguments.length===1&&(r.arguments.openParenthesis=void 0,r.arguments.closeParenthesis=void 0),e.push(r)}s<e.length&&(e[s].leadingComments=[{multiLine:!1,text:`Masterbar ${t.index+1} Metadata`}])}static _buildStructuralMetaDataNodes(e,t,s,i,r){if((e===void 0||e.index===0)&&(r===0&&(t.index===0&&s.push(ee._buildNewTrackNode(t.track)),s.push(ee._buildNewStaffNode(t)),ee._buildStaffMetaDataNodes(s,t)),i)){const n=_.meta("voice");n.trailingComments=[{multiLine:!0,text:`Voice ${r+1}`}],s.push(n)}}static _buildNewStaffNode(e){const t=_.meta("staff",void 0,_.props([e.showStandardNotation?["score",_.args([e.standardNotationLineCount!==Li.DefaultStandardNotationLineCount?_.number(e.standardNotationLineCount):void 0])]:void 0,e.showTablature?["tabs",void 0]:void 0,e.showSlash?["slash",void 0]:void 0,e.showNumbered?["numbered",void 0]:void 0]));return t.properties&&t.properties.properties.length>0&&(t.properties.properties[0].leadingComments=[{multiLine:!1,text:"Staff Properties"}]),t}static _buildNewTrackNode(e){const t=_.meta("track",_.args([_.string(e.name),e.shortName.length>0?_.string(e.shortName):void 0]),_.props([e.color.rgba!==ee._defaultTrack.color.rgba?["color",_.stringValue(e.color.rgba)]:void 0,e.defaultSystemsLayout!==ee._defaultTrack.defaultSystemsLayout?["defaultSystemsLayout",_.numberValue(e.defaultSystemsLayout)]:void 0,e.systemsLayout.length?["systemsLayout",_.args(e.systemsLayout.map(s=>_.number(s)))]:void 0,["volume",_.numberValue(e.playbackInfo.volume)],["balance",_.numberValue(e.playbackInfo.balance)],e.playbackInfo.isMute?["mute",void 0]:void 0,e.playbackInfo.isSolo?["solo",void 0]:void 0,e.score.stylesheet.perTrackMultiBarRest&&e.score.stylesheet.perTrackMultiBarRest.has(e.index)?["multiBarRest",void 0]:void 0,["instrument",_.identValue(e.isPercussion?"percussion":Zt.getName(e.playbackInfo.program))],e.playbackInfo.bank>0?["bank",_.numberValue(e.playbackInfo.bank)]:void 0]));return t.properties&&t.properties.properties.length>0&&(t.properties.properties[0].leadingComments=[{multiLine:!1,text:"Track Properties"}]),t}buildNoteEffects(e){const t=[];if(e.hasBend){const i=_.args([_.ident(U.bendTypeReversed.get(e.bendType)),e.bendStyle!==ze.Default?_.ident(U.bendStyleReversed.get(e.bendStyle)):void 0],!0);for(const r of e.bendPoints)i.arguments.push(_.number(r.offset)),i.arguments.push(_.number(r.value));_.prop(t,"be",i)}let s="";switch(e.harmonicType){case Q.Natural:_.prop(t,"nh");break;case Q.Artificial:s="ah";break;case Q.Pinch:s="ph";break;case Q.Tap:s="th";break;case Q.Semi:s="sh";break;case Q.Feedback:s="fh";break}switch(s&&_.prop(t,s,_.numberValue(e.harmonicValue)),e.showStringNumber&&_.prop(t,"string"),e.isTrill&&_.prop(t,"tr",_.args([_.number(e.trillFret),_.number(e.trillSpeed)])),e.vibrato){case be.Slight:_.prop(t,"v");break;case be.Wide:_.prop(t,"vw");break}switch(e.slideInType){case dt.IntoFromBelow:_.prop(t,"sib");break;case dt.IntoFromAbove:_.prop(t,"sia");break}switch(e.slideOutType){case ne.Shift:_.prop(t,"ss");break;case ne.Legato:_.prop(t,"sl");break;case ne.OutUp:_.prop(t,"sou");break;case ne.OutDown:_.prop(t,"sod");break;case ne.PickSlideDown:_.prop(t,"psd");break;case ne.PickSlideUp:_.prop(t,"psu");break}switch(e.isHammerPullOrigin&&_.prop(t,"h"),e.isLeftHandTapped&&_.prop(t,"lht"),e.isGhost&&_.prop(t,"g"),e.accentuated){case tt.Normal:_.prop(t,"ac");break;case tt.Heavy:_.prop(t,"hac");break;case tt.Tenuto:_.prop(t,"ten");break}if(e.isPalmMute&&_.prop(t,"pm"),e.isStaccato&&_.prop(t,"st"),e.isLetRing&&_.prop(t,"lr"),e.isDead&&_.prop(t,"x"),e.isTieDestination&&_.prop(t,"t"),e.leftHandFinger>=j.Thumb&&_.prop(t,"lf",_.numberValue(e.leftHandFinger+1)),e.rightHandFinger>=j.Thumb&&_.prop(t,"rf",_.numberValue(e.rightHandFinger+1)),e.isVisible||_.prop(t,"hide"),e.isSlurOrigin){const i=`s${e.id}`;_.prop(t,"slur",_.identValue(i))}if(e.isSlurDestination){const i=`s${e.slurOrigin.id}`;_.prop(t,"slur",_.identValue(i))}switch(e.accidentalMode!==re.Default&&_.prop(t,"acc",_.identValue(L.reverseAccidentalModeMapping.get(e.accidentalMode))),e.ornament){case je.InvertedTurn:_.prop(t,"iturn");break;case je.Turn:_.prop(t,"turn");break;case je.UpperMordent:_.prop(t,"umordent");break;case je.LowerMordent:_.prop(t,"lmordent");break}return t}buildBeatEffects(e){const t=[];switch(e.fade){case ut.FadeIn:_.prop(t,"f");break;case ut.FadeOut:_.prop(t,"fo");break;case ut.VolumeSwell:_.prop(t,"vs");break}if(e.vibrato===be.Slight?_.prop(t,"v"):e.vibrato===be.Wide&&_.prop(t,"vw"),e.slap&&_.prop(t,"s"),e.pop&&_.prop(t,"p"),e.tap&&_.prop(t,"tt"),e.dots>=2?_.prop(t,"dd"):e.dots>0&&_.prop(t,"d"),e.pickStroke===kt.Up?_.prop(t,"su"):e.pickStroke===kt.Down&&_.prop(t,"sd"),e.hasTuplet&&_.prop(t,"tu",_.args([_.number(e.tupletNumerator),_.number(e.tupletDenominator)])),e.hasWhammyBar){const n=_.args([_.ident(U.whammyTypeReversed.get(e.whammyBarType)),_.ident(U.bendStyleReversed.get(e.whammyStyle))],!0);for(const o of e.whammyBarPoints)n.arguments.push(_.number(o.offset)),n.arguments.push(_.number(o.value));_.prop(t,"tbe",n)}let s="";switch(e.brushType){case Y.BrushUp:s="bu";break;case Y.BrushDown:s="bd";break;case Y.ArpeggioUp:s="au";break;case Y.ArpeggioDown:s="ad";break}if(s&&_.prop(t,s,_.numberValue(e.brushDuration)),e.chord!=null&&_.prop(t,"ch",_.stringValue(e.chord.name)),e.ottava!==ae.Regular&&_.prop(t,"ot",_.identValue(U.ottaviaReversed.get(e.ottava))),e.hasRasgueado&&_.prop(t,"rasg",_.identValue(U.rasgueadoReversed.get(e.rasgueado))),e.text!=null&&_.prop(t,"txt",_.stringValue(e.text)),e.lyrics!=null&&e.lyrics.length>0)if(e.lyrics.length>1)for(let n=0;n<e.lyrics.length;n++)_.prop(t,"lyrics",_.args([_.number(n),_.string(e.lyrics[n])]));else _.prop(t,"lyrics",_.stringValue(e.lyrics[0]));switch(e.graceType!==$.None&&_.prop(t,"gr",e.graceType===$.BeforeBeat?void 0:_.identValue(U.graceTypeReversed.get(e.graceType))),e.isTremolo&&_.prop(t,"tp",_.numberValue(e.tremoloSpeed)),e.crescendo){case Lt.Crescendo:_.prop(t,"cre");break;case Lt.Decrescendo:_.prop(t,"dec");break}(e.voice.bar.index===0&&e.index===0||e.dynamics!==e.previousBeat?.dynamics)&&_.prop(t,"dy",_.identValue(U.dynamicValueReversed.get(e.dynamics))),e.fermata!=null&&_.prop(t,"fermata",_.args([_.ident(U.fermataTypeReversed.get(e.fermata.type)),_.number(e.fermata.length)])),e.isLegatoOrigin&&_.prop(t,"legatoorigin");for(const n of e.automations)switch(n.type){case De.Tempo:_.prop(t,"tempo",_.args([_.number(n.value),n.text.length===0?void 0:_.string(n.text)]));break;case De.Volume:_.prop(t,"volume",_.numberValue(n.value));break;case De.Instrument:e.voice.bar.staff.isPercussion||_.prop(t,"instrument",_.identValue(Zt.getName(n.value)));break;case De.Balance:_.prop(t,"balance",_.numberValue(n.value));break}switch(e.wahPedal){case Jt.Open:_.prop(t,"waho");break;case Jt.Closed:_.prop(t,"wahc");break}switch(e.isBarre&&_.prop(t,"barre",_.args([_.number(e.barreFret),_.ident(U.barreShapeReversed.get(e.barreShape))])),e.slashed&&_.prop(t,"slashed"),e.deadSlapped&&_.prop(t,"ds"),e.golpe){case Ht.Thumb:_.prop(t,"glpt");break;case Ht.Finger:_.prop(t,"glpf");break}e.invertBeamDirection?_.prop(t,"beam",_.identValue("invert")):e.preferredBeamDirection!==null&&_.prop(t,"beam",_.identValue(P[e.preferredBeamDirection]));let r="";switch(e.beamingMode){case Xe.ForceSplitToNext:r="split";break;case Xe.ForceMergeWithNext:r="merge";break;case Xe.ForceSplitOnSecondaryToNext:r="splitsecondary";break}return r&&_.prop(t,"beam",_.identValue(r)),e.showTimer&&_.prop(t,"timer"),t}}class Ki{data;settings;init(e,t){this.data=e,this.settings=t,Ws.resetIds()}}class ft extends Ve{constructor(e=null,t){super(Oe.Format,e??"Unsupported format",t)}}class pt{_buffer;length=0;position=0;get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return pt.withCapacity(0)}static withCapacity(e){const t=new pt;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){const t=new pt;return t._buffer=e,t.length=e.length,t}static fromString(e){const t=B.stringToBytes(e);return pt.fromBuffer(t)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(e.set(this._buffer.subarray(this.position,this.position+i),t),this.position+=i,i)}writeByte(e){const t=this.position+1;this._ensureCapacity(t),this._buffer[this.position]=e&255,t>this.length&&(this.length=t),this.position=t}write(e,t,s){const i=this.position+s;this._ensureCapacity(i);const r=Math.min(s,e.length-t);this._buffer.set(e.subarray(t,t+r),this.position),i>this.length&&(this.length=i),this.position=i}_ensureCapacity(e){if(e>this._buffer.length){let t=e;t<256&&(t=256),t<this._buffer.length*2&&(t=this._buffer.length*2);const s=new Uint8Array(t);this.length>0&&s.set(this._buffer.subarray(0,0+this.length),0),this._buffer=s}}readAll(){return this.toArray()}toArray(){const e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}}class Fi extends Ve{lexerDiagnostics;parserDiagnostics;semanticDiagnostics;*iterateDiagnostics(){if(this.lexerDiagnostics)for(const e of this.lexerDiagnostics.items)yield e;if(this.parserDiagnostics)for(const e of this.parserDiagnostics.items)yield e;if(this.semanticDiagnostics)for(const e of this.semanticDiagnostics.items)yield e}constructor(e,t,s,i){super(Oe.AlphaTex,e),this.lexerDiagnostics=t,this.parserDiagnostics=s,this.semanticDiagnostics=i}toString(){return[this.message,"lexer diagnostics:",Fi._diagnosticsToString(this.lexerDiagnostics,"  "),"parser diagnostics:",Fi._diagnosticsToString(this.parserDiagnostics,"  "),"semantic diagnostics:",Fi._diagnosticsToString(this.semanticDiagnostics,"  ")].join(`
`)}static _diagnosticsToString(e,t){return e?e.items.map(s=>`${t}${he[s.severity]} AT${s.code.toString().padStart(3,"0")}${Fi._locationToString(s)}: ${s.message}`).join(`
`):`${t}none`}static _locationToString(e){let t="";return e.start&&(t+=`(${e.start.line},${e.start.col})`),e.end&&(t.length>0&&(t+="->"),t+=`(${e.end.line},${e.end.col})`),t}}class $n{trackChannel=0;score;currentTrack;currentStaff;barIndex=0;voiceIndex=0;ignoredInitialVoice=!1;ignoredInitialStaff=!1;ignoredInitialTrack=!1;currentDuration=y.Quarter;articulationValueToIndex=new Map;hasAnyProperData=!1;percussionArticulationNames=new Map;slurs=new Map;lyrics=new Map;sustainPedalToBeat=new Map;staffTuningApplied=new Set;staffNoteKind=new Map;staffHasExplicitTuning=new Set;staffHasExplicitDisplayTransposition=new Set;staffDisplayTranspositionApplied=new Set;staffInitialClef=new Map;syncPoints=[];currentDynamics=Z.F;accidentalMode=Xr.Explicit;currentTupletNumerator=-1;currentTupletDenominator=-1;scoreNode}class Za extends Ki{_parser;_handler=ee.instance;_state=new $n;get state(){return this._state}get scoreNode(){return this._state.scoreNode}get name(){return"AlphaTex"}get lexerDiagnostics(){return this._parser.lexerDiagnostics}get parserDiagnostics(){return this._parser.parserDiagnostics}get parser(){return this._parser}get parseMode(){return this._parser.mode}logErrors=!1;semanticDiagnostics=new Ka;addSemanticDiagnostic(e){this.semanticDiagnostics.push(e)}initFromString(e,t){this.data=pt.empty(),this._parser=new Gn(e),this.settings=t,Ws.resetIds()}readScore(){this._state=new $n,this._createDefaultScore(),this.data.length>0&&(this._parser=new Gn(B.toString(this.data.readAll(),this.settings.importer.encoding)));let e;try{e=this._parser.read(),this._state.scoreNode=e}catch(t){throw this.logErrors&&E.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new ft("Error parsing alphaTex, check inner error for details",t)}if(this._parser.parserDiagnostics.hasErrors||this._parser.lexer.lexerDiagnostics.hasErrors){const t=new Fi("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&E.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),new ft("Error parsing alphaTex, check diagnostics on inner error for details",t)}if(e.bars.length===0)throw new ft("No alphaTex data found");if(this._bars(e),this.semanticDiagnostics.hasErrors)if(this._state.hasAnyProperData){const t=new Fi("There are errors in the parsed alphaTex, check the diagnostics for details",this.lexerDiagnostics,this.parserDiagnostics,this.semanticDiagnostics);throw this.logErrors&&E.error("AlphaTex",`Error while parsing alphaTex: ${t.toString()}`),t}else throw new ft("No alphaTex data found");L.consolidate(this._state.score),this._state.score.finish(this.settings),L.trimEmptyBarsAtEnd(this._state.score),this._state.score.rebuildRepeatGroups(),this._state.score.applyFlatSyncPoints(this._state.syncPoints);for(const[t,s]of this._state.lyrics)this._state.score.tracks[t].applyLyrics(s);for(const[t,s]of this._state.sustainPedalToBeat)if(t.ratioPosition<1){const i=s.voice.bar.masterBar.calculateDuration();t.ratioPosition=s.playbackStart/i}return this._state.score}_createDefaultScore(){this._state.score=new Ws,this._newTrack()}_newTrack(){this._state.currentTrack=new Gs,this._state.currentTrack.ensureStaveCount(1),this._state.currentTrack.playbackInfo.program=25,this._state.currentTrack.playbackInfo.primaryChannel=this._state.trackChannel++,this._state.currentTrack.playbackInfo.secondaryChannel=this._state.trackChannel++;const e=this._state.currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning=A.getDefaultTuningFor(6),this._state.articulationValueToIndex.clear(),this._beginStaff(e),this._state.score.addTrack(this._state.currentTrack),this._state.lyrics.set(this._state.currentTrack.index,[]),this._state.currentDynamics=Z.F,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}_beginStaff(e){this._state.currentStaff&&(this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)),this._state.currentStaff=e,this._state.slurs.clear(),this._state.barIndex=0,this._state.voiceIndex=0}_bars(e){if(e.bars.length>0)for(const t of e.bars)this._bar(t);else this._newBar(this._state.currentStaff),this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff)}_bar(e){const t=this._barMeta(e);this._detectTuningForStaff(this._state.currentStaff),this._handleTransposition(this._state.currentStaff),t.index===0&&this._state.staffInitialClef.has(this._state.currentStaff)&&(t.clef=this._state.staffInitialClef.get(this._state.currentStaff));const s=t.voices[this._state.voiceIndex];for(const i of e.beats)this._beat(s,i);if(s.beats.length===0){const i=new wt;i.isEmpty=!0,s.addBeat(i)}}_beat(e,t){if(t.durationChange&&this._beatDuration(t.durationChange),!t.notes&&!t.rest)return;const s=new wt;if(e.addBeat(s),t.notes)for(const r of t.notes.notes)this._note(s,r);else t.rest;t.durationValue&&(this._state.currentDuration=this._parseDuration(t.durationValue)),s.duration=this._state.currentDuration,s.dynamics=this._state.currentDynamics,this._state.currentTupletNumerator!==-1&&!s.hasTuplet&&(s.tupletNumerator=this._state.currentTupletNumerator,s.tupletDenominator=this._state.currentTupletDenominator);let i=1;t.beatMultiplierValue!==void 0&&(i=t.beatMultiplierValue.value),t.beatEffects&&this._beatEffects(s,t.beatEffects);for(let r=0;r<i-1;r++)e.addBeat(Qa.clone(s))}_beatEffects(e,t){for(const s of t.properties)switch(this._handler.applyBeatProperty(this,e,s)){case k.Applied:case k.NotAppliedSemanticError:this._state.hasAnyProperData=!0;break;case k.NotAppliedUnrecognizedMarker:const r=Array.from(this._handler.knownBeatProperties).join(",");this.addSemanticDiagnostic({code:ue.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${r}`,severity:he.Error,start:s.start,end:s.end});break}}_beatDuration(e){if(e.value&&(this._state.currentDuration=this._parseDuration(e.value)),this._state.currentTupletNumerator=-1,this._state.currentTupletDenominator=-1,e.properties)for(const t of e.properties.properties)switch(this._handler.applyBeatDurationProperty(this,t)){case k.Applied:case k.NotAppliedSemanticError:this._state.hasAnyProperData=!0;break;case k.NotAppliedUnrecognizedMarker:const i=Array.from(this._handler.knownBeatDurationProperties).join(",");this.addSemanticDiagnostic({code:ue.AT212,message:`Unrecogized property '${t.property.text}', expected one of ${i}`,severity:he.Error,start:t.start,end:t.end});break}}_parseDuration(e){switch(e.value){case-4:return y.QuadrupleWhole;case-2:return y.DoubleWhole;case 1:return y.Whole;case 2:return y.Half;case 4:return y.Quarter;case 8:return y.Eighth;case 16:return y.Sixteenth;case 32:return y.ThirtySecond;case 64:return y.SixtyFourth;case 128:return y.OneHundredTwentyEighth;case 256:return y.TwoHundredFiftySixth;default:return this.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected duration value '${e.value}', expected: -4, -2, 1, 2, 4, 8, 16, 32, 64, 128 or 256`,severity:he.Error,start:e.start,end:e.end}),this._state.currentDuration}}_note(e,t){let s=!1,i=!1,r=-1,n=-1,o=-1,l=re.Default;const h=t.noteValue;let c,d=this._state.staffNoteKind.has(this._state.currentStaff)?this._state.staffNoteKind.get(this._state.currentStaff):void 0;switch(h.nodeType){case D.Number:r=h.value,t.noteString!==void 0?c=Gt.Fretted:c=Gt.Articulation;break;case D.String:case D.Ident:const p=h.text;if(s=p==="x",i=p==="-",i||s)r=0,t.noteStringDot&&t.noteString?c=Gt.Fretted:c=void 0;else{const g=L.parseTuning(p);if(g)c=Gt.Pitched,n=g.octave,o=g.tone.noteValue,this._state.accidentalMode===Xr.Explicit&&(l=g.tone.accidentalMode);else{c=Gt.Articulation;const m=p.toLowerCase(),b=this._state.percussionArticulationNames;if(d===void 0&&b.size===0)for(const[S,T]of ht.instrumentArticulationNames)b.set(S.toLowerCase(),T),b.set(L.toArticulationId(S),T);if(b.has(m))r=b.get(m);else{this.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected percussion articulation value '${m}', expected: oneOf(${Array.from(this._state.percussionArticulationNames.keys()).join(",")}).`,severity:he.Error,start:h.start,end:h.end}),r=Array.from(ht.instrumentArticulationNames.values())[0];return}}}break}c!==void 0?d===void 0?(d=c,this.applyStaffNoteKind(this._state.currentStaff,d)):d!==c&&this.addSemanticDiagnostic({code:ue.AT218,message:`Wrong note kind '${Gt[c]}' for staff with note kind ''${Gt[d]}'. Do not mix incompatible staves and notes.`,severity:he.Error,start:h.start,end:h.end}):d!==void 0&&(c=d);const f=new mt;if(f.isDead=s,(s||i)&&(f.fret=r),f.isTieDestination=i,c!==void 0&&c===d)switch(c){case Gt.Pitched:f.octave=n,f.tone=o,f.accidentalMode=l;break;case Gt.Fretted:if(!t.noteString){this.addSemanticDiagnostic({code:ue.AT207,message:"Missing string for fretted note.",severity:he.Error,start:h.end,end:h.end});return}const p=t.noteString.value;if(p<1||p>this._state.currentStaff.tuning.length){this.addSemanticDiagnostic({code:ue.AT208,message:`Note string is out of range. Available range: 1-${this._state.currentStaff.tuning.length}`,severity:he.Error,start:h.end,end:h.end});return}f.string=this._state.currentStaff.tuning.length-(p-1),i||(f.fret=r);break;case Gt.Articulation:let g=0;if(this._state.articulationValueToIndex.has(r))g=this._state.articulationValueToIndex.get(r);else{g=this._state.currentTrack.percussionArticulations.length;const m=ht.getArticulationByInputMidiNumber(r);if(m===null){this.addSemanticDiagnostic({code:ue.AT209,message:`Unexpected articulation value '${r}', expected: oneOf(${Array.from(ht.instrumentArticulations.keys()).join(",")}).`,severity:he.Error,start:h.end,end:h.end});return}this._state.currentTrack.percussionArticulations.push(m),this._state.articulationValueToIndex.set(r,g)}f.percussionArticulation=g;break}e.addNote(f),this._state.hasAnyProperData=!0,t.noteEffects&&this._noteEffects(f,t.noteEffects)}getStaffNoteKind(e){return this._state.staffNoteKind.has(e)?this._state.staffNoteKind.get(e):void 0}applyStaffNoteKind(e,t){switch(this._state.staffNoteKind.set(e,t),t){case Gt.Pitched:e.isPercussion=!1,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break;case Gt.Fretted:e.isPercussion=!1,this._detectTuningForStaff(e),this._handleTransposition(e);break;case Gt.Articulation:e.isPercussion=!0,e.stringTuning.reset(),this._state.staffHasExplicitDisplayTransposition.has(e)||(e.displayTranspositionPitch=0);break}}_noteEffects(e,t){for(const s of t.properties){let i=this._handler.applyNoteProperty(this,e,s);switch(i===k.NotAppliedUnrecognizedMarker&&(i=this._handler.applyBeatProperty(this,e.beat,s)),i){case k.Applied:case k.NotAppliedSemanticError:break;case k.NotAppliedUnrecognizedMarker:const r=Array.from(this._handler.knownNoteProperties).concat(Array.from(this._handler.knownBeatProperties)).join(",");this.addSemanticDiagnostic({code:ue.AT212,message:`Unrecogized property '${s.property.text}', expected one of ${r}`,severity:he.Error,start:s.start,end:s.end});break}}}_handleTransposition(e){if(!this._state.staffDisplayTranspositionApplied.has(e)&&!this._state.staffHasExplicitDisplayTransposition.has(e)){const t=e.track.playbackInfo.program;L.displayTranspositionPitches.has(t)?e.displayTranspositionPitch=L.displayTranspositionPitches.get(t):this._state.currentStaff.displayTranspositionPitch=0,this._state.staffDisplayTranspositionApplied.add(e)}}_detectTuningForStaff(e){const t=e.track.playbackInfo.program;!this._state.staffTuningApplied.has(e)&&!this._state.staffHasExplicitTuning.has(e)&&(e.stringTuning.reset(),t===15||t>=24&&t<=31?e.stringTuning.tunings=A.getDefaultTuningFor(6).tunings:t>=32&&t<=39?(e.stringTuning.tunings=[43,38,33,28],this._state.staffInitialClef.set(e,Te.F4)):t===40||t===44||t===45||t===48||t===49||t===50||t===51?e.stringTuning.tunings=[52,57,50,43]:t===41?e.stringTuning.tunings=[57,50,43,36]:t===42?e.stringTuning.tunings=[45,38,31,24]:t===43?e.stringTuning.tunings=[43,38,33,28]:t===105?e.stringTuning.tunings=[50,47,43,38,55]:t===106?e.stringTuning.tunings=[57,52,45]:t===107?e.stringTuning.tunings=[52,45,38,31]:t===110?e.stringTuning.tunings=[64,57,50,43]:this._state.staffNoteKind.has(e)&&this._state.staffNoteKind.get(e)===Gt.Fretted&&(e.stringTuning=A.getDefaultTuningFor(6)),this._state.staffTuningApplied.add(e))}_barMeta(e){let t=this._state.score.masterBars.length>0?void 0:[],s=this._state.currentStaff,i=!1,r=!1,n=!1;const o=()=>{t&&(t=void 0,s=this._state.currentStaff,i=!1,r=!1,n=!1)},l=new Ji(()=>{const h=this._newBar(this._state.currentStaff);if(t){for(const c of t)this._handler.applyBarMetaData(this,h,c);o()}return h});for(const h of e.metaData){const c=h.tag.tag.text.toLowerCase();if(this._handler.knownStructuralMetaDataTags.has(c)){switch(this._state.hasAnyProperData=!0,this._handler.applyStructuralMetaData(this,h)){case Vs.AppliedNewTrack:r||i?n=!0:(i=!0,s=this._state.currentStaff),l.reset();break;case Vs.AppliedNewStaff:r?n=!0:(r=!0,s=this._state.currentStaff),l.reset();break}if(t&&n)if(s.bars.length===0){const f=new Kt;s.addBar(f);const p=new hs;if(f.addVoice(p),s.bars.length>this._state.score.masterBars.length){const g=new Os;this._state.score.addMasterBar(g)}for(const g of t)this._handler.applyBarMetaData(this,f,g);o()}else throw new Ve(Oe.AlphaTex,"Unexpected internal error, didn't expect a filled staff after multiple \\track and/or \\staff tags. Please report this problem providing the input alphaTex.")}else if(this._handler.knownScoreMetaDataTags.has(h.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyScoreMetaData(this,this._state.score,h);else if(this._handler.knownStaffMetaDataTags.has(h.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,this._handler.applyStaffMetaData(this,this._state.currentStaff,h);else if(this._handler.knownBarMetaDataTags.has(h.tag.tag.text.toLowerCase()))this._state.hasAnyProperData=!0,t?t.push(h):this._handler.applyBarMetaData(this,l.value,h);else{const d=Array.from(this._handler.allKnownMetaDataTags).join(",");this.addSemanticDiagnostic({code:ue.AT204,message:`Unrecognized metadata '${h.tag.tag.text}', expected one of: ${d}`,severity:he.Error,start:h.tag.start,end:h.tag.end})}}return l.value}_newBar(e){if(this._state.barIndex<e.bars.length){const i=e.bars[this._state.barIndex];return this._state.barIndex++,i}const t=e.bars.length===0?1:e.bars[0].voices.length,s=new Kt;e.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this._state.barIndex++,s.index>0&&(s.clef=s.previousBar.clef);for(let i=0;i<t;i++){const r=new hs;s.addVoice(r)}if(this._state.currentStaff.bars.length>this._state.score.masterBars.length){const i=new Os;this._state.score.addMasterBar(i),i.index>0&&(i.timeSignatureDenominator=i.previousMasterBar.timeSignatureDenominator,i.timeSignatureNumerator=i.previousMasterBar.timeSignatureNumerator,i.tripletFeel=i.previousMasterBar.tripletFeel)}return s}startNewStaff(){if(this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff||this._state.currentTrack.staves[0].bars.length>0){const e=this._state.currentStaff.isPercussion;this._state.currentTrack.ensureStaveCount(this._state.currentTrack.staves.length+1);const t=this._state.currentTrack.staves[this._state.currentTrack.staves.length-1];this._beginStaff(t),e&&this.applyPercussionStaff(this._state.currentStaff),this._state.currentDynamics=Z.F}else this._state.ignoredInitialStaff=!0;return this._state.currentStaff}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1,e.track.playbackInfo.program=0}startNewTrack(){return this._state.ignoredInitialVoice=!1,this._state.ignoredInitialStaff=!1,this._state.ignoredInitialTrack||this._state.score.masterBars.length>0?this._newTrack():this._state.ignoredInitialTrack=!0,this._state.currentTrack}startNewVoice(){if(this._state.voiceIndex===0&&(this._state.currentStaff.bars.length===0||this._state.currentStaff.bars.length===1&&this._state.currentStaff.bars[0].isEmpty&&!this._state.ignoredInitialVoice)){this._state.ignoredInitialVoice=!0;return}for(const e of this._state.currentStaff.bars){const t=new hs;e.addVoice(t)}this._state.voiceIndex++,this._state.barIndex=0,this._state.currentTupletDenominator=-1,this._state.currentTupletNumerator=-1}}let ja=class{};class Jr extends ja{n;constructor(e){super(),this.n=e}}class Mi extends ja{left;right;constructor(e,t){super(),this.left=e,this.right=t}}class en extends ja{n;table;constructor(e,t){super(),this.n=e,this.table=t}}class It{static make(e,t,s,i){const r=[],n=[];if(i>32)throw new Ft("Invalid huffman");for(let h=0;h<i;h++)r.push(0),n.push(0);for(let h=0;h<s;h++){const c=e[h+t];if(c>=i)throw new Ft("Invalid huffman");r[c]++}let o=0;for(let h=1;h<i-1;h++)o=o+r[h]<<1,n[h]=o;const l=new Map;for(let h=0;h<s;h++){const c=e[h+t];if(c!==0){const d=n[c-1];n[c-1]=d+1,l.set(d<<5|c,h)}}return It._treeCompress(new Mi(It._treeMake(l,i,0,1),It._treeMake(l,i,1,1)))}static _treeMake(e,t,s,i){if(i>t)throw new Ft("Invalid huffman");const r=s<<5|i;return e.has(r)?new Jr(e.get(r)):(s=s<<1,i+=1,new Mi(It._treeMake(e,t,s,i),It._treeMake(e,t,s|1,i)))}static _treeCompress(e){const t=It._treeDepth(e);if(t===0)return e;if(t===1){if(e instanceof Mi)return new Mi(It._treeCompress(e.left),It._treeCompress(e.right));throw new Ft("assert")}const s=1<<t,i=[];for(let r=0;r<s;r++)i.push(new Jr(-1));return It._treeWalk(i,0,0,t,e),new en(t,i)}static _treeWalk(e,t,s,i,r){r instanceof Mi&&i>0?(It._treeWalk(e,t,s+1,i-1,r.left),It._treeWalk(e,t|1<<s,s+1,i-1,r.right)):e[t]=It._treeCompress(r)}static _treeDepth(e){if(e instanceof Jr)return 0;if(e instanceof en)throw new Ft("assert");if(e instanceof Mi){const t=It._treeDepth(e.left),s=It._treeDepth(e.right);return 1+(t<s?t:s)}return 0}}var Tt;(function(a){a[a.Head=0]="Head",a[a.Block=1]="Block",a[a.CData=2]="CData",a[a.Flat=3]="Flat",a[a.Crc=4]="Crc",a[a.Dist=5]="Dist",a[a.DistOne=6]="DistOne",a[a.Done=7]="Done"})(Tt||(Tt={}));class qs{static _size=32768;static _bufferSize=65536;buffer=new Uint8Array(qs._bufferSize);pos=0;slide(){const e=new Uint8Array(qs._bufferSize);this.pos-=qs._size,e.set(this.buffer.subarray(qs._size,qs._size+this.pos),0),this.buffer=e}addBytes(e,t,s){this.pos+s>qs._bufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+s),this.pos),this.pos+=s}addByte(e){this.pos===qs._bufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}class Ds{static _lenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1];static _lenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];static _distExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1];static _distBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];static _codeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static _fixedHuffman=Ds._buildFixedHuffman();static _buildFixedHuffman(){const e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return It.make(e,0,288,10)}_nbits=0;_bits=0;_state=Tt.Block;_isFinal=!1;_huffman=Ds._fixedHuffman;_huffdist=null;_len=0;_dist=0;_needed=0;_output=null;_outpos=0;_input;_lengths=[];_window=new qs;constructor(e){this._input=e;for(let t=0;t<19;t++)this._lengths.push(-1)}readBytes(e,t,s){if(this._needed=s,this._outpos=t,this._output=e,s>0)for(;this._inflateLoop(););return s-this._needed}_inflateLoop(){switch(this._state){case Tt.Head:const e=this._input.readByte();if((e&15)!==8)throw new Ft("Invalid data");const s=this._input.readByte(),i=(s&32)!==0;if(((e<<8)+s)%31!==0)throw new Ft("Invalid data");if(i)throw new Ft("Unsupported dictionary");return this._state=Tt.Block,!0;case Tt.Crc:return this._state=Tt.Done,!0;case Tt.Done:return!1;case Tt.Block:switch(this._isFinal=this._getBit(),this._getBits(2)){case 0:if(this._len=B.readUInt16LE(this._input),B.readUInt16LE(this._input)!==65535-this._len)throw new Ft("Invalid data");this._state=Tt.Flat;const c=this._inflateLoop();return this._resetBits(),c;case 1:return this._huffman=Ds._fixedHuffman,this._huffdist=null,this._state=Tt.CData,!0;case 2:const d=this._getBits(5)+257,f=this._getBits(5)+1,p=this._getBits(4)+4;for(let m=0;m<p;m++)this._lengths[Ds._codeLengthsPos[m]]=this._getBits(3);for(let m=p;m<19;m++)this._lengths[Ds._codeLengthsPos[m]]=0;this._huffman=It.make(this._lengths,0,19,8);const g=[];for(let m=0;m<d+f;m++)g.push(0);return this._inflateLengths(g,d+f),this._huffdist=It.make(g,d,f,16),this._huffman=It.make(g,0,d,16),this._state=Tt.CData,!0;default:throw new Ft("Invalid data")}case Tt.Flat:{const h=this._len<this._needed?this._len:this._needed,c=B.readByteArray(this._input,h);return this._len-=h,this._addBytes(c,0,h),this._len===0&&(this._state=this._isFinal?Tt.Crc:Tt.Block),this._needed>0}case Tt.DistOne:{const h=this._len<this._needed?this._len:this._needed;return this._addDistOne(h),this._len-=h,this._len===0&&(this._state=Tt.CData),this._needed>0}case Tt.Dist:for(;this._len>0&&this._needed>0;){const h=this._len<this._dist?this._len:this._dist,c=this._needed<h?this._needed:h;this._addDist(this._dist,c),this._len-=c}return this._len===0&&(this._state=Tt.CData),this._needed>0;case Tt.CData:let r=this._applyHuffman(this._huffman);if(r<256)return this._addByte(r),this._needed>0;if(r===256)return this._state=this._isFinal?Tt.Crc:Tt.Block,!0;r=r-257&255;let n=Ds._lenExtraBitsTbl[r];if(n===-1)throw new Ft("Invalid data");this._len=Ds._lenBaseValTbl[r]+this._getBits(n);const o=this._huffdist,l=o?this._applyHuffman(o):this._getRevBits(5);if(n=Ds._distExtraBitsTbl[l],n===-1)throw new Ft("Invalid data");if(this._dist=Ds._distBaseValTbl[l]+this._getBits(n),this._dist>this._window.available())throw new Ft("Invalid data");return this._state=this._dist===1?Tt.DistOne:Tt.Dist,!0}return!1}_addDistOne(e){const t=this._window.getLastChar();for(let s=0;s<e;s++)this._addByte(t)}_addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}_addDist(e,t){this._addBytes(this._window.buffer,this._window.pos-e,t)}_getBit(){this._nbits===0&&(this._nbits=8,this._bits=this._input.readByte());const e=(this._bits&1)===1;return this._nbits--,this._bits=this._bits>>1,e}_getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;const t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}_getRevBits(e){return e===0?0:this._getBit()?1<<e-1|this._getRevBits(e-1):this._getRevBits(e-1)}_resetBits(){this._bits=0,this._nbits=0}_addBytes(e,t,s){this._window.addBytes(e,t,s),this._output.set(e.subarray(t,t+s),this._outpos),this._needed-=s,this._outpos+=s}_inflateLengths(e,t){let s=0,i=0;for(;s<t;){const r=this._applyHuffman(this._huffman);switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=r,e[s]=r,s++;break;case 16:const n=s+3+this._getBits(2);if(n>t)throw new Ft("Invalid data");for(;s<n;)e[s]=i,s++;break;case 17:if(s+=3+this._getBits(3),s>t)throw new Ft("Invalid data");break;case 18:if(s+=11+this._getBits(7),s>t)throw new Ft("Invalid data");break;default:throw new Ft("Invalid data")}}}_applyHuffman(e){if(e instanceof Jr)return e.n;if(e instanceof Mi)return this._applyHuffman(this._getBit()?e.right:e.left);if(e instanceof en)return this._applyHuffman(e.table[this._getBits(e.n)]);throw new Ft("Invalid data")}}class $r{static OptionalDataDescriptorSignature=134695760;static CompressionMethodDeflate=8;static LocalFileHeaderSignature=67324752;static CentralFileHeaderSignature=33639248;static EndOfCentralDirSignature=101010256;fullName;fileName;data;constructor(e,t){this.fullName=e;const s=e.lastIndexOf("/");this.fileName=s===-1||s===e.length-1?this.fullName:e.substr(s+1),this.data=t}}class tn{_readable;constructor(e){this._readable=e}read(){const e=[];for(;;){const t=this._readEntry();if(!t)break;e.push(t)}return e}_readEntry(){const e=this._readable;if(B.readInt32LE(e)!==$r.LocalFileHeaderSignature)return null;B.readUInt16LE(e);const s=B.readUInt16LE(e),i=B.readUInt16LE(e),r=i!==0;if(r&&i!==$r.CompressionMethodDeflate)return null;B.readInt16LE(this._readable),B.readInt16LE(this._readable),B.readInt32LE(e),B.readInt32LE(e);const n=B.readInt32LE(e),o=B.readInt16LE(e),l=B.readInt16LE(e),h=B.toString(B.readByteArray(e,o),"utf-8");e.skip(l);let c;if(r){const d=pt.empty(),f=new Ds(this._readable),p=new Uint8Array(65536);for(;;){const g=f.readBytes(p,0,p.length);if(d.write(p,0,g),g<p.length)break}c=d.toArray()}else c=B.readByteArray(this._readable,n);return(s&8)!==0&&(B.readInt32LE(this._readable)===$r.OptionalDataDescriptorSignature&&B.readInt32LE(this._readable),B.readInt32LE(this._readable),B.readInt32LE(this._readable)),new $r(h,c)}}var et;(function(a){a[a.None=0]="None",a[a.Element=1]="Element",a[a.Text=2]="Text",a[a.CDATA=3]="CDATA",a[a.Document=4]="Document",a[a.DocumentType=5]="DocumentType",a[a.Comment=6]="Comment"})(et||(et={}));class gs{nodeType=et.None;localName=null;value=null;childNodes=[];attributes=new Map;firstChild=null;firstElement=null;*childElements(){for(const e of this.childNodes)e.nodeType===et.Element&&(yield e)}addChild(e){this.childNodes.push(e),this.firstChild=e,(e.nodeType===et.Element||e.nodeType===et.CDATA)&&(this.firstElement=e)}getAttribute(e,t=""){return this.attributes.has(e)?this.attributes.get(e):t}getElementsByTagName(e,t=!1){const s=[];return this._searchElementsByTagName(this.childNodes,s,e,t),s}_searchElementsByTagName(e,t,s,i=!1){for(const r of e)r&&r.nodeType===et.Element&&r.localName===s&&t.push(r),i&&this._searchElementsByTagName(r.childNodes,t,s,!0)}findChildElement(e){for(const t of this.childNodes)if(t&&t.nodeType===et.Element&&t.localName===e)return t;return null}addElement(e){const t=new gs;return t.nodeType=et.Element,t.localName=e,this.addChild(t),t}get innerText(){if(this.nodeType===et.Element||this.nodeType===et.Document){if(this.firstElement&&this.firstElement.nodeType===et.CDATA)return this.firstElement.innerText;let e="";for(const s of this.childNodes)e+=s.innerText?.toString();return e.trim()}return this.value??""}set innerText(e){const t=new gs;t.nodeType=et.Text,t.value=e,this.childNodes=[t]}setCData(e){const t=new gs;t.nodeType=et.CDATA,t.value=e,this.childNodes=[t]}}class ms extends Ve{xml;pos=0;constructor(e,t,s){super(Oe.Format,e),this.xml=t,this.pos=s}}var le;(function(a){a[a.IgnoreSpaces=0]="IgnoreSpaces",a[a.Begin=1]="Begin",a[a.BeginNode=2]="BeginNode",a[a.TagName=3]="TagName",a[a.Body=4]="Body",a[a.AttribName=5]="AttribName",a[a.Equals=6]="Equals",a[a.AttvalBegin=7]="AttvalBegin",a[a.AttribVal=8]="AttribVal",a[a.Childs=9]="Childs",a[a.Close=10]="Close",a[a.WaitEnd=11]="WaitEnd",a[a.WaitEndRet=12]="WaitEndRet",a[a.Pcdata=13]="Pcdata",a[a.Header=14]="Header",a[a.Comment=15]="Comment",a[a.Doctype=16]="Doctype",a[a.Cdata=17]="Cdata",a[a.Escape=18]="Escape"})(le||(le={}));class _e{static CharCodeLF=10;static CharCodeTab=9;static CharCodeCR=13;static CharCodeSpace=32;static CharCodeLowerThan=60;static CharCodeAmp=38;static CharCodeBrackedClose=93;static CharCodeBrackedOpen=91;static CharCodeGreaterThan=62;static CharCodeExclamation=33;static CharCodeUpperD=68;static CharCodeLowerD=100;static CharCodeMinus=45;static CharCodeQuestion=63;static CharCodeSlash=47;static CharCodeEquals=61;static CharCodeDoubleQuote=34;static CharCodeSingleQuote=39;static CharCodeSharp=35;static CharCodeLowerX=120;static CharCodeLowerA=97;static CharCodeLowerZ=122;static CharCodeUpperA=65;static CharCodeUpperZ=90;static CharCode0=48;static CharCode9=57;static CharCodeColon=58;static CharCodeDot=46;static CharCodeUnderscore=95;static CharCodeSemi=59;static _escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);static parse(e,t,s){let i=e.charCodeAt(t),r=le.Begin,n=le.Begin,o=0,l="",h=le.Begin,c=null,d=null,f=0,p=0;for(;t<e.length;){switch(i=e.charCodeAt(t),r){case le.IgnoreSpaces:switch(i){case _e.CharCodeLF:case _e.CharCodeCR:case _e.CharCodeTab:case _e.CharCodeSpace:break;default:r=n;continue}break;case le.Begin:switch(i){case _e.CharCodeLowerThan:r=le.IgnoreSpaces,n=le.BeginNode;break;default:o=t,r=le.Pcdata;continue}break;case le.Pcdata:if(i===_e.CharCodeLowerThan){l+=e.substr(o,t-o);const g=new gs;g.nodeType=et.Text,g.value=l,l="",s.addChild(g),r=le.IgnoreSpaces,n=le.BeginNode}else i===_e.CharCodeAmp&&(l+=e.substr(o,t-o),r=le.Escape,h=le.Pcdata,o=t+1);break;case le.Cdata:if(i===_e.CharCodeBrackedClose&&e.charCodeAt(t+1)===_e.CharCodeBrackedClose&&e.charCodeAt(t+2)===_e.CharCodeGreaterThan){const g=new gs;g.nodeType=et.CDATA,g.value=e.substr(o,t-o),s.addChild(g),t+=2,r=le.Begin}break;case le.BeginNode:switch(i){case _e.CharCodeExclamation:if(e.charCodeAt(t+1)===_e.CharCodeBrackedOpen){if(t+=2,e.substr(t,6).toUpperCase()!=="CDATA[")throw new ms("Expected <![CDATA[",e,t);t+=5,r=le.Cdata,o=t+1}else if(e.charCodeAt(t+1)===_e.CharCodeUpperD||e.charCodeAt(t+1)===_e.CharCodeLowerD){if(e.substr(t+2,6).toUpperCase()!=="OCTYPE")throw new ms("Expected <!DOCTYPE",e,t);t+=8,r=le.Doctype,o=t+1}else{if(e.charCodeAt(t+1)!==_e.CharCodeMinus||e.charCodeAt(t+2)!==_e.CharCodeMinus)throw new ms("Expected <!--",e,t);t+=2,r=le.Comment,o=t+1}break;case _e.CharCodeQuestion:r=le.Header,o=t;break;case _e.CharCodeSlash:if(!s)throw new ms("Expected node name",e,t);o=t+1,r=le.IgnoreSpaces,n=le.Close;break;default:r=le.TagName,o=t;continue}break;case le.TagName:if(!_e._isValidChar(i)){if(t===o)throw new ms("Expected node name",e,t);c=new gs,c.nodeType=et.Element,c.localName=e.substr(o,t-o),s.addChild(c),r=le.IgnoreSpaces,n=le.Body;continue}break;case le.Body:switch(i){case _e.CharCodeSlash:r=le.WaitEnd;break;case _e.CharCodeGreaterThan:r=le.Childs;break;default:r=le.AttribName,o=t;continue}break;case le.AttribName:if(!_e._isValidChar(i)){if(o===t)throw new ms("Expected attribute name",e,t);if(d=e.substr(o,t-o),c.attributes.has(d))throw new ms(`Duplicate attribute [${d}]`,e,t);r=le.IgnoreSpaces,n=le.Equals;continue}break;case le.Equals:switch(i){case _e.CharCodeEquals:r=le.IgnoreSpaces,n=le.AttvalBegin;break;default:throw new ms("Expected =",e,t)}break;case le.AttvalBegin:switch(i){case _e.CharCodeDoubleQuote:case _e.CharCodeSingleQuote:l="",r=le.AttribVal,o=t+1,p=i;break}break;case le.AttribVal:switch(i){case _e.CharCodeAmp:l+=e.substr(o,t-o),r=le.Escape,h=le.AttribVal,o=t+1;break;default:if(i===p){l+=e.substr(o,t-o);const g=l;l="",c.attributes.set(d,g),r=le.IgnoreSpaces,n=le.Body}break}break;case le.Childs:t=_e.parse(e,t,c),o=t,r=le.Begin;break;case le.WaitEnd:switch(i){case _e.CharCodeGreaterThan:r=le.Begin;break;default:throw new ms("Expected >",e,t)}break;case le.WaitEndRet:switch(i){case _e.CharCodeGreaterThan:return t;default:throw new ms("Expected >",e,t)}case le.Close:if(!_e._isValidChar(i)){if(o===t)throw new ms("Expected node name",e,t);if(e.substr(o,t-o)!==s.localName)throw new ms(`Expected </${s.localName}>`,e,t);r=le.IgnoreSpaces,n=le.WaitEndRet;continue}break;case le.Comment:i===_e.CharCodeMinus&&e.charCodeAt(t+1)===_e.CharCodeMinus&&e.charCodeAt(t+2)===_e.CharCodeGreaterThan&&(t+=2,r=le.Begin);break;case le.Doctype:if(i===_e.CharCodeBrackedOpen)f++;else if(i===_e.CharCodeBrackedClose)f--;else if(i===_e.CharCodeGreaterThan&&f===0){const g=new gs;g.nodeType=et.DocumentType,g.value=e.substr(o,t-o),s.addChild(g),r=le.Begin}break;case le.Header:i===_e.CharCodeQuestion&&e.charCodeAt(t+1)===_e.CharCodeGreaterThan&&(t++,r=le.Begin);break;case le.Escape:if(i===_e.CharCodeSemi){const g=e.substr(o,t-o);if(g.charCodeAt(0)===_e.CharCodeSharp){const m=g.charCodeAt(1)===_e.CharCodeLowerX?Number.parseInt(`0${g.substr(1,g.length-1)}`,10):Number.parseInt(g.substr(1,g.length-1),10);l+=String.fromCharCode(m)}else _e._escapes.has(g)?l+=_e._escapes.get(g):l+=`&${g};`?.toString();o=t+1,r=h}else!_e._isValidChar(i)&&i!==_e.CharCodeSharp&&(l+="&",l+=e.substr(o,t-o),t--,o=t+1,r=h);break}t++}if(r===le.Begin&&(o=t,r=le.Pcdata),r===le.Pcdata){if(t!==o){l+=e.substr(o,t-o);const g=new gs;g.nodeType=et.Text,g.value=l,s.addChild(g)}return t}if(r===le.Escape&&h===le.Pcdata){l+="&",l+=e.substr(o,t-o);const g=new gs;return g.nodeType=et.Text,g.value=l,s.addChild(g),t}throw new ms("Unexpected end",e,t)}static _isValidChar(e){return e>=_e.CharCodeLowerA&&e<=_e.CharCodeLowerZ||e>=_e.CharCodeUpperA&&e<=_e.CharCodeUpperZ||e>=_e.CharCode0&&e<=_e.CharCode9||e===_e.CharCodeColon||e===_e.CharCodeDot||e===_e.CharCodeUnderscore||e===_e.CharCodeMinus}}class sn{_result=[];_indention;_xmlHeader;_isStartOfLine;_currentIndention;constructor(e,t){this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case et.None:break;case et.Element:this._result.length>0&&this._writeLine(),this._write(`<${e.localName}`);for(const[t,s]of e.attributes)this._write(` ${t}="`),this._writeAttributeValue(s),this._write('"');if(e.childNodes.length===0)this._write("/>");else{if(this._write(">"),e.childNodes.length===1&&!e.firstElement)this.writeNode(e.childNodes[0]);else{this._indent();for(const t of e.childNodes)(t.nodeType===et.Element||t.nodeType===et.Comment)&&this.writeNode(t);this._unindend(),this._writeLine()}this._write(`</${e.localName}>`)}break;case et.Text:e.value&&this._write(e.value);break;case et.CDATA:e.value!==null&&this._write(`<![CDATA[${e.value}]]>`);break;case et.Document:this._xmlHeader&&this._write('<?xml version="1.0" encoding="utf-8"?>');for(const t of e.childNodes)this.writeNode(t);break;case et.DocumentType:this._write(`<!DOCTYPE ${e.value}>`);break;case et.Comment:this._write(`<!-- ${e.value} -->`);break}}_unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}_indent(){this._currentIndention+=this._indention}_writeAttributeValue(e){for(let t=0;t<e.length;t++){const s=e.charAt(t);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s);break}}}static write(e,t,s){const i=new sn(t,s);return i.writeNode(e),i.toString()}_write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}_writeLine(e=null){e&&this._write(e),this._indention.length>0&&!this._isStartOfLine&&(this._result.push(`
`),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class fr extends gs{constructor(){super(),this.nodeType=et.Document}parse(e){_e.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return sn.write(this,e,t)}}class Qs{noteRange=1;x=0;y=0}var Ai;(function(a){a[a.None=0]="None",a[a.Rectangle=1]="Rectangle",a[a.Ellipse=2]="Ellipse",a[a.Circle=3]="Circle"})(Ai||(Ai={}));class rn extends Qs{align=X.Left;frame=Ai.None;text="";fontFace="";weight=0;height=0}class qn extends Qs{chord=new ui}class Qn extends Qs{}class Kn extends Qs{}class Al extends Qs{number=0}class Zn extends Qs{decrescendo=!1}class an extends Qs{allNumbers=!1;firstNumber=0;lastNumber=0}class Il extends Qs{octave=1}class Rl extends Qs{}class Wl{defaultClef=Te.G2;description="";percussion=!1;instrument=0;volume=0;transpose=0;index=0}class Ol{from=0;to=0;curly=!1}class Vl{currentBarIndex=-1;currentBarComplete=!0;currentBarDuration=0;currentPosition=0;voiceStemDir=null;repeatCount=0;repeatEnd=null}class qr{score;_trackChannel=0;_beamingMode=Xe.Auto;_galleryObjects;_voiceCounts;_isFirstSystem=!0;_initialTempo=-1;parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;const s=new fr;try{s.parse(e)}catch(i){throw new ft("Could not parse XML",i)}this._parseDom(s),this._consolidate(),this.score.finish(t)}_consolidate(){L.consolidate(this.score),qr._applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),qr._applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?Lt.Decrescendo:Lt.Crescendo})}static _applyEffectRange(e,t){for(const[s,i]of e){const r=i.noteRange;let n=s;for(let o=0;o<r;o++)if(t(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else if(n.voice.bar.index+1<n.voice.bar.staff.bars.length)n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0];else break}}_parseDom(e){const t=e.firstElement;if(!t)throw new ft("No valid XML");if(t.localName==="score"){this.score=new Ws;for(const s of t.childElements())switch(s.localName){case"info":this._parseInfo(s);break;case"layout":this._parseLayout(s);break;case"gallery":this._parseGallery(s);break;case"pageObjects":this._parsePageObjects(s);break;case"systems":this._parseSystems(s);break}}else throw new ft('Root node of XML was not "score"')}_staffLookup=new Map;_parseLayout(e){for(const r of e.childElements())switch(r.localName){case"staves":this._parseLayoutStaves(r);break;case"brackets":this._parseBrackets(r);break}const t=this._brackets.filter(r=>!!r.curly);t.sort((r,n)=>r.from-n.from);let s=0,i=null;for(let r=0;r<this._staffLayouts.length;r++){const n=this._staffLayouts[r];for(;s<t.length&&r>t[s].to;)s++;i&&s<t.length&&r>t[s].from&&r<=t[s].to?i.ensureStaveCount(i.staves.length+1):(i=new Gs,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._trackChannel++,i.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(i));const o=i.staves[i.staves.length-1];o.isPercussion=n.percussion,o.transpositionPitch=n.transpose,o.displayTranspositionPitch=0,o.showTablature=!1,this._staffLookup.set(n.index,o)}}_brackets=[];_parseBrackets(e){for(const t of e.childElements())switch(t.localName){case"bracket":this._parseBracket(t);break}}_parseBracket(e){const t=new Ol;t.from=Number.parseInt(e.getAttribute("from"),10),t.to=Number.parseInt(e.getAttribute("to"),10),e.attributes.has("curly")&&(t.curly=e.attributes.get("curly")==="true"),this._brackets.push(t)}_parseLayoutStaves(e){for(const t of e.childElements())switch(t.localName){case"staffLayout":this._parseStaffLayout(t);break}}_staffLayoutLookup=new Map;_staffLayouts=[];_parseStaffLayout(e){const t=new Wl;t.description=e.getAttribute("description");for(const s of e.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(t.defaultClef=this._parseClef(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(t.percussion=s.attributes.get("percussion")==="true"),s.attributes.has("instr")&&(t.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(t.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(t.transpose=Number.parseInt(s.attributes.get("transpose"),10));break}this._staffLayoutLookup.set(t.description,t),t.index=this._staffLayouts.length,this._staffLayouts.push(t)}_parseClef(e){switch(e){case"treble":return Te.G2;case"bass":return Te.F4;case"alto":return Te.C4;case"tenor":return Te.C4}return Te.G2}_parseClefOttava(e){return e.endsWith("-")?ae._8vb:e.endsWith("+")?ae._8va:ae.Regular}_parseSystems(e){for(const t of e.childElements())switch(t.localName){case"system":this._parseSystem(t);break}}_parseSystem(e){e.attributes.has("tempo")&&this.score.masterBars.length===0&&(this._initialTempo=Number.parseInt(e.attributes.get("tempo"),10)),e.getAttribute("beamGrouping")==="0"&&(this._beamingMode=Xe.ForceSplitToNext);for(const t of e.childElements())switch(t.localName){case"staves":this._parseStaves(e,t);break}this._isFirstSystem=!1}_parseStaves(e,t){const s=this.score.masterBars.length;for(const i of t.childElements())switch(i.localName){case"staff":this._parseStaff(e,s,i);break}}_timeSignature=new Os;_currentStaffLayout;_parseStaff(e,t,s){const i=s.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(i),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this._parseTime(s.getAttribute("defaultTime"));const r=this._staffLookup.get(this._currentStaffLayout.index);for(;r.bars.length<t;)this._addNewBar(r);for(const n of s.childElements())switch(n.localName){case"voices":this._parseVoices(i,r,e,t,n);break}}_parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(e.indexOf("/")>0){const t=e.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(t[0],10),this._timeSignature.timeSignatureDenominator=Number.parseInt(t[1],10),this._timeSignature.timeSignatureCommon=!1}break}}_parseVoices(e,t,s,i,r){let n=0;for(const o of r.childElements())switch(o.localName){case"voice":this._parseVoice(e,t,s,n,i,o),n++;break}}_getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this._addNewBar(e)}_addNewBar(e){const t=new Kt;if(e.bars.length>0?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava,t.keySignature=e.bars[e.bars.length-1].keySignature,t.keySignatureType=e.bars[e.bars.length-1].keySignatureType):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length){const s=new Os;this.score.addMasterBar(s),s.index>0?s.tripletFeel=s.previousMasterBar.tripletFeel:this._initialTempo>0&&s.tempoAutomations.push(Ye.buildTempoAutomation(!1,0,this._initialTempo,0)),s.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,s.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,s.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return t}_voiceStates=new Map;_currentVoiceState;_currentBar;_currentVoice;_newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this._getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this._ensureVoice(e,t)}_parseVoice(e,t,s,i,r,n){const o=`${e}_${i}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(o)?(this._currentVoiceState=this._voiceStates.get(o),this._currentBar=this._getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this._ensureVoice(t,i)):(this._currentVoiceState=new Vl,this._currentVoiceState.currentBarIndex=r-1,this._voiceStates.set(o,this._currentVoiceState),this._newBar(t,i)),n.attributes.has("stemDir"))switch(n.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=P.Up;break;case"down":this._currentVoiceState.voiceStemDir=P.Down;break;default:this._currentVoiceState.voiceStemDir=null;break}else this._currentVoiceState.voiceStemDir=null;const l=n.findChildElement("noteObjects");if(s.attributes.has("tempo")){const h=new Ye;h.isLinear=!0,h.type=De.Tempo,h.value=Number.parseInt(s.attributes.get("tempo"),10),h.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(h)}if(l)for(const h of l.childElements())switch(this._currentVoiceState.currentBarComplete&&h.localName!=="barline"&&this._newBar(t,i),h.localName){case"clefSign":this._currentBar.clef=this._parseClef(h.getAttribute("clef")),this._currentBar.clefOttava=this._parseClefOttava(h.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(h.getAttribute("fifths"),10);break;case"timeSign":this._parseTime(h.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(h.getAttribute("type")){case"double":this._currentBar.barLineRight=ce.LightLight,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(h),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this._parseBarDrawObject(h),this._newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0;break;case"dashed":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break}break;case"chord":const c=new wt;this._initFromPreviousBeat(c,this._currentVoice),c.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(c.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this._parseDuration(c,h.findChildElement("duration")),c.updateDurations(),this._currentVoiceState.currentPosition+=c.playbackDuration,this._currentVoice.addBeat(c),this._parseChord(c,h),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":const d=this._parseRestDurations(h.findChildElement("duration"));d&&(this._initFromPreviousBeat(d,this._currentVoice),d.updateDurations(),this._currentVoiceState.currentPosition+=d.playbackDuration,this._currentVoice.addBeat(d),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0));break}}_initFromPreviousBeat(e,t){const s=this._getLastBeat(t);s&&(e.dynamics=s.dynamics)}_getLastBeat(e){if(e.beats.length>0)return e.beats[e.beats.length-1];if(e.bar.index>0){const t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length){const s=t.voices[e.index];return this._getLastBeat(s)}}return null}_ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new hs);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}_parseChord(e,t){const s=new mt;for(const i of t.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":e.preferredBeamDirection=P.Up;break;case"down":e.preferredBeamDirection=P.Down;break}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=tt.Normal;break;case"strongAccent":s.accentuated=tt.Heavy;break}break;case"lyric":this._parseLyric(e,i);break;case"drawObjects":this._parseBeatDrawObject(e,i);break;case"heads":this._parseHeads(e,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":e.beamingMode=Xe.ForceMergeWithNext;break;case"divide":e.beamingMode=Xe.ForceSplitToNext;break}break}}_parseHeads(e,t,s){for(const i of s.childElements())switch(i.localName){case"head":this._parseHead(e,t,i);break}}_tieStarts;_tieStartIds;_slurs;_crescendo;_parseHead(e,t,s){const i=new mt,r=L.parseTuning(s.getAttribute("pitch"));i.octave=r.octave-1,i.tone=r.tone.noteValue,i.isStaccato=t.isStaccato,i.accentuated=t.accentuated,e.addNote(i);for(const n of s.childElements())switch(n.localName){case"alter":n.attributes.has("step")&&(i.tone+=Number.parseInt(n.attributes.get("step"),10));break;case"tie":n.attributes.has("begin")?this._tieStartIds.has(i.id)||(this._tieStartIds.set(i.id,!0),this._tieStarts.push(i)):n.attributes.has("end")&&this._tieStarts.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(i.id));break}}_parseBeatDrawObject(e,t){for(const s of t.childElements())switch(s.localName){case"drawObj":const i=this._parseDrawObj(s);if(i){if(i instanceof rn)i.fontFace.startsWith("capella")?i.text==="u"?(e.fermata=new hr,e.fermata.type=jt.Medium):i.text==="f"?e.dynamics=Z.F:i.text==="j"&&(e.dynamics=Z.MF):this._isFirstSystem&&this.score.title===""&&i.align===X.Center&&i.height>16&&i.weight>400?this.score.title=i.text:this._isFirstSystem&&this.score.artist===""&&i.align===X.Center&&i.y<0?this.score.artist=i.text:this._isFirstSystem&&this.score.music===""&&i.align===X.Right&&i.y<0?this.score.music=i.text:i.text.startsWith("by capella")||(e.text=i.text);else if(!(i instanceof qn))if(i instanceof Kn)e.vibrato=be.Slight;else if(i instanceof Zn)e.crescendo=i.decrescendo?Lt.Decrescendo:Lt.Crescendo,i.noteRange++,this._crescendo.set(e,i);else if(i instanceof Qn){const r=i;this._slurs.set(e,r)}else i instanceof an&&this._applyVolta(i)}break}}_parseBarDrawObject(e){for(const t of e.childElements())switch(t.localName){case"drawObj":const s=this._parseDrawObj(t);s&&s instanceof an&&this._applyVolta(s);break}}_applyVolta(e){if(e.lastNumber>0?(this._currentVoiceState.repeatCount=e.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):e.firstNumber>0&&(this._currentVoiceState.repeatCount=e.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),e.lastNumber>0&&e.firstNumber>0){let t=0;for(let s=e.firstNumber;s<=e.lastNumber;s++)t=t|1<<s-1;this._currentBar.masterBar.alternateEndings=t}else e.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<e.lastNumber-1:e.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<e.firstNumber-1)}_parseLyric(e,t){for(const s of t.childElements())switch(s.localName){case"verse":e.lyrics||(e.lyrics=[]);let i=s.innerText;s.getAttribute("hyphen")==="true"&&(i+="-"),e.lyrics.push(i);break}}_parseRestDurations(e){const t=e.getAttribute("base");if(t.indexOf("/")!==-1){const i=new wt;return i.beamingMode=this._beamingMode,this._parseDuration(i,e),i}if(Number.parseInt(t,10)===1){const i=new wt;return i.beamingMode=this._beamingMode,i.duration=y.Whole,i}return E.warning("Importer","Multi-Bar rests are not supported"),null}_parseDurationValue(e){switch(e){case"2/1":return y.DoubleWhole;case"1/1":return y.Whole;case"1/2":return y.Half;case"1/4":return y.Quarter;case"1/8":return y.Eighth;case"1/16":return y.Sixteenth;case"1/32":return y.ThirtySecond;case"1/64":return y.SixtyFourth;case"1/128":return y.OneHundredTwentyEighth;default:return E.warning("Importer","Unsupported duration"),y.Quarter}}_parseDuration(e,t){const s=t.getAttribute("base");e.duration=this._parseDurationValue(s),t.attributes.has("dots")&&(e.dots=Number.parseInt(t.attributes.get("dots"),10));const i=t.findChildElement("tuplet");if(i){e.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const r=i.getAttribute("tripartite")==="true"?3:1,n=i.getAttribute("prolong")==="true"?0:1;let o=0;for(;r*Math.pow(2,o+n)<e.tupletNumerator;)o++;e.tupletDenominator=r*Math.pow(2,o)}}_parsePageObjects(e){for(const t of e.childElements())switch(t.localName){case"drawObj":const s=this._parseDrawObj(t);if(s&&s instanceof rn)switch(s.align){case X.Center:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case X.Right:this.score.artist||(this.score.artist=t.innerText);break}break}}_parseGallery(e){for(const t of e.childElements())switch(t.localName){case"drawObj":const s=this._parseDrawObj(t);s&&this._galleryObjects.set(t.getAttribute("name"),s);break}}_parseDrawObj(e){let t=null,s=1;for(const i of e.childElements())switch(i.localName){case"text":t=this._parseText(i);break;case"guitar":t=this._parseGuitar(i);break;case"slur":t=this._parseSlur(i);break;case"wavyLine":t=this._parseWavyLine(i);break;case"bracket":t=this._parseTupletBracket(i);break;case"wedge":t=this._parseWedge(i);break;case"volta":t=this._parseVolta(i);break;case"octaveClef":t=this._parseOctaveClef(i);break;case"trill":t=this._parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10));break}return t&&(t.noteRange=s),t}_parseTrill(e){return new Rl}_parseOctaveClef(e){const t=new Il;return e.attributes.has("octave")&&(t.octave=Number.parseInt(e.attributes.get("octave"),10)),t}_parseVolta(e){const t=new an;return t.allNumbers=e.attributes.get("allNumbers")==="true",e.attributes.has("firstNumber")&&(t.firstNumber=Number.parseInt(e.attributes.get("firstNumber"),10)),e.attributes.has("lastNumber")&&(t.lastNumber=Number.parseInt(e.attributes.get("lastNumber"),10)),t}_parseWedge(e){const t=new Zn;return t.decrescendo=e.attributes.get("decrescendo")==="true",t}_parseTupletBracket(e){const t=new Al;return e.attributes.has("number")&&(t.number=Number.parseInt(e.attributes.get("number"),10)),t}_parseWavyLine(e){return new Kn}_parseSlur(e){return new Qn}_parseGuitar(e){const t=new qn,s=e.innerText.trim();for(let i=0;i<s.length;i++)s.charAt(i)==="/"?t.chord.strings.push(0):t.chord.strings.push(Number.parseInt(s.charAt(i),10));return t}_parseText(e){const t=new rn;switch(e.attributes.has("x")&&(t.x=Number.parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=Number.parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=X.Left;break;case"center":t.align=X.Center;break;case"right":t.align=X.Right;break}switch(e.getAttribute("frame")){case"rectangle":t.frame=Ai.Rectangle;break;case"ellipse":t.frame=Ai.Ellipse;break;case"circle":t.frame=Ai.Circle;break;case"none":t.frame=Ai.None;break}if(e.firstElement)for(const s of e.childElements())switch(s.localName){case"font":t.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(t.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(t.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":t.text=s.innerText;break}else t.text=e.innerText;return t}_parseInfo(e){for(const t of e.childElements())switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText;break}}}class Hl extends Ki{get name(){return"Capella"}readScore(){E.debug(this.name,"Loading ZIP entries");const e=new tn(this.data);let t,s=null;if(t=e.read(),E.debug(this.name,"Zip entries loaded"),t.length>0)for(const i of t)switch(i.fileName){case"score.xml":s=B.toString(i.data,this.settings.importer.encoding);break}else this.data.reset(),s=B.toString(this.data.readAll(),this.settings.importer.encoding);if(!s)throw new ft("No valid capella file");E.debug(this.name,"Start Parsing score.xml");try{const i=new qr;return i.parseXml(s,this.settings),E.debug(this.name,"score.xml parsed"),i.score}catch(i){throw new ft("Failed to parse CapXML",i)}}}var z;(function(a){a[a.TargetFine=0]="TargetFine",a[a.TargetSegno=1]="TargetSegno",a[a.TargetSegnoSegno=2]="TargetSegnoSegno",a[a.TargetCoda=3]="TargetCoda",a[a.TargetDoubleCoda=4]="TargetDoubleCoda",a[a.JumpDaCapo=5]="JumpDaCapo",a[a.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",a[a.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",a[a.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",a[a.JumpDalSegno=9]="JumpDalSegno",a[a.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",a[a.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",a[a.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",a[a.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",a[a.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",a[a.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",a[a.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",a[a.JumpDaCoda=17]="JumpDaCoda",a[a.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"})(z||(z={}));class pi extends Ki{static _versionString="FICHIER GUITAR PRO ";_versionNumber=0;_score;_globalTripletFeel=Be.NoTripletFeel;_lyricsTrack=0;_lyrics=[];_barCount=0;_trackCount=0;_playbackInfos=[];_doubleBars=new Set;_clefsPerTrack=new Map;_keySignatures=new Map;_beatTextChunksByTrack=new Map;_directionLookup=new Map;_initialTempo;get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new Ws,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Ee.gpReadBool(this.data)?Be.Triplet8th:Be.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._initialTempo=Ye.buildTempoAutomation(!1,0,0,0),this._versionNumber>=500&&(this.readPageSetup(),this._initialTempo.text=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._initialTempo.value=B.readInt32LE(this.data),this._versionNumber>=510&&Ee.gpReadBool(this.data),B.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this._readDirection(z.TargetCoda),this._readDirection(z.TargetDoubleCoda),this._readDirection(z.TargetSegno),this._readDirection(z.TargetSegnoSegno),this._readDirection(z.TargetFine),this._readDirection(z.JumpDaCapo),this._readDirection(z.JumpDaCapoAlCoda),this._readDirection(z.JumpDaCapoAlDoubleCoda),this._readDirection(z.JumpDaCapoAlFine),this._readDirection(z.JumpDalSegno),this._readDirection(z.JumpDalSegnoAlCoda),this._readDirection(z.JumpDalSegnoAlDoubleCoda),this._readDirection(z.JumpDalSegnoAlFine),this._readDirection(z.JumpDalSegnoSegno),this._readDirection(z.JumpDalSegnoSegnoAlCoda),this._readDirection(z.JumpDalSegnoSegnoAlDoubleCoda),this._readDirection(z.JumpDalSegnoSegnoAlFine),this._readDirection(z.JumpDaCoda),this._readDirection(z.JumpDaDoubleCoda),this.data.skip(4)),this._barCount=B.readInt32LE(this.data),this._trackCount=B.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){const e=Ye.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return L.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}_readDirection(e){let t=B.readInt16LE(this.data);if(t===-1)return;t--;let s;this._directionLookup.has(t)?s=this._directionLookup.get(t):(s=[],this._directionLookup.set(t,s)),s.push(e)}readVersion(){let e=Ee.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(pi._versionString))throw new ft("Unsupported format");e=e.substr(pi._versionString.length+1);const t=e.indexOf(".");this._versionNumber=100*Number.parseInt(e.substr(0,t),10)+Number.parseInt(e.substr(t+1),10),E.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){this._score.title=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const e=B.readInt32LE(this.data);let t="";for(let s=0;s<e;s++)s>0&&(t+=`\r
`),t+=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=t}readLyrics(){this._lyrics=[],this._lyricsTrack=B.readInt32LE(this.data)-1;for(let e=0;e<5;e++){const t=new $t;t.startBar=B.readInt32LE(this.data)-1,t.text=Ee.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(t)}}readPageSetup(){this.data.skip(28);const e=B.readInt16LE(this.data);L.getOrCreateHeaderFooterStyle(this._score,O.Title).isVisible=(e&1)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Title).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.SubTitle).isVisible=(e&2)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.SubTitle).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.Artist).isVisible=(e&4)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Artist).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.Album).isVisible=(e&8)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Album).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.Words).isVisible=(e&16)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Words).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.Music).isVisible=(e&32)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Music).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.WordsAndMusic).isVisible=(e&64)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.WordsAndMusic).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.Copyright).isVisible=(e&128)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.Copyright).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),L.getOrCreateHeaderFooterStyle(this._score,O.CopyrightSecondLine).isVisible=(e&128)!==0,L.getOrCreateHeaderFooterStyle(this._score,O.CopyrightSecondLine).template=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let t=0;t<64;t++){const s=new Un;s.primaryChannel=e++,s.secondaryChannel=e++,s.program=B.readInt32LE(this.data),s.volume=this.data.readByte(),s.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(s)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);const t=new Os;!e&&this._initialTempo.value>0&&t.tempoAutomations.push(this._initialTempo);const s=this.data.readByte();if((s&1)!==0?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),(s&2)!==0?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=(s&4)!==0,(s&8)!==0&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),(s&16)!==0&&this._versionNumber<500){let n=e,o=0;for(;n&&!(n.isRepeatEnd&&n!==e||n.isRepeatStart);)o=o|n.alternateEndings,n=n.previousMasterBar;let l=0;const h=this.data.readByte();for(let c=0;c<8;c++){const d=1<<c;h>c&&(o&d)===0&&(l=l|d)}t.alternateEndings=l}if((s&32)!==0){const n=new cr;n.text=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),n.marker="",Ee.gpReadColor(this.data,!1),t.section=n}if((s&64)!==0&&this._keySignatures.set(this._score.masterBars.length,[B.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&(s&3)!==0&&this.data.skip(4),this._versionNumber>=500&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=Be.Triplet8th;break;case 2:t.tripletFeel=Be.Triplet16th;break}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;const i=(s&128)!==0;t.isDoubleBar=i;const r=this._score.masterBars.length;if(this._directionLookup.has(r))for(const n of this._directionLookup.get(r))t.addDirection(n);this._score.addMasterBar(t),i&&this._doubleBars.add(t.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){const e=new Gs;e.ensureStaveCount(1),this._score.addTrack(e);const t=e.staves[0],s=this.data.readByte();e.name=Ee.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),(s&1)!==0&&(t.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=(s&8)!==0),this._score.stylesheet.perTrackDisplayTuning===null&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,(s&128)!==0);const i=B.readInt32LE(this.data),r=[];for(let h=0;h<7;h++){const c=B.readInt32LE(this.data);i>h&&r.push(c)}t.stringTuning.tunings=r;const n=B.readInt32LE(this.data),o=B.readInt32LE(this.data)-1,l=B.readInt32LE(this.data)-1;if(this.data.skip(4),o>=0&&o<this._playbackInfos.length){const h=this._playbackInfos[o];h.port=n,h.isSolo=(s&16)!==0,h.isMute=(s&32)!==0,h.secondaryChannel=l,Zt.isGuitar(h.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=h}if(t.capo=B.readInt32LE(this.data),e.color=Ee.gpReadColor(this.data,!1),this._versionNumber>=500){const h=this.data.readByte();t.showTablature=(h&1)!==0,t.showStandardNotation=(h&2)!==0;const c=(h&100)!==0;this._score.stylesheet.perTrackChordDiagramsOnTop===null&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,c),this.data.readByte(),this.data.readByte(),e.playbackInfo.bank=this.data.readByte(),this.data.readByte(),B.readInt32LE(this.data)===12?this._clefsPerTrack.set(o,Te.F4):this._clefsPerTrack.set(o,Te.G2),B.readInt32LE(this.data),B.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this._readRseBank(),this._versionNumber>=510&&(this.data.skip(4),Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else Zt.isBass(e.playbackInfo.program)?this._clefsPerTrack.set(o,Te.F4):this._clefsPerTrack.set(o,Te.G2)}readBars(){for(let e=0;e<this._barCount;e++)for(let t=0;t<this._trackCount;t++)this.readBar(this._score.tracks[t])}readBar(e){const t=new Kt,s=e.staves[0];if(s.isPercussion?t.clef=Te.Neutral:this._clefsPerTrack.has(e.index)&&(t.clef=this._clefsPerTrack.get(e.index)),s.addBar(t),this._keySignatures.has(t.index)){const r=this._keySignatures.get(t.index);t.keySignature=r[0],t.keySignatureType=r[1]}else t.index>0&&(t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);this._doubleBars.has(t.index)&&(t.barLineRight=ce.LightLight);let i=1;this._versionNumber>=500&&(this.data.readByte(),i=2);for(let r=0;r<i;r++)this.readVoice(e,t)}readVoice(e,t){const s=B.readInt32LE(this.data);if(s===0)return;const i=new hs;t.addVoice(i);for(let r=0;r<s;r++)this.readBeat(e,t,i)}readBeat(e,t,s){const i=new wt,r=this.data.readByte();if((r&1)!==0&&(i.dots=1),(r&64)!==0){const c=this.data.readByte();i.isEmpty=(c&2)===0}switch(s.addBeat(i),B.readSInt8(this.data)){case-2:i.duration=y.Whole;break;case-1:i.duration=y.Half;break;case 0:i.duration=y.Quarter;break;case 1:i.duration=y.Eighth;break;case 2:i.duration=y.Sixteenth;break;case 3:i.duration=y.ThirtySecond;break;case 4:i.duration=y.SixtyFourth;break;default:i.duration=y.Quarter;break}if((r&32)!==0)switch(i.tupletNumerator=B.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1;break}(r&2)!==0&&this.readChord(i);const o=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if((r&4)!==0){const c=Ee.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(o){const d=new $t;d.text=c.trim(),d.finish(!0);const f=[];for(let p=d.chunks.length-1;p>=0;p--)f.push(d.chunks[p]);this._beatTextChunksByTrack.set(e.index,f)}else i.text=c}let l=Q.None;(r&8)!==0&&(l=this.readBeatEffects(i)),(r&16)!==0&&this.readMixTableChange(i);const h=this.data.readByte();for(let c=6;c>=0;c--)if((h&1<<c)!==0&&6-c<t.staff.tuning.length){const d=this.readNote(e,t,s,i,6-c);l!==Q.None&&(d.harmonicType=l,d.harmonicType===Q.Natural&&(d.harmonicValue=L.deltaFretToHarmonicValue(d.fret)))}if(this._versionNumber>=500){const c=B.readInt16LE(this.data);if((c&1)!==0&&i.index>0&&(s.beats[i.index-1].beamingMode=Xe.ForceSplitToNext),(c&2)!==0&&(i.preferredBeamDirection=P.Down),(c&4)!==0&&i.index>0&&(s.beats[i.index-1].beamingMode=Xe.ForceMergeWithNext),(c&8)!==0&&(i.preferredBeamDirection=P.Up),(c&16)!==0&&(i.ottava=ae._8va),(c&32)!==0&&(i.ottava=ae._8vb),(c&64)!==0&&(i.ottava=ae._15ma),(c&256)!==0&&(i.ottava=ae._15mb),(c&2048)!==0){const d=this.data.readByte()!==0;i.index>0&&d&&(s.beats[i.index-1].beamingMode=Xe.ForceSplitOnSecondaryToNext)}}o&&!i.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(i.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){const t=new ui,s=L.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=Ee.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=B.readInt32LE(this.data);for(let n=0;n<7;n++){const o=B.readInt32LE(this.data);n<e.voice.bar.staff.tuning.length&&t.strings.push(o)}const i=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let n=0;n<i;n++)t.barreFrets.push(r[n]);this.data.skip(26)}else if(this.data.readByte()!==0)if(this._versionNumber>=400){this.data.skip(16),t.name=Ee.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=B.readInt32LE(this.data);for(let n=0;n<7;n++){const o=B.readInt32LE(this.data);n<e.voice.bar.staff.tuning.length&&t.strings.push(o)}const i=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let n=0;n<i;n++)t.barreFrets.push(r[n]);this.data.skip(26)}else{this.data.skip(25),t.name=Ee.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=B.readInt32LE(this.data);for(let i=0;i<6;i++){const r=B.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(r)}this.data.skip(36)}else{const i=this._versionNumber>=406?7:6;if(t.name=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=B.readInt32LE(this.data),t.firstFret>0)for(let r=0;r<i;r++){const n=B.readInt32LE(this.data);r<e.voice.bar.staff.tuning.length&&t.strings.push(n)}}t.name&&(e.chordId=s,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(e){const t=this.data.readByte();let s=0;if(this._versionNumber>=400&&(s=this.data.readByte()),(t&16)!==0&&(e.fade=ut.FadeIn),(this._versionNumber<400&&(t&1)!==0||(t&2)!==0)&&(e.vibrato=be.Slight),(s&1)!==0&&(e.rasgueado=ie.Ii),(t&32)!==0&&this._versionNumber>=400)switch(B.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}else if((t&32)!==0){switch(B.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0;break}this.data.skip(4)}if((s&4)!==0&&this.readTremoloBarEffect(e),(t&64)!==0){let i=0,r=0;this._versionNumber<500?(r=this.data.readByte(),i=this.data.readByte()):(i=this.data.readByte(),r=this.data.readByte()),i>0?(e.brushType=Y.BrushUp,e.brushDuration=pi._toStrokeValue(i)):r>0&&(e.brushType=Y.BrushDown,e.brushDuration=pi._toStrokeValue(r))}if((s&2)!==0)switch(B.readSInt8(this.data)){case 0:e.pickStroke=kt.None;break;case 1:e.pickStroke=kt.Up;break;case 2:e.pickStroke=kt.Down;break}if(this._versionNumber<400){if((t&4)!==0)return Q.Natural;if((t&8)!==0)return Q.Artificial}return Q.None}readTremoloBarEffect(e){this.data.readByte(),B.readInt32LE(this.data);const t=B.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){const i=new H(0,0);i.offset=B.readInt32LE(this.data),i.value=B.readInt32LE(this.data)/pi._bendStep|0,Ee.gpReadBool(this.data),e.addWhammyBarPoint(i)}}static _toStrokeValue(e){switch(e){case 1:return 30;case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}_readRseBank(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(e){const t=new Gl;t.instrument=B.readSInt8(this.data),this._versionNumber>=500&&this._readRseBank(),t.volume=B.readSInt8(this.data),t.balance=B.readSInt8(this.data);const s=B.readSInt8(this.data),i=B.readSInt8(this.data),r=B.readSInt8(this.data),n=B.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=B.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),r>=0&&this.data.readByte(),n>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=B.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){const o=B.readSInt8(this.data);o>=100?e.wahPedal=Jt.Closed:o>=0&&(e.wahPedal=Jt.Open)}if(this._versionNumber>=510&&(Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ee.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){const o=new Ye;o.isLinear=!0,o.type=De.Volume,o.value=t.volume,e.automations.push(o)}if(t.balance>=0){const o=new Ye;o.isLinear=!0,o.type=De.Balance,o.value=t.balance,e.automations.push(o)}if(t.instrument>=0){const o=new Ye;o.isLinear=!0,o.type=De.Instrument,o.value=t.instrument,e.automations.push(o)}if(t.tempo>=0){const o=new Ye;o.isLinear=!0,o.type=De.Tempo,o.value=t.tempo,e.automations.push(o),e.voice.bar.masterBar.tempoAutomations.some(l=>l.ratioPosition===o.ratioPosition&&l.value===o.value)||e.voice.bar.masterBar.tempoAutomations.push(o)}}readNote(e,t,s,i,r){const n=new mt;n.string=t.staff.tuning.length-r;const o=this.data.readByte();if((o&2)!==0?n.accentuated=tt.Heavy:(o&64)!==0&&(n.accentuated=tt.Normal),n.isGhost=(o&4)!==0,(o&32)!==0){const h=this.data.readByte();h===3?n.isDead=!0:h===2&&(n.isTieDestination=!0)}if((o&1)!==0&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),(o&16)!==0){const h=B.readSInt8(this.data);n.dynamics=this.toDynamicValue(h),i.dynamics=n.dynamics}(o&32)!==0&&(n.fret=B.readSInt8(this.data)),(o&128)!==0&&(n.leftHandFinger=B.readSInt8(this.data),n.rightHandFinger=B.readSInt8(this.data));let l=!1;if(this._versionNumber>=500&&((o&1)!==0&&(n.durationPercent=B.readFloat64BE(this.data)),l=(this.data.readByte()&2)!==0),i.addNote(n),(o&8)!==0&&this.readNoteEffects(e,s,i,n),t.staff.isPercussion&&(n.percussionArticulation=n.fret,n.string=-1,n.fret=-1),l){const h=L.computeAccidental(t.keySignature,re.Default,n.realValueWithoutHarmonic,!1);h===K.Sharp?n.accidentalMode=re.ForceFlat:h===K.Flat&&(n.accidentalMode=re.ForceSharp)}return n}toDynamicValue(e){switch(e){case 1:return Z.PPP;case 2:return Z.PP;case 3:return Z.P;case 4:return Z.MP;case 5:return Z.MF;case 6:return Z.F;case 7:return Z.FF;case 8:return Z.FFF;default:return Z.F}}readNoteEffects(e,t,s,i){const r=this.data.readByte();let n=0;this._versionNumber>=400&&(n=this.data.readByte()),(r&1)!==0&&this.readBend(i),(r&16)!==0&&this.readGrace(t,i),(n&4)!==0&&this.readTremoloPicking(s),(n&8)!==0?this.readSlide(i):this._versionNumber<400&&(r&4)!==0&&(i.slideOutType=ne.Shift),(n&16)!==0&&this.readArtificialHarmonic(i),(n&32)!==0&&this.readTrill(i),i.isLetRing=(r&8)!==0,i.isHammerPullOrigin=(r&2)!==0,(n&64)!==0&&(i.vibrato=be.Slight),i.isPalmMute=(n&2)!==0,i.isStaccato=(n&1)!==0}static _bendStep=25;readBend(e){this.data.readByte(),B.readInt32LE(this.data);const t=B.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){const i=new H(0,0);i.offset=B.readInt32LE(this.data),i.value=B.readInt32LE(this.data)/pi._bendStep|0,Ee.gpReadBool(this.data),e.addBendPoint(i)}}readGrace(e,t){const s=new wt,i=new mt;switch(i.string=t.string,i.fret=B.readSInt8(this.data),s.duration=y.ThirtySecond,s.dynamics=this.toDynamicValue(B.readSInt8(this.data)),B.readSInt8(this.data)){case 0:break;case 1:i.slideOutType=ne.Legato,i.slideTarget=t;break;case 2:break;case 3:i.isHammerPullOrigin=!0;break}if(i.dynamics=s.dynamics,this.data.skip(1),this._versionNumber<500)s.graceType=$.BeforeBeat;else{const n=this.data.readByte();i.isDead=(n&1)!==0,s.graceType=(n&2)!==0?$.OnBeat:$.BeforeBeat}e.addGraceBeat(s),s.addNote(i)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=y.Eighth;break;case 2:e.tremoloSpeed=y.Sixteenth;break;case 3:e.tremoloSpeed=y.ThirtySecond;break}}readSlide(e){if(this._versionNumber>=500){const t=B.readSInt8(this.data);(t&1)!==0?e.slideOutType=ne.Shift:(t&2)!==0?e.slideOutType=ne.Legato:(t&4)!==0?e.slideOutType=ne.OutDown:(t&8)!==0&&(e.slideOutType=ne.OutUp),(t&16)!==0?e.slideInType=dt.IntoFromBelow:(t&32)!==0&&(e.slideInType=dt.IntoFromAbove)}else switch(B.readSInt8(this.data)){case 1:e.slideOutType=ne.Shift;break;case 2:e.slideOutType=ne.Legato;break;case 3:e.slideOutType=ne.OutDown;break;case 4:e.slideOutType=ne.OutUp;break;case-1:e.slideInType=dt.IntoFromBelow;break;case-2:e.slideInType=dt.IntoFromAbove;break}}readArtificialHarmonic(e){const t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=Q.Natural,e.harmonicValue=L.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=Q.Artificial;break;case 3:e.harmonicType=Q.Tap,e.harmonicValue=L.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=Q.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=Q.Semi,e.harmonicValue=12;break}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=Q.Natural;break;case 3:e.harmonicType=Q.Tap;break;case 4:e.harmonicType=Q.Pinch;break;case 5:e.harmonicType=Q.Semi;break;case 15:e.harmonicType=Q.Artificial;break;case 17:e.harmonicType=Q.Artificial;break;case 22:e.harmonicType=Q.Artificial;break}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=y.Sixteenth;break;case 2:e.trillSpeed=y.ThirtySecond;break;case 3:e.trillSpeed=y.SixtyFourth;break}}}class Ee{static gpReadColor(e,t=!1){const s=e.readByte(),i=e.readByte(),r=e.readByte();let n=255;return t?n=e.readByte():e.skip(1),new Ce(s,i,r,n)}static gpReadBool(e){return e.readByte()!==0}static gpReadStringIntUnused(e,t){return e.skip(4),Ee.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return Ee.gpReadString(e,B.readInt32LE(e),t)}static gpReadStringIntByte(e,t){const s=B.readInt32LE(e)-1;return e.readByte(),Ee.gpReadString(e,s,t)}static gpReadString(e,t,s){const i=new Uint8Array(t);return e.read(i,0,i.length),B.toString(i,s)}static gpWriteString(e,t){const s=B.stringToBytes(t);e.writeByte(t.length),e.write(s,0,s.length)}static gpReadStringByteLength(e,t,s){const i=e.readByte(),r=Ee.gpReadString(e,i,s);return i<t&&e.skip(t-i),r}}class Gl{volume=-1;balance=-1;instrument=-1;tempoName="";tempo=-1;duration=-1}var Ie;(function(a){a[a.Boolean=0]="Boolean",a[a.Integer=1]="Integer",a[a.Float=2]="Float",a[a.String=3]="String",a[a.Point=4]="Point",a[a.Size=5]="Size",a[a.Rectangle=6]="Rectangle",a[a.Color=7]="Color"})(Ie||(Ie={}));class cs{_types=new Map;raw=new Map;constructor(e){e&&this._read(e)}_read(e){const t=pt.fromBuffer(e),s=B.readInt32BE(t);for(let i=0;i<s;i++){const r=Ee.gpReadString(t,t.readByte(),"utf-8"),n=t.readByte();switch(this._types.set(r,n),n){case Ie.Boolean:const o=t.readByte()===1;this.addValue(r,o);break;case Ie.Integer:const l=B.readInt32BE(t);this.addValue(r,l);break;case Ie.Float:const h=B.readFloat32BE(t);this.addValue(r,h);break;case Ie.String:const c=Ee.gpReadString(t,B.readInt16BE(t),"utf-8");this.addValue(r,c);break;case Ie.Point:const d=B.readInt32BE(t),f=B.readInt32BE(t);this.addValue(r,new H(d,f));break;case Ie.Size:const p=B.readInt32BE(t),g=B.readInt32BE(t);this.addValue(r,new H(p,g));break;case Ie.Rectangle:const m=new Mt;m.x=B.readInt32BE(t),m.y=B.readInt32BE(t),m.w=B.readInt32BE(t),m.h=B.readInt32BE(t),this.addValue(r,m);break;case Ie.Color:const b=Ee.gpReadColor(t,!0);this.addValue(r,b);break}}}apply(e){for(const[t,s]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":e.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":e.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":e.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":e.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(e.stylesheet.singleTrackTrackNamePolicy=lt.Hidden);break;case"System/showTrackNameMulti":s||(e.stylesheet.multiTrackTrackNamePolicy=lt.Hidden);break;case"System/trackNameModeSingle":if(e.stylesheet.singleTrackTrackNamePolicy!==lt.Hidden)switch(s){case 0:e.stylesheet.singleTrackTrackNamePolicy=lt.FirstSystem;break;case 1:e.stylesheet.singleTrackTrackNamePolicy=lt.FirstSystem;break;case 2:e.stylesheet.singleTrackTrackNamePolicy=lt.AllSystems;break}break;case"System/trackNameModeMulti":if(e.stylesheet.multiTrackTrackNamePolicy!==lt.Hidden)switch(s){case 0:e.stylesheet.multiTrackTrackNamePolicy=lt.FirstSystem;break;case 1:e.stylesheet.multiTrackTrackNamePolicy=lt.FirstSystem;break;case 2:e.stylesheet.multiTrackTrackNamePolicy=lt.AllSystems;break}break;case"System/shortTrackNameOnFirstSystem":s?e.stylesheet.firstSystemTrackNameMode=Wt.ShortName:e.stylesheet.firstSystemTrackNameMode=Wt.FullName;break;case"System/shortTrackNameOnOtherSystems":s?e.stylesheet.otherSystemsTrackNameMode=Wt.ShortName:e.stylesheet.otherSystemsTrackNameMode=Wt.FullName;break;case"System/horizontalTrackNameOnFirstSystem":s?e.stylesheet.firstSystemTrackNameOrientation=Ot.Horizontal:e.stylesheet.firstSystemTrackNameOrientation=Ot.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":s?e.stylesheet.otherSystemsTrackNameOrientation=Ot.Horizontal:e.stylesheet.otherSystemsTrackNameOrientation=Ot.Vertical;break;case"Header/Title":L.getOrCreateHeaderFooterStyle(e,O.Title).template=s;break;case"Header/TitleAlignment":L.getOrCreateHeaderFooterStyle(e,O.Title).textAlign=this._toTextAlign(s);break;case"Header/drawTitle":L.getOrCreateHeaderFooterStyle(e,O.Title).isVisible=s;break;case"Header/Subtitle":L.getOrCreateHeaderFooterStyle(e,O.SubTitle).template=s;break;case"Header/SubtitleAlignment":L.getOrCreateHeaderFooterStyle(e,O.SubTitle).textAlign=this._toTextAlign(s);break;case"Header/drawSubtitle":L.getOrCreateHeaderFooterStyle(e,O.SubTitle).isVisible=s;break;case"Header/Artist":L.getOrCreateHeaderFooterStyle(e,O.Artist).template=s;break;case"Header/ArtistAlignment":L.getOrCreateHeaderFooterStyle(e,O.Artist).textAlign=this._toTextAlign(s);break;case"Header/drawArtist":L.getOrCreateHeaderFooterStyle(e,O.Artist).isVisible=s;break;case"Header/Album":L.getOrCreateHeaderFooterStyle(e,O.Album).template=s;break;case"Header/AlbumAlignment":L.getOrCreateHeaderFooterStyle(e,O.Album).textAlign=this._toTextAlign(s);break;case"Header/drawAlbum":L.getOrCreateHeaderFooterStyle(e,O.Album).isVisible=s;break;case"Header/Words":L.getOrCreateHeaderFooterStyle(e,O.Words).template=s;break;case"Header/WordsAlignment":L.getOrCreateHeaderFooterStyle(e,O.Words).textAlign=this._toTextAlign(s);break;case"Header/drawWords":L.getOrCreateHeaderFooterStyle(e,O.Words).isVisible=s;break;case"Header/Music":L.getOrCreateHeaderFooterStyle(e,O.Music).template=s;break;case"Header/MusicAlignment":L.getOrCreateHeaderFooterStyle(e,O.Music).textAlign=this._toTextAlign(s);break;case"Header/drawMusic":L.getOrCreateHeaderFooterStyle(e,O.Music).isVisible=s;break;case"Header/WordsAndMusic":L.getOrCreateHeaderFooterStyle(e,O.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":L.getOrCreateHeaderFooterStyle(e,O.WordsAndMusic).textAlign=this._toTextAlign(s);break;case"Header/drawWordsAndMusic":L.getOrCreateHeaderFooterStyle(e,O.WordsAndMusic).isVisible=s;break;case"Header/Tabber":L.getOrCreateHeaderFooterStyle(e,O.Transcriber).template=s;break;case"Header/TabberAlignment":L.getOrCreateHeaderFooterStyle(e,O.Transcriber).textAlign=this._toTextAlign(s);break;case"Header/drawTabber":L.getOrCreateHeaderFooterStyle(e,O.Transcriber).isVisible=s;break;case"Footer/Copyright":L.getOrCreateHeaderFooterStyle(e,O.Copyright).template=s;break;case"Footer/CopyrightAlignment":L.getOrCreateHeaderFooterStyle(e,O.Copyright).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright":L.getOrCreateHeaderFooterStyle(e,O.Copyright).isVisible=s;break;case"Footer/Copyright2":L.getOrCreateHeaderFooterStyle(e,O.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":L.getOrCreateHeaderFooterStyle(e,O.CopyrightSecondLine).textAlign=this._toTextAlign(s);break;case"Footer/drawCopyright2":L.getOrCreateHeaderFooterStyle(e,O.CopyrightSecondLine).isVisible=s;break}}_toTextAlign(e){switch(e){case 0:return X.Left;case 1:return X.Center;case 2:return X.Right}return X.Left}addValue(e,t,s){this.raw.set(e,t),s!==void 0&&this._types.set(e,s)}writeTo(e){B.writeInt32BE(e,this.raw.size);for(const[t,s]of this.raw){const i=this._getDataType(t,s);switch(Ee.gpWriteString(e,t),e.writeByte(i),i){case Ie.Boolean:e.writeByte(s?1:0);break;case Ie.Integer:B.writeInt32BE(e,s);break;case Ie.Float:B.writeFloat32BE(e,s);break;case Ie.String:const r=B.stringToBytes(s);B.writeInt16BE(e,r.length),e.write(r,0,r.length);break;case Ie.Point:B.writeInt32BE(e,s.offset),B.writeInt32BE(e,s.value);break;case Ie.Size:B.writeInt32BE(e,s.offset),B.writeInt32BE(e,s.value);break;case Ie.Rectangle:B.writeInt32BE(e,s.x),B.writeInt32BE(e,s.y),B.writeInt32BE(e,s.w),B.writeInt32BE(e,s.h);break;case Ie.Color:e.writeByte(s.r),e.writeByte(s.g),e.writeByte(s.b),e.writeByte(s.a);break}}}_getDataType(e,t){if(this._types.has(e))return this._types.get(e);const s=typeof t;switch(typeof t){case"string":return Ie.String;case"number":const i=t|0;return t===i?Ie.Integer:Ie.Float;case"object":if(t instanceof H)return Ie.Point;if(t instanceof Mt)return Ie.Rectangle;if(t instanceof Ce)return Ie.Color;break}throw new Ve(Oe.General,`Unknown value type in BinaryStylesheet: ${s}`)}static writeForScore(e){const t=new cs;switch(t.addValue("StandardNotation/hideDynamics",e.stylesheet.hideDynamics,Ie.Boolean),t.addValue("System/bracketExtendMode",e.stylesheet.bracketExtendMode,Ie.Integer),t.addValue("Global/useSystemSignSeparator",e.stylesheet.useSystemSignSeparator,Ie.Boolean),t.addValue("Global/DisplayTuning",e.stylesheet.globalDisplayTuning,Ie.Boolean),t.addValue("Global/DrawChords",e.stylesheet.globalDisplayChordDiagramsOnTop,Ie.Boolean),e.stylesheet.singleTrackTrackNamePolicy){case lt.Hidden:t.addValue("System/showTrackNameSingle",!1,Ie.Boolean);break;case lt.FirstSystem:t.addValue("System/trackNameModeSingle",0,Ie.Integer);break;case lt.AllSystems:t.addValue("System/trackNameModeSingle",2,Ie.Integer);break}switch(e.stylesheet.multiTrackTrackNamePolicy){case lt.Hidden:t.addValue("System/showTrackNameMulti",!1,Ie.Boolean);break;case lt.FirstSystem:t.addValue("System/trackNameModeMulti",0,Ie.Integer);break;case lt.AllSystems:t.addValue("System/trackNameModeMulti",2,Ie.Integer);break}switch(e.stylesheet.firstSystemTrackNameMode){case Wt.FullName:t.addValue("System/shortTrackNameOnFirstSystem",!1,Ie.Boolean);break;case Wt.ShortName:t.addValue("System/shortTrackNameOnFirstSystem",!0,Ie.Boolean);break}switch(e.stylesheet.otherSystemsTrackNameMode){case Wt.FullName:t.addValue("System/shortTrackNameOnOtherSystems",!1,Ie.Boolean);break;case Wt.ShortName:t.addValue("System/shortTrackNameOnOtherSystems",!0,Ie.Boolean);break}switch(e.stylesheet.firstSystemTrackNameOrientation){case Ot.Horizontal:t.addValue("System/horizontalTrackNameOnFirstSystem",!0,Ie.Boolean);break;case Ot.Vertical:t.addValue("System/horizontalTrackNameOnFirstSystem",!1,Ie.Boolean);break}switch(e.stylesheet.otherSystemsTrackNameOrientation){case Ot.Horizontal:t.addValue("System/horizontalTrackNameOnOtherSystems",!0,Ie.Boolean);break;case Ot.Vertical:t.addValue("System/horizontalTrackNameOnOtherSystems",!1,Ie.Boolean);break}const s=e.style;if(s)for(const[r,n]of s.headerAndFooter)switch(r){case O.Title:cs._addHeaderAndFooter(t,n,"Header/","Title");break;case O.SubTitle:cs._addHeaderAndFooter(t,n,"Header/","Subtitle");break;case O.Artist:cs._addHeaderAndFooter(t,n,"Header/","Artist");break;case O.Album:cs._addHeaderAndFooter(t,n,"Header/","Album");break;case O.Words:cs._addHeaderAndFooter(t,n,"Header/","Words");break;case O.Music:cs._addHeaderAndFooter(t,n,"Header/","Music");break;case O.WordsAndMusic:cs._addHeaderAndFooter(t,n,"Header/","WordsAndMusic");break;case O.Transcriber:cs._addHeaderAndFooter(t,n,"Header/","Tabber");break;case O.Copyright:cs._addHeaderAndFooter(t,n,"Footer/","Copyright");break;case O.CopyrightSecondLine:cs._addHeaderAndFooter(t,n,"Footer/","Copyright2");break}const i=pt.withCapacity(128);return t.writeTo(i),i.toArray()}static _addHeaderAndFooter(e,t,s,i){e.addValue(`${s}${i}`,t.template,Ie.String),e.addValue(`${s}${i}Alignment`,t.textAlign,Ie.Integer),t.isVisible!==void 0&&e.addValue(`${s}draw${i}`,t.isVisible,Ie.Boolean)}}class jn{rawAudioFile}class Ul{id="";dots=0;tupletDenominator=-1;tupletNumerator=-1;value=y.Quarter}class zl{name="";path="";role="";get uniqueId(){return`${this.path};${this.name};${this.role}`}program=0;bank=0}class V{static _invalidId="-1";static _bendPointPositionFactor=H.MaxPosition/100;static _bendPointValueFactor=1/25;static _sampleRate=44100;score;_backingTrackAssetId;_masterTrackAutomations;_automationsPerTrackIdAndBarIndex;_sustainPedalsPerTrackIdAndBarIndex;_tracksMapping;_tracksById;_masterBars;_barsOfMasterBar;_barsById;_voicesOfBar;_voiceById;_beatsOfVoice;_rhythmOfBeat;_beatById;_rhythmById;_noteById;_notesOfBeat;_tappedNotes;_lyricsByTrack;_soundsByTrack;_hasAnacrusis=!1;_articulationByName;_skipApplyLyrics=!1;_backingTrackPadding=0;_doubleBars=new Set;_keySignatures=new Map;loadAsset;parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;const s=new fr;try{s.parse(e)}catch(i){throw new ft("Could not parse XML",i)}if(this._parseDom(s),this._buildModel(),L.consolidate(this.score),this.score.finish(t),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(const[i,r]of this._lyricsByTrack)this._tracksById.get(i).applyLyrics(r)}_parseDom(e){const t=e.firstElement;if(t)if(t.localName==="GPIF"){this.score=new Ws;for(const s of t.childElements())switch(s.localName){case"Score":this._parseScoreNode(s);break;case"MasterTrack":this._parseMasterTrackNode(s);break;case"BackingTrack":this._parseBackingTrackNode(s);break;case"Tracks":this._parseTracksNode(s);break;case"MasterBars":this._parseMasterBarsNode(s);break;case"Bars":this._parseBars(s);break;case"Voices":this._parseVoices(s);break;case"Beats":this._parseBeats(s);break;case"Notes":this._parseNotes(s);break;case"Rhythms":this._parseRhythms(s);break;case"Assets":this._parseAssets(s);break}}else throw new ft("Root node of XML was not GPIF")}_parseAssets(e){for(const t of e.childElements())switch(t.localName){case"Asset":t.getAttribute("id")===this._backingTrackAssetId&&this._parseBackingTrackAsset(t);break}}_parseBackingTrackAsset(e){let t="";for(const i of e.childElements())switch(i.localName){case"EmbeddedFilePath":t=i.innerText;break}const s=this.loadAsset;if(s){const i=s(t);i?this.score.backingTrack.rawAudioFile=i:this.score.backingTrack=void 0}}_parseScoreNode(e){for(const t of e.childElements())switch(t.localName){case"Title":this.score.title=t.innerText;break;case"SubTitle":this.score.subTitle=t.innerText;break;case"Artist":this.score.artist=t.innerText;break;case"Album":this.score.album=t.innerText;break;case"Words":this.score.words=t.innerText;break;case"Music":this.score.music=t.innerText;break;case"WordsAndMusic":const s=t.innerText;s!==""&&(s&&!this.score.words&&(this.score.words=s),s&&!this.score.music&&(this.score.music=s));break;case"Copyright":this.score.copyright=t.innerText;break;case"Tabber":this.score.tab=t.innerText;break;case"Instructions":this.score.instructions=t.innerText;break;case"Notices":this.score.notices=t.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=V._parseIntSafe(t.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=V._splitSafe(t.innerText).map(i=>V._parseIntSafe(i,4));break}}static _parseIntSafe(e,t){if(!e)return t;const s=Number.parseInt(e,10);return Number.isNaN(s)?t:s}static _parseFloatSafe(e,t){if(!e)return t;const s=Number.parseFloat(e);return Number.isNaN(s)?t:s}static _splitSafe(e,t=" "){return e?e.split(t).map(s=>s.trim()).filter(s=>s.length>0):[]}_parseBackingTrackNode(e){const t=new jn;let s=!1,i="",r="";for(const n of e.childElements())switch(n.localName){case"Enabled":s=n.innerText==="true";break;case"Source":i=n.innerText;break;case"AssetId":r=n.innerText;break;case"FramePadding":this._backingTrackPadding=V._parseIntSafe(n.innerText,0)/V._sampleRate*1e3;break}s&&i==="Local"&&(this.score.backingTrack=t,this._backingTrackAssetId=r)}_parseMasterTrackNode(e){for(const t of e.childElements())switch(t.localName){case"Automations":this._parseAutomations(t,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=V._splitSafe(t.innerText);break;case"Anacrusis":this._hasAnacrusis=!0;break}}_parseAutomations(e,t,s,i){for(const r of e.childElements())switch(r.localName){case"Automation":this._parseAutomation(r,t,s,i);break}}_parseAutomation(e,t,s,i){let r=null,n=!1,o=-1,l=0,h=0,c=null,d=0,f=null,p,g=!0;for(const b of e.childElements())switch(b.localName){case"Type":r=b.innerText;break;case"Linear":n=b.innerText.toLowerCase()==="true";break;case"Bar":o=V._parseIntSafe(b.innerText,0);break;case"Position":l=V._parseFloatSafe(b.innerText,0);break;case"Value":if(b.firstElement&&b.firstElement.nodeType===et.CDATA)c=b.innerText;else if(b.firstElement&&b.firstElement.nodeType===et.Element&&r==="SyncPoint"){p=new Ur;for(const S of b.childElements())switch(S.localName){case"BarIndex":o=V._parseIntSafe(S.innerText,0);break;case"BarOccurrence":p.barOccurence=V._parseIntSafe(S.innerText,0);break;case"FrameOffset":const T=V._parseFloatSafe(S.innerText,0);p.millisecondOffset=T/V._sampleRate*1e3;break}}else{const S=V._splitSafe(b.innerText);S.length===1?(h=V._parseFloatSafe(S[0],0),d=1):(h=V._parseFloatSafe(S[0],0),d=V._parseIntSafe(S[1],0))}break;case"Text":f=b.innerText;break;case"Visible":g=b.innerText.toLowerCase()==="true";break}if(!r)return;const m=[];switch(r){case"Tempo":m.push(Ye.buildTempoAutomation(n,l,h,d,g));break;case"SyncPoint":const b=new Ye;b.type=De.SyncPoint,b.isLinear=n,b.ratioPosition=l,b.syncPointValue=p,b.isVisible=g,m.push(b);break;case"Sound":if(c&&s&&s.has(c)){const S=new Ye;S.type=De.Bank,S.ratioPosition=l,S.value=s.get(c).bank,S.isVisible=g,m.push(S);const T=Ye.buildInstrumentAutomation(n,l,s.get(c).program);m.push(T)}break;case"SustainPedal":if(i){let S;i.has(o)?S=i.get(o):(S=[],i.set(o,S));const T=new ci;switch(T.ratioPosition=l,d){case 1:T.pedalType=qe.Down;break;case 3:T.pedalType=qe.Up;break}S.push(T)}break}if(m.length){if(f)for(const b of m)b.text=f;if(o>=0){t.has(o)||t.set(o,[]);for(const b of m)t.get(o).push(b)}}}_parseTracksNode(e){for(const t of e.childElements())switch(t.localName){case"Track":this._parseTrack(t);break}}_parseTrack(e){this._articulationByName=new Map;const t=new Gs;t.ensureStaveCount(1);const s=t.staves[0];s.showStandardNotation=!0;const i=e.getAttribute("id");for(const r of e.childElements())switch(r.localName){case"Name":t.name=r.innerText;break;case"Color":const n=V._splitSafe(r.innerText);if(n.length>=3){const h=V._parseIntSafe(n[0],0),c=V._parseIntSafe(n[1],0),d=V._parseIntSafe(n[2],0);t.color=new Ce(h,c,d,255)}break;case"Instrument":const o=r.getAttribute("ref");(o.endsWith("-gs")||o.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this._parseInstrumentSet(t,r);break;case"NotationPatch":this._parseNotationPatch(t,r);break;case"ShortName":t.shortName=r.innerText;break;case"SystemsDefautLayout":t.defaultSystemsLayout=V._parseIntSafe(r.innerText,4);break;case"SystemsLayout":t.systemsLayout=V._splitSafe(r.innerText).map(h=>V._parseIntSafe(h,4));break;case"Lyrics":this._parseLyrics(i,r);break;case"Properties":this._parseTrackProperties(t,r);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this._parseGeneralMidi(t,r);break;case"Sounds":this._parseSounds(i,t,r);break;case"PlaybackState":const l=r.innerText;t.playbackInfo.isSolo=l==="Solo",t.playbackInfo.isMute=l==="Mute";break;case"PartSounding":this._parsePartSounding(i,t,r);break;case"Staves":this._parseStaves(t,r);break;case"Transpose":this._parseTranspose(i,t,r);break;case"RSE":this._parseRSE(t,r);break;case"Automations":this._parseTrackAutomations(i,r);break}this._tracksById.set(i,t)}_parseTrackAutomations(e,t){const s=new Map;this._automationsPerTrackIdAndBarIndex.set(e,s);const i=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(e,i),this._parseAutomations(t,s,this._soundsByTrack.get(e),i)}_parseNotationPatch(e,t){for(const s of t.childElements())switch(s.localName){case"LineCount":const i=V._parseIntSafe(s.innerText,5);for(const r of e.staves)r.standardNotationLineCount=i;break;case"Elements":this._parseElements(e,s);break}}_parseInstrumentSet(e,t){for(const s of t.childElements())switch(s.localName){case"Type":if(s.innerText==="drumKit")for(const r of e.staves)r.isPercussion=!0;break;case"Elements":this._parseElements(e,s);break;case"LineCount":const i=V._parseIntSafe(s.innerText,5);for(const r of e.staves)r.standardNotationLineCount=i;break}}_parseElements(e,t){for(const s of t.childElements())switch(s.localName){case"Element":this._parseElement(e,s);break}}_parseElement(e,t){const s=t.findChildElement("Type")?.innerText??"";for(const i of t.childElements())switch(i.localName){case"Name":case"Articulations":this._parseArticulations(e,i,s);break}}_parseArticulations(e,t,s){for(const i of t.childElements())switch(i.localName){case"Articulation":this._parseArticulation(e,i,s);break}}_parseArticulation(e,t,s){const i=new J;i.outputMidiNumber=-1,i.elementType=s;let r="";for(const n of t.childElements()){const o=n.innerText;switch(n.localName){case"Name":r=n.innerText;break;case"OutputMidiNumber":i.outputMidiNumber=V._parseIntSafe(o,0);break;case"TechniqueSymbol":i.techniqueSymbol=this._parseTechniqueSymbol(o);break;case"TechniquePlacement":switch(o){case"outside":i.techniqueSymbolPlacement=Ge.Outside;break;case"inside":i.techniqueSymbolPlacement=Ge.Inside;break;case"above":i.techniqueSymbolPlacement=Ge.Above;break;case"below":i.techniqueSymbolPlacement=Ge.Below;break}break;case"Noteheads":const l=V._splitSafe(o);l.length>=1&&(i.noteHeadDefault=this._parseNoteHead(l[0])),l.length>=2&&(i.noteHeadHalf=this._parseNoteHead(l[1])),l.length>=3&&(i.noteHeadWhole=this._parseNoteHead(l[2])),i.noteHeadHalf===u.None&&(i.noteHeadHalf=i.noteHeadDefault),i.noteHeadWhole===u.None&&(i.noteHeadWhole=i.noteHeadDefault);break;case"StaffLine":i.staffLine=V._parseIntSafe(o,0);break}}i.outputMidiNumber!==-1?(e.percussionArticulations.push(i),r.length>0&&this._articulationByName.set(r,i)):r.length>0&&this._articulationByName.has(r)&&(this._articulationByName.get(r).staffLine=i.staffLine)}_parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return u.PictEdgeOfCymbal;case"articStaccatoAbove":return u.ArticStaccatoAbove;case"noteheadParenthesis":return u.NoteheadParenthesis;case"stringsUpBow":return u.StringsUpBow;case"stringsDownBow":return u.StringsDownBow;case"guitarGolpe":return u.GuitarGolpe;default:return u.None}}_parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return u.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return u.NoteheadDoubleWhole;case"noteheadWhole":return u.NoteheadWhole;case"noteheadHalf":return u.NoteheadHalf;case"noteheadBlack":return u.NoteheadBlack;case"noteheadNull":return u.NoteheadNull;case"noteheadXOrnate":return u.NoteheadXOrnate;case"noteheadTriangleUpWhole":return u.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return u.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return u.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return u.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return u.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return u.NoteheadDiamondWhiteWide;case"noteheadCircleX":return u.NoteheadCircleX;case"noteheadXWhole":return u.NoteheadXWhole;case"noteheadXHalf":return u.NoteheadXHalf;case"noteheadXBlack":return u.NoteheadXBlack;case"noteheadParenthesis":return u.NoteheadParenthesis;case"noteheadSlashedBlack2":return u.NoteheadSlashedBlack2;case"noteheadCircleSlash":return u.NoteheadCircleSlash;case"noteheadHeavyX":return u.NoteheadHeavyX;case"noteheadHeavyXHat":return u.NoteheadHeavyXHat;default:return E.warning("GPIF","Unknown notehead symbol",e),u.None}}_parseStaves(e,t){let s=0;for(const i of t.childElements())switch(i.localName){case"Staff":e.ensureStaveCount(s+1);const r=e.staves[s];this._parseStaff(r,i),s++;break}}_parseStaff(e,t){for(const s of t.childElements())switch(s.localName){case"Properties":this._parseStaffProperties(e,s);break}}_parseStaffProperties(e,t){for(const s of t.childElements())switch(s.localName){case"Property":this._parseStaffProperty(e,s);break}}_parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(const r of t.childElements())switch(r.localName){case"Pitches":const n=V._splitSafe(t.findChildElement("Pitches")?.innerText),o=new Array(n.length);for(let l=0;l<o.length;l++)o[o.length-1-l]=V._parseIntSafe(n[l],0);e.stringTuning.tunings=o;break;case"Label":e.stringTuning.name=r.innerText;break}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForStaff(e,t);break;case"CapoFret":const i=V._parseIntSafe(t.findChildElement("Fret")?.innerText,0);e.capo=i;break}}_parseLyrics(e,t){const s=[];for(const i of t.childElements())switch(i.localName){case"Line":s.push(this._parseLyricsLine(i));break}this._lyricsByTrack.set(e,s)}_parseLyricsLine(e){const t=new $t;for(const s of e.childElements())switch(s.localName){case"Offset":t.startBar=V._parseIntSafe(s.innerText,0);break;case"Text":t.text=s.innerText;break}return t}_parseDiagramCollectionForTrack(e,t){const s=t.findChildElement("Items");if(s)for(const i of s.childElements())switch(i.localName){case"Item":this._parseDiagramItemForTrack(e,i);break}}_parseDiagramCollectionForStaff(e,t){const s=t.findChildElement("Items");if(s)for(const i of s.childElements())switch(i.localName){case"Item":this._parseDiagramItemForStaff(e,i);break}}_parseDiagramItemForTrack(e,t){const s=new ui,i=t.getAttribute("id");for(const r of e.staves)r.addChord(i,s);this._parseDiagramItemForChord(s,t)}_parseDiagramItemForStaff(e,t){const s=new ui,i=t.getAttribute("id");e.addChord(i,s),this._parseDiagramItemForChord(s,t)}_parseDiagramItemForChord(e,t){e.name=t.getAttribute("name");const s=t.findChildElement("Diagram");if(!s){e.showDiagram=!1,e.showFingering=!1;return}const i=V._parseIntSafe(s.getAttribute("stringCount"),6),r=V._parseIntSafe(s.getAttribute("baseFret"),0);e.firstFret=r+1;for(let n=0;n<i;n++)e.strings.push(-1);for(const n of s.childElements())switch(n.localName){case"Fret":const o=V._parseIntSafe(n.getAttribute("string"),0);e.strings[i-o-1]=r+V._parseIntSafe(n.getAttribute("fret"),0);break;case"Fingering":const l=new Map;for(const h of n.childElements())switch(h.localName){case"Position":let c=j.Unknown;const d=r+V._parseIntSafe(h.getAttribute("fret"),0);switch(h.getAttribute("finger")){case"Index":c=j.IndexFinger;break;case"Middle":c=j.MiddleFinger;break;case"Rank":c=j.AnnularFinger;break;case"Pinky":c=j.LittleFinger;break;case"Thumb":c=j.Thumb;break}c!==j.Unknown&&(l.has(c)?e.barreFrets.push(d):l.set(c,!0));break}break;case"Property":switch(n.getAttribute("name")){case"ShowName":e.showName=n.getAttribute("value")==="true";break;case"ShowDiagram":e.showDiagram=n.getAttribute("value")==="true";break;case"ShowFingering":e.showFingering=n.getAttribute("value")==="true";break}break}}_parseTrackProperties(e,t){for(const s of t.childElements())switch(s.localName){case"Property":this._parseTrackProperty(e,s);break}}_parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":const i=V._splitSafe(t.findChildElement("Pitches")?.innerText),r=new Array(i.length);for(let o=0;o<r.length;o++)r[r.length-1-o]=V._parseIntSafe(i[o],0);for(const o of e.staves)o.stringTuning.tunings=r,o.showStandardNotation=!0,o.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this._parseDiagramCollectionForTrack(e,t);break;case"CapoFret":const n=V._parseIntSafe(t.findChildElement("Fret")?.innerText,0);for(const o of e.staves)o.capo=n;break}}_parseGeneralMidi(e,t){for(const i of t.childElements())switch(i.localName){case"Program":e.playbackInfo.program=V._parseIntSafe(i.innerText,0);break;case"Port":e.playbackInfo.port=V._parseIntSafe(i.innerText,0);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=V._parseIntSafe(i.innerText,0);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=V._parseIntSafe(i.innerText,0);break}if(t.getAttribute("table")==="Percussion")for(const i of e.staves)i.isPercussion=!0}_parseSounds(e,t,s){for(const i of s.childElements())switch(i.localName){case"Sound":this._parseSound(e,t,i);break}}_parseSound(e,t,s){const i=new zl;for(const r of s.childElements())switch(r.localName){case"Name":i.name=r.innerText;break;case"Path":i.path=r.innerText;break;case"Role":i.role=r.innerText;break;case"MIDI":this._parseSoundMidi(i,r);break}this._soundsByTrack.has(e)||(this._soundsByTrack.set(e,new Map),t.playbackInfo.program=i.program,t.playbackInfo.bank=i.bank),this._soundsByTrack.get(e).set(i.uniqueId,i)}_parseSoundMidi(e,t){let s=0,i=0;for(const r of t.childElements())switch(r.localName){case"Program":e.program=V._parseIntSafe(r.innerText,0);break;case"MSB":s=V._parseIntSafe(r.innerText,0);break;case"LSB":i=V._parseIntSafe(r.innerText,0);break}e.bank=(s&127)<<7|i}_parsePartSounding(e,t,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const n of t.staves)n.displayTranspositionPitch=V._parseIntSafe(i.innerText,0);break;case"NominalKey":const r=Math.max(0,A.noteNames.indexOf(i.innerText));this._transposeKeySignaturePerTrack.set(e,r);break}}_transposeKeySignaturePerTrack=new Map;_parseTranspose(e,t,s){let i=0,r=0;for(const l of s.childElements())switch(l.localName){case"Chromatic":r=V._parseIntSafe(l.innerText,0);break;case"Octave":i=V._parseIntSafe(l.innerText,0);break}const n=i*12+r;for(const l of t.staves)l.displayTranspositionPitch=n;const o=L.flooredDivision(n,12);this._transposeKeySignaturePerTrack.set(e,o)}_parseRSE(e,t){for(const s of t.childElements())switch(s.localName){case"ChannelStrip":this._parseChannelStrip(e,s);break}}_parseChannelStrip(e,t){for(const s of t.childElements())switch(s.localName){case"Parameters":this._parseChannelStripParameters(e,s);break}}_parseChannelStripParameters(e,t){if(t.firstChild&&t.firstChild.value){const s=V._splitSafe(t.firstChild.value);s.length>=12&&(e.playbackInfo.balance=Math.floor(V._parseFloatSafe(s[11],.5)*16),e.playbackInfo.volume=Math.floor(V._parseFloatSafe(s[12],.9)*16))}}_parseMasterBarsNode(e){for(const t of e.childElements())switch(t.localName){case"MasterBar":this._parseMasterBar(t);break}}_parseMasterBar(e){const t=new Os;this._masterBars.length===0&&this._hasAnacrusis&&(t.isAnacrusis=!0);for(const s of e.childElements())switch(s.localName){case"Time":const i=s.innerText.split("/");t.timeSignatureNumerator=V._parseIntSafe(i[0],4),t.timeSignatureDenominator=V._parseIntSafe(i[1],4);break;case"FreeTime":t.isFreeTime=!0;break;case"DoubleBar":t.isDoubleBar=!0,this._doubleBars.add(t);break;case"Section":t.section=new cr,t.section.marker=s.findChildElement("Letter")?.innerText??"",t.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":s.getAttribute("start").toLowerCase()==="true"&&(t.isRepeatStart=!0),s.getAttribute("end").toLowerCase()==="true"&&s.getAttribute("count")&&(t.repeatCount=V._parseIntSafe(s.getAttribute("count"),1));break;case"AlternateEndings":const r=V._splitSafe(s.innerText);let n=0;for(let c=0;c<r.length;c++)n=n|1<<-1+V._parseIntSafe(r[c],0);t.alternateEndings=n;break;case"Bars":this._barsOfMasterBar.push(V._splitSafe(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":t.tripletFeel=Be.NoTripletFeel;break;case"Triplet8th":t.tripletFeel=Be.Triplet8th;break;case"Triplet16th":t.tripletFeel=Be.Triplet16th;break;case"Dotted8th":t.tripletFeel=Be.Dotted8th;break;case"Dotted16th":t.tripletFeel=Be.Dotted16th;break;case"Scottish8th":t.tripletFeel=Be.Scottish8th;break;case"Scottish16th":t.tripletFeel=Be.Scottish16th;break}break;case"Key":const o=V._parseIntSafe(s.findChildElement("AccidentalCount")?.innerText,0),l=s.findChildElement("Mode");let h=Qt.Major;if(l)switch(l.innerText.toLowerCase()){case"major":h=Qt.Major;break;case"minor":h=Qt.Minor;break}this._keySignatures.set(this._masterBars.length,[o,h]);break;case"Fermatas":this._parseFermatas(t,s);break;case"XProperties":this._parseMasterBarXProperties(t,s);break;case"Directions":this._parseDirections(t,s);break}this._masterBars.push(t)}_parseDirections(e,t){for(const s of t.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":e.addDirection(z.TargetCoda);break;case"DoubleCoda":e.addDirection(z.TargetDoubleCoda);break;case"Segno":e.addDirection(z.TargetSegno);break;case"SegnoSegno":e.addDirection(z.TargetSegnoSegno);break;case"Fine":e.addDirection(z.TargetFine);break}break;case"Jump":switch(s.innerText){case"DaCapo":e.addDirection(z.JumpDaCapo);break;case"DaCapoAlCoda":e.addDirection(z.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":e.addDirection(z.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":e.addDirection(z.JumpDaCapoAlFine);break;case"DaSegno":e.addDirection(z.JumpDalSegno);break;case"DaSegnoAlCoda":e.addDirection(z.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":e.addDirection(z.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":e.addDirection(z.JumpDalSegnoAlFine);break;case"DaSegnoSegno":e.addDirection(z.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":e.addDirection(z.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":e.addDirection(z.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":e.addDirection(z.JumpDalSegnoSegnoAlFine);break;case"DaCoda":e.addDirection(z.JumpDaCoda);break;case"DaDoubleCoda":e.addDirection(z.JumpDaDoubleCoda);break}break}}_parseFermatas(e,t){for(const s of t.childElements())switch(s.localName){case"Fermata":this._parseFermata(e,s);break}}_parseFermata(e,t){let s=0;const i=new hr;for(const r of t.childElements())switch(r.localName){case"Type":switch(r.innerText){case"Short":i.type=jt.Short;break;case"Medium":i.type=jt.Medium;break;case"Long":i.type=jt.Long;break}break;case"Length":i.length=V._parseFloatSafe(r.innerText,0);break;case"Offset":const n=r.innerText.split("/");if(n.length===2){const o=V._parseIntSafe(n[0],4),l=V._parseIntSafe(n[1],4);s=o/l*x.QuarterTime|0}break}e.addFermata(s,i)}_parseBars(e){for(const t of e.childElements())switch(t.localName){case"Bar":this._parseBar(t);break}}_parseBar(e){const t=new Kt,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Voices":this._voicesOfBar.set(s,V._splitSafe(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":t.clef=Te.Neutral;break;case"G2":t.clef=Te.G2;break;case"F4":t.clef=Te.F4;break;case"C4":t.clef=Te.C4;break;case"C3":t.clef=Te.C3;break}break;case"Ottavia":switch(i.innerText){case"8va":t.clefOttava=ae._8va;break;case"15ma":t.clefOttava=ae._15ma;break;case"8vb":t.clefOttava=ae._8vb;break;case"15mb":t.clefOttava=ae._15mb;break}break;case"SimileMark":switch(i.innerText){case"Simple":t.simileMark=_t.Simple;break;case"FirstOfDouble":t.simileMark=_t.FirstOfDouble;break;case"SecondOfDouble":t.simileMark=_t.SecondOfDouble;break}break;case"XProperties":this._parseBarXProperties(i,t);break}this._barsById.set(s,t)}_parseVoices(e){for(const t of e.childElements())switch(t.localName){case"Voice":this._parseVoice(t);break}}_parseVoice(e){const t=new hs,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Beats":this._beatsOfVoice.set(s,V._splitSafe(i.innerText));break}this._voiceById.set(s,t)}_parseBeats(e){for(const t of e.childElements())switch(t.localName){case"Beat":this._parseBeat(t);break}}_parseBeat(e){const t=new wt,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Notes":this._notesOfBeat.set(s,V._splitSafe(i.innerText));break;case"Rhythm":this._rhythmOfBeat.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":t.fade=ut.FadeIn;break;case"FadeOut":t.fade=ut.FadeOut;break;case"VolumeSwell":t.fade=ut.VolumeSwell;break}break;case"Tremolo":switch(i.innerText){case"1/2":t.tremoloSpeed=y.Eighth;break;case"1/4":t.tremoloSpeed=y.Sixteenth;break;case"1/8":t.tremoloSpeed=y.ThirtySecond;break}break;case"Chord":t.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":t.crescendo=Lt.Crescendo;break;case"Decrescendo":t.crescendo=Lt.Decrescendo;break}break;case"Arpeggio":i.innerText==="Up"?t.brushType=Y.ArpeggioUp:t.brushType=Y.ArpeggioDown;break;case"Properties":this._parseBeatProperties(i,t);break;case"XProperties":this._parseBeatXProperties(i,t);break;case"FreeText":t.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":t.preferredBeamDirection=P.Up;break;case"Downward":t.preferredBeamDirection=P.Down;break}break;case"Dynamic":switch(i.innerText){case"PPP":t.dynamics=Z.PPP;break;case"PP":t.dynamics=Z.PP;break;case"P":t.dynamics=Z.P;break;case"MP":t.dynamics=Z.MP;break;case"MF":t.dynamics=Z.MF;break;case"F":t.dynamics=Z.F;break;case"FF":t.dynamics=Z.FF;break;case"FFF":t.dynamics=Z.FFF;break}break;case"GraceNotes":switch(i.innerText){case"OnBeat":t.graceType=$.OnBeat;break;case"BeforeBeat":t.graceType=$.BeforeBeat;break}break;case"Legato":i.getAttribute("origin")==="true"&&(t.isLegatoOrigin=!0);break;case"Whammy":const r=new H(0,0);r.value=this._toBendValue(V._parseFloatSafe(i.getAttribute("originValue"),0)),r.offset=this._toBendOffset(V._parseFloatSafe(i.getAttribute("originOffset"),0)),t.addWhammyBarPoint(r);const n=new H(0,0);n.value=this._toBendValue(V._parseFloatSafe(i.getAttribute("middleValue"),0)),n.offset=this._toBendOffset(V._parseFloatSafe(i.getAttribute("middleOffset1"),0)),t.addWhammyBarPoint(n);const o=new H(0,0);o.value=this._toBendValue(V._parseFloatSafe(i.getAttribute("middleValue"),0)),o.offset=this._toBendOffset(V._parseFloatSafe(i.getAttribute("middleOffset2"),0)),t.addWhammyBarPoint(o);const l=new H(0,0);l.value=this._toBendValue(V._parseFloatSafe(i.getAttribute("destinationValue"),0)),l.offset=this._toBendOffset(V._parseFloatSafe(i.getAttribute("destinationOffset"),0)),t.addWhammyBarPoint(l);break;case"Ottavia":switch(i.innerText){case"8va":t.ottava=ae._8va;break;case"8vb":t.ottava=ae._8vb;break;case"15ma":t.ottava=ae._15ma;break;case"15mb":t.ottava=ae._15mb;break}break;case"Lyrics":t.lyrics=this._parseBeatLyrics(i),this._skipApplyLyrics=!0;break;case"Slashed":t.slashed=!0;break;case"DeadSlapped":t.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":t.golpe=Ht.Finger;break;case"Thumb":t.golpe=Ht.Thumb;break}break;case"Wah":switch(i.innerText){case"Open":t.wahPedal=Jt.Open;break;case"Closed":t.wahPedal=Jt.Closed;break}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":t.preferredBeamDirection=P.Down;break;case"Upward":t.preferredBeamDirection=P.Up;break}break;case"Timer":t.showTimer=!0,t.timer=V._parseIntSafe(i.innerText,-1),t.timer<0&&(t.timer=null);break}this._beatById.set(s,t)}_parseBeatLyrics(e){const t=[];for(const s of e.childElements())switch(s.localName){case"Line":t.push(s.innerText);break}return t}_parseBeatXProperties(e,t){for(const s of e.childElements())switch(s.localName){case"XProperty":const i=s.getAttribute("id");let r=0;switch(i){case"1124204546":switch(r=V._parseIntSafe(s.findChildElement("Int")?.innerText,0),r){case 1:t.beamingMode=Xe.ForceMergeWithNext;break;case 2:t.beamingMode=Xe.ForceSplitToNext;break}break;case"1124204552":switch(r=V._parseIntSafe(s.findChildElement("Int")?.innerText,0),r){case 1:t.beamingMode!==Xe.ForceSplitToNext&&(t.beamingMode=Xe.ForceSplitOnSecondaryToNext);break}break;case"1124204545":r=V._parseIntSafe(s.findChildElement("Int")?.innerText,0),t.invertBeamDirection=r===1;break;case"687935489":r=V._parseIntSafe(s.findChildElement("Int")?.innerText,0),t.brushDuration=r;break}break}}_parseBarXProperties(e,t){for(const s of e.childElements())switch(s.localName){case"XProperty":switch(s.getAttribute("id")){case"1124139520":const r=s.findChildElement("Double")??s.findChildElement("Float");t.displayScale=V._parseFloatSafe(r?.innerText,1);break}break}}_parseMasterBarXProperties(e,t){for(const s of t.childElements())switch(s.localName){case"XProperty":switch(s.getAttribute("id")){case"1124073984":e.displayScale=V._parseFloatSafe(s.findChildElement("Double")?.innerText,1);break}break}}_parseBeatProperties(e,t){let s=!1,i=null,r=null,n=null,o=null,l=null;for(const h of e.childElements())switch(h.localName){case"Property":switch(h.getAttribute("name")){case"Brush":h.findChildElement("Direction")?.innerText==="Up"?t.brushType=Y.BrushUp:t.brushType=Y.BrushDown;break;case"PickStroke":h.findChildElement("Direction")?.innerText==="Up"?t.pickStroke=kt.Up:t.pickStroke=kt.Down;break;case"Slapped":h.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength")?.innerText){case"Wide":t.vibrato=be.Wide;break;case"Slight":t.vibrato=be.Slight;break}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new H(0,0)),i.value=this._toBendValue(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new H(0,0)),i.offset=this._toBendOffset(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":r=this._toBendValue(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":n=this._toBendOffset(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":o=this._toBendOffset(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":l||(l=new H(H.MaxPosition,0)),l.value=this._toBendValue(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":l||(l=new H(0,0)),l.offset=this._toBendOffset(V._parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"BarreFret":t.barreFret=V._parseIntSafe(h.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(h.findChildElement("String")?.innerText){case"0":t.barreShape=ps.Full;break;case"1":t.barreShape=ps.Half;break}break;case"Rasgueado":switch(h.findChildElement("Rasgueado")?.innerText){case"ii_1":t.rasgueado=ie.Ii;break;case"mi_1":t.rasgueado=ie.Mi;break;case"mii_1":t.rasgueado=ie.MiiTriplet;break;case"mii_2":t.rasgueado=ie.MiiAnapaest;break;case"pmp_1":t.rasgueado=ie.PmpTriplet;break;case"pmp_2":t.rasgueado=ie.PmpAnapaest;break;case"pei_1":t.rasgueado=ie.PeiTriplet;break;case"pei_2":t.rasgueado=ie.PeiAnapaest;break;case"pai_1":t.rasgueado=ie.PaiTriplet;break;case"pai_2":t.rasgueado=ie.PaiAnapaest;break;case"ami_1":t.rasgueado=ie.AmiTriplet;break;case"ami_2":t.rasgueado=ie.AmiAnapaest;break;case"ppp_1":t.rasgueado=ie.Ppp;break;case"amii_1":t.rasgueado=ie.Amii;break;case"amip_1":t.rasgueado=ie.Amip;break;case"eami_1":t.rasgueado=ie.Eami;break;case"eamii_1":t.rasgueado=ie.Eamii;break;case"peami_1":t.rasgueado=ie.Peami;break}break}break}s&&(i||(i=new H(0,0)),l||(l=new H(H.MaxPosition,0)),t.addWhammyBarPoint(i),n&&r&&t.addWhammyBarPoint(new H(n,r)),o&&r&&t.addWhammyBarPoint(new H(o,r)),!n&&!o&&r&&t.addWhammyBarPoint(new H(H.MaxPosition/2|0,r)),t.addWhammyBarPoint(l))}_parseNotes(e){for(const t of e.childElements())switch(t.localName){case"Note":this._parseNote(t);break}}_parseNote(e){const t=new mt,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Properties":this._parseNoteProperties(i,t,s);break;case"AntiAccent":i.innerText.toLowerCase()==="normal"&&(t.isGhost=!0);break;case"LetRing":t.isLetRing=!0;break;case"Trill":t.trillValue=V._parseIntSafe(i.innerText,-1),t.trillSpeed=y.Sixteenth;break;case"Accent":const r=V._parseIntSafe(i.innerText,0);(r&1)!==0&&(t.isStaccato=!0),(r&4)!==0&&(t.accentuated=tt.Heavy),(r&8)!==0&&(t.accentuated=tt.Normal),(r&16)!==0&&(t.accentuated=tt.Tenuto);break;case"Tie":i.getAttribute("destination").toLowerCase()==="true"&&(t.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":t.vibrato=be.Slight;break;case"Wide":t.vibrato=be.Wide;break}break;case"LeftFingering":switch(i.innerText){case"P":t.leftHandFinger=j.Thumb;break;case"I":t.leftHandFinger=j.IndexFinger;break;case"M":t.leftHandFinger=j.MiddleFinger;break;case"A":t.leftHandFinger=j.AnnularFinger;break;case"C":t.leftHandFinger=j.LittleFinger;break}break;case"RightFingering":switch(i.innerText){case"P":t.rightHandFinger=j.Thumb;break;case"I":t.rightHandFinger=j.IndexFinger;break;case"M":t.rightHandFinger=j.MiddleFinger;break;case"A":t.rightHandFinger=j.AnnularFinger;break;case"C":t.rightHandFinger=j.LittleFinger;break}break;case"InstrumentArticulation":t.percussionArticulation=V._parseIntSafe(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":t.ornament=je.Turn;break;case"InvertedTurn":t.ornament=je.InvertedTurn;break;case"UpperMordent":t.ornament=je.UpperMordent;break;case"LowerMordent":t.ornament=je.LowerMordent;break}break}this._noteById.set(s,t)}_parseNoteProperties(e,t,s){let i=!1,r=null,n=null,o=null,l=null,h=null,c=-1,d=-1,f=!1;for(const p of e.childElements())switch(p.localName){case"Property":switch(p.getAttribute("name")){case"ShowStringNumber":p.findChildElement("Enable")&&(t.showStringNumber=!0);break;case"String":t.string=V._parseIntSafe(p.findChildElement("String")?.innerText,0)+1;break;case"Fret":t.fret=V._parseIntSafe(p.findChildElement("Fret")?.innerText,0);break;case"Element":c=V._parseIntSafe(p.findChildElement("Element")?.innerText,0);break;case"Variation":d=V._parseIntSafe(p.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":const m=p.findChildElement("HType");if(m)switch(m.innerText){case"NoHarmonic":t.harmonicType=Q.None;break;case"Natural":t.harmonicType=Q.Natural;break;case"Artificial":t.harmonicType=Q.Artificial;break;case"Pinch":t.harmonicType=Q.Pinch;break;case"Tap":t.harmonicType=Q.Tap;break;case"Semi":t.harmonicType=Q.Semi;break;case"Feedback":t.harmonicType=Q.Feedback;break}break;case"HarmonicFret":const b=p.findChildElement("HFret");b&&(t.harmonicValue=V._parseFloatSafe(b.innerText,0));break;case"Muted":p.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":p.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=V._parseIntSafe(p.findChildElement("Number")?.innerText,0),t.tone===-1&&(t.tone=0);break;case"Tone":t.tone=V._parseIntSafe(p.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":f||this._parseConcertPitch(p,t);break;case"TransposedPitch":t.accidentalMode=re.Default,this._parseConcertPitch(p,t),f=!0;break;case"Bended":i=!0;break;case"BendOriginValue":r||(r=new H(0,0)),r.value=this._toBendValue(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":r||(r=new H(0,0)),r.offset=this._toBendOffset(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":n=this._toBendValue(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":o=this._toBendOffset(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":l=this._toBendOffset(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":h||(h=new H(H.MaxPosition,0)),h.value=this._toBendValue(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":h||(h=new H(0,0)),h.offset=this._toBendOffset(V._parseFloatSafe(p.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":p.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":const S=V._parseIntSafe(p.findChildElement("Flags")?.innerText,0);(S&1)!==0?t.slideOutType=ne.Shift:(S&2)!==0?t.slideOutType=ne.Legato:(S&4)!==0?t.slideOutType=ne.OutDown:(S&8)!==0&&(t.slideOutType=ne.OutUp),(S&16)!==0?t.slideInType=dt.IntoFromBelow:(S&32)!==0&&(t.slideInType=dt.IntoFromAbove),(S&64)!==0?t.slideOutType=ne.PickSlideDown:(S&128)!==0&&(t.slideOutType=ne.PickSlideUp);break}break}i&&(r||(r=new H(0,0)),h||(h=new H(H.MaxPosition,0)),t.addBendPoint(r),o&&n&&t.addBendPoint(new H(o,n)),l&&n&&t.addBendPoint(new H(l,n)),!o&&!l&&n&&t.addBendPoint(new H(H.MaxPosition/2|0,n)),t.addBendPoint(h)),c!==-1&&d!==-1&&(t.percussionArticulation=ht.articulationFromElementVariation(c,d))}_parseConcertPitch(e,t){const s=e.findChildElement("Pitch");if(s)for(const i of s.childElements())switch(i.localName){case"Accidental":switch(i.innerText){case"x":t.accidentalMode=re.ForceDoubleSharp;break;case"#":t.accidentalMode=re.ForceSharp;break;case"b":t.accidentalMode=re.ForceFlat;break;case"bb":t.accidentalMode=re.ForceDoubleFlat;break}break}}_toBendValue(e){return e*V._bendPointValueFactor|0}_toBendOffset(e){return e*V._bendPointPositionFactor}_parseRhythms(e){for(const t of e.childElements())switch(t.localName){case"Rhythm":this._parseRhythm(t);break}}_parseRhythm(e){const t=new Ul,s=e.getAttribute("id");t.id=s;for(const i of e.childElements())switch(i.localName){case"NoteValue":switch(i.innerText){case"Long":t.value=y.QuadrupleWhole;break;case"DoubleWhole":t.value=y.DoubleWhole;break;case"Whole":t.value=y.Whole;break;case"Half":t.value=y.Half;break;case"Quarter":t.value=y.Quarter;break;case"Eighth":t.value=y.Eighth;break;case"16th":t.value=y.Sixteenth;break;case"32nd":t.value=y.ThirtySecond;break;case"64th":t.value=y.SixtyFourth;break;case"128th":t.value=y.OneHundredTwentyEighth;break;case"256th":t.value=y.TwoHundredFiftySixth;break}break;case"PrimaryTuplet":t.tupletNumerator=V._parseIntSafe(i.getAttribute("num"),-1),t.tupletDenominator=V._parseIntSafe(i.getAttribute("den"),-1);break;case"AugmentationDot":t.dots=V._parseIntSafe(i.getAttribute("count"),0);break}this._rhythmById.set(s,t)}_buildModel(){for(let i=0,r=this._masterBars.length;i<r;i++){const n=this._masterBars[i];this.score.addMasterBar(n)}const e=this._masterBars[this._masterBars.length-1];this._doubleBars.has(e)&&(this._doubleBars.delete(e),e.isDoubleBar=!1);const t=[];for(const i of this._tracksMapping){if(!i)continue;const r=this._tracksById.get(i);this.score.addTrack(r),t.push(i)}let s;for(const i of this._barsOfMasterBar){let r=0,n=0;s=[He.C,Qt.Major],this._transposeKeySignaturePerTrack.has(t[0])&&(s=[L.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[0])),s[1]]);for(let o=0;o<i.length&&n<this.score.tracks.length;o++){const l=i[o];if(l!==V._invalidId){const h=this._barsById.get(l),c=this.score.tracks[n],d=c.staves[r];d.addBar(h);const f=d.bars.length-1;if(this._keySignatures.has(f)&&(s=this._keySignatures.get(f),this._transposeKeySignaturePerTrack.has(t[n])&&(s=[L.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[n])),s[1]])),h.keySignature=s[0],h.keySignatureType=s[1],this._doubleBars.has(h.masterBar)&&(h.barLineRight=ce.LightLight),this._voicesOfBar.has(l))for(const p of this._voicesOfBar.get(l))if(p!==V._invalidId){const g=this._voiceById.get(p);if(h.addVoice(g),this._beatsOfVoice.has(p)){for(const m of this._beatsOfVoice.get(p))if(m!==V._invalidId){const b=Qa.clone(this._beatById.get(m));g.addBeat(b);const S=this._rhythmOfBeat.get(m),T=this._rhythmById.get(S);if(b.duration=T.value,b.dots=T.dots,b.tupletNumerator=T.tupletNumerator,b.tupletDenominator=T.tupletDenominator,this._notesOfBeat.has(m)){for(const C of this._notesOfBeat.get(m))if(C!==V._invalidId){const v=Hn.clone(this._noteById.get(C));d.isPercussion?(v.fret=-1,v.string=-1):v.percussionArticulation=-1,b.addNote(v),this._tappedNotes.has(C)&&(b.tap=!0)}}}}}else{const g=new hs;h.addVoice(g);const m=new wt;m.isEmpty=!0,m.duration=y.Quarter,g.addBeat(m)}r===c.staves.length-1?(n++,r=0):r++,s=[He.C,Qt.Major],n<t.length&&this._transposeKeySignaturePerTrack.has(t[n])&&(s=[L.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[n])),s[1]])}else n++}}for(const i of this._tracksMapping){if(!i)continue;const r=this._tracksById.get(i);let n=!1;for(const o of r.staves)if(o.isPercussion){n=!0;break}if(n||(r.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(i)){const o=this._automationsPerTrackIdAndBarIndex.get(i);for(const[l,h]of o)if(r.staves.length>0&&l<r.staves[0].bars.length){const c=r.staves[0].bars[l];if(c.voices.length>0&&c.voices[0].beats.length>0){const d=c.voices[0].beats[0];for(const f of h)f.type===De.Bank&&f.value===0&&c.index===0||d.automations.push(f)}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(i)){const o=this._sustainPedalsPerTrackIdAndBarIndex.get(i);for(const[l,h]of o)if(r.staves.length>0&&l<r.staves[0].bars.length){const c=r.staves[0].bars[l];c.sustainPedals=h}}}for(const[i,r]of this._masterTrackAutomations){const n=this.score.masterBars[i];for(let o=0,l=r.length;o<l;o++){const h=r[o];switch(h.type){case De.Tempo:n.tempoAutomations.push(h);break;case De.SyncPoint:h.syncPointValue.millisecondOffset-=this._backingTrackPadding,n.addSyncPoint(h);break}}}}}class nn{isMultiRest=!1;trackViewGroups=[]}class eo{showNumbered=!1;showSlash=!1;showStandardNotation=!1;showTablature=!1}class to{scoreViews=[];apply(e){if(this.scoreViews.length>0){let t=0;e.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){const i=e.tracks[t];for(const r of i.staves)r.isPercussion||(r.showTablature=s.showTablature),r.showStandardNotation=s.showStandardNotation,r.showSlash=s.showSlash,r.showNumbered=s.showNumbered}t++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(e.stylesheet.perTrackMultiBarRest||(e.stylesheet.perTrackMultiBarRest=new Set),t=s-1,e.stylesheet.perTrackMultiBarRest.add(t))}}constructor(e){const t=pt.fromBuffer(e),s=B.readInt32BE(t);for(let i=0;i<s;i++){const r=new nn;this.scoreViews.push(r),r.isMultiRest=Ee.gpReadBool(t);const n=B.readInt32BE(t);for(let o=0;o<n;o++){let l=t.readByte();l===0&&(l=1);const h=new eo;h.showStandardNotation=(l&1)!==0,h.showTablature=(l&2)!==0,h.showSlash=(l&4)!==0,h.showNumbered=(l&8)!==0,r.trackViewGroups.push(h)}}}static writeForScore(e){const t=pt.withCapacity(128),s=[new nn];s[0].isMultiRest=e.stylesheet.multiTrackMultiBarRest;for(const i of e.tracks){const r=new eo;r.showStandardNotation=i.staves[0].showStandardNotation,r.showTablature=i.staves[0].showTablature,r.showSlash=i.staves[0].showSlash,r.showNumbered=i.staves[0].showNumbered,s[0].trackViewGroups.push(r);const n=new nn;n.isMultiRest=e.stylesheet.perTrackMultiBarRest?.has(i.index)===!0,n.trackViewGroups.push(r),s.push(n)}B.writeInt32BE(t,s.length);for(const i of s){t.writeByte(i.isMultiRest?1:0),B.writeInt32BE(t,i.trackViewGroups.length);for(const r of i.trackViewGroups){let n=0;r.showStandardNotation&&(n=n|1),r.showTablature&&(n=n|2),r.showSlash&&(n=n|4),r.showNumbered&&(n=n|8),t.writeByte(n)}}return B.writeInt32BE(t,1),t.toArray()}}class Yl{trackViewGroups=[]}class Xl{isVisible=!1}var on;(function(a){a[a.PageVertical=0]="PageVertical",a[a.PageGrid=1]="PageGrid",a[a.PageParchment=2]="PageParchment",a[a.ScreenVertical=3]="ScreenVertical",a[a.ScreenHorizontal=4]="ScreenHorizontal",a[a.PageHorizontal=5]="PageHorizontal"})(on||(on={}));class so{zoomLevel=4;view=on.PageVertical;muiltiVoiceCursor=!1;scoreViews=[];constructor(e,t){const s=pt.fromBuffer(t);this.zoomLevel=B.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=s.readByte()!==0;const i=e.scoreViews.length;for(let r=0;r<i;r++){const n=new Yl;this.scoreViews.push(n);const o=e.scoreViews[r];for(let l=0;l<o.trackViewGroups.length;l++){const h=new Xl;h.isVisible=s.readByte()!==0,n.trackViewGroups.push(h)}}}apply(e){if(this.scoreViews.length>0){let t=0;for(const s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){const i=e.tracks[t];i.isVisibleOnMultiTrack=s.isVisible}t++}}}static writeForScore(e){const t=pt.withCapacity(128);B.writeInt32BE(t,4),t.writeByte(0);const s=e.tracks.length>0&&e.tracks[0].staves[0].bars[0].isMultiVoice;t.writeByte(s?255:0);for(const i of e.tracks)t.writeByte(i.isVisibleOnMultiTrack?255:0);for(const i of e.tracks)t.writeByte(255);return t.toArray()}}class Jl extends Ki{get name(){return"Guitar Pro 7-8"}readScore(){E.debug(this.name,"Loading ZIP entries");const e=new tn(this.data);let t;try{t=e.read()}catch(d){throw new ft("No Zip archive",d)}E.debug(this.name,"Zip entries loaded");let s=null,i=null,r=null,n=null;const o=new Map;for(const d of t)switch(o.set(d.fullName,d),d.fileName){case"score.gpif":s=B.toString(d.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=d.data;break;case"PartConfiguration":r=d.data;break;case"LayoutConfiguration":n=d.data;break}if(!s)throw new ft("No score.gpif found in zip archive");E.debug(this.name,"Start Parsing score.gpif");const l=new V;l.loadAsset=d=>{if(o.has(d))return o.get(d).data},l.parseXml(s,this.settings),E.debug(this.name,"score.gpif parsed");const h=l.score;i&&(E.debug(this.name,"Start Parsing BinaryStylesheet"),new cs(i).apply(h),E.debug(this.name,"BinaryStylesheet parsed"));let c=null;return r&&(E.debug(this.name,"Start Parsing Part Configuration"),c=new to(r),c.apply(h),E.debug(this.name,"Part Configuration parsed")),n&&c!=null&&(E.debug(this.name,"Start Parsing Layout Configuration"),new so(c,n).apply(h),E.debug(this.name,"Layout Configuration parsed")),h}}class ln extends Ve{constructor(){super(Oe.Format,"Unexpected end of data within reader")}}class Qr{static _byteSize=8;_currentByte=0;_position=Qr._byteSize;_source;constructor(e){this._source=e}readByte(){return this.readBits(8)}readBytes(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=this.readByte()&255;return t}readBits(e){let t=0,s=e-1;for(;s>=0;)t=t|this.readBit()<<s,s--;return t}readBitsReversed(e){let t=0;for(let s=0;s<e;s++)t=t|this.readBit()<<s;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),this._currentByte===-1)throw new ln;this._position=0}const e=this._currentByte>>Qr._byteSize-this._position-1&1;return this._position++,e}readAll(){const e=pt.empty();try{for(;;)e.writeByte(this.readByte()&255)}catch(t){if(!(t instanceof ln))throw t}return e.toArray()}}class $l{fileName="";fileSize=0;data=null}class ql{static HeaderBcFs="BCFS";static HeaderBcFz="BCFZ";fileFilter;files=[];constructor(){this.files=[],this.fileFilter=e=>!0}load(e){const t=new Qr(e);this._readBlock(t)}readHeader(e){return this._getString(e.readBytes(4),0,4)}decompress(e,t=!1){const s=pt.empty();let i;const r=this._getInteger(e.readBytes(4),0);try{for(;s.length<r;)if(e.readBits(1)===1){const d=e.readBits(4),f=e.readBitsReversed(d),p=e.readBitsReversed(d),g=s.length-f,m=Math.min(f,p);i=s.getBuffer(),s.write(i,g,m)}else{const d=e.readBitsReversed(2);for(let f=0;f<d;f++)s.writeByte(e.readByte())}}catch(c){if(!(c instanceof ln))throw c}i=s.getBuffer();const n=t?4:0,o=s.length-n,l=new Uint8Array(o),h=o;return l.set(i.subarray(n,n+h),0),l}_readBlock(e){const t=this.readHeader(e);if(t==="BCFZ")this._readUncompressedBlock(this.decompress(e,!0));else if(t==="BCFS")this._readUncompressedBlock(e.readAll());else throw new ft("Unsupported format")}_readUncompressedBlock(e){let s=4096;for(;s+3<e.length;){if(this._getInteger(e,s)===2){const r=new $l;r.fileName=this._getString(e,s+4,127),r.fileSize=this._getInteger(e,s+140);const n=!this.fileFilter||this.fileFilter(r.fileName);n&&this.files.push(r);const o=s+148;let l=0,h=0;const c=n?pt.withCapacity(r.fileSize):null;for(;l=this._getInteger(e,o+4*h++),l!==0;)s=l*4096,n&&c.write(e,s,4096);if(n){r.data=new Uint8Array(Math.min(r.fileSize,c.length));const d=c.toArray();r.data.set(d.subarray(0,0+r.data.length),0)}}s+=4096}}_getString(e,t,s){let i="";for(let r=0;r<s;r++){const n=e[t+r]&255;if(n===0)break;i+=String.fromCharCode(n)}return i}_getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}class Ql extends Ki{get name(){return"Guitar Pro 6"}readScore(){E.debug(this.name,"Loading GPX filesystem");const e=new ql;e.fileFilter=h=>h.endsWith("score.gpif")||h.endsWith("BinaryStylesheet")||h.endsWith("PartConfiguration")||h.endsWith("LayoutConfiguration"),e.load(this.data),E.debug(this.name,"GPX filesystem loaded");let t=null,s=null,i=null,r=null;for(const h of e.files)switch(h.fileName){case"score.gpif":t=B.toString(h.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=h.data;break;case"PartConfiguration":i=h.data;break;case"LayoutConfiguration":r=h.data;break}if(!t)throw new ft("No score.gpif found in GPX");E.debug(this.name,"Start Parsing score.gpif");const n=new V;n.parseXml(t,this.settings),E.debug(this.name,"score.gpif parsed");const o=n.score;s&&(E.debug(this.name,"Start Parsing BinaryStylesheet"),new cs(s).apply(o),E.debug(this.name,"BinaryStylesheet parsed"));let l=null;return i&&(E.debug(this.name,"Start Parsing Part Configuration"),l=new to(i),l.apply(o),E.debug(this.name,"Part Configuration parsed")),r&&l!=null&&(E.debug(this.name,"Start Parsing Layout Configuration"),new so(l,r).apply(o),E.debug(this.name,"Layout Configuration parsed")),o}}class Kl{maxLine=-1e3;maxLineNote=null;minLine=-1e3;minLineNote=null}class Rt{_bar;_barRenderer;static _stepsPerOctave=7;static _octaveSteps=[38,32,30,26,38];static sharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6];static flatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];_registeredAccidentals=new Map;_appliedScoreLines=new Map;_appliedScoreLinesByValue=new Map;_notesByValue=new Map;_beatLines=new Map;maxLineBeat=null;minLineBeat=null;maxLine=-1e3;minLine=-1e3;constructor(e){this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:ht.getArticulationByInputMidiNumber(t)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case re.ForceDoubleFlat:t+=2;break;case re.ForceDoubleSharp:t-=2;break;case re.ForceFlat:t+=1;break;case re.ForceSharp:t-=1;break}return t}applyAccidental(e){const t=Rt.getNoteValue(e),s=e.hasQuarterToneOffset;return this._getAccidental(t,s,e.beat,!1,e)}applyAccidentalForValue(e,t,s,i){return this._getAccidental(t,s,e,i,null)}static computeLineWithoutAccidentals(e,t){let s=0;const i=Rt.getNoteValue(t);return t.isPercussion?s=Rt.getPercussionLine(e,i):s=Rt.calculateNoteSteps(e.keySignature,e.clef,i),s}_getAccidental(e,t,s,i,r=null){let n=0,o=K.None;if(r!=null?r.isPercussion:this._bar.staff.isPercussion)n=Rt.getPercussionLine(this._bar,e);else{const h=r?r.accidentalMode:re.Default;n=Rt.calculateNoteSteps(this._bar.keySignature,this._bar.clef,e);const c=this._registeredAccidentals.has(n)?this._registeredAccidentals.get(n):null;o=L.computeAccidental(this._bar.keySignature,h,e,t,c);let d=!1;switch(o){case K.NaturalQuarterNoteUp:case K.SharpQuarterNoteUp:case K.FlatQuarterNoteUp:break;default:if(r&&r.isTieDestination&&r.beat.index===0){const f=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,r.tieOrigin.beat.voice.bar);f&&f.staff===this._barRenderer.staff&&f.accidentalHelper.getNoteLine(r.tieOrigin)===n&&(d=!0)}d?o=K.None:o!==K.None&&this._registeredAccidentals.set(n,o);break}}return r?(this._appliedScoreLines.set(r.id,n),this._notesByValue.set(e,r)):this._appliedScoreLinesByValue.set(e,n),(this.minLine===-1e3||this.minLine<n)&&(this.minLine=n,this.minLineBeat=s),(this.maxLine===-1e3||this.maxLine>n)&&(this.maxLine=n,this.maxLineBeat=s),i||this._registerLine(s,n,r),o}_registerLine(e,t,s){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Kl,this._beatLines.set(e.id,i)),(i.minLine===-1e3||t<i.minLine)&&(i.minLine=t,i.minLineNote=s),(i.minLine===-1e3||t>i.maxLine)&&(i.maxLine=t,i.maxLineNote=s)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMaxLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLineNote:null}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}getMinLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLineNote:null}static calculateNoteSteps(e,t,s){const i=s,r=e,n=t,o=i%12,l=(i/12|0)-1;let h=Rt._octaveSteps[n];h-=l*Rt._stepsPerOctave;const c=L.keySignatureIsSharp(r)||L.keySignatureIsNatural(r)?Rt.sharpNoteSteps:Rt.flatNoteSteps;return h-=c[o],h}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}class Zl{slurStarts;currentDynamics=Z.F;tieStarts;tieStartIds;slideOrigins=new Map;transpose=0;isExplicitlyBeamed=!1;constructor(){this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class jl extends J{outputMidiChannel=-1;outputMidiProgram=-1;outputMidiBank=-1;outputVolume=-1;outputBalance=-1}class hn{track;firstArticulation;instruments=new Map;_instrumentIdToArticulationIndex=new Map;_lyricsLine=0;_lyricsLines=new Map;constructor(e){this.track=e}getLyricLine(e){if(this._lyricsLines.has(e))return this._lyricsLines.get(e);const t=this._lyricsLine;return this._lyricsLines.set(e,t),this._lyricsLine++,t}static _defaultNoteArticulation=new J("Default",0,0,u.NoteheadBlack,u.NoteheadHalf,u.NoteheadWhole);getOrCreateArticulation(e,t){const s=t.octave*12+t.tone,i=`${e}_${s}`;if(this._instrumentIdToArticulationIndex.has(i))return this._instrumentIdToArticulationIndex.get(i);let r;this.instruments.has(e)?r=this.instruments.get(e):r=hn._defaultNoteArticulation;const n=this.track.percussionArticulations.length,o=t.beat.voice.bar;let l;s===0?l=4:l=Rt.calculateNoteSteps(o.keySignature,o.clef,s);const d=9-(t.beat.voice.bar.staff.standardNotationLineCount*2-1),f=l-d,p=new J(r.elementType,f,r.outputMidiNumber,r.noteHeadDefault,r.noteHeadHalf,r.noteHeadWhole,r.techniqueSymbol,r.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(i,n),this.track.percussionArticulations.push(p),n}}class Ue extends Ki{_score;_idToTrackInfo=new Map;_indexToTrackInfo=new Map;_staffToContext=new Map;_divisionsPerQuarterNote=1;_currentDynamics=Z.F;get name(){return"MusicXML"}readScore(){const e=this._extractMusicXml(),t=new fr;try{t.parse(e)}catch(s){throw new ft("Unsupported format",s)}return this._score=new Ws,this._score.stylesheet.hideDynamics=!0,this._parseDom(t),L.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}_extractMusicXml(){const e=new tn(this.data);let t;try{t=e.read()}catch{t=[]}if(t.length===0)return this.data.reset(),B.toString(this.data.readAll(),this.settings.importer.encoding);const s=t.find(h=>h.fullName==="META-INF/container.xml");if(!s)throw new ft("No compressed MusicXML");const i=new fr;try{i.parse(B.toString(s.data,this.settings.importer.encoding))}catch(h){throw new ft("Malformed container.xml, could not parse as XML",h)}const r=i.firstElement;if(!r||r.localName!=="container")throw new ft("Malformed container.xml, root element not 'container'");const n=r.findChildElement("rootfiles");if(!n)throw new ft("Malformed container.xml, 'container/rootfiles' not found");let o="";for(const h of n.childElements())if(h.localName==="rootfile"){o=h.getAttribute("full-path");break}if(!o)throw new ft("Unsupported compressed MusicXML, missing rootfile");const l=t.find(h=>h.fullName===o);if(!l)throw new ft(`Malformed container.xml, '${o}' not contained in zip`);return B.toString(l.data,this.settings.importer.encoding)}_parseDom(e){const t=e.firstElement;if(!t)throw new ft("Unsupported format");switch(t.localName){case"score-partwise":this._parsePartwise(t);break;case"score-timewise":this._parseTimewise(t);break;default:throw new ft("Unsupported format")}}_parsePartwise(e){for(const t of e.childElements())switch(t.localName){case"credit":this._parseCredit(t);break;case"identification":this._parseIdentification(t);break;case"movement-title":this._parseMovementTitle(t);break;case"part":this._parsePartwisePart(t);break;case"part-list":this._parsePartList(t);break;case"work":this._parseWork(t);break}}_parseTimewise(e){let t=0;for(const s of e.childElements())switch(s.localName){case"credit":this._parseCredit(s);break;case"identification":this._parseIdentification(s);break;case"movement-title":this._parseMovementTitle(s);break;case"part-list":this._parsePartList(s);break;case"work":this._parseWork(s);break;case"measure":this._parseTimewiseMeasure(s,t),t++;break}}_parseCredit(e){if(e.getAttribute("page","1")!=="1")return;const t=[];let s=null,i="";for(const r of e.childElements())switch(r.localName){case"credit-type":t.push(r.innerText);break;case"credit-words":s===null&&(s=r),i+=r.innerText;break}if(t.length>0)for(const r of t)switch(r){case"title":this._score.title=Ue._sanitizeDisplay(i);break;case"subtitle":this._score.subTitle=Ue._sanitizeDisplay(i);break;case"composer":this._score.artist=Ue._sanitizeDisplay(i);break;case"arranger":this._score.artist=Ue._sanitizeDisplay(i);break;case"lyricist":this._score.words=Ue._sanitizeDisplay(i);break;case"rights":this._score.copyright=Ue._sanitizeDisplay(i);break}else if(s){const r=s.getAttribute("font-size","0"),n=s.getAttribute("font-size","top"),o=s.getAttribute("halign","left");if(n==="top"){if(i.includes("copyright")||i.includes("Copyright")||i.includes("")||i.includes("(c)")||i.includes("(C)")){this._score.copyright=Ue._sanitizeDisplay(i);return}if(o==="center"||r==="center"){if(this._score.title.length===0){this._score.title=Ue._sanitizeDisplay(i);return}if(this._score.subTitle.length===0){this._score.subTitle=Ue._sanitizeDisplay(i);return}if(this._score.album.length===0){this._score.album=Ue._sanitizeDisplay(i);return}}else if((o==="right"||r==="right")&&this._score.music.length===0){this._score.music=Ue._sanitizeDisplay(i);return}if(this._score.artist.length===0){this._score.artist=Ue._sanitizeDisplay(i);return}if(this._score.words.length===0){this._score.words=Ue._sanitizeDisplay(i);return}}}}static _sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll(`
`," ").replaceAll("	","").replaceAll(" ","")}_parseIdentification(e){for(const t of e.childElements())switch(t.localName){case"creator":if(t.attributes.has("type"))switch(t.attributes.get("type")){case"composer":this._score.artist=Ue._sanitizeDisplay(t.innerText);break;case"lyricist":this._score.words=Ue._sanitizeDisplay(t.innerText);break;case"arranger":this._score.music=Ue._sanitizeDisplay(t.innerText);break}else this._score.artist=Ue._sanitizeDisplay(t.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=t.innerText,t.attributes.has("type")&&(this._score.copyright+=` (${t.attributes.get("type")})`);break;case"encoding":this._parseEncoding(t);break}}_parseEncoding(e){for(const t of e.childElements())switch(t.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=t.innerText,t.attributes.has("type")&&(this._score.tab+=` (${t.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=Ue._sanitizeDisplay(t.innerText);break}}_parseMovementTitle(e){this._score.title.length===0?this._score.title=Ue._sanitizeDisplay(e.innerText):this._score.subTitle=Ue._sanitizeDisplay(e.innerText)}_parsePartList(e){for(const t of e.childElements())switch(t.localName){case"score-part":this._parseScorePart(t);break}}_parseScorePart(e){const t=new Gs;t.ensureStaveCount(1),this._score.addTrack(t);const s=e.attributes.get("id"),i=new hn(t);this._idToTrackInfo.set(s,i),this._indexToTrackInfo.set(t.index,i);for(const r of e.childElements())switch(r.localName){case"part-name":t.name=Ue._sanitizeDisplay(r.innerText);break;case"part-name-display":t.name=this._parsePartDisplayAsText(r);break;case"part-abbreviation":t.shortName=Ue._sanitizeDisplay(r.innerText);break;case"part-abbreviation-display":t.shortName=this._parsePartDisplayAsText(r);break;case"score-instrument":this._parseScoreInstrument(r,i);break;case"midi-device":r.attributes.has("port")&&(t.playbackInfo.port=Number.parseInt(r.attributes.get("port"),10));break;case"midi-instrument":this._parseScorePartMidiInstrument(r,i);break}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(t.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(t.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(t.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(t.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(t.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,t.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}_parseScoreInstrument(e,t){const s=new jl;t.firstArticulation||(t.firstArticulation=s),t.instruments.set(e.getAttribute("id",""),s)}_parseScorePartMidiInstrument(e,t){const s=e.getAttribute("id","");if(!t.instruments.has(s))return;const i=t.instruments.get(s);for(const r of e.childElements())switch(r.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(r.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(r.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(r.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(r.innerText,10)-1;break;case"volume":i.outputVolume=Ue._interpolatePercent(Number.parseFloat(r.innerText));break;case"pan":i.outputBalance=Ue._interpolatePan(Number.parseFloat(r.innerText));break}}static _interpolatePercent(e){return Ue._interpolate(0,100,0,16,e)|0}static _interpolatePan(e){return Ue._interpolate(-90,90,0,16,e)|0}static _interpolate(e,t,s,i,r){const n=(r-e)/(t-e);return s+(i-s)*n}_parsePartDisplayAsText(e){let t="";for(const s of e.childElements())switch(s.localName){case"display-text":t+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":t+="";break;case"natural":t+="";break;case"flat":t+="";break;case"double-sharp":t+="";break;case"sharp-sharp":t+="";break;case"flat-flat":t+="";break;case"natural-sharp":t+="";break;case"natural-flat":t+="";break;case"sharp-down":t+="";break;case"sharp-up":t+="";break;case"natural-down":t+="";break;case"natural-up":t+="";break;case"flat-down":t+="";break;case"flat-up":t+="";break;case"arrow-down":t+="";break;case"arrow-up":t+="";break;case"triple-sharp":t+="";break;case"triple-flat":t+="";break;case"sharp-1":t+="";break;case"sharp-2":t+="";break;case"sharp-3":t+="";break;case"sharp-4":t+="";break;case"sharp-5":t+="";break;case"flat-1":t+="";break;case"flat-2":t+="";break;case"flat-3":t+="";break;case"flat-4":t+="";break;case"flat-5":t+="";break}break}return Ue._sanitizeDisplay(t)}_parseWork(e){for(const t of e.childElements())switch(t.localName){case"work-title":this._score.title=Ue._sanitizeDisplay(t.innerText);break}}_parsePartwisePart(e){const t=e.attributes.get("id");if(!t||!this._idToTrackInfo.has(t))return;const s=this._idToTrackInfo.get(t).track;let i=0;for(const r of e.childElements())switch(r.localName){case"measure":this._parsePartwiseMeasure(r,s,i),i++;break}}_parsePartwiseMeasure(e,t,s){const i=this._getOrCreateMasterBar(e,s);this._parsePartMeasure(e,i,t)}_parseTimewiseMeasure(e,t){const s=this._getOrCreateMasterBar(e,t);for(const i of e.childElements())switch(i.localName){case"part":this._parseTimewisePart(i,s);break}}_getOrCreateMasterBar(e,t){const s=e.attributes.get("implicit")==="yes";for(;this._score.masterBars.length<=t;){const r=new Os;s&&(r.isAnacrusis=!0),this._score.addMasterBar(r),r.index>0&&(r.timeSignatureDenominator=r.previousMasterBar.timeSignatureDenominator,r.timeSignatureNumerator=r.previousMasterBar.timeSignatureNumerator,r.tripletFeel=r.previousMasterBar.tripletFeel)}return this._score.masterBars[t]}_parseTimewisePart(e,t){const s=e.attributes.get("id");if(!s||!this._idToTrackInfo.has(s))return;const i=this._idToTrackInfo.get(s).track;this._parsePartMeasure(e,t,i)}_musicalPosition=0;_lastBeat=null;_parsePartMeasure(e,t,s){this._musicalPosition=0,this._lastBeat=null,t.alternateEndings=this._nextMasterBarRepeatEnding;const i=[];for(const n of e.childElements())switch(n.localName){case"note":this._parseNote(n,t,s);break;case"backup":this._parseBackup(n);break;case"forward":this._parseForward(n);break;case"direction":this._parseDirection(n,t,s);break;case"attributes":this._parseAttributes(n,t,s);break;case"harmony":this._parseHarmony(n,s);break;case"print":this._parsePrint(n,t,s);break;case"sound":this._parseSound(n,t,s);break;case"barline":i.push(n);break}for(const n of i)this._parseBarLine(n,t,s);this._applySimileMarks(t,s);const r=this._getOrCreateStaff(s,0);this._getOrCreateBar(r,t),this._keyAllStaves=null}_parsePrint(e,t,s){(e.getAttribute("new-system","no")==="yes"||e.getAttribute("new-page","no")==="yes")&&s.addLineBreaks(t.index)}_applySimileMarks(e,t){if(this._simileMarkAllStaves!==null){for(const s of t.staves){const i=this._getOrCreateBar(s,e);i.simileMark=this._simileMarkAllStaves,i.simileMark!==_t.None&&this._clearBar(i)}this._simileMarkAllStaves===_t.FirstOfDouble?this._simileMarkAllStaves=_t.SecondOfDouble:this._simileMarkAllStaves=null}if(this._simileMarkPerStaff!==null){const s=Array.from(this._simileMarkPerStaff.keys());for(const i of s){const r=this._getOrCreateStaff(t,i),n=this._getOrCreateBar(r,e);n.simileMark=this._simileMarkPerStaff.get(i),n.simileMark!==_t.None&&this._clearBar(n),n.simileMark===_t.FirstOfDouble?this._simileMarkPerStaff.set(i,_t.SecondOfDouble):this._simileMarkPerStaff.delete(i)}this._simileMarkPerStaff.size===0&&(this._simileMarkPerStaff=null)}}_clearBar(e){for(const t of e.voices){const s=new wt;s.isEmpty=!0,t.addBeat(s)}}_parseBarLine(e,t,s){for(const i of e.childElements())switch(i.localName){case"bar-style":this._parseBarStyle(i,t,s,e.getAttribute("location","right"));break;case"ending":this._parseEnding(i,t);break;case"repeat":this._parseRepeat(i,t);break}}_parseRepeat(e,t){const s=e.getAttribute("direction");let i=Number.parseInt(e.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),s==="backward"?t.repeatCount=i:s==="forward"&&(t.isRepeatStart=!0)}_nextMasterBarRepeatEnding=0;_parseEnding(e,t){const s=e.getAttribute("number").split(",").map(r=>Number.parseInt(r,10));let i=0;for(const r of s)i=i|1<<r-1&255;switch(t.alternateEndings=i,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|i;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~i;break}}_parseBarStyle(e,t,s,i){let r=ce.Automatic;switch(e.innerText){case"dashed":r=ce.Dashed;break;case"dotted":r=ce.Dotted;break;case"heavy":r=ce.Heavy;break;case"heavy-heavy":r=ce.HeavyHeavy;break;case"heavy-light":r=ce.HeavyLight;break;case"light-heavy":r=ce.LightHeavy;break;case"light-light":r=ce.LightLight;break;case"none":r=ce.None;break;case"regular":r=ce.Regular;break;case"short":r=ce.Short;break;case"tick":r=ce.Tick;break}for(const n of s.staves){const o=this._getOrCreateBar(n,t);switch(i){case"left":o.barLineLeft=r;break;case"right":o.barLineRight=r;break}}}_parseSound(e,t,s){for(const i of e.childElements())switch(i.localName){case"midi-instrument":this._parseSoundMidiInstrument(i,t);break;case"swing":this._parseSwing(i,t);break}if(e.attributes.has("coda")&&t.addDirection(z.TargetCoda),e.attributes.has("tocoda")&&t.addDirection(z.JumpDaCoda),e.attributes.has("dacapo")&&t.addDirection(z.JumpDaCapo),e.attributes.has("dalsegno")&&t.addDirection(z.JumpDalSegno),e.attributes.has("fine")&&t.addDirection(z.TargetFine),e.attributes.has("segno")&&t.addDirection(z.TargetSegno),e.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const i=new Ye;i.type=De.Balance,i.value=Ue._interpolatePan(Number.parseFloat(e.attributes.get("pan"))),this._nextBeatAutomations.push(i)}if(e.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const i=new Ye;i.type=De.Tempo,i.value=Ue._interpolatePercent(Number.parseFloat(e.attributes.get("tempo"))),this._nextBeatAutomations.push(i)}}_parseSwing(e,t){let s=0,i=0,r=null;for(const n of e.childElements())switch(n.localName){case"straight":t.tripletFeel=Be.NoTripletFeel;return;case"first":s=Number.parseInt(n.innerText,10);break;case"second":i=Number.parseInt(n.innerText,10);break;case"swing-type":r=this._parseBeatDuration(n);break}r||(r=y.Eighth),r===y.Eighth?s===2&&i===1?t.tripletFeel=Be.Triplet8th:s===3&&i===1?t.tripletFeel=Be.Dotted8th:s===1&&i===3&&(t.tripletFeel=Be.Scottish8th):r===y.Sixteenth&&(s===2&&i===1?t.tripletFeel=Be.Triplet16th:s===3&&i===1?t.tripletFeel=Be.Dotted16th:s===1&&i===3&&(t.tripletFeel=Be.Scottish16th))}_nextBeatAutomations=null;_nextBeatChord=null;_nextBeatCrescendo=null;_nextBeatLetRing=!1;_nextBeatPalmMute=!1;_nextBeatOttavia=null;_nextBeatText=null;_parseSoundMidiInstrument(e,t){let s;for(const i of e.childElements())switch(i.localName){case"midi-bank":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Ye,s.type=De.Bank,s.value=Number.parseInt(i.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Ye,s.type=De.Instrument,s.value=Number.parseInt(i.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Ye,s.type=De.Volume,s.value=Ue._interpolatePercent(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Ye,s.type=De.Balance,s.value=Ue._interpolatePan(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s);break}}_parseHarmony(e,t){const s=new ui;let i=!1,r="";for(const n of e.childElements())switch(n.localName){case"root":s.name=this._parseHarmonyRoot(n);break;case"kind":s.name=s.name+this._parseHarmonyKind(n),n.getAttribute("parentheses-degrees","no")==="yes"&&(i=!0);break;case"frame":this._parseHarmonyFrame(n,s);break;case"degree":r+=this._parseDegree(n);break}r&&(s.name+=i?`(${r})`:r),this._nextBeatChord===null&&(this._nextBeatChord=s)}_parseDegree(e){let t="",s="",i="";for(const r of e.childElements())switch(r.localName){case"degree-value":t=r.innerText;break;case"degree-alter":switch(r.innerText){case"-1":s="";break;case"1":s="";break}break;case"degree-type":i+=r.getAttribute("text","");break}return`${i}${s}${t}`}_parseHarmonyRoot(e){let t="",s="";for(const i of e.childElements())switch(i.localName){case"root-step":t=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##";break}break}return t+s}_parseHarmonyKind(e){const t=e.getAttribute("text");let s="";if(t)s=t;else{const i=e.innerText;switch(i){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="II";break;case"Italian":s="It";break;case"French":s="Fr";break;case"German":s="Fr";break;default:s=i;break}}return s}_parseHarmonyFrame(e,t){for(const s of e.childElements())switch(s.localName){case"frame-strings":const i=Number.parseInt(s.innerText,10);t.strings=new Array(i);for(let o=0;o<i;o++)t.strings[o]=-1;break;case"first-fret":t.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let r=null,n=null;for(const o of s.childElements())switch(o.localName){case"string":r=Number.parseInt(o.innerText,10);break;case"fret":n=Number.parseInt(o.innerText,10),r&&n>=0&&(t.strings[r-1]=n);break;case"barre":r&&n&&o.getAttribute("type")==="start"&&t.barreFrets.push(n);break}break}}_parseAttributes(e,t,s){let i,r,n;if(this._lastBeat==null)for(const o of e.childElements())switch(o.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(o.innerText);break;case"key":this._parseKey(o,t,s);break;case"time":this._parseTime(o,t);break;case"staves":s.ensureStaveCount(Number.parseInt(o.innerText,10));break;case"clef":i=Number.parseInt(o.getAttribute("number","1"),10)-1,r=this._getOrCreateStaff(s,i),n=this._getOrCreateBar(r,t),this._parseClef(o,n);break;case"staff-details":i=Number.parseInt(o.getAttribute("number","1"),10)-1,r=this._getOrCreateStaff(s,i),this._parseStaffDetails(o,r);break;case"transpose":this._parseTranspose(o,s);break;case"measure-style":this._parseMeasureStyle(o,s,!1);break}else for(const o of e.childElements())switch(o.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(o.innerText);break;case"measure-style":this._parseMeasureStyle(o,s,!0);break}}_simileMarkAllStaves=null;_simileMarkPerStaff=null;_isBeatSlash=!1;_parseMeasureStyle(e,t,s){for(const i of e.childElements())switch(i.localName){case"measure-repeat":if(!s){let r=null;switch(i.getAttribute("type")){case"start":switch(Number.parseInt(i.getAttribute("slashes","1"),10)){case 1:r=_t.Simple;break;case 2:r=_t.FirstOfDouble;break}break;case"stop":r=null;break}if(e.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;const n=Number.parseInt(e.attributes.get("number"),10)-1;r==null?this._simileMarkPerStaff.delete(n):this._simileMarkPerStaff.set(n,r)}else this._simileMarkAllStaves=r}break;case"slash":switch(i.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1;break}break}}_parseTranspose(e,t){let s=0;for(const i of e.childElements())switch(i.localName){case"chromatic":s+=Number.parseFloat(i.innerText);break;case"octave-change":s+=Number.parseFloat(i.innerText)*12;break}if(e.attributes.has("number")){const i=this._getOrCreateStaff(t,Number.parseInt(e.attributes.get("number"),10)-1);this._getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}else for(const i of t.staves)this._getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}_parseStaffDetails(e,t){for(const s of e.childElements())switch(s.localName){case"staff-lines":t.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this._parseStaffTuning(s,t);break;case"capo":t.capo=Number.parseInt(s.innerText,10);break}}_parseStaffTuning(e,t){t.stringTuning.tunings.length===0&&(t.showTablature=!0,t.showStandardNotation=!1,t.stringTuning.tunings=new Array(t.standardNotationLineCount).fill(0));const s=Number.parseInt(e.getAttribute("line"),10);let i="C",r="",n=0;for(const l of e.childElements())switch(l.localName){case"tuning-step":i=l.innerText;break;case"tuning-alter":n=Number.parseFloat(l.innerText);break;case"tuning-octave":r=l.innerText;break}const o=L.getTuningForText(i+r)+n;t.tuning[t.tuning.length-s]=o}_parseClef(e,t){let s="s",i=0;for(const r of e.childElements())switch(r.localName){case"sign":s=r.innerText.toLowerCase();break;case"line":i=Number.parseInt(r.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(r.innerText,10)){case-2:t.clefOttava=ae._15mb;break;case-1:t.clefOttava=ae._8vb;break;case 1:t.clefOttava=ae._8va;break;case 2:t.clefOttava=ae._15mb;break}break}switch(s){case"g":t.clef=Te.G2;break;case"f":t.clef=Te.F4;break;case"c":i===3?t.clef=Te.C3:t.clef=Te.C4;break;case"percussion":t.clef=Te.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=Te.G2,t.staff.showTablature=!0;break;default:t.clef=Te.G2;break}}_parseTime(e,t){let s=!1,i=!1;for(const r of e.childElements()){const n=r.innerText;switch(r.localName){case"beats":s||(n.indexOf("+")===-1?t.timeSignatureNumerator=Number.parseInt(n,10):t.timeSignatureNumerator=n.split("+").map(o=>Number.parseInt(o,10)).reduce((o,l)=>l+o,0),s=!0);break;case"beat-type":i||(n.indexOf("+")===-1?t.timeSignatureDenominator=Number.parseInt(n,10):t.timeSignatureDenominator=n.split("+").map(o=>Number.parseInt(o,10)).reduce((o,l)=>l+o,0),i=!0);break}}switch(e.getAttribute("symbol","")){case"common":case"cut":t.timeSignatureCommon=!0;break}}_keyAllStaves=null;_parseKey(e,t,s){let i=-He.C,r="";for(const l of e.childElements())switch(l.localName){case"fifths":i=Number.parseInt(l.innerText,10);break;case"mode":r=l.innerText;break}let n;-7<=i&&i<=7?n=i:n=He.C;let o;if(r==="minor"?o=Qt.Minor:o=Qt.Major,e.attributes.has("number")){const l=this._getOrCreateStaff(s,Number.parseInt(e.attributes.get("number"),10)-1),h=this._getOrCreateBar(l,t);h.keySignature=n,h.keySignatureType=o}else{this._keyAllStaves=[n,o];for(const l of s.staves)l.bars.length>t.index&&(l.bars[t.index].keySignature=n,l.bars[t.index].keySignatureType=o)}}_parseDirection(e,t,s){const i=[];let r=null,n=-1,o=-1;for(const f of e.childElements())switch(f.localName){case"direction-type":const p=f.firstElement;p&&i.push(p);break;case"offset":r=Number.parseFloat(f.innerText);break;case"voice":break;case"staff":n=Number.parseInt(f.innerText,10)-1;break;case"sound":f.attributes.has("tempo")&&(o=Number.parseFloat(f.attributes.get("tempo")));break}let l=null;n>=0?l=this._getOrCreateStaff(s,n):this._lastBeat!==null?l=this._lastBeat.voice.bar.staff:l=this._getOrCreateStaff(s,0);const h=l?this._getOrCreateBar(l,t):null,c=()=>{let f=this._musicalPosition;r!==null&&(f+=r);const p=t.calculateDuration(!1);return f/p};if(o>0){const f=new Ye;f.type=De.Tempo,f.value=o,f.ratioPosition=c(),this._hasSameTempo(t,f)||t.tempoAutomations.push(f)}let d="";for(const f of i)switch(f.localName){case"rehearsal":t.section=new cr,t.section.marker=f.innerText;break;case"segno":t.addDirection(z.TargetSegno);break;case"coda":t.addDirection(z.TargetCoda);break;case"words":d=f.innerText;break;case"wedge":switch(f.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=Lt.Crescendo;break;case"diminuendo":this._nextBeatCrescendo=Lt.Decrescendo;break;case"stop":this._nextBeatCrescendo=null;break}break;case"dynamics":const p=this._parseDynamics(f);p!==null&&(this._currentDynamics=p,this._score.stylesheet.hideDynamics=!1);break;case"dashes":const g=f.getAttribute("type","start");switch(d){case"LetRing":this._nextBeatLetRing=g==="start"||g==="continue";break;case"P.M.":this._nextBeatPalmMute=g==="start"||g==="continue";break}d="";break;case"pedal":const m=this._parsePedal(f);if(m&&h){m.ratioPosition=c();const b=h.sustainPedals.length>0&&h.sustainPedals[h.sustainPedals.length-1].pedalType!==qe.Up;(m.pedalType!==qe.Up||b)&&h.sustainPedals.push(m)}break;case"metronome":this._parseMetronome(f,t,c());break;case"octave-shift":this._nextBeatOttavia=this._parseOctaveShift(f);break}d&&(this._nextBeatText=d)}_parseOctaveShift(e){const t=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"),10)){case 15:switch(t){case"up":return ae._15mb;case"down":return ae._15ma;case"stop":return ae.Regular;case"continue":return this._nextBeatOttavia}break;case 8:switch(t){case"up":return ae._8vb;case"down":return ae._8va;case"stop":return ae.Regular;case"continue":return this._nextBeatOttavia}break}return null}_parseMetronome(e,t,s){let i=null,r=-1;for(const n of e.childElements())switch(n.localName){case"beat-unit":i=this._parseBeatDuration(n);break;case"per-minute":r=Number.parseFloat(n.innerText);break}if(i!==null&&r>0){const n=new Ye;n.type=De.Tempo,n.value=r*(i/4)|0,n.ratioPosition=s,this._hasSameTempo(t,n)||t.tempoAutomations.push(n)}}_hasSameTempo(e,t){for(const s of e.tempoAutomations)if(t.ratioPosition===s.ratioPosition&&t.value===s.value)return!0;return!1}_parsePedal(e){const t=new ci;switch(e.getAttribute("type")){case"start":t.pedalType=qe.Down;break;case"stop":t.pedalType=qe.Up;break;case"continue":t.pedalType=qe.Hold;break;default:return null}return t}_parseDynamics(e){for(const t of e.childElements()){const s=t.localName.toUpperCase();switch(s){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return Z[s]}}return null}_parseForward(e){for(const t of e.childElements())switch(t.localName){case"duration":this._musicalPosition+=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText));break}}_parseBackup(e){for(const t of e.childElements())switch(t.localName){case"duration":if(this._lastBeat){let i=this._musicalPosition;i-=this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)),i<0&&(i=0),this._musicalPosition=i}break}}_getOrCreateStaff(e,t){for(;e.staves.length<=t;){const s=new Li;e.addStaff(s),this._score.masterBars.length>0&&this._getOrCreateBar(s,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[t]}_getOrCreateBar(e,t){const s=e.bars.length===0?1:e.bars[0].voices.length;for(;e.bars.length<=t.index;){const i=new Kt;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),this._keyAllStaves!=null&&(i.keySignature=this._keyAllStaves[0],i.keySignatureType=this._keyAllStaves[1]);for(let r=0;r<s;r++){const n=new hs;i.addVoice(n)}}return e.bars[t.index]}_getOrCreateVoice(e,t){let s=!1;for(;e.voices.length<=t;)e.addVoice(new hs),s=!0;if(s)for(const i of e.staff.bars)for(;i.voices.length<=t;)i.addVoice(new hs);return e.voices[t]}_parseNote(e,t,s){let i=null,r=$.None,n=0,o=null,l=!1,h=0,c=0,d=-1,f=null,p=0,g=-1,m=-1,b=null,S=null,T=!1,C=null;const v=e.getAttribute("print-object","yes")!=="no",G=()=>{if(i!==null)return;l&&!this._lastBeat&&(E.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),l=!1),l&&!S&&(E.warning("MusicXML","Cannot mix <chord /> and <rest />"),l=!1);const W=this._getOrCreateStaff(s,h);if(l){i=this._lastBeat,i.addNote(S);return}const w=this._getOrCreateBar(W,t),se=this._getOrCreateVoice(w,c),Ne=se.beats.length===0?0:se.beats[se.beats.length-1].displayEnd;let ye=this._musicalPosition-Ne;if(ye>0){if(this._lastBeat&&this._lastBeat.beamingMode===Xe.ForceMergeWithNext&&this._lastBeat.voice.bar.staff.index!==h&&se.beats.length>0&&se.beats[se.beats.length-1].beamingMode===Xe.ForceMergeWithNext){const Dt=se.beats[se.beats.length-1].duration;for(;ye>0;){const Xt=this._createRestForGap(ye,Dt);if(Xt!==null)this._insertBeatToVoice(Xt,se),ye-=Xt.playbackDuration;else break}}if(ye>0){const Dt=new wt;Dt.dynamics=this._currentDynamics,Dt.isEmpty=!0,Dt.duration=y.TwoHundredFiftySixth,Dt.overrideDisplayDuration=ye,Dt.updateDurations(),this._insertBeatToVoice(Dt,se)}}else ye<0&&E.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");d<0&&f!==null&&(d=x.toTicks(f),p>0&&(d=x.applyDot(d,p===2)));const te=new wt;i=te,o===null?te.beamingMode=this._getStaffContext(W).isExplicitlyBeamed?Xe.ForceSplitToNext:Xe.Auto:(te.beamingMode=o,this._getStaffContext(W).isExplicitlyBeamed=!0),te.isEmpty=!1,te.dynamics=this._currentDynamics,this._isBeatSlash&&(te.slashed=!0);const Ke=this._nextBeatAutomations;if(this._nextBeatAutomations=null,Ke!==null)for(const Dt of Ke)te.automations.push(Dt);const We=this._nextBeatChord;this._nextBeatChord=null,We!==null&&(te.chordId=We.uniqueId,se.bar.staff.hasChord(We.uniqueId)||se.bar.staff.addChord(te.chordId,We));const qt=this._nextBeatCrescendo;qt!==null&&(te.crescendo=qt);const Ss=this._nextBeatOttavia;if(Ss!==null&&(te.ottava=Ss),te.isLetRing=this._nextBeatLetRing,te.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(te.text=this._nextBeatText,this._nextBeatText=null),S!==null&&te.addNote(S),this._insertBeatToVoice(te,se),S!==null){S.isVisible=v;const Dt=this._indexToTrackInfo.get(s.index);C!==null?S.percussionArticulation=Dt.getOrCreateArticulation(C,S):T||(S.percussionArticulation=Dt.getOrCreateArticulation("",S))}r!==$.None?(te.graceType=r,this._applyBeatDurationFromTicks(te,n,null,!1)):(te.tupletNumerator=g,te.tupletDenominator=m,te.dots=p,te.preferredBeamDirection=b,this._applyBeatDurationFromTicks(te,d,f,!0)),this._musicalPosition=te.displayEnd,this._lastBeat=te};for(const W of e.childElements())switch(W.localName){case"grace":const w=Number.parseFloat(W.getAttribute("make-time","-1"));w>=0?(n=this._musicXmlDivisionsToAlphaTabTicks(w),r=$.BeforeBeat):r=$.OnBeat,W.getAttribute("slash")==="yes"&&(r=$.BeforeBeat);break;case"chord":l=!0;break;case"cue":return;case"pitch":S=this._parsePitch(W),T=!0;break;case"unpitched":S=this._parseUnpitched(W,s);break;case"rest":S=null,f===null&&(f=y.Whole);break;case"duration":d=this._parseDuration(W);break;case"instrument":C=W.getAttribute("id","");break;case"voice":c=Number.parseInt(W.innerText,10),Number.isNaN(c)?(E.warning("MusicXML","Voices need to be specified as numbers"),c=0):c=c-1;break;case"type":f=this._parseBeatDuration(W);break;case"dot":p++;break;case"accidental":S===null?E.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseAccidental(W,S);break;case"time-modification":for(const se of W.childElements())switch(se.localName){case"actual-notes":g=Number.parseInt(se.innerText,10);break;case"normal-notes":m=Number.parseInt(se.innerText,10);break}break;case"stem":b=this._parseStem(W);break;case"notehead":S===null?E.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this._parseNoteHead(W,S,f??y.Quarter,b??this._estimateBeamDirection(S));break;case"staff":h=Number.parseInt(W.innerText,10)-1;break;case"beam":if(W.getAttribute("number","1")==="1")switch(W.innerText){case"begin":o=Xe.ForceMergeWithNext;break;case"continue":o=Xe.ForceMergeWithNext;break;case"end":o=Xe.ForceSplitToNext;break}break;case"notations":G(),this._parseNotations(W,S,i);break;case"lyric":G(),this._parseLyric(W,i,s);break;case"play":this._parsePlay(W,S);break}if(T){const W=this._getOrCreateStaff(s,h),w=this._getStaffContext(W).transpose;if(w!==0){const se=S.octave*12+S.tone+w;S.octave=se/12|0,S.tone=se-S.octave*12}}G()}_parsePlay(e,t){for(const s of e.childElements())switch(s.localName){case"mute":t&&s.innerText==="palm"&&(t.isPalmMute=!0);break}}static _b4Value=71;_estimateBeamDirection(e){return e.calculateRealValue(!1,!1)<Ue._b4Value?P.Down:P.Up}_parseNoteHead(e,t,s,i){e.getAttribute("parentheses","no")==="yes"&&(t.isGhost=!0);const r=e.getAttribute("filled","");let n;switch(r==="yes"?n=!0:r==="no"&&(n=!1),t.style=new On,e.innerText){case"arrow down":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,n,u.NoteheadTriangleDownDoubleWhole,u.NoteheadTriangleDownWhole,u.NoteheadTriangleDownHalf,u.NoteheadTriangleDownBlack);break;case"arrow up":t.style.noteHeadCenterOnStem=!0,this._applyNoteHead(t,s,n,u.NoteheadTriangleUpDoubleWhole,u.NoteheadTriangleUpWhole,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpBlack);break;case"back slashed":this._applyNoteHead(t,s,n,u.NoteheadSlashedDoubleWhole2,u.NoteheadSlashedWhole2,u.NoteheadSlashedHalf2,u.NoteheadSlashedBlack2);break;case"circle dot":t.style.noteHead=u.NoteheadRoundWhiteWithDot;break;case"circle-x":this._applyNoteHead(t,s,n,u.NoteheadCircleXDoubleWhole,u.NoteheadCircleXWhole,u.NoteheadCircleXHalf,u.NoteheadCircleX);break;case"circled":this._applyNoteHead(t,s,n,u.NoteheadCircledDoubleWhole,u.NoteheadCircledWhole,u.NoteheadCircledHalf,u.NoteheadCircledBlack);break;case"cluster":this._applyNoteHead(t,s,n,u.NoteheadClusterDoubleWhole3rd,u.NoteheadClusterWhole3rd,u.NoteheadClusterHalf3rd,u.NoteheadClusterQuarter3rd);break;case"cross":this._applyNoteHead(t,s,n,u.NoteheadPlusDoubleWhole,u.NoteheadPlusWhole,u.NoteheadPlusHalf,u.NoteheadPlusBlack);break;case"diamond":this._applyNoteHead(t,s,n,u.NoteheadDiamondDoubleWhole,u.NoteheadDiamondWhole,u.NoteheadDiamondHalf,u.NoteheadDiamondBlack);break;case"do":this._applyNoteHead(t,s,n,u.NoteShapeTriangleUpWhite,u.NoteShapeTriangleUpWhite,u.NoteShapeTriangleUpWhite,u.NoteShapeTriangleUpBlack);break;case"fa":i===P.Up?this._applyNoteHead(t,s,n,u.NoteShapeTriangleRightWhite,u.NoteShapeTriangleRightWhite,u.NoteShapeTriangleRightWhite,u.NoteShapeTriangleRightBlack):this._applyNoteHead(t,s,n,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftBlack);break;case"fa up":this._applyNoteHead(t,s,n,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftWhite,u.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this._applyNoteHead(t,s,n,u.NoteheadTriangleDownDoubleWhole,u.NoteheadTriangleDownWhole,u.NoteheadTriangleDownHalf,u.NoteheadTriangleDownBlack);break;case"la":this._applyNoteHead(t,s,n,u.NoteShapeSquareWhite,u.NoteShapeSquareWhite,u.NoteShapeSquareWhite,u.NoteShapeSquareBlack);break;case"left triangle":this._applyNoteHead(t,s,n,u.NoteheadTriangleRightWhite,u.NoteheadTriangleRightWhite,u.NoteheadTriangleRightWhite,u.NoteheadTriangleRightBlack);break;case"mi":this._applyNoteHead(t,s,n,u.NoteShapeDiamondWhite,u.NoteShapeDiamondWhite,u.NoteShapeDiamondWhite,u.NoteShapeDiamondBlack);break;case"none":t.style.noteHead=u.NoteheadNull;break;case"normal":this._applyNoteHead(t,s,n,u.NoteheadDoubleWhole,u.NoteheadWhole,u.NoteheadHalf,u.NoteheadBlack);break;case"re":this._applyNoteHead(t,s,n,u.NoteShapeMoonWhite,u.NoteShapeMoonWhite,u.NoteShapeMoonWhite,u.NoteShapeMoonBlack);break;case"rectangle":this._applyNoteHead(t,s,n,u.NoteheadSquareWhite,u.NoteheadSquareWhite,u.NoteheadSquareWhite,u.NoteheadSquareBlack);break;case"slash":this._applyNoteHead(t,s,n,u.NoteheadSlashWhiteWhole,u.NoteheadSlashWhiteWhole,u.NoteheadSlashWhiteHalf,u.NoteheadSlashHorizontalEnds);break;case"slashed":this._applyNoteHead(t,s,n,u.NoteheadSlashedDoubleWhole1,u.NoteheadSlashedWhole1,u.NoteheadSlashedHalf1,u.NoteheadSlashedBlack1);break;case"so":this._applyNoteHead(t,s,n,u.NoteShapeRoundWhite,u.NoteShapeRoundWhite,u.NoteShapeRoundWhite,u.NoteShapeRoundBlack);break;case"square":this._applyNoteHead(t,s,n,u.NoteShapeSquareWhite,u.NoteShapeSquareWhite,u.NoteShapeSquareWhite,u.NoteShapeSquareBlack);break;case"ti":this._applyNoteHead(t,s,n,u.NoteShapeTriangleRoundWhite,u.NoteShapeTriangleRoundWhite,u.NoteShapeTriangleRoundWhite,u.NoteShapeTriangleRoundBlack);break;case"triangle":this._applyNoteHead(t,s,n,u.NoteheadTriangleUpDoubleWhole,u.NoteheadTriangleUpWhole,u.NoteheadTriangleUpHalf,u.NoteheadTriangleUpBlack);break;case"x":this._applyNoteHead(t,s,n,u.NoteheadXDoubleWhole,u.NoteheadXWhole,u.NoteheadXHalf,u.NoteheadXBlack);break}}_createRestForGap(e,t){let s=x.toTicks(t);for(;s>e;){if(t===y.TwoHundredFiftySixth)return null;t=t*2,s=x.toTicks(t)}const i=new wt;return i.dynamics=this._currentDynamics,i.isEmpty=!1,i.duration=t,i.overrideDisplayDuration=s,i.updateDurations(),i}_insertBeatToVoice(e,t){if(t.beats.length>0){const s=t.beats[t.beats.length-1];s.nextBeat=e,e.previousBeat=s;let i=s;for(;i!==null&&i.graceType!==$.None;)i.index>0?i=i.previousBeat:i=null;i!==null&&(e.displayStart=i.displayEnd)}t.addBeat(e)}_musicXmlDivisionsToAlphaTabTicks(e){return e*x.QuarterTime/this._divisionsPerQuarterNote}_parseBeatDuration(e){switch(e.innerText){case"1024th":return y.TwoHundredFiftySixth;case"512th":return y.TwoHundredFiftySixth;case"256th":return y.TwoHundredFiftySixth;case"128th":return y.OneHundredTwentyEighth;case"64th":return y.SixtyFourth;case"32nd":return y.ThirtySecond;case"16th":return y.Sixteenth;case"eighth":return y.Eighth;case"quarter":return y.Quarter;case"half":return y.Half;case"whole":return y.Whole;case"breve":return y.DoubleWhole;case"long":return y.QuadrupleWhole}return null}static _allDurations=[y.TwoHundredFiftySixth,y.OneHundredTwentyEighth,y.SixtyFourth,y.ThirtySecond,y.Sixteenth,y.Eighth,y.Quarter,y.Half,y.Whole,y.DoubleWhole,y.QuadrupleWhole];static _allDurationTicks=Ue._allDurations.map(e=>x.toTicks(e));_applyBeatDurationFromTicks(e,t,s,i){if(!s)for(let r=0;r<Ue._allDurations.length;r++){const n=Ue._allDurationTicks[r];if(t>=n)s=Ue._allDurations[r];else break}e.duration=s??y.Sixteenth,i&&(e.overrideDisplayDuration=t),e.updateDurations()}_parseLyric(e,t,s){const r=this._indexToTrackInfo.get(s.index).getLyricLine(e.getAttribute("number",""));for(t.lyrics===null&&(t.lyrics=[]);t.lyrics.length<=r;)t.lyrics.push("");for(const n of e.childElements())switch(n.localName){case"text":t.lyrics[r]?t.lyrics[r]+=` ${n.innerText}`:t.lyrics[r]=n.innerText;break;case"elision":t.lyrics[r]+=n.innerText;break}}_parseNotations(e,t,s){for(const i of e.childElements())switch(i.localName){case"tied":t&&this._parseTied(i,t,s.voice.bar.staff);break;case"slur":t&&this._parseSlur(i,t);break;case"glissando":t&&this._parseGlissando(i,t);break;case"slide":t&&this._parseSlide(i,t);break;case"ornaments":t&&this._parseOrnaments(i,t);break;case"technical":this._parseTechnical(i,t,s);break;case"articulations":t&&this._parseArticulations(i,t);break;case"dynamics":const r=this._parseDynamics(i);r!==null&&(s.dynamics=r,this._currentDynamics=r);break;case"fermata":this._parseFermata(i,s);break;case"arpeggiate":this._parseArpeggiate(i,s);break}}_getStaffContext(e){if(!this._staffToContext.has(e)){const t=new Zl;return this._staffToContext.set(e,t),t}return this._staffToContext.get(e)}_parseGlissando(e,t){const s=e.getAttribute("type"),i=e.getAttribute("number","1"),r=this._getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":r.slideOrigins.set(i,t);break;case"stop":if(r.slideOrigins.has(i)){const n=r.slideOrigins.get(i);n.slideTarget=t,t.slideOrigin=n,n.slideOutType=ne.Shift}break}}_parseSlur(e,t){const s=e.getAttribute("number","1"),i=this._getStaffContext(t.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":i.slurStarts.set(s,t);break;case"stop":if(i.slurStarts.has(s)){t.isSlurDestination=!0;const r=i.slurStarts.get(s);r.slurDestination=t,t.slurOrigin=r,i.slurStarts.delete(s)}break}}_parseArpeggiate(e,t){switch(e.getAttribute("direction","down")){case"down":t.brushType=Y.ArpeggioDown;break;case"up":t.brushType=Y.ArpeggioUp;break}}_parseFermata(e,t){let s;switch(e.innerText){case"normal":s=jt.Medium;break;case"angled":s=jt.Short;break;case"square":s=jt.Long;break;default:s=jt.Medium;break}t.fermata=new hr,t.fermata.type=s}_parseArticulations(e,t){for(const s of e.childElements())switch(s.localName){case"accent":t.accentuated=tt.Normal;break;case"strong-accent":t.accentuated=tt.Heavy;break;case"staccato":t.isStaccato=!0;break;case"tenuto":t.accentuated=tt.Tenuto;break}}_parseTechnical(e,t,s){const i=[];for(const r of e.childElements())switch(r.localName){case"up-bow":s.pickStroke=kt.Up;break;case"down-bow":s.pickStroke=kt.Down;break;case"harmonic":break;case"fingering":t&&(t.leftHandFinger=this._parseFingering(r));break;case"pluck":t&&(t.rightHandFinger=this._parseFingering(r));break;case"fret":t&&(t.fret=Number.parseInt(r.innerText,10));break;case"string":t&&(t.string=s.voice.bar.staff.tuning.length-Number.parseInt(r.innerText,10)+1);break;case"hammer-on":case"pull-off":t&&(t.isHammerPullOrigin=!0);break;case"bend":i.push(r);break;case"tap":s.tap=!0;break;case"smear":t&&(t.vibrato=be.Slight);break;case"golpe":switch(r.getAttribute("placement","above")){case"above":s.golpe=Ht.Finger;break;case"below":s.golpe=Ht.Thumb;break}break}t&&i.length>0&&this._parseBends(i,t)}_parseBends(e,t){const s=H.MaxPosition/e.length;let i=0,r=0,n=!0;for(const o of e){const l=o.findChildElement("bend-alter");if(l){const h=Math.round(Math.abs(Number.parseFloat(l.innerText))*2);o.findChildElement("pre-bend")?n?(i+=h,t.addBendPoint(new H(r,i)),r+=s,t.addBendPoint(new H(r,i)),n=!1):r+=s:o.findChildElement("release")?(n&&(i+=h),t.addBendPoint(new H(r,i)),r+=s,i-=h,t.addBendPoint(new H(r,i)),n=!1):(t.addBendPoint(new H(r,i)),i+=h,r+=s,t.addBendPoint(new H(r,i)),n=!1)}}}_parseFingering(e){switch(e.innerText){case"0":return j.NoOrDead;case"1":case"p":case"t":return j.Thumb;case"2":case"i":return j.IndexFinger;case"3":case"m":return j.MiddleFinger;case"4":case"a":return j.AnnularFinger;case"5":case"c":return j.LittleFinger}return j.Unknown}_currentTrillStep=-1;_parseOrnaments(e,t){let s=-1;for(const i of e.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),t.isStringed?t.trillValue=t.stringTuning+s:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+s);break;case"turn":t.ornament=je.Turn;break;case"inverted-turn":t.ornament=je.InvertedTurn;break;case"wavy-line":s>0?i.getAttribute("type")==="start"&&(this._currentTrillStep=s):this._currentTrillStep>0?i.getAttribute("type")==="stop"?this._currentTrillStep=-1:t.isStringed?t.trillValue=t.stringTuning+this._currentTrillStep:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+this._currentTrillStep):t.vibrato=be.Slight;break;case"mordent":t.ornament=je.LowerMordent;break;case"inverted-mordent":t.ornament=je.UpperMordent;break;case"tremolo":switch(i.innerText){case"1":t.beat.tremoloSpeed=y.Eighth;break;case"2":t.beat.tremoloSpeed=y.Sixteenth;break;case"3":t.beat.tremoloSpeed=y.ThirtySecond;break}break}}_parseSlide(e,t){const s=e.getAttribute("type"),i=e.getAttribute("number","1"),r=this._getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":r.slideOrigins.set(i,t);break;case"stop":if(r.slideOrigins.has(i)){const n=r.slideOrigins.get(i);n.slideTarget=t,t.slideOrigin=n,n.slideOutType=ne.Shift}break}}_parseTied(e,t,s){const i=e.getAttribute("type"),r=e.getAttribute("number",""),n=this._getStaffContext(s);if(i==="start"){if(r){if(n.tieStartIds.has(r)){const o=n.tieStartIds.get(r);n.tieStarts.delete(o)}n.tieStartIds.set(r,t)}n.tieStarts.add(t)}else if(i==="stop"&&!t.isTieDestination){let o=null;if(r){if(!n.tieStartIds.has(r))return;o=n.tieStartIds.get(r),n.tieStartIds.delete(r),n.tieStarts.delete(t)}else{const l=this._calculatePitchedNoteValue(t);for(const h of n.tieStarts)if(this._calculatePitchedNoteValue(h)===l){o=h,n.tieStarts.delete(o);break}}if(!o)return;t.isTieDestination=!0,t.tieOrigin=o}}_parseStem(e){switch(e.innerText){case"down":return P.Down;case"up":return P.Up;default:return null}}_parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=re.ForceSharp;break;case"natural":t.accidentalMode=re.ForceNatural;break;case"flat":t.accidentalMode=re.ForceFlat;break;case"double-sharp":t.accidentalMode=re.ForceDoubleSharp;break;case"flat-flat":t.accidentalMode=re.ForceDoubleFlat;break}}_calculatePitchedNoteValue(e){return e.octave*12+e.tone}_parseDuration(e){return this._musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}_parseUnpitched(e,t){let s="",i=0;for(const n of e.childElements())switch(n.localName){case"display-step":s=n.innerText;break;case"display-octave":i=Number.parseInt(n.innerText,10)+1;break}const r=new mt;if(s==="")r.octave=0,r.tone=0;else{const n=i*12+(L.getToneForText(s)?.noteValue??0);r.octave=n/12|0,r.tone=n-r.octave*12}return r}_parsePitch(e){let t="",s=0,i=0;for(const o of e.childElements())switch(o.localName){case"step":t=o.innerText;break;case"alter":s=Number.parseFloat(o.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(o.innerText,10)+1;break}s=s|0;const r=i*12+(L.getToneForText(t)?.noteValue??0)+s,n=new mt;return n.octave=r/12|0,n.tone=r-n.octave*12,n}_applyNoteHead(e,t,s,i,r,n,o){if(s===void 0)switch(t){case y.QuadrupleWhole:case y.DoubleWhole:e.style.noteHead=i;break;case y.Whole:e.style.noteHead=r;break;case y.Half:e.style.noteHead=n;break;default:e.style.noteHead=o;break}else if(s===!0)e.style.noteHead=o;else switch(t){case y.QuadrupleWhole:case y.DoubleWhole:e.style.noteHead=i;break;case y.Whole:e.style.noteHead=r;break;case y.Half:e.style.noteHead=n;break;default:e.style.noteHead=n;break}}}class io{_buffer;_writePosition=0;_readPosition=0;count=0;constructor(e){this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);const r=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(e.subarray(t,t+r),this._writePosition),this._writePosition+=r,this._writePosition%=this._buffer.length,i+=r,i<s&&(this._buffer.set(e.subarray(t+i,t+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(e,t,s){s>this.count&&(s=this.count);let i=0;const r=Math.min(this._buffer.length-this._readPosition,s);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+r),t),i+=r,this._readPosition+=r,this._readPosition%=this._buffer.length,i<s&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),t+i),this._readPosition+=s-i,i=s),this.count-=i,i}}class Nt{static CmdOutputPrefix="alphaSynth.output.";static CmdOutputAddSamples=`${Nt.CmdOutputPrefix}addSamples`;static CmdOutputPlay=`${Nt.CmdOutputPrefix}play`;static CmdOutputPause=`${Nt.CmdOutputPrefix}pause`;static CmdOutputResetSamples=`${Nt.CmdOutputPrefix}resetSamples`;static CmdOutputStop=`${Nt.CmdOutputPrefix}stop`;static CmdOutputSampleRequest=`${Nt.CmdOutputPrefix}sampleRequest`;static CmdOutputSamplesPlayed=`${Nt.CmdOutputPrefix}samplesPlayed`;static preferredSampleRate=0;_worker;get sampleRate(){return Nt.preferredSampleRate}open(){E.debug("AlphaSynth","Initializing synth worker"),this._worker=F.globalThis,this._worker.addEventListener("message",this._handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}_handleMessage(e){const t=e.data;switch(t.cmd){case Nt.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case Nt.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples);break}}ready=new ct;samplesPlayed=new ge;sampleRequest=new ct;addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:F.prepareForPostMessage(e)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}class eh{device;constructor(e){this.device=e}get deviceId(){return this.device.deviceId}get label(){return this.device.label}isDefault=!1}class es{static _knownDevices=[];static findKnownDevice(e){return es._knownDevices.find(t=>t.deviceId===e)}static createAudioContext(){if("AudioContext"in F.globalThis)return new AudioContext;if("webkitAudioContext"in F.globalThis)return new webkitAudioContext;throw new Ve(Oe.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in es.createAudioContext()?!0:(E.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await es.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(o){E.warning("WebAudio","Output device permission rejected",o)}const e=await navigator.mediaDevices.enumerateDevices();let t="",s="";const i=new Map;for(const o of e)o.kind==="audiooutput"&&(i.set(o.groupId,new eh(o)),(o.deviceId==="default"||o.deviceId==="")&&(t=o.groupId,s=o.deviceId));const r=Array.from(i.values());let n=r.find(o=>o.deviceId===s);return n||(n=r.find(o=>o.device.groupId===t)),!n&&r.length>0&&(n=r[0]),n&&(n.isDefault=!0),es._knownDevices=r,r}catch(e){return E.error("WebAudio","Failed to enumerate output devices",e),[]}}}class Us{static BufferSize=4096;static PreferredSampleRate=44100;context=null;buffer=null;source=null;_resumeHandler;get sampleRate(){return this.context?this.context.sampleRate:Us.PreferredSampleRate}activate(e){this.context||(this.context=es.createAudioContext()),(this.context.state==="suspended"||this.context.state==="interrupted")&&(E.debug("WebAudio","Audio Context is suspended, trying resume"),this.context.resume().then(()=>{E.debug("WebAudio",`Audio Context resume success: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}`),e&&e()},t=>{E.warning("WebAudio",`Audio Context resume failed: state=${this.context?.state}, sampleRate:${this.context?.sampleRate}, reason=${t}`)}))}_patchIosSampleRate(){const e=navigator.userAgent;if(e.indexOf("iPhone")!==-1||e.indexOf("iPad")!==-1){const t=es.createAudioContext(),s=t.createBuffer(1,1,Us.PreferredSampleRate),i=t.createBufferSource();i.buffer=s,i.connect(t.destination),i.start(0),i.disconnect(0),t.close()}}open(e){this._patchIosSampleRate(),this.context=es.createAudioContext(),this.context.state==="suspended"&&this._registerResumeHandler()}_registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this._unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}_unregisterResumeHandler(){const e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){const e=this.context;this.activate(),this.buffer=e.createBuffer(2,Us.BufferSize,e.sampleRate),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0}pause(){this.source&&(this.source.stop(0),this.source.disconnect()),this.source=null}destroy(){this.pause(),this.context?.close(),this.context=null,this._unregisterResumeHandler()}ready=new ct;samplesPlayed=new ge;sampleRequest=new ct;onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return es.enumerateOutputDevices()}async setOutputDevice(e){await es.checkSinkIdSupport()&&(e?await this.context.setSinkId(e.deviceId):await this.context.setSinkId(""))}async getOutputDevice(){if(!await es.checkSinkIdSupport())return null;const e=this.context.sinkId;if(typeof e!="string"||e===""||e==="default")return null;let t=es.findKnownDevice(e);if(t)return t;const s=await this.enumerateOutputDevices();return t=s.find(i=>i.deviceId===e),t||(E.warning("WebAudio","Could not find output device in device list",e,s),null)}}class Kr{static _isRegistered=!1;static init(){Kr._isRegistered||(Kr._isRegistered=!0,registerProcessor("alphatab",class Gr extends AudioWorkletProcessor{static BufferSize=4096;_outputBuffer=new Float32Array(0);_circularBuffer;_bufferCount=0;_requestedBufferCount=0;_isStopped=!1;constructor(t){super(t),E.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(t.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/Gr.BufferSize),this._circularBuffer=new io(Gr.BufferSize*this._bufferCount),this.port.onmessage=this._handleMessage.bind(this)}_handleMessage(t){const s=t.data;switch(s.cmd){case Nt.CmdOutputAddSamples:const r=s.samples;this._circularBuffer.write(r,0,r.length),this._requestedBufferCount--;break;case Nt.CmdOutputResetSamples:this._circularBuffer.clear();break;case Nt.CmdOutputStop:this._isStopped=!0;break}}process(t,s,i){if(s.length!==1&&s[0].length!==2)return!1;const r=s[0][0],n=s[0][1];if(!r||!n)return!0;const o=r.length+n.length;let l=this._outputBuffer;l.length!==o&&(l=new Float32Array(o),this._outputBuffer=l);const h=this._circularBuffer.read(l,0,Math.min(l.length,this._circularBuffer.count));let c=0;const d=Math.min(r.length,h);for(let f=0;f<d;f++)r[f]=l[c++],n[f]=l[c++];if(h<r.length)for(let f=h;f<r.length;f++)r[f]=0,n[f]=0;return this.port.postMessage({cmd:Nt.CmdOutputSamplesPlayed,samples:h/oe.AudioChannels}),this._requestBuffers(),this._circularBuffer.count>0||!this._isStopped}_requestBuffers(){const t=this._bufferCount/2|0,s=t*Gr.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*Gr.BufferSize<s){for(let r=0;r<t;r++)this.port.postMessage({cmd:Nt.CmdOutputSampleRequest});this._requestedBufferCount+=t}}}))}}class th extends Us{_worklet=null;_bufferTimeInMilliseconds=0;_settings;constructor(e){super(),this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();const e=this.context;F.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this._handleMessage.bind(this),this.source.connect(this._worklet),this.source.start(0),this._worklet.connect(e.destination)},t=>{E.error("WebAudio",`Audio Worklet creation failed: reason=${t}`)})}_handleMessage(e){const t=e.data;switch(t.cmd){case Nt.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case Nt.CmdOutputSampleRequest:this.onSampleRequest();break}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:Nt.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){this._worklet?.port.postMessage({cmd:Nt.CmdOutputAddSamples,samples:F.prepareForPostMessage(e)})}resetSamples(){this._worklet?.port.postMessage({cmd:Nt.CmdOutputResetSamples})}}var Zi;(function(a){a[a.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",a[a.MultiTrack=1]="MultiTrack"})(Zi||(Zi={}));class ro{events=[];addEvent(e){if(this.events.length===0||e.tick>=this.events[this.events.length-1].tick)this.events.push(e);else{let t=this.events.length;for(;t>0&&this.events[t-1].tick>e.tick;)t--;this.events.splice(t,0,e)}}writeTo(e){const t=pt.empty();let s=0;for(const n of this.events){const o=n.tick-s;Ks.writeVariableInt(t,o),n.writeTo(t),s=n.tick}const i=new Uint8Array([77,84,114,107]);e.write(i,0,i.length);const r=t.toArray();B.writeInt32BE(e,r.length),e.write(r,0,r.length)}}class Ks{format=Zi.SingleTrackMultiChannel;division=x.QuarterTime;get events(){if(this.tracks.length===1)return this.tracks[0].events;const e=[];for(const t of this.tracks)this.events.push(...t.events);return e.sort((t,s)=>t.tick-s.tick),e}tracks=[];_ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new ro)}addEvent(e){this.format===Zi.SingleTrackMultiChannel?(this._ensureTracks(1),this.tracks[0].addEvent(e)):(this._ensureTracks(e.track+1),this.tracks[e.track].addEvent(e))}toBinary(){const e=pt.empty();return this.writeTo(e),e.toArray()}writeTo(e){const t=new Uint8Array([77,84,104,100]);e.write(t,0,t.length),B.writeInt32BE(e,6),B.writeInt16BE(e,this.format),B.writeInt16BE(e,this.tracks.length),B.writeInt16BE(e,this.division);for(const s of this.tracks)s.writeTo(e)}static writeVariableInt(e,t){const s=new Uint8Array(4);let i=0;do s[i++]=t&127,t>>=7;while(t>0);for(;i>0;)i--,i>0?e.writeByte(s[i]|128):e.writeByte(s[i])}}var Fe;(function(a){a[a.TimeSignature=88]="TimeSignature",a[a.NoteOn=128]="NoteOn",a[a.NoteOff=144]="NoteOff",a[a.ControlChange=176]="ControlChange",a[a.ProgramChange=192]="ProgramChange",a[a.TempoChange=81]="TempoChange",a[a.PitchBend=224]="PitchBend",a[a.PerNotePitchBend=96]="PerNotePitchBend",a[a.EndOfTrack=47]="EndOfTrack",a[a.AlphaTabRest=241]="AlphaTabRest",a[a.AlphaTabMetronome=242]="AlphaTabMetronome",a[a.SystemExclusive=240]="SystemExclusive",a[a.SystemExclusive2=247]="SystemExclusive2",a[a.Meta=255]="Meta"})(Fe||(Fe={}));class Zs{track;tick;type;constructor(e,t,s){this.track=e,this.tick=t,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class ao extends Zs{numerator;denominatorIndex;midiClocksPerMetronomeClick;thirtySecondNodesInQuarter;constructor(e,t,s,i,r,n){super(e,t,Fe.TimeSignature),this.track=e,this.tick=t,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=r,this.thirtySecondNodesInQuarter=n}writeTo(e){e.writeByte(255),e.writeByte(88),Ks.writeVariableInt(e,4),e.writeByte(this.numerator&255),e.writeByte(this.denominatorIndex&255),e.writeByte(this.midiClocksPerMetronomeClick&255),e.writeByte(this.thirtySecondNodesInQuarter&255)}}class ji extends Zs{static AlphaTabManufacturerId=125;static MetronomeEventId=0;static RestEventId=1;writeTo(e){e.writeByte(240);const t=pt.withCapacity(16);t.writeByte(ji.AlphaTabManufacturerId),this.writeEventData(t),t.writeByte(247),Ks.writeVariableInt(e,t.length),t.copyTo(e)}}class no extends ji{metronomeNumerator;metronomeDurationInTicks;metronomeDurationInMilliseconds;isMetronome=!0;constructor(e,t,s,i,r){super(e,t,Fe.AlphaTabMetronome),this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=r,this.metronomeDurationInTicks=i}writeEventData(e){e.writeByte(ji.MetronomeEventId),e.writeByte(this.metronomeNumerator),B.writeInt32LE(e,this.metronomeDurationInTicks),B.writeInt32LE(e,this.metronomeDurationInMilliseconds)}}class oo extends ji{channel;constructor(e,t,s){super(e,t,Fe.AlphaTabRest),this.channel=s}writeEventData(e){e.writeByte(ji.RestEventId),e.writeByte(this.channel)}}class lo extends Zs{channel;noteKey;noteVelocity;constructor(e,t,s,i,r,n){super(e,t,s),this.channel=i,this.noteKey=r,this.noteVelocity=n}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class ho extends lo{constructor(e,t,s,i,r){super(e,t,Fe.NoteOn,s,i,r)}writeTo(e){e.writeByte(this.channel&15|144),e.writeByte(this.noteKey&255),e.writeByte(this.noteVelocity&255)}}class co extends lo{constructor(e,t,s,i,r){super(e,t,Fe.NoteOff,s,i,r)}writeTo(e){e.writeByte(this.channel&15|128),e.writeByte(this.noteKey&255),e.writeByte(this.noteVelocity&255)}}class uo extends Zs{channel;controller;value;constructor(e,t,s,i,r){super(e,t,Fe.ControlChange),this.channel=s,this.controller=i,this.value=r}writeTo(e){e.writeByte(this.channel&15|176),e.writeByte(this.controller&255),e.writeByte(this.value&255)}get data1(){return this.controller}get data2(){return this.value}}class fo extends Zs{channel;program;constructor(e,t,s,i){super(e,t,Fe.ProgramChange),this.channel=s,this.program=i}writeTo(e){e.writeByte(this.channel&15|192),e.writeByte(this.program&255)}get data1(){return this.program}}class po extends Zs{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}beatsPerMinute=0;constructor(e,t){super(0,e,Fe.TempoChange),this.microSecondsPerQuarterNote=t}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(this.microSecondsPerQuarterNote&255)}}class go extends Zs{channel;value;constructor(e,t,s,i){super(e,t,Fe.PitchBend),this.channel=s,this.value=i}writeTo(e){e.writeByte(this.channel&15|224),e.writeByte(this.value&127),e.writeByte(this.value>>7&127)}get data1(){return this.value&127}get data2(){return this.value>>7&127}}class mo extends Zs{channel;noteKey;value;constructor(e,t,s,i,r){super(e,t,Fe.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=r}writeTo(e){throw new Ve(Oe.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class yo extends Zs{constructor(e,t){super(e,t,Fe.EndOfTrack)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}}class pr{eventIndex;event;isMetronome;time=0;constructor(e,t){this.eventIndex=e,this.event=t,this.isMetronome=this.event.type===Fe.AlphaTabMetronome}static newMetronomeEvent(e,t,s,i,r){const n=new no(0,t,s,i,r);return new pr(e,n)}}class gr{masterBarIndex=0;masterBarOccurence=0;synthBpm=0;synthTime=0;synthTick=0;syncTime=0;syncBpm=0;updateSyncBpm(e,t){const s=e-this.synthTime,i=t-this.syncTime,r=s/i*this.synthBpm;this.syncBpm=r}}class bo{bpm;ticks;time;constructor(e,t,s){this.bpm=e,this.ticks=t,this.time=s}}class cn{tempoChanges=[];tempoChangeIndex=0;syncPoints=[];firstProgramEventPerChannel=new Map;firstTimeSignatureNumerator=0;firstTimeSignatureDenominator=0;synthData=[];division=x.QuarterTime;eventIndex=0;currentTime=0;syncPointIndex=0;playbackRange=null;playbackRangeStartTime=0;playbackRangeEndTime=0;endTick=0;endTime=0;currentTempo=0;syncPointTempo=0}class _o{_synthesizer;_currentState;_mainState;_oneTimeState=null;_countInState=null;get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}constructor(e){this._synthesizer=e,this._mainState=new cn,this._currentState=this._mainState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){this._mainState.playbackRange=e,e&&(this._mainState.playbackRangeStartTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this._tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}isLooping=!1;get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}playbackSpeed=1;mainSeek(e){if(e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime)this._mainSilentProcess(e-this._mainState.currentTime);else if(e<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){const t=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(t)}this._mainSilentProcess(e)}}_mainSilentProcess(e){if(e<=0)return;const t=Date.now(),s=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this._fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(oe.MicroBufferSize);this._mainState.currentTime=s;const i=Date.now()-t;E.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}instrumentPrograms=new Set;percussionKeys=new Set;loadMidi(e){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){const t=new cn;this.percussionKeys.add(oe.MetronomeKey),t.tempoChanges=[],t.division=e.division,t.eventIndex=0,t.currentTime=0,t.synthData=[];let s=120,i=0,r=0,n=0,o=0,l=0,h=0,c=0,d=0;for(const f of e.events){const p=new pr(t.synthData.length,f);t.synthData.push(p);const g=f.tick-d;if(i+=g,r+=g*(6e4/(s*e.division)),p.time=r,d=f.tick,o>0)for(;h<i;){const m=pr.newMetronomeEvent(t.synthData.length,h,Math.floor(h/o)%n,o,l);t.synthData.push(m),m.time=c,h+=o,c+=l}if(f.type===Fe.TempoChange)s=f.beatsPerMinute,t.tempoChanges.push(new bo(s,i,r)),l=o*(6e4/(s*e.division));else if(f.type===Fe.TimeSignature){const m=f,b=Math.pow(2,m.denominatorIndex);n=m.numerator,o=t.division*(4/b)|0,l=o*(6e4/(s*e.division)),t.firstTimeSignatureDenominator===0&&(t.firstTimeSignatureNumerator=m.numerator,t.firstTimeSignatureDenominator=b)}else if(f.type===Fe.ProgramChange){const m=f,b=m.channel;t.firstProgramEventPerChannel.has(b)||t.firstProgramEventPerChannel.set(b,p),b===oe.PercussionChannel||this.instrumentPrograms.add(m.program)}else if(f.type===Fe.NoteOn){const m=f;m.channel===oe.PercussionChannel&&this.percussionKeys.add(m.noteKey)}}return t.currentTempo=t.tempoChanges.length>0?t.tempoChanges[0].bpm:s,t.syncPointTempo=t.currentTempo,t.synthData.sort((f,p)=>f.time>p.time?1:f.time<p.time?-1:f.eventIndex-p.eventIndex),t.endTime=r,t.endTick=i,t}fillMidiEventQueue(){return this._fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(e){for(;this._mainState.currentTime<e;)this._fillMidiEventQueueLimited(e-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(oe.MicroBufferSize);let t=!1;for(this._currentState.currentTime=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){const s=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(s),this._currentState.eventIndex++,t=!0}return t}_fillMidiEventQueueLimited(e){let t=oe.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this._internalEndTime;e>0&&(e<t&&(t=e),s=Math.min(this._internalEndTime,this._currentState.currentTime+e));let i=!1;for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(e){return this._tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainUpdateSyncPoints(e){const t=this._mainState;if(e.sort((s,i)=>s.synthTick-i.synthTick),t.syncPoints=[],e.length>=0){let s=120,i=0,r=0,n=0;for(let o=0;o<e.length;o++){const l=e[o];let h=0,c,d,f;if(o===0)c=s,d=0,f=0;else{const p=e[o-1];c=p.syncBpm,d=p.syncTime,f=p.synthTick}for(;n<t.tempoChanges.length&&t.tempoChanges[n].ticks<=l.synthTick;){if(h=t.tempoChanges[n].ticks-i,h>0){i+=h,r+=h*(6e4/(s*t.division));const p=(l.syncTime-d)/(l.synthTick-f),g=(i-f)*p+d,m=new gr;m.synthTick=i,m.synthBpm=s,m.synthTime=r,m.syncTime=g,m.syncBpm=c}s=t.tempoChanges[n].bpm,n++}h=l.synthTick-i,i+=h,r+=h*(6e4/(s*t.division)),t.syncPoints.push(l)}}t.syncPointIndex=0,t.syncPointTempo=t.syncPoints.length>0?t.syncPoints[0].syncBpm:t.currentTempo}currentTimePositionToTickPosition(e){const t=this._currentState;if(t.tempoChanges.length===0)return 0;e*=this.playbackSpeed,this._updateCurrentTempo(t,e);const s=t.tempoChanges[t.tempoChangeIndex],r=(e-s.time)/(6e4/(s.bpm*t.division))|0;return s.ticks+r+1}currentUpdateCurrentTempo(e){this._updateCurrentTempo(this._mainState,e*this.playbackSpeed)}_updateCurrentTempo(e,t){let s=e.tempoChangeIndex;for(t<e.tempoChanges[s].time&&(s=0);s+1<e.tempoChanges.length&&e.tempoChanges[s+1].time<=t;)s++;s!==e.tempoChangeIndex&&(e.tempoChangeIndex=s,e.currentTempo=e.tempoChanges[e.tempoChangeIndex].bpm,e.syncPoints.length===0&&(e.syncPointTempo=e.currentTempo))}currentUpdateSyncPoints(e){this._updateSyncPoints(this._mainState,e)}_updateSyncPoints(e,t){const s=e.syncPoints;if(s.length>0){let i=Math.min(e.syncPointIndex,s.length-1);for(t<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=t;)i++;i!==e.syncPointIndex&&(e.syncPointIndex=i,e.syncPointTempo=s[i].syncBpm)}else e.syncPointTempo=e.currentTempo}mainTimePositionFromBackingTrack(e,t){const s=this._mainState,i=s.syncPoints;if(e<0||i.length===0)return e;this._updateSyncPoints(this._mainState,e);const r=Math.min(s.syncPointIndex,i.length-1),n=i[r],o=e-n.syncTime;let l;if(r+1<i.length){const h=i[r+1],c=o/(h.syncTime-n.syncTime);l=(h.synthTime-n.synthTime)*c}else{const h=o/(t-n.syncTime);l=(s.endTime-n.synthTime)*h}return(n.synthTime+l)/this.playbackSpeed}mainTimePositionToBackingTrack(e,t){const s=this._mainState,i=s.syncPoints;if(e<0||i.length===0)return e;e*=this.playbackSpeed;let r=Math.min(s.syncPointIndex,i.length-1);for(e<i[r].synthTime&&(r=0);r+1<i.length&&i[r+1].synthTime<=e;)r++;const n=i[r],o=e-n.synthTime;let l;if(r+1<i.length){const h=i[r+1],c=o/(h.synthTime-n.synthTime),d=h.syncTime-n.syncTime;l=n.syncTime+d*c}else{const h=o/(s.endTime-n.synthTime),c=t-n.syncTime;l=n.syncTime+c*h}return l}_tickPositionToTimePositionWithSpeed(e,t,s){let i=0,r=120,n=0;for(const o of e.tempoChanges){if(t<o.ticks)break;i=o.time,r=o.bpm,n=o.ticks}return t-=n,i+=t*(6e4/(r*e.division)),i/s}get _internalEndTime(){return this.isPlayingMain?this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this._internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){const e=new cn;e.division=this._mainState.division;let t=120,s=4,i=4;this._mainState.eventIndex===0?(t=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,i=this._mainState.firstTimeSignatureDenominator):(t=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,i=this._synthesizer.timeSignatureDenominator),e.tempoChanges.push(new bo(t,0,0));const r=e.division*(4/i)|0,n=r*(6e4/(t*this._mainState.division));let o=0,l=0;for(let h=0;h<s;h++){const c=pr.newMetronomeEvent(e.synthData.length,o,h,r,n);e.synthData.push(c),c.time=l,o+=r,l+=n}e.synthData.sort((h,c)=>h.time>c.time?1:h.time<c.time?-1:h.eventIndex-c.eventIndex),e.endTime=l,e.endTick=o,e.currentTempo=t,e.syncPointTempo=t,this._countInState=e}}var vt;(function(a){a[a.Paused=0]="Paused",a[a.Playing=1]="Playing"})(vt||(vt={}));class er{state;stopped;constructor(e,t){this.state=e,this.stopped=t}}class js{currentTime;endTime;currentTick;endTick;isSeek;originalTempo=0;modifiedTempo=0;constructor(e,t,s,i,r,n,o){this.currentTime=e,this.endTime=t,this.currentTick=s,this.endTick=i,this.isSeek=r,this.originalTempo=n,this.modifiedTempo=o}}class ws{static HeaderSize=8;id="";size=0;static load(e,t,s){if(e&&ws.HeaderSize>e.size||s.position+ws.HeaderSize>=s.length||(t.id=B.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)||(t.size=B.readUInt32LE(s),e&&ws.HeaderSize+t.size>e.size))return!1;e&&(e.size-=ws.HeaderSize+t.size);const i=t.id==="RIFF",r=t.id==="LIST";return i&&e?!1:!i&&!r?!0:(t.id=B.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122?!1:(t.size-=4,!0))}}class sh{packetData;isBeginningOfStream;isEndOfStream;granulePosition;constructor(e,t,s,i){this.packetData=e,this.isBeginningOfStream=t,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(e){const t=this.packetData,s=new Uint8Array(t.length+e.length);s.set(t,0),s.set(e,t.length)}}var mr;(function(a){a[a.ContinuesPacket=1]="ContinuesPacket",a[a.BeginningOfStream=2]="BeginningOfStream",a[a.EndOfStream=4]="EndOfStream"})(mr||(mr={}));class ih{_readable;constructor(e){this._readable=e}read(){const e=[];for(;this._findAndReadPage(e););return e}_findAndReadPage(e){return this._seekPageHeader()?this._readPage(e):!1}_seekPageHeader(){for(let e=0;e<65536;e++){if(B.readInt32LE(this._readable)===1399285583)return!0;this._readable.position-=3}return!1}_readPage(e){const t=this._readable.readByte();if(t===-1||t!==0)return!1;const s=this._readable.readByte(),i=B.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);const r=this._readable.readByte();if(r===-1)return!1;const n=[];let o=0;for(let l=0;l<r;l++){const h=this._readable.readByte();o===n.length&&n.push(0),n[o]+=h,h<255&&o++}for(let l=0;l<n.length;l++){const h=new Uint8Array(n[l]);if(this._readable.read(h,0,h.length)!==h.length)return!1;if((s&mr.ContinuesPacket)!==0){if(e.length===0)throw new Ve(Oe.Format,"OGG: Continuation page without any previous packets");e[e.length-1].addData(h)}else{const d=new sh(h,(s&mr.BeginningOfStream)!==0&&l===0,(s&mr.EndOfStream)!==0&&l===n.length-1,i);e.push(d)}}return!0}}class rh{audioChannels=0;audioSampleRate=0;samples=new Float32Array(0);bitrateMaximum=0;bitrateNominal=0;bitrateMinimum=0;blocksize0=0;blocksize1=0}class So{value=0;bitsRead=0}class Zr{static _byteSize=8;_source;_bitBucket=0n;_bitCount=0n;_overflowBits=0n;constructor(e){this._source=e}readByte(){return this.readBits(Zr._byteSize)}readBit(){return this.readBits(1)===1}readBytes(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=this.readByte()&255;return t}readBits(e){if(e===0)return 0;const t=this.tryPeekBits(e);return this.skipBits(e),t.value}tryPeekBits(e){if(e<0||e>32)throw new Ve(Oe.General,"IO: Cannot read more than 32 bits in one go");if(e===0)return new So;const t=new So;for(;this._bitCount<e;){const i=BigInt(this._source.readByte());if(i===-1n)return t.bitsRead=Number(this._bitCount),t.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,t;this._bitBucket=(i&0xffn)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=i>>40n-this._bitCount&0xffn)}let s=this._bitBucket;return e<64&&(s=s&(1n<<BigInt(e))-1n),t.value=Number(s),t.bitsRead=e,t}skipBits(e){let t=BigInt(e);if(e!==0)if(this._bitCount>t){if(e>31?this._bitBucket=0n:this._bitBucket=this._bitBucket>>t,this._bitCount>32){const s=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-t-s,s>e&&(this._overflowBits=this._overflowBits>>t&0xffn)}this._bitCount-=t}else if(this._bitCount===t)this._bitBucket=0n,this._bitCount=0n;else{for(t-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;t>8;){if(this._source.readByte()===-1){t=0n;break}t-=8n}if(t>0){const s=BigInt(this._source.readByte());s===-1n||(this._bitBucket=s>>t,this._bitCount=8n-t)}}}}class ah{codebooks=[];timeDomainTransforms=[];floors=[];residues=[];mappings=[];modes=[]}class zs{static ilog(e){let t=0;for(;e>0;)++t,e>>=1;return t}static bitReverse(e,t=32){let s=BigInt(e);return s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(t),Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(e){const t=BigInt(e);let s=t&BigInt(2097151);const i=t&BigInt(2147483648),r=(t&BigInt(2145386496))>>21n;return i!==0n&&(s=-s),Number(s)*Math.pow(2,Number(r)-788)}}class nh{_data;constructor(e){this._data=e}get(e){return this._data[e]}}class dn{static instance=new dn;get(e){return e}}class oh{_lengths;_maxBits=0;_overflowList=null;_prefixList=null;_prefixBitLength=0;_lookupTable;dimensions=0;entries=0;mapType=0;constructor(e,t){if(e.readBits(24)!==5653314)throw new Ve(Oe.Format,"Vorbis: Book header had invalid signature!");this.dimensions=e.readBits(16),this.entries=e.readBits(24),this._lengths=new Int32Array(this.entries),this._initTree(e,t),this._initLookupTable(e)}get(e,t){return this._lookupTable[e*this.dimensions+t]}decodeScalar(e){let t=e.tryPeekBits(this._prefixBitLength);if(t.bitsRead===0)return-1;let s=this._prefixList[t.value];if(s!=null)return e.skipBits(s.length),s.value;if(t=e.tryPeekBits(this._maxBits),this._overflowList!==null)for(let i=0;i<this._overflowList.length;i++){s=this._overflowList[i];const r=t.value&s.mask;if(s.bits===r)return e.skipBits(s.length),s.value}return-1}_initTree(e,t){let s,i=0,r;if(e.readBit()){let n=e.readBits(5)+1;for(let o=0;o<this.entries;){let l=e.readBits(zs.ilog(this.entries-o));for(;--l>=0;)this._lengths[o++]=n;++n}i=0,s=!1,r=n}else{r=-1,s=e.readBit();for(let n=0;n<this.entries;n++)!s||e.readBit()?(this._lengths[n]=e.readBits(5)+1,++i):this._lengths[n]=-1,this._lengths[n]>r&&(r=this._lengths[n])}if(this._maxBits=r,r>-1){let n=null;s&&i>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this._lengths.subarray(0,this.entries),0),s=!1);let o;s?o=i:o=0;let l=null,h=null;if(s?o!==0&&(n=new Int32Array(o),h=new Int32Array(o),l=new Int32Array(o)):h=new Int32Array(this.entries),!this._computeCodewords(s,h,n,this._lengths,this.entries,l))throw new Ve(Oe.Format,"Vorbis: Failed to compute codewords");const c=l==null?dn.instance:new nh(l);t.generateTable(c,n??this._lengths,h),this._prefixList=t.prefixTree,this._prefixBitLength=t.tableBits,this._overflowList=t.overflowList}}_computeCodewords(e,t,s,i,r,n){const o=new Uint32Array(32);let l=0,h=0;for(l=0;l<r&&!(i[l]>0);++l);if(l===r)return!0;this._addEntry(e,t,s,0,l,h++,i[l],n);for(let c=1;c<=i[l];++c)o[c]=1<<32-c;for(let c=l+1;c<r;++c){let d=i[c];if(d<=0)continue;for(;d>0&&o[d]===0;)--d;if(d===0)return!1;const f=o[d];if(o[d]=0,this._addEntry(e,t,s,zs.bitReverse(f),c,h++,i[c],n),d!==i[c])for(let p=i[c];p>d;--p)o[p]=f+(1<<32-p)}return!0}_addEntry(e,t,s,i,r,n,o,l){e?(t[n]=i,s[n]=o,l[n]=r):t[r]=i}_initLookupTable(e){if(this.mapType=e.readBits(4),this.mapType===0)return;const t=zs.convertFromVorbisFloat32(e.readBits(32)),s=zs.convertFromVorbisFloat32(e.readBits(32)),i=e.readBits(4)+1,r=e.readBit();let n=this.entries*this.dimensions;const o=new Float32Array(n);this.mapType===1&&(n=this._lookup1Values());const l=new Uint32Array(n);for(let h=0;h<n;h++)l[h]=e.readBits(i);if(this.mapType===1)for(let h=0;h<this.entries;h++){let c=0,d=1;for(let f=0;f<this.dimensions;f++){const p=h/d%n|0,g=l[p]*s+t+c;o[h*this.dimensions+f]=g,r&&(c=g),d*=n}}else for(let h=0;h<this.entries;h++){let c=0,d=h*this.dimensions;for(let f=0;f<this.dimensions;f++){const p=l[d]*s+t+c;o[h*this.dimensions+f]=p,r&&(c=p),++d}}this._lookupTable=o}_lookup1Values(){let e=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(e+1,this.dimensions))<=this.entries&&++e,e}}class lh{value=0;length=0;bits=0;mask=0}class jr{static maxTableBits=10;tableBits=0;prefixTree=[];overflowList=null;generateTable(e,t,s){const i=new Array(t.length);let r=0;for(let h=0;h<i.length;h++){const c=new lh;c.value=e.get(h),c.length=t[h]<=0?99999:t[h],c.bits=s[h],c.mask=(1<<t[h])-1,i[h]=c,t[h]>0&&r<t[h]&&(r=t[h])}i.sort((h,c)=>{const d=h.length-c.length;return d===0?h.bits-c.bits:d});const n=r>jr.maxTableBits?jr.maxTableBits:r,o=[];let l=null;for(let h=0;h<i.length&&i[h].length<99999;h++){const c=i[h].length;if(c>n)for(l=[];h<i.length&&i[h].length<99999;h++)l.push(i[h]);else{const d=1<<n-c,f=i[h];for(let p=0;p<d;p++){const g=p<<c|f.bits;for(;o.length<=g;)o.push(null);o[g]=f}}}for(;o.length<1<<n;)o.push(null);this.tableBits=n,this.prefixTree=o,this.overflowList=l}}class hh{constructor(e){e.readBits(16)}}class ch{coeff;amp=0;get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1;constructor(e){this.coeff=e}}class ea{_order;_rate;_barkMapSize;_ampBits;_ampOfs;_ampDiv;_books;_bookBits;_wMap;_barkMaps;constructor(e,t,s,i){if(this._order=e.readBits(8),this._rate=e.readBits(16),this._barkMapSize=e.readBits(16),this._ampBits=e.readBits(6),this._ampOfs=e.readBits(8),this._books=new Array(e.readBits(4)+1),this._order<1||this._rate<1||this._barkMapSize<1||this._books.length===0)throw new Ve(Oe.Format,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let r=0;r<this._books.length;r++){const n=e.readBits(8);if(n<0||n>=i.length)throw new Ve(Oe.Format,"Vorbis: Invalid Floor0 Data");const o=i[n];if(o.mapType===0||o.dimensions<1)throw new Ve(Oe.Format,"Vorbis: Invalid Floor0 Data");this._books[r]=o}this._bookBits=zs.ilog(this._books.length),this._barkMaps=new Map([[t,this._synthesizeBarkCurve(t/2)],[s,this._synthesizeBarkCurve(s/2)]]),this._wMap=new Map([[t,this._synthesizeWDelMap(t/2)],[s,this._synthesizeWDelMap(s/2)]])}_synthesizeBarkCurve(e){const t=this._barkMapSize/ea._toBARK(this._rate/2),s=new Int32Array(e+1);for(let i=0;i<e-1;i++)s[i]=Math.min(this._barkMapSize-1,Math.floor(ea._toBARK(this._rate/2/e*i)*t));return s[e]=-1,s}static _toBARK(e){return 13.1*Math.atan(74e-5*e)+2.24*Math.atan(185e-10*e*e)+1e-4*e}_synthesizeWDelMap(e){const t=Math.PI/this._barkMapSize,s=new Float32Array(e);for(let i=0;i<e;i++)s[i]=2*Math.cos(t*i);return s}unpack(e,t,s){const i=new ch(new Float32Array(this._order+1));if(i.amp=e.readBits(this._ampBits),i.amp>0){i.amp=i.amp/this._ampDiv*this._ampOfs;const r=e.readBits(this._bookBits);if(r>=this._books.length)return i.amp=0,i;const n=this._books[r];for(let l=0;l<this._order;){const h=n.decodeScalar(e);if(h===-1)return i.amp=0,i;for(let c=0;l<this._order&&c<n.dimensions;c++,l++)i.coeff[l]=n.get(h,c)}let o=0;for(let l=0;l<this._order;){for(let h=0;l<this._order&&h<n.dimensions;l++,h++)i.coeff[l]+=o;o=i.coeff[l-1]}}return i}apply(e,t,s){const i=e,r=t/2;if(i.amp>0){const n=this._barkMaps.get(t),o=this._wMap.get(t);let l=0;for(l=0;l<this._order;l++)i.coeff[l]=2*Math.cos(i.coeff[l]);for(l=0;l<r;){let h=0;const c=n[l];let d=.5,f=.5;const p=o[c];for(h=1;h<this._order;h+=2)f*=p-i.coeff[h-1],d*=p-i.coeff[h];for(h===this._order?(f*=p-i.coeff[h-1],d*=d*(4-p*p),f*=f):(d*=d*(2-p),f*=f*(2+p)),f=i.amp/Math.sqrt(d+f)-this._ampOfs,f=Math.exp(f*.11512925),s[l]*=f;n[++l]===c;)s[l]*=f}}else s.fill(0,0,r)}}class dh{posts=new Int32Array(64);postCount=0;get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}forceEnergy=!1;forceNoEnergy=!1}class tr{static _rangeLookup=[256,128,86,64];static _yBitsLookup=[8,7,7,6];_partitionClass;_classDimensions;_classSubclasses;_xList;_classMasterBookIndex;_hNeigh;_lNeigh;_sortIdx;_multiplier;_range;_yBits;_classMasterbooks;_subclassBooks;_subclassBookIndex;constructor(e,t){let s=-1;this._partitionClass=new Int32Array(e.readBits(5));for(let n=0;n<this._partitionClass.length;n++)this._partitionClass[n]=e.readBits(4),this._partitionClass[n]>s&&(s=this._partitionClass[n]);++s,this._classDimensions=new Int32Array(s),this._classSubclasses=new Int32Array(s),this._classMasterbooks=new Array(s),this._classMasterBookIndex=new Int32Array(s),this._subclassBooks=new Array(s),this._subclassBookIndex=new Array(s);for(let n=0;n<s;n++){this._classDimensions[n]=e.readBits(3)+1,this._classSubclasses[n]=e.readBits(2),this._classSubclasses[n]>0&&(this._classMasterBookIndex[n]=e.readBits(8),this._classMasterbooks[n]=t[this._classMasterBookIndex[n]]),this._subclassBooks[n]=new Array(1<<this._classSubclasses[n]),this._subclassBookIndex[n]=new Int32Array(this._subclassBooks[n].length);for(let o=0;o<this._subclassBooks[n].length;o++){const l=e.readBits(8)-1;l>=0&&(this._subclassBooks[n][o]=t[l]),this._subclassBookIndex[n][o]=l}}this._multiplier=e.readBits(2),this._range=tr._rangeLookup[this._multiplier],this._yBits=tr._yBitsLookup[this._multiplier],++this._multiplier;const i=e.readBits(4),r=[];r.push(0),r.push(1<<i);for(let n=0;n<this._partitionClass.length;n++){const o=this._partitionClass[n];for(let l=0;l<this._classDimensions[o];l++)r.push(e.readBits(i))}this._xList=new Int32Array(r),this._lNeigh=new Int32Array(r.length),this._hNeigh=new Int32Array(r.length),this._sortIdx=new Int32Array(r.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let n=2;n<this._lNeigh.length;n++){this._lNeigh[n]=0,this._hNeigh[n]=1,this._sortIdx[n]=n;for(let o=2;o<n;o++){const l=this._xList[o];l<this._xList[n]?l>this._xList[this._lNeigh[n]]&&(this._lNeigh[n]=o):l<this._xList[this._hNeigh[n]]&&(this._hNeigh[n]=o)}}for(let n=0;n<this._sortIdx.length-1;n++)for(let o=n+1;o<this._sortIdx.length;o++){if(this._xList[n]===this._xList[o])throw new Ve(Oe.Format,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[n]]>this._xList[this._sortIdx[o]]){const l=this._sortIdx[n];this._sortIdx[n]=this._sortIdx[o],this._sortIdx[o]=l}}}unpack(e,t,s){const i=new dh;if(e.readBit()){let r=2;i.posts[0]=e.readBits(this._yBits),i.posts[1]=e.readBits(this._yBits);for(let n=0;n<this._partitionClass.length;n++){const o=this._partitionClass[n],l=this._classDimensions[o],h=this._classSubclasses[o],c=(1<<h)-1;let d=0;if(h>0&&(d=this._classMasterbooks[o].decodeScalar(e),d===-1)){r=0;break}for(let f=0;f<l;f++){const p=this._subclassBooks[o][d&c];if(d=d>>h,p!=null&&(i.posts[r]=p.decodeScalar(e),i.posts[r]===-1)){r=0,n=this._partitionClass.length;break}++r}}i.postCount=r}return i}apply(e,t,s){const i=e,r=t/2;if(i.postCount>0){const n=this._unwrapPosts(i);let o=0,l=i.posts[0]*this._multiplier;for(let h=1;h<i.postCount;h++){const c=this._sortIdx[h];if(n[c]){const d=this._xList[c],f=i.posts[c]*this._multiplier;o<r&&this._renderLineMulti(o,l,Math.min(d,r),f,s),o=d,l=f}if(o>=r)break}o<r&&this._renderLineMulti(o,l,r,l,s)}else s.fill(0,0,r)}_unwrapPosts(e){const t=new Array(64);t.fill(!1),t[0]=!0,t[1]=!0;const s=new Int32Array(64);s[0]=e.posts[0],s[1]=e.posts[1];for(let i=2;i<e.postCount;i++){const r=this._lNeigh[i],n=this._hNeigh[i],o=this._renderPoint(this._xList[r],s[r],this._xList[n],s[n],this._xList[i]),l=e.posts[i],h=this._range-o,c=o;let d;h<c?d=h*2:d=c*2,l!==0?(t[r]=!0,t[n]=!0,t[i]=!0,l>=d?h>c?s[i]=l-c+o:s[i]=o-l+h-1:l%2===1?s[i]=o-(l+1)/2:s[i]=o+l/2):(t[i]=!1,s[i]=o)}for(let i=0;i<e.postCount;i++)e.posts[i]=s[i];return t}_renderPoint(e,t,s,i,r){const n=i-t,o=s-e,c=Math.abs(n)*(r-e)/o|0;return n<0?t-c:t+c}_renderLineMulti(e,t,s,i,r){const n=i-t,o=s-e;let l=Math.abs(n);const h=1-(n>>31&1)*2,c=n/o|0;let d=e,f=t,p=-o;for(r[e]*=tr._inverseDbTable[t],l-=Math.abs(c)*o;++d<s;)f+=c,p+=l,p>=0&&(p-=o,f+=h),r[d]*=tr._inverseDbTable[f]}static _inverseDbTable=new Float32Array([10649863e-14,11341951e-14,12079015e-14,12863978e-14,13699951e-14,14590251e-14,15538408e-14,16548181e-14,17623575e-14,18768855e-14,19988561e-14,2128753e-13,22670913e-14,24144197e-14,25713223e-14,27384213e-14,29163793e-14,31059021e-14,33077411e-14,35226968e-14,37516214e-14,39954229e-14,4255068e-13,45315863e-14,48260743e-14,51396998e-14,54737065e-14,58294187e-14,62082472e-14,66116941e-14,70413592e-14,74989464e-14,79862701e-14,8505263e-13,90579828e-14,96466216e-14,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1])}class uh{floor;constructor(e,t,s,i){const r=e.readBits(16);switch(r){case 0:this.floor=new ea(e,t,s,i);break;case 1:this.floor=new tr(e,i);break;default:throw new Ve(Oe.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(e,t,s){this.floor.apply(e,t,s)}unpack(e,t,s){return this.floor.unpack(e,t,s)}}class yr{_channels;_begin;_end;_partitionSize;_classifications;_maxStages;_books;_classBook;_cascade;_decodeMap;constructor(e,t,s){this._begin=e.readBits(24),this._end=e.readBits(24),this._partitionSize=e.readBits(24)+1,this._classifications=e.readBits(6)+1,this._classBook=s[e.readBits(8)],this._cascade=new Int32Array(this._classifications);let i=0;for(let d=0;d<this._classifications;d++){const f=e.readBits(3);e.readBit()?this._cascade[d]=e.readBits(5)<<3|f:this._cascade[d]=f,i+=yr._icount(this._cascade[d])}const r=new Int32Array(i);for(let d=0;d<i;d++)if(r[d]=e.readBits(8),s[r[d]].mapType===0)throw new Ve(Oe.Format,"Vorbis: Invalid Residue 0");const n=this._classBook.entries;let o=this._classBook.dimensions,l=1;for(;o>0;){if(l*=this._classifications,l>n)throw new Ve(Oe.Format,"Vorbis: Invalid Residue 0");--o}this._books=new Array(this._classifications),i=0;let h=0,c;for(let d=0;d<this._classifications;d++)if(c=zs.ilog(this._cascade[d]),this._books[d]=new Array(c),c>0){h=Math.max(h,c);for(let f=0;f<c;f++)(this._cascade[d]&1<<f)>0&&(this._books[d][f]=s[r[i++]])}this._maxStages=h,this._decodeMap=new Array(l);for(let d=0;d<l;d++){let f=d,p=l/this._classifications|0;this._decodeMap[d]=new Int32Array(this._classBook.dimensions);for(let g=0;g<this._classBook.dimensions;g++){const m=f/p|0;f-=m*p,p=p/this._classifications|0,this._decodeMap[d][g]=m}}this._channels=t}static _icount(e){let t=0;for(;e!==0;)t+=e&1,e>>=1;return t}decode(e,t,s,i){const n=(this._end<s/2?this._end:s/2)-this._begin;if(n>0&&t.indexOf(!1)!==-1){const o=n/this._partitionSize,l=(o+this._classBook.dimensions-1)/this._classBook.dimensions|0,h=[];for(let c=0;c<this._channels;c++)h.push(new Array(l));for(let c=0;c<this._maxStages;c++)for(let d=0,f=0;d<o;f++){if(c===0)for(let p=0;p<this._channels;p++){const g=this._classBook.decodeScalar(e);if(g>=0&&g<this._decodeMap.length)h[p][f]=this._decodeMap[g];else{d=o,c=this._maxStages;break}}for(let p=0;d<o&&p<this._classBook.dimensions;p++,d++){const g=this._begin+d*this._partitionSize;for(let m=0;m<this._channels;m++){const b=h[m][f][p];if((this._cascade[b]&1<<c)!==0){const S=this._books[b][c];if(S&&this.writeVectors(S,e,i,m,g,this._partitionSize)){d=o,c=this._maxStages;break}}}}}}}writeVectors(e,t,s,i,r,n){const o=s[i],l=n/e.dimensions,h=new Int32Array(l);for(let c=0;c<l;c++)if(h[c]=e.decodeScalar(t),h[c]===-1)return!0;for(let c=0;c<e.dimensions;c++)for(let d=0;d<l;d++,r++)o[r]+=e.get(h[d],c);return!1}}class fh extends yr{writeVectors(e,t,s,i,r,n){const o=s[i];for(let l=0;l<n;){const h=e.decodeScalar(t);if(h===-1)return!0;for(let c=0;c<e.dimensions;l++,c++)o[r+l]+=e.get(h,c)}return!1}}class ph extends yr{_realChannels;constructor(e,t,s){super(e,1,s),this._realChannels=t}decode(e,t,s,i){super.decode(e,t,s*this._realChannels,i)}writeVectors(e,t,s,i,r,n){let o=0;r/=this._realChannels;for(let l=0;l<n;){const h=e.decodeScalar(t);if(h===-1)return!0;for(let c=0;c<e.dimensions;c++,l++)s[o][r]+=e.get(h,c),++o===this._realChannels&&(o=0,r++)}return!1}}class gh{residue;constructor(e,t,s){const i=e.readBits(16);switch(i){case 0:this.residue=new yr(e,t,s);break;case 1:this.residue=new fh(e,t,s);break;case 2:this.residue=new ph(e,t,s);break;default:throw new Ve(Oe.Format,`Vorbis: Invalid Residue type: ${i}`)}}decode(e,t,s,i){this.residue.decode(e,t,s,i)}}class mh{_mdct;_couplingAngle;_couplingMangitude;_submapFloor;_submapResidue;_channelFloor;_channelResidue;constructor(e,t,s,i,r){if(e.readBits(16)!==0)throw new Ve(Oe.Format,"Vorbis: Invalid mapping type!");let o=1;e.readBit()&&(o+=e.readBits(4));let l=0;e.readBit()&&(l=e.readBits(8)+1);const h=zs.ilog(t-1);this._couplingAngle=new Int32Array(l),this._couplingMangitude=new Int32Array(l);for(let d=0;d<l;d++){const f=e.readBits(h),p=e.readBits(h);if(f===p||f>t-1||p>t-1)throw new Ve(Oe.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[d]=p,this._couplingMangitude[d]=f}if(e.readBits(2)!==0)throw new Ve(Oe.Format,"Vorbis: Reserved bits not 0 in mapping header.");const c=new Int32Array(t);if(o>1){for(let d=0;d<t;d++)if(c[d]=e.readBits(4),c[d]>o)throw new Ve(Oe.Format,"Vorbis: Invalid channel mux submap index in mapping header!")}this._submapFloor=new Array(o),this._submapResidue=new Array(o);for(let d=0;d<o;d++){e.skipBits(8);const f=e.readBits(8);if(f>=s.length)throw new Ve(Oe.Format,"Vorbis: Invalid floor number in mapping header!");const p=e.readBits(8);if(p>=i.length)throw new Ve(Oe.Format,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[d]=s[f],this._submapResidue[d]=i[p]}this._channelFloor=new Array(t),this._channelResidue=new Array(t);for(let d=0;d<t;d++)this._channelFloor[d]=this._submapFloor[c[d]],this._channelResidue[d]=this._submapResidue[c[d]];this._mdct=r}decodePacket(e,t,s){const i=t>>1,r=new Array(this._channelFloor.length),n=new Array(this._channelFloor.length);n.fill(!1);for(let o=0;o<this._channelFloor.length;o++)r[o]=this._channelFloor[o].unpack(e,t,o),n[o]=!r[o].executeChannel,s[o].fill(0,0,i);for(let o=0;o<this._couplingAngle.length;o++)(r[this._couplingAngle[o]].executeChannel||r[this._couplingMangitude[o]].executeChannel)&&(r[this._couplingAngle[o]].forceEnergy=!0,r[this._couplingMangitude[o]].forceEnergy=!0);for(let o=0;o<this._submapFloor.length;o++){for(let l=0;l<this._channelFloor.length;l++)(this._submapFloor[o]!==this._channelFloor[l]||this._submapResidue[o]!==this._channelResidue[l])&&(r[l].forceNoEnergy=!0);this._submapResidue[o].decode(e,n,t,s)}for(let o=this._couplingAngle.length-1;o>=0;o--)if(r[this._couplingAngle[o]].executeChannel||r[this._couplingMangitude[o]].executeChannel){const l=s[this._couplingMangitude[o]],h=s[this._couplingAngle[o]];for(let c=0;c<i;c++){let d,f;const p=l[c],g=h[c];p>0?g>0?(d=p,f=p-g):(f=p,d=p+g):g>0?(d=p,f=p+g):(f=p,d=p-g),l[c]=d,h[c]=f}}for(let o=0;o<this._channelFloor.length;o++)r[o].executeChannel?(this._channelFloor[o].apply(r[o],t,s[o]),this._mdct.reverse(s[o],t)):s[o].fill(0,i,i*2)}}class ko{packetStartIndex=0;packetTotalLength=0;packetValidLength=0}class yh{overlapInfo=new ko;windowIndex=0}class bh{samplePosition=null;constructor(e=null){this.samplePosition=e}}class as{static _piHalf=3.1415926539/2;_channels;_blockFlag;_blockSize;_mapping;_windows;_overlapInfo=null;constructor(e,t,s,i,r){if(this._channels=t,this._blockFlag=e.readBit(),e.readBits(32)!==0)throw new Ve(Oe.Format,"Vorbis: Mode header had invalid window or transform type!");const n=e.readBits(8);if(n>=r.length)throw new Ve(Oe.Format,"Vorbis: Mode header had invalid mapping index!");this._mapping=r[n],this._blockFlag?(this._blockSize=i,this._windows=[as._calcWindow(s,i,s),as._calcWindow(i,i,s),as._calcWindow(s,i,i),as._calcWindow(i,i,i)],this._overlapInfo=[as._calcOverlap(s,i,s),as._calcOverlap(i,i,s),as._calcOverlap(s,i,i),as._calcOverlap(i,i,i)]):(this._blockSize=s,this._windows=[as._calcWindow(s,s,s)])}decode(e,t){const s=this._getPacketInfo(e);this._mapping.decodePacket(e,this._blockSize,t);const i=this._windows[s.windowIndex];for(let r=0;r<this._blockSize;r++)for(let n=0;n<this._channels;n++)t[n][r]*=i[r];return s.overlapInfo}_getPacketInfo(e){const t=new yh;if(this._blockFlag){const s=e.readBit(),i=e.readBit();t.windowIndex=(s?1:0)+(i?2:0);const r=this._overlapInfo[t.windowIndex];t.overlapInfo.packetStartIndex=r.packetStartIndex,t.overlapInfo.packetValidLength=r.packetValidLength,t.overlapInfo.packetTotalLength=r.packetTotalLength}else t.windowIndex=0,t.overlapInfo.packetStartIndex=0,t.overlapInfo.packetValidLength=this._blockSize/2,t.overlapInfo.packetTotalLength=this._blockSize;return t}static _calcWindow(e,t,s){const i=new Float32Array(t),r=e/2,n=t,o=s/2,l=n/4-r/2,h=n-n/4-o/2;for(let c=0;c<r;c++){let d=Math.sin((c+.5)/r*as._piHalf);d*=d,i[l+c]=Math.sin(d*as._piHalf)}for(let c=l+r;c<h;c++)i[c]=1;for(let c=0;c<o;c++){let d=Math.sin((o-c-.5)/o*as._piHalf);d*=d,i[h+c]=Math.sin(d*as._piHalf)}return i}static _calcOverlap(e,t,s){const i=e/4,r=s/4,n=t/4-i,o=t/4*3+r,l=o-r*2,h=new ko;return h.packetStartIndex=n,h.packetValidLength=l,h.packetTotalLength=o,h}}class gi{static _pi=3.141592653589793;_n;_n2;_n4;_n8;_ld;_a;_b;_c;_bitrev;constructor(e){this._n=e,this._n2=e>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=zs.ilog(e)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let t=0,s=0;for(;t<this._n4;++t,s+=2)this._a[s]=Math.cos(4*t*gi._pi/e),this._a[s+1]=-Math.sin(4*t*gi._pi/e),this._b[s]=Math.cos((s+1)*gi._pi/e/2)*.5,this._b[s+1]=Math.sin((s+1)*gi._pi/e/2)*.5;for(t=0,s=0;t<this._n8;++t,s+=2)this._c[s]=Math.cos(2*(s+1)*gi._pi/e),this._c[s+1]=-Math.sin(2*(s+1)*gi._pi/e);this._bitrev=new Uint16Array(this._n8);for(let i=0;i<this._n8;++i)this._bitrev[i]=de.int32ToUint16(zs.bitReverse(i,this._ld-3)<<2)}calcReverse(e){let t,s;const i=new Float32Array(this._n2);{let n=this._n2-2,o=0,l=0;const h=this._n2;for(;l!==h;)i[n+1]=e[l]*this._a[o]-e[l+2]*this._a[o+1],i[n]=e[l]*this._a[o+1]+e[l+2]*this._a[o],n-=2,o+=2,l+=4;for(l=this._n2-3;n>=0;)i[n+1]=-e[l+2]*this._a[o]- -e[l]*this._a[o+1],i[n]=-e[l+2]*this._a[o+1]+-e[l]*this._a[o],n-=2,o+=2,l-=4}t=e,s=i;{let n=this._n2-8,o=this._n4,l=0,h=this._n4,c=0;for(;n>=0;){let d,f;f=s[o+1]-s[l+1],d=s[o]-s[l],t[h+1]=s[o+1]+s[l+1],t[h]=s[o]+s[l],t[c+1]=f*this._a[n+4]-d*this._a[n+5],t[c]=d*this._a[n+4]+f*this._a[n+5],f=s[o+3]-s[l+3],d=s[o+2]-s[l+2],t[h+3]=s[o+3]+s[l+3],t[h+2]=s[o+2]+s[l+2],t[c+3]=f*this._a[n]-d*this._a[n+1],t[c+2]=d*this._a[n]+f*this._a[n+1],n-=8,h+=4,c+=4,o+=4,l+=4}}this._step3Iter0Loop(this._n>>4,t,this._n2-1-this._n4*0,-this._n8),this._step3Iter0Loop(this._n>>4,t,this._n2-1-this._n4*1,-this._n8),this._step3InnerRLoop(this._n>>5,t,this._n2-1-this._n8*0,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-this._n8*1,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-this._n8*2,-(this._n>>4),16),this._step3InnerRLoop(this._n>>5,t,this._n2-1-this._n8*3,-(this._n>>4),16);let r=2;for(;r<this._ld-3>>1;++r){const n=this._n>>r+2,o=n>>1,l=1<<r+1;for(let h=0;h<l;++h)this._step3InnerRLoop(this._n>>r+4,t,this._n2-1-n*h,-o,1<<r+3)}for(;r<this._ld-6;++r){const n=this._n>>r+2,o=1<<r+3,l=n>>1,h=this._n>>r+6,c=1<<r+1;let d=this._n2-1,f=0;for(let p=h;p>0;--p)this._step3InnerSLoop(c,t,d,-l,f,o,n),f+=o*4,d-=8}this._step3InnerSLoopLd654(this._n>>5,t,this._n2-1,this._n);{let n=0,o=this._n4-4,l=this._n2-4;for(;o>=0;){let h;h=this._bitrev[n],s[l+3]=t[h],s[l+2]=t[h+1],s[o+3]=t[h+2],s[o+2]=t[h+3],h=this._bitrev[n+1],s[l+1]=t[h],s[l]=t[h+1],s[o+1]=t[h+2],s[o]=t[h+3],o-=4,l-=4,n+=2}}{let n=0,o=0,l=this._n2-4;for(;o<l;){let h,c,d,f,p,g;h=s[o]-s[l+2],c=s[o+1]+s[l+3],d=this._c[n+1]*h+this._c[n]*c,f=this._c[n+1]*c-this._c[n]*h,p=s[o]+s[l+2],g=s[o+1]-s[l+3],s[o]=p+d,s[o+1]=g+f,s[l+2]=p-d,s[l+3]=f-g,h=s[o+2]-s[l],c=s[o+3]+s[l+1],d=this._c[n+3]*h+this._c[n+2]*c,f=this._c[n+3]*c-this._c[n+2]*h,p=s[o+2]+s[l],g=s[o+3]-s[l+1],s[o+2]=p+d,s[o+3]=g+f,s[l]=p-d,s[l+1]=f-g,n+=4,o+=4,l-=4}}{let n=this._n2-8,o=this._n2-8,l=0,h=this._n2-4,c=this._n2,d=this._n-4;for(;o>=0;){let f,p,g,m;m=i[o+6]*this._b[n+7]-i[o+7]*this._b[n+6],g=-i[o+6]*this._b[n+6]-i[o+7]*this._b[n+7],e[l]=m,e[h+3]=-m,e[c]=g,e[d+3]=g,p=i[o+4]*this._b[n+5]-i[o+5]*this._b[n+4],f=-i[o+4]*this._b[n+4]-i[o+5]*this._b[n+5],e[l+1]=p,e[h+2]=-p,e[c+1]=f,e[d+2]=f,m=i[o+2]*this._b[n+3]-i[o+3]*this._b[n+2],g=-i[o+2]*this._b[n+2]-i[o+3]*this._b[n+3],e[l+2]=m,e[h+1]=-m,e[c+2]=g,e[d+1]=g,p=i[o]*this._b[n+1]-i[o+1]*this._b[n],f=-i[o]*this._b[n]-i[o+1]*this._b[n+1],e[l+3]=p,e[h]=-p,e[c+3]=f,e[d]=f,n-=8,o-=8,l+=4,c+=4,h-=4,d-=4}}}_step3InnerRLoop(e,t,s,i,r){let n,o,l=s,h=l+i,c=0;for(let d=e>>2;d>0;--d)n=t[l]-t[h],o=t[l-1]-t[h-1],t[l]+=t[h],t[l-1]+=t[h-1],t[h]=n*this._a[c]-o*this._a[c+1],t[h-1]=o*this._a[c]+n*this._a[c+1],c+=r,n=t[l-2]-t[h-2],o=t[l-3]-t[h-3],t[l-2]+=t[h-2],t[l-3]+=t[h-3],t[h-2]=n*this._a[c]-o*this._a[c+1],t[h-3]=o*this._a[c]+n*this._a[c+1],c+=r,n=t[l-4]-t[h-4],o=t[l-5]-t[h-5],t[l-4]+=t[h-4],t[l-5]+=t[h-5],t[h-4]=n*this._a[c]-o*this._a[c+1],t[h-5]=o*this._a[c]+n*this._a[c+1],c+=r,n=t[l-6]-t[h-6],o=t[l-7]-t[h-7],t[l-6]+=t[h-6],t[l-7]+=t[h-7],t[h-6]=n*this._a[c]-o*this._a[c+1],t[h-7]=o*this._a[c]+n*this._a[c+1],c+=r,l-=8,h-=8}_step3Iter0Loop(e,t,s,i){let r=s,n=r+i,o=0;for(let l=e>>2;l>0;--l){let h,c;h=t[r]-t[n],c=t[r-1]-t[n-1],t[r]+=t[n],t[r-1]+=t[n-1],t[n]=h*this._a[o]-c*this._a[o+1],t[n-1]=c*this._a[o]+h*this._a[o+1],o+=8,h=t[r-2]-t[n-2],c=t[r-3]-t[n-3],t[r-2]+=t[n-2],t[r-3]+=t[n-3],t[n-2]=h*this._a[o]-c*this._a[o+1],t[n-3]=c*this._a[o]+h*this._a[o+1],o+=8,h=t[r-4]-t[n-4],c=t[r-5]-t[n-5],t[r-4]+=t[n-4],t[r-5]+=t[n-5],t[n-4]=h*this._a[o]-c*this._a[o+1],t[n-5]=c*this._a[o]+h*this._a[o+1],o+=8,h=t[r-6]-t[n-6],c=t[r-7]-t[n-7],t[r-6]+=t[n-6],t[r-7]+=t[n-7],t[n-6]=h*this._a[o]-c*this._a[o+1],t[n-7]=c*this._a[o]+h*this._a[o+1],o+=8,r-=8,n-=8}}_step3InnerSLoop(e,t,s,i,r,n,o){const l=this._a[r],h=this._a[r+1],c=this._a[r+n],d=this._a[r+n+1],f=this._a[r+n*2],p=this._a[r+n*2+1],g=this._a[r+n*3],m=this._a[r+n*3+1];let b,S,T=s,C=T+i;for(let v=e;v>0;--v)b=t[T]-t[C],S=t[T-1]-t[C-1],t[T]+=t[C],t[T-1]+=t[C-1],t[C]=b*l-S*h,t[C-1]=S*l+b*h,b=t[T-2]-t[C-2],S=t[T-3]-t[C-3],t[T-2]+=t[C-2],t[T-3]+=t[C-3],t[C-2]=b*c-S*d,t[C-3]=S*c+b*d,b=t[T-4]-t[C-4],S=t[T-5]-t[C-5],t[T-4]+=t[C-4],t[T-5]+=t[C-5],t[C-4]=b*f-S*p,t[C-5]=S*f+b*p,b=t[T-6]-t[C-6],S=t[T-7]-t[C-7],t[T-6]+=t[C-6],t[T-7]+=t[C-7],t[C-6]=b*g-S*m,t[C-7]=S*g+b*m,T-=o,C-=o}_step3InnerSLoopLd654(e,t,s,i){const r=i>>3,n=this._a[r];let o=s;const l=o-16*e;for(;o>l;){let h,c;h=t[o]-t[o-8],c=t[o-1]-t[o-9],t[o]+=t[o-8],t[o-1]+=t[o-9],t[o-8]=h,t[o-9]=c,h=t[o-2]-t[o-10],c=t[o-3]-t[o-11],t[o-2]+=t[o-10],t[o-3]+=t[o-11],t[o-10]=(h+c)*n,t[o-11]=(c-h)*n,h=t[o-12]-t[o-4],c=t[o-5]-t[o-13],t[o-4]+=t[o-12],t[o-5]+=t[o-13],t[o-12]=c,t[o-13]=h,h=t[o-14]-t[o-6],c=t[o-7]-t[o-15],t[o-6]+=t[o-14],t[o-7]+=t[o-15],t[o-14]=(h+c)*n,t[o-15]=(h-c)*n,this._iter54(t,o),this._iter54(t,o-8),o-=16}}_iter54(e,t){const s=e[t]-e[t-4],i=e[t]+e[t-4],r=e[t-2]+e[t-6],n=e[t-2]-e[t-6];e[t]=i+r,e[t-2]=i-r;const o=e[t-3]-e[t-7];e[t-4]=s+o,e[t-6]=s-o;const l=e[t-1]-e[t-5],h=e[t-1]+e[t-5],c=e[t-3]+e[t-7];e[t-1]=h+c,e[t-3]=h-c,e[t-5]=l-n,e[t-7]=l+n}}class _h{_setupCache=new Map;reverse(e,t){let s;this._setupCache.has(t)?s=this._setupCache.get(t):(s=new gi(t),this._setupCache.set(t,s)),s.calcReverse(e)}}class un{_stream;_setup;_packets;_packetIndex=0;_nextPacketBuf;_prevPacketBuf;_prevPacketStart;_prevPacketEnd;_prevPacketStop;_currentPosition;_hasPosition;_eosFound;_modeFieldBits;constructor(e,t,s){this._stream=e,this._setup=t,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=zs.ilog(t.modes.length-1)}decode(){let e=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels);const t=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels);let s=0,i=0;for(;s=this.read(t,0,t.length),s!==0;){if(i+s>=e.length){const r=new Float32Array(e.length+t.length);r.set(e,0),e=r}e.set(t.subarray(0,s),i),i+=s}return e.subarray(0,i)}read(e,t,s){if(s===0)return 0;let i=t;const r=t+s;for(;i<r;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}const o=this._readNextPacket((i-t)/this._stream.audioChannels);o===null&&(this._prevPacketEnd=this._prevPacketStop),o!==null&&o.samplePosition!==null&&!this._hasPosition&&(this._hasPosition=!0,this._currentPosition=o.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-t)/this._stream.audioChannels)}const n=Math.min((r-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);n>0&&(i+=this._copyBuffer(e,i,n))}return s=i-t,this._currentPosition+=s/this._stream.audioChannels,s}_copyBuffer(e,t,s){let i=t;for(;s>0;this._prevPacketStart++,s--)for(let r=0;r<this._stream.audioChannels;r++)e[i++]=this._prevPacketBuf[r][this._prevPacketStart];return i-t}_readNextPacket(e){const t=this._decodeNextPacket();if(this._eosFound=this._eosFound||t.isEndOfStream,t.curPacket==null)return null;if(t.samplePosition!==null&&t.isEndOfStream){const s=this._currentPosition+e+t.validLen-t.startIndex,i=t.samplePosition-s;i<0&&(t.validLen+=i,t.validLen<0&&(t.validLen=0))}return this._prevPacketEnd>0?(un._overlapBuffers(this._prevPacketBuf,t.curPacket,this._prevPacketStart,this._prevPacketStop,t.startIndex,this._stream.audioChannels),this._prevPacketStart=t.startIndex):this._prevPacketBuf==null&&(this._prevPacketStart=t.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=t.validLen,this._prevPacketStop=t.totalLen,this._prevPacketBuf=t.curPacket,new bh(t.samplePosition)}static _overlapBuffers(e,t,s,i,r,n){for(;s<i;s++,r++)for(let o=0;o<n;o++)t[o][r]+=e[o][s]}_decodeNextPacket(){const e=new Sh;let t=null;if(this._packetIndex>=this._packets.length)e.isEndOfStream=!0;else{t=this._packets[this._packetIndex++];const s=new Zr(pt.fromBuffer(t.packetData));if(e.isEndOfStream=t.isEndOfStream,!s.readBit()){const i=this._setup.modes[s.readBits(this._modeFieldBits)];if(this._nextPacketBuf==null){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let n=0;n<this._stream.audioChannels;n++)this._nextPacketBuf[n]=new Float32Array(this._stream.blocksize1)}const r=i.decode(s,this._nextPacketBuf);return e.startIndex=r.packetStartIndex,e.validLen=r.packetValidLength,e.totalLen=r.packetTotalLength,e.samplePosition=t.granulePosition,e.curPacket=this._nextPacketBuf,e}}return e}}class Sh{curPacket=null;startIndex=0;validLen=0;totalLen=0;isEndOfStream=!1;samplePosition=null}var br;(function(a){a[a.IdentificationHeader=1]="IdentificationHeader",a[a.Comment=3]="Comment",a[a.SetupHeader=5]="SetupHeader"})(br||(br={}));class mi{static vorbisHeaderMarker=new Uint8Array([118,111,114,98,105,115]);_packets;_packetIndex;constructor(e){this._packetIndex=-1,this._packets=e}read(){let e;for(;;){if(e=this._nextPacket(),e==null)return null;if(e.isBeginningOfStream){const t=this._readStream(e);if(t!=null)return t}}}_nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}_readStream(e){const t=new rh;if(!this._readIdentificationHeader(t,e)||!this._readComments(this._nextPacket()))return null;const s=new ah;if(!this._readSetupHeader(t,s,this._nextPacket()))return null;const i=[];let r;for(;r=this._nextPacket(),!(r==null||(i.push(r),r.isEndOfStream)););const n=new un(t,s,i);return t.samples=n.decode(),t}_commonHeaderDecode(e,t){const s=new Uint8Array(7);if(t.read(s,0,s.length),s[0]!==e)return!1;for(let i=0;i<mi.vorbisHeaderMarker.length;i++)if(s[1+i]!==mi.vorbisHeaderMarker[i])return!1;return!0}_commonHeaderDecodeBit(e,t){const s=t.readBytes(7);if(s[0]!==e)return!1;for(let i=0;i<mi.vorbisHeaderMarker.length;i++)if(s[1+i]!==mi.vorbisHeaderMarker[i])return!1;return!0}_readIdentificationHeader(e,t){const s=pt.fromBuffer(t.packetData);if(!this._commonHeaderDecode(br.IdentificationHeader,s)||B.readUInt32LE(s)!==0||(e.audioChannels=s.readByte(),e.audioSampleRate=B.readUInt32LE(s),e.audioChannels<=0||e.audioSampleRate<=0))return!1;e.bitrateMaximum=B.readInt32LE(s),e.bitrateNominal=B.readInt32LE(s),e.bitrateMinimum=B.readInt32LE(s);const r=s.readByte();return e.blocksize0=1<<(r&15),e.blocksize1=1<<(r>>4),!(e.blocksize0>e.blocksize1||!mi._isAllowedBlockSize(e.blocksize0)||!mi._isAllowedBlockSize(e.blocksize0)||s.readByte()===0)}static _isAllowedBlockSize(e){switch(e){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}_readComments(e){if(e==null)return!1;const t=pt.fromBuffer(e.packetData);if(!this._commonHeaderDecode(br.Comment,t))return!1;const s=B.readUInt32LE(t);t.skip(s);const i=B.readUInt32LE(t);for(let n=0;n<i;n++){const o=B.readUInt32LE(t);t.skip(o)}return t.readByte()!==0}_readSetupHeader(e,t,s){if(s==null)return!1;const i=new Zr(pt.fromBuffer(s.packetData)),r=new _h,n=new jr;if(!this._commonHeaderDecodeBit(br.SetupHeader,i))return!1;let o=i.readByte()+1;for(let l=0;l<o;l++)t.codebooks.push(new oh(i,n));o=i.readBits(6)+1;for(let l=0;l<o;l++)t.timeDomainTransforms.push(new hh(i));o=i.readBits(6)+1;for(let l=0;l<o;l++)t.floors.push(new uh(i,e.blocksize0,e.blocksize1,t.codebooks));o=i.readBits(6)+1;for(let l=0;l<o;l++)t.residues.push(new gh(i,e.audioChannels,t.codebooks));o=i.readBits(6)+1;for(let l=0;l<o;l++)t.mappings.push(new mh(i,e.audioChannels,t.floors,t.residues,r));o=i.readBits(6)+1;for(let l=0;l<o;l++)t.modes.push(new as(i,e.audioChannels,e.blocksize0,e.blocksize1,t.mappings));return!!i.readBit()}}class kh{streams=[];constructor(e){const s=new ih(e).read(),i=new mi(s);for(;;){const r=i.read();if(r==null)break;this.streams.push(r)}}}class wo{phdrs=[];pbags=[];pmods=[];pgens=[];insts=[];ibags=[];imods=[];igens=[];sHdrs=[];sampleData=new Uint8Array(0);_sampleCache=new Map;decodeSamples(e,t,s){const i=`${e}_${t}_${s}`;if(!this._sampleCache.has(i)){let r;const n=this.sampleData.slice(e,t);if(s)r=new kh(pt.fromBuffer(n)).streams[0].samples;else{const o=new DataView(n.buffer,n.byteOffset,n.length);r=new Float32Array(n.length/2);for(let l=0;l<r.length;l++)r[l]=o.getInt16(l*2,!0)/32767}return this._sampleCache.set(i,r),r}return this._sampleCache.get(i)}load(e){const t=new ws,s=new ws;if(!ws.load(null,t,e)||t.id!=="sfbk")throw new Ft("Soundfont is not a valid Soundfont2 file");for(;ws.load(t,s,e);){const i=new ws;if(s.id==="pdta")for(;ws.load(s,i,e);)switch(i.id){case"phdr":for(let r=0,n=i.size/Co.SizeInFile|0;r<n;r++)this.phdrs.push(new Co(e));break;case"pbag":for(let r=0,n=i.size/Po.SizeInFile|0;r<n;r++)this.pbags.push(new Po(e));break;case"pmod":for(let r=0,n=i.size/Eo.SizeInFile|0;r<n;r++)this.pmods.push(new Eo(e));break;case"pgen":for(let r=0,n=i.size/ei.SizeInFile|0;r<n;r++)this.pgens.push(new ei(e));break;case"inst":for(let r=0,n=i.size/No.SizeInFile|0;r<n;r++)this.insts.push(new No(e));break;case"ibag":for(let r=0,n=i.size/Bo.SizeInFile|0;r<n;r++)this.ibags.push(new Bo(e));break;case"imod":for(let r=0,n=i.size/To.SizeInFile|0;r<n;r++)this.imods.push(new To(e));break;case"igen":for(let r=0,n=i.size/xo.SizeInFile|0;r<n;r++)this.igens.push(new xo(e));break;case"shdr":for(let r=0,n=i.size/vo.SizeInFile|0;r<n;r++)this.sHdrs.push(new vo(e));break;default:e.position+=i.size;break}else if(s.id==="sdta")for(;ws.load(s,i,e);)switch(i.id){case"smpl":this.sampleData=new Uint8Array(i.size),e.read(this.sampleData,0,i.size);break;default:e.position+=i.size;break}else e.position+=s.size}}}class Bo{static SizeInFile=4;instGenNdx;instModNdx;constructor(e){this.instGenNdx=B.readUInt16LE(e),this.instModNdx=B.readUInt16LE(e)}}class To{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(e){this.modSrcOper=B.readUInt16LE(e),this.modDestOper=B.readUInt16LE(e),this.modAmount=B.readInt16LE(e),this.modAmtSrcOper=B.readUInt16LE(e),this.modTransOper=B.readUInt16LE(e)}}class xo{static SizeInFile=4;genOper;genAmount;constructor(e){this.genOper=B.readUInt16LE(e),this.genAmount=new Do(e)}}class No{static SizeInFile=22;instName;instBagNdx;constructor(e){this.instName=B.read8BitStringLength(e,20),this.instBagNdx=B.readUInt16LE(e)}}class Po{static SizeInFile=4;genNdx;modNdx;constructor(e){this.genNdx=B.readUInt16LE(e),this.modNdx=B.readUInt16LE(e)}}class ei{static SizeInFile=4;static GenInstrument=41;static GenKeyRange=43;static GenVelRange=44;static GenSampleId=53;genOper;genAmount;constructor(e){this.genOper=B.readUInt16LE(e),this.genAmount=new Do(e)}}class Co{static SizeInFile=38;presetName;preset;bank;presetBagNdx;library;genre;morphology;constructor(e){this.presetName=B.read8BitStringLength(e,20),this.preset=B.readUInt16LE(e),this.bank=B.readUInt16LE(e),this.presetBagNdx=B.readUInt16LE(e),this.library=B.readUInt32LE(e),this.genre=B.readUInt32LE(e),this.morphology=B.readUInt32LE(e)}}class Eo{static SizeInFile=10;modSrcOper;modDestOper;modAmount;modAmtSrcOper;modTransOper;constructor(e){this.modSrcOper=B.readUInt16LE(e),this.modDestOper=B.readUInt16LE(e),this.modAmount=B.readUInt16LE(e),this.modAmtSrcOper=B.readUInt16LE(e),this.modTransOper=B.readUInt16LE(e)}}class vo{static SizeInFile=46;sampleName;start;end;startLoop;endLoop;sampleRate;originalPitch;pitchCorrection;sampleLink;sampleType;constructor(e){this.sampleName=B.read8BitStringLength(e,20),this.start=B.readUInt32LE(e),this.end=B.readUInt32LE(e),this.startLoop=B.readUInt32LE(e),this.endLoop=B.readUInt32LE(e),this.sampleRate=B.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=B.readSInt8(e),this.sampleLink=B.readUInt16LE(e),this.sampleType=B.readUInt16LE(e)}}class Do{wordAmount;get shortAmount(){return de.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return this.wordAmount&255}get highByteAmount(){return(this.wordAmount&65280)>>8&255}constructor(e){this.wordAmount=B.readUInt16LE(e)}}class wh{presetIndex=0;bank=0;pitchWheel=0;perNotePitchWheel=new Map;midiPan=0;midiVolume=0;midiExpression=0;midiRpn=0;midiData=0;panOffset=0;gainDb=0;pitchRange=0;tuning=0;mixVolume=0;mute=!1;solo=!1}class Bh{activeChannel=0;channelList=[];setupVoice(e,t){const s=this.channelList[this.activeChannel],i=t.region.pan+s.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=s.mixVolume,t.noteGainDb+=s.gainDb,t.updatePitchRatio(s,e.outSampleRate),i<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):i>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-i),t.panFactorRight=Math.sqrt(.5+i))}}var ti;(function(a){a[a.None=0]="None",a[a.Continuous=1]="Continuous",a[a.Sustain=2]="Sustain"})(ti||(ti={}));var Ii;(function(a){a[a.StereoInterleaved=0]="StereoInterleaved",a[a.StereoUnweaved=1]="StereoUnweaved",a[a.Mono=2]="Mono"})(Ii||(Ii={}));class Th{name="";presetNumber=0;bank=0;regions=null}class Pt{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,e*.05):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}}class _r{delay=0;attack=0;hold=0;decay=0;sustain=0;release=0;keynumToHold=0;keynumToDecay=0;constructor(e){e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Pt.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Pt.timecents2Secs(this.attack),this.release=this.release<-11950?0:Pt.timecents2Secs(this.release),this.keynumToHold===0&&(this.hold=this.hold<-11950?0:Pt.timecents2Secs(this.hold)),this.keynumToDecay===0&&(this.decay=this.decay<-11950?0:Pt.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:e?this.sustain=Pt.decibelsToGain(-this.sustain/10):this.sustain=1-this.sustain/1e3}}var Me;(function(a){a[a.StartAddrsOffset=0]="StartAddrsOffset",a[a.EndAddrsOffset=1]="EndAddrsOffset",a[a.StartloopAddrsOffset=2]="StartloopAddrsOffset",a[a.EndloopAddrsOffset=3]="EndloopAddrsOffset",a[a.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",a[a.ModLfoToPitch=5]="ModLfoToPitch",a[a.VibLfoToPitch=6]="VibLfoToPitch",a[a.ModEnvToPitch=7]="ModEnvToPitch",a[a.InitialFilterFc=8]="InitialFilterFc",a[a.InitialFilterQ=9]="InitialFilterQ",a[a.ModLfoToFilterFc=10]="ModLfoToFilterFc",a[a.ModEnvToFilterFc=11]="ModEnvToFilterFc",a[a.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",a[a.ModLfoToVolume=13]="ModLfoToVolume",a[a.Unused1=14]="Unused1",a[a.ChorusEffectsSend=15]="ChorusEffectsSend",a[a.ReverbEffectsSend=16]="ReverbEffectsSend",a[a.Pan=17]="Pan",a[a.Unused2=18]="Unused2",a[a.Unused3=19]="Unused3",a[a.Unused4=20]="Unused4",a[a.DelayModLFO=21]="DelayModLFO",a[a.FreqModLFO=22]="FreqModLFO",a[a.DelayVibLFO=23]="DelayVibLFO",a[a.FreqVibLFO=24]="FreqVibLFO",a[a.DelayModEnv=25]="DelayModEnv",a[a.AttackModEnv=26]="AttackModEnv",a[a.HoldModEnv=27]="HoldModEnv",a[a.DecayModEnv=28]="DecayModEnv",a[a.SustainModEnv=29]="SustainModEnv",a[a.ReleaseModEnv=30]="ReleaseModEnv",a[a.KeynumToModEnvHold=31]="KeynumToModEnvHold",a[a.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",a[a.DelayVolEnv=33]="DelayVolEnv",a[a.AttackVolEnv=34]="AttackVolEnv",a[a.HoldVolEnv=35]="HoldVolEnv",a[a.DecayVolEnv=36]="DecayVolEnv",a[a.SustainVolEnv=37]="SustainVolEnv",a[a.ReleaseVolEnv=38]="ReleaseVolEnv",a[a.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",a[a.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",a[a.Instrument=41]="Instrument",a[a.Reserved1=42]="Reserved1",a[a.KeyRange=43]="KeyRange",a[a.VelRange=44]="VelRange",a[a.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",a[a.Keynum=46]="Keynum",a[a.Velocity=47]="Velocity",a[a.InitialAttenuation=48]="InitialAttenuation",a[a.Reserved2=49]="Reserved2",a[a.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",a[a.CoarseTune=51]="CoarseTune",a[a.FineTune=52]="FineTune",a[a.SampleID=53]="SampleID",a[a.SampleModes=54]="SampleModes",a[a.Reserved3=55]="Reserved3",a[a.ScaleTuning=56]="ScaleTuning",a[a.ExclusiveClass=57]="ExclusiveClass",a[a.OverridingRootKey=58]="OverridingRootKey",a[a.Unused5=59]="Unused5",a[a.EndOper=60]="EndOper"})(Me||(Me={}));class si{static _noSamples=new Float32Array(0);loopMode=ti.None;samples=si._noSamples;sampleRate=0;loKey=0;hiKey=0;loVel=0;hiVel=0;group=0;offset=0;end=0;loopStart=0;loopEnd=0;transpose=0;tune=0;pitchKeyCenter=0;pitchKeyTrack=0;attenuation=0;pan=0;ampEnv=new _r;modEnv=new _r;initialFilterQ=0;initialFilterFc=0;modEnvToPitch=0;modEnvToFilterFc=0;modLfoToFilterFc=0;modLfoToVolume=0;delayModLFO=0;freqModLFO=0;modLfoToPitch=0;delayVibLFO=0;freqVibLFO=0;vibLfoToPitch=0;constructor(e){e&&(this.loopMode=e.loopMode,this.samples=e.samples,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new _r(e.ampEnv),this.modEnv=new _r(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=ti.None,this.samples=si._noSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,!e&&(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case Me.StartAddrsOffset:this.offset+=de.int16ToUint32(t.shortAmount);break;case Me.EndAddrsOffset:this.end+=de.int16ToUint32(t.shortAmount);break;case Me.StartloopAddrsOffset:this.loopStart+=de.int16ToUint32(t.shortAmount);break;case Me.EndloopAddrsOffset:this.loopEnd+=de.int16ToUint32(t.shortAmount);break;case Me.StartAddrsCoarseOffset:this.offset+=de.int16ToUint32(t.shortAmount)*32768;break;case Me.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case Me.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case Me.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case Me.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case Me.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case Me.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case Me.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case Me.EndAddrsCoarseOffset:this.end+=de.int16ToUint32(t.shortAmount)*32768;break;case Me.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case Me.Pan:this.pan=t.shortAmount/1e3;break;case Me.DelayModLFO:this.delayModLFO=t.shortAmount;break;case Me.FreqModLFO:this.freqModLFO=t.shortAmount;break;case Me.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case Me.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case Me.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case Me.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case Me.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case Me.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case Me.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case Me.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case Me.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case Me.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case Me.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case Me.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case Me.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case Me.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case Me.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case Me.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case Me.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case Me.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case Me.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case Me.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case Me.StartloopAddrsCoarseOffset:this.loopStart+=de.int16ToUint32(t.shortAmount)*32768;break;case Me.InitialAttenuation:this.attenuation+=t.shortAmount*.1;break;case Me.EndloopAddrsCoarseOffset:this.loopEnd+=de.int16ToUint32(t.shortAmount)*32768;break;case Me.CoarseTune:this.transpose+=t.shortAmount;break;case Me.FineTune:this.tune+=t.shortAmount;break;case Me.SampleModes:this.loopMode=(t.wordAmount&3)===3?ti.Sustain:(t.wordAmount&3)===1?ti.Continuous:ti.None;break;case Me.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case Me.ExclusiveClass:this.group=t.wordAmount;break;case Me.OverridingRootKey:this.pitchKeyCenter=t.shortAmount;break}}}var Ze;(function(a){a[a.None=0]="None",a[a.Delay=1]="Delay",a[a.Attack=2]="Attack",a[a.Hold=3]="Hold",a[a.Decay=4]="Decay",a[a.Sustain=5]="Sustain",a[a.Release=6]="Release",a[a.Done=7]="Done"})(Ze||(Ze={}));class ta{static _fastReleaseTime=.01;level=0;slope=0;samplesUntilNextSegment=0;segment=Ze.None;midiVelocity=0;parameters=null;segmentIsExponential=!1;isAmpEnv=!1;nextSegment(e,t){if(this.parameters)for(;;)switch(e){case Ze.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,this.samplesUntilNextSegment>0){this.segment=Ze.Delay,this.segmentIsExponential=!1,this.level=0,this.slope=0;return}e=Ze.Delay;break;case Ze.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,this.samplesUntilNextSegment>0){this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=Ze.Attack,this.segmentIsExponential=!1,this.level=0,this.slope=1/this.samplesUntilNextSegment;return}e=Ze.Attack;break;case Ze.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,this.samplesUntilNextSegment>0){this.segment=Ze.Hold,this.segmentIsExponential=!1,this.level=1,this.slope=0;return}e=Ze.Hold;break;case Ze.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,this.samplesUntilNextSegment>0){if(this.segment=Ze.Decay,this.level=1,this.isAmpEnv){const s=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(s),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/s|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1;return}e=Ze.Decay;break;case Ze.Decay:this.segment=Ze.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,this.segmentIsExponential=!1;return;case Ze.Sustain:if(this.segment=Ze.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?ta._fastReleaseTime:this.parameters.release)*t|0,this.isAmpEnv){const s=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(s),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:this.segment=Ze.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,this.samplesUntilNextSegment=134217727;return}}setup(e,t,s,i,r){this.parameters=new _r(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Pt.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Pt.timecents2Secs(this.parameters.decay)),this.midiVelocity=s|0,this.isAmpEnv=i,this.nextSegment(Ze.None,r)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}}class Lo{samplesUntil=0;level=0;delta=0;setup(e,t,s){this.samplesUntil=e*s|0,this.delta=4*Pt.cents2Hertz(t)/s,this.level=0}process(e){if(this.samplesUntil>e){this.samplesUntil-=e;return}this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level)}}class Fo{qInv=0;a0=0;a1=0;b1=0;b2=0;z1=0;z2=0;active=!1;constructor(e){e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){const t=Math.tan(Math.PI*e),s=t*t,i=1/(1+t*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-t*this.qInv+s)*i}process(e){const t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class sa{static renderEffectSampleBlock=oe.MicroBufferSize;playingPreset=0;playingKey=0;playingChannel=0;region=null;pitchInputTimecents=0;pitchOutputFactor=0;sourceSamplePosition=0;noteGainDb=0;panFactorLeft=0;panFactorRight=0;playIndex=0;loopStart=0;loopEnd=0;ampEnv=new ta;modEnv=new ta;lowPass=new Fo;modLfo=new Lo;vibLfo=new Lo;mixVolume=0;mute=!1;updatePitchRatio(e,t){let s=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(s+=e.perNotePitchWheel.get(this.playingKey)-8192);const i=s===8192?e.tuning:s/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(i,t)}calcPitchRatio(e,t){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);e!==0&&(i+=e),this.pitchInputTimecents=i*100,this.pitchOutputFactor=this.region.sampleRate/(Pt.timecents2Secs(this.region.pitchKeyCenter*100)*t)}end(e){this.region&&(this.ampEnv.nextSegment(Ze.Sustain,e),this.modEnv.nextSegment(Ze.Sustain,e),this.region.loopMode===ti.Sustain&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(Ze.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(Ze.Sustain,e)}render(e,t,s,i,r){if(!this.region)return;const n=this.region,o=n.samples;let l=0,h=e.outputMode===Ii.StereoUnweaved?i:-1;const c=n.modEnvToPitch!==0||n.modEnvToFilterFc!==0,d=this.modLfo.delta>0&&(n.modLfoToPitch!==0||n.modLfoToFilterFc!==0||n.modLfoToVolume!==0),f=this.vibLfo.delta>0&&n.vibLfoToPitch!==0,p=this.loopStart<this.loopEnd,g=this.loopStart,m=this.loopEnd,b=n.end,S=m+1;let T=this.sourceSamplePosition;const C=new Fo(this.lowPass),v=n.modLfoToFilterFc!==0||n.modEnvToFilterFc!==0;let G=0,W=0,w=0,se=0;const Ne=n.modLfoToPitch!==0||n.modEnvToPitch!==0||n.vibLfoToPitch!==0;let ye=0,te=0,Ke=0,We=0;const qt=n.modLfoToVolume!==0;let Ss=0,Dt=0;for(v?(G=e.outSampleRate,W=n.initialFilterFc,w=n.modLfoToFilterFc,se=n.modEnvToFilterFc):(G=0,W=0,w=0,se=0),Ne?(ye=0,te=n.modLfoToPitch,Ke=n.vibLfoToPitch,We=n.modEnvToPitch):(ye=Pt.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,te=0,Ke=0,We=0),qt?Dt=n.modLfoToVolume*.1:(Ss=Pt.decibelsToGain(this.noteGainDb),Dt=0);i>0;){let Xt,Ci,hi=0,Ps=i>sa.renderEffectSampleBlock?sa.renderEffectSampleBlock:i;if(i-=Ps,v){const At=W+this.modLfo.level*w+this.modEnv.level*se;C.active=At<=13500,C.active&&C.setup(Pt.cents2Hertz(At)/G)}switch(Ne&&(ye=Pt.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*te+this.vibLfo.level*Ke+this.modEnv.level*We))*this.pitchOutputFactor),qt&&(Ss=Pt.decibelsToGain(this.noteGainDb+this.modLfo.level*Dt)),Xt=Ss*this.ampEnv.level,r?Xt=0:Xt*=this.mixVolume,this.ampEnv.process(Ps,e.outSampleRate),c&&this.modEnv.process(Ps,e.outSampleRate),d&&this.modLfo.process(Ps),f&&this.vibLfo.process(Ps),e.outputMode){case Ii.StereoInterleaved:for(Ci=Xt*this.panFactorLeft,hi=Xt*this.panFactorRight;Ps-- >0&&T<b;){const At=T|0,Xi=At>=m&&p?g:At+1,Is=T-At;let ls=o[At]*(1-Is)+o[Xi]*Is;C.active&&(ls=C.process(ls)),t[s+l]+=ls*Ci,l++,t[s+l]+=ls*hi,l++,T+=ye,T>=S&&p&&(T-=m-g+1)}break;case Ii.StereoUnweaved:for(Ci=Xt*this.panFactorLeft,hi=Xt*this.panFactorRight;Ps-- >0&&T<b;){const At=T|0,Xi=At>=m&&p?g:At+1,Is=T-At;let ls=o[At]*(1-Is)+o[Xi]*Is;C.active&&(ls=C.process(ls)),t[s+l]+=ls*Ci,l++,t[s+h]+=ls*hi,h++,T+=ye,T>=S&&p&&(T-=m-g+1)}break;case Ii.Mono:for(;Ps-- >0&&T<b;){const At=T|0,Xi=At>=m&&p?g:At+1,Is=T-At;let ls=o[At]*(1-Is)+o[Xi]*Is;C.active&&(ls=C.process(ls)),t[s+l]=ls*Xt,l++,T+=ye,T>=S&&p&&(T-=m-g+1)}break}if(T>=b||this.ampEnv.segment===Ze.Done){this.kill();return}}this.sourceSamplePosition=T,(C.active||v)&&(this.lowPass=C)}kill(){this.playingPreset=-1}}class Mo{value;next;constructor(e){this.value=e}}class fn{_head;_tail;get isEmpty(){return this._head===void 0}clear(){this._head=void 0,this._tail=void 0}enqueue(e){const t=new Mo(e);this._tail?(this._tail.next=t,this._tail=t):(this._head=t,this._tail=t)}enqueueFront(e){const t=new Mo(e);t.next=this._head,this._head?this._head=t:(this._head=t,this._tail=t)}peek(){const e=this._head;if(e)return e.value}dequeue(){const e=this._head;if(!e)return;const t=e.next;return this._head=t,t||(this._tail=void 0),e.value}}var $e;(function(a){a[a.BankSelectCoarse=0]="BankSelectCoarse",a[a.ModulationCoarse=1]="ModulationCoarse",a[a.DataEntryCoarse=6]="DataEntryCoarse",a[a.VolumeCoarse=7]="VolumeCoarse",a[a.PanCoarse=10]="PanCoarse",a[a.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",a[a.BankSelectFine=32]="BankSelectFine",a[a.ModulationFine=33]="ModulationFine",a[a.DataEntryFine=38]="DataEntryFine",a[a.VolumeFine=39]="VolumeFine",a[a.PanFine=42]="PanFine",a[a.ExpressionControllerFine=43]="ExpressionControllerFine",a[a.HoldPedal=64]="HoldPedal",a[a.LegatoPedal=68]="LegatoPedal",a[a.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",a[a.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",a[a.RegisteredParameterFine=100]="RegisteredParameterFine",a[a.RegisteredParameterCourse=101]="RegisteredParameterCourse",a[a.AllSoundOff=120]="AllSoundOff",a[a.ResetControllers=121]="ResetControllers",a[a.AllNotesOff=123]="AllNotesOff"})($e||($e={}));class ia{_midiEventQueue=new fn;_mutedChannels=new Map;_soloChannels=new Map;_isAnySolo=!1;_transpositionPitches=new Map;_liveTranspositionPitches=new Map;currentTempo=0;timeSignatureNumerator=0;timeSignatureDenominator=0;constructor(e){this.outSampleRate=e}synthesize(e,t,s){return this._fillWorkingBuffer(e,t,s)}synthesizeSilent(e){this._fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){const s=this._channelInit(e);for(const i of this._voices)i.playingChannel===e&&i.playingPreset!==-1&&(i.mixVolume=t);s.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(e,t){let s=0;this._liveTranspositionPitches.has(e)&&(s=this._liveTranspositionPitches.get(e)),t===0?this._liveTranspositionPitches.delete(e):this._liveTranspositionPitches.set(e,t);for(const i of this._voices)if(i.playingChannel===e&&i.playingChannel!==9){let r=0;r-=s,r+=t,i.playingKey+=r,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(e){const t=this._transpositionPitches;for(const s of this._voices)if(s.playingChannel>=0&&s.playingChannel!==9){let i=0;t.has(s.playingChannel)&&(i-=t.get(s.playingChannel)),e.has(s.playingChannel)&&(i+=e.get(s.playingChannel)),s.playingKey+=i,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=e}dispatchEvent(e){this._midiEventQueue.enqueue(e)}_fillWorkingBuffer(e,t,s){const i=this._isAnySolo,r=[];for(;!this._midiEventQueue.isEmpty;){const n=this._midiEventQueue.dequeue();n.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(oe.MetronomeChannel,oe.MetronomeKey),this.channelNoteOn(oe.MetronomeChannel,oe.MetronomeKey,95/127)):n.event&&this.processMidiMessage(n.event),r.push(n)}for(const n of this._voices)if(n.playingPreset!==-1){const o=n.playingChannel,l=this._mutedChannels.has(o)||i&&o!==oe.MetronomeChannel&&!this._soloChannels.has(o);e?n.render(this,e,t,s,l):n.kill()}return r}processMidiMessage(e){switch(e.type){case Fe.TimeSignature:const s=e;this.timeSignatureNumerator=s.numerator,this.timeSignatureDenominator=Math.pow(2,s.denominatorIndex);break;case Fe.NoteOn:const i=e;this.channelNoteOn(i.channel,i.noteKey,i.noteVelocity/127);break;case Fe.NoteOff:const r=e;this.channelNoteOff(r.channel,r.noteKey);break;case Fe.ControlChange:const n=e;this.channelMidiControl(n.channel,n.controller,n.value);break;case Fe.ProgramChange:const o=e;this.channelSetPresetNumber(o.channel,o.program,o.channel===9);break;case Fe.TempoChange:const l=e;this.currentTempo=l.beatsPerMinute;break;case Fe.PitchBend:const h=e;this.channelSetPitchWheel(h.channel,h.value);break;case Fe.PerNotePitchBend:const c=e;let d=c.value;d=d*oe.MaxPitchWheel/oe.MaxPitchWheel20,this.channelSetPerNotePitchWheel(c.channel,c.noteKey,d);break}}get metronomeVolume(){return this.channelGetMixVolume(oe.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(oe.MetronomeChannel,e),e>0&&(this.channelSetVolume(oe.MetronomeChannel,1),this.channelSetPresetNumber(oe.MetronomeChannel,0,!0))}get masterVolume(){return Pt.decibelsToGain(this.globalGainDb)}set masterVolume(e){const t=Pt.gainToDecibels(e),s=t-this.globalGainDb;if(s!==0){for(const i of this._voices)i.playingPreset!==-1&&(i.noteGainDb+=s);this.globalGainDb=t}}resetSoft(){for(const e of this._voices)e.playingPreset!==-1&&(e.ampEnv.segment<Ze.Release||e.ampEnv.parameters.release!==0)&&e.endQuick(this.outSampleRate);if(this._channels)for(const e of this._channels.channelList)e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.perNotePitchWheel.clear(),e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}presets=null;_voices=[];_channels=null;_voicePlayIndex=0;get presetCount(){return this.presets?.length??0}outputMode=Ii.StereoInterleaved;outSampleRate=0;globalGainDb=0;reset(){for(const e of this._voices)e.playingPreset!==-1&&(e.ampEnv.segment<Ze.Release||e.ampEnv.parameters.release!==0)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,s){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=s}noteOn(e,t,s){if(!this.presets)return;const i=s*127|0;if(e<0||e>=this.presets.length)return;if(s<=0){this.noteOff(e,t);return}const r=this._voicePlayIndex++;for(const n of this.presets[e].regions){if(t<n.loKey||t>n.hiKey||i<n.loVel||i>n.hiVel)continue;let o=null;if(n.group!==0)for(const c of this._voices)c.playingPreset===e&&c.region.group===n.group?c.endQuick(this.outSampleRate):c.playingPreset===-1&&!o&&(o=c);else for(const c of this._voices)c.playingPreset===-1&&(o=c);if(!o){for(let c=0;c<4;c++){const d=new sa;d.playingPreset=-1,this._voices.push(d)}o=this._voices[this._voices.length-4]}o.region=n,o.playingPreset=e,o.playingKey=t,o.playIndex=r,o.noteGainDb=this.globalGainDb-n.attenuation-Pt.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,o):(o.calcPitchRatio(0,this.outSampleRate),o.panFactorLeft=Math.sqrt(.5-n.pan),o.panFactorRight=Math.sqrt(.5+n.pan)),o.sourceSamplePosition=n.offset;const l=n.loopMode!==ti.None&&n.loopStart<n.loopEnd;o.loopStart=l?n.loopStart:0,o.loopEnd=l?n.loopEnd:0,o.ampEnv.setup(n.ampEnv,t,i,!0,this.outSampleRate),o.modEnv.setup(n.modEnv,t,i,!1,this.outSampleRate);const h=n.initialFilterQ/10;o.lowPass.qInv=1/Math.pow(10,h/20),o.lowPass.z1=0,o.lowPass.z2=0,o.lowPass.active=n.initialFilterFc<=13500,o.lowPass.active&&o.lowPass.setup(Pt.cents2Hertz(n.initialFilterFc)/this.outSampleRate),o.modLfo.setup(n.delayModLFO,n.freqModLFO,this.outSampleRate),o.vibLfo.setup(n.delayVibLFO,n.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,s,i){const r=this._getPresetIndex(e,t);return r===-1?!1:(this.noteOn(r,s,i),!0)}noteOff(e,t){let s=null,i=null;const r=[];for(const n of this._voices)n.playingPreset!==e||n.playingKey!==t||n.ampEnv.segment>=Ze.Release||(!s||n.playIndex<s.playIndex?(s=n,i=n,r.push(n)):n.playIndex===s.playIndex&&(i=n,r.push(n)));if(s)for(const n of r)n!==s&&n!==i&&(n.playIndex!==s.playIndex||n.playingPreset!==e||n.playingKey!==t||n.ampEnv.segment>=Ze.Release)||n.end(this.outSampleRate)}bankNoteOff(e,t,s){const i=this._getPresetIndex(e,t);return i===-1?!1:(this.noteOff(i,s),!0)}noteOffAll(e){for(const t of this._voices)t.playingPreset!==-1&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<Ze.Release&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(const t of this._voices)t.playingPreset!==-1&&e++;return e}_channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new Bh);for(let t=this._channels.channelList.length;t<=e;t++){const s=new wh;s.presetIndex=0,s.bank=0,s.pitchWheel=8192,s.midiPan=8192,s.midiVolume=16383,s.midiExpression=16383,s.midiRpn=65535,s.midiData=0,s.panOffset=0,s.gainDb=0,s.pitchRange=2,s.tuning=0,s.mixVolume=1,this._channels.channelList.push(s)}return this._channels.channelList[e]}_getPresetIndex(e,t){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===t&&i.bank===e)return s}return-1}getPresetName(e){return this.presets?e<0||e>=this.presets.length?null:this.presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this._getPresetIndex(e,t))}channelNoteOn(e,t,s){!this._channels||e>this._channels.channelList.length||(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,s))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));const s=[];let i=null,r=null;for(const o of this._voices)o.playingPreset===-1||o.playingChannel!==e||o.playingKey!==t||o.ampEnv.segment>=Ze.Release||(!i||o.playIndex<i.playIndex?(i=o,r=o,s.push(o)):o.playIndex===i.playIndex&&(r=o,s.push(o)));if(this._channelInit(e).perNotePitchWheel.delete(t),!!i)for(const o of s)o!==i&&o!==r&&(o.playIndex!==i.playIndex||o.playingPreset===-1||o.playingChannel!==e||o.playingKey!==t||o.ampEnv.segment>=Ze.Release)||o.end(this.outSampleRate)}channelNoteOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(const s of this._voices)s.playingPreset!==-1&&s.playingChannel===e&&s.ampEnv.segment<Ze.Release&&s.end(this.outSampleRate)}channelSoundsOffAll(e){this._channelInit(e).perNotePitchWheel.clear();for(const s of this._voices)s.playingPreset!==-1&&s.playingChannel===e&&(s.ampEnv.segment<Ze.Release||s.ampEnv.parameters.release===0)&&s.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this._channelInit(e).presetIndex=de.int32ToUint16(t)}channelSetPresetNumber(e,t,s=!1){const i=this._channelInit(e);let r=0;return s?(r=this._getPresetIndex(128|i.bank&32767,t),r===-1&&(r=this._getPresetIndex(128,t)),r===-1&&(r=this._getPresetIndex(128,0)),r===-1&&(r=this._getPresetIndex(i.bank&2047,t))):r=this._getPresetIndex(i.bank&2047,t),i.presetIndex=r,r!==-1}channelSetBank(e,t){this._channelInit(e).bank=de.int32ToUint16(t)}channelSetBankPreset(e,t,s){const i=this._channelInit(e),r=this._getPresetIndex(t,s);return r===-1?!1:(i.presetIndex=de.int32ToUint16(r),i.bank=de.int32ToUint16(t),!0)}channelSetPan(e,t){for(const s of this._voices)if(s.playingChannel===e&&s.playingPreset!==-1){const i=s.region.pan+t-.5;i<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):i>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-i),s.panFactorRight=Math.sqrt(.5+i))}this._channelInit(e).panOffset=t-.5}channelSetVolume(e,t){const s=this._channelInit(e),i=Pt.gainToDecibels(t),r=i-s.gainDb;if(r!==0){for(const n of this._voices)n.playingChannel===e&&n.playingPreset!==-1&&(n.noteGainDb+=r);s.gainDb=i}}channelSetPitchWheel(e,t){const s=this._channelInit(e);s.pitchWheel!==t&&(s.pitchWheel=de.int32ToUint16(t),this._channelApplyPitch(e,s))}channelSetPerNotePitchWheel(e,t,s){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));const i=this._channelInit(e);i.perNotePitchWheel.has(t)&&i.perNotePitchWheel.get(t)===s||(i.perNotePitchWheel.set(t,s),this._channelApplyPitch(e,i,t))}_channelApplyPitch(e,t,s=-1){for(const i of this._voices)i.playingChannel===e&&i.playingPreset!==-1&&(s===-1||i.playingKey===s)&&i.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){const s=this._channelInit(e);s.pitchRange!==t&&(s.pitchRange=t,s.pitchWheel!==8192&&this._channelApplyPitch(e,s))}channelSetTuning(e,t){const s=this._channelInit(e);s.tuning!==t&&(s.tuning=t,this._channelApplyPitch(e,s))}channelMidiControl(e,t,s){const i=this._channelInit(e);switch(t){case $e.DataEntryFine:i.midiData=de.int32ToUint16(i.midiData&16256|s),i.midiRpn===0?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(i.midiData&127)):i.midiRpn===1?this.channelSetTuning(e,(i.tuning|0)+(i.midiData-8192)/8192):i.midiRpn===2&&this.channelSetTuning(e,s-64+(i.tuning-(i.tuning|0)));return;case $e.VolumeCoarse:i.midiVolume=de.int32ToUint16(i.midiVolume&127|s<<7),this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case $e.VolumeFine:i.midiVolume=de.int32ToUint16(i.midiVolume&16256|s),this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case $e.ExpressionControllerCoarse:i.midiExpression=de.int32ToUint16(i.midiExpression&127|s<<7),this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case $e.ExpressionControllerFine:i.midiExpression=de.int32ToUint16(i.midiExpression&16256|s),this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));return;case $e.PanCoarse:i.midiPan=de.int32ToUint16(i.midiPan&127|s<<7),this.channelSetPan(e,i.midiPan/16383);return;case $e.PanFine:i.midiPan=de.int32ToUint16(i.midiPan&16256|s),this.channelSetPan(e,i.midiPan/16383);return;case $e.DataEntryCoarse:i.midiData=de.int32ToUint16(i.midiData&127|s<<7),i.midiRpn===0?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(i.midiData&127)):i.midiRpn===1?this.channelSetTuning(e,(i.tuning|0)+(i.midiData-8192)/8192):i.midiRpn===2&&t===$e.DataEntryCoarse&&this.channelSetTuning(e,s-64+(i.tuning-(i.tuning|0)));return;case $e.BankSelectCoarse:i.bank=de.int32ToUint16(32768|s);return;case $e.BankSelectFine:i.bank=de.int32ToUint16(((i.bank&32768)!==0?(i.bank&127)<<7:0)|s);return;case $e.RegisteredParameterCourse:i.midiRpn=de.int32ToUint16((i.midiRpn===65535?0:i.midiRpn)&127|s<<7);return;case $e.RegisteredParameterFine:i.midiRpn=de.int32ToUint16((i.midiRpn===65535?0:i.midiRpn)&16256|s);return;case $e.NonRegisteredParameterFine:i.midiRpn=65535;return;case $e.NonRegisteredParameterCourse:i.midiRpn=65535;return;case $e.AllSoundOff:this.channelSoundsOffAll(e);return;case $e.AllNotesOff:this.channelNoteOffAll(e);return;case $e.ResetControllers:i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),this.channelSetPitchRange(e,2);return}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].bank&32767:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Pt.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(e,t,s,i){const r=[];for(let n=0;n<e.phdrs.length-1;n++){const o=e.phdrs[n];let l=0;const h=new Th;r.push(h),h.name=o.presetName,h.bank=o.bank,h.presetNumber=o.preset;let c=0;for(let f=o.presetBagNdx;f<e.phdrs[n+1].presetBagNdx;f++){const p=e.pbags[f];let g=0,m=127,b=0,S=127;for(let T=p.genNdx;T<e.pbags[f+1].genNdx;T++){const C=e.pgens[T];if(C.genOper===ei.GenKeyRange){g=C.genAmount.lowByteAmount,m=C.genAmount.highByteAmount;continue}if(C.genOper===ei.GenVelRange){b=C.genAmount.lowByteAmount,S=C.genAmount.highByteAmount;continue}if(C.genOper!==ei.GenInstrument||C.genAmount.wordAmount>=e.insts.length)continue;const v=e.insts[C.genAmount.wordAmount];for(let G=v.instBagNdx;G<e.insts[C.genAmount.wordAmount+1].instBagNdx;G++){const W=e.ibags[G];let w=0,se=127,Ne=0,ye=127;for(let te=W.instGenNdx;te<e.ibags[G+1].instGenNdx;te++){const Ke=e.igens[te];if(Ke.genOper===ei.GenKeyRange){w=Ke.genAmount.lowByteAmount,se=Ke.genAmount.highByteAmount;continue}if(Ke.genOper===ei.GenVelRange){Ne=Ke.genAmount.lowByteAmount,ye=Ke.genAmount.highByteAmount;continue}Ke.genOper===53&&se>=g&&w<=m&&ye>=b&&Ne<=S&&c++}}}}h.regions=new Array(c);let d=new si;d.clear(!0);for(let f=o.presetBagNdx;f<e.phdrs[n+1].presetBagNdx;f++){const p=e.pbags[f],g=new si(d);let m=!1;for(let b=p.genNdx;b<e.pbags[f+1].genNdx;b++){const S=e.pgens[b];if(S.genOper===ei.GenInstrument){const T=S.genAmount.wordAmount;if(T>=e.insts.length)continue;let C=new si;C.clear(!1);const v=e.insts[T];for(let G=v.instBagNdx;G<e.insts[T+1].instBagNdx;G++){const W=e.ibags[G],w=new si(C);let se=!1;for(let Ne=W.instGenNdx;Ne<e.ibags[G+1].instGenNdx;Ne++){const ye=e.igens[Ne];if(ye.genOper===ei.GenSampleId){if(w.hiKey<g.loKey||w.loKey>g.hiKey||w.hiVel<g.loVel||w.loVel>g.hiVel)continue;g.loKey>w.loKey&&(w.loKey=g.loKey),g.hiKey<w.hiKey&&(w.hiKey=g.hiKey),g.loVel>w.loVel&&(w.loVel=g.loVel),g.hiVel<w.hiVel&&(w.hiVel=g.hiVel),w.offset+=g.offset,w.end+=g.end,w.loopStart+=g.loopStart,w.loopEnd+=g.loopEnd,w.transpose+=g.transpose,w.tune+=g.tune,w.pitchKeyTrack+=g.pitchKeyTrack,w.attenuation+=g.attenuation,w.pan+=g.pan,w.ampEnv.delay+=g.ampEnv.delay,w.ampEnv.attack+=g.ampEnv.attack,w.ampEnv.hold+=g.ampEnv.hold,w.ampEnv.decay+=g.ampEnv.decay,w.ampEnv.sustain+=g.ampEnv.sustain,w.ampEnv.release+=g.ampEnv.release,w.modEnv.delay+=g.modEnv.delay,w.modEnv.attack+=g.modEnv.attack,w.modEnv.hold+=g.modEnv.hold,w.modEnv.decay+=g.modEnv.decay,w.modEnv.sustain+=g.modEnv.sustain,w.modEnv.release+=g.modEnv.release,w.initialFilterQ+=g.initialFilterQ,w.initialFilterFc+=g.initialFilterFc,w.modEnvToPitch+=g.modEnvToPitch,w.modEnvToFilterFc+=g.modEnvToFilterFc,w.delayModLFO+=g.delayModLFO,w.freqModLFO+=g.freqModLFO,w.modLfoToPitch+=g.modLfoToPitch,w.modLfoToFilterFc+=g.modLfoToFilterFc,w.modLfoToVolume+=g.modLfoToVolume,w.delayVibLFO+=g.delayVibLFO,w.freqVibLFO+=g.freqVibLFO,w.vibLfoToPitch+=g.vibLfoToPitch,w.ampEnv.envToSecs(!0),w.modEnv.envToSecs(!1),w.delayModLFO=w.delayModLFO<-11950?0:Pt.timecents2Secs(w.delayModLFO),w.delayVibLFO=w.delayVibLFO<-11950?0:Pt.timecents2Secs(w.delayVibLFO),w.pan<-.5?w.pan=-.5:w.pan>.5&&(w.pan=.5),(w.initialFilterQ<1500||w.initialFilterQ>13500)&&(w.initialFilterQ=0);const te=e.sHdrs[ye.genAmount.wordAmount];w.offset+=te.start,w.end+=te.end,w.loopStart+=te.startLoop,w.loopEnd+=te.endLoop,te.endLoop>0&&(w.loopEnd-=1),w.pitchKeyCenter===-1&&(w.pitchKeyCenter=te.originalPitch),w.tune+=te.pitchCorrection,w.sampleRate=te.sampleRate;const Ke=o.bank===oe.PercussionBank;Ke&&ia._setContainsRange(s,w.loKey,w.hiKey)||!Ke&&t.has(o.preset)?(te.sampleType&1)!==0?(E.debug("AlphaSynth",`Loading of used sample ${te.sampleName} for preset ${o.presetName} (bank ${h.bank} program ${h.presetNumber})`),(te.sampleType&16)!==0?w.samples=e.decodeSamples(te.start,te.end,!0):(w.samples=e.decodeSamples(w.offset*2,w.end*2,!1),w.loopStart>0&&(w.loopStart-=w.offset),w.loopEnd>0&&(w.loopEnd-=w.offset)),w.offset=0,w.end=w.samples.length-1):(E.warning("AlphaSynth",`Skipping load of unsupported sample ${te.sampleName} for preset ${o.presetName}, sample type ${te.sampleType} is not supported (bank ${h.bank} program ${h.presetNumber})`),w.samples=new Float32Array(0)):(E.debug("AlphaSynth",`Skipping load of unused sample ${te.sampleName} for preset ${o.presetName} (bank ${h.bank} program ${h.presetNumber})`),w.samples=new Float32Array(0)),h.regions[l]=new si(w),l++,se=!0}else w.operator(ye.genOper,ye.genAmount)}W===e.ibags[v.instBagNdx]&&!se&&(C=new si(w))}m=!0}else g.operator(S.genOper,S.genAmount)}p===e.pbags[o.presetBagNdx]&&!m&&(d=g)}}if(!i||!this.presets)this.presets=r;else for(const n of r)this.presets.push(n)}static _setContainsRange(e,t,s){for(let i=t;i<=s;i++)if(e.has(i))return!0;return!1}hasSamplesForProgram(e){const t=this.presets;if(!t)return!1;for(const s of t)if(s.presetNumber===e){for(const i of s.regions)if(i.samples.length>0)return!0}return!1}hasSamplesForPercussion(e){const t=this.presets;if(!t)return!1;for(const s of t)if(s.bank===oe.PercussionBank){for(const i of s.regions)if(i.loKey>=e&&i.hiKey<=e&&i.samples.length>0)return!0}return!1}}class Ao{events;constructor(e){this.events=e}}class ra{playbackRange;constructor(e){this.playbackRange=e}}class xh{soundFonts;sampleRate=44100;useSyncPoints=!1;masterVolume=1;metronomeVolume=0;playbackRange;trackVolume=new Map;trackTranspositionPitches=new Map}class Nh{samples;currentTime=0;endTime=0;currentTick=0;endTick=0}class Io{sequencer;synthesizer;isSoundFontLoaded=!1;_isMidiLoaded=!1;_tickPosition=0;_timePosition=0;_metronomeVolume=0;_countInVolume=0;playedEventsQueue=new fn;midiEventsPlayedFilterSet=new Set;_notPlayedSamples=0;_synthStopping=!1;_output;_loadedMidiInfo;_currentPosition=new js(0,0,0,0,!1,120,120);get output(){return this._output}isReady=!1;get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}state=vt.Paused;get logLevel(){return E.logLevel}set logLevel(e){E.logLevel=e}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,oe.MinVolume),this.updateMasterVolume(e)}updateMasterVolume(e){this.synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,oe.MinVolume),this._metronomeVolume=e,this.synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,oe.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this.midiEventsPlayedFilterSet)}set midiEventsPlayedFilter(e){this.midiEventsPlayedFilterSet=new Set(e)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(e){e=L.clamp(e,oe.MinPlaybackSpeed,oe.MaxPlaybackSpeed),this.updatePlaybackSpeed(e)}updatePlaybackSpeed(e){const t=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this.sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){E.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this.sequencer.mainSeek(e),this.updateTimePosition(e,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(e){this.sequencer.mainPlaybackRange=e,e&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new ra(e))}get isLooping(){return this.sequencer.isLooping}set isLooping(e){this.sequencer.isLooping=e}destroy(){E.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(e,t,s){E.debug("AlphaSynth","Initializing player"),this.state=vt.Paused,this.ready=new ct(()=>this.isReady),this.readyForPlayback=new ct(()=>this.isReadyForPlayback),this.midiLoaded=new ge(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new ge(()=>new er(this.state,!1)),this.positionChanged=new ge(()=>this._currentPosition),this.playbackRangeChanged=new ge(()=>this.playbackRange?new ra(this.playbackRange):null),E.debug("AlphaSynth","Creating output"),this._output=e,E.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=t,this.sequencer=new _o(this.synthesizer),E.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this._checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this._onSamplesPlayed.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===vt.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let e=new Float32Array(oe.MicroBufferSize*oe.MicroBufferCount*oe.AudioChannels),t=0;for(let s=0;s<oe.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const i=this.synthesizer.synthesize(e,t,oe.MicroBufferSize);t+=oe.MicroBufferSize*oe.AudioChannels;for(const r of i)this.midiEventsPlayedFilterSet.has(r.event.type)&&this.playedEventsQueue.enqueue(r);if(this.sequencer.isFinished)break}t<e.length&&(e=e.subarray(0,t)),this._notPlayedSamples+=e.length,this.output.addSamples(e)}else{const e=new Float32Array(0);this.output.addSamples(e)}}play(){return this.state!==vt.Paused||!this._isMidiLoaded?!1:(this.output.activate(),this._playInternal(),this._countInVolume>0&&(E.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}_playInternal(){this.sequencer.isPlayingOneTimeMidi&&(E.debug("AlphaSynth","Cancelling one time midi"),this._stopOneTimeMidi()),E.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=vt.Playing,this.stateChanged.trigger(new er(this.state,!1))}pause(){this.state===vt.Paused||!this._isMidiLoaded||(E.debug("AlphaSynth","Pausing playback"),this.state=vt.Paused,this.stateChanged.trigger(new er(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state!==vt.Paused||!this._isMidiLoaded?this.pause():this.play()}stop(){this._isMidiLoaded&&(E.debug("AlphaSynth","Stopping playback"),this.state=vt.Paused,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new er(this.state,!0)))}playOneTimeMidiFile(e){this.sequencer.isPlayingOneTimeMidi?this._stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(e),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}_loadedSoundFonts=[];loadSoundFont(e,t){this.pause();const s=pt.fromBuffer(e);try{E.debug("AlphaSynth","Loading soundfont from bytes");const i=new wo;i.load(s),t||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(i),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),E.debug("AlphaSynth","soundFont successfully loaded"),this._checkReadyForPlayback()}catch(i){E.error("AlphaSynth",`Could not load soundfont from bytes ${i}`),this.soundFontLoadFailed.trigger(i)}}_checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const e=this.sequencer.instrumentPrograms,t=this.sequencer.percussionKeys;let s=!1;for(const i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,e,t,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(e){this.stop();try{E.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(e),this._isMidiLoaded=!0,this._loadedMidiInfo=new js(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),E.debug("AlphaSynth","Midi successfully loaded"),this._checkReadyForPlayback(),this.tickPosition=0}catch(t){E.error("AlphaSynth",`Could not load midi from model ${t}`),this.midiLoadFailed.trigger(t)}}applyTranspositionPitches(e){this.synthesizer.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this.synthesizer.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this.synthesizer.channelSetMute(e,t)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(e,t){this.synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,oe.MinVolume),this.synthesizer.channelSetMixVolume(e,t)}_onSamplesPlayed(e){if(e===0)return;const t=e/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=e*oe.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish()}checkForFinish(){let e=0,t=0;this.playbackRange&&this.sequencer.isPlayingMain?(e=this.playbackRange.startTick,t=this.playbackRange.endTick):t=this.sequencer.currentEndTick,this._tickPosition>=t&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(E.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this._playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(E.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=vt.Paused,this._stopOneTimeMidi()):this.isLooping?(E.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(E.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,E.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(E.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}_stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}_createPositionChangedEventArgs(e){let t=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(t);const i=this.sequencer.currentEndTime,r=this.sequencer.currentEndTick;return t>i&&(t=i,s=r),new js(t,i,s,r,e,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(e,t){this._timePosition=e;const s=this._createPositionChangedEventArgs(t);this._tickPosition=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(E.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),t)this.playedEventsQueue.clear();else{const r=[];for(;!this.playedEventsQueue.isEmpty&&this.playedEventsQueue.peek().time<s.currentTime;){const n=this.playedEventsQueue.dequeue();r.push(n.event)}r.length>0&&(r.reverse(),this.midiEventsPlayed.trigger(new Ao(r)))}}ready;readyForPlayback=new ct;finished=new ct;soundFontLoaded=new ct;soundFontLoadFailed=new ge;midiLoaded;midiLoadFailed=new ge;stateChanged;positionChanged;midiEventsPlayed=new ge;playbackRangeChanged;hasSamplesForProgram(e){return this.synthesizer.hasSamplesForProgram(e)}hasSamplesForPercussion(e){return this.synthesizer.hasSamplesForPercussion(e)}loadBackingTrack(e){}updateSyncPoints(e){}}class Ph extends Io{constructor(e,t){super(e,new ia(e.sampleRate),t)}exportAudio(e,t,s,i){const r=new Ch(e);r.loadMidiFile(t),e.useSyncPoints&&r.updateSyncPoints(s),r.applyTranspositionPitches(i);for(const[n,o]of e.trackTranspositionPitches)r.setChannelTranspositionPitch(n,o);for(const[n,o]of e.trackVolume)r.channelSetMixVolume(n,o);if(e.soundFonts)for(const n of e.soundFonts)r.loadSoundFont(n);else r.loadPresets(this.synthesizer.presets);return e.playbackRange&&r.limitExport(e.playbackRange),r.setup(),r}}class Ch{_synth;_sequencer;constructor(e){this._synth=new ia(e.sampleRate),this._sequencer=new _o(this._synth),this._synth.masterVolume=Math.max(e.masterVolume,oe.MinVolume),this._synth.metronomeVolume=Math.max(e.metronomeVolume,oe.MinVolume)}loadSoundFont(e){const t=pt.fromBuffer(e),s=new wo;s.load(t);const i=this._sequencer.instrumentPrograms,r=this._sequencer.percussionKeys;this._synth.loadPresets(s,i,r,!0)}loadPresets(e){this._synth.presets=e}limitExport(e){this._sequencer.mainPlaybackRange=e,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(e.startTick))}setChannelTranspositionPitch(e,t){this._synth.setChannelTranspositionPitch(e,t)}applyTranspositionPitches(e){this._synth.applyTranspositionPitches(e)}loadMidiFile(e){this._sequencer.loadMidi(e)}updateSyncPoints(e){this._sequencer.mainUpdateSyncPoints(e)}channelSetMixVolume(e,t){t=Math.max(t,oe.MinVolume),this._synth.channelSetMixVolume(e,t)}_generatedAudioCurrentTime=0;_generatedAudioEndTime=0;setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);const e=this._sequencer.currentSyncPoints,t=this._sequencer.currentEndTime;if(e.length===0)this._generatedAudioEndTime=t;else{const s=e[e.length-1];let i=s.syncTime;const r=this._sequencer.currentEndTick-s.synthTick;r>0&&(i+=x.ticksToMillis(r,s.syncBpm)),this._generatedAudioEndTime=i}}render(e){if(this._sequencer.isFinished)return;const t=oe.MicroBufferSize*1e3/this._synth.outSampleRate,s=Math.ceil(e/t);let i=new Float32Array(oe.MicroBufferSize*s*oe.AudioChannels);const r=this._sequencer.currentSyncPoints;let n=0,o=this._generatedAudioCurrentTime;for(let h=0;h<s;h++){if(r.length>0){this._sequencer.currentUpdateSyncPoints(o),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);const c=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==c&&(this._sequencer.playbackSpeed=c)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,n,oe.MicroBufferSize),n+=oe.MicroBufferSize*oe.AudioChannels,o+=t,this._sequencer.isFinished)break}n<i.length&&(i=i.subarray(0,n));const l=new Nh;return l.currentTime=this._generatedAudioCurrentTime,l.endTime=this._generatedAudioEndTime,l.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),l.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=e,l.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),l}}class N{static parseEnum(e,t){switch(typeof e){case"string":const s=Number.parseInt(e,10);return Number.isNaN(s)?t[Object.keys(t).find(i=>i.toLowerCase()===e.toLowerCase())]:s;case"number":return e;case"undefined":case"object":return}throw new Ve(Oe.Format,`Could not parse enum value '${e}'`)}static parseEnumExact(e,t){if(e in t)return t[e]}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if(typeof e=="object")for(const s in e)t(e[s],s)}static getValue(e,t){return e instanceof Map?e.get(t):typeof e=="object"?e[t]:null}}class Eh{startPos;endPos;text;constructor(e,t,s){this.text=e,this.startPos=t,this.endPos=s}}class sr{style="normal";variant="normal";weight="normal";stretch="normal";lineHeight="normal";size="1rem";families=[];parseOnlyFamilies=!1;_tokens;_currentTokenIndex=-1;_input="";_currentToken=null;constructor(e){this._input=e,this._tokens=this._splitToTokens(e)}_splitToTokens(e){const t=[];let s=0;for(;s<e.length;){let i=s;for(;i<e.length&&e.charAt(i)!==" ";)i++;i>s&&t.push(new Eh(e.substring(s,i),s,i)),s=i+1}return t}parse(){if(this._reset(),this._tokens.length===1)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this._fontStyleVariantWeight(),this._fontSizeLineHeight()),this._fontFamily()}static parseFamilies(e){const t=new sr(e);return t.parseOnlyFamilies=!0,t.parse(),t.families}_fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const e=this._input.substr(this._currentToken.startPos).trim();let t=0;for(;t<e.length;){const s=e.charAt(t);if(s===" "||s===",")t++;else if(s==='"'||s==="'"){const i=this._findEndOfQuote(e,t+1,s);this.families.push(e.substring(t+1,i).split(`\\${s}`).join(s)),t=i+1}else{const i=this._findEndOfQuote(e,t+1,",");this.families.push(e.substring(t,i).trim()),t=i+1}}}_findEndOfQuote(e,t,s){let i=!1;for(;t<e.length;){const r=e.charAt(t);if(!i&&r===s)return t;!i&&r==="\\"?i=!0:i=!1,t+=1}return e.length}_fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");const e=this._currentToken.text.split("/");if(e.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this._nextToken(),e.length>=2)if(e[1]==="/"){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.size=e[0],this.lineHeight=e[1];else if(e.length>=1){if(this.size=e[0],this._currentToken&&this._currentToken.text.indexOf("/")===0)if(this._currentToken.text==="/"){if(this._nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this._nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this._nextToken()}else throw new Error("Missing font size")}_nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}_fontStyleVariantWeight(){let e=!1,t=!1,s=!1,i=3;const r=[];for(;;){if(!this._currentToken)return;const n=this._currentToken.text;switch(n){case"normal":case"inherit":r.push(n),i--,this._nextToken();break;case"italic":case"oblique":this.style=n,e=!0,i--,this._nextToken();break;case"small-caps":this.variant=n,t=!0,i--,this._nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=n,s=!0,i--,this._nextToken();break;default:return}if(i===0)break}for(;r.length>0;){const n=r.pop();s?t?e||(this.style=n):this.variant=n:this.weight=n}}_reset(){this._currentTokenIndex=-1,this._nextToken()}static quoteFont(e){return e.indexOf(" ")===-1?e:`"${e.replaceAll('"','\\"')}"`}}var st;(function(a){a[a.Plain=0]="Plain",a[a.Italic=1]="Italic"})(st||(st={}));var ts;(function(a){a[a.Regular=0]="Regular",a[a.Bold=1]="Bold"})(ts||(ts={}));class pe{_css;_cssScale=0;_families;_style;_weight;_size;_reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=sr.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this._reset()}get size(){return this._size}set size(e){this._size=e,this._reset()}get style(){return this._style}set style(e){this._style=e,this._reset()}get weight(){return this._weight}set weight(e){this._weight=e,this._reset()}get isBold(){return this.weight===ts.Bold}get isItalic(){return this.style===st.Italic}constructor(e,t,s=st.Plain,i=ts.Regular){this._families=sr.parseFamilies(e),this._size=t,this._style=s,this._weight=i,this._css=this.toCssString()}withSize(e){return pe.withFamilyList(this._families,e,this._style,this._weight)}static withFamilyList(e,t,s=st.Plain,i=ts.Regular){const r=new pe("",t,s,i);return r.families=e,r}toCssString(e=1){if(!this._css||!(Math.abs(e-this._cssScale)<.01)){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+=this.families.map(s=>sr.quoteFont(s)).join(", "),this._css=t,this._cssScale=e}return this._css}static fromJson(e){if(e instanceof pe)return e;switch(typeof e){case"undefined":return;case"object":{const t=e,s=t.get("families"),i=t.get("size"),r=N.parseEnum(t.get("style"),st),n=N.parseEnum(t.get("weight"),ts);return pe.withFamilyList(s,i,r,n)}case"string":{const t=new sr(e);t.parse();const s=t.families,i=t.size.toLowerCase();let r=0;switch(i){case"xx-small":r=7;break;case"x-small":r=10;break;case"small":case"smaller":r=13;break;case"medium":r=16;break;case"large":case"larger":r=18;break;case"x-large":r=24;break;case"xx-large":r=32;break;default:try{i.endsWith("em")?r=Number.parseFloat(i.substr(0,i.length-2))*16:i.endsWith("pt")?r=Number.parseFloat(i.substr(0,i.length-2))*16/12:i.endsWith("px")?r=Number.parseFloat(i.substr(0,i.length-2)):r=12}catch{r=12}break}let n=st.Plain;t.style==="italic"&&(n=st.Italic);let o=ts.Regular;switch(t.weight.toLowerCase()){case"normal":case"lighter":break;default:o=ts.Bold;break}return pe.withFamilyList(s,r,n,o)}default:return}}static toJson(e){if(!e)return;const t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}}class vh{static clone(e){const t=new Ls;return t.musicFontSize=e.musicFontSize,t.oneStaffSpace=e.oneStaffSpace,t.tabLineSpacing=e.tabLineSpacing,t.arrowShaftThickness=e.arrowShaftThickness,t.barlineSeparation=e.barlineSeparation,t.beamSpacing=e.beamSpacing,t.beamThickness=e.beamThickness,t.bracketThickness=e.bracketThickness,t.dashedBarlineDashLength=e.dashedBarlineDashLength,t.dashedBarlineGapLength=e.dashedBarlineGapLength,t.dashedBarlineThickness=e.dashedBarlineThickness,t.hairpinThickness=e.hairpinThickness,t.legerLineThickness=e.legerLineThickness,t.legerLineExtension=e.legerLineExtension,t.octaveLineThickness=e.octaveLineThickness,t.pedalLineThickness=e.pedalLineThickness,t.repeatBarlineDotSeparation=e.repeatBarlineDotSeparation,t.repeatEndingLineThickness=e.repeatEndingLineThickness,t.slurMidpointThickness=e.slurMidpointThickness,t.staffLineThickness=e.staffLineThickness,t.stemThickness=e.stemThickness,t.thickBarlineThickness=e.thickBarlineThickness,t.thinBarlineThickness=e.thinBarlineThickness,t.thinThickBarlineSeparation=e.thinThickBarlineSeparation,t.tieMidpointThickness=e.tieMidpointThickness,t.tupletBracketThickness=e.tupletBracketThickness,t.stemUp=new Map(e.stemUp),t.stemDown=new Map(e.stemDown),t.repeatOffsetX=new Map(e.repeatOffsetX),t.standardStemLength=e.standardStemLength,t.stemFlagOffsets=new Map(e.stemFlagOffsets),t.glyphTop=new Map(e.glyphTop),t.glyphBottom=new Map(e.glyphBottom),t.glyphWidths=new Map(e.glyphWidths),t.glyphHeights=new Map(e.glyphHeights),t.numberedBarRendererBarSize=e.numberedBarRendererBarSize,t.numberedBarRendererBarSpacing=e.numberedBarRendererBarSpacing,t.numberedDashGlyphPadding=e.numberedDashGlyphPadding,t.numberedDashGlyphWidth=e.numberedDashGlyphWidth,t.lineRangedGlyphDashGap=e.lineRangedGlyphDashGap,t.lineRangedGlyphDashSize=e.lineRangedGlyphDashSize,t.preNoteEffectPadding=e.preNoteEffectPadding,t.postNoteEffectPadding=e.postNoteEffectPadding,t.onNoteEffectPadding=e.onNoteEffectPadding,t.stringNumberCirclePadding=e.stringNumberCirclePadding,t.rowContainerPadding=e.rowContainerPadding,t.rowContainerGap=e.rowContainerGap,t.alternateEndingsPadding=e.alternateEndingsPadding,t.sustainPedalLinePadding=e.sustainPedalLinePadding,t.tieHeight=e.tieHeight,t.beatTimerPadding=e.beatTimerPadding,t.bendNoteHeadElementPadding=e.bendNoteHeadElementPadding,t.ghostParenthesisWidth=e.ghostParenthesisWidth,t.ghostParenthesisPadding=e.ghostParenthesisPadding,t.brokenBeamWidth=e.brokenBeamWidth,t.tabWhammyTextPadding=e.tabWhammyTextPadding,t.tabWhammyPerHalfHeight=e.tabWhammyPerHalfHeight,t.tabWhammyDashSize=e.tabWhammyDashSize,t.songBookWhammyDipHeight=e.songBookWhammyDipHeight,t.deadSlappedLineWidth=e.deadSlappedLineWidth,t.leftHandTabTieWidth=e.leftHandTabTieWidth,t.tabBendDashSize=e.tabBendDashSize,t.tabBendPerValueHeight=e.tabBendPerValueHeight,t.tabBendLabelPadding=e.tabBendLabelPadding,t.simpleSlideWidth=e.simpleSlideWidth,t.simpleSlideHeight=e.simpleSlideHeight,t.chordDiagramPaddingX=e.chordDiagramPaddingX,t.chordDiagramPaddingY=e.chordDiagramPaddingY,t.chordDiagramStringSpacing=e.chordDiagramStringSpacing,t.chordDiagramFretSpacing=e.chordDiagramFretSpacing,t.chordDiagramNutHeight=e.chordDiagramNutHeight,t.chordDiagramFretHeight=e.chordDiagramFretHeight,t.chordDiagramLineWidth=e.chordDiagramLineWidth,t.tripletFeelBracketPadding=e.tripletFeelBracketPadding,t.accidentalPadding=e.accidentalPadding,t.preBeatGlyphSpacing=e.preBeatGlyphSpacing,t.tempoNoteScale=e.tempoNoteScale,t.tuningGlyphCircleNumberScale=e.tuningGlyphCircleNumberScale,t.tuningGlyphStringColumnScale=e.tuningGlyphStringColumnScale,t.tuningGlyphStringRowPadding=e.tuningGlyphStringRowPadding,t.directionsScale=e.directionsScale,t}}class aa{topY=0;bottomY=0;x=0}class Ls{static _bravuraDefaults;static get bravuraDefaults(){let e=Ls._bravuraDefaults;return e||(e=new Ls,e.fillFromSmufl(Ls.bravuraMetadata),Ls._bravuraDefaults=e),vh.clone(e)}musicFontSize=0;oneStaffSpace=0;tabLineSpacing=0;arrowShaftThickness=0;barlineSeparation=0;beamSpacing=0;beamThickness=0;bracketThickness=0;dashedBarlineDashLength=0;dashedBarlineGapLength=0;dashedBarlineThickness=0;hairpinThickness=0;legerLineThickness=0;legerLineExtension=0;octaveLineThickness=0;pedalLineThickness=0;repeatBarlineDotSeparation=0;repeatEndingLineThickness=0;slurMidpointThickness=0;staffLineThickness=0;stemThickness=0;thickBarlineThickness=0;thinBarlineThickness=0;thinThickBarlineSeparation=0;tieMidpointThickness=0;tupletBracketThickness=0;stemUp=new Map;stemDown=new Map;repeatOffsetX=new Map;standardStemLength=0;stemFlagOffsets=new Map;glyphTop=new Map;glyphBottom=new Map;glyphWidths=new Map;glyphHeights=new Map;hasSymbol(e){return this.glyphWidths.get(e)>0&&this.glyphHeights.get(e)>0}fillFromSmufl(e,t=36){this.musicFontSize=t,this.oneStaffSpace=t/4,this.tabLineSpacing=Math.floor(this.oneStaffSpace*1.5),this.arrowShaftThickness=e.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=e.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=e.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=e.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=e.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=e.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=e.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=e.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=e.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=e.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=e.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=e.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=e.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=e.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=e.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=e.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=e.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=e.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=e.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,typeof e.engravingDefaults.thinThickBarlineSeparation=="number"?this.thinThickBarlineSeparation=e.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=e.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=e.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(y.QuadrupleWhole,0),this.stemFlagOffsets.set(y.DoubleWhole,0),this.stemFlagOffsets.set(y.Whole,0),this.stemFlagOffsets.set(y.Half,0),this.stemFlagOffsets.set(y.Quarter,0),this.stemFlagOffsets.set(y.Eighth,0),this.stemFlagOffsets.set(y.Sixteenth,0),this.stemFlagOffsets.set(y.ThirtySecond,0),this.stemFlagOffsets.set(y.SixtyFourth,0),this.stemFlagOffsets.set(y.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(y.TwoHundredFiftySixth,0);for(const[o,l]of Object.entries(e.glyphsWithAnchors)){const h=Ls._smuflNameToMusicFontSymbol(o);if(h){if(l.stemDownNW){const c=new aa;c.x=l.stemDownNW[0]*this.oneStaffSpace,c.topY=l.stemDownNW[1]*this.oneStaffSpace,l.stemDownSW?c.bottomY=l.stemDownSW[1]*this.oneStaffSpace:c.bottomY=0,this.stemDown.set(h,c)}if(l.stemUpSE){const c=new aa,d=l.stemUpSE[0]*this.oneStaffSpace;c.bottomY=l.stemUpSE[1]*this.oneStaffSpace,l.stemUpNW?(c.x=l.stemUpNW[0]*this.oneStaffSpace,c.topY=l.stemUpNW[1]*this.oneStaffSpace):(c.x=d-this.stemThickness,c.topY=0),this.stemUp.set(h,c)}if(l.repeatOffset&&this.repeatOffsetX.set(h,l.repeatOffset[0]*this.oneStaffSpace),l.stemUpNW){const c=l.stemUpNW[1]*this.oneStaffSpace;switch(h){case u.Flag8thUp:this.stemFlagOffsets.set(y.Eighth,c);break;case u.Flag16thUp:this.stemFlagOffsets.set(y.Sixteenth,c);break;case u.Flag32ndUp:this.stemFlagOffsets.set(y.ThirtySecond,c);break;case u.Flag64thUp:this.stemFlagOffsets.set(y.SixtyFourth,c);break;case u.Flag128thUp:this.stemFlagOffsets.set(y.OneHundredTwentyEighth,c);break;case u.Flag256thUp:this.stemFlagOffsets.set(y.TwoHundredFiftySixth,c);break}}}}const i=new Set,r=e.glyphBBoxes;if(r)for(const[o,l]of Object.entries(r)){const h=Ls._smuflNameToMusicFontSymbol(o);h&&(i.add(h),this.glyphTop.set(h,l.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(h,l.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(h,(l.bBoxNE[0]-l.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(h,(l.bBoxNE[1]-l.bBoxSW[1])*this.oneStaffSpace))}const n=new Set([u.None,u.Space,u.NoteheadNull]);for(const o of L.getAllMusicFontSymbols())i.has(o)||(n.has(o)||E.warning("SmuFL",`The provided SmuFL font is missing the glyph ${u[o]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(o,0),this.glyphBottom.set(o,0),this.glyphWidths.set(o,0),this.glyphHeights.set(o,0));this.numberedBarRendererBarSize=this.staffLineThickness*2,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]);static _smuflNameToMusicFontSymbol(e){const t=Ls.smuflNameToGlyphNameMapping.has(e)?Ls.smuflNameToGlyphNameMapping.get(e):e.substring(0,1).toUpperCase()+e.substring(1);return N.parseEnumExact(t,u)}numberedBarRendererBarSize=0;numberedBarRendererBarSpacing=0;numberedDashGlyphPadding=0;numberedDashGlyphWidth=0;lineRangedGlyphDashGap=0;lineRangedGlyphDashSize=0;preNoteEffectPadding=0;postNoteEffectPadding=0;onNoteEffectPadding=0;stringNumberCirclePadding=0;rowContainerPadding=0;rowContainerGap=0;alternateEndingsPadding=0;sustainPedalLinePadding=0;tieHeight=0;beatTimerPadding=0;bendNoteHeadElementPadding=0;ghostParenthesisWidth=0;ghostParenthesisPadding=0;brokenBeamWidth=0;tabWhammyTextPadding=0;tabWhammyPerHalfHeight=0;tabWhammyDashSize=0;songBookWhammyDipHeight=0;deadSlappedLineWidth=0;leftHandTabTieWidth=0;tabBendDashSize=0;tabBendPerValueHeight=0;tabBendLabelPadding=0;simpleSlideWidth=0;simpleSlideHeight=0;chordDiagramPaddingX=0;chordDiagramPaddingY=0;chordDiagramStringSpacing=0;chordDiagramFretSpacing=0;chordDiagramNutHeight=0;chordDiagramFretHeight=0;chordDiagramLineWidth=0;tripletFeelBracketPadding=0;accidentalPadding=0;preBeatGlyphSpacing=0;tempoNoteScale=.7;tuningGlyphCircleNumberScale=.7;tuningGlyphStringColumnScale=1.5;tuningGlyphStringRowPadding=0;directionsScale=.6;static bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}}}class zt{static _sansFont="Arial, sans-serif";static _serifFont="Georgia, serif";smuflFontFamilyName;engravingSettings=Ls.bravuraDefaults;copyrightFont=new pe(zt._sansFont,12,st.Plain,ts.Bold);titleFont=new pe(zt._serifFont,32,st.Plain);subTitleFont=new pe(zt._serifFont,20,st.Plain);wordsFont=new pe(zt._serifFont,15,st.Plain);effectFont=new pe(zt._serifFont,12,st.Italic);timerFont=new pe(zt._serifFont,12,st.Plain);directionsFont=new pe(zt._serifFont,14,st.Plain);fretboardNumberFont=new pe(zt._sansFont,11,st.Plain);numberedNotationFont=new pe(zt._sansFont,16,st.Plain);numberedNotationGraceFont=new pe(zt._sansFont,14,st.Plain);tablatureFont=new pe(zt._sansFont,14,st.Plain);graceFont=new pe(zt._sansFont,12,st.Plain);staffLineColor=new Ce(165,165,165,255);barSeparatorColor=new Ce(34,34,17,255);barNumberFont=new pe(zt._sansFont,11,st.Plain);barNumberColor=new Ce(200,0,0,255);fingeringFont=new pe(zt._serifFont,14,st.Plain);inlineFingeringFont=new pe(zt._serifFont,12,st.Plain);markerFont=new pe(zt._serifFont,14,st.Plain,ts.Bold);mainGlyphColor=new Ce(0,0,0,255);secondaryGlyphColor=new Ce(0,0,0,100);scoreInfoColor=new Ce(0,0,0,255);getFontForElement(e){switch(e){case O.Title:return this.titleFont;case O.SubTitle:case O.Artist:case O.Album:return this.subTitleFont;case O.Words:case O.Music:case O.WordsAndMusic:case O.Transcriber:return this.wordsFont;case O.Copyright:case O.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}var ii;(function(a){a[a.Default=0]="Default",a[a.ScoreTab=1]="ScoreTab",a[a.Score=2]="Score",a[a.Tab=3]="Tab",a[a.TabMixed=4]="TabMixed"})(ii||(ii={}));var yi;(function(a){a[a.Automatic=0]="Automatic",a[a.UseModelLayout=1]="UseModelLayout"})(yi||(yi={}));class Dh{scale=1;stretchForce=1;layoutMode=$s.Page;staveProfile=ii.Default;barsPerRow=-1;startBar=1;barCount=-1;barCountPerPartial=10;justifyLastSystem=!1;resources=new zt;padding=[35,35];firstSystemPaddingTop=5;systemPaddingTop=10;systemPaddingBottom=10;lastSystemPaddingBottom=0;systemLabelPaddingLeft=0;systemLabelPaddingRight=3;accoladeBarPaddingRight=3;notationStaffPaddingTop=5;notationStaffPaddingBottom=5;effectStaffPaddingTop=0;effectStaffPaddingBottom=0;firstStaffPaddingLeft=6;staffPaddingLeft=2;effectBandPaddingBottom=2;systemsLayoutMode=yi.Automatic}class Lh{encoding="utf-8";mergePartGroupsInMusicXml=!1;beatTextAsLyrics=!1}var ri;(function(a){a[a.Off=0]="Off",a[a.Continuous=1]="Continuous",a[a.OffScreen=2]="OffScreen"})(ri||(ri={}));class Fh{noteWideLength=240;noteWideAmplitude=1;noteSlightLength=360;noteSlightAmplitude=.5;beatWideLength=480;beatWideAmplitude=2;beatSlightLength=480;beatSlightAmplitude=2}class Mh{simpleSlidePitchOffset=6;simpleSlideDurationRatio=.25;shiftSlideDurationRatio=.5}var Sr;(function(a){a[a.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",a[a.WebAudioScriptProcessor=1]="WebAudioScriptProcessor"})(Sr||(Sr={}));var Yt;(function(a){a[a.Disabled=0]="Disabled",a[a.EnabledAutomatic=1]="EnabledAutomatic",a[a.EnabledSynthesizer=2]="EnabledSynthesizer",a[a.EnabledBackingTrack=3]="EnabledBackingTrack",a[a.EnabledExternalMedia=4]="EnabledExternalMedia"})(Yt||(Yt={}));class Ah{soundFont=null;scrollElement="html,body";outputMode=Sr.WebAudioAudioWorklets;enablePlayer=!1;playerMode=Yt.Disabled;enableCursor=!0;enableAnimatedBeatCursor=!0;enableElementHighlighting=!0;enableUserInteraction=!0;scrollOffsetX=0;scrollOffsetY=0;scrollMode=ri.Continuous;scrollSpeed=300;nativeBrowserSmoothScroll=!0;songBookBendDuration=75;songBookDipDuration=150;vibrato=new Fh;slide=new Mh;playTripletFeel=!0;bufferTimeInMilliseconds=500}class kr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>kr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),e.smuflFontSources!==null){const s=new Map;t.set("smuflfontsources",s);for(const[i,r]of e.smuflFontSources)s.set(i.toString(),r)}return t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(e,t,s){switch(t){case"scriptfile":return e.scriptFile=s,!0;case"fontdirectory":return e.fontDirectory=s,!0;case"smuflfontsources":return e.smuflFontSources=new Map,N.forEach(s,(i,r)=>{e.smuflFontSources.set(N.parseEnum(r,Ns),i)}),!0;case"file":return e.file=s,!0;case"tex":return e.tex=s,!0;case"tracks":return e.tracks=s,!0;case"enablelazyloading":return e.enableLazyLoading=s,!0;case"engine":return e.engine=s,!0;case"loglevel":return e.logLevel=N.parseEnum(s,Es),!0;case"useworkers":return e.useWorkers=s,!0;case"includenotebounds":return e.includeNoteBounds=s,!0}return!1}}class ir{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ir.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("topy",e.topY),t.set("bottomy",e.bottomY),t.set("x",e.x),t}static setProperty(e,t,s){switch(t){case"topy":return e.topY=s,!0;case"bottomy":return e.bottomY=s,!0;case"x":return e.x=s,!0}return!1}}class na{static fromJson(e,t){t&&N.forEach(t,(s,i)=>na.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;t.set("musicfontsize",e.musicFontSize),t.set("onestaffspace",e.oneStaffSpace),t.set("tablinespacing",e.tabLineSpacing),t.set("arrowshaftthickness",e.arrowShaftThickness),t.set("barlineseparation",e.barlineSeparation),t.set("beamspacing",e.beamSpacing),t.set("beamthickness",e.beamThickness),t.set("bracketthickness",e.bracketThickness),t.set("dashedbarlinedashlength",e.dashedBarlineDashLength),t.set("dashedbarlinegaplength",e.dashedBarlineGapLength),t.set("dashedbarlinethickness",e.dashedBarlineThickness),t.set("hairpinthickness",e.hairpinThickness),t.set("legerlinethickness",e.legerLineThickness),t.set("legerlineextension",e.legerLineExtension),t.set("octavelinethickness",e.octaveLineThickness),t.set("pedallinethickness",e.pedalLineThickness),t.set("repeatbarlinedotseparation",e.repeatBarlineDotSeparation),t.set("repeatendinglinethickness",e.repeatEndingLineThickness),t.set("slurmidpointthickness",e.slurMidpointThickness),t.set("stafflinethickness",e.staffLineThickness),t.set("stemthickness",e.stemThickness),t.set("thickbarlinethickness",e.thickBarlineThickness),t.set("thinbarlinethickness",e.thinBarlineThickness),t.set("thinthickbarlineseparation",e.thinThickBarlineSeparation),t.set("tiemidpointthickness",e.tieMidpointThickness),t.set("tupletbracketthickness",e.tupletBracketThickness);{const s=new Map;t.set("stemup",s);for(const[i,r]of e.stemUp)s.set(i.toString(),ir.toJson(r))}{const s=new Map;t.set("stemdown",s);for(const[i,r]of e.stemDown)s.set(i.toString(),ir.toJson(r))}{const s=new Map;t.set("repeatoffsetx",s);for(const[i,r]of e.repeatOffsetX)s.set(i.toString(),r)}t.set("standardstemlength",e.standardStemLength);{const s=new Map;t.set("stemflagoffsets",s);for(const[i,r]of e.stemFlagOffsets)s.set(i.toString(),r)}{const s=new Map;t.set("glyphtop",s);for(const[i,r]of e.glyphTop)s.set(i.toString(),r)}{const s=new Map;t.set("glyphbottom",s);for(const[i,r]of e.glyphBottom)s.set(i.toString(),r)}{const s=new Map;t.set("glyphwidths",s);for(const[i,r]of e.glyphWidths)s.set(i.toString(),r)}{const s=new Map;t.set("glyphheights",s);for(const[i,r]of e.glyphHeights)s.set(i.toString(),r)}return t.set("numberedbarrendererbarsize",e.numberedBarRendererBarSize),t.set("numberedbarrendererbarspacing",e.numberedBarRendererBarSpacing),t.set("numbereddashglyphpadding",e.numberedDashGlyphPadding),t.set("numbereddashglyphwidth",e.numberedDashGlyphWidth),t.set("linerangedglyphdashgap",e.lineRangedGlyphDashGap),t.set("linerangedglyphdashsize",e.lineRangedGlyphDashSize),t.set("prenoteeffectpadding",e.preNoteEffectPadding),t.set("postnoteeffectpadding",e.postNoteEffectPadding),t.set("onnoteeffectpadding",e.onNoteEffectPadding),t.set("stringnumbercirclepadding",e.stringNumberCirclePadding),t.set("rowcontainerpadding",e.rowContainerPadding),t.set("rowcontainergap",e.rowContainerGap),t.set("alternateendingspadding",e.alternateEndingsPadding),t.set("sustainpedallinepadding",e.sustainPedalLinePadding),t.set("tieheight",e.tieHeight),t.set("beattimerpadding",e.beatTimerPadding),t.set("bendnoteheadelementpadding",e.bendNoteHeadElementPadding),t.set("ghostparenthesiswidth",e.ghostParenthesisWidth),t.set("ghostparenthesispadding",e.ghostParenthesisPadding),t.set("brokenbeamwidth",e.brokenBeamWidth),t.set("tabwhammytextpadding",e.tabWhammyTextPadding),t.set("tabwhammyperhalfheight",e.tabWhammyPerHalfHeight),t.set("tabwhammydashsize",e.tabWhammyDashSize),t.set("songbookwhammydipheight",e.songBookWhammyDipHeight),t.set("deadslappedlinewidth",e.deadSlappedLineWidth),t.set("lefthandtabtiewidth",e.leftHandTabTieWidth),t.set("tabbenddashsize",e.tabBendDashSize),t.set("tabbendpervalueheight",e.tabBendPerValueHeight),t.set("tabbendlabelpadding",e.tabBendLabelPadding),t.set("simpleslidewidth",e.simpleSlideWidth),t.set("simpleslideheight",e.simpleSlideHeight),t.set("chorddiagrampaddingx",e.chordDiagramPaddingX),t.set("chorddiagrampaddingy",e.chordDiagramPaddingY),t.set("chorddiagramstringspacing",e.chordDiagramStringSpacing),t.set("chorddiagramfretspacing",e.chordDiagramFretSpacing),t.set("chorddiagramnutheight",e.chordDiagramNutHeight),t.set("chorddiagramfretheight",e.chordDiagramFretHeight),t.set("chorddiagramlinewidth",e.chordDiagramLineWidth),t.set("tripletfeelbracketpadding",e.tripletFeelBracketPadding),t.set("accidentalpadding",e.accidentalPadding),t.set("prebeatglyphspacing",e.preBeatGlyphSpacing),t.set("temponotescale",e.tempoNoteScale),t.set("tuningglyphcirclenumberscale",e.tuningGlyphCircleNumberScale),t.set("tuningglyphstringcolumnscale",e.tuningGlyphStringColumnScale),t.set("tuningglyphstringrowpadding",e.tuningGlyphStringRowPadding),t.set("directionsscale",e.directionsScale),t}static setProperty(e,t,s){switch(t){case"musicfontsize":return e.musicFontSize=s,!0;case"onestaffspace":return e.oneStaffSpace=s,!0;case"tablinespacing":return e.tabLineSpacing=s,!0;case"arrowshaftthickness":return e.arrowShaftThickness=s,!0;case"barlineseparation":return e.barlineSeparation=s,!0;case"beamspacing":return e.beamSpacing=s,!0;case"beamthickness":return e.beamThickness=s,!0;case"bracketthickness":return e.bracketThickness=s,!0;case"dashedbarlinedashlength":return e.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return e.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return e.dashedBarlineThickness=s,!0;case"hairpinthickness":return e.hairpinThickness=s,!0;case"legerlinethickness":return e.legerLineThickness=s,!0;case"legerlineextension":return e.legerLineExtension=s,!0;case"octavelinethickness":return e.octaveLineThickness=s,!0;case"pedallinethickness":return e.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return e.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return e.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return e.slurMidpointThickness=s,!0;case"stafflinethickness":return e.staffLineThickness=s,!0;case"stemthickness":return e.stemThickness=s,!0;case"thickbarlinethickness":return e.thickBarlineThickness=s,!0;case"thinbarlinethickness":return e.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return e.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return e.tieMidpointThickness=s,!0;case"tupletbracketthickness":return e.tupletBracketThickness=s,!0;case"stemup":return e.stemUp=new Map,N.forEach(s,(i,r)=>{const n=new aa;ir.fromJson(n,i),e.stemUp.set(N.parseEnum(r,u),n)}),!0;case"stemdown":return e.stemDown=new Map,N.forEach(s,(i,r)=>{const n=new aa;ir.fromJson(n,i),e.stemDown.set(N.parseEnum(r,u),n)}),!0;case"repeatoffsetx":return e.repeatOffsetX=new Map,N.forEach(s,(i,r)=>{e.repeatOffsetX.set(N.parseEnum(r,u),i)}),!0;case"standardstemlength":return e.standardStemLength=s,!0;case"stemflagoffsets":return e.stemFlagOffsets=new Map,N.forEach(s,(i,r)=>{e.stemFlagOffsets.set(N.parseEnum(r,y),i)}),!0;case"glyphtop":return e.glyphTop=new Map,N.forEach(s,(i,r)=>{e.glyphTop.set(N.parseEnum(r,u),i)}),!0;case"glyphbottom":return e.glyphBottom=new Map,N.forEach(s,(i,r)=>{e.glyphBottom.set(N.parseEnum(r,u),i)}),!0;case"glyphwidths":return e.glyphWidths=new Map,N.forEach(s,(i,r)=>{e.glyphWidths.set(N.parseEnum(r,u),i)}),!0;case"glyphheights":return e.glyphHeights=new Map,N.forEach(s,(i,r)=>{e.glyphHeights.set(N.parseEnum(r,u),i)}),!0;case"numberedbarrendererbarsize":return e.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return e.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return e.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return e.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return e.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return e.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return e.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return e.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return e.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return e.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return e.rowContainerPadding=s,!0;case"rowcontainergap":return e.rowContainerGap=s,!0;case"alternateendingspadding":return e.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return e.sustainPedalLinePadding=s,!0;case"tieheight":return e.tieHeight=s,!0;case"beattimerpadding":return e.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return e.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return e.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return e.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return e.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return e.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return e.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return e.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return e.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return e.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return e.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return e.tabBendDashSize=s,!0;case"tabbendpervalueheight":return e.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return e.tabBendLabelPadding=s,!0;case"simpleslidewidth":return e.simpleSlideWidth=s,!0;case"simpleslideheight":return e.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return e.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return e.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return e.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return e.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return e.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return e.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return e.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return e.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return e.accidentalPadding=s,!0;case"prebeatglyphspacing":return e.preBeatGlyphSpacing=s,!0;case"temponotescale":return e.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return e.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return e.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return e.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return e.directionsScale=s,!0}return!1}}class wr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>wr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("smuflfontfamilyname",e.smuflFontFamilyName),t.set("engravingsettings",na.toJson(e.engravingSettings)),t.set("copyrightfont",pe.toJson(e.copyrightFont)),t.set("titlefont",pe.toJson(e.titleFont)),t.set("subtitlefont",pe.toJson(e.subTitleFont)),t.set("wordsfont",pe.toJson(e.wordsFont)),t.set("effectfont",pe.toJson(e.effectFont)),t.set("timerfont",pe.toJson(e.timerFont)),t.set("directionsfont",pe.toJson(e.directionsFont)),t.set("fretboardnumberfont",pe.toJson(e.fretboardNumberFont)),t.set("numberednotationfont",pe.toJson(e.numberedNotationFont)),t.set("numberednotationgracefont",pe.toJson(e.numberedNotationGraceFont)),t.set("tablaturefont",pe.toJson(e.tablatureFont)),t.set("gracefont",pe.toJson(e.graceFont)),t.set("stafflinecolor",Ce.toJson(e.staffLineColor)),t.set("barseparatorcolor",Ce.toJson(e.barSeparatorColor)),t.set("barnumberfont",pe.toJson(e.barNumberFont)),t.set("barnumbercolor",Ce.toJson(e.barNumberColor)),t.set("fingeringfont",pe.toJson(e.fingeringFont)),t.set("inlinefingeringfont",pe.toJson(e.inlineFingeringFont)),t.set("markerfont",pe.toJson(e.markerFont)),t.set("mainglyphcolor",Ce.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",Ce.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",Ce.toJson(e.scoreInfoColor)),t}static setProperty(e,t,s){switch(t){case"smuflfontfamilyname":return e.smuflFontFamilyName=s,!0;case"copyrightfont":return e.copyrightFont=pe.fromJson(s),!0;case"titlefont":return e.titleFont=pe.fromJson(s),!0;case"subtitlefont":return e.subTitleFont=pe.fromJson(s),!0;case"wordsfont":return e.wordsFont=pe.fromJson(s),!0;case"effectfont":return e.effectFont=pe.fromJson(s),!0;case"timerfont":return e.timerFont=pe.fromJson(s),!0;case"directionsfont":return e.directionsFont=pe.fromJson(s),!0;case"fretboardnumberfont":return e.fretboardNumberFont=pe.fromJson(s),!0;case"numberednotationfont":return e.numberedNotationFont=pe.fromJson(s),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=pe.fromJson(s),!0;case"tablaturefont":return e.tablatureFont=pe.fromJson(s),!0;case"gracefont":return e.graceFont=pe.fromJson(s),!0;case"stafflinecolor":return e.staffLineColor=Ce.fromJson(s),!0;case"barseparatorcolor":return e.barSeparatorColor=Ce.fromJson(s),!0;case"barnumberfont":return e.barNumberFont=pe.fromJson(s),!0;case"barnumbercolor":return e.barNumberColor=Ce.fromJson(s),!0;case"fingeringfont":return e.fingeringFont=pe.fromJson(s),!0;case"inlinefingeringfont":return e.inlineFingeringFont=pe.fromJson(s),!0;case"markerfont":return e.markerFont=pe.fromJson(s),!0;case"mainglyphcolor":return e.mainGlyphColor=Ce.fromJson(s),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=Ce.fromJson(s),!0;case"scoreinfocolor":return e.scoreInfoColor=Ce.fromJson(s),!0}return["engravingsettings"].indexOf(t)>=0?(na.fromJson(e.engravingSettings,s),!0):!1}}class Br{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Br.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",wr.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("firststaffpaddingleft",e.firstStaffPaddingLeft),t.set("staffpaddingleft",e.staffPaddingLeft),t.set("effectbandpaddingbottom",e.effectBandPaddingBottom),t.set("systemslayoutmode",e.systemsLayoutMode),t}static setProperty(e,t,s){switch(t){case"scale":return e.scale=s,!0;case"stretchforce":return e.stretchForce=s,!0;case"layoutmode":return e.layoutMode=N.parseEnum(s,$s),!0;case"staveprofile":return e.staveProfile=N.parseEnum(s,ii),!0;case"barsperrow":return e.barsPerRow=s,!0;case"startbar":return e.startBar=s,!0;case"barcount":return e.barCount=s,!0;case"barcountperpartial":return e.barCountPerPartial=s,!0;case"justifylastsystem":return e.justifyLastSystem=s,!0;case"padding":return e.padding=s,!0;case"firstsystempaddingtop":return e.firstSystemPaddingTop=s,!0;case"systempaddingtop":return e.systemPaddingTop=s,!0;case"systempaddingbottom":return e.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return e.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return e.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return e.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return e.accoladeBarPaddingRight=s,!0;case"notationstaffpaddingtop":return e.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return e.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return e.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return e.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return e.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return e.staffPaddingLeft=s,!0;case"effectbandpaddingbottom":return e.effectBandPaddingBottom=s,!0;case"systemslayoutmode":return e.systemsLayoutMode=N.parseEnum(s,yi),!0}if(["resources"].indexOf(t)>=0)return wr.fromJson(e.resources,s),!0;for(const i of["resources"])if(t.indexOf(i)===0&&wr.setProperty(e.resources,t.substring(i.length),s))return!0;return!1}}class Tr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Tr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;t.set("notationmode",e.notationMode),t.set("fingeringmode",e.fingeringMode);{const s=new Map;t.set("elements",s);for(const[i,r]of e.elements)s.set(i.toString(),r)}return t.set("rhythmmode",e.rhythmMode),t.set("rhythmheight",e.rhythmHeight),t.set("transpositionpitches",e.transpositionPitches),t.set("displaytranspositionpitches",e.displayTranspositionPitches),t.set("smallgracetabnotes",e.smallGraceTabNotes),t.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),t.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),t.set("slurheight",e.slurHeight),t}static setProperty(e,t,s){switch(t){case"notationmode":return e.notationMode=N.parseEnum(s,Et),!0;case"fingeringmode":return e.fingeringMode=N.parseEnum(s,Cs),!0;case"elements":return e.elements=new Map,N.forEach(s,(i,r)=>{e.elements.set(N.parseEnum(r,fe),i)}),!0;case"rhythmmode":return e.rhythmMode=N.parseEnum(s,ks),!0;case"rhythmheight":return e.rhythmHeight=s,!0;case"transpositionpitches":return e.transpositionPitches=s,!0;case"displaytranspositionpitches":return e.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return e.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return e.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return e.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return e.slurHeight=s,!0}return!1}}class xr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>xr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t}static setProperty(e,t,s){switch(t){case"encoding":return e.encoding=s,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return e.beatTextAsLyrics=s,!0}return!1}}class Nr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Nr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t}static setProperty(e,t,s){switch(t){case"notewidelength":return e.noteWideLength=s,!0;case"notewideamplitude":return e.noteWideAmplitude=s,!0;case"noteslightlength":return e.noteSlightLength=s,!0;case"noteslightamplitude":return e.noteSlightAmplitude=s,!0;case"beatwidelength":return e.beatWideLength=s,!0;case"beatwideamplitude":return e.beatWideAmplitude=s,!0;case"beatslightlength":return e.beatSlightLength=s,!0;case"beatslightamplitude":return e.beatSlightAmplitude=s,!0}return!1}}class Pr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Pr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t}static setProperty(e,t,s){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=s,!0}return!1}}class Cr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Cr.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("playermode",e.playerMode),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",Nr.toJson(e.vibrato)),t.set("slide",Pr.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t}static setProperty(e,t,s){switch(t){case"soundfont":return e.soundFont=s,!0;case"scrollelement":return e.scrollElement=s,!0;case"outputmode":return e.outputMode=N.parseEnum(s,Sr),!0;case"enableplayer":return e.enablePlayer=s,!0;case"playermode":return e.playerMode=N.parseEnum(s,Yt),!0;case"enablecursor":return e.enableCursor=s,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return e.enableElementHighlighting=s,!0;case"enableuserinteraction":return e.enableUserInteraction=s,!0;case"scrolloffsetx":return e.scrollOffsetX=s,!0;case"scrolloffsety":return e.scrollOffsetY=s,!0;case"scrollmode":return e.scrollMode=N.parseEnum(s,ri),!0;case"scrollspeed":return e.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return e.songBookBendDuration=s,!0;case"songbookdipduration":return e.songBookDipDuration=s,!0;case"playtripletfeel":return e.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(t)>=0)return Nr.fromJson(e.vibrato,s),!0;for(const i of["vibrato"])if(t.indexOf(i)===0&&Nr.setProperty(e.vibrato,t.substring(i.length),s))return!0;if(["slide"].indexOf(t)>=0)return Pr.fromJson(e.slide,s),!0;for(const i of["slide"])if(t.indexOf(i)===0&&Pr.setProperty(e.slide,t.substring(i.length),s))return!0;return!1}}class Er{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Er.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("indent",e.indent),t.set("comments",e.comments),t}static setProperty(e,t,s){switch(t){case"indent":return e.indent=s,!0;case"comments":return e.comments=s,!0}return!1}}class bi{static fromJson(e,t){t&&N.forEach(t,(s,i)=>bi.setProperty(e,i.toLowerCase(),s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("core",kr.toJson(e.core)),t.set("display",Br.toJson(e.display)),t.set("notation",Tr.toJson(e.notation)),t.set("importer",xr.toJson(e.importer)),t.set("player",Cr.toJson(e.player)),t.set("exporter",Er.toJson(e.exporter)),t}static setProperty(e,t,s){if(["core",""].indexOf(t)>=0)return kr.fromJson(e.core,s),!0;for(const i of["core",""])if(t.indexOf(i)===0&&kr.setProperty(e.core,t.substring(i.length),s))return!0;if(["display",""].indexOf(t)>=0)return Br.fromJson(e.display,s),!0;for(const i of["display",""])if(t.indexOf(i)===0&&Br.setProperty(e.display,t.substring(i.length),s))return!0;if(["notation"].indexOf(t)>=0)return Tr.fromJson(e.notation,s),!0;for(const i of["notation"])if(t.indexOf(i)===0&&Tr.setProperty(e.notation,t.substring(i.length),s))return!0;if(["importer"].indexOf(t)>=0)return xr.fromJson(e.importer,s),!0;for(const i of["importer"])if(t.indexOf(i)===0&&xr.setProperty(e.importer,t.substring(i.length),s))return!0;if(["player"].indexOf(t)>=0)return Cr.fromJson(e.player,s),!0;for(const i of["player"])if(t.indexOf(i)===0&&Cr.setProperty(e.player,t.substring(i.length),s))return!0;if(["exporter"].indexOf(t)>=0)return Er.fromJson(e.exporter,s),!0;for(const i of["exporter"])if(t.indexOf(i)===0&&Er.setProperty(e.exporter,t.substring(i.length),s))return!0;return!1}}class Ih{indent=2;comments=!1}class _i{core=new _l;display=new Dh;notation=new zr;importer=new Lh;player=new Ah;exporter=new Ih;setSongBookModeSettings(){this.notation.notationMode=Et.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=Cs.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(fe.ParenthesisOnTiedBends,!1),this.notation.elements.set(fe.TabNotesOnTiedBends,!1),this.notation.elements.set(fe.ZerosOnDiveWhammys,!0)}static get songBook(){const e=new _i;return e.setSongBookModeSettings(),e}fillFromJson(e){bi.fromJson(this,e)}handleBackwardsCompatibility(){this.player.playerMode===Yt.Disabled&&this.player.enablePlayer&&(this.player.playerMode=Yt.EnabledAutomatic)}}class oa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>oa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("marker",e.marker),t.set("text",e.text),t}static setProperty(e,t,s){switch(t){case"marker":return e.marker=s,!0;case"text":return e.text=s,!0}return!1}}class la{static fromJson(e,t){t&&N.forEach(t,(s,i)=>la.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("baroccurence",e.barOccurence),t.set("millisecondoffset",e.millisecondOffset),t}static setProperty(e,t,s){switch(t){case"baroccurence":return e.barOccurence=s,!0;case"millisecondoffset":return e.millisecondOffset=s,!0}return!1}}class Si{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Si.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),e.syncPointValue&&t.set("syncpointvalue",la.toJson(e.syncPointValue)),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t.set("isvisible",e.isVisible),t}static setProperty(e,t,s){switch(t){case"islinear":return e.isLinear=s,!0;case"type":return e.type=N.parseEnum(s,De),!0;case"value":return e.value=s,!0;case"syncpointvalue":return s?(e.syncPointValue=new Ur,la.fromJson(e.syncPointValue,s)):e.syncPointValue=void 0,!0;case"ratioposition":return e.ratioPosition=s,!0;case"text":return e.text=s,!0;case"isvisible":return e.isVisible=s,!0}return!1}}class ha{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ha.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("type",e.type),t.set("length",e.length),t}static setProperty(e,t,s){switch(t){case"type":return e.type=N.parseEnum(s,jt),!0;case"length":return e.length=s,!0}return!1}}class ca{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ca.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("isfreetime",e.isFreeTime),t.set("tripletfeel",e.tripletFeel),e.section&&t.set("section",oa.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(s=>Si.toJson(s))),e.syncPoints!==void 0&&t.set("syncpoints",e.syncPoints?.map(s=>Si.toJson(s))),e.fermata!==null){const s=new Map;t.set("fermata",s);for(const[i,r]of e.fermata)s.set(i.toString(),ha.toJson(r))}if(t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),e.directions!==null){const s=[];t.set("directions",s);for(const i of e.directions)s.push(i)}return t}static setProperty(e,t,s){switch(t){case"alternateendings":return e.alternateEndings=s,!0;case"isdoublebar":return e.isDoubleBar=s,!0;case"isrepeatstart":return e.isRepeatStart=s,!0;case"repeatcount":return e.repeatCount=s,!0;case"timesignaturenumerator":return e.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return e.timeSignatureDenominator=s,!0;case"timesignaturecommon":return e.timeSignatureCommon=s,!0;case"isfreetime":return e.isFreeTime=s,!0;case"tripletfeel":return e.tripletFeel=N.parseEnum(s,Be),!0;case"section":return s?(e.section=new cr,oa.fromJson(e.section,s)):e.section=null,!0;case"tempoautomations":e.tempoAutomations=[];for(const i of s){const r=new Ye;Si.fromJson(r,i),e.tempoAutomations.push(r)}return!0;case"syncpoints":if(s){e.syncPoints=[];for(const i of s){const r=new Ye;Si.fromJson(r,i),e.addSyncPoint(r)}}return!0;case"fermata":return e.fermata=new Map,N.forEach(s,(i,r)=>{const n=new hr;ha.fromJson(n,i),e.addFermata(Number.parseInt(r),n)}),!0;case"start":return e.start=s,!0;case"isanacrusis":return e.isAnacrusis=s,!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"directions":for(const i of s)e.addDirection(N.parseEnum(i,z));return!0}return!1}}class rr{static fromJson(e,t){t&&N.forEach(t,(s,i)=>rr.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("offset",e.offset),t.set("value",e.value),t}static setProperty(e,t,s){switch(t){case"offset":return e.offset=s,!0;case"value":return e.value=s,!0}return!1}}class da{static fromJson(e,t){t&&N.forEach(t,(s,i)=>da.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;t.set("notehead",e.noteHead),t.set("noteheadcenteronstem",e.noteHeadCenterOnStem);{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"notehead":return e.noteHead=N.parseEnum(s,u),!0;case"noteheadcenteronstem":return e.noteHeadCenterOnStem=s,!0;case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,Vt),Ce.fromJson(i))}),!0}return!1}}class ua{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ua.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),e.bendPoints!==null&&t.set("bendpoints",e.bendPoints?.map(s=>rr.toJson(s))),t.set("fret",e.fret),t.set("string",e.string),t.set("showstringnumber",e.showStringNumber),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),t.set("ornament",e.ornament),e.style&&t.set("style",da.toJson(e.style)),e.toJson(t),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"accentuated":return e.accentuated=N.parseEnum(s,tt),!0;case"bendtype":return e.bendType=N.parseEnum(s,q),!0;case"bendstyle":return e.bendStyle=N.parseEnum(s,ze),!0;case"iscontinuedbend":return e.isContinuedBend=s,!0;case"bendpoints":if(s){e.bendPoints=[];for(const i of s){const r=new H;rr.fromJson(r,i),e.addBendPoint(r)}}return!0;case"fret":return e.fret=s,!0;case"string":return e.string=s,!0;case"showstringnumber":return e.showStringNumber=s,!0;case"octave":return e.octave=s,!0;case"tone":return e.tone=s,!0;case"percussionarticulation":return e.percussionArticulation=s,!0;case"isvisible":return e.isVisible=s,!0;case"islefthandtapped":return e.isLeftHandTapped=s,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=s,!0;case"isslurdestination":return e.isSlurDestination=s,!0;case"harmonictype":return e.harmonicType=N.parseEnum(s,Q),!0;case"harmonicvalue":return e.harmonicValue=s,!0;case"isghost":return e.isGhost=s,!0;case"isletring":return e.isLetRing=s,!0;case"ispalmmute":return e.isPalmMute=s,!0;case"isdead":return e.isDead=s,!0;case"isstaccato":return e.isStaccato=s,!0;case"slideintype":return e.slideInType=N.parseEnum(s,dt),!0;case"slideouttype":return e.slideOutType=N.parseEnum(s,ne),!0;case"vibrato":return e.vibrato=N.parseEnum(s,be),!0;case"istiedestination":return e.isTieDestination=s,!0;case"lefthandfinger":return e.leftHandFinger=N.parseEnum(s,j),!0;case"righthandfinger":return e.rightHandFinger=N.parseEnum(s,j),!0;case"trillvalue":return e.trillValue=s,!0;case"trillspeed":return e.trillSpeed=N.parseEnum(s,y),!0;case"durationpercent":return e.durationPercent=s,!0;case"accidentalmode":return e.accidentalMode=N.parseEnum(s,re),!0;case"dynamics":return e.dynamics=N.parseEnum(s,Z),!0;case"ornament":return e.ornament=N.parseEnum(s,je),!0;case"style":return s?(e.style=new On,da.fromJson(e.style,s)):e.style=void 0,!0}return e.setProperty(t,s)}}class fa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>fa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,Je),Ce.fromJson(i))}),!0}return!1}}class pa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>pa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("notes",e.notes.map(s=>ua.toJson(s))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(s=>Si.toJson(s))),t.set("dots",e.dots),t.set("fade",e.fade),t.set("lyrics",e.lyrics),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("slashed",e.slashed),t.set("deadslapped",e.deadSlapped),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),e.whammyBarPoints!==null&&t.set("whammybarpoints",e.whammyBarPoints?.map(s=>rr.toJson(s))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("overridedisplayduration",e.overrideDisplayDuration),t.set("golpe",e.golpe),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t.set("wahpedal",e.wahPedal),t.set("barrefret",e.barreFret),t.set("barreshape",e.barreShape),t.set("rasgueado",e.rasgueado),t.set("showtimer",e.showTimer),t.set("timer",e.timer),e.style&&t.set("style",fa.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"notes":e.notes=[];for(const i of s){const r=new mt;ua.fromJson(r,i),e.addNote(r)}return!0;case"isempty":return e.isEmpty=s,!0;case"whammystyle":return e.whammyStyle=N.parseEnum(s,ze),!0;case"ottava":return e.ottava=N.parseEnum(s,ae),!0;case"islegatoorigin":return e.isLegatoOrigin=s,!0;case"duration":return e.duration=N.parseEnum(s,y),!0;case"automations":e.automations=[];for(const i of s){const r=new Ye;Si.fromJson(r,i),e.automations.push(r)}return!0;case"dots":return e.dots=s,!0;case"fade":return e.fade=N.parseEnum(s,ut),!0;case"lyrics":return e.lyrics=s,!0;case"pop":return e.pop=s,!0;case"slap":return e.slap=s,!0;case"tap":return e.tap=s,!0;case"text":return e.text=s,!0;case"slashed":return e.slashed=s,!0;case"deadslapped":return e.deadSlapped=s,!0;case"brushtype":return e.brushType=N.parseEnum(s,Y),!0;case"brushduration":return e.brushDuration=s,!0;case"tupletdenominator":return e.tupletDenominator=s,!0;case"tupletnumerator":return e.tupletNumerator=s,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=s,!0;case"whammybartype":return e.whammyBarType=N.parseEnum(s,Le),!0;case"whammybarpoints":if(s){e.whammyBarPoints=[];for(const i of s){const r=new H;rr.fromJson(r,i),e.addWhammyBarPoint(r)}}return!0;case"vibrato":return e.vibrato=N.parseEnum(s,be),!0;case"chordid":return e.chordId=s,!0;case"gracetype":return e.graceType=N.parseEnum(s,$),!0;case"pickstroke":return e.pickStroke=N.parseEnum(s,kt),!0;case"tremolospeed":return e.tremoloSpeed=N.parseEnum(s,y)??null,!0;case"crescendo":return e.crescendo=N.parseEnum(s,Lt),!0;case"displaystart":return e.displayStart=s,!0;case"playbackstart":return e.playbackStart=s,!0;case"displayduration":return e.displayDuration=s,!0;case"playbackduration":return e.playbackDuration=s,!0;case"overridedisplayduration":return e.overrideDisplayDuration=s,!0;case"golpe":return e.golpe=N.parseEnum(s,Ht),!0;case"dynamics":return e.dynamics=N.parseEnum(s,Z),!0;case"invertbeamdirection":return e.invertBeamDirection=s,!0;case"preferredbeamdirection":return e.preferredBeamDirection=N.parseEnum(s,P)??null,!0;case"beamingmode":return e.beamingMode=N.parseEnum(s,Xe),!0;case"wahpedal":return e.wahPedal=N.parseEnum(s,Jt),!0;case"barrefret":return e.barreFret=s,!0;case"barreshape":return e.barreShape=N.parseEnum(s,ps),!0;case"rasgueado":return e.rasgueado=N.parseEnum(s,ie),!0;case"showtimer":return e.showTimer=s,!0;case"timer":return e.timer=s,!0;case"style":return s?(e.style=new Dl,fa.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class ga{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ga.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,lr),Ce.fromJson(i))}),!0}return!1}}class ma{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ma.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("beats",e.beats.map(s=>pa.toJson(s))),e.style&&t.set("style",ga.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"beats":e.beats=[];for(const i of s){const r=new wt;pa.fromJson(r,i),e.addBeat(r)}return!0;case"style":return s?(e.style=new El,ga.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class ya{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ya.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("ratioposition",e.ratioPosition),t.set("pedaltype",e.pedalType),t}static setProperty(e,t,s){switch(t){case"ratioposition":return e.ratioPosition=s,!0;case"pedaltype":return e.pedalType=N.parseEnum(s,qe),!0}return!1}}class ba{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ba.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,Pe),Ce.fromJson(i))}),!0}return!1}}class _a{static fromJson(e,t){t&&N.forEach(t,(s,i)=>_a.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(s=>ma.toJson(s))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t.set("sustainpedals",e.sustainPedals.map(s=>ya.toJson(s))),t.set("barlineleft",e.barLineLeft),t.set("barlineright",e.barLineRight),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),e.style&&t.set("style",ba.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"clef":return e.clef=N.parseEnum(s,Te),!0;case"clefottava":return e.clefOttava=N.parseEnum(s,ae),!0;case"voices":e.voices=[];for(const i of s){const r=new hs;ma.fromJson(r,i),e.addVoice(r)}return!0;case"similemark":return e.simileMark=N.parseEnum(s,_t),!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"sustainpedals":e.sustainPedals=[];for(const i of s){const r=new ci;ya.fromJson(r,i),e.sustainPedals.push(r)}return!0;case"barlineleft":return e.barLineLeft=N.parseEnum(s,ce),!0;case"barlineright":return e.barLineRight=N.parseEnum(s,ce),!0;case"keysignature":return e.keySignature=N.parseEnum(s,He),!0;case"keysignaturetype":return e.keySignatureType=N.parseEnum(s,Qt),!0;case"style":return s?(e.style=new Cl,ba.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Sa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Sa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t}static setProperty(e,t,s){switch(t){case"name":return e.name=s,!0;case"firstfret":return e.firstFret=s,!0;case"strings":return e.strings=s,!0;case"barrefrets":return e.barreFrets=s,!0;case"showname":return e.showName=s,!0;case"showdiagram":return e.showDiagram=s,!0;case"showfingering":return e.showFingering=s,!0}return!1}}class ka{static fromJson(e,t){t&&N.forEach(t,(s,i)=>ka.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t}static setProperty(e,t,s){switch(t){case"isstandard":return e.isStandard=s,!0;case"name":return e.name=s,!0;case"tunings":return e.tunings=s,!0}return!1}}class wa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>wa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("bars",e.bars.map(s=>_a.toJson(s))),e.chords!==null){const s=new Map;t.set("chords",s);for(const[i,r]of e.chords)s.set(i.toString(),Sa.toJson(r))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",ka.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("shownumbered",e.showNumbered),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(e,t,s){switch(t){case"bars":e.bars=[];for(const i of s){const r=new Kt;_a.fromJson(r,i),e.addBar(r)}return!0;case"chords":return e.chords=new Map,N.forEach(s,(i,r)=>{const n=new ui;Sa.fromJson(n,i),e.addChord(r,n)}),!0;case"capo":return e.capo=s,!0;case"transpositionpitch":return e.transpositionPitch=s,!0;case"displaytranspositionpitch":return e.displayTranspositionPitch=s,!0;case"stringtuning":return ka.fromJson(e.stringTuning,s),!0;case"showslash":return e.showSlash=s,!0;case"shownumbered":return e.showNumbered=s,!0;case"showtablature":return e.showTablature=s,!0;case"showstandardnotation":return e.showStandardNotation=s,!0;case"ispercussion":return e.isPercussion=s,!0;case"standardnotationlinecount":return e.standardNotationLineCount=s,!0}return!1}}class Ba{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Ba.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("bank",e.bank),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t}static setProperty(e,t,s){switch(t){case"volume":return e.volume=s,!0;case"balance":return e.balance=s,!0;case"port":return e.port=s,!0;case"program":return e.program=s,!0;case"bank":return e.bank=s,!0;case"primarychannel":return e.primaryChannel=s,!0;case"secondarychannel":return e.secondaryChannel=s,!0;case"ismute":return e.isMute=s,!0;case"issolo":return e.isSolo=s,!0}return!1}}class Ta{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Ta.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t}static setProperty(e,t,s){switch(t){case"elementtype":return e.elementType=s,!0;case"staffline":return e.staffLine=s,!0;case"noteheaddefault":return e.noteHeadDefault=N.parseEnum(s,u),!0;case"noteheadhalf":return e.noteHeadHalf=N.parseEnum(s,u),!0;case"noteheadwhole":return e.noteHeadWhole=N.parseEnum(s,u),!0;case"techniquesymbol":return e.techniqueSymbol=N.parseEnum(s,u),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=N.parseEnum(s,Ge),!0;case"outputmidinumber":return e.outputMidiNumber=s,!0}return!1}}class xa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>xa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,Hs),Ce.fromJson(i))}),!0}return!1}}class Na{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Na.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("staves",e.staves.map(s=>wa.toJson(s))),t.set("playbackinfo",Ba.toJson(e.playbackInfo)),t.set("color",Ce.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),e.lineBreaks!==void 0){const s=[];t.set("linebreaks",s);for(const i of e.lineBreaks)s.push(i)}return t.set("percussionarticulations",e.percussionArticulations.map(s=>Ta.toJson(s))),e.style&&t.set("style",xa.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"staves":e.staves=[];for(const i of s){const r=new Li;wa.fromJson(r,i),e.addStaff(r)}return!0;case"playbackinfo":return Ba.fromJson(e.playbackInfo,s),!0;case"color":return e.color=Ce.fromJson(s),!0;case"name":return e.name=s,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=s,!0;case"shortname":return e.shortName=s,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"linebreaks":for(const i of s)e.addLineBreaks(i);return!0;case"percussionarticulations":e.percussionArticulations=[];for(const i of s){const r=new J;Ta.fromJson(r,i),e.percussionArticulations.push(r)}return!0;case"style":return s?(e.style=new Ml,xa.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Pa{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Pa.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("hidedynamics",e.hideDynamics),t.set("bracketextendmode",e.bracketExtendMode),t.set("usesystemsignseparator",e.useSystemSignSeparator),t.set("globaldisplaytuning",e.globalDisplayTuning),e.perTrackDisplayTuning!==null){const s=new Map;t.set("pertrackdisplaytuning",s);for(const[i,r]of e.perTrackDisplayTuning)s.set(i.toString(),r)}if(t.set("globaldisplaychorddiagramsontop",e.globalDisplayChordDiagramsOnTop),e.perTrackChordDiagramsOnTop!==null){const s=new Map;t.set("pertrackchorddiagramsontop",s);for(const[i,r]of e.perTrackChordDiagramsOnTop)s.set(i.toString(),r)}if(t.set("singletracktracknamepolicy",e.singleTrackTrackNamePolicy),t.set("multitracktracknamepolicy",e.multiTrackTrackNamePolicy),t.set("firstsystemtracknamemode",e.firstSystemTrackNameMode),t.set("othersystemstracknamemode",e.otherSystemsTrackNameMode),t.set("firstsystemtracknameorientation",e.firstSystemTrackNameOrientation),t.set("othersystemstracknameorientation",e.otherSystemsTrackNameOrientation),t.set("multitrackmultibarrest",e.multiTrackMultiBarRest),e.perTrackMultiBarRest!==null){const s=[];t.set("pertrackmultibarrest",s);for(const i of e.perTrackMultiBarRest)s.push(i)}return t}static setProperty(e,t,s){switch(t){case"hidedynamics":return e.hideDynamics=s,!0;case"bracketextendmode":return e.bracketExtendMode=N.parseEnum(s,vi),!0;case"usesystemsignseparator":return e.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return e.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return e.perTrackDisplayTuning=new Map,N.forEach(s,(i,r)=>{e.perTrackDisplayTuning.set(Number.parseInt(r),i)}),!0;case"globaldisplaychorddiagramsontop":return e.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return e.perTrackChordDiagramsOnTop=new Map,N.forEach(s,(i,r)=>{e.perTrackChordDiagramsOnTop.set(Number.parseInt(r),i)}),!0;case"singletracktracknamepolicy":return e.singleTrackTrackNamePolicy=N.parseEnum(s,lt),!0;case"multitracktracknamepolicy":return e.multiTrackTrackNamePolicy=N.parseEnum(s,lt),!0;case"firstsystemtracknamemode":return e.firstSystemTrackNameMode=N.parseEnum(s,Wt),!0;case"othersystemstracknamemode":return e.otherSystemsTrackNameMode=N.parseEnum(s,Wt),!0;case"firstsystemtracknameorientation":return e.firstSystemTrackNameOrientation=N.parseEnum(s,Ot),!0;case"othersystemstracknameorientation":return e.otherSystemsTrackNameOrientation=N.parseEnum(s,Ot),!0;case"multitrackmultibarrest":return e.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return e.perTrackMultiBarRest=new Set(s),!0}return!1}}class Ca{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Ca.setProperty(e,i,s))}static toJson(e){return e?new Map:null}static setProperty(e,t,s){return!1}}class Ea{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Ea.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("template",e.template),t.set("isvisible",e.isVisible),t.set("textalign",e.textAlign),t}static setProperty(e,t,s){switch(t){case"template":return e.template=s,!0;case"isvisible":return e.isVisible=s,!0;case"textalign":return e.textAlign=N.parseEnum(s,X),!0}return!1}}class va{static fromJson(e,t){t&&N.forEach(t,(s,i)=>va.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("headerandfooter",s);for(const[i,r]of e.headerAndFooter)s.set(i.toString(),Ea.toJson(r))}{const s=new Map;t.set("colors",s);for(const[i,r]of e.colors)s.set(i.toString(),Ce.toJson(r))}return t}static setProperty(e,t,s){switch(t){case"headerandfooter":return e.headerAndFooter=new Map,N.forEach(s,(i,r)=>{const n=new is;Ea.fromJson(n,i),e.headerAndFooter.set(N.parseEnum(r,O),n)}),!0;case"colors":return e.colors=new Map,N.forEach(s,(i,r)=>{e.colors.set(N.parseEnum(r,O),Ce.fromJson(i))}),!0}return!1}}class Da{static fromJson(e,t){t&&N.forEach(t,(s,i)=>Da.setProperty(e,i,s))}static toJson(e){if(!e)return null;const t=new Map;return t.set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("masterbars",e.masterBars.map(s=>ca.toJson(s))),t.set("tracks",e.tracks.map(s=>Na.toJson(s))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",Pa.toJson(e.stylesheet)),e.backingTrack&&t.set("backingtrack",Ca.toJson(e.backingTrack)),e.style&&t.set("style",va.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"album":return e.album=s,!0;case"artist":return e.artist=s,!0;case"copyright":return e.copyright=s,!0;case"instructions":return e.instructions=s,!0;case"music":return e.music=s,!0;case"notices":return e.notices=s,!0;case"subtitle":return e.subTitle=s,!0;case"title":return e.title=s,!0;case"words":return e.words=s,!0;case"tab":return e.tab=s,!0;case"masterbars":e.masterBars=[];for(const i of s){const r=new Os;ca.fromJson(r,i),e.addMasterBar(r)}return!0;case"tracks":e.tracks=[];for(const i of s){const r=new Gs;Na.fromJson(r,i),e.addTrack(r)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"stylesheet":return Pa.fromJson(e.stylesheet,s),!0;case"backingtrack":return s?(e.backingTrack=new jn,Ca.fromJson(e.backingTrack,s)):e.backingTrack=void 0,!0;case"style":return s?(e.style=new Di,va.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class yt{static _jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);const s={};for(const[i,r]of t)s[i]=r;return s}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(e){const t=yt.scoreToJsObject(e);return JSON.stringify(t,yt._jsonReplacer)}static jsonToScore(e,t){return yt.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return Da.toJson(e)}static jsObjectToScore(e,t){const s=new Ws;return Da.fromJson(s,e),s.finish(t??new _i),s}static settingsToJson(e){const t=yt.settingsToJsObject(e);return JSON.stringify(t,yt._jsonReplacer)}static jsonToSettings(e){return yt.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return bi.toJson(e)}static jsObjectToSettings(e){const t=new _i;return bi.fromJson(t,e),t}static jsObjectToMidiFile(e){const t=new Ks;return N.forEach(e,(s,i)=>{switch(i){case"division":t.division=s;break;case"tracks":for(const r of s){const n=yt._jsObjectToMidiTrack(r);t.tracks.push(n)}break}}),t}static _jsObjectToMidiTrack(e){const t=new ro;return N.forEach(e,(s,i)=>{switch(i){case"events":for(const r of s){const n=yt.jsObjectToMidiEvent(r);t.events.push(n)}break}}),t}static jsObjectToMidiEvent(e){const t=N.getValue(e,"track"),s=N.getValue(e,"tick"),i=N.getValue(e,"type");switch(i){case Fe.TimeSignature:return new ao(t,s,N.getValue(e,"numerator"),N.getValue(e,"denominatorIndex"),N.getValue(e,"midiClocksPerMetronomeClick"),N.getValue(e,"thirdySecondNodesInQuarter"));case Fe.AlphaTabRest:return new oo(t,s,N.getValue(e,"channel"));case Fe.AlphaTabMetronome:return new no(t,s,N.getValue(e,"metronomeNumerator"),N.getValue(e,"metronomeDurationInTicks"),N.getValue(e,"metronomeDurationInMilliseconds"));case Fe.NoteOn:return new ho(t,s,N.getValue(e,"channel"),N.getValue(e,"noteKey"),N.getValue(e,"noteVelocity"));case Fe.NoteOff:return new co(t,s,N.getValue(e,"channel"),N.getValue(e,"noteKey"),N.getValue(e,"noteVelocity"));case Fe.ControlChange:return new uo(t,s,N.getValue(e,"channel"),N.getValue(e,"controller"),N.getValue(e,"value"));case Fe.ProgramChange:return new fo(t,s,N.getValue(e,"channel"),N.getValue(e,"program"));case Fe.TempoChange:const r=new po(s,0);return r.beatsPerMinute=N.getValue(e,"beatsPerMinute"),r;case Fe.PitchBend:return new go(t,s,N.getValue(e,"channel"),N.getValue(e,"value"));case Fe.PerNotePitchBend:return new mo(t,s,N.getValue(e,"channel"),N.getValue(e,"noteKey"),N.getValue(e,"value"));case Fe.EndOfTrack:return new yo(t,s)}throw new Ve(Oe.Format,`Unknown Midi Event type: ${i}`)}static midiFileToJsObject(e){const t=new Map;t.set("division",e.division);const s=[];for(const i of e.tracks)s.push(yt._midiTrackToJsObject(i));return t.set("tracks",s),t}static _midiTrackToJsObject(e){const t=new Map,s=[];for(const i of e.events)s.push(yt.midiEventToJsObject(i));return t.set("events",s),t}static midiEventToJsObject(e){const t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case Fe.TimeSignature:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case Fe.AlphaTabRest:t.set("channel",e.channel);break;case Fe.AlphaTabMetronome:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case Fe.NoteOn:case Fe.NoteOff:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case Fe.ControlChange:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case Fe.ProgramChange:t.set("channel",e.channel),t.set("program",e.program);break;case Fe.TempoChange:t.set("beatsPerMinute",e.beatsPerMinute);break;case Fe.PitchBend:t.set("channel",e.channel),t.set("value",e.value);break;case Fe.PerNotePitchBend:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value);break;case Fe.EndOfTrack:break}return t}}class pn{_player;_main;_exporter=new Map;constructor(e,t){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new Ph(new Nt,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){const e=F.globalThis;e.addEventListener("message",t=>{const s=t.data;switch(s.cmd){case"alphaSynth.initialize":Nt.preferredSampleRate=s.sampleRate,E.logLevel=s.logLevel,F.globalThis.alphaSynthWebWorker=new pn(e,s.bufferTimeInMilliseconds);break}})}handleMessage(e){const t=e.data,s=t.cmd;switch(s){case"alphaSynth.setLogLevel":E.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(yt.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(yt.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(t.channel,t.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)));break}s.startsWith("alphaSynth.exporter")&&this._handleExporterMessage(e)}_handleExporterMessage(e){const t=e.data,s=t.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const i=this._player.exportAudio(t.options,yt.jsObjectToMidiFile(t.midi),t.syncPoints,t.transpositionPitches);this._exporter.set(t.exporterId,i),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:t.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(t.exporterId)){const n=this._exporter.get(t.exporterId).render(t.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:t.exporterId,chunk:n})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(t.exporterId);break}}catch(i){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:i})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this._serializeException(F.prepareForPostMessage(e))})}_serializeException(e){const t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this._serializeException(F.prepareForPostMessage(e))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(yt.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}}var Bs;(function(a){a[a.Browser=0]="Browser",a[a.NodeJs=1]="NodeJs",a[a.BrowserModule=2]="BrowserModule"})(Bs||(Bs={}));class Ro{characterWidths;characterHeights;constructor(e,t){this.characterWidths=e,this.characterHeights=t}}class ds{static fontSizeLookupTables=new Map;static ControlChars=32;static generateFontLookup(e){if(!ds.fontSizeLookupTables.has(e))if(!F.isRunningInWorker&&F.webPlatform!==Bs.NodeJs){const s=document.createElement("canvas").getContext("2d"),i=11;s.font=`${i}px ${e}`;const r=[],n=[];for(let l=ds.ControlChars;l<255;l++){const h=String.fromCharCode(l),c=s.measureText(h);r.push(c.width);const d=c.actualBoundingBoxDescent+c.actualBoundingBoxAscent;n.push(d)}const o=new Ro(new Uint8Array(r),new Uint8Array(n));ds.fontSizeLookupTables.set(e,o)}else{const t=new Ro(new Uint8Array([8]),new Uint8Array([10]));ds.fontSizeLookupTables.set(e,t)}}static measureString(e,t,s,i,r){let n,l=t[0];for(let f=0;f<t.length;f++)if(ds.fontSizeLookupTables.has(t[f])){l=t[f];break}ds.fontSizeLookupTables.has(l)||ds.generateFontLookup(l),n=ds.fontSizeLookupTables.get(l);let h=1;i===st.Italic&&(h*=1.1),r===ts.Bold&&(h*=1.1);let c=0,d=0;for(let f=0;f<e.length;f++){const p=Math.min(n.characterWidths.length-1,e.charCodeAt(f)-ds.ControlChars);p>=0&&(c+=n.characterWidths[p]*s/11,d=Math.max(d,n.characterHeights[p]*s/11))}return h*=1.07,new Yr(c*h,d)}}class gn{_renderer;_main;constructor(e){this._main=e,this._main.addEventListener("message",this._handleMessage.bind(this),!1)}static init(){F.globalThis.alphaTabWebWorker=new gn(F.globalThis)}_handleMessage(e){const t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":const i=yt.jsObjectToSettings(t.settings);E.logLevel=i.core.logLevel,this._renderer=new ur(i),this._renderer.partialRenderFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:n})}),this._renderer.partialLayoutFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:n})}),this._renderer.renderFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:n})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(n=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:n})}),this._renderer.error.on(this._error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this._updateFontSizes(t.fontSizes);const r=t.score==null?null:yt.jsObjectToScore(t.score,this._renderer.settings);this._renderMultiple(r,t.trackIndexes);break;case"alphaTab.updateSettings":this._updateSettings(t.settings);break}}_updateFontSizes(e){if(!(e instanceof Map)){const t=e;e=new Map;for(const s in t)e.set(s,t[s])}if(e)for(const[t,s]of e)ds.fontSizeLookupTables.set(t,s)}_updateSettings(e){bi.fromJson(this._renderer.settings,e)}_renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(s){this._error(s)}}_error(e){E.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}class Rh{_measureCanvas;_measureContext;_canvas=null;_context;_color=new Ce(0,0,0,255);_font=new pe("Arial",10,st.Plain);_musicFont;_lineWidth=0;settings;constructor(){this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._musicFont=new pe(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,st.Plain,ts.Regular);const s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=e*F.highDpiFactor|0,this._canvas.height=t*F.highDpiFactor|0,this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(F.highDpiFactor*s,F.highDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){const e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,s,i){s>0&&this._context.fillRect(e,t,s,i)}strokeRect(e,t,s,i){const r=this.lineWidth%2===0?0:.5;this._context.strokeRect(e+r,t+r,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,s,i){this._context.quadraticCurveTo(e,t,s,i)}bezierCurveTo(e,t,s,i,r,n){this._context.bezierCurveTo(e,t,s,i,r,n)}fillCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,Math.PI*2,!0),this.fill()}strokeCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,Math.PI*2,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(1)),this._measureContext.font=e.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":return X.Left;case"center":return X.Center;case"right":return X.Right;default:return X.Left}}set textAlign(e){switch(e){case X.Left:this._context.textAlign="left";break;case X.Center:this._context.textAlign="center";break;case X.Right:this._context.textAlign="right";break}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return Re.Top;case"middle":return Re.Middle;case"bottom":return Re.Bottom;case"alphabetic":return Re.Alphabetic;default:return Re.Top}}set textBaseline(e){switch(e){case Re.Top:this._context.textBaseline="hanging";break;case Re.Middle:this._context.textBaseline="middle";break;case Re.Bottom:this._context.textBaseline="bottom";break;case Re.Alphabetic:this._context.textBaseline="alphabetic";break}}beginGroup(e){}endGroup(){}fillText(e,t,s){this._context.fillText(e,t,s)}measureText(e){const t=this._measureContext.measureText(e);return new Yr(t.width,t.actualBoundingBoxDescent+t.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,s,i,r=!1){i!==u.None&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),r)}fillMusicFontSymbols(e,t,s,i,r=!1){let n="";for(const o of i)o!==u.None&&(n+=String.fromCharCode(o));this._fillMusicFontSymbolText(e,t,s,n,r)}_fillMusicFontSymbolText(e,t,s,i,r){const n=this._context.textAlign,o=this._context.textBaseline,l=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="alphabetic",r?this._context.textAlign="center":this._context.textAlign="left",this._context.fillText(i,e,t),this._context.textBaseline=o,this._context.font=l,this._context.textAlign=n}beginRotate(e,t,s){this._context.save(),this._context.translate(e,t),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}}class Fs{_midiFile;_smf1Mode;constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,s){let i=0,r=s;for(;r=r>>1,r>0;)i++;this._midiFile.addEvent(new ao(0,e,t,i,48,8))}addRest(e,t,s){this._smf1Mode||this._midiFile.addEvent(new oo(e,t,s))}addNote(e,t,s,i,r,n){this._midiFile.addEvent(new ho(e,t,n,Fs._fixValue(i),Fs._fixValue(r))),this._midiFile.addEvent(new co(e,t+s,n,Fs._fixValue(i),Fs._fixValue(r)))}static _fixValue(e){return e>127?127:e<0?0:e}addControlChange(e,t,s,i,r){this._midiFile.addEvent(new uo(e,t,s,i,Fs._fixValue(r)))}addProgramChange(e,t,s,i){this._midiFile.addEvent(new fo(e,t,s,i))}addTempo(e,t){const s=new po(e,0);s.beatsPerMinute=t,this._midiFile.addEvent(s)}addBend(e,t,s,i){i>=oe.MaxPitchWheel?i=oe.MaxPitchWheel:i=Math.floor(i),this._midiFile.addEvent(new go(e,t,s,i))}addNoteBend(e,t,s,i,r){this._smf1Mode?this.addBend(e,t,s,r):(r=r*oe.MaxPitchWheel20/oe.MaxPitchWheel,this._midiFile.addEvent(new mo(e,t,s,i,r)))}finishTrack(e,t){(this._midiFile.format===Zi.MultiTrack||e===0)&&this._midiFile.addEvent(new yo(e,t))}}class Wh{group;opening;iterations;closingIndex=0;constructor(e,t){this.group=e,this.opening=t,e.closings=e.closings.sort((s,i)=>s.index-i.index),this.iterations=e.closings.map(s=>0)}}var Ct;(function(a){a[a.PlayingNormally=0]="PlayingNormally",a[a.DirectionJumped=1]="DirectionJumped",a[a.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",a[a.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",a[a.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"})(Ct||(Ct={}));class Oh{_score;_repeatStack=[];_groupsOnStack=new Set;_previousAlternateEndings=0;_state=Ct.PlayingNormally;shouldPlay=!0;index=0;currentTick=0;get finished(){return this.index>=this._score.masterBars.length}constructor(e){this._score=e}processCurrent(){const e=this._score.masterBars[this.index];if(this._state===Ct.PlayingNormally){let t=e.alternateEndings;if(t===0&&(t=this._previousAlternateEndings),e===e.repeatGroup.opening&&e.repeatGroup.isClosed&&!this._groupsOnStack.has(e.repeatGroup)){const s=new Wh(e.repeatGroup,e);this._repeatStack.push(s),this._groupsOnStack.add(e.repeatGroup),this._previousAlternateEndings=0,t=e.alternateEndings}if(this._repeatStack.length===0||t===0)this.shouldPlay=!0;else{const s=this._repeatStack[this._repeatStack.length-1],i=s.iterations[s.closingIndex];this._previousAlternateEndings=t,(t&1<<i)===0?this.shouldPlay=!1:this.shouldPlay=!0}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){this._moveNextWithDirections()||this._moveNextWithNormalRepeats()}_resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}_handleDaCapo(e,t,s){return e.has(t)?(this.index=0,this._state=s,this._resetRepeats(),!0):!1}_handleDalSegno(e,t,s,i){if(e.has(t)){const r=this._findJumpTarget(i,this.index,!0);return r===-1?!1:(this.index=r,this._state=s,this._resetRepeats(),!0)}return!1}_handleDaCoda(e,t,s){if(e.has(t)){const i=this._findJumpTarget(s,this.index,!1);return i===-1?(this.index++,!0):(this.index=i,this._state=Ct.PlayingNormally,!0)}return!1}_moveNextWithDirections(){const e=this._score.masterBars[this.index],t=e.directions!==null&&e.directions.size>0;if(this._state===Ct.PlayingNormally&&!t)return!1;if(!t)return this.index++,!0;switch(this._state){case Ct.PlayingNormally:return!!(this._handleDaCapo(e.directions,z.JumpDaCapo,Ct.DirectionJumped)||this._handleDaCapo(e.directions,z.JumpDaCapoAlCoda,Ct.DirectionJumpedAlCoda)||this._handleDaCapo(e.directions,z.JumpDaCapoAlDoubleCoda,Ct.DirectionJumpedAlDoubleCoda)||this._handleDaCapo(e.directions,z.JumpDaCapoAlFine,Ct.DirectionJumpedAlFine)||this._handleDalSegno(e.directions,z.JumpDalSegno,Ct.DirectionJumped,z.TargetSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoAlCoda,Ct.DirectionJumpedAlCoda,z.TargetSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoAlDoubleCoda,Ct.DirectionJumpedAlDoubleCoda,z.TargetSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoAlFine,Ct.DirectionJumpedAlFine,z.TargetSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoSegno,Ct.DirectionJumped,z.TargetSegnoSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoSegnoAlCoda,Ct.DirectionJumpedAlCoda,z.TargetSegnoSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoSegnoAlDoubleCoda,Ct.DirectionJumpedAlDoubleCoda,z.TargetSegnoSegno)||this._handleDalSegno(e.directions,z.JumpDalSegnoSegnoAlFine,Ct.DirectionJumpedAlFine,z.TargetSegnoSegno));case Ct.DirectionJumped:return this.index++,!0;case Ct.DirectionJumpedAlCoda:return this._handleDaCoda(e.directions,z.JumpDaCoda,z.TargetCoda)||this.index++,!0;case Ct.DirectionJumpedAlDoubleCoda:return this._handleDaCoda(e.directions,z.JumpDaDoubleCoda,z.TargetDoubleCoda)||this.index++,!0;case Ct.DirectionJumpedAlFine:return e.directions.has(z.TargetFine)?(this.index=this._score.masterBars.length,!0):(this.index++,!0)}return!0}_findJumpTarget(e,t,s){let i;return s?(i=this._findJumpTargetBackwards(e,t),i===-1&&(i=this._findJumpTargetForwards(e,t)),i):(i=this._findJumpTargetForwards(e,t),i===-1&&(i=this._findJumpTargetBackwards(e,t)),i)}_findJumpTargetForwards(e,t){let s=t;for(;s<this._score.masterBars.length;){const i=this._score.masterBars[s].directions;if(i&&i.has(e))return s;s++}return-1}_findJumpTargetBackwards(e,t){let s=t;for(;s>=0;){const i=this._score.masterBars[s].directions;if(i&&i.has(e))return s;s--}return-1}_moveNextWithNormalRepeats(){const t=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&t>0){const s=this._repeatStack[this._repeatStack.length-1];if(s.iterations[s.closingIndex]<t){this.index=s.opening.index,s.iterations[s.closingIndex]++;for(let r=0;r<s.closingIndex;r++)s.iterations[r]=0;s.closingIndex=0,this._previousAlternateEndings=0}else s.closingIndex<s.group.closings.length-1?(s.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(s.group),this.index++)}else this.index++}}class Vh{beat;playbackStart;constructor(e,t){this.beat=e,this.playbackStart=t}}class Ts{_highlightedBeats=new Map;start;end;highlightedBeats=[];nextBeat=null;previousBeat=null;get duration(){return this.end-this.start}constructor(e,t){this.start=e,this.end=t}highlightBeat(e,t){e.isEmpty&&!e.voice.isEmpty||this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new Vh(e,t)))}getVisibleBeatAtStart(e){for(const t of this.highlightedBeats)if(t.playbackStart===this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}}class La{tick;tempo;constructor(e,t){this.tick=e,this.tempo=t}}class Wo{start=0;end=0;get tempo(){return this.tempoChanges[0].tempo}tempoChanges=[];masterBar;firstBeat=null;lastBeat=null;_insertAfter(e,t){this.firstBeat==null||e==null||this.lastBeat==null?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,t.previousBeat=e,e.nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e===this.lastBeat&&(this.lastBeat=t))}_insertBefore(e,t){this.firstBeat==null||e==null||this.lastBeat==null?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,t.nextBeat=e,e.previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e===this.firstBeat&&(this.firstBeat=t))}nextMasterBar=null;previousMasterBar=null;addBeat(e,t,s,i){const r=s+i;if(this.firstBeat==null){const n=new Ts(s,r);n.highlightBeat(e,t),this._insertAfter(this.firstBeat,n)}else if(s>=this.lastBeat.end){const n=new Ts(this.lastBeat.end,r);n.highlightBeat(e,t),this._insertAfter(this.lastBeat,n)}else{let n=null;if(s<this.firstBeat.start)n=this.firstBeat;else{let o=this.firstBeat;for(;o!=null;){if(s>=o.start&&s<o.end){n=o;break}o=o.nextBeat}if(n===null)throw new Ve(Oe.General,"Error on building lookup, unknown variant")}if(s<n.start)if(r===n.start){const o=new Ts(s,n.start);o.highlightBeat(e,t),this._insertBefore(this.firstBeat,o)}else if(r<n.end){const o=new Ts(s,n.start);o.highlightBeat(e,t),this._insertBefore(n,o);const l=new Ts(n.start,r);for(const h of n.highlightedBeats)l.highlightBeat(h.beat,h.playbackStart);l.highlightBeat(e,t),this._insertBefore(n,l),n.start=r}else if(r===n.end){const o=new Ts(s,n.start);o.highlightBeat(e,t),n.highlightBeat(e,t),this._insertBefore(n,o)}else{const o=new Ts(s,n.start);o.highlightBeat(e,t),n.highlightBeat(e,t),this._insertBefore(n,o),this.addBeat(e,t,n.end,r-n.end)}else if(s>n.start)if(r===n.end){const o=new Ts(n.start,s);for(const l of n.highlightedBeats)o.highlightBeat(l.beat,l.playbackStart);n.start=s,n.highlightBeat(e,t),this._insertBefore(n,o)}else if(r<n.end){const o=new Ts(n.start,s);this._insertBefore(n,o);const l=new Ts(s,r);this._insertBefore(n,l);for(const h of n.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart),l.highlightBeat(h.beat,h.playbackStart);l.highlightBeat(e,t),n.start=r}else{const o=new Ts(n.start,s);for(const l of n.highlightedBeats)o.highlightBeat(l.beat,l.playbackStart);n.start=s,n.highlightBeat(e,t),this._insertBefore(n,o),this.addBeat(e,t,n.end,r-n.end)}else if(r===n.end)n.highlightBeat(e,t);else if(r<n.end){const o=new Ts(n.start,r);for(const l of n.highlightedBeats)o.highlightBeat(l.beat,l.playbackStart);o.highlightBeat(e,t),n.start=r,this._insertBefore(n,o)}else n.highlightBeat(e,t),this.addBeat(e,t,n.end,r-n.end)}}}var ys;(function(a){a[a.Unknown=0]="Unknown",a[a.ToNextBext=1]="ToNextBext",a[a.ToEndOfBar=2]="ToEndOfBar"})(ys||(ys={}));class Hh{beat;masterBar;beatLookup;nextBeat=null;tickDuration=0;duration=0;cursorMode=ys.Unknown;get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(e){this.masterBar=e}calculateDuration(){if(this.masterBar.tempoChanges.length===1)this.duration=x.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const r of this.masterBar.tempoChanges)if(r.tick<t)s=r.tempo;else{if(r.tick>i)break;e+=x.ticksToMillis(r.tick-t,s),s=r.tempo,t=r.tick}i>t&&(e+=x.ticksToMillis(i-t,s)),this.duration=e}}}class Gh{_currentMasterBar=null;masterBarLookup=new Map;masterBars=[];multiBarRestInfo=null;findBeat(e,t,s=null){let i=null;return s&&(i=this._findBeatFast(e,s,t)),i||(i=this._findBeatSlow(e,s,t,!1)),i}_findBeatFast(e,t,s){if(s>=t.start&&s<t.end)return t;if(t.nextBeat&&s>=t.nextBeat.start&&s<t.nextBeat.end){const i=t.nextBeat;return this._fillNextBeat(i,e),i}return null}_fillNextBeatMultiBarRest(e,t){const s=this.multiBarRestInfo.get(e.masterBar.masterBar.index);let i=e.masterBar;for(let r=0;r<s.length&&i;r++)i=i.nextMasterBar;i?i.nextMasterBar?(e.nextBeat=this._firstBeatInMasterBar(t,i.nextMasterBar,i.nextMasterBar.start,!0),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=ys.ToNextBext,e.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==i.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=ys.ToEndOfBar)):(e.tickDuration=i.nextMasterBar.end-e.start,e.cursorMode=ys.ToEndOfBar)):(e.tickDuration=i.end-e.start,e.cursorMode=ys.ToEndOfBar):(E.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),e.tickDuration=(e.masterBar.end-e.masterBar.start)*(s.length+1),e.cursorMode=ys.ToEndOfBar),e.calculateDuration()}_fillNextBeat(e,t){this._isMultiBarRestResult(e)?this._fillNextBeatMultiBarRest(e,t):this._fillNextBeatDefault(e,t)}_fillNextBeatDefault(e,t){e.nextBeat=this._findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!0),e.nextBeat==null&&(e.nextBeat=this._findBeatSlow(t,e,e.end,!0)),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=ys.ToNextBext,e.calculateDuration()):(e.tickDuration=e.masterBar.end-e.start,e.cursorMode=ys.ToEndOfBar,e.calculateDuration()),e.nextBeat&&e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=ys.ToEndOfBar)}_isMultiBarRestResult(e){return this._internalIsMultiBarRestResult(e.masterBar.masterBar.index,e.beat)}_internalIsMultiBarRestResult(e,t){return this.multiBarRestInfo&&this.multiBarRestInfo.has(e)&&t.isRest&&t.voice.bar.isRestOnly}_findBeatSlow(e,t,s,i){let r=null;return t!=null&&(t.masterBar.start<=s&&t.masterBar.end>s?r=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=s&&t.masterBar.nextMasterBar.end>s&&(r=t.masterBar.nextMasterBar)),r||(r=this._findMasterBar(s)),r?this._firstBeatInMasterBar(e,r,s,i):null}_firstBeatInMasterBar(e,t,s,i){let r=t;for(;r;){if(r.firstBeat){const n=this._findBeatInMasterBar(r,r.firstBeat,s,e,i);if(n)return n}r=r.nextMasterBar}return null}_findBeatInMasterBar(e,t,s,i,r){if(!t)return null;let n=null,o=null;const l=s-e.start;for(;t!=null&&o==null;){if((t.start<=l||r&&l<0)&&l<t.end){if(n=t,o=t.getVisibleBeatAtStart(i),!o)if(r){let c=e;for(;c!=null&&o==null;){for(;t!=null;){if(o=t.getVisibleBeatAtStart(i),o){n=t,e=c;break}t=t.nextBeat}(!o||!n)&&(c=c.nextMasterBar,t=c?.firstBeat??null)}}else{let c=e;for(;c!=null&&o==null;){for(;t!=null;){if(o=t.getVisibleBeatAtStart(i),o){n=t,e=c;break}t=t.previousBeat}(!o||!n)&&(c=c.previousMasterBar,t=c?.firstBeat??null)}}}else if(t.end>l)break;t=t?.nextBeat??null}return o==null?null:this._createResult(e,n,o,r,i)}_createResult(e,t,s,i,r){const n=new Hh(e);if(n.beat=s,n.beatLookup=t,n.tickDuration=t.end-t.start,!i)this._fillNextBeat(n,r);else if(this._isMultiBarRestResult(n)){const o=this.multiBarRestInfo.get(e.masterBar.index);let l=e;for(let h=0;h<o.length&&l;h++)l=l.nextMasterBar;l?l.nextMasterBar?n.tickDuration=l.nextMasterBar.start-t.start:n.tickDuration=l.end-t.start:E.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}return n.calculateDuration(),n}_findMasterBar(e){const t=this.masterBars;let s=0,i=t.length-1;for(;s<=i;){const r=(i+s)/2|0,n=t[r];if(e>=n.start&&e<n.end)return n;e<n.start?i=r-1:s=r+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){const t=new Wo;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,s){const i=this._currentMasterBar;if(i)if(t<0&&i.previousMasterBar){const r=i.previousMasterBar.end-i.previousMasterBar.start,n=r+t,o=n+s;if(i.previousMasterBar.addBeat(e,n,n,s),o>r){const l=s+t;i.addBeat(e,t,0,l)}}else i.addBeat(e,t,t,s)}}class Uh{noteOnly=0;untilTieOrSlideEnd=0;letRingEnd=0}class zh{firstBeatDuration=0;secondBeatStartOffset=0;secondBeatDuration=0}class Yh{durations=[];brushInfos=[]}class Xh{synthTick=0;synthTime=0;currentTempo=0;automationToSyncPoint=new Map;syncPoints;createNewSyncPoints=!1}class we{static _defaultDurationDead=30;static _defaultDurationPalmMute=80;_score;_settings;_handler;_programsPerChannel=new Map;_currentTime=0;_calculatedBeatTimers=new Set;tickLookup=new Gh;applyTranspositionPitches=!0;syncPoints=[];transpositionPitches=new Map;constructor(e,t,s){this._score=e,this._settings=t||new _i,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(const e of this._score.tracks)this._generateTrack(e);E.debug("Midi","Begin midi generation"),this.syncPoints=[],we._playThroughSong(this._score,this.syncPoints,!1,(e,t,s,i,r)=>{this._generateMasterBar(e,t,s,i,r)},(e,t,s)=>{for(const i of this._score.tracks)for(const r of i.staves)e<r.bars.length&&this._generateBar(r.bars[e],t,s)},e=>{for(const t of this._score.tracks)this._handler.finishTrack(t.index,e)}),E.debug("Midi","Midi generation done")}_generateTrack(e){this._generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this._generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}_addProgramChange(e,t,s,i){(!this._programsPerChannel.has(s)||this._programsPerChannel.get(s)!==i)&&(this._handler.addProgramChange(e.index,t,s,i),this._programsPerChannel.set(s,i))}_addBankChange(e,t,s,i){const r=Zt.bankToLsbMsb(i);this._handler.addControlChange(e.index,t,s,$e.BankSelectCoarse,r[1]),this._handler.addControlChange(e.index,t,s,$e.BankSelectFine,r[0])}static buildTranspositionPitches(e,t){const s=new Map;for(const i of e.tracks){const r=i.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,r),s.set(i.playbackInfo.secondaryChannel,r)}return s}_generateChannel(e,t,s){const i=e.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[e.index]:-e.staves[0].transpositionPitch;this.transpositionPitches.set(t,i);const r=we._toChannelShort(s.volume),n=we._toChannelShort(s.balance);this._handler.addControlChange(e.index,0,t,$e.VolumeCoarse,r),this._handler.addControlChange(e.index,0,t,$e.PanCoarse,n),this._handler.addControlChange(e.index,0,t,$e.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,$e.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,$e.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,$e.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,$e.DataEntryCoarse,we._pitchBendRangeInSemitones),this._addBankChange(e,0,t,s.bank),this._addProgramChange(e,0,t,s.program)}static generateSyncPoints(e,t=!1){const s=[];return we._playThroughSong(e,s,t,(i,r,n,o,l)=>{},(i,r,n)=>{},i=>{}),s}static buildModifiedTempoLookup(e){const t=[];return we._playThroughSong(e,t,!1,(i,r,n,o,l)=>{},(i,r,n)=>{},i=>{}).automationToSyncPoint}static _playThroughSong(e,t,s,i,r,n){const o=new Oh(e),l=new Xh;l.currentTempo=e.tempo,l.syncPoints=t,l.createNewSyncPoints=s;let h=null;const c=new Map;for(;!o.finished;){const d=o.index,f=e.masterBars[d],p=o.currentTick;if(o.processCurrent(),o.shouldPlay){let g=c.has(d)?c.get(d):-1;g++,c.set(d,g),i(f,h,p,l.currentTempo,g);const m=f.tempoAutomations.length>0?f.tempoAutomations[0].value:l.currentTempo;r(d,p,m),l.synthTick=p,we._processBarTime(f,g,l)}o.moveNext(),h=f}if(t.length>0){const d=t[t.length-1],f=o.currentTick-d.synthTick;if(f>0){const p=new gr;p.masterBarIndex=h.index,p.masterBarOccurence=c.get(h.index)-1,p.synthTick=o.currentTick,p.synthBpm=l.currentTempo,l.createNewSyncPoints?(p.syncBpm=d.synthBpm,p.synthBpm=d.synthBpm):t.length===1?p.syncBpm=d.synthBpm:p.syncBpm=t[t.length-2].syncBpm,p.synthTime=d.synthTime+x.ticksToMillis(f,d.synthBpm),p.syncTime=d.syncTime+x.ticksToMillis(f,p.syncBpm),l.createNewSyncPoints||d.updateSyncBpm(p.synthTime,p.syncTime),t.push(p)}}return n(o.currentTick),l}static _processBarTime(e,t,s){const i=e.calculateDuration(),r=e.syncPoints,n=s.synthTick;s.createNewSyncPoints?we._processBarTimeWithNewSyncPoints(e,t,s):r?we._processBarTimeWithSyncPoints(e,t,s):we._processBarTimeNoSyncPoints(e,s);const o=n+i,l=o-s.synthTick;l>0&&(s.synthTime+=x.ticksToMillis(l,s.currentTempo),s.synthTick=o)}static _processBarTimeWithNewSyncPoints(e,t,s){const i=s.synthTick;if(e.index===0&&t===0){s.currentTempo=e.score.tempo;const n=new gr;n.masterBarIndex=e.index,n.masterBarOccurence=t,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const r=e.calculateDuration();for(const n of e.tempoAutomations){const o=i+n.ratioPosition*r,l=o-s.synthTick;if(l>0&&(s.synthTick=o,s.synthTime+=x.ticksToMillis(l,s.currentTempo)),n.value!==s.currentTempo){s.currentTempo=n.value;const h=new gr;h.masterBarIndex=e.index,h.masterBarOccurence=t,h.synthTick=o,h.synthBpm=s.currentTempo,h.synthTime=s.synthTime,h.syncBpm=s.currentTempo,h.syncTime=s.synthTime,s.syncPoints.push(h)}}}static _processBarTimeWithSyncPoints(e,t,s){const i=s.synthTick,r=e.calculateDuration();let n=0,o;for(const l of e.syncPoints){if(l.syncPointValue.barOccurence!==t)continue;const h=i+l.ratioPosition*r;for(;n<e.tempoAutomations.length&&e.tempoAutomations[n].ratioPosition<=l.ratioPosition;){const d=e.tempoAutomations[n],f=i+d.ratioPosition*r;o=f-s.synthTick,o>0&&(s.synthTick=f,s.synthTime+=x.ticksToMillis(o,s.currentTempo)),s.currentTempo=d.value,n++}o=h-s.synthTick,o>0&&(s.synthTick=h,s.synthTime+=x.ticksToMillis(o,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,l.syncPointValue.millisecondOffset);const c=new gr;c.masterBarIndex=e.index,c.masterBarOccurence=t,c.synthTick=h,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncTime=l.syncPointValue.millisecondOffset,c.syncBpm=0,s.syncPoints.push(c),s.automationToSyncPoint.set(l,c)}for(;n<e.tempoAutomations.length;){const l=e.tempoAutomations[n],h=i+l.ratioPosition*r;o=h-s.synthTick,o>0&&(s.synthTick=h,s.synthTime+=x.ticksToMillis(o,s.currentTempo)),s.currentTempo=l.value,n++}}static _processBarTimeNoSyncPoints(e,t){const s=t.synthTick,i=e.calculateDuration();for(const r of e.tempoAutomations){const n=s+r.ratioPosition*i,o=n-t.synthTick;o>0&&(t.synthTick=n,t.synthTime+=x.ticksToMillis(o,t.currentTempo)),t.currentTempo=r.value}}static _toChannelShort(e){const t=Math.max(-32768,Math.min(32767,e*8-1));return Math.max(t,-1)+1}_generateMasterBar(e,t,s,i,r){(!t||t.timeSignatureDenominator!==e.timeSignatureDenominator||t.timeSignatureNumerator!==e.timeSignatureNumerator)&&this._handler.addTimeSignature(s,e.timeSignatureNumerator,e.timeSignatureDenominator);const n=e.calculateDuration(),o=new Wo;if(e.tempoAutomations.length>0){e.tempoAutomations[0].ratioPosition>0&&o.tempoChanges.push(new La(s,i));for(const l of e.tempoAutomations){const h=s+n*l.ratioPosition;this._handler.addTempo(h,l.value),o.tempoChanges.push(new La(h,l.value))}}else t?o.tempoChanges.push(new La(s,i)):(this._handler.addTempo(s,e.score.tempo),o.tempoChanges.push(new La(s,e.score.tempo)));o.masterBar=e,o.start=s,o.end=o.start+n,this.tickLookup.addMasterBar(o)}_generateBar(e,t,s){const i=this._getPlaybackBar(e),r=this._currentTime;for(const h of i.voices)this._currentTime=r,this._generateVoice(h,t,e,s);const n=i.masterBar,o=n.calculateDuration(),l=n.tempoAutomations.slice();if(l.length===0)this._currentTime=r+x.ticksToMillis(o,s);else{this._currentTime=r;let h=t,c=s;const d=t+o;for(const p of l){const m=o*p.ratioPosition-h;m>0&&(this._currentTime+=x.ticksToMillis(m,c)),c=p.value,h+=m}const f=d-h;f>0&&(this._currentTime+=x.ticksToMillis(f,c))}i.id!==e.id&&this.tickLookup.addBeat(e.voices[0].beats[0],0,o)}_getPlaybackBar(e){switch(e.simileMark){case _t.Simple:e.previousBar&&(e=this._getPlaybackBar(e.previousBar));break;case _t.FirstOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this._getPlaybackBar(e.previousBar.previousBar));break;case _t.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this._getPlaybackBar(e.previousBar.previousBar));break}return e}_generateVoice(e,t,s,i){if(e.isEmpty&&(!e.bar.isEmpty||e.index!==0))return;const r=s.masterBar.tempoAutomations.slice();let n=i;const o=s.masterBar.calculateDuration();for(const l of e.beats){const h=l.playbackStart/o;for(;r.length>0&&r[0].ratioPosition<=h;)n=r.shift().value;this._generateBeat(l,t,s,n)}}_currentTripletFeel=null;_generateBeat(e,t,s,i){let r=e.playbackStart,n=e.playbackDuration;const o=e.voice.bar.masterBar.calculateDuration();e.voice.bar.isEmpty?n=o:e.voice.bar.masterBar.tripletFeel!==Be.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(r-=this._currentTripletFeel.secondBeatStartOffset,n=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=we._calculateTripletFeelInfo(r,n,e),this._currentTripletFeel&&(n=this._currentTripletFeel.firstBeatDuration))),e.showTimer&&!this._calculatedBeatTimers.has(e.id)&&(e.timer=this._currentTime,this._calculatedBeatTimers.add(e.id)),this._currentTime+=x.ticksToMillis(n,i),s===e.voice.bar&&this.tickLookup.addBeat(e,r,n);const l=e.voice.bar.staff.track;for(const h of e.automations)this._generateNonTempoAutomation(e,h,t);if(e.isRest)this._handler.addRest(l.index,t+r,l.playbackInfo.primaryChannel);else if(e.deadSlapped)this._generateDeadSlap(e,t+r);else{const h=this._getBrushInfo(e),c=this._getRasgueadoInfo(e,n);for(const d of e.notes)this._generateNote(d,t+r,n,i,h,c)}if(e.fade!==ut.None&&this._generateFade(e,t+r,n),e.vibrato!==be.None){let h=240,c=3;switch(e.vibrato){case be.Slight:h=this._settings.player.vibrato.beatSlightLength,c=this._settings.player.vibrato.beatSlightAmplitude;break;case be.Wide:h=this._settings.player.vibrato.beatWideLength,c=this._settings.player.vibrato.beatWideAmplitude;break}this._generateVibratorWithParams(t+r,e.playbackDuration,h,0,c,(d,f)=>{this._handler.addBend(e.voice.bar.staff.track.index,d,l.playbackInfo.secondaryChannel,f)})}}static _calculateTripletFeelInfo(e,t,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case Be.Triplet8th:case Be.Dotted8th:case Be.Scottish8th:i=y.Eighth;break;case Be.Triplet16th:case Be.Dotted16th:case Be.Scottish16th:i=y.Sixteenth;break;default:return null}const r=x.toTicks(i);if(t!==r||e%r!==0||!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==r)return null;const n=new zh;switch(s.voice.bar.masterBar.tripletFeel){case Be.Triplet8th:n.firstBeatDuration=x.applyTuplet(x.toTicks(y.Quarter),3,2),n.secondBeatDuration=x.applyTuplet(x.toTicks(y.Eighth),3,2);break;case Be.Dotted8th:n.firstBeatDuration=x.applyDot(x.toTicks(y.Eighth),!1),n.secondBeatDuration=x.toTicks(y.Sixteenth);break;case Be.Scottish8th:n.firstBeatDuration=x.toTicks(y.Sixteenth),n.secondBeatDuration=x.applyDot(x.toTicks(y.Eighth),!1);break;case Be.Triplet16th:n.firstBeatDuration=x.applyTuplet(x.toTicks(y.Eighth),3,2),n.secondBeatDuration=x.applyTuplet(x.toTicks(y.Sixteenth),3,2);break;case Be.Dotted16th:n.firstBeatDuration=x.applyDot(x.toTicks(y.Sixteenth),!1),n.secondBeatDuration=x.toTicks(y.ThirtySecond);break;case Be.Scottish16th:n.firstBeatDuration=x.toTicks(y.ThirtySecond),n.secondBeatDuration=x.applyDot(x.toTicks(y.Sixteenth),!1);break}return n.secondBeatStartOffset=t-n.firstBeatDuration,n}_generateDeadSlap(e,t){const s=x.toTicks(y.SixtyFourth),i=e.voice.bar.staff;if(i.tuning.length>0)for(const r of i.tuning)this._handler.addNote(i.track.index,t,s,r,x.dynamicToVelocity(Z.F),i.track.playbackInfo.primaryChannel)}_needsSecondaryChannel(e){return e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==be.None}_determineChannel(e,t){if(this._needsSecondaryChannel(t))return e.playbackInfo.secondaryChannel;let s=t;for(;s.isTieDestination;)if(s=s.tieOrigin,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;for(s=t;s.isTieOrigin;)if(s=s.tieDestination,this._needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;return e.playbackInfo.primaryChannel}_generateNote(e,t,s,i,r,n){const o=e.beat.voice.bar.staff.track,l=e.beat.voice.bar.staff;let h=e.calculateRealValue(this.applyTranspositionPitches,!0);if(e.isPercussion){const S=ht.getArticulation(e);S&&(h=S.outputMidiNumber)}const c=n==null&&e.isStringed&&e.string<=r.length?r[e.string-1]:0,d=t+c,f=this._getNoteDuration(e,s,i);f.untilTieOrSlideEnd-=c,f.noteOnly-=c,f.letRingEnd-=c;const p=we._getNoteVelocity(e),g=this._determineChannel(o,e);let m=0;const b=Math.max(f.untilTieOrSlideEnd,f.letRingEnd);if(e.hasBend?m=we.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?m=we.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===ne.Legato?m=-1:m=we.getPitchWheel(0),m>=0&&this._handler.addNoteBend(o.index,d,g,h,m),e.beat.hasRasgueado){this._generateRasgueado(o,e,d,h,p,g,n);return}if(e.ornament!==je.None){this._generateOrnament(o,e,d,b,h,p,g);return}if(e.isTrill&&!l.isPercussion){this._generateTrill(e,d,f,h,p,g);return}if(e.beat.isTremolo){this._generateTremoloPicking(e,d,f,h,p,g);return}e.hasBend?this._generateBend(e,d,f,h,g,i):e.beat.hasWhammyBar&&e.index===0?this._generateWhammy(e.beat,d,f,g,i):e.slideInType!==dt.None||e.slideOutType!==ne.None?this._generateSlide(e,d,f,h,g,i):(e.vibrato!==be.None||e.isTieDestination&&e.tieOrigin.vibrato!==be.None)&&this._generateVibrato(e,d,f,h,g),!e.isTieDestination&&(!e.slideOrigin||e.slideOrigin.slideOutType!==ne.Legato)&&this._handler.addNote(o.index,d,b,h,p,g)}static _ornamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1];static ornamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];_generateOrnament(e,t,s,i,r,n,o){let l,h;const c=r%12,d=1/3;switch(t.ornament){case je.Turn:l=[r+we._ornamentKeysUp[c],r,r+we.ornamentKeysDown[c]],h=[x.toTicks(y.Sixteenth)*d,x.toTicks(y.Sixteenth)*d,x.toTicks(y.Sixteenth)*d];break;case je.InvertedTurn:l=[r+we.ornamentKeysDown[c],r,r+we._ornamentKeysUp[c]],h=[x.toTicks(y.Sixteenth)*d,x.toTicks(y.Sixteenth)*d,x.toTicks(y.Sixteenth)*d];break;case je.UpperMordent:l=[r,r+we._ornamentKeysUp[c]],h=[x.toTicks(y.ThirtySecond),x.toTicks(y.ThirtySecond)];break;case je.LowerMordent:l=[r,r+we.ornamentKeysDown[c]],h=[x.toTicks(y.ThirtySecond),x.toTicks(y.ThirtySecond)];break;default:return}let f=1;i<x.QuarterTime&&(f=i/x.QuarterTime),n-=x.VelocityIncrement;let p=0;for(let m=0;m<l.length;m++){const b=h[m]*f;this._handler.addNote(e.index,s,b,l[m],n,o),s+=b,p+=b}const g=i-p;this._handler.addNote(e.index,s,g,r,n,o)}_getNoteDuration(e,t,s){const i=new Uh;if(i.noteOnly=t,i.untilTieOrSlideEnd=t,i.letRingEnd=t,e.isDead)return i.noteOnly=this._applyStaticDuration(we._defaultDurationDead,t,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(e.isPalmMute)return i.noteOnly=this._applyStaticDuration(we._defaultDurationPalmMute,t,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(e.isStaccato)return i.noteOnly=t/2|0,i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(e.isTieOrigin){const r=e.tieDestination;if(r)if(e.isTieDestination){const n=this._getNoteDuration(r,r.beat.playbackDuration,s);i.untilTieOrSlideEnd=t+n.untilTieOrSlideEnd}else{const n=e.beat.absolutePlaybackStart,o=this._getNoteDuration(r,r.beat.playbackDuration,s),l=r.beat.absolutePlaybackStart+o.untilTieOrSlideEnd;i.untilTieOrSlideEnd=l-n}}else if(e.slideOutType===ne.Legato){const r=e.slideTarget;if(r){const n=e.beat.absolutePlaybackStart,o=this._getNoteDuration(r,r.beat.playbackDuration,s),l=r.beat.absolutePlaybackStart+o.untilTieOrSlideEnd;i.untilTieOrSlideEnd=l-n}}if(e.isLetRing&&this._settings.notation.notationMode===Et.GuitarPro){let r=e.beat,n=0;const o=e.beat.voice.bar.masterBar.calculateDuration();for(;r.nextBeat;){const l=r.nextBeat;if(l.isRest||e.isStringed&&l.hasNoteOnString(e.string))break;if(r=r.nextBeat,n=r.absolutePlaybackStart-e.beat.absolutePlaybackStart+r.playbackDuration,n>o){n=o;break}}r===e.beat?i.letRingEnd=t:i.letRingEnd=n}else i.letRingEnd=i.untilTieOrSlideEnd;return i}_applyStaticDuration(e,t,s){const i=s*e/H.MaxPosition|0;return Math.min(i,t)}static _getNoteVelocity(e){let t=0;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case tt.Normal:t++;break;case tt.Heavy:t+=2;break}return x.dynamicToVelocity(e.dynamics,t)}_generateFade(e,t,s){const i=e.voice.bar.staff.track;switch(e.fade){case ut.FadeIn:this._generateFadeSteps(i,t,s,0,we._toChannelShort(i.playbackInfo.volume));break;case ut.FadeOut:this._generateFadeSteps(i,t,s,we._toChannelShort(i.playbackInfo.volume),0);break;case ut.VolumeSwell:const r=s/2|0;this._generateFadeSteps(i,t,r,0,we._toChannelShort(i.playbackInfo.volume)),this._generateFadeSteps(i,t+r,r,we._toChannelShort(i.playbackInfo.volume),0);break}}_generateFadeSteps(e,t,s,i,r){s=s*.8|0;const o=(r-i)/s,l=s/120+1|0,h=t+s;for(let c=0;c<l;c++){const d=c===l-1,f=d?h:t+c*120,p=d?r:Math.round(i+(f-t)*o);this._handler.addControlChange(e.index,f,e.playbackInfo.primaryChannel,$e.VolumeCoarse,p),this._handler.addControlChange(e.index,f,e.playbackInfo.secondaryChannel,$e.VolumeCoarse,p)}}_generateVibrato(e,t,s,i,r){let n=0,o=0;switch(e.vibrato!==be.None?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:be.Slight){case be.Slight:n=this._settings.player.vibrato.noteSlightLength,o=this._settings.player.vibrato.noteSlightAmplitude;break;case be.Wide:n=this._settings.player.vibrato.noteWideLength,o=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const h=e.beat.voice.bar.staff.track;let c=0;if(e.isTieDestination&&e.tieOrigin.hasBend){const d=e.tieOrigin.bendPoints;c=d[d.length-1].value}this._generateVibratorWithParams(t,s.noteOnly,n,c,o,(d,f)=>{this._handler.addNoteBend(h.index,d,r,i,f)})}vibratoResolution=16;_generateVibratorWithParams(e,t,s,i,r,n){const o=this.vibratoResolution,l=s/2|0,h=e+t;for(;e<h;){let c=0;const d=e+s<h?s:h-e;for(;c<d;){const f=i+r*Math.sin(c*Math.PI/l);n(e+c|0,we.getPitchWheel(f)),c+=o}e+=s}n(h|0,we.getPitchWheel(i))}static _pitchBendRangeInSemitones=16;static _pitchValuePerSemitone=oe.DefaultPitchWheel/we._pitchBendRangeInSemitones;static _minBreakpointsPerSemitone=6;static _millisecondsPerBreakpoint=150;static getPitchWheel(e){return oe.DefaultPitchWheel+e/2*we._pitchValuePerSemitone}_generateSlide(e,t,s,i,r,n){const o=e.slideOutType===ne.Legato?s.noteOnly:s.untilTieOrSlideEnd,l=[],h=e.beat.voice.bar.staff.track,c=this._settings.player.slide.simpleSlidePitchOffset,d=Math.floor(H.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),f=Math.floor(H.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case dt.IntoFromAbove:l.push(new H(0,c)),l.push(new H(d,0));break;case dt.IntoFromBelow:l.push(new H(0,-c)),l.push(new H(d,0));break}switch(e.slideOutType){case ne.Legato:case ne.Shift:l.push(new H(f,0));const p=(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0))*2;l.push(new H(H.MaxPosition,p));break;case ne.OutDown:l.push(new H(H.MaxPosition-d,0)),l.push(new H(H.MaxPosition,-c));break;case ne.OutUp:l.push(new H(H.MaxPosition-d,0)),l.push(new H(H.MaxPosition,c));break}this._generateWhammyOrBend(t,o,l,n,(p,g)=>{this._handler.addNoteBend(h.index,p,r,i,g)})}_generateBend(e,t,s,i,r,n){const o=e.bendPoints,l=e.beat.voice.bar.staff.track,h=(g,m)=>{this._handler.addNoteBend(l.index,g,r,i,m)};let c=null,d;if(e.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let g=e;for(;g.isTieOrigin&&!g.tieDestination.hasBend&&g.tieDestination.vibrato===be.None;)g=g.tieDestination;d=g.beat.absolutePlaybackStart-e.beat.absolutePlaybackStart+this._getNoteDuration(g,g.beat.playbackDuration,n).noteOnly}else if(e.isTieOrigin&&e.beat.graceType!==$.None){switch(e.tieDestination.bendType){case q.Bend:case q.BendRelease:case q.PrebendBend:c=e.tieDestination.bendPoints[1].value;break;case q.Prebend:case q.PrebendRelease:c=e.tieDestination.bendPoints[0].value;break}d=Math.max(s.noteOnly,x.millisToTicks(this._settings.player.songBookBendDuration,n))}else d=s.noteOnly;o[0].value>0&&!e.isContinuedBend&&t>0&&t--;const f=Math.min(d,x.millisToTicks(this._settings.player.songBookBendDuration,n));let p=[];switch(e.bendType){case q.Custom:p=o;break;case q.Bend:case q.Release:switch(e.bendStyle){case ze.Default:p=o;break;case ze.Gradual:p.push(new H(0,e.bendPoints[0].value)),(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),p.push(new H(H.MaxPosition,c));break;case ze.Fast:(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),e.beat.graceType===$.BendGrace?this._generateSongBookWhammyOrBend(t,d,!0,[e.bendPoints[0].value,c],f,n,h):this._generateSongBookWhammyOrBend(t,d,!1,[e.bendPoints[0].value,c],f,n,h);return}break;case q.BendRelease:switch(e.bendStyle){case ze.Default:p=o;break;case ze.Gradual:p.push(new H(0,e.bendPoints[0].value)),p.push(new H(H.MaxPosition/2|0,e.bendPoints[1].value)),p.push(new H(H.MaxPosition,e.bendPoints[2].value));break;case ze.Fast:this._generateSongBookWhammyOrBend(t,d,!1,[e.bendPoints[0].value,e.bendPoints[1].value,e.bendPoints[2].value],f,n,h);return}break;case q.Hold:p=o;break;case q.Prebend:p=o;break;case q.PrebendBend:switch(e.bendStyle){case ze.Default:p=o;break;case ze.Gradual:p.push(new H(0,e.bendPoints[0].value)),p.push(new H(H.MaxPosition,e.bendPoints[1].value));break;case ze.Fast:const g=we.getPitchWheel(e.bendPoints[0].value);h(t,g|0),(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),this._generateSongBookWhammyOrBend(t,d,!1,[e.bendPoints[0].value,c],f,n,h);return}break;case q.PrebendRelease:switch(e.bendStyle){case ze.Default:p=o;break;case ze.Gradual:p.push(new H(0,e.bendPoints[0].value)),p.push(new H(H.MaxPosition,e.bendPoints[1].value));break;case ze.Fast:const g=we.getPitchWheel(e.bendPoints[0].value);h(t,g|0),this._generateSongBookWhammyOrBend(t,d,!1,[e.bendPoints[0].value,e.bendPoints[1].value],f,n,h);return}break}this._generateWhammyOrBend(t,d,p,n,h)}_generateSongBookWhammyOrBend(e,t,s,i,r,n,o){const l=s?e:e+t-r,h=r/(i.length-1);for(let c=0;c<i.length-1;c++){const d=we.getPitchWheel(i[c]),f=we.getPitchWheel(i[c+1]),p=l+h*c;this._generateBendValues(p,h,d,f,n,o)}}_generateWhammy(e,t,s,i,r){const n=e.whammyBarPoints,o=e.voice.bar.staff.track,l=s.noteOnly;n[0].value>0&&!e.isContinuedWhammy&&t--;const h=(d,f)=>{this._handler.addBend(o.index,d,i,f)};let c=[];switch(e.whammyBarType){case Le.Custom:c=n;break;case Le.Dive:switch(e.whammyStyle){case ze.Default:c=n;break;case ze.Gradual:c.push(new H(0,n[0].value)),c.push(new H(H.MaxPosition,n[1].value));break;case ze.Fast:const d=Math.min(l,x.millisToTicks(this._settings.player.songBookBendDuration,r));this._generateSongBookWhammyOrBend(t,l,!1,[n[0].value,n[1].value],d,r,h);return}break;case Le.Dip:switch(e.whammyStyle){case ze.Default:c=n;break;case ze.Gradual:c.push(new H(0,n[0].value)),c.push(new H(H.MaxPosition/2|0,n[1].value)),c.push(new H(H.MaxPosition,n[2].value));break;case ze.Fast:const d=Math.min(l,x.millisToTicks(this._settings.player.songBookDipDuration,r));this._generateSongBookWhammyOrBend(t,l,!0,[n[0].value,n[1].value,n[2].value],d,r,h);return}break;case Le.Hold:c=n;break;case Le.Predive:c=n;break;case Le.PrediveDive:switch(e.whammyStyle){case ze.Default:c=n;break;case ze.Gradual:c.push(new H(0,n[0].value)),c.push(new H(H.MaxPosition/2|0,n[0].value)),c.push(new H(H.MaxPosition,n[1].value));break;case ze.Fast:const d=we.getPitchWheel(n[0].value);this._handler.addBend(o.index,t,i,d|0);const f=Math.min(l,x.millisToTicks(this._settings.player.songBookBendDuration,r));this._generateSongBookWhammyOrBend(t,l,!1,[n[0].value,n[1].value],f,r,h);return}break}this._generateWhammyOrBend(t,l,c,r,h)}_generateWhammyOrBend(e,t,s,i,r){const n=t/H.MaxPosition;for(let o=0;o<s.length-1;o++){const l=s[o],h=s[o+1],c=we.getPitchWheel(l.value),d=we.getPitchWheel(h.value),f=n*(h.offset-l.offset),p=e+n*l.offset;this._generateBendValues(p,f,c,d,i,r)}}_generateBendValues(e,t,s,i,r,n){const o=x.ticksToMillis(t,r),l=Math.abs(i-s)/we._pitchValuePerSemitone,h=Math.max(we._minBreakpointsPerSemitone*l,o/we._millisecondsPerBreakpoint),c=t/h,d=(i-s)/h,f=e+t;for(let p=0;p<h;p++)n(e|0,Math.round(s)),s+=d,e+=c;n(f|0,i)}_generateRasgueado(e,t,s,i,r,n,o){let l=s;for(let h=0;h<o.durations.length;h++){const c=o.brushInfos[h],d=t.isStringed&&t.string<=c.length?c[t.string-1]:0,f=o.durations[h];this._handler.addNote(e.index,l+d,f-d,i,r,n),l+=f}}_generateTrill(e,t,s,i,r,n){const o=e.beat.voice.bar.staff.track,l=e.stringTuning+e.trillFret;let h=x.toTicks(e.trillSpeed),c=!0,d=t;const f=t+s.untilTieOrSlideEnd;for(;d+10<f;)d+h>=f&&(h=f-d),this._handler.addNote(o.index,d,h,c?l:i,r,n),c=!c,d+=h}_generateTremoloPicking(e,t,s,i,r,n){const o=e.beat.voice.bar.staff.track;let l=x.toTicks(e.beat.tremoloSpeed),h=t;const c=t+s.untilTieOrSlideEnd;for(;h+10<c;)h+l>=c&&(l=c-h),this._handler.addNote(o.index,h,l,i,r,n),h+=l}static _rasgueadoDirections=new Map([[ie.Ii,[Y.BrushDown,Y.BrushUp]],[ie.Mi,[Y.BrushDown,Y.BrushDown]],[ie.MiiTriplet,[Y.BrushDown,Y.BrushDown,Y.BrushUp]],[ie.MiiAnapaest,[Y.BrushDown,Y.BrushDown,Y.BrushUp]],[ie.PmpTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.PmpAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.PeiTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.PeiAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.PaiTriplet,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.PaiAnapaest,[Y.BrushUp,Y.BrushDown,Y.BrushDown]],[ie.AmiTriplet,[Y.BrushDown,Y.BrushDown,Y.BrushDown]],[ie.AmiAnapaest,[Y.BrushDown,Y.BrushDown,Y.BrushDown]],[ie.Ppp,[Y.None,Y.BrushDown,Y.BrushUp]],[ie.Amii,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[ie.Amip,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[ie.Eami,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown]],[ie.Eamii,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]],[ie.Peami,[Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushDown,Y.BrushUp]]]);static _rasgueadoDurations=new Map([[ie.Ii,[x.toTicks(y.Eighth),x.toTicks(y.Eighth)]],[ie.Mi,[x.toTicks(y.Eighth),x.toTicks(y.Eighth)]],[ie.MiiTriplet,[x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3]],[ie.MiiAnapaest,[x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth),x.toTicks(y.Eighth)]],[ie.PmpTriplet,[x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3]],[ie.PmpAnapaest,[x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Eighth)/3]],[ie.PeiTriplet,[x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3]],[ie.PeiAnapaest,[x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth),x.toTicks(y.Eighth)]],[ie.PaiTriplet,[x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3]],[ie.PaiAnapaest,[x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth),x.toTicks(y.Eighth)]],[ie.AmiTriplet,[x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3,x.toTicks(y.Eighth)/3]],[ie.AmiAnapaest,[x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Eighth)/3]],[ie.Ppp,[x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Eighth)/3]],[ie.Amii,[x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Eighth)]],[ie.Amip,[x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Sixteenth)/3,x.toTicks(y.Eighth)]],[ie.Eami,[x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth),x.toTicks(y.Sixteenth)]],[ie.Eamii,[x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5]],[ie.Peami,[x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5,x.toTicks(y.Sixteenth)/5]]]);_getRasgueadoInfo(e,t){if(!e.hasRasgueado)return null;const s=new Yh,r=we._rasgueadoDurations.get(e.rasgueado).reduce((c,d)=>c+d,0);s.durations=we._rasgueadoDurations.get(e.rasgueado).map(c=>t*c/r),s.brushInfos=new Array(s.durations.length);const n=x.toTicks(y.Sixteenth);let o=0,l=0;for(const c of e.notes)c.isTieDestination||(o|=1<<c.string-1,l++);const h=we._rasgueadoDirections.get(e.rasgueado);for(let c=0;c<s.durations.length;c++){const d=s.durations[c]*n/x.QuarterTime,f=new Int32Array(e.voice.bar.staff.tuning.length);s.brushInfos[c]=f;const p=h[c];p!==Y.None&&this._fillBrushInfo(e,f,p===Y.ArpeggioDown||p===Y.BrushDown,o,l,d)}return s}_getBrushInfo(e){const t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType){let s=0,i=0;for(const r of e.notes)r.isTieDestination||(s|=1<<r.string-1,i++);this._fillBrushInfo(e,t,e.brushType===Y.ArpeggioDown||e.brushType===Y.BrushDown,s,i,e.brushDuration)}return t}_fillBrushInfo(e,t,s,i,r,n){if(e.notes.length>0){let o=0;const l=n/(r-1)|0;for(let h=0;h<e.voice.bar.staff.tuning.length;h++){const c=s?h:t.length-1-h;(i&1<<c)!==0&&(t[c]=o,o+=l)}}return t}_generateNonTempoAutomation(e,t,s){switch(t.type){case De.Instrument:this._addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,(t.value|0)&255),this._addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,(t.value|0)&255);break;case De.Bank:this._addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,t.value),this._addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,t.value);break;case De.Balance:const i=we._toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,$e.PanCoarse,i),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,$e.PanCoarse,i);break;case De.Volume:const r=we._toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,$e.VolumeCoarse,r),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,$e.VolumeCoarse,r);break}}prepareSingleBeat(e){let t=-1,s=-1,i=e;for(;i&&(t===-1||s===-1);){for(const c of e.automations)switch(c.type){case De.Instrument:s=c.value;break;case De.Tempo:t=c.value;break}i=i.previousBeat}const r=e.voice.bar.staff.track,n=e.voice.bar.masterBar;t===-1&&(t=n.score.tempo);const o=e.playbackStart/n.calculateDuration();for(const c of n.tempoAutomations)if(c.ratioPosition<=o)t=c.value;else break;s===-1&&(s=r.playbackInfo.program);const l=r.playbackInfo.volume;this._generateTrack(r),this._handler.addTimeSignature(0,n.timeSignatureNumerator,n.timeSignatureDenominator),this._handler.addTempo(0,t);const h=we._toChannelShort(l);return this._handler.addControlChange(0,0,r.playbackInfo.primaryChannel,$e.VolumeCoarse,h),this._handler.addControlChange(0,0,r.playbackInfo.secondaryChannel,$e.VolumeCoarse,h),t}generateSingleBeat(e){const t=this.prepareSingleBeat(e);this._generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){const t=this.prepareSingleBeat(e.beat);this._generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length),null)}}class Oo{oldWidth=0;newWidth=0;settings=null}class ot{x;y;width=0;height=0;renderer;constructor(e,t){this.x=e,this.y=t}getBoundingBoxTop(){return this.y}doLayout(){}paint(e,t,s){}}class us extends ot{beat=null;nextGlyph=null;previousGlyph=null;constructor(e=0,t=0){super(e,t)}}class gt extends us{glyphScale=0;symbol;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(e,t,s,i){super(e,t),this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const e=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-e}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(e,t,s){if(this.width===0&&this.height===0)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class Jh extends us{glyphScale=0;symbols;center=!1;colorOverride;offsetX=0;offsetY=0;constructor(e,t,s,i){super(e,t),this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let e=0;for(let t=0;t<this.symbols.length;t++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[t]);(t===0||s<e)&&(e=s)}return this.y-this.offsetY-e}doLayout(){this.width=0,this.height=0;for(let e=0;e<this.symbols.length;e++){const t=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[e])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[e])*this.glyphScale;(e===0||t>this.width)&&(this.width=t),(e===0||s>this.height)&&(this.height=s)}}paint(e,t,s){if(this.width===0&&this.height===0)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class ve extends gt{static GraceScale=.75;centerOnStem=!1;constructor(e,t,s,i){super(e,t,i?ve.GraceScale:1,ve.getSymbol(s))}paint(e,t,s){this.centerOnStem&&(this.center=!0),super.paint(e,t,s)}static getSymbol(e){switch(e){case y.QuadrupleWhole:return u.NoteheadDoubleWholeSquare;case y.DoubleWhole:return u.NoteheadDoubleWhole;case y.Whole:return u.NoteheadWhole;case y.Half:return u.NoteheadHalf;default:return u.NoteheadBlack}}}class Fa extends gt{constructor(e,t,s,i,r){super(e,t,r?ve.GraceScale:1,Fa.getSymbol(s,i,r))}static getSymbol(e,t,s){if(s&&(e=y.Eighth),t===P.Up)switch(e){case y.Eighth:return u.Flag8thUp;case y.Sixteenth:return u.Flag16thUp;case y.ThirtySecond:return u.Flag32ndUp;case y.SixtyFourth:return u.Flag64thUp;case y.OneHundredTwentyEighth:return u.Flag128thUp;case y.TwoHundredFiftySixth:return u.Flag256thUp;default:return u.Flag8thUp}switch(e){case y.Eighth:return u.Flag8thDown;case y.Sixteenth:return u.Flag16thDown;case y.ThirtySecond:return u.Flag32ndDown;case y.SixtyFourth:return u.Flag64thDown;case y.OneHundredTwentyEighth:return u.Flag128thDown;case y.TwoHundredFiftySixth:return u.Flag128thDown;default:return u.Flag8thDown}}}class xs extends ot{voiceContainer;beat;preNotes;onNotes;ties=[];minWidth=0;get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(e,t){super(0,0),this.beat=e,this.ties=[],this.voiceContainer=t}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){const t=this.preNotes.computedWidth+this.onNotes.centerX;let s=this.onNotes.computedWidth-this.onNotes.centerX;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);this.beat.graceType!==$.None?s+=this.renderer.smuflMetrics.glyphWidths.get(u.Flag8thUp)*ve.GraceScale:i&&this.drawBeamHelperAsFlags(i)&&(s+=this.renderer.smuflMetrics.glyphWidths.get(u.Flag8thUp)*ve.GraceScale);for(const r of this.ties)s+=r.width;e.addBeatSpring(this.beat,t,s)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.onNotes.updateBeamingHelper();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&this.onNotes.beamingHelper.beats.length===1&&this.beat.duration>=y.Eighth){const t=Fa.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,this.beat.graceType!==$.None);this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(t)}let e=0;for(const t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(e,t,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&this.ties.length===0)return;s.beginGroup(xs.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,s),this.onNotes.paint(e+this.x,t+this.y,s);const r=e-this.voiceContainer.x-this.renderer.x,n=t-this.voiceContainer.y-this.renderer.y;for(let o=0,l=this.ties.length;o<l;o++){const h=this.ties[o];h.renderer=this.renderer,h.paint(r,n,s)}s.endGroup()}buildBoundingsLookup(e,t,s,i){const r=new Yn;if(r.beat=this.beat,this.beat.isEmpty)r.visualBounds=new Mt,r.visualBounds.x=t+this.x,r.visualBounds.y=e.visualBounds.y,r.visualBounds.w=this.width,r.visualBounds.h=e.visualBounds.h,r.realBounds=new Mt,r.realBounds.x=t+this.x,r.realBounds.y=e.realBounds.y,r.realBounds.w=this.width,r.realBounds.h=e.realBounds.h,r.onNotesX=t+this.x+this.onNotes.centerX;else{r.visualBounds=new Mt,r.visualBounds.x=t+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?r.visualBounds.x=t+this.x:r.visualBounds.x=t+this.x+this.onNotes.x:r.visualBounds.x=t+this.x+this.preNotes.x;let n=0;this.onNotes.isEmpty?this.preNotes.isEmpty?n=t+this.x+this.width:n=t+this.x+this.preNotes.x+this.preNotes.width:n=t+this.x+this.onNotes.x+this.onNotes.width,r.visualBounds.w=n-r.visualBounds.x;const o=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(o&&this.drawBeamHelperAsFlags(o)||this.beat.graceType!==$.None)&&(r.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(u.Flag8thUp)*(this.beat.graceType!==$.None?ve.GraceScale:1)),r.visualBounds.y=e.visualBounds.y,r.visualBounds.h=e.visualBounds.h,r.realBounds=new Mt,r.realBounds.x=t+this.x,r.realBounds.y=e.realBounds.y,r.realBounds.w=this.width,r.realBounds.h=e.realBounds.h,r.onNotesX=t+this.x+this.onNotes.x+this.onNotes.centerX}e.addBeat(r),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(r,t+this.x,s+this.y)}}class $h{_instance;_instanceEventUnregister;_settings;_width=0;_score=null;_trackIndexes=null;get instance(){return this._instance}set instance(e){this._instance=e;const t=this._instanceEventUnregister;if(t)for(const s of t)s();if(e){const s=[];s.push(e.preRender.on(i=>this.preRender.trigger(i))),s.push(e.renderFinished.on(i=>this.renderFinished.trigger(i))),s.push(e.partialRenderFinished.on(i=>this.partialRenderFinished.trigger(i))),s.push(e.partialLayoutFinished.on(i=>this.partialLayoutFinished.trigger(i))),s.push(e.postRenderFinished.on(()=>this.postRenderFinished.trigger())),s.push(e.error.on(i=>this.error.trigger(i))),this._instanceEventUnregister=s,this._settings&&e.updateSettings(this._settings),e.width=this._width,this._score!==null&&e.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(e){this._width=e,this._instance&&(this._instance.width=e)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(e,t){this._score=e,this._trackIndexes=t,this._instance?.renderScore(e,t)}renderResult(e){this._instance?.renderResult(e)}updateSettings(e){this._settings=e,this._instance?.updateSettings(e)}destroy(){this._instance?.destroy(),this._instance=void 0}preRender=new ge;renderFinished=new ge;partialRenderFinished=new ge;partialLayoutFinished=new ge;postRenderFinished=new ct;error=new ge}class Vo{activeBeats;constructor(e){this.activeBeats=e}}class qh{_masterVolume=1;_metronomeVolume=0;_countInVolume=0;_playbackSpeed=1;_isLooping=!1;_midiEventsPlayedFilter=[];_instance;_instanceEventUnregister;constructor(){this.ready=new ct(()=>this.isReady),this.readyForPlayback=new ct(()=>this.isReadyForPlayback),this.midiLoaded=new ge(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new ge(()=>new er(this.state,!1)),this.positionChanged=new ge(()=>this.currentPosition),this.playbackRangeChanged=new ge(()=>{const e=this.playbackRange;return e?new ra(e):null})}get instance(){return this._instance}set instance(e){this._instance=e;const t=this._instanceEventUnregister;if(t)for(const s of t)s();if(e){const s=[];s.push(e.ready.on(()=>this.ready.trigger())),s.push(e.readyForPlayback.on(()=>this.readyForPlayback.trigger())),s.push(e.finished.on(()=>this.finished.trigger())),s.push(e.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),s.push(e.soundFontLoadFailed.on(i=>this.soundFontLoadFailed.trigger(i))),s.push(e.midiLoaded.on(i=>{this.midiLoaded.trigger(i)})),s.push(e.midiLoadFailed.on(i=>this.midiLoadFailed.trigger(i))),s.push(e.stateChanged.on(i=>this.stateChanged.trigger(i))),s.push(e.positionChanged.on(i=>{this.positionChanged.trigger(i)})),s.push(e.midiEventsPlayed.on(i=>this.midiEventsPlayed.trigger(i))),s.push(e.playbackRangeChanged.on(i=>this.playbackRangeChanged.trigger(i))),this._instanceEventUnregister=s,this.isReady?(e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):s.push(e.ready.on(()=>{e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return this._instance?this._instance.isReady:!1}get isReadyForPlayback(){return this._instance?this._instance.isReadyForPlayback:!1}get state(){return this._instance?this._instance.state:vt.Paused}get logLevel(){return E.logLevel}set logLevel(e){E.logLevel=e,this._instance&&(this._instance.logLevel=e)}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,oe.MinVolume),this._masterVolume=e,this._instance&&(this._instance.masterVolume=e)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,oe.MinVolume),this._metronomeVolume=e,this._instance&&(this._instance.metronomeVolume=e)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._instance&&(this._instance.playbackSpeed=e)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new js(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(e){this._instance&&(this._instance.tickPosition=e)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(e){this._instance&&(this._instance.timePosition=e)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(e){this._instance&&(this._instance.playbackRange=e)}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._instance&&(this._instance.isLooping=e)}get countInVolume(){return this._countInVolume}set countInVolume(e){this._countInVolume=e,this._instance&&(this._instance.countInVolume=e)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._instance&&(this._instance.midiEventsPlayedFilter=e)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return this._instance?this._instance.play():!1}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(e){this._instance&&this._instance.playOneTimeMidiFile(e)}loadSoundFont(e,t){this._instance&&this._instance.loadSoundFont(e,t)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(e){this._instance&&this._instance.loadMidiFile(e)}loadBackingTrack(e){this._instance&&this._instance.loadBackingTrack(e)}updateSyncPoints(e){this._instance&&this._instance.updateSyncPoints(e)}applyTranspositionPitches(e){this._instance&&this._instance.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this._instance&&this._instance.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this._instance&&this._instance.setChannelMute(e,t)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(e,t){this._instance&&this._instance.setChannelSolo(e,t)}setChannelVolume(e,t){this._instance&&this._instance.setChannelVolume(e,t)}ready;readyForPlayback;finished=new ct;soundFontLoaded=new ct;soundFontLoadFailed=new ge;midiLoaded;midiLoadFailed=new ge;stateChanged;positionChanged;midiEventsPlayed=new ge;playbackRangeChanged}class Qh{_midiEventQueue=new fn;masterVolume=1;metronomeVolume=0;outSampleRate=44100;currentTempo=120;timeSignatureNumerator=4;timeSignatureDenominator=4;activeVoiceCount=0;output;noteOffAll(e){}resetSoft(){}resetPresets(){}loadPresets(e,t,s,i){}setupMetronomeChannel(e){}synthesizeSilent(e){this.fakeSynthesize()}_processMidiMessage(e){}dispatchEvent(e){this._midiEventQueue.enqueue(e)}synthesize(e,t,s){return this.fakeSynthesize()}fakeSynthesize(){const e=[];for(;!this._midiEventQueue.isEmpty;){const t=this._midiEventQueue.dequeue();t.isMetronome&&this.metronomeVolume>0||t.event&&this._processMidiMessage(t.event),e.push(t)}return e}applyTranspositionPitches(e){}setChannelTranspositionPitch(e,t){}channelSetMute(e,t){}channelSetSolo(e,t){}resetChannelStates(){}channelSetMixVolume(e,t){}hasSamplesForProgram(e){return!0}hasSamplesForPercussion(e){return!0}}class Ho extends Io{_backingTrackOutput;constructor(e,t){super(e,new Qh,t),this.synthesizer.output=e,this._backingTrackOutput=e,e.timeUpdate.on(s=>{const i=this.sequencer.mainTimePositionFromBackingTrack(s,e.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(i),this.synthesizer.fakeSynthesize(),this.updateTimePosition(i,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,t){super.updateTimePosition(e,t),t&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){const t=e.backingTrack;t&&(this._backingTrackOutput.loadBackingTrack(t),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}}class Kh{sampleRate=44100;_seekPosition=0;_handler;get handler(){return this._handler}set handler(e){e&&this._seekPosition!==0&&(e.seekTo(this._seekPosition),this._seekPosition=0),this._handler=e}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(e){const t=this.handler;t&&(t.playbackRate=e)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(e){const t=this.handler;t&&(t.masterVolume=e)}seekTo(e){const t=this.handler;t?t.seekTo(e):this._seekPosition=e}loadBackingTrack(e){}open(e){this.ready.trigger()}updatePosition(e){this.timeUpdate.trigger(e)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(e){}resetSamples(){}activate(){}ready=new ct;samplesPlayed=new ge;timeUpdate=new ge;sampleRequest=new ct;async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}class Zh extends Ho{get handler(){return this.output.handler}set handler(e){this.output.handler=e}constructor(e){super(new Kh,e)}}class jh{startTick=0;endTick=0}class Ma{beat;bounds=null;constructor(e){this.beat=e}}class ec{_startTime=0;_trackIndexes=null;_trackIndexLookup=null;_isDestroyed=!1;_score=null;_tracks=[];_actualPlayerMode=Yt.Disabled;_player;_renderer;get actualPlayerMode(){return this._actualPlayerMode}uiFacade;container;get renderer(){return this._renderer}get score(){return this._score}settings;get tracks(){return this._tracks}canvasElement;constructor(e,t){this.uiFacade=e,this.container=e.rootContainer,this.activeBeatsChanged=new ge(()=>this._player.state===vt.Playing&&this._currentBeat?new Vo(this._currentBeat.beatLookup.highlightedBeats.map(i=>i.beat)):null),this.playedBeatChanged=new ge(()=>this._player.state===vt.Playing&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new ge(()=>this._score?this._score:null),this.midiLoaded=new ge(()=>this._player.loadedMidiInfo??null),e.initialize(this,t),E.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),F.printEnvironmentInfo(!1),this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new $h,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&F.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new ur(this.settings),this.container.resize.on(F.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},e.resizeThrottle));const s=new Oo;s.oldWidth=this._renderer.width,s.newWidth=this.container.width|0,s.settings=this.settings,this._onResize(s),this._renderer.preRender.on(this._onRenderStarted.bind(this)),this._renderer.renderFinished.on(i=>{this._onRenderFinished(i)}),this._renderer.postRenderFinished.on(()=>{const i=Date.now()-this._startTime;E.debug("rendering",`Rendering completed in ${i}ms`),this._onPostRenderFinished()}),this._renderer.preRender.on(i=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(i=>this._appendRenderResult(i,!1)),this._renderer.partialRenderFinished.on(this._updateRenderResult.bind(this)),this._renderer.renderFinished.on(i=>{this._appendRenderResult(i,!0)}),this._renderer.error.on(this.onError.bind(this)),this._setupPlayerWrapper(),this.settings.player.playerMode!==Yt.Disabled&&this._setupOrDestroyPlayer(),this._setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}_setupPlayerWrapper(){const e=new qh;this._player=e,e.ready.on(()=>{this.loadMidiForScore()}),e.readyForPlayback.on(()=>{if(this._onPlayerReady(),this.tracks)for(const t of this.tracks){const s=t.playbackInfo.volume/16;e.setChannelVolume(t.playbackInfo.primaryChannel,s),e.setChannelVolume(t.playbackInfo.secondaryChannel,s)}}),e.soundFontLoaded.on(this._onSoundFontLoaded.bind(this)),e.soundFontLoadFailed.on(t=>{this.onError(t)}),e.midiLoaded.on(this._onMidiLoaded.bind(this)),e.midiLoadFailed.on(t=>{this.onError(t)}),e.stateChanged.on(this._onPlayerStateChanged.bind(this)),e.positionChanged.on(this._onPlayerPositionChanged.bind(this)),e.midiEventsPlayed.on(this._onMidiEventsPlayed.bind(this)),e.playbackRangeChanged.on(this._onPlaybackRangeChanged.bind(this)),e.finished.on(this._onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const e=this.score;e&&L.applyPitchOffsets(this.settings,e),this._updateRenderer(),this._renderer.updateSettings(this.settings),this._setupOrDestroyPlayer(),this._onSettingsUpdated()}_updateRenderer(){const e=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&F.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?e.instance instanceof ur&&(e.destroy(),e.instance=this.uiFacade.createWorkerRenderer()):e.instance instanceof ur||(e.destroy(),e.instance=new ur(this.settings))}load(e,t){try{return this.uiFacade.load(e,s=>{this.renderScore(s,t)},s=>{this.onError(s)})}catch(s){return this.onError(s),!1}}renderScore(e,t){const s=[];if(!t)e.tracks.length>0&&s.push(e.tracks[0]);else if(t.length===0)e.tracks.length>0&&s.push(e.tracks[0]);else if(t.length===1&&t[0]===-1)for(const i of e.tracks)s.push(i);else for(const i of t)i>=0&&i<=e.tracks.length&&s.push(e.tracks[i]);this._internalRenderTracks(e,s)}renderTracks(e){if(e.length>0){const t=e[0].score;for(const s of e)if(s.score!==t){this.onError(new Ve(Oe.General,"All rendered tracks must belong to the same score."));return}this._internalRenderTracks(t,e)}}_internalRenderTracks(e,t){if(L.applyPitchOffsets(this.settings,e),e!==this.score){this._score=e,this._tracks=t,this._tickCache=null,this._trackIndexes=[];for(const s of t)this._trackIndexes.push(s.index);this._trackIndexLookup=new Set(this._trackIndexes),this._onScoreLoaded(e),this.loadMidiForScore(),this.render()}else{this._tracks=t;const s=L.computeFirstDisplayedBarIndex(e,this.settings),i=L.computeLastDisplayedBarIndex(e,this.settings,s);this._tickCache&&(this._tickCache.multiBarRestInfo=L.buildMultiBarRestInfo(this.tracks,s,i)),this._trackIndexes=[];for(const r of t)this._trackIndexes.push(r.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(!this.container.isVisible)E.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{E.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()});else{const e=new Oo;e.oldWidth=this._renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this._onResize(e),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}}_appendRenderResult(e,t){t&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight)),(e.width>0||e.height>0)&&this.uiFacade.beginAppendRenderResults(e),t&&this.uiFacade.beginAppendRenderResults(null)}_updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{const s=new Za;s.logErrors=!0,s.initFromString(e,this.settings);const i=s.readScore();this.renderScore(i,t)}catch(s){this.onError(s)}}loadSoundFont(e,t=!1){return this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}_tickCache=null;get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(e){this._player.masterVolume=e}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(e){this._player.metronomeVolume=e}get countInVolume(){return this._player.countInVolume}set countInVolume(e){this._player.countInVolume=e}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._player.midiEventsPlayedFilter=e}get tickPosition(){return this._player.tickPosition}set tickPosition(e){this._player.tickPosition=e}get timePosition(){return this._player.timePosition}set timePosition(e){this._player.timePosition=e}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(e){this._player.playbackRange=e,this._updateSelectionCursor(e)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(e){this._player.playbackSpeed=e}get isLooping(){return this._player.isLooping}set isLooping(e){this._player.isLooping=e}_destroyPlayer(){this._player.destroy(),this._previousTick=0,this._destroyCursors()}_setupOrDestroyPlayer(){let e=this.settings.player.playerMode;if(e===Yt.EnabledAutomatic){const s=this.score;if(!s)return!1;s?.backingTrack?.rawAudioFile?e=Yt.EnabledBackingTrack:e=Yt.EnabledSynthesizer}let t=null;if(e!==this._actualPlayerMode)switch(this._destroyPlayer(),this._updateCursors(),e){case Yt.Disabled:t=null;break;case Yt.EnabledSynthesizer:t=this.uiFacade.createWorkerPlayer();break;case Yt.EnabledBackingTrack:t=this.uiFacade.createBackingTrackPlayer();break;case Yt.EnabledExternalMedia:t=new Zh(this.settings.player.bufferTimeInMilliseconds);break}else return this._updateCursors(),!1;return this._actualPlayerMode=e,t&&(this._player.instance=t),!1}loadMidiForScore(){if(!this.score)return;const e=this.score;E.debug("AlphaTab","Generating Midi");const t=new Ks,s=new Fs(t),i=new we(e,this.settings,s),r=L.computeFirstDisplayedBarIndex(e,this.settings),n=L.computeLastDisplayedBarIndex(e,this.settings,r);i.tickLookup.multiBarRestInfo=L.buildMultiBarRestInfo(this.tracks,r,n),i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this._onMidiLoad(t);const o=this._player;o.loadMidiFile(t),o.loadBackingTrack(e),o.updateSyncPoints(i.syncPoints),o.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const e=this.score;this._player.updateSyncPoints(we.generateSyncPoints(e))}changeTrackVolume(e,t){for(const s of e)this._player.setChannelVolume(s.playbackInfo.primaryChannel,t),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){for(const s of e)this._player.setChannelSolo(s.playbackInfo.primaryChannel,t),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){for(const s of e)this._player.setChannelMute(s.playbackInfo.primaryChannel,t),this._player.setChannelMute(s.playbackInfo.secondaryChannel,t)}changeTrackTranspositionPitch(e,t){for(const s of e)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,t),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,t)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(e){const t=new Ks,s=new Fs(t);new we(e.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(e),this._player.playOneTimeMidiFile(t)}playNote(e){const t=new Ks,s=new Fs(t);new we(e.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(e),this._player.playOneTimeMidiFile(t)}_cursorWrapper=null;_barCursor=null;_beatCursor=null;_selectionWrapper=null;_previousTick=0;_currentBeat=null;_currentBeatBounds=null;_isInitialBeatCursorUpdate=!0;_previousStateForCursor=vt.Paused;_previousCursorCache=null;_lastScroll=0;_destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}_updateCursors(){const e=this._hasCursor;if(e&&!this._cursorWrapper){const t=this.uiFacade.createCursors();t&&(this._cursorWrapper=t.cursorWrapper,this._barCursor=t.barCursor,this._beatCursor=t.beatCursor,this._selectionWrapper=t.selectionWrapper,this._isInitialBeatCursorUpdate=!0),this._currentBeat!==null&&this._cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}else!e&&this._cursorWrapper&&this._destroyCursors()}_cursorUpdateTick(e,t,s,i=!1,r=!1){this._previousTick=e;const n=this._tickCache;if(n){const o=this._trackIndexLookup;if(o!=null&&o.size>0){const l=n.findBeat(o,e,this._currentBeat);l&&this._cursorUpdateBeat(l,t,i,s,r||this.playerState===vt.Paused)}}}_cursorUpdateBeat(e,t,s,i,r=!1){const n=e.beat,o=e.nextBeat?.beat??null,l=e.duration,h=e.beatLookup.highlightedBeats;if(!n)return;const c=this._renderer.boundsLookup;if(!c)return;const d=this._currentBeat,f=this._previousCursorCache,p=this._previousStateForCursor;if(!r&&n===d?.beat&&c===f&&p===this._player.state&&d?.start===e.start)return;const g=c.findBeat(n);g&&(this._currentBeat=e,this._previousCursorCache=c,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this._internalCursorUpdateBeat(n,o,l,t,h,c,g,s,e.cursorMode,i)}))}scrollToCursor(){const e=this._currentBeatBounds;e&&this._internalScrollToCursor(e.barBounds.masterBarBounds)}_internalScrollToCursor(e){const t=this.uiFacade.getScrollContainer(),s=F.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,i=this.settings.player.scrollMode;if(s){const r=e.realBounds.y+this.settings.player.scrollOffsetY;if(r!==this._lastScroll)switch(this._lastScroll=r,i){case ri.Continuous:const n=this.uiFacade.getOffset(t,this.container);this.uiFacade.scrollToY(t,n.y+r,this.settings.player.scrollSpeed);break;case ri.OffScreen:const o=t.scrollTop+this.uiFacade.getOffset(null,t).h;if(e.visualBounds.y+e.visualBounds.h>=o||e.visualBounds.y<t.scrollTop){const l=e.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(t,l,this.settings.player.scrollSpeed)}break}}else{const r=e.visualBounds.x;if(r!==this._lastScroll)switch(this._lastScroll=r,i){case ri.Continuous:const n=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,n,this.settings.player.scrollSpeed);break;case ri.OffScreen:const o=t.scrollLeft+this.uiFacade.getOffset(null,t).w;if(e.visualBounds.x+e.visualBounds.w>=o||e.visualBounds.x<t.scrollLeft){const l=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,l,this.settings.player.scrollSpeed)}break}}}_internalCursorUpdateBeat(e,t,s,i,r,n,o,l,h,c){const d=this._barCursor,f=this._beatCursor,p=o.barBounds.masterBarBounds,g=p.visualBounds,m=this._currentBeatBounds;this._currentBeatBounds=o,d&&d.setBounds(g.x,g.y,g.w,g.h);const b=this._player.state===vt.Playing&&!i;let S=p.visualBounds.x+p.visualBounds.w;if(t&&h===ys.ToNextBext){const v=n.findBeat(t);v&&v.barBounds.masterBarBounds.staffSystemBounds===p.staffSystemBounds&&(S=v.onNotesX)}let T=o.onNotesX;if(f){if(this.settings.player.enableAnimatedBeatCursor){const v=S-o.onNotesX,G=this._previousTick-this._currentBeat.start,W=this._currentBeat.tickDuration>0?G/this._currentBeat.tickDuration:0;T=o.onNotesX+v*W,s-=s*W,b?((!m||this._isInitialBeatCursorUpdate||g.y!==m.barBounds.masterBarBounds.visualBounds.y||T<m.onNotesX||p.index>m.barBounds.masterBarBounds.index+1)&&(f.transitionToX(0,T),f.setBounds(T,g.y,1,g.h)),this.uiFacade.beginInvoke(()=>{const se=h===ys.ToNextBext?2:1,Ne=T+(S-T)*se;f.transitionToX(s/c*se,Ne)})):(f.transitionToX(0,T),f.setBounds(T,g.y,1,g.h))}else f.transitionToX(0,T),f.setBounds(T,g.y,1,g.h);this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let C=!1;if(b){if(this.settings.player.enableElementHighlighting)for(const v of r){const G=xs.getGroupId(v.beat);this.uiFacade.highlightElements(G,e.voice.bar.index)}l=!i,C=!0}l&&!this._isBeatMouseDown&&this.settings.player.scrollMode!==ri.Off&&this._internalScrollToCursor(p),C&&(this._onPlayedBeatChanged(e),this._onActiveBeatsChanged(new Vo(r.map(v=>v.beat))))}playedBeatChanged;_onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}activeBeatsChanged;_onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}_isBeatMouseDown=!1;_isNoteMouseDown=!1;_selectionStart=null;_selectionEnd=null;beatMouseDown=new ge;beatMouseMove=new ge;beatMouseUp=new ge;noteMouseDown=new ge;noteMouseMove=new ge;noteMouseUp=new ge;get _hasCursor(){return this.settings.player.playerMode!==Yt.Disabled&&this.settings.player.enableCursor}_onBeatMouseDown(e,t){this._isDestroyed||(this._hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Ma(t),this._selectionEnd=null),this._isBeatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}_onNoteMouseDown(e,t){this._isDestroyed||(this._isNoteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}_onBeatMouseMove(e,t){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==t)&&(this._selectionEnd=new Ma(t),this._cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}_onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}_onBeatMouseUp(e,t){if(!this._isDestroyed){if(this._hasCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){const s=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<s){const r=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=r}}if(this._selectionStart&&this._tickCache){const s=this._tickCache,i=s.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._player.state===vt.Paused&&this._cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=i+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){const r=s.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),n=new jh;n.startTick=i+this._selectionStart.beat.playbackStart,n.endTick=r+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=n}else this._selectionStart=null,this.playbackRange=null,this._cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._isBeatMouseDown=!1}}_onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._isNoteMouseDown=!1)}_updateSelectionCursor(e){if(this._tickCache)if(e){const t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),s=this._tickCache.findBeat(this._trackIndexLookup,e.endTick);if(t&&s){const i=new Ma(t.beat),r=new Ma(s.beat);this._cursorSelectRange(i,r)}}else this._cursorSelectRange(null,null)}_setupClickHandling(){this.canvasElement.mouseDown.on(e=>{if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this._onBeatMouseDown(e,i),this.settings.core.includeNoteBounds)){const r=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);r&&this._onNoteMouseDown(e,r)}}),this.canvasElement.mouseMove.on(e=>{if(!this._isBeatMouseDown)return;const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this._onBeatMouseMove(e,i),this._isNoteMouseDown)){const r=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);r&&this._onNoteMouseMove(e,r)}}),this.canvasElement.mouseUp.on(e=>{if(!this._isBeatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(this._onBeatMouseUp(e,i),this._isNoteMouseDown)if(i){const r=this._renderer.boundsLookup?.getNoteAtPos(i,t,s)??null;this._onNoteMouseUp(e,r)}else this._onNoteMouseUp(e,null)}),this._renderer.postRenderFinished.on(()=>{!this._selectionStart||!this._hasCursor||!this.settings.player.enableUserInteraction||this._cursorSelectRange(this._selectionStart,this._selectionEnd)})}_cursorSelectRange(e,t){const s=this._renderer.boundsLookup;if(!s)return;const i=this._selectionWrapper;if(!i||(i.clear(),!e||!t||e.beat===t.beat))return;e.bounds||(e.bounds=s.findBeat(e.beat)),t.bounds||(t.bounds=s.findBeat(t.beat));const r=this._tickCache?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart)<r){const h=e;e=t,t=h}const o=e.bounds.realBounds.x;let l=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(l=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staffSystemBounds!==t.bounds.barBounds.masterBarBounds.staffSystemBounds){const h=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,c=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,d=this.uiFacade.createSelectionElement();d.setBounds(o,e.bounds.barBounds.masterBarBounds.visualBounds.y,c-o,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(d);const f=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,p=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let m=f;m<p;m++){const b=s.staffSystems[m],S=this.uiFacade.createSelectionElement();S.setBounds(h,b.visualBounds.y,c-h,b.visualBounds.h),i.appendChild(S)}const g=this.uiFacade.createSelectionElement();g.setBounds(h,t.bounds.barBounds.masterBarBounds.visualBounds.y,l-h,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(g)}else{const h=this.uiFacade.createSelectionElement();h.setBounds(o,e.bounds.barBounds.masterBarBounds.visualBounds.y,l-o,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(h)}}scoreLoaded;_onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e),this._setupOrDestroyPlayer()||this.loadMidiForScore())}resize=new ge;_onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}renderStarted=new ge;_onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}renderFinished=new ge;_onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}postRenderFinished=new ct;_onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this._cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}error=new ge;onError(e){this._isDestroyed||(E.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}get playerReady(){return this._player.readyForPlayback}_onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}_onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}_onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}midiLoad=new ge;_onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}midiLoaded;_onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}get playerStateChanged(){return this._player.stateChanged}_onPlayerStateChanged(e){if(!this._isDestroyed){if(!e.stopped&&e.state===vt.Paused){const t=this._currentBeat,s=this._tickCache;t&&s&&(this._player.tickPosition=s.getBeatStart(t.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",e)}}get playerPositionChanged(){return this._player.positionChanged}_onPlayerPositionChanged(e){this._isDestroyed||(this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{const t=e.modifiedTempo/e.originalTempo;this._cursorUpdateTick(e.currentTick,!1,t,!1,e.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}get midiEventsPlayed(){return this._player.midiEventsPlayed}_onMidiEventsPlayed(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e)}get playbackRangeChanged(){return this._player.playbackRangeChanged}_onPlaybackRangeChanged(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e)}settingsUpdated=new ct;_onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this._player.output.enumerateOutputDevices()}async setOutputDevice(e){await this._player.output.setOutputDevice(e)}async getOutputDevice(){return await this._player.output.getOutputDevice()}async exportAudio(e){if(!this.score)throw new Ve(Oe.General,"No song loaded");let t;switch(this._actualPlayerMode){case Yt.EnabledSynthesizer:t=this.uiFacade.createWorkerAudioExporter(this._player.instance);break;default:t=this.uiFacade.createWorkerAudioExporter(null);break}const s=this.score,i=new Ks,r=new Fs(i),n=new we(s,this.settings,r);n.applyTranspositionPitches=!1,n.generate();const o=new xh;o.soundFonts=e.soundFonts,o.sampleRate=e.sampleRate,o.useSyncPoints=e.useSyncPoints,o.masterVolume=e.masterVolume,o.metronomeVolume=e.metronomeVolume,o.playbackRange=e.playbackRange;for(const[l,h]of e.trackVolume)if(l<this.score.tracks.length){const c=this.score.tracks[l];o.trackVolume.set(c.playbackInfo.primaryChannel,h),o.trackVolume.set(c.playbackInfo.secondaryChannel,h)}for(const[l,h]of e.trackTranspositionPitches)if(l<this.score.tracks.length){const c=this.score.tracks[l];o.trackTranspositionPitches.set(c.playbackInfo.primaryChannel,h),o.trackTranspositionPitches.set(c.playbackInfo.secondaryChannel,h)}return await t.initialize(o,i,n.syncPoints,n.transpositionPitches),t}}class Ri extends Ve{xhr;constructor(e,t){super(Oe.General,e),this.xhr=t}}class ar{static loadAlphaTex(e,t){const s=new Za;return s.logErrors=!0,s.initFromString(e,t??new _i),s.readScore()}static loadScoreAsync(e,t,s,i){const r=new XMLHttpRequest;r.open("GET",e,!0,null,null),r.responseType="arraybuffer",r.onreadystatechange=()=>{if(r.readyState===XMLHttpRequest.DONE){const n=r.response;if(r.status===200||r.status===0&&n)try{const o=r.response,l=new Uint8Array(o),h=ar.loadScoreFromBytes(l,i);t(h)}catch(o){s(o)}else r.status===0?s(new Ri(`You are offline!!
 Please Check Your Network.`,r)):r.status===404?s(new Ri("Requested URL not found.",r)):r.status===500?s(new Ri("Internel Server Error.",r)):r.statusText==="parsererror"?s(new Ri(`Error.
Parsing JSON Request failed.`,r)):r.statusText==="timeout"?s(new Ri("Request Time out.",r)):s(new Ri(`Unknow Error: ${r.responseText}`,r))}},r.send()}static loadScoreFromBytes(e,t){t||(t=new _i);const s=F.buildImporters();E.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${s.length} importers`);let i=null;const r=pt.fromBuffer(e);for(const n of s){r.reset();try{E.debug("ScoreLoader",`Importing using importer ${n.name}`),n.init(r,t),i=n.readScore(),E.debug("ScoreLoader",`Score imported using ${n.name}`);break}catch(o){if(o instanceof ft)E.debug("ScoreLoader",`${n.name} does not support the file`);else throw E.error("ScoreLoader","Score import failed due to unexpected error: ",o),o}}if(i)return i;throw new ft("No compatible importer found for file")}}class mn{mouseEvent;get isLeftMouseButton(){return this.mouseEvent.button===0}getX(e){const t=e.element,i=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-i}getY(e){const t=e.element,i=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-i}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}}class ai{static _resizeObserver=new Ji(()=>new ResizeObserver(e=>{for(const t of e){const s=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(s)}}));_resizeListeners=0;get width(){return this.element.offsetWidth}set width(e){this.element.style.width=`${e}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollLeft=e}get scrollTop(){return this.element.scrollTop}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){e>=0?this.element.style.height=`${e}px`:this.element.style.height="100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}element;constructor(e){this.element=e,this.mouseDown={on:s=>{const i=r=>{s(new mn(r))};return this.element.addEventListener("mousedown",i,!0),()=>{this.element.removeEventListener("mousedown",i,!0)}},off:s=>{}},this.mouseUp={on:s=>{const i=r=>{s(new mn(r))};return this.element.addEventListener("mouseup",i,!0),()=>{this.element.removeEventListener("mouseup",i,!0)}},off:s=>{}},this.mouseMove={on:s=>{const i=r=>{s(new mn(r))};return this.element.addEventListener("mousemove",i,!0),()=>{this.element.removeEventListener("mousemove",i,!0)}},off:s=>{}};const t=this;this.resize={on:function(s){return t._resizeListeners===0&&ai._resizeObserver.value.observe(t.element),t.element.addEventListener("resize",s,!0),t._resizeListeners++,()=>this.off(s)},off:s=>{this.element.removeEventListener("resize",s,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,ai._resizeObserver.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,Number.NaN,Number.NaN,Number.NaN)}lastBounds=new Mt;setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}resize;mouseDown;mouseMove;mouseUp;appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}class Go{_originalFamilies;_families;_isStarted=!1;isFontLoaded=!1;fontLoaded=new ge;constructor(e){this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(F.isRunningInWorker){this.isFontLoaded=!1;return}if(this._isStarted)return;this._isStarted=!0;let e=0;const t=window.setInterval(()=>{E.warning("Rendering",`Could not load font '${this._families[0]}' within ${(e+1)*5} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);E.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);const s=n=>{this._families.length>1?(E.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,n),this._families.shift(),window.setTimeout(()=>{r()},0)):(E.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,n),window.clearInterval(t))},i=n=>{E.debug("Font",`[${n}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},r=async()=>{for(const n of this._families)if(await this._isFontAvailable(n,!1)){i(n);return}try{await document.fonts.load(`1em ${this._families[0]}`)}catch(n){s(n)}return E.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this._isFontAvailable(this._families[0],!0)?i(this._families[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{r()})}_isFontAvailable(e,t){return new Promise(s=>{const i=`1em ${e}`;if(document.fonts.check(i))s(!0);else if(t){E.debug("Font",`Font ${e} not available, creating test element to trigger load`);const r=document.createElement("div");r.style.font=i,r.style.opacity="0",r.style.position="absolute",r.style.top="0",r.style.left="0",r.innerText=`Trigger ${e} load`,document.body.appendChild(r),setTimeout(()=>{document.body.removeChild(r),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class tc extends Us{_audioNode=null;_circularBuffer;_bufferCount=0;_requestedBufferCount=0;open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/Us.BufferSize),this._circularBuffer=new io(Us.BufferSize*this._bufferCount),this.onReady()}play(){super.play();const e=this.context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this._generateSound.bind(this),this._circularBuffer.clear(),this._requestBuffers(),this.source=e.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=!0,this.source.connect(this._audioNode,0,0),this.source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}_requestBuffers(){const e=this._bufferCount/2|0,t=e*Us.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*Us.BufferSize<t){for(let i=0;i<e;i++)this.onSampleRequest();this._requestedBufferCount+=e}}_outputBuffer=new Float32Array(0);_generateSound(e){const t=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),i=t.length+s.length;let r=this._outputBuffer;r.length!==i&&(r=new Float32Array(i),this._outputBuffer=r);const n=this._circularBuffer.read(r,0,Math.min(r.length,this._circularBuffer.count));let o=0;const l=Math.min(t.length,n);for(let h=0;h<l;h++)t[h]=r[o++],s[h]=r[o++];if(n<t.length)for(let h=n;h<t.length;h++)t[h]=0,s[h]=0;this.onSamplesPlayed(n/oe.AudioChannels),this._requestBuffers()}}class yn{_synth;_output;_workerIsReadyForPlayback=!1;_workerIsReady=!1;_outputIsReady=!1;_state=vt.Paused;_masterVolume=0;_metronomeVolume=0;_countInVolume=0;_playbackSpeed=0;_isLooping=!1;_playbackRange=null;_midiEventsPlayedFilter=[];_loadedMidiInfo;_currentPosition=new js(0,0,0,0,!1,120,120);get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return E.logLevel}get worker(){return this._synth}set logLevel(e){E.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,oe.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,oe.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,oe.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:F.prepareForPostMessage(e)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=L.clamp(e,oe.MinPlaybackSpeed,oe.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(e){e<0&&(e=0),this._currentPosition=new js(this._currentPosition.currentTime,this._currentPosition.endTime,e,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._currentPosition.currentTime}set timePosition(e){e<0&&(e=0),this._currentPosition=new js(e,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:F.prepareForPostMessage(e)})}constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=vt.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this._onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=F.createWebWorker(t)}catch(s){E.error("AlphaSynth",`Failed to create WebWorker: ${s}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:yt.midiFileToJsObject(F.prepareForPostMessage(e))})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:F.prepareForPostMessage(e),append:t})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:yt.midiFileToJsObject(F.prepareForPostMessage(e))})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(F.prepareForPostMessage(e).entries()))})}setChannelTranspositionPitch(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:e,semitones:t})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,oe.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){const t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this._checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this._checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new js(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Ao(t.events.map(yt.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new er(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new ra(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this._checkReadyForPlayback(),this._loadedMidiInfo=new js(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this._checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples();break}}_checkReady(){this.isReady&&this.ready.trigger()}_checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}ready=new ct;readyForPlayback=new ct;finished=new ct;soundFontLoaded=new ct;soundFontLoadFailed=new ge;midiLoaded=new ge;midiLoadFailed=new ge;stateChanged=new ge;positionChanged=new ge;midiEventsPlayed=new ge;playbackRangeChanged=new ge;onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}_onOutputReady(){this._outputIsReady=!0,this._checkReady()}loadBackingTrack(e){}updateSyncPoints(e){}}class sc{_api;_worker;_width=0;boundsLookup=null;constructor(e,t){this._api=e;try{this._worker=F.createWebWorker(t)}catch(s){E.error("Rendering",`Failed to create WebWorker: ${s}`);return}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this._serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this._handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this._serializeSettingsForWorker(e)})}_serializeSettingsForWorker(e){const t=yt.settingsToJsObject(F.prepareForPostMessage(e));return t.delete("player"),t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}_handleWorkerMessage(e){const t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=rs.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error);break}}renderScore(e,t){const s=e==null?null:yt.scoreToJsObject(F.prepareForPostMessage(e));this._worker.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:F.prepareForPostMessage(t),fontSizes:ds.fontSizeLookupTables})}preRender=new ge;partialRenderFinished=new ge;partialLayoutFinished=new ge;renderFinished=new ge;postRenderFinished=new ct;error=new ge}class ic{cursorWrapper;barCursor;beatCursor;selectionWrapper;constructor(e,t,s,i){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=s,this.selectionWrapper=i}}class rc extends ai{_xscale;_yscale;constructor(e,t,s){super(e),this._xscale=t,this._yscale=s}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=`${e*this._xscale}px`}get height(){return this.element.offsetHeight/this._yscale}set height(e){e>=0?this.element.style.height=`${e*this._yscale}px`:this.element.style.height="100%"}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s=s/this._xscale,Number.isNaN(i)?i=this.lastBounds.h:i=i/this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}}class ac{sampleRate=44100;audioElement;_updateInterval=0;get backingTrackDuration(){const e=this.audioElement.duration??0;return Number.isFinite(e)?e*1e3:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(e){this.audioElement.playbackRate=e}get masterVolume(){return this.audioElement.volume}set masterVolume(e){this.audioElement.volume=e}seekTo(e){this.audioElement.currentTime=e/1e3}loadBackingTrack(e){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const t=new Blob([e.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(t),this.audioElement.playbackRate=s}open(e){const t=document.createElement("audio");t.style.display="none",document.body.appendChild(t),t.addEventListener("seeked",()=>{this._updatePosition()}),t.addEventListener("timeupdate",()=>{this._updatePosition()}),this.audioElement=t,this.ready.trigger()}_updatePosition(){const e=this.audioElement.currentTime*1e3;this.timeUpdate.trigger(e)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this._updatePosition()},50)}destroy(){const e=this.audioElement;e&&document.body.removeChild(e)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(e){}resetSamples(){}activate(){}ready=new ct;samplesPlayed=new ge;timeUpdate=new ge;sampleRequest=new ct;async enumerateOutputDevices(){return es.enumerateOutputDevices()}async setOutputDevice(e){await es.checkSinkIdSupport()&&(e?await this.audioElement.setSinkId(e.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await es.checkSinkIdSupport())return null;const e=this.audioElement.sinkId;if(typeof e!="string"||e===""||e==="default")return null;let t=es.findKnownDevice(e);if(t)return t;const s=await this.enumerateOutputDevices();return t=s.find(i=>i.deviceId===e),t||(E.warning("WebAudio","Could not find output device in device list",e,s),null)}}class bn{static _nextExporterId=1;_worker;_unsubscribe;_exporterId;_ownsWorker;_promise=null;constructor(e,t){this._exporterId=bn._nextExporterId++,this._worker=e,this._ownsWorker=t}async initialize(e,t,s,i){const r=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",r,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",r,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:F.prepareForPostMessage(e),midi:yt.midiFileToJsObject(F.prepareForPostMessage(t)),syncPoints:F.prepareForPostMessage(s),transpositionPitches:F.prepareForPostMessage(i)}),await this._promise.promise}handleWorkerMessage(e){const t=e.data;if(t.exporterId!==this._exporterId)return;switch(t.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(t.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(t.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new Ve(Oe.General,"Worker was destroyed")),this._promise=null;break}}async render(e){if(this._promise)throw new Ve(Oe.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:e}),await this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}}var Ys;(function(a){a[a.LayoutDone=0]="LayoutDone",a[a.RenderRequested=1]="RenderRequested",a[a.RenderDone=2]="RenderDone",a[a.Detached=3]="Detached"})(Ys||(Ys={}));class Wi{_fontCheckers=new Map;_api;_contents=null;_file=null;_totalResultCount=0;_initialTrackIndexes=null;_intersectionObserver;_barToElementLookup=new Map;_resultIdToElementLookup=new Map;_webFont;rootContainerBecameVisible=new ct;canRenderChanged=new ct;get resizeThrottle(){return 10}rootContainer;areWorkersSupported;get canRender(){return this._areAllFontsLoaded()}_areAllFontsLoaded(){let e=!1;for(const t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return e?!1:(E.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}_onFontLoaded(e){ds.generateFontLookup(e),this._areAllFontsLoaded()&&this.canRenderChanged.trigger()}constructor(e){if(F.webPlatform!==Bs.Browser&&F.webPlatform!==Bs.BrowserModule)throw new Ve(Oe.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new ai(e),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this._onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}_onElementVisibilityChanged(e){for(const t of e){const s=t.target;if(s===this.rootContainer.element)t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in s&&this._api.settings.core.enableLazyLoading){const i=s;t.isIntersecting?i.renderedResultId!==i.layoutResultId?this._resultIdToElementLookup.has(i.layoutResultId)?i.resultState!==Ys.RenderRequested&&(i.resultState=Ys.RenderRequested,this._api.renderer.renderResult(i.layoutResultId)):s.replaceChildren():i.resultState===Ys.Detached&&(s.replaceChildren(...i.renderedResult),i.resultState=Ys.RenderDone):i.resultState===Ys.RenderDone&&(i.resultState=Ys.Detached,i.replaceChildren())}}}createWorkerRenderer(){return new sc(this._api,this._api.settings)}initialize(e,t){this._api=e;let s;t instanceof _i?s=t:s=yt.jsObjectToSettings(t);const i=this._getDataAttributes();bi.fromJson(s,i),s.notation.notationMode===Et.SongBook&&s.setSongBookModeSettings(),e.settings=s,this._setupFontCheckers(s),this._initialTrackIndexes=this.parseTracks(s.core.tracks),this._contents="";const r=e.container;s.core.tex&&(this._contents=r.element.innerHTML,r.element.innerHTML=""),this._createStyleElements(s),this._file=s.core.file}_setupFontCheckers(e){this._registerFontChecker(e.display.resources.copyrightFont),this._registerFontChecker(e.display.resources.effectFont),this._registerFontChecker(e.display.resources.graceFont),this._registerFontChecker(e.display.resources.markerFont),this._registerFontChecker(e.display.resources.tablatureFont),this._registerFontChecker(e.display.resources.titleFont),this._registerFontChecker(e.display.resources.wordsFont),this._registerFontChecker(e.display.resources.barNumberFont),this._registerFontChecker(e.display.resources.fretboardNumberFont),this._registerFontChecker(e.display.resources.subTitleFont)}_registerFontChecker(e){if(!this._fontCheckers.has(e.families.join(", "))){const t=new Go(e.families);this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this._onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";const e=this._webFont;e.usages--,e.usages<=0&&(e.element.remove(),Wi._registeredWebFonts.delete(e.hash))}createCanvasElement(){const e=document.createElement("div");return e.classList.add("at-surface",`at${this._webFont.fontSuffix}`),e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new ai(e)}triggerEvent(e,t,s=null,i){const r=e.element;t=`alphaTab.${t}`;const n=document.createEvent("CustomEvent"),o=i?i.mouseEvent:null;if(n.initCustomEvent(t,!1,!1,s),o&&(n.originalEvent=o),r.dispatchEvent(n),window&&"jQuery"in window){const l=window.jQuery,h=[];h.push(s),o&&h.push(o),l(r).trigger(t,h)}}load(e,t,s){if(e instanceof Ws)return t(e),!0;if(e instanceof ArrayBuffer){const i=new Uint8Array(e);return t(ar.loadScoreFromBytes(i,this._api.settings)),!0}return e instanceof Uint8Array?(t(ar.loadScoreFromBytes(e,this._api.settings)),!0):typeof e=="string"?(ar.loadScoreAsync(e,t,s,this._api.settings),!0):!1}loadSoundFont(e,t){return this._api.player?e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),!0):typeof e=="string"?(this._api.loadSoundFontFromUrl(e,t),!0):!1:!1}initialRender(){this._api.renderer.preRender.on(t=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});const e=()=>{this._api.renderer.width=this.rootContainer.width|0,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&ar.loadScoreAsync(this._file,t=>{this._api.renderScore(t,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},t=>{this._api.onError(t)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}_createStyleElements(e){const t=this._api.container.element.ownerDocument;Wi.createSharedStyleElement(t);const s=e.core.smuflFontSources??_l.buildDefaultSmuflFontSources(e.core.fontDirectory),i=Wi._cyrb53(s.values()),r=Wi._registeredWebFonts;if(r.has(i)){const p=r.get(i);p.usages++,p.checker.fontLoaded.on(this._onFontLoaded.bind(this)),this._webFont=p;return}const n=r.size===0?"":String(r.size),o=`alphaTab${n}`,l=Array.from(s.entries()).map(p=>`url(${JSON.stringify(p[1])}) format('${Wi._cssFormat(p[0])}')`).join(","),h=`
            @font-face {
                font-display: block;
                font-family: '${o}';
                src: ${l};
                font-weight: normal;
                font-style: normal;
            }
            .at-surface.at${n} .at {
                font-family: '${o}';
                speak: none;
                font-style: normal;
                font-weight: normal;
                font-variant: normal;
                text-transform: none;
                line-height: 1;
                line-height: 1;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-size: ${e.display.resources.engravingSettings.musicFontSize}px;
                overflow: visible !important;
            }`,c=t.createElement("style");c.id=`alphaTabStyle${n}`,c.innerHTML=h,t.getElementsByTagName("head").item(0).appendChild(c);const d=new Go([o]);d.fontLoaded.on(this._onFontLoaded.bind(this)),this._fontCheckers.set(o,d),d.checkForFontAvailability(),e.display.resources.smuflFontFamilyName=o;const f={hash:i,element:c,fontSuffix:n,usages:1,checker:d};r.set(i,f),this._webFont=f}static _cssFormat(e){switch(e){case Ns.EmbeddedOpenType:return"embedded-opentype";case Ns.Woff:return"woff";case Ns.Woff2:return"woff2";case Ns.OpenType:return"opentype";case Ns.TrueType:return"truetype";case Ns.Svg:return"svg"}}static _registeredWebFonts=new Map;static _cyrb53(e,t=0){let s=3735928559^t,i=1103547991^t;for(const r of e)for(let n=0;n<r.length;n++){const o=r.charCodeAt(n);s=Math.imul(s^o,2654435761),i=Math.imul(i^o,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(e){let t=e.getElementById("alphaTabStyle");if(!t){t=document.createElement("style"),t.id="alphaTabStyleShared";const s=`
                .at-surface * {
                    cursor: default;
                    vertical-align: top;
                    overflow: visible;
                }
                .at-surface-svg text {
                    dominant-baseline: alphabetic;
                    white-space:pre;
                }`;t.innerHTML=s,document.getElementsByTagName("head").item(0).appendChild(t)}}parseTracks(e){if(!e)return[];const t=[];if(typeof e=="string")try{if(e==="all")return[-1];e=JSON.parse(e)}catch{e=[0]}if(typeof e=="number")t.push(e);else if("length"in e){const s=e.length,i=e;for(let r=0;r<s;r++){const n=i[r];let o=0;typeof n=="number"?o=n:"index"in n?o=n.index:o=Number.parseInt(n.toString(),10),(o>=0||o===-1)&&t.push(o)}}else"index"in e&&t.push(e.index);return t}_getDataAttributes(){const e=new Map,t=this._api.container.element;if(t.dataset)for(const s of Object.keys(t.dataset)){let i=t.dataset[s];try{i=JSON.parse(i)}catch{i===""&&(i=null)}e.set(s,i)}else for(let s=0;s<t.attributes.length;s++){const i=t.attributes.item(s),r=i.nodeName;if(r.startsWith("data-")){const n=r.substr(5).split("-");let o=n[0];for(let h=1;h<n.length;h++)o+=n[h].substr(0,1).toUpperCase()+n[h].substr(1);let l=i.nodeValue;try{l=JSON.parse(l)}catch{l===""&&(l=null)}e.set(o,l)}}return e}beginUpdateRenderResults(e){if(!this._resultIdToElementLookup.has(e.id))return;const t=this._resultIdToElementLookup.get(e.id),s=e.renderResult;typeof s=="string"?t.innerHTML=s:"nodeType"in s&&t.replaceChildren(s),t.resultState=Ys.RenderDone,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children)}beginAppendRenderResults(e){const t=this._api.canvasElement.element;if(e){let s;this._totalResultCount<t.childElementCount?s=t.childNodes.item(this._totalResultCount):(s=document.createElement("div"),t.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${e.x}px`,s.style.top=`${e.y}px`,s.style.width=`${e.width}px`,s.style.height=`${e.height}px`,s.style.display="inline-block",s.layoutResultId=e.id,s.resultState=Ys.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,this._resultIdToElementLookup.set(e.id,s);for(let i=e.firstMasterBarIndex;i<=e.lastMasterBarIndex;i++)i>=0&&this._barToElementLookup.set(i,s);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(s),this._intersectionObserver.observe(s)),this._totalResultCount++}else for(;t.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(t.lastChild),t.removeChild(t.lastElementChild)}createWorkerPlayer(){let e=null;const t="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===Sr.WebAudioAudioWorklets?(E.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),e=new yn(new th(this._api.settings),this._api.settings)):t&&(E.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),e=new yn(new tc,this._api.settings)),e?e.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):E.error("Player","Player requires webworkers and web audio api, browser unsupported",null),e}createWorkerAudioExporter(e){const t=e===null||!(e instanceof yn);return t&&(e=this.createWorkerPlayer()),new bn(e,t)}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}_highlightedElements=[];highlightElements(e,t){const s=this._barToElementLookup.get(t);if(s){const i=s.getElementsByClassName(e);for(let r=0;r<i.length;r++)i.item(r).classList.add("at-highlight"),this._highlightedElements.push(i.item(r))}}removeHighlights(){const e=this._highlightedElements;if(e){for(const t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){const e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){const e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),r=this.createScalingElement(),n=i.element;n.classList.add("at-cursor-bar");const o=r.element;return o.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",s.style.position="absolute",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),o.style.position="absolute",o.style.transition="all 0s linear",o.style.left="0",o.style.top="0",o.style.willChange="transform",r.width=3,r.height=1,r.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(s),t.appendChild(n),t.appendChild(o),new ic(new ai(t),i,r,new ai(s))}getOffset(e,t){const s=t.element,i=s.getBoundingClientRect();let r=i.top+s.ownerDocument.defaultView.pageYOffset,n=i.left+s.ownerDocument.defaultView.pageXOffset;if(e){const l=e.element,h=l.nodeName.toLowerCase();if(h!=="html"&&h!=="body"){const c=this.getOffset(null,e);r=r+l.scrollTop-c.y,n=n+l.scrollLeft-c.x}}const o=new Mt;return o.x=n,o.y=r,o.w=i.width,o.h=i.height,o}_scrollContainer=null;getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let e=typeof this._api.settings.player.scrollElement=="string"?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement;const t=e.nodeName.toLowerCase();return(t==="html"||t==="body")&&("scrollingElement"in document?e=document.scrollingElement:navigator.userAgent.indexOf("WebKit")!==-1?e=document.body:e=document.documentElement),this._scrollContainer=new ai(e),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const e=document.createElement("div");e.style.position="absolute";const t=new rc(e,100,100);return t.width=1,t.height=1,t.setBounds(0,0,1,1),t}scrollToY(e,t,s){this._internalScrollToY(e.element,t,s)}scrollToX(e,t,s){this._internalScrollToX(e.element,t,s)}_internalScrollToY(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({top:t,behavior:"smooth"});else{const i=e.scrollTop,r=t-i;let n=0;const o=l=>{n===0&&(n=l);const h=l-n,c=Math.min(h/s,1);e.scrollTop=i+r*c|0,h<s&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}_internalScrollToX(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({left:t,behavior:"smooth"});else{const i=e.scrollLeft,r=t-i;let n=0;const o=l=>{n===0&&(n=l);const h=l-n,c=Math.min(h/s,1);e.scrollLeft=i+r*c|0,h<s&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}createBackingTrackPlayer(){return new Ho(new ac,this._api.settings.player.bufferTimeInMilliseconds)}}class nc{loaded;total;constructor(e,t){this.loaded=e,this.total=t}}class _n extends ec{constructor(e,t){super(new Wi(e),t)}tex(e,t){const s=this.uiFacade;super.tex(e,s.parseTracks(t))}print(e,t=null){const s=window.open("","","width=0,height=0"),i=s.document.createElement("div");e?i.style.width=e:this.settings.display.layoutMode===$s.Horizontal?i.style.width="297mm":i.style.width="210mm",s.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `);const r=this.score;r&&(r.artist&&r.title?s.document.title=`${r.title} - ${r.artist}`:r.title&&(s.document.title=`${r.title}`)),s.document.body.appendChild(i);const n=typeof window.screenLeft<"u"?window.screenLeft:window.left,o=typeof window.screenTop<"u"?window.screenTop:window.top,l="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,h="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,c=i.offsetWidth+50,d=window.innerHeight,f=(l/2|0)-(c/2|0)+n,p=(h/2|0)-(d/2|0)+o;s.resizeTo(c,d),s.moveTo(f,p),s.focus();const g=yt.jsObjectToSettings(yt.settingsToJsObject(this.settings));g.core.enableLazyLoading=!1,g.core.useWorkers=!0,g.core.file=null,g.core.tracks=null,g.player.enableCursor=!1,g.player.playerMode=Yt.Disabled,g.player.enableElementHighlighting=!1,g.player.enableUserInteraction=!1,g.player.soundFont=null,g.display.scale=.8,g.display.stretchForce=.8,bi.fromJson(g,t);const m=new _n(i,g);s.onunload=()=>{m.destroy()},m.renderer.postRenderFinished.on(()=>{s.print()}),m.renderTracks(this.tracks)}downloadMidi(e=Zi.SingleTrackMultiChannel){if(!this.score)return;const t=new Ks;t.format=e;const s=new Fs(t,!0);new we(this.score,this.settings,s).generate();const r=t.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",o=document.createElement("a");o.download=n;const l=new Blob([r],{type:"audio/midi"}),h=URL.createObjectURL(l);o.href=h,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}changeTrackMute(e,t){const s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(s,t)}changeTrackSolo(e,t){const s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(s,t)}changeTrackVolume(e,t){const s=this._trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(s,t)}_trackIndexesToTracks(e){if(!this.score)return[];const t=[];if(e.length===1&&e[0]===-1)for(const s of this.score.tracks)t.push(s);else for(const s of e)s>=0&&s<this.score.tracks.length&&t.push(this.score.tracks[s]);return t}soundFontLoad=new ge;loadSoundFontFromUrl(e,t){const s=this.player;if(!s)return;E.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);const i=new XMLHttpRequest;i.open("GET",e,!0,null,null),i.responseType="arraybuffer",i.onload=r=>{const n=new Uint8Array(i.response);this.loadSoundFont(n,t)},i.onerror=r=>{E.error("AlphaSynth",`Loading failed: ${r.message}`),s.soundFontLoadFailed.trigger(new Ri(r.message,i))},i.onprogress=r=>{E.debug("AlphaSynth",`Soundfont downloading: ${r.loaded}/${r.total} bytes`);const n=new nc(r.loaded,r.total);this.soundFontLoad.trigger(n),this.uiFacade.triggerEvent(this.container,"soundFontLoad",n)},i.send()}}class Uo{exec(e,t,s){if(typeof t!="string"&&(s=[t],t="init"),t.charCodeAt(0)===95||t==="exec")return null;const i=new jQuery(e),r=i.data("alphaTab");if(t==="destroy"&&!r)return null;if(t!=="init"&&!r)throw new Error("alphaTab not initialized");const n=this[t];if(n){const o=[i,r].concat(s);return n.apply(this,o)}return E.error("Api",`Method '${t}' does not exist on jQuery.alphaTab`),null}init(e,t,s){if(!t){t=new _n(e[0],s),e.data("alphaTab",t);for(const i of this._initListeners)i(e,t,s)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,s,i){t.print(s,i)}load(e,t,s,i){return t.load(s,i)}render(e,t){t.render()}renderScore(e,t,s,i){t.renderScore(s,i)}renderTracks(e,t,s){t.renderTracks(s)}invalidate(e,t){t.render()}tex(e,t,s,i){t.tex(s,i)}muteTrack(e,t,s,i){t.changeTrackMute(s,i)}soloTrack(e,t,s,i){t.changeTrackSolo(s,i)}trackVolume(e,t,s,i){t.changeTrackVolume(s,i)}loadSoundFont(e,t,s,i){t.loadSoundFont(s,i)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,s){return typeof s=="number"&&(t.masterVolume=s),t.masterVolume}metronomeVolume(e,t,s){return typeof s=="number"&&(t.metronomeVolume=s),t.metronomeVolume}countInVolume(e,t,s){return typeof s=="number"&&(t.countInVolume=s),t.countInVolume}midiEventsPlayedFilter(e,t,s){return Array.isArray(s)&&(t.midiEventsPlayedFilter=s),t.midiEventsPlayedFilter}playbackSpeed(e,t,s){return typeof s=="number"&&(t.playbackSpeed=s),t.playbackSpeed}tickPosition(e,t,s){return typeof s=="number"&&(t.tickPosition=s),t.tickPosition}timePosition(e,t,s){return typeof s=="number"&&(t.timePosition=s),t.timePosition}loop(e,t,s){return typeof s=="boolean"&&(t.isLooping=s),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_initListeners=[];_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}function oc(a,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var s,i;if(s===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=e[Symbol.dispose]}if(typeof s!="function")throw new TypeError("Object not disposable.");i&&(s=function(){try{i.call(this)}catch(r){return Promise.reject(r)}}),a.stack.push({value:e,dispose:s,async:t})}return e}var lc=typeof SuppressedError=="function"?SuppressedError:function(a,e,t){var s=new Error(t);return s.name="SuppressedError",s.error=a,s.suppressed=e,s};function hc(a){function e(r){a.error=a.hasError?new lc(r,a.error,"An error was suppressed during disposal."):r,a.hasError=!0}var t,s=0;function i(){for(;t=a.stack.pop();)try{if(!t.async&&s===1)return s=0,a.stack.push(t),Promise.resolve().then(i);if(t.dispose){var r=t.dispose.call(t.value);if(t.async)return s|=2,Promise.resolve(r).then(i,function(n){return e(n),i()})}else s|=1}catch(n){e(n)}if(s===1)return a.hasError?Promise.reject(a.error):Promise.resolve();if(a.hasError)throw a.error}return i()}class it{static _alphaSkia;static _defaultMusicTextStyle=null;static enable(e,t){it._alphaSkia=t,it.initializeMusicFont(it._alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){it._defaultMusicTextStyle=new it._alphaSkia.AlphaSkiaTextStyle([e.familyName],e.weight,e.isItalic)}static registerFont(e,t){const s=it._alphaSkia.AlphaSkiaTypeface.register(e.buffer);return t||(t=pe.withFamilyList([s.familyName],12,s.isItalic?st.Italic:st.Plain,s.weight>400?ts.Bold:ts.Regular)),t}_canvas;_color=new Ce(0,0,0,0);_lineWidth=0;_textStyle=null;_scale=1;_textStyles=new Map;_font=new pe("Arial",10,st.Plain);_musicTextStyle=null;settings;get font(){return this._font}set font(e){if(this._font===e)return;this._font=e;const t=this._textStyleKey(e);if(this._textStyles.has(t))this._textStyle=this._textStyles.get(t);else{const s=new it._alphaSkia.AlphaSkiaTextStyle(e.families,e.weight===ts.Bold?700:400,e.isItalic);this._textStyles.set(t,s),this._textStyle=s}}_textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}constructor(){this._canvas=new it._alphaSkia.AlphaSkiaCanvas,this.color=new Ce(0,0,0,255)}destroy(){this._canvas[Symbol.dispose]();for(const e of this._textStyles.values())e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(e,t){this._scale=this.settings.display.scale,this._canvas.beginRender(e,t,F.highDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==it._defaultMusicTextStyle.familyNames[0]?this._textStyles.has(s)?this._musicTextStyle=this._textStyles.get(s):(this._musicTextStyle=new it._alphaSkia.AlphaSkiaTextStyle([s],it._defaultMusicTextStyle.weight,it._defaultMusicTextStyle.isItalic),this._textStyles.set(s,this._musicTextStyle)):this._musicTextStyle=it._defaultMusicTextStyle}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=it._alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,s,i){s>0&&this._canvas.fillRect(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}strokeRect(e,t,s,i){const r=this.lineWidth%2===0?0:.5;this._canvas.strokeRect(e*this._scale+r,t*this._scale+r,s*this._scale,i*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e*this._scale,t*this._scale)}lineTo(e,t){this._canvas.lineTo(e*this._scale,t*this._scale)}quadraticCurveTo(e,t,s,i){this._canvas.quadraticCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}bezierCurveTo(e,t,s,i,r,n){this._canvas.bezierCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale,r*this._scale,n*this._scale)}fillCircle(e,t,s){this._canvas.fillCircle(e*this._scale,t*this._scale,s*this._scale)}strokeCircle(e,t,s){this._canvas.strokeCircle(e*this._scale,t*this._scale,s*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}textAlign=X.Left;textBaseline=Re.Top;beginGroup(e){}endGroup(){}fillText(e,t,s){if(e.length===0)return;let i=it._alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case X.Left:i=it._alphaSkia.AlphaSkiaTextAlign.Left;break;case X.Center:i=it._alphaSkia.AlphaSkiaTextAlign.Center;break;case X.Right:i=it._alphaSkia.AlphaSkiaTextAlign.Right;break}let r=it._alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case Re.Top:r=it._alphaSkia.AlphaSkiaTextBaseline.Top;break;case Re.Middle:r=it._alphaSkia.AlphaSkiaTextBaseline.Middle;break;case Re.Bottom:r=it._alphaSkia.AlphaSkiaTextBaseline.Bottom;break;case Re.Alphabetic:r=it._alphaSkia.AlphaSkiaTextBaseline.Alphabetic;break}this._canvas.fillText(e,this._textStyle,this._font.size*this._scale,t*this._scale,s*this._scale,i,r)}measureText(e){const t={stack:[],error:void 0,hasError:!1};try{const s=oc(t,this._canvas.measureText(e,this._textStyle,this._font.size,it._alphaSkia.AlphaSkiaTextAlign.Left,it._alphaSkia.AlphaSkiaTextBaseline.Alphabetic),!1),[i,r]=this._getTextWidthAndHeight(s,e);return new Yr(i,r)}catch(s){t.error=s,t.hasError=!0}finally{hc(t)}}_getTextWidthAndHeight(e,t){let s=e.width;if(t.length>0&&s<1)for(let r=0;r<5&&(s=e.width,!(s>1));r++);const i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;return[s,i]}fillMusicFontSymbol(e,t,s,i,r){i!==u.None&&this._fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),r)}fillMusicFontSymbols(e,t,s,i,r){let n="";for(const o of i)o!==u.None&&(n+=String.fromCharCode(o));this._fillMusicFontSymbolText(e,t,s,n,r)}_fillMusicFontSymbolText(e,t,s,i,r){this._canvas.fillText(i,this._musicTextStyle,this.settings.display.resources.engravingSettings.musicFontSize*this._scale*s,e*this._scale,t*this._scale,r?it._alphaSkia.AlphaSkiaTextAlign.Center:it._alphaSkia.AlphaSkiaTextAlign.Left,it._alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,s){this._canvas.beginRotate(e*this._scale,t*this._scale,s)}endRotate(){this._canvas.endRotate()}}class Sn{buffer="";_currentPath="";_currentPathIsEmpty=!0;scale=1;color=new Ce(255,255,255,255);lineWidth=1;font=new pe("Arial",10,st.Plain);textAlign=X.Left;textBaseline=Re.Top;settings;destroy(){}beginRender(e,t){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${e|0}px" height="${t|0}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=Re.Top}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,s,i){s>0&&(this.buffer+=`<rect x="${e*this.scale}" y="${t*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />
`)}strokeRect(e,t,s,i){const r=this.lineWidth*this.scale%2===0?0:.5;this.buffer+=`<rect x="${e*this.scale+r}" y="${t*this.scale+r}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,this.lineWidth!==1&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=` fill="transparent" />
`}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e*this.scale},${t*this.scale}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e*this.scale},${t*this.scale}`}quadraticCurveTo(e,t,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(e,t,s,i,r,n){this._currentPathIsEmpty=!1,this._currentPath+=` C${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale},${r*this.scale},${n*this.scale}`}fillCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.fill()}strokeCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;(this.lineWidth!==1||this.scale!==1)&&(e+=` stroke-width="${this.lineWidth*this.scale}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(e,t,s){if(e==="")return;let i=`<text x="${t*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;this.color.rgba!=="#000000"&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==X.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${Sn._escapeText(e)}</text>`,this.buffer+=i}static _escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case X.Left:return"start";case X.Center:return"middle";case X.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case Re.Top:return"dominant-baseline: hanging";case Re.Bottom:return"dominant-baseline: ideographic";case Re.Alphabetic:return"";case Re.Middle:return"dominant-baseline: middle";default:return""}}measureText(e){return e?ds.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):new Yr(0,0)}onRenderFinished(){return null}beginRotate(e,t,s){this.buffer+=`<g transform="translate(${e*this.scale} ,${t*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class cc extends Sn{fillMusicFontSymbol(e,t,s,i,r){i!==u.None&&this._fillMusicFontSymbolText(e,t,s,`&#${i};`,r)}fillMusicFontSymbols(e,t,s,i,r){let n="";for(const o of i)o!==u.None&&(n+=`&#${o};`);this._fillMusicFontSymbolText(e,t,s,n,r)}_fillMusicFontSymbolText(e,t,s,i,r){e*=this.scale,t*=this.scale,this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`;const n=this.scale*s;n!==1?this.buffer+=` style="font-size: ${n*100}%; stroke:none"`:this.buffer+=' style="stroke:none"',this.color.rgba!=="#000000"&&(this.buffer+=` fill="${this.color.rgba}"`),r&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(X.Center)}"`),this.buffer+=`>${i}</text></g>`}}class vr{isInsideBracket=!0;isRelevantForBoundsLookup=!0;hideOnMultiTrack=!1;hideOnPercussionTrack=!1;canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}var me;(function(a){a[a.PreNotes=0]="PreNotes",a[a.OnNotes=1]="OnNotes",a[a.MiddleNotes=2]="MiddleNotes",a[a.Stem=3]="Stem",a[a.PostNotes=4]="PostNotes",a[a.EndBeat=5]="EndBeat"})(me||(me={}));class Ms extends ot{glyphs=null;get isEmpty(){return!this.glyphs||this.glyphs.length===0}getBoundingBoxTop(){let e=0;const t=this.glyphs;if(t)for(const s of t){const i=s.getBoundingBoxTop();i<e&&(e=i)}return e}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}let e=0,t=0;for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s];r.renderer=this.renderer,r.doLayout(),e=Math.max(e,r.width),t=Math.max(t,r.y+r.height)}this.width=e,this.height=t}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,s){const i=this.glyphs;if(!(!i||i.length===0))for(const r of i)r.paint(e+this.x,t+this.y,s)}}class Oi extends Ms{gap=0;constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width+this.gap,super.addGlyph(e)}}class Se{static score(e,t,s,i=!1){if(!s.style&&!i)return;const r=Se._scoreDefaultColor(e.settings.display.resources,t);return new nr(e,t,s.style,r)}static scoreColor(e,t,s){const i=Se._scoreDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static _scoreDefaultColor(e,t){return e.mainGlyphColor}static bar(e,t,s,i=!1){if(!s.style&&!i)return;let r=e.settings.display.resources.mainGlyphColor;switch(t){case Pe.StandardNotationRepeats:case Pe.GuitarTabsRepeats:case Pe.SlashRepeats:case Pe.NumberedRepeats:case Pe.StandardNotationClef:case Pe.GuitarTabsClef:case Pe.StandardNotationKeySignature:case Pe.NumberedKeySignature:case Pe.StandardNotationTimeSignature:case Pe.GuitarTabsTimeSignature:case Pe.SlashTimeSignature:case Pe.NumberedTimeSignature:break;case Pe.StandardNotationBarLines:case Pe.GuitarTabsBarLines:case Pe.SlashBarLines:case Pe.NumberedBarLines:r=e.settings.display.resources.barSeparatorColor;break;case Pe.StandardNotationBarNumber:case Pe.SlashBarNumber:case Pe.NumberedBarNumber:case Pe.GuitarTabsBarNumber:r=e.settings.display.resources.barNumberColor;break;case Pe.StandardNotationStaffLine:case Pe.GuitarTabsStaffLine:case Pe.SlashStaffLine:case Pe.NumberedStaffLine:r=e.settings.display.resources.staffLineColor;break}return new nr(e,t,s.style,r)}static voice(e,t,s,i=!1){if(!s.style&&!i)return;const r=s.index===0?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new nr(e,t,s.style,r)}static trackColor(e,t,s){const i=Se._trackDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static _trackDefaultColor(e,t){let s=e.mainGlyphColor;switch(t){case Hs.TrackName:case Hs.SystemSeparator:case Hs.StringTuning:break;case Hs.BracesAndBrackets:s=e.barSeparatorColor;break}return s}static track(e,t,s,i=!1){if(!s.style&&!i)return;const r=Se._trackDefaultColor(e.settings.display.resources,t);return new nr(e,t,s.style,r)}static beatColor(e,t,s){const i=Se._beatDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static _beatDefaultColor(e,t,s){return s.voice.index===0?e.mainGlyphColor:e.secondaryGlyphColor}static beat(e,t,s,i=!1){if(!s.style&&!i)return;const r=Se._beatDefaultColor(e.settings.display.resources,t,s);return new nr(e,t,s.style,r)}static noteColor(e,t,s){const i=Se._noteDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static _noteDefaultColor(e,t,s){return s.beat.voice.index===0?e.mainGlyphColor:e.secondaryGlyphColor}static note(e,t,s,i=!1){if(!s.style&&!i)return;const r=s.beat.voice.index===0?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new nr(e,t,s.style,r)}}class nr{_canvas;_previousColor;constructor(e,t,s,i){this._canvas=e,s&&s.colors.has(t)?(this._previousColor=e.color,e.color=s.colors.get(t)??i):s||(this._previousColor=e.color,e.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}}class dc extends Ms{static KeySizeBeat="Beat";beatGlyphs;voice;tupletGroups;constructor(e,t,s){super(e,t),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){const t=this.renderer.layoutingInfo.spaceToForce(e);this._scaleToForce(t)}_scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);const t=this.renderer.layoutingInfo.buildOnTimePositions(e),s=this.beatGlyphs;for(let i=0,r=s.length;i<r;i++){const n=s[i];switch(n.beat.graceType){case $.None:n.x=t.get(n.beat.absoluteDisplayStart)-n.onTimeX;break;default:const o=n.beat.graceGroup.beats[0].absoluteDisplayStart,l=n.beat.graceGroup.id;if(n.beat.graceGroup.isComplete&&t.has(o)){n.x=t.get(o)-n.onTimeX;const h=this.renderer.layoutingInfo.allGraceRods.get(l),c=n.beat.graceGroup.beats[n.beat.graceGroup.beats.length-1].nextBeat,d=c?this.renderer.layoutingInfo.getPreBeatSize(c):0;n.x-=d,n.x-=h[n.beat.graceIndex].postSpringWidth,n.x+=h[n.beat.graceIndex].graceBeatWidth;const f=h[n.beat.graceGroup.beats.length-1];n.x-=f.graceBeatWidth}else{const h=this.renderer.layoutingInfo.incompleteGraceRods.get(l),c=h[n.beat.graceIndex].postSpringWidth-h[n.beat.graceIndex].preSpringWidth;i>0?n.beat.graceIndex===0?n.x=s[i-1].x+s[i-1].width:n.x=s[i-1].x+h[n.beat.graceIndex-1].postSpringWidth-h[n.beat.graceIndex-1].preSpringWidth-c:n.x=-c}break}if(i>0){const o=n.x-s[i-1].x;s[i-1].scaleToWidth(o)}if(i===r-1){const o=this.width-s[s.length-1].x;n.scaleToWidth(o)}}}registerLayoutingInfo(e){const t=this.beatGlyphs;for(const s of t)s.registerLayoutingInfo(e)}applyLayoutingInfo(e){const t=this.beatGlyphs;for(const s of t)s.applyLayoutingInfo(e);this._scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){const t=e;e.x=this.beatGlyphs.length===0?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(e,t,s){const i=Se.voice(s,lr.Glyphs,this.voice,!0);try{for(let r=0,n=this.beatGlyphs.length;r<n;r++)this.beatGlyphs[r].paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class uc{staffId="";up=0;down=0}class fc{startBeat=null;startX=0;startY=0;endBeat=null;endX=0;endY=0;calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}}class As{_staff;_beatLineXPositions=new Map;_renderer;_firstNonRestBeat=null;_lastNonRestBeat=null;voice=null;beats=[];shortestDuration=y.QuadrupleWhole;tremoloDuration;hasTuplet=!1;slashBeats=[];lowestNoteInHelper=null;_lowestNoteCompareValueInHelper=-1;highestNoteInHelper=null;_highestNoteCompareValueInHelper=-1;invertBeamDirection=!1;preferredBeamDirection=null;graceType=$.None;minRestLine=null;beatOfMinRestLine=null;maxRestLine=null;beatOfMaxRestLine=null;get isRestBeamHelper(){return this.beats.length===1&&this.beats[0].isRest}hasLine(e,t){return e&&this._beatHasLine(t)||!e&&this.beats.length===1&&this._beatHasLine(t)}_beatHasLine(e){return e.duration>y.Whole}hasFlag(e,t){return e&&this._beatHasFlag(t)||!e&&this.beats.length===1&&this._beatHasFlag(this.beats[0])}_beatHasFlag(e){return!e.deadSlapped&&!e.isRest&&(e.duration>y.Quarter||e.graceType!==$.None)}constructor(e,t){this._staff=e,this._renderer=t,this.beats=[]}getBeatLineX(e,t){return t=t??this.direction,this.hasBeatLineX(e)?t===P.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,s,i){const r=this._getOrCreateBeatPositions(t);r.staffId=e,r.up=s,r.down=i;for(const n of this.drawingInfos.values())n.startBeat===t?n.startX=this.getBeatLineX(t):n.endBeat===t&&(n.endX=this.getBeatLineX(t))}_getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new uc),this._beatLineXPositions.get(e.index)}direction=P.Up;finish(){this.direction=this._calculateDirection(),this._renderer.completeBeamingHelper(this)}_calculateDirection(){if(!this.voice)return P.Up;if(this.preferredBeamDirection!==null)return this.preferredBeamDirection;if(this.voice.index>0)return this._invert(P.Down);if(this.voice.bar.isMultiVoice)return this._invert(P.Up);if(this.beats[0].graceType!==$.None)return this._invert(P.Up);if(this.highestNoteInHelper&&this.lowestNoteInHelper){const e=this._renderer.getNoteY(this.highestNoteInHelper,R.Center),t=this._renderer.getNoteY(this.lowestNoteInHelper,R.Center),s=(e+t)/2;return this._invert(this._renderer.middleYPosition<s?P.Up:P.Down)}return this._invert(P.Up)}static computeLineHeightsForRest(e){switch(e){case y.QuadrupleWhole:return[2,2];case y.DoubleWhole:return[2,2];case y.Whole:return[0,1];case y.Half:return[1,0];case y.Quarter:return[3,3];case y.Eighth:return[2,2];case y.Sixteenth:return[2,4];case y.ThirtySecond:return[4,4];case y.SixtyFourth:return[4,6];case y.OneHundredTwentyEighth:return[6,6];case y.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(e,t){if(this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index)return;let s=t,i=t;const r=As.computeLineHeightsForRest(e.duration);s-=r[0],i+=r[1];const n=this.minRestLine,o=this.maxRestLine;(n===null||n>s)&&(this.minRestLine=s,this.beatOfMinRestLine=e),(o===null||o<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=e)}_invert(e){if(!this.invertBeamDirection)return e;switch(e){case P.Down:return P.Up;default:return P.Down}}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if(this.beats.length===0)t=!0;else switch(this.beats[this.beats.length-1].beamingMode){case Xe.Auto:case Xe.ForceSplitOnSecondaryToNext:t=As._canJoin(this.beats[this.beats.length-1],e);break;case Xe.ForceSplitToNext:t=!1;break;case Xe.ForceMergeWithNext:t=!0;break}return t&&(this.preferredBeamDirection==null&&e.preferredBeamDirection!==null&&(this.preferredBeamDirection=e.preferredBeamDirection),e.hasTuplet&&(this.hasTuplet=!0),e.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<e.tremoloSpeed)&&(this.tremoloDuration=e.tremoloSpeed),e.graceType!==$.None&&(this.graceType=e.graceType),e.isRest?this.beats.length===0&&this.beats.push(e):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(e),this._checkNote(e.minNote),this._checkNote(e.maxNote),this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),this._firstNonRestBeat||(this._firstNonRestBeat=e),this._lastNonRestBeat=e),e.slashed&&this.slashBeats.push(e)),t}_checkNote(e){if(!e)return;let t,s;this.voice&&e.isPercussion?(t=-Rt.getPercussionLine(this.voice.bar,Rt.getNoteValue(e)),s=t):(t=Rt.getNoteValue(e),s=t,e.harmonicType!==Q.None&&e.harmonicType!==Q.Natural&&(s=e.realValue-this._staff.displayTranspositionPitch)),(!this.lowestNoteInHelper||t<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=e,this._lowestNoteCompareValueInHelper=t),(!this.highestNoteInHelper||s>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=e,this._highestNoteCompareValueInHelper=s)}static _canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||e.graceType===$.BendGrace||t.graceType===$.BendGrace||e.deadSlapped||t.deadSlapped)return!1;if(e.graceType!==$.None&&t.graceType!==$.None)return!0;const s=e.voice.bar,i=t.voice.bar;if(s!==i)return!1;const r=e.playbackStart,n=t.playbackStart;if(!As._canJoinDuration(e.duration)||!As._canJoinDuration(t.duration))return r===n;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let o=x.QuarterTime;switch(s.masterBar.timeSignatureDenominator){case 8:s.masterBar.timeSignatureNumerator%3===0&&(o+=x.QuarterTime/2|0);break}const l=(o+r)/o|0|0,h=(o+n)/o|0|0;return l===h}static _canJoinDuration(e){switch(e){case y.Whole:case y.Half:case y.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,s){return L.getIndex(e.duration)-2-s>0&&L.getIndex(t.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return this._beatLineXPositions.has(t.index)?this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId:!0}drawingInfos=new Map}class pc{topY=0;bottomY=0;constructor(e,t){this.topY=e,this.bottomY=t}}class gc{beat;topY=-1e3;bottomY=-1e3;slots=[];constructor(e){this.beat=e}addSlot(e,t){if(this.slots.push(new pc(e,t)),this.topY===-1e3)this.topY=e,this.bottomY=t;else{const s=Math.min(e,t),i=Math.max(e,t);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class mc{reservedLayoutAreasByDisplayTime=new Map;restDurationsByDisplayTime=new Map;getBeatMinMaxY(){let e=-1e3,t=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())e===-1e3?(e=s.topY,t=s.bottomY):(e>s.topY&&(e=s.topY),t<s.bottomY&&(t=s.bottomY));return e===-1e3?[0,0]:[e,t]}reserveBeatSlot(e,t,s){t!==s&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new gc(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,s),e.isRest&&this.registerRest(e))}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(e,t,s){if(e.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(e.playbackStart)){const i=As.computeLineHeightsForRest(e.duration).map(c=>c*s),r=t-i[0],n=t+i[1];let o=r;const l=this.reservedLayoutAreasByDisplayTime.get(e.playbackStart);let h=!1;for(const c of l.slots)if(r>=c.topY&&r<=c.bottomY||n>=c.topY&&n<=c.bottomY){h=!0;break}if(h){e.voice.index===1?o=l.topY-i[1]-i[0]:o=l.bottomY;const c=o+i[0]+i[1],d=s*2,f=Math.ceil(Math.abs(o-r)/d);return l.addSlot(o,c),o<r?f*-d:f*d}}return 0}}class yc{_renderer;beamHelpers=[];beamHelperLookup=[];collisionHelper;preferredBeamDirection=null;constructor(e){this._renderer=e,this.collisionHelper=new mc}initialize(){const e=this._renderer,t=this._renderer.bar;let s=null,i=null;for(let r=0,n=t.voices.length;r<n;r++){const o=t.voices[r];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let l=0,h=o.beats.length;l<h;l++){const c=o.beats[l];let d;c.graceType!==$.None?d=i:(d=s,i=null),(!d||!d.checkBeat(c))&&(d&&d.finish(),d=new As(t.staff,e),d.preferredBeamDirection=this.preferredBeamDirection,d.checkBeat(c),c.graceType!==$.None?i=d:s=d,this.beamHelpers[o.index].push(d)),this.beamHelperLookup[o.index].set(c.index,d)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}class Dr extends us{static _frets=5;_chord;_textRow=0;_fretRow=0;_firstFretSpacing=0;constructor(e,t,s){super(e,t),this._chord=s}doLayout(){super.doLayout();const e=this.renderer.resources;this._textRow=e.effectFont.size*1.5,this._fretRow=e.effectFont.size*1.5,this._chord.firstFret>1?this._firstFretSpacing=this.renderer.smuflMetrics.chordDiagramFretSpacing:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+Dr._frets*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width=this._firstFretSpacing+(this._chord.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingX}paint(e,t,s){e+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this._firstFretSpacing,t+=this.y;const i=this.renderer.smuflMetrics.chordDiagramStringSpacing,r=this.renderer.smuflMetrics.chordDiagramFretSpacing,n=this.renderer.resources,o=n.engravingSettings.chordDiagramLineWidth,l=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this._firstFretSpacing+o,h=n.engravingSettings.glyphHeights.get(u.FretboardFilledCircle),c=n.engravingSettings.glyphTop.get(u.FretboardFilledCircle),d=n.engravingSettings.glyphHeights.get(u.FretboardX)/2,f=n.engravingSettings.glyphHeights.get(u.FretboardO)/2,p=s.textAlign,g=s.textBaseline;s.font=n.effectFont,s.textAlign=X.Center,s.textBaseline=Re.Top,this._chord.showName&&s.fillText(this._chord.name,e+l/2,t+n.effectFont.size/2),t+=this._textRow,s.font=n.fretboardNumberFont,s.textBaseline=Re.Middle;for(let b=0;b<this._chord.strings.length;b++){const S=e+b*i,T=t+this._fretRow/2;let C=this._chord.strings[this._chord.strings.length-b-1];C<0?rt.fillMusicFontSymbolSafe(s,S,T+d,1,u.FretboardX,!0):C===0?rt.fillMusicFontSymbolSafe(s,S,T+f,1,u.FretboardO,!0):(C-=this._chord.firstFret-1,s.fillText(C.toString(),S,T))}t+=this._fretRow;for(let b=0;b<this._chord.strings.length;b++){const S=e+b*i;s.fillRect(S,t,o,r*Dr._frets+1)}this._chord.firstFret>1?(s.textAlign=X.Left,s.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,t+r/2),s.fillRect(e,t,l,o)):s.fillRect(e,t-this.renderer.smuflMetrics.chordDiagramNutHeight/2,l,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let b=0;b<=Dr._frets;b++){const S=t+b*r;s.fillRect(e,S,l,this.renderer.smuflMetrics.chordDiagramFretHeight)}const m=new Map;for(const b of this._chord.barreFrets){const S=[-1,-1];m.set(b-this._chord.firstFret,S)}for(let b=0;b<this._chord.strings.length;b++){let S=this._chord.strings[b];if(S>0){if(S-=this._chord.firstFret,m.has(S)){const v=m.get(S);(v[0]===-1||b<v[0])&&(v[0]=b),(v[1]===-1||b>v[1])&&(v[1]=b)}const T=t+S*r+r/2+.5,C=e+(this._chord.strings.length-b-1)*i+o/2;rt.fillMusicFontSymbolSafe(s,C,T+c-h/2,1,u.FretboardFilledCircle,!0)}}for(const[b,S]of m){const T=t+b*r+r/2+.5,C=e+(this._chord.strings.length-S[1]-1)*i,v=e+(this._chord.strings.length-S[0]-1)*i;s.fillRect(C,T-h/2,v-C,h)}s.textAlign=p,s.textBaseline=g}}class zo extends Ms{_glyphWidth=0;_align;constructor(e,t,s=X.Center){super(e,t),this.glyphs=[],this._align=s}doLayout(){const e=this.renderer.smuflMetrics.rowContainerGap,t=this._glyphWidth-e;let s=0;switch(this._align){case X.Left:s=0;break;case X.Center:s=(this.width-t)/2;break;case X.Right:s=this.width-t;break}for(const i of this.glyphs)i.x=s,s+=i.width+e}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width+this.renderer.smuflMetrics.rowContainerGap,e.height>this.height&&(this.height=e.height)}}class Yo extends Ms{_rows=[];_align;constructor(e,t,s=X.Center){super(e,t),this.height=0,this.glyphs=[],this._align=s}doLayout(){let e=0,t=0;const s=this.renderer.smuflMetrics.rowContainerGap;this._rows=[];let i=new zo(e,t,this._align);i.renderer=this.renderer,i.width=this.width;for(const r of this.glyphs){const n=e+r.width+s;n<this.width?(i.addGlyphToRow(r),e=Math.ceil(n)):(i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),e=0,i=new zo(e,t,this._align),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(r),e+=Math.ceil(r.width+s))}i.isEmpty||(i.doLayout(),this._rows.push(i),t+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=t}paint(e,t,s){for(const i of this._rows)i.paint(e+this.x,t+this.y,s)}}class bc extends Yo{addChord(e){if(e.strings.length>0){const t=new Dr(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}paint(e,t,s){if(this.glyphs.length>0){const i=Se.score(s,O.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}}class bs extends us{_lines;_lineHeights=null;font;textAlign;textBaseline;colorOverride;constructor(e,t,s,i,r=X.Left,n=null,o){super(e,t),this._lines=s.split(`
`),this.font=i,this.textAlign=r,this.textBaseline=n,this.colorOverride=o}doLayout(){super.doLayout(),this._lineHeights=[];const e=this.renderer.scoreRenderer.canvas;for(const t of this._lines){e.font=this.font;const s=e.measureText(t),i=s.height;this._lineHeights.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(e,t,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const r=s.textAlign,n=s.textBaseline;s.textAlign=this.textAlign,this.textBaseline!==null&&(s.textBaseline=this.textBaseline);let o=t+this.y;for(let l=0;l<this._lines.length;l++)s.fillText(this._lines[l],e+this.x,o),o+=this._lineHeights[l];s.textAlign=r,s.textBaseline=n,s.color=i}}class _c{_factory;_sharedLayoutData=new Map;staffTrackGroup;system;barRenderers=[];x=0;y=0;height=0;index=0;staffIndex=0;isFirstInSystem=!1;trackIndex=0;modelStaff;get staffId(){return this._factory.staffId}staveTop=0;topSpacing=0;bottomSpacing=0;staveBottom=0;get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(e,t,s){this._factory=s,this.trackIndex=e,this.modelStaff=t}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staffId,e)}addBar(e,t,s){const i=this._factory.create(this.system.layout.renderer,e);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo();const r=i.barDisplayWidth;r>0&&this.system.layout.systemsLayoutMode===fs.FromModelWithWidths&&(i.width=r),this.barRenderers.push(i),e&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){const e=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,e);for(const t of this.barRenderers)t.applyLayoutingInfo();return e}scaleToWidth(e){this._sharedLayoutData=new Map;const t=this.topOverflow;let s=0;switch(this.system.layout.systemsLayoutMode){case fs.Automatic:const r=(e-this.system.computedWidth)/this.barRenderers.length;for(const o of this.barRenderers){o.x=s,o.y=this.topSpacing+t;const l=o.computedWidth+r;o.scaleToWidth(l),s+=o.width}break;case fs.FromModelWithScale:e-=this.system.accoladeWidth;const n=this.system.totalBarDisplayScale;for(const o of this.barRenderers){o.x=s,o.y=this.topSpacing+t;const l=o.barDisplayScale*e/n;o.scaleToWidth(l),s+=o.width}break;case fs.FromModelWithWidths:for(const o of this.barRenderers){o.x=s,o.y=this.topSpacing+t;const l=o.barDisplayWidth;l>0?o.scaleToWidth(l):o.scaleToWidth(o.computedWidth),s+=o.width}break}}get topOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){const i=this.barRenderers[t];i.topOverflow>e&&(e=i.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){const i=this.barRenderers[t];i.bottomOverflow>e&&(e=i.bottomOverflow)}return e}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let e=!1,t=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+t,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(e=!0);if(e){t=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+t;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+t+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(e,t,s,i,r){if(!(this.height===0||r===0))for(let n=i,o=Math.min(i+r,this.barRenderers.length);n<o;n++)this.barRenderers[n].paint(e+this.x,t+this.y,s)}}class Xo{timePosition=0;longestDuration=0;smallestDuration=0;force=0;springConstant=0;get springWidth(){return this.preSpringWidth+this.postSpringWidth}preBeatWidth=0;graceBeatWidth=0;postSpringWidth=0;get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}allDurations=new Set}class Aa{static _defaultMinDuration=30;static _defaultMinDurationWidth=7;_timeSortedSprings=[];_minTime=-1;_onTimePositionsForce=0;_onTimePositions=new Map;_incompleteGraceRodsWidth=0;_minDuration=Aa._defaultMinDuration;version=0;preBeatSize=0;postBeatSize=0;minStretchForce=0;totalSpringConstant=0;_updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){if(e.graceType!==$.None){const s=e.graceGroup.id;return this.allGraceRods.get(s)[e.graceIndex].preBeatWidth}const t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).preBeatWidth:0}getPostBeatSize(e){if(e.graceType!==$.None){const s=e.graceGroup.id;return this.allGraceRods.get(s)[e.graceIndex].postSpringWidth}const t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).postSpringWidth:0}incompleteGraceRods=new Map;allGraceRods=new Map;springs=new Map;addSpring(e,t,s,i,r){this.version++;let n;if(this.springs.has(e))n=this.springs.get(e),n.postSpringWidth<r&&(n.postSpringWidth=r),n.graceBeatWidth<s&&(n.graceBeatWidth=s),n.preBeatWidth<i&&(n.preBeatWidth=i),t<n.smallestDuration&&(n.smallestDuration=t),t>n.longestDuration&&(n.longestDuration=t),n.allDurations.add(t);else{if(n=new Xo,n.timePosition=e,n.allDurations.add(t),this._timeSortedSprings.length>0){const h=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const c of h.allDurations)h.timePosition+c;t<this._minDuration&&(this._minDuration=t)}n.longestDuration=t,n.postSpringWidth=r,n.graceBeatWidth=s,n.preBeatWidth=i,this.springs.set(e,n);const o=this._timeSortedSprings;let l=o.length-1;for(;l>0&&o[l].timePosition>e;)l--;this._timeSortedSprings.splice(l+1,0,n)}return(this._minTime===-1||this._minTime>e)&&(this._minTime=e),n}addBeatSpring(e,t,s){const i=e.absoluteDisplayStart;if(e.graceType!==$.None){const r=e.graceGroup.id;this.allGraceRods.has(r)||this.allGraceRods.set(r,new Array(e.graceGroup.beats.length)),!e.graceGroup.isComplete&&!this.incompleteGraceRods.has(r)&&this.incompleteGraceRods.set(r,new Array(e.graceGroup.beats.length));const n=this.allGraceRods.get(r)[e.graceIndex];if(n)n.postSpringWidth<s&&(n.postSpringWidth=s),n.preBeatWidth<t&&(n.preBeatWidth=t);else{const o=new Xo;o.timePosition=i,o.postSpringWidth=s,o.preBeatWidth=t,e.graceGroup.isComplete||(this.incompleteGraceRods.get(r)[e.graceIndex]=o),this.allGraceRods.get(r)[e.graceIndex]=o}}else{let r=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(const n of this.allGraceRods.get(e.graceGroup.id))r+=n.springWidth;this.addSpring(i,e.displayDuration,r,t,s)}}finish(){for(const[e,t]of this.allGraceRods){let s=0;for(const i of t)s+=i.preBeatWidth,i.graceBeatWidth=s,s+=i.postSpringWidth}this._incompleteGraceRodsWidth=0;for(const e of this.incompleteGraceRods.values())for(const t of e)this._incompleteGraceRodsWidth+=t.preBeatWidth+t.postSpringWidth;this._calculateSpringConstants(),this.version++}_calculateSpringConstants(){let e=0;const t=this._timeSortedSprings;if(t.length===0){this.totalSpringConstant=-1,this.minStretchForce=-1;return}for(let s=0;s<t.length;s++){const i=t[s];let r=0;if(s===t.length-1)r=i.longestDuration;else{const n=t[s+1];r=Math.abs(n.timePosition-i.timePosition)}i.springConstant=this._calculateSpringConstant(i,r),e+=1/i.springConstant}this.totalSpringConstant=1/e,this.minStretchForce=0;for(let s=0;s<t.length;s++){const i=t[s];let r=0;if(s===t.length-1)r=i.postSpringWidth;else{const o=t[s+1];r=i.postSpringWidth+o.preSpringWidth}s===0&&(r+=i.preSpringWidth);const n=r*i.springConstant;this._updateMinStretchForce(n)}}height=0;paint(e,t,s){}_calculateSpringConstant(e,t){t<=0&&(t=x.toTicks(y.TwoHundredFiftySixth)),e.smallestDuration===0&&(e.smallestDuration=t);const s=e.smallestDuration,i=this._minDuration,r=Aa._defaultMinDurationWidth,n=1+.85*Math.log2(t/i);return s/t*(1/(n*r))}spaceToForce(e){return this.totalSpringConstant!==-1?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return this.totalSpringConstant!==-1&&(t=this._calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth,t}_calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(this.totalSpringConstant===-1)return new Map;if(L.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;const t=new Map;this._onTimePositions=t;const s=this._timeSortedSprings;if(s.length===0)return t;let i=s[0].preSpringWidth;for(let r=0;r<s.length;r++)t.set(s[r].timePosition,i),i+=this._calculateWidth(e,s[r].springConstant);return t}}class Sc{width=0;isLinkedToPrevious=!1;canWrap=!0;masterBar;additionalMultiBarRestIndexes=null;get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}renderers=[];layoutingInfo}class kc{track;staffSystem;staves=[];stavesRelevantForBoundsLookup=[];firstStaffInBracket=null;lastStaffInBracket=null;bracket=null;constructor(e,t){this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class wc{firstStaffInBracket=null;lastStaffInBracket=null;drawAsBrace=!1;braceScale=1;width=0;index=0;finalizeBracket(e){if(this.firstStaffInBracket===this.lastStaffInBracket){this.width=0;return}const t=e.glyphHeights.get(u.Brace),s=e.glyphWidths.get(u.Brace);if(this.drawAsBrace?this.width=s:this.width=e.bracketThickness,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;const i=this.firstStaffInBracket.contentTop,o=(this.lastStaffInBracket.contentBottom-i)/t;this.braceScale=o,this.width=s*this.braceScale}}class Ia extends wc{track;constructor(e){super(),this.track=e,this.drawAsBrace=Ia.isTrackDrawAsBrace(e)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return e.staves.filter(t=>t.showStandardNotation).length>1}}class Bc extends Ia{includesStaff(e){return e.modelStaff.track===this.track?!0:this.drawAsBrace?!1:this.track.playbackInfo.program===e.modelStaff.track.playbackInfo.program}}class Tc{_allStaves=[];_firstStaffInBrackets=null;_lastStaffInBrackets=null;_accoladeSpacingCalculated=!1;_brackets=[];_hasSystemSeparator=!1;x=0;y=0;index=0;accoladeWidth=0;isFull=!1;width=0;computedWidth=0;totalBarDisplayScale=0;isLast=!1;masterBarsRenderers=[];staves=[];layout;topPadding;bottomPadding;constructor(e){this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,t){if(e.length===0)return null;this.masterBarsRenderers.push(t),t.layoutingInfo.preBeatSize=0;let s=0;for(let i=0,r=this.staves.length;i<r;i++){const n=this.staves[i];for(let o=0,l=n.staves.length;o<l;o++){const h=n.staves[o],c=t.renderers[s++];h.addBarRenderer(c)}}return this._calculateAccoladeSpacing(e),this._updateWidthFromLastBar(),t}addBars(e,t,s){const i=new Sc;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new Aa,i.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(i);const r=i.layoutingInfo;for(const n of this.staves)for(const o of n.staves){const l=n.track.staves[o.modelStaff.index].bars[t],h=s==null?null:s.map(d=>n.track.staves[o.modelStaff.index].bars[d]);o.addBar(l,r,h);const c=o.barRenderers[o.barRenderers.length-1];i.renderers.push(c),c.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),c.canWrap||(i.canWrap=!1)}return this._calculateAccoladeSpacing(e),r.finish(),i.width=this._updateWidthFromLastBar(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){const e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0,s=0;for(let i=0,r=this._allStaves.length;i<r;i++){const o=this._allStaves[i].revertLastBar(),l=o.computedWidth;l>t&&(t=l);const h=o.barDisplayScale;h>s&&(s=h)}return this.width-=t,this.computedWidth-=t,this.totalBarDisplayScale-=s,e}return null}_updateWidthFromLastBar(){let e=0,t=0;for(let s=0,i=this._allStaves.length;s<i;s++){const r=this._allStaves[s],n=r.barRenderers[r.barRenderers.length-1];n.applyLayoutingInfo(),n.computedWidth>e&&(e=n.computedWidth);const o=n.barDisplayScale;o>t&&(t=o)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=t,e}_calculateAccoladeSpacing(e){const t=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;const s=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(fe.TrackNames)){const o=this.layout.renderer.tracks.length===1?s.singleTrackTrackNamePolicy:s.multiTrackTrackNamePolicy,l=this.index===0?s.firstSystemTrackNameMode:s.otherSystemsTrackNameMode,h=this.index===0?s.firstSystemTrackNameOrientation:s.otherSystemsTrackNameOrientation;let c=!1;switch(o){case lt.Hidden:break;case lt.FirstSystem:c=this.index===0;break;case lt.AllSystems:c=!0;break}let d=!1;if(c){const f=this.layout.renderer.canvas,p=t.display.resources.effectFont;f.font=p;for(const g of e){let m="";switch(l){case Wt.FullName:m=g.name;break;case Wt.ShortName:m=g.shortName;break}if(m.length>0){d=!0;const b=f.measureText(m);switch(h){case Ot.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,b.width));break;case Ot.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,b.height));break}}}d&&(this.accoladeWidth+=t.display.systemLabelPaddingLeft,this.accoladeWidth+=t.display.systemLabelPaddingRight)}}let r=0;for(const o of this._allStaves)o.y=r,o.calculateHeightForAccolade(),r+=o.height;let n=0;for(const o of this._brackets)o.finalizeBracket(t.display.resources.engravingSettings),n=Math.max(n,o.width);this.accoladeWidth+=n,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}_getStaffTrackGroup(e){for(let t=0,s=this.staves.length;t<s;t++){const i=this.staves[t];if(i.track===e)return i}return null}addStaff(e,t){let s=this._getStaffTrackGroup(e);if(s||(s=new kc(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this._allStaves.length,this._allStaves.push(t),s.addStaff(t),t.isInsideBracket){this._firstStaffInBrackets||(this._firstStaffInBrackets=t,t.isFirstInSystem=!0),s.firstStaffInBracket||(s.firstStaffInBracket=t),this._lastStaffInBrackets=t,s.lastStaffInBracket=t;let i=this._brackets.find(r=>r.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case vi.NoBrackets:break;case vi.GroupStaves:i=new Ia(e),i.index=this._brackets.length,this._brackets.push(i);break;case vi.GroupSimilarInstruments:i=new Bc(e),i.index=this._brackets.length,this._brackets.push(i);break}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i)}}get height(){return this._allStaves.length===0?0:Math.ceil(this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(e){for(let t=0,s=this._allStaves.length;t<s;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,s){if(this.paintPartial(e+this.x,t+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this._hasSystemSeparator){const i=Se.track(s,Hs.SystemSeparator,this._allStaves[0].modelStaff.track);try{const r=this.layout.renderer.settings.display.resources.engravingSettings,n=Math.min(0,r.glyphBottom.get(u.SystemDivider)??0);rt.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height+n,1,u.SystemDivider,!1),rt.fillMusicFontSymbolSafe(s,e+this.x+this.width-r.glyphWidths.get(u.SystemDivider),t+this.y+this.height+n,1,u.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(e,t,s,i,r){for(let o=0,l=this._allStaves.length;o<l;o++)this._allStaves[o].paint(e,t,s,i,r);const n=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&i===0){s.color=n.barSeparatorColor;const o=this.layout.renderer.settings,l=this.layout.renderer.settings.notation.isNotationElementVisible(fe.TrackNames);if(s.font=n.effectFont,l){const h=this.layout.renderer.score.stylesheet,c=this.layout.renderer.tracks.length===1?h.singleTrackTrackNamePolicy:h.multiTrackTrackNamePolicy,d=this.index===0?h.firstSystemTrackNameMode:h.otherSystemsTrackNameMode,f=this.index===0?h.firstSystemTrackNameOrientation:h.otherSystemsTrackNameOrientation;let p=!1;switch(c){case lt.Hidden:break;case lt.FirstSystem:p=this.index===0;break;case lt.AllSystems:p=!0;break}if(p){const g=s.textBaseline,m=s.textAlign;for(const b of this.staves)if(b.firstStaffInBracket&&b.lastStaffInBracket){const S=t+b.firstStaffInBracket.contentTop,T=t+b.lastStaffInBracket.contentBottom;let C="";switch(d){case Wt.FullName:C=b.track.name;break;case Wt.ShortName:C=b.track.shortName;break}const v=Se.track(s,Hs.TrackName,b.track);try{if(C.length>0){const G=e+b.firstStaffInBracket.x-o.display.accoladeBarPaddingRight-(b.bracket?.width??0)-o.display.systemLabelPaddingRight;switch(f){case Ot.Horizontal:s.textBaseline=Re.Middle,s.textAlign=X.Right,s.fillText(C,G,(S+T)/2);break;case Ot.Vertical:s.textBaseline=Re.Bottom,s.textAlign=X.Center,s.beginRotate(G,(S+T)/2,-90-.1),s.fillText(C,0,0),s.endRotate();break}}}finally{v?.[Symbol.dispose]?.()}}s.textBaseline=g,s.textAlign=m}}if(this._allStaves.length>0){let h=null;for(const c of this._allStaves)if(c.isInsideBracket){if(h!==null){const d=h.contentBottom,f=c.contentTop,p=e+h.x,g=h.barRenderers[0],m=Se.bar(s,g.staffLineBarSubElement,g.bar);try{const b=Math.ceil(f-d);s.fillRect(p,t+d,n.engravingSettings.thinBarlineThickness,b)}finally{m?.[Symbol.dispose]?.()}}h=c}}for(const h of this._brackets)if(h.firstStaffInBracket&&h.lastStaffInBracket){const c=e+h.firstStaffInBracket.x,d=h.width,f=o.display.accoladeBarPaddingRight,p=t+h.firstStaffInBracket.contentTop,g=t+h.lastStaffInBracket.contentBottom;let m=p,b=g;if(h.drawAsBrace)rt.fillMusicFontSymbolSafe(s,c-f-d,b,h.braceScale,u.Brace);else if(h.firstStaffInBracket!==h.lastStaffInBracket){const S=d/2;m-=S,b+=S*2,s.fillRect(c-f-d,m,d,Math.ceil(b-m));const T=c-f-d;rt.fillMusicFontSymbolSafe(s,T,m,1,u.BracketTop),rt.fillMusicFontSymbolSafe(s,T,Math.floor(b),1,u.BracketBottom)}}}}finalizeSystem(){const e=this.layout.renderer.settings;if(this.index===0&&(this.topPadding=e.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=e.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const s=e.display.resources.engravingSettings.glyphHeights.get(u.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,s),this._hasSystemSeparator=!0}let t=0;for(const s of this._allStaves)s.x=this.accoladeWidth,s.y=t,s.finalizeStaff(),t+=s.height;for(const s of this._brackets)s.finalizeBracket(e.display.resources.engravingSettings)}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this._firstStaffInBrackets,i=this._lastStaffInBrackets;if(!s||!i)return;t+=this.topPadding;const r=this._allStaves[this._allStaves.length-1],n=t+this.y+s.y,o=t+this.y+i.y+i.height,l=t+this.y+this._allStaves[0].y,h=t+this.y+r.y+r.height,c=t+this.y+s.y+s.topSpacing+s.topOverflow+(s.barRenderers.length>0?s.barRenderers[0].topPadding:0),d=t+this.y+r.y+r.height-r.bottomSpacing-r.bottomOverflow-(r.barRenderers.length>0?r.barRenderers[0].bottomPadding:0),f=o-n,p=d-c,g=h-l,m=this.x+s.x,b=new Jn;b.visualBounds=new Mt,b.visualBounds.x=e+this.x,b.visualBounds.y=t+this.y,b.visualBounds.w=this.width,b.visualBounds.h=this.height-this.topPadding-this.bottomPadding,b.realBounds=new Mt,b.realBounds.x=e+this.x,b.realBounds.y=t+this.y,b.realBounds.w=this.width,b.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(b);const S=new Map;for(let T=0;T<this.staves.length;T++)for(const C of this.staves[T].stavesRelevantForBoundsLookup)for(const v of C.barRenderers){let G;S.has(v.bar.masterBar.index)?G=S.get(v.bar.masterBar.index):(G=new Xn,G.index=v.bar.masterBar.index,G.isFirstOfLine=v.isFirstOfLine,G.realBounds=new Mt,G.realBounds.x=m+v.x,G.realBounds.y=l,G.realBounds.w=v.width,G.realBounds.h=g,G.visualBounds=new Mt,G.visualBounds.x=m+v.x,G.visualBounds.y=n,G.visualBounds.w=v.width,G.visualBounds.h=f,G.lineAlignedBounds=new Mt,G.lineAlignedBounds.x=m+v.x,G.lineAlignedBounds.y=c,G.lineAlignedBounds.w=v.width,G.lineAlignedBounds.h=p,this.layout.renderer.boundsLookup.addMasterBar(G),S.set(G.index,G)),v.buildBoundingsLookup(G,m,t+this.y+C.y)}}getBarX(e){if(!this._firstStaffInBrackets||this.layout.renderer.tracks.length===0)return 0;const t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,t).x}}class xc extends Yo{constructor(e,t){super(e,t,X.Left)}}class Nc extends Ms{_tuning;_trackLabel;colorOverride;constructor(e,t,s,i){super(e,t),this._tuning=s,this._trackLabel=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this._createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(e,t,s),s.color=i}_createGlyphs(e){const t=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){const n=new bs(0,this.height,this._trackLabel,t.effectFont,X.Left);n.renderer=this.renderer,n.doLayout(),this.height+=n.height,this.addGlyph(n)}if(e.name.length>0){const n=new bs(0,this.height,e.name,t.effectFont,X.Left);n.renderer=this.renderer,n.doLayout(),this.height+=n.height,this.addGlyph(n)}const s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(u.GuitarString0)*s;this.renderer.scoreRenderer.canvas.font=t.effectFont;const r=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*t.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,2*r)),!e.isStandard){const n=Math.ceil(e.tunings.length/2)|0;let o=0;const l=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let h=l;for(let c=0,d=e.tunings.length;c<d;c++){const f=u.GuitarString0+(c+1);this.addGlyph(new gt(o,h+i,s,f));const p=` = ${A.getTextForTuning(e.tunings[c],!1)}`;this.addGlyph(new bs(o+i,h+i/2,p,t.effectFont,X.Left,Re.Middle)),h+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const g=h;this.height<g&&(this.height=g),c===n-1&&(h=l,o+=r)}}}}class Pc{args;renderCallback;constructor(e,t){this.args=e,this.renderCallback=t}}var fs;(function(a){a[a.Automatic=0]="Automatic",a[a.FromModelWithScale=1]="FromModelWithScale",a[a.FromModelWithWidths=2]="FromModelWithWidths"})(fs||(fs={}));class Vi{_barRendererLookup=new Map;pagePadding=null;renderer;width=0;height=0;multiBarRestInfo=null;get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}headerGlyphs=new Map;footerGlyphs=new Map;chordDiagrams=null;tuningGlyph=null;systemsLayoutMode=fs.Automatic;constructor(e){this.renderer=e}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();const e=this.renderer.score;this.firstBarIndex=L.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=L.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=L.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(t=>t/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),this.pagePadding.length===1?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:this.pagePadding.length===2&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this._createScoreInfoGlyphs(),this.doLayoutAndRender()}_lazyPartials=new Map;registerPartial(e,t){if(e.height===0)return;const s=this.renderer.settings.display.scale;e.x*=s,e.y*=s,e.width*=s,e.height*=s,e.totalWidth*=s,e.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new Pc(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this._internalRenderLazyPartial(e,t))}_internalRenderLazyPartial(e,t){const s=this.renderer.canvas;s.beginRender(e.width,e.height),t(s),e.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){if(this._lazyPartials.has(e)){const t=this._lazyPartials.get(e);this._internalRenderLazyPartial(t.args,t.renderCallback)}}static headerElements=new Ji(()=>new Map([[O.Title,fe.ScoreTitle],[O.SubTitle,fe.ScoreSubTitle],[O.Artist,fe.ScoreArtist],[O.Album,fe.ScoreAlbum],[O.Words,fe.ScoreWords],[O.Music,fe.ScoreMusic],[O.WordsAndMusic,fe.ScoreWordsAndMusic],[O.Transcriber,void 0]]));static footerElements=new Ji(()=>new Map([[O.Copyright,fe.ScoreCopyright],[O.CopyrightSecondLine,void 0]]));_createHeaderFooterGlyph(e,t,s,i){switch(s){case O.WordsAndMusic:if(t.words!==t.music)return;break;case O.Words:case O.Music:if(t.words===t.music)return;break;case O.CopyrightSecondLine:if(!this.footerGlyphs.has(O.Copyright))return;break}const r=e.display.resources,n=e.notation,l=t.style&&t.style.headerAndFooter.has(s)?t.style.headerAndFooter.get(s):Di.defaultHeaderAndFooter.get(s);let h=l.isVisible!==void 0?l.isVisible:!0;if(i!==void 0&&(h=n.isNotationElementVisible(i)),!h)return;const c=l.buildText(t);if(c)return new bs(0,0,c,r.getFontForElement(s),l.textAlign,void 0,Se.scoreColor(r,s,t))}_createScoreInfoGlyphs(){E.debug("ScoreLayout","Creating score info glyphs");const e=this.renderer.settings,t=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const s=new Oa(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[n,o]of Vi.headerElements.value){const l=this._createHeaderFooterGlyph(e,t,n,o);l&&(l.renderer=s,l.doLayout(),this.headerGlyphs.set(n,l))}for(const[n,o]of Vi.footerElements.value){const l=this._createHeaderFooterGlyph(e,t,n,o);l&&(l.renderer=s,l.doLayout(),this.footerGlyphs.set(n,l))}const i=e.notation,r=e.display.resources;if(i.isNotationElementVisible(fe.GuitarTuning)){const n=[];for(const o of this.renderer.tracks)for(const l of o.staves){let h=!l.isPercussion&&l.isStringed&&l.tuning.length>0&&l.showTablature;if(t.stylesheet.perTrackDisplayTuning&&t.stylesheet.perTrackDisplayTuning.has(o.index)&&t.stylesheet.perTrackDisplayTuning.get(o.index)===!1&&(h=!1),h){n.push(l);break}}if(n.length>0&&t.stylesheet.globalDisplayTuning){this.tuningGlyph=new xc(0,0),this.tuningGlyph.renderer=s;for(const o of n)if(o.stringTuning.tunings.length>0){const l=n.length>1?o.track.name:"",h=new Nc(0,0,o.stringTuning,l);h.colorOverride=Se.trackColor(r,Hs.StringTuning,o.track),h.renderer=s,h.doLayout(),this.tuningGlyph.addGlyph(h)}}else this.tuningGlyph=null}if(i.isNotationElementVisible(fe.ChordDiagrams)){this.chordDiagrams=new bc(0,0),this.chordDiagrams.renderer=s;const n=new Set;for(const o of this.renderer.tracks)if(t.stylesheet.globalDisplayChordDiagramsOnTop&&(t.stylesheet.perTrackChordDiagramsOnTop==null||!t.stylesheet.perTrackChordDiagramsOnTop.has(o.index)||t.stylesheet.perTrackChordDiagramsOnTop.get(o.index)))for(const h of o.staves){const c=h.chords;if(c)for(const[,d]of c)n.has(d.uniqueId)||d.showDiagram&&(n.add(d.uniqueId),this.chordDiagrams.addChord(d))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}firstBarIndex=0;lastBarIndex=0;createEmptyStaffSystem(){const e=new Tc(this);for(let t=0;t<this.renderer.tracks.length;t++){const s=this.renderer.tracks[t];for(let i=0;i<s.staves.length;i++){const r=s.staves[i],n=F.staveProfiles.get(this.renderer.settings.display.staveProfile);for(const o of n)o.canCreate(s,r)&&e.addStaff(s,new _c(t,r,o))}}return e}registerBarRenderer(e,t){if(this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t),t.additionalMultiRestBars)for(const s of t.additionalMultiRestBars)this._barRendererLookup.get(e).set(s.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){const s=this._barRendererLookup.get(e);if(s.delete(t.bar.id),t.additionalMultiRestBars)for(const i of t.additionalMultiRestBars)s.delete(i.id)}}getRendererForBar(e,t){const s=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(s)?this._barRendererLookup.get(e).get(s):null}layoutAndRenderBottomScoreInfo(e){e=Math.round(e);const t=new fi;t.x=0,t.y=e;let s=0;const i=this.renderer.settings.display.resources,r=[];let n=0;for(const[o,l]of Vi.footerElements.value)if(this.footerGlyphs.has(o)){const h=this.footerGlyphs.get(o);h.y=s,this.alignScoreInfoGlyph(h),s+=h.height,r.push(h),n=Math.max(n,Math.round(h.x+h.width))}return s=Math.round(s),r.length>0&&(t.width=n,t.height=s,t.totalWidth=this.scaledWidth,t.totalHeight=e+t.height,this.registerPartial(t,o=>{o.color=i.scoreInfoColor,o.textAlign=X.Left,o.textBaseline=Re.Top;for(const l of r)l.paint(0,0,o)})),e+s}alignScoreInfoGlyph(e){if(F.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(e.textAlign){case X.Left:e.x=this.pagePadding[0];break;case X.Center:e.x=this.scaledWidth/2;break;case X.Right:e.x=this.scaledWidth-this.pagePadding[2];break}else e.x=this.firstBarX,e.textAlign=X.Left}layoutAndRenderAnnotation(e){const t="rendered by alphaTab",s=this.renderer.settings.display.resources,i=12,r=pe.withFamilyList(s.copyrightFont.families,i,st.Plain,ts.Bold),n=new Oa(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),o=new bs(0,0,t,r,X.Center,void 0,s.mainGlyphColor);o.renderer=n,o.doLayout(),this.alignScoreInfoGlyph(o);const l=new fi;return l.width=o.x+o.width,l.x=0,l.height=i,l.y=e,l.totalWidth=this.scaledWidth,l.totalHeight=e+i,l.firstMasterBarIndex=-1,l.lastMasterBarIndex=-1,this.registerPartial(l,h=>{h.color=s.mainGlyphColor,h.font=r,h.textAlign=X.Left,h.textBaseline=Re.Top,o.paint(0,0,h)}),e+i}}class ki extends Ms{_effectGlyphs=[];_normalGlyphs=[];container;computedWidth=0;constructor(){super(0,0)}doLayout(){let e=0;if(this.glyphs)for(let t=0,s=this.glyphs.length;t<s;t++){const i=this.glyphs[t];i.x=e,i.renderer=this.renderer,i.doLayout(),e+=i.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,t,s){this._paintEffects(e,t,s),this._paintNormal(e,t,s)}_paintNormal(e,t,s){for(const i of this._normalGlyphs)i.paint(e+this.x,t+this.y,s)}_paintEffects(e,t,s){const i=this.effectElement?Se.beat(s,this.effectElement,this.container.beat):void 0;try{for(const r of this._effectGlyphs)r.paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class wi extends ki{beamingHelper;centerX=0;updateBeamingHelper(){}buildBoundingsLookup(e,t,s){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}}class or extends ot{_scale=0;_baseline;_symbols=[];constructor(e,t,s,i,r=1){super(e,t),this._symbols=or.getSymbols(s),this._scale=r,this._baseline=i}static getSymbols(e){const t=[];for(;e>0;){const s=e%10;t.unshift(or.getSymbol(s)),e=e/10|0}return t}static getSymbol(e){switch(e){case 0:return u.TimeSig0;case 1:return u.TimeSig1;case 2:return u.TimeSig2;case 3:return u.TimeSig3;case 4:return u.TimeSig4;case 5:return u.TimeSig5;case 6:return u.TimeSig6;case 7:return u.TimeSig7;case 8:return u.TimeSig8;case 9:return u.TimeSig9;default:return u.None}}doLayout(){let e=0;for(const t of this._symbols)e+=this.renderer.smuflMetrics.glyphWidths.get(t);this.width=e}paint(e,t,s){switch(this._baseline){case Re.Top:t+=this.renderer.smuflMetrics.glyphBottom.get(this._symbols[0]);break;case Re.Bottom:t+=this.renderer.smuflMetrics.glyphTop.get(this._symbols[0]);break}s.fillMusicFontSymbols(e+this.x,t+this.y,this._scale,this._symbols)}}class Ra extends ot{static _restSymbols=[u.RestHBarLeft,u.RestHBarMiddle,u.RestHBarMiddle,u.RestHBarMiddle,u.RestHBarRight];_numberGlyph=[];constructor(){super(0,0)}doLayout(){this.width=Ra._restSymbols.reduce((t,s)=>t+this.renderer.smuflMetrics.glyphWidths.get(s),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));const e=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=or.getSymbols(e)}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.renderer.height/2,1,Ra._restSymbols);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(e+this.x+this.width/2,t+this.y+i|0,1,this._numberGlyph,!0)}}class Wa extends xs{constructor(e){super(Wa._getOrCreatePlaceholderBeat(e),e),this.preNotes=new ki,this.onNotes=new wi}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new Ra),super.doLayout()}static _getOrCreatePlaceholderBeat(e){if(e.voice.beats.length>1)return e.voice.beats[0];const t=new wt;return t.voice=e.voice,t}}var R;(function(a){a[a.TopWithStem=0]="TopWithStem",a[a.Top=1]="Top",a[a.Center=2]="Center",a[a.Bottom=3]="Bottom",a[a.BottomWithStem=4]="BottomWithStem",a[a.StemUp=5]="StemUp",a[a.StemDown=6]="StemDown"})(R||(R={}));var Qe;(function(a){a[a.Left=0]="Left",a[a.Center=1]="Center",a[a.Right=2]="Right"})(Qe||(Qe={}));class Oa{_preBeatGlyphs=new Oi;_voiceContainers=new Map;_postBeatGlyphs=new Oi;_ties=[];get nextRenderer(){return!this.bar||!this.bar.nextBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar)}get previousRenderer(){return!this.bar||!this.bar.previousBar?null:this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar)}scoreRenderer;staff;layoutingInfo;bar;additionalMultiRestBars=null;get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}x=0;y=0;width=0;computedWidth=0;height=0;index=0;topOverflow=0;bottomOverflow=0;helpers;isLinkedToPrevious=!1;canWrap=!0;get showMultiBarRest(){return!1}constructor(e,t){this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new yc(this))}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return e=Math.ceil(e),e>this.topOverflow?(this.topOverflow=e,!0):!1}registerOverflowBottom(e){return e=Math.ceil(e),e>this.bottomOverflow?(this.bottomOverflow=e,!0):!1}scaleToWidth(e){const t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(const s of this._voiceContainers.values())s.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}wasFirstOfLine=!1;get isFirstOfLine(){return this.index===0}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){const e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);for(const i of this._voiceContainers.values())i.registerLayoutingInfo(e),i.x+i.width;const s=this._postBeatGlyphs.width;e.postBeatSize<s&&(e.postBeatSize=s)}_appliedLayoutingInfo=0;applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(const s of this._voiceContainers.values()){s.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,s.applyLayoutingInfo(this.layoutingInfo);const i=s.x+s.width;e<i&&(e=i)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;const t=this.barDisplayWidth;return t>0&&this.scoreRenderer.layout.systemsLayoutMode===fs.FromModelWithWidths&&(this.width=t,this.computedWidth=t),!0}isFinalized=!1;finalizeRenderer(){this.isFinalized=!0;let e=!1;const t=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const i of this._ties)if(i.doLayout(),i.height>0){const r=i.y+i.height-s;r>0&&this.registerOverflowBottom(r)&&(e=!0);const n=i.y-t;n<0&&this.registerOverflowTop(n*-1)&&(e=!0)}return e}topPadding=0;bottomPadding=0;doLayout(){if(!this.bar)return;this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new Oi,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new Oi,this._postBeatGlyphs.renderer=this;for(let i=0;i<this.bar.voices.length;i++){const r=this.bar.voices[i];if(this.hasVoiceContainer(r)){const n=new dc(0,0,r);n.renderer=this,this._voiceContainers.set(this.bar.voices[i].index,n)}}if(this.bar.simileMark===_t.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){const i=new Wa(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(i)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(const i of this.helpers.beamHelpers)for(const r of i)r.finish();this.computedWidth=this.width;const e=this.height,t=this._preBeatGlyphs.glyphs;if(t)for(const i of t){const r=i.getBoundingBoxTop();r<0&&this.registerOverflowTop(r*-1);const n=r+i.height;n>e&&this.registerOverflowBottom(n-e)}const s=this._postBeatGlyphs.glyphs;if(s)for(const i of s){const r=i.getBoundingBoxTop();r<0&&this.registerOverflowTop(r*-1);const n=r+i.height;n>e&&this.registerOverflowBottom(n-e)}}hasVoiceContainer(e){return this.additionalMultiRestBars||e.index===0?!0:!e.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);const e=this._voiceContainers,t=this.beatGlyphsStart;let s=t;for(const i of e.values()){i.x=t,i.doLayout();const r=i.x+i.width;s<r&&(s=r)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(e){e.renderer=this,this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){return this.getVoiceContainer(e.voice)?.beatGlyphs?.[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e)?.preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e)?.onNotes}paint(e,t,s){this.paintBackground(e,t,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,s);for(const i of this._voiceContainers.values())i.paint(e+this.x,t+this.y,s);s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,s)}paintBackground(e,t,s){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,s)}buildBoundingsLookup(e,t,s){const i=new zn;i.bar=this.bar,i.visualBounds=new Mt,i.visualBounds.x=t+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new Mt,i.realBounds.x=t+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,e.addBar(i);for(const[r,n]of this._voiceContainers){const o=this.bar.isEmpty&&r===0;if(!n.voice.isEmpty||o)for(let l=0,h=n.beatGlyphs.length;l<h;l++)n.beatGlyphs[l].buildBoundingsLookup(i,t+this.x+n.x,s+this.y+n.y,o)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=me.PreNotes){const s=this.getBeatContainer(e);if(s)switch(t){case me.PreNotes:return s.voiceContainer.x+s.x;case me.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case me.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case me.Stem:const i=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(e):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+i;case me.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case me.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(e){const t=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],me.OnNotes),s=t,i=this.postBeatGlyphsStart-t;return s+i*e}getNoteX(e,t){const s=this.getBeatContainer(e.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(e,t):0}getNoteY(e,t){const s=this.getOnNotesGlyphForBeat(e.beat);return s?s.getNoteY(e,t):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new Oi,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(e,t,s){const i=Se.voice(s,lr.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case _t.Simple:s.beginGroup(xs.getGroupId(this.bar.voices[0].beats[0])),rt.fillMusicFontSymbolSafe(s,e+this.x+this.width/2,t+this.y+this.height/2,1,u.Repeat1Bar,!0),s.endGroup();break;case _t.SecondOfDouble:s.beginGroup(xs.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(xs.getGroupId(this.bar.previousBar.voices[0].beats[0])),rt.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height/2,1,u.Repeat2Bars,!0),s.endGroup(),s.endGroup();break}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}}var ke;(function(a){a[a.SinglePreBeat=0]="SinglePreBeat",a[a.SingleOnBeat=1]="SingleOnBeat",a[a.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",a[a.GroupedOnBeat=3]="GroupedOnBeat",a[a.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",a[a.FullBar=5]="FullBar"})(ke||(ke={}));class Cc extends ot{_uniqueEffectGlyphs=[];_effectGlyphs=[];isEmpty=!0;previousBand=null;isLinkedToPrevious=!1;firstBeat=null;lastBeat=null;height=0;originalHeight=0;voice;info;slot=null;constructor(e,t){super(0,0),this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||this.renderer.staff.trackIndex===0)){if(this.isEmpty=!1,(!this.firstBeat||e.isBefore(this.firstBeat))&&(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case ke.SingleOnBeatToEnd:case ke.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat);break}const t=this._createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height,this.originalHeight=t.height)}}resetHeight(){this.height=this.originalHeight}_createOrResizeGlyph(e,t){let s;switch(e){case ke.FullBar:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case ke.SinglePreBeat:case ke.SingleOnBeat:case ke.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case ke.GroupedOnBeat:case ke.GroupedOnBeatToEnd:const i=e===ke.GroupedOnBeat?ke.SingleOnBeat:ke.SingleOnBeatToEnd;if(t.index>0||this.renderer.index>0){const r=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,r)){let n=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(r.index))n=this._effectGlyphs[t.voice.index].get(r.index);else if(this.renderer.index>0){const h=this.renderer.previousRenderer.getBand(r.voice,this.info.effectId);if(h){const c=h._effectGlyphs[r.voice.index];c.has(r.index)&&(n=c.get(r.index))}}const o=this._createOrResizeGlyph(i,t);return n&&this.info.canExpand(r,t)&&(n.nextGlyph=o,o.previousGlyph=n,this.isLinkedToPrevious=!0),o}return this._createOrResizeGlyph(i,t)}return this._createOrResizeGlyph(i,t);default:return this._createOrResizeGlyph(ke.SingleOnBeat,t)}}paint(e,t,s){super.paint(e,t,s);for(let i=0,r=this._uniqueEffectGlyphs.length;i<r;i++){const n=this._uniqueEffectGlyphs[i];for(let o=0,l=n.length;o<l;o++){const h=n[o],c=Se.beat(s,Je.Effects,h.beat,!1);try{h.paint(e+this.x,t+this.y,s)}finally{c?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(const t of this._effectGlyphs[e].keys())this._alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}_alignGlyph(e,t){const s=this._effectGlyphs[t.voice.index].get(t.index),i=this.renderer.getBeatContainer(t);switch(e){case ke.SinglePreBeat:const r=this.renderer.layoutingInfo.getPreBeatSize(t);s.x=this.renderer.beatGlyphsStart+i.x-r;break;case ke.SingleOnBeat:case ke.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x;break;case ke.SingleOnBeatToEnd:case ke.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{const n=this.renderer.layoutingInfo.getPostBeatSize(t);s.width=n}break;case ke.FullBar:s.width=this.renderer.width;break}}}class Ec{uniqueEffectId=null;y=0;height=0;firstBeat=null;lastBeat=null}class vc{bands;shared;constructor(){this.bands=[],this.shared=new Ec}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),(!this.shared.firstBeat||e.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=e.firstBeat),(!this.shared.lastBeat||e.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class Dc{_effectSlot;slots;constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){const s=this._effectSlot.get(e.info.effectId);if(s.canBeUsed(e))return s}for(const s of this.slots)if(s.canBeUsed(e))return s;const t=new vc;return this.slots.push(t),t}register(e){const t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class Lc extends Oa{_infos;_bands=[];_bandLookup=new Map;sizingInfo=null;constructor(e,t,s){super(e,t),this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this._updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return this._updateHeight()&&(e=!0),e}_updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(const t of this.sizingInfo.slots){t.shared.y=e;for(const s of t.bands)s.y=e,s.height=t.shared.height;e+=t.shared.height+this.settings.display.effectBandPaddingBottom}return e=Math.ceil(e),e!==this.height?(this.height=e,!0):!1}applyLayoutingInfo(){const e=!super.applyLayoutingInfo();if(this.index>0){const t=this.previousRenderer;this.sizingInfo=t.sizingInfo}else this.sizingInfo=new Dc;for(const t of this._bands)t.resetHeight(),t.alignGlyphs(),t.isEmpty||this.sizingInfo.register(t);return this._updateHeight(),e}scaleToWidth(e){super.scaleToWidth(e);for(const t of this._bands)t.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(const e of this.bar.voices)if(this.hasVoiceContainer(e))for(const t of this._infos){const s=new Cc(e,t);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(`${e.index}.${t.effectId}`,s)}super.createBeatGlyphs();for(const e of this._bands)e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(const t of e.beats){const s=new xs(t,this.getVoiceContainer(e));s.preNotes=new ki,s.onNotes=new wi,this.addBeatGlyph(s);for(const i of this._bands)i.createGlyph(t)}}paint(e,t,s){this.paintBackground(e,t,s);for(const i of this._bands)s.color=i.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(e+this.x,t+this.y,s)}getBand(e,t){const s=`${e.index}.${t}`;return this._bandLookup.has(s)?this._bandLookup.get(s):null}}class Hi extends vr{infos;_staffId;get staffId(){return this._staffId}shouldShow;getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t,s=null){super(),this.infos=t,this._staffId=e,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(e,t){const s=this.shouldShow;return super.canCreate(e,t)&&(!s||s(e,t))}create(e,t){return new Lc(e,t,this.infos.filter(s=>e.settings.notation.isNotationElementVisible(s.notationElement)))}}class Fc extends us{_endings;_endingsString="";_openLine;_closeLine;_indent;constructor(e,t,s,i,r,n){super(e,t),this._endings=L.getAlternateEndingsList(s),this._openLine=i,this._closeLine=r,this._indent=n}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+this.renderer.smuflMetrics.alternateEndingsPadding*2;let e="";for(let t=0,s=this._endings.length;t<s;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,s){let i=this._closeLine?this.width-s.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===ce.LightHeavy&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(e|0)+s.lineWidth/2,t=(t|0)+s.lineWidth/2,this._indent&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this._openLine?(s.moveTo(e+this.x,t+this.y+this.height),s.lineTo(e+this.x,t+this.y)):s.moveTo(e+this.x,t+this.y),s.lineTo(e+this.x+i,t+this.y),this._closeLine&&s.lineTo(e+this.x+i,t+this.y+this.height),s.stroke(),this._openLine){const n=s.textBaseline;s.textBaseline=Re.Top;const o=this.renderer.resources;s.font=o.wordsFont,s.fillText(this._endingsString,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,t+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=n}}}class nt{get effectId(){return this.notationElement.toString()}}class Mc extends nt{get notationElement(){return fe.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ke.FullBar}shouldCreateGlyph(e,t){return t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.alternateEndings!==0}createNewGlyph(e,t){const s=t.voice.bar.masterBar,i=s.previousMasterBar===null||s.alternateEndings!==s.previousMasterBar.alternateEndings;let r=s.isRepeatEnd||s.nextMasterBar===null||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(o=>o.index>=s.index)||(r=!1);const n=s.previousMasterBar!==null&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new Fc(0,0,s.alternateEndings,i,r,n)}canExpand(e,t){return!0}}class Lr extends us{endPosition;forceGroupedRendering=!1;endOnBarLine=!1;constructor(e){super(),this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(e,t,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering){this.paintNonGrouped(e,t,s);return}let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const r=i.renderer,n=i.beat,o=this.endPosition,l=e-this.renderer.x,h=this.calculateEndX(r,n,l,o);this.paintGrouped(e,t,h,s)}calculateEndX(e,t,s,i){return t?s+e.x+e.getBeatX(t,i):s+e.x+this.x+this.width}paintNonGrouped(e,t,s){const i=e-this.renderer.x,r=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(e,t,r,s)}}class Gi extends Lr{_label;_dashed;_labelWidth=0;constructor(e,t=!0){super(me.OnNotes),this._label=e,this._dashed=t}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=me.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;const e=this.renderer.scoreRenderer.canvas.measureText(this._label);this.height=e.height,this._labelWidth=e.width}paintNonGrouped(e,t,s){const i=this.renderer.resources;s.font=i.effectFont;const r=s.textBaseline;s.textBaseline=Re.Middle,s.fillText(this._label,e+this.x-this._labelWidth/2,t+this.y+this.height/2),s.textBaseline=r}paintGrouped(e,t,s,i){this.paintNonGrouped(e,t,i);const r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,n=this.renderer.smuflMetrics.lineRangedGlyphDashSize,o=this.renderer.smuflMetrics.pedalLineThickness,l=e+this.x+this._labelWidth/2+r/2,h=t+this.y+this.height/2-o/2;if(this._dashed){if(s>l){let c=l;for(;c<s;){const d=Math.min(c+n,s);i.fillRect(c,h,d-c,o),c+=n+r}i.fillRect(s,h-n/2+o/2,o,n)}}else i.fillRect(l,h,s-l,o),i.fillRect(s-o,h,o,n/2)}}class Va extends nt{get notationElement(){return fe.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isBarre}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){let s="";switch(t.barreShape){case ps.None:case ps.Full:break;case ps.Half:s+="1/2";break}return s+=`B ${Va.toRoman(t.barreFret)}`,new Gi(s,!1)}static _romanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);static toRoman(e){let t="";if(e>0)for(const[s,i]of Va._romanLetters){const r=Math.floor(e/i);e-=r*i,t+=s.repeat(r)}return t}canExpand(e,t){return e.barreFret===t.barreFret&&e.barreShape===t.barreShape}}class Ac extends us{_timer;_text="";_textWidth=0;_textHeight=0;constructor(e){super(0,0),this._timer=e}doLayout(){const e=this._timer/6e4|0,t=(this._timer-e*6e4)/1e3|0;this._text=`${e}:${t.toString().padStart(2,"0")}`;const s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.timerFont;const i=s.measureText(this._text);this._textHeight=s.font.size+this.renderer.smuflMetrics.beatTimerPadding*2,this._textWidth=i.width+this.renderer.smuflMetrics.beatTimerPadding*2,this.height=this._textHeight+this.renderer.smuflMetrics.beatTimerPadding*2}paint(e,t,s){const i=this._textWidth/2|0;s.strokeRect(e+this.x-i,t+this.y+this.renderer.smuflMetrics.beatTimerPadding,this._textWidth,this._textHeight);const r=s.font,n=s.textBaseline,o=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=Re.Middle,s.textAlign=X.Center,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=r,s.textBaseline=n,s.textAlign=o}}class Ic extends nt{get notationElement(){return fe.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.showTimer}createNewGlyph(e,t){return new Ac(t.timer??0)}canExpand(e,t){return!0}}class Rc extends nt{get notationElement(){return fe.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.index===0&&t.voice.bar.index===0&&t.voice.bar.staff.capo!==0}createNewGlyph(e,t){return new bs(0,0,`Capo. fret ${t.voice.bar.staff.capo}`,e.resources.effectFont,X.Left)}canExpand(e,t){return!1}}class Wc extends nt{get notationElement(){return fe.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new bs(0,0,t.chord.name,e.resources.effectFont,X.Center)}canExpand(e,t){return!1}}class Oc extends Lr{_crescendo;constructor(e,t,s){super(me.EndBeat),this._crescendo=Lt.None,this._crescendo=s,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.DynamicCrescendoHairpin)}paintGrouped(e,t,s,i){const r=e+this.x,n=this.height,o=this.renderer.smuflMetrics.glyphWidths.get(u.NoteheadBlack)/2;i.beginPath(),this._crescendo===Lt.Crescendo?(s-=o,i.moveTo(s,t+this.y),i.lineTo(r,t+this.y+n/2),i.lineTo(s,t+this.y+n)):(s-=o,i.moveTo(r,t+this.y),i.lineTo(s,t+this.y+n/2),i.lineTo(r,t+this.y+n));const l=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=l}}class Vc extends nt{get notationElement(){return fe.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==Lt.None}createNewGlyph(e,t){return new Oc(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class Ha extends ot{_symbols;_scale=1;constructor(e){super(0,0),this._symbols=e}doLayout(){this.height=0;const e=this.renderer.smuflMetrics.directionsScale;this._scale=e;for(const t of this._symbols){const s=this.renderer.smuflMetrics.glyphHeights.get(t)*e;s>this.height&&(this.height=s)}}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.height,this._scale,this._symbols,!0)}}class ns extends ot{_text;constructor(e){super(0,0),this._text=e}doLayout(){const e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.directionsFont,this.height=e.measureText(this._text).height}paint(e,t,s){const i=s.font,r=s.textBaseline,n=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=Re.Middle,s.textAlign=X.Right,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=i,s.textBaseline=r,s.textAlign=n}}class Hc extends us{_directions;_barBeginGlyphs=[];_barEndGlyphs=[];constructor(e,t,s){super(e,t),this._directions=s}doLayout(){const e=this._directions;e.has(z.TargetSegnoSegno)&&this._barBeginGlyphs.push(new Ha([u.Segno,u.Segno])),e.has(z.TargetSegno)&&this._barBeginGlyphs.push(new Ha([u.Segno])),e.has(z.TargetDoubleCoda)&&this._barBeginGlyphs.push(new Ha([u.Coda,u.Coda])),e.has(z.TargetCoda)&&this._barBeginGlyphs.push(new Ha([u.Coda])),e.has(z.TargetFine)&&this._barEndGlyphs.push(new ns("Fine")),e.has(z.JumpDaDoubleCoda)&&this._barEndGlyphs.push(new ns("To Double Coda")),e.has(z.JumpDaCoda)&&this._barEndGlyphs.push(new ns("To Coda")),e.has(z.JumpDalSegnoSegno)&&this._barEndGlyphs.push(new ns("D.S.S.")),e.has(z.JumpDalSegnoSegnoAlCoda)&&this._barEndGlyphs.push(new ns("D.S.S. al Coda")),e.has(z.JumpDalSegnoSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new ns("D.S.S. al Double Coda")),e.has(z.JumpDalSegnoSegnoAlFine)&&this._barEndGlyphs.push(new ns("D.S.S. al Fine")),e.has(z.JumpDalSegno)&&this._barEndGlyphs.push(new ns("D.S.")),e.has(z.JumpDalSegnoAlCoda)&&this._barEndGlyphs.push(new ns("D.S. al Coda")),e.has(z.JumpDalSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new ns("D.S. al Double Coda")),e.has(z.JumpDalSegnoAlFine)&&this._barEndGlyphs.push(new ns("D.S. al Fine")),e.has(z.JumpDaCapo)&&this._barEndGlyphs.push(new ns("D.C.")),e.has(z.JumpDaCapoAlCoda)&&this._barEndGlyphs.push(new ns("D.C. al Coda")),e.has(z.JumpDaCapoAlDoubleCoda)&&this._barEndGlyphs.push(new ns("D.C. al Double Coda")),e.has(z.JumpDaCapoAlFine)&&this._barEndGlyphs.push(new ns("D.C. al Fine"));const t=this._doSideLayout(this._barBeginGlyphs),s=this._doSideLayout(this._barEndGlyphs);this.height=Math.max(t,s)}_doSideLayout(e){let t=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of e)i.y=t,i.renderer=this.renderer,i.doLayout(),t+=i.height+s;return t}paint(e,t,s){for(const i of this._barBeginGlyphs)i.paint(e+this.x,t+this.y,s);for(const i of this._barEndGlyphs)i.paint(e+this.x+this.width,t+this.y,s)}}class Gc extends nt{get notationElement(){return fe.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ke.FullBar}shouldCreateGlyph(e,t){return t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.directions!==null&&t.voice.bar.masterBar.directions.size>0}createNewGlyph(e,t){return new Hc(0,0,t.voice.bar.masterBar.directions)}canExpand(e,t){return!0}}class kn extends gt{constructor(e,t,s){super(e,t,1,kn._getSymbol(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(u.DynamicForte);const e=this.renderer.smuflMetrics.glyphTop.get(u.DynamicForte);this.offsetY=e}static _getSymbol(e){switch(e){case Z.PPP:return u.DynamicPPP;case Z.PP:return u.DynamicPP;case Z.P:return u.DynamicPiano;case Z.MP:return u.DynamicMP;case Z.MF:return u.DynamicMF;case Z.F:return u.DynamicForte;case Z.FF:return u.DynamicFF;case Z.FFF:return u.DynamicFFF;case Z.PPPP:return u.DynamicPPPP;case Z.PPPPP:return u.DynamicPPPPP;case Z.PPPPPP:return u.DynamicPPPPP;case Z.FFFF:return u.DynamicFFFF;case Z.FFFFF:return u.DynamicFFFFF;case Z.FFFFFF:return u.DynamicFFFFFF;case Z.SF:return u.DynamicSforzando1;case Z.SFP:return u.DynamicSforzandoPiano;case Z.SFPP:return u.DynamicSforzandoPianissimo;case Z.FP:return u.DynamicFortePiano;case Z.RF:return u.DynamicRinforzando1;case Z.RFZ:return u.DynamicRinforzando2;case Z.SFZ:return u.DynamicSforzato;case Z.SFFZ:return u.DynamicSforzatoFF;case Z.FZ:return u.DynamicForzando;case Z.N:return u.DynamicNiente;case Z.PF:return u.DynamicPF;case Z.SFZP:return u.DynamicSforzatoPiano;default:return u.None}}}class Uc extends nt{get notationElement(){return fe.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return this._internalShouldCreateGlyph(t)}_internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest)return!1;const t=this._getPreviousDynamicsBeat(e);let s=e.voice.index===0&&!t||e.dynamics!==t?.dynamics;if(s&&e.voice.index>0){for(const i of e.voice.bar.voices)if(i.index<e.voice.index){const r=i.getBeatAtPlaybackStart(e.playbackStart);r&&e.dynamics===r.dynamics&&this._internalShouldCreateGlyph(r)&&(s=!1)}}return s}_getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;t!=null;){if(!t.isRest)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new kn(0,0,t.dynamics)}canExpand(e,t){return!0}}class wn extends gt{constructor(e){super(0,0,1,wn._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case ut.FadeIn:return u.GuitarFadeIn;case ut.FadeOut:return u.GuitarFadeOut;case ut.VolumeSwell:return u.GuitarVolumeSwell}return u.None}paint(e,t,s){super.paint(e,t+this.height,s)}}class zc extends nt{get notationElement(){return fe.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.fade!==ut.None}createNewGlyph(e,t){return new wn(t.fade)}canExpand(e,t){return!0}}class Bn extends gt{constructor(e,t,s){super(e,t,1,Bn._getSymbol(s))}static _getSymbol(e){switch(e){case jt.Short:return u.FermataShortAbove;case jt.Medium:return u.FermataAbove;case jt.Long:return u.FermataLongAbove;default:return u.None}}paint(e,t,s){super.paint(e-this.width/2,t+this.height,s)}}class Yc extends nt{get notationElement(){return fe.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.voice.index===0&&!!t.fermata}createNewGlyph(e,t){return new Bn(0,0,t.fermata.type)}canExpand(e,t){return!0}}class Xc{line=0;symbols;color;constructor(e,t){this.line=e,this.symbols=t}}class Fr extends Ms{_infos=new Map;constructor(){super(0,0)}get isEmpty(){return this._infos.size===0}addFingers(e){const t=this.renderer.settings;if(t.notation.fingeringMode!==Cs.ScoreDefault&&t.notation.fingeringMode!==Cs.ScoreForcePiano)return;const s=Fr.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.leftHandFinger,!0);s!==u.None&&this._addFinger(e,s);const i=Fr.fingerToMusicFontSymbol(this.renderer.settings,e.beat,e.rightHandFinger,!1);i!==u.None&&this._addFinger(e,i)}static fingerToMusicFontSymbol(e,t,s,i){if(e.notation.fingeringMode===Cs.ScoreForcePiano||e.notation.fingeringMode===Cs.SingleNoteEffectBandForcePiano||Zt.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(s){case j.Unknown:case j.NoOrDead:return u.None;case j.Thumb:return u.Fingering1;case j.IndexFinger:return u.Fingering2;case j.MiddleFinger:return u.Fingering3;case j.AnnularFinger:return u.Fingering4;case j.LittleFinger:return u.Fingering5;default:return u.None}if(i)switch(s){case j.Unknown:return u.None;case j.NoOrDead:return u.Fingering0;case j.Thumb:return u.FingeringTLower;case j.IndexFinger:return u.Fingering1;case j.MiddleFinger:return u.Fingering2;case j.AnnularFinger:return u.Fingering3;case j.LittleFinger:return u.Fingering4;default:return u.None}switch(s){case j.Unknown:case j.NoOrDead:return u.None;case j.Thumb:return u.FingeringPLower;case j.IndexFinger:return u.FingeringILower;case j.MiddleFinger:return u.FingeringMLower;case j.AnnularFinger:return u.FingeringALower;case j.LittleFinger:return u.FingeringCLower;default:return u.None}}_addFinger(e,t){const s=this.renderer,i=s.getNoteLine(e);if(this._infos.has(i))this._infos.get(i).symbols.push(t);else{const r=new Xc(i,[t]);r.color=Se.noteColor(s.resources,Vt.StandardNotationEffects,e),this._infos.set(i,r)}}doLayout(){const e=this.renderer;for(const[t,s]of this._infos){const i=new Jh(0,0,1,s.symbols);i.colorOverride=s.color,i.renderer=e,i.y=e.getScoreY(s.line),i.doLayout(),i.offsetY=i.height/2,this.addGlyph(i),this.width=Math.max(this.width,i.width)}for(const t of this.glyphs){const s=t;s.x=this.width/2,s.center=!0}}}class Jc extends nt{get notationElement(){return fe.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.voice.index!==0||t.isRest||e.notation.fingeringMode!==Cs.SingleNoteEffectBand&&e.notation.fingeringMode!==Cs.SingleNoteEffectBandForcePiano||t.notes.length!==1?!1:t.notes[0].isFingering}createNewGlyph(e,t){let s=j.Unknown,i=!1;const r=t.notes[0];r.leftHandFinger!==j.Unknown?(s=r.leftHandFinger,i=!0):r.rightHandFinger!==j.Unknown&&(s=r.rightHandFinger);const n=Fr.fingerToMusicFontSymbol(e.settings,t,s,i),o=new gt(0,0,1,n);return o.center=!0,o.renderer=e,o.doLayout(),o.offsetY=e.smuflMetrics.glyphTop.get(o.symbol),o}canExpand(e,t){return!0}}class $c extends nt{get notationElement(){return fe.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SinglePreBeat}shouldCreateGlyph(e,t){const s=t.voice.bar.masterBar;return t.voice.bar.staff.index===0&&t.voice.index===0&&t.index===0&&s.isFreeTime&&(s.index===0||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(e,t){return new bs(0,0,"Free time",e.resources.effectFont,X.Left)}canExpand(e,t){return!0}}class Jo extends gt{constructor(e,t,s=!1){super(e,t,ve.GraceScale,u.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class Ga extends nt{_type;_shouldCreate;constructor(e,t){super(),this._type=e,this._shouldCreate=t}get notationElement(){return fe.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){const s=this._shouldCreate;return t.golpe===this._type&&(!s||s(e,t))}createNewGlyph(e,t){return new Jo(0,0,!0)}canExpand(e,t){return!1}}class Ui extends nt{lastCreateInfo=null;shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let s=0,i=t.notes.length;s<i;s++){const r=t.notes[s];this.shouldCreateGlyphForNote(r)&&this.lastCreateInfo.push(r)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class Bi extends Ui{_harmonicType;_beat=null;_effectId;get effectId(){return this._effectId}get notationElement(){return fe.EffectHarmonics}constructor(e){switch(super(),this._harmonicType=e,e){case Q.None:this._effectId="harmonics-none";break;case Q.Natural:this._effectId="harmonics-natural";break;case Q.Artificial:this._effectId="harmonics-artificial";break;case Q.Pinch:this._effectId="harmonics-pinch";break;case Q.Tap:this._effectId="harmonics-tap";break;case Q.Semi:this._effectId="harmonics-semi";break;case Q.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId="";break}}shouldCreateGlyphForNote(e){return!e.isHarmonic||e.harmonicType!==this._harmonicType?!1:(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){return new Gi(Bi.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case Q.Natural:return"N.H.";case Q.Artificial:return"A.H.";case Q.Pinch:return"P.H.";case Q.Tap:return"T.H.";case Q.Semi:return"S.H.";case Q.Feedback:return"Fdbk."}return""}}class qc extends gt{constructor(){super(0,0,1,u.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class $o extends Ui{get notationElement(){return fe.EffectTap}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new qc}}class Qc extends nt{get notationElement(){return fe.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){return new Gi("LetRing")}canExpand(e,t){return!0}}class Kc extends us{_lines;font;textAlign;constructor(e,t,s,i,r=X.Center){super(e,t),this._lines=s,this.font=i,this.textAlign=r}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let r=0;r<this._lines.length;r++)this._lines[r]&&s.fillText(this._lines[r],e+this.x,t+this.y+r*this.font.size);s.textAlign=i}}class Zc extends nt{get notationElement(){return fe.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new Kc(0,0,t.lyrics,e.resources.effectFont,X.Center)}canExpand(e,t){return!0}}class jc extends nt{get notationElement(){return fe.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ke.SinglePreBeat}shouldCreateGlyph(e,t){return t.voice.bar.staff.index===0&&t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new bs(0,0,t.voice.bar.masterBar.section.marker?`[${t.voice.bar.masterBar.section.marker}] ${t.voice.bar.masterBar.section.text}`:t.voice.bar.masterBar.section.text,e.resources.markerFont,X.Left)}canExpand(e,t){return!0}}class Tn extends gt{constructor(e){super(0,0,1,Tn._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case je.InvertedTurn:return u.OrnamentTurnInverted;case je.Turn:return u.OrnamentTurn;case je.UpperMordent:return u.OrnamentShortTrill;case je.LowerMordent:return u.OrnamentMordent}return u.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(u.OrnamentMordent)}}class ed extends nt{get notationElement(){return fe.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.notes.some(s=>s.ornament!==je.None)}createNewGlyph(e,t){return new Tn(t.notes.find(s=>s.ornament!==je.None).ornament)}canExpand(e,t){return!1}}class td extends Lr{_ottava;_aboveStaff;constructor(e,t){super(me.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.QuindicesimaAlta)}paintNonGrouped(e,t,s){this._paintOttava(e,t,s)}_paintOttava(e,t,s){let i=0;switch(this._ottava){case ae._15ma:i=this.renderer.smuflMetrics.glyphWidths.get(u.QuindicesimaAlta),rt.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,u.QuindicesimaAlta,!1);break;case ae._8va:i=this.renderer.smuflMetrics.glyphWidths.get(u.OttavaAlta),rt.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,u.OttavaAlta,!1);break;case ae._8vb:i=this.renderer.smuflMetrics.glyphWidths.get(u.OttavaBassaVb),rt.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,u.OttavaBassaVb,!1);break;case ae._15mb:i=(this.renderer.smuflMetrics.glyphWidths.get(u.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(u.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(u.OctaveBaselineB))*1,rt.fillMusicFontSymbolsSafe(s,e+this.x-i/2,t+this.y+this.height,1,[u.Quindicesima,u.OctaveBaselineM,u.OctaveBaselineB],!1);break}return i/2}paintGrouped(e,t,s,i){const r=this._paintOttava(e,t,i),n=this.renderer.smuflMetrics.lineRangedGlyphDashGap,o=e+this.x+r+n;let l=t+this.y;const h=this.height*.5;l+=this._aboveStaff?0:this.height;const c=this.renderer.smuflMetrics.lineRangedGlyphDashSize,d=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>o){let f=o;for(;f<s;)i.beginPath(),i.moveTo(f,l|0),i.lineTo(Math.min(f+c,s),l|0),f+=c+n,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,l),i.lineTo(s,l+h)):(i.moveTo(s,l),i.lineTo(s,l-h)),i.stroke()}i.lineWidth=d}}class qo extends nt{_aboveStaff;get effectId(){return`ottavia-${this._aboveStaff?"above":"below"}`}get notationElement(){return fe.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.GroupedOnBeat}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case ae._15ma:return this._aboveStaff;case ae._8va:return this._aboveStaff;case ae._8vb:return!this._aboveStaff;case ae._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new td(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class sd extends Ui{get notationElement(){return fe.EffectPalmMute}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){return new Gi("P.M.")}}class id extends Ui{get notationElement(){return fe.EffectPickSlide}shouldCreateGlyphForNote(e){return e.slideOutType===ne.PickSlideDown||e.slideOutType===ne.PickSlideUp}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){return new Gi("P.S.")}}class Mr extends gt{constructor(e,t,s){super(e,t,ve.GraceScale,Mr._getSymbol(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static _getSymbol(e){switch(e){case kt.Up:return u.StringsUpBow;case kt.Down:return u.StringsDownBow;default:return u.None}}}class rd extends nt{get notationElement(){return fe.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==kt.None}createNewGlyph(e,t){return new Mr(0,0,t.pickStroke)}canExpand(e,t){return!0}}class ad extends nt{get notationElement(){return fe.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.hasRasgueado}get sizingMode(){return ke.GroupedOnBeat}createNewGlyph(e,t){return new Gi("rasg.")}canExpand(e,t){return!0}}class Qo extends Lr{_type;_symbol=u.None;_repeatOffsetX=0;_symbolOffsetY=0;_partialWaves;constructor(e,t,s,i=!1){super(me.EndBeat),this._type=s,this.x=e,this.y=t,this._partialWaves=i}doLayout(){switch(super.doLayout(),this._type){case be.Slight:this._symbol=this.slightVibratoGlyph;break;case be.Wide:this._symbol=this.wideVibratoGlyph;break}this._repeatOffsetX=this.renderer.smuflMetrics.repeatOffsetX.get(this._symbol),this._symbolOffsetY=this.renderer.smuflMetrics.glyphTop.get(this._symbol),this.height=this.renderer.smuflMetrics.glyphHeights.get(this._symbol)}paintGrouped(e,t,s,i){const r=e+this.x,n=s-r,o=this._repeatOffsetX;let l=n/o;this._partialWaves||(l=Math.floor(l)),l<1&&(l=1);const h=[];for(let c=0;c<l;c++)h.push(this._symbol);i.fillMusicFontSymbols(e+this.x,t+this.y+this._symbolOffsetY,1,h,!1)}}class Ti extends Qo{get slightVibratoGlyph(){return u.GuitarVibratoStroke}get wideVibratoGlyph(){return u.GuitarWideVibratoStroke}}class Ko extends Qo{get slightVibratoGlyph(){return u.WiggleSawtoothNarrow}get wideVibratoGlyph(){return u.WiggleSawtooth}}class Zo extends nt{get notationElement(){return fe.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===be.Slight}createNewGlyph(e,t){return new Ko(0,0,be.Slight)}canExpand(e,t){return!0}}class jo extends Ui{_hideOnTiedBend;get notationElement(){return fe.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){let t=e.vibrato===be.Slight||e.isTieDestination&&e.tieOrigin.vibrato===be.Slight;return this._hideOnTiedBend&&t&&e.isTieDestination&&e.tieOrigin.hasBend&&(t=!1),t}get sizingMode(){return ke.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Ti(0,0,be.Slight)}constructor(e){super(),this._hideOnTiedBend=e}}class nd extends us{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.KeyboardPedalPed)}paint(e,t,s){const i=this.renderer,r=t+this.y,n=this.height,o=i.bar.sustainPedals,l=this.renderer.smuflMetrics.glyphWidths.get(u.KeyboardPedalPed),h=this.renderer.smuflMetrics.glyphWidths.get(u.KeyboardPedalUp);let c=0;for(;c<o.length;){let d=o[c];for(;d!=null;){const f=e+this.renderer.getRatioPositionX(d.ratioPosition);let p=0;if(d.pedalType===qe.Down?(rt.fillMusicFontSymbolSafe(s,f,r+n,1,u.KeyboardPedalPed,!0),p=l/2+this.renderer.smuflMetrics.sustainPedalLinePadding):d.pedalType===qe.Up&&(rt.fillMusicFontSymbolSafe(s,f,r+n,1,u.KeyboardPedalUp,!0),p=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding),d.nextPedalMarker)if(d.nextPedalMarker.bar===d.bar){let g=e+this.renderer.getRatioPositionX(d.nextPedalMarker.ratioPosition);switch(d.nextPedalMarker.pedalType){case qe.Down:g-=l/2;break;case qe.Hold:break;case qe.Up:g-=h/2;break}const m=f+p;g>m&&s.fillRect(m,r+n-this.renderer.smuflMetrics.pedalLineThickness,g-m,this.renderer.smuflMetrics.pedalLineThickness)}else{const g=e+this.x+this.width,m=f+p;s.fillRect(m,r+n-this.renderer.smuflMetrics.pedalLineThickness,g-m,this.renderer.smuflMetrics.pedalLineThickness)}if(c===0&&d.previousPedalMarker){const g=e+this.x,m=f-p;s.fillRect(g,r+n-this.renderer.smuflMetrics.pedalLineThickness,m-g,this.renderer.smuflMetrics.pedalLineThickness)}c++,d.nextPedalMarker!=null&&d.nextPedalMarker.bar!==d.bar?(d=null,c=o.length):d=d.nextPedalMarker}}}}class od extends nt{get notationElement(){return fe.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.FullBar}shouldCreateGlyph(e,t){return t.voice.index===0&&t.index===0&&t.voice.bar.sustainPedals.length>0}createNewGlyph(e,t){return new nd}canExpand(e,t){return!0}}class ld extends nt{get notationElement(){return fe.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){const s=e.resources;return t.slap?new bs(0,0,"S",s.effectFont,X.Center):t.pop?new bs(0,0,"P",s.effectFont,X.Center):new bs(0,0,"T",s.effectFont,X.Center)}canExpand(e,t){return!0}}class hd extends us{_tempoAutomations;constructor(e){super(0,0),this._tempoAutomations=e}doLayout(){super.doLayout();const e=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(u.MetNoteQuarterUp)*e.engravingSettings.tempoNoteScale}paint(e,t,s){for(const i of this._tempoAutomations){let r=e+this.renderer.getRatioPositionX(i.ratioPosition);const n=this.renderer.resources;s.font=n.markerFont;const o=t+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(u.MetNoteQuarterUp)*n.engravingSettings.tempoNoteScale,l=s.textBaseline;if(s.textBaseline=Re.Alphabetic,i.text){const h=`${i.text} `,c=s.measureText(h);s.fillText(h,r,o),r+=c.width}else r-=n.engravingSettings.glyphWidths.get(u.MetNoteQuarterUp)/2;rt.fillMusicFontSymbolSafe(s,r,o,n.engravingSettings.tempoNoteScale,u.MetNoteQuarterUp),r+=this.renderer.smuflMetrics.glyphWidths.get(u.MetNoteQuarterUp)*n.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,r,o),s.textBaseline=l,r+=s.measureText(` = ${i.value.toString()}`).width}}}class cd extends nt{get notationElement(){return fe.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ke.SinglePreBeat}shouldCreateGlyph(e,t){return t.voice.bar.staff.index===0&&t.voice.index===0&&t.index===0&&t.voice.bar.masterBar.tempoAutomations.some(s=>s.isVisible)}createNewGlyph(e,t){return new hd(t.voice.bar.masterBar.tempoAutomations.filter(s=>s.isVisible))}canExpand(e,t){return!0}}class dd extends nt{get notationElement(){return fe.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new bs(0,0,t.text,e.resources.effectFont,X.Left)}canExpand(e,t){return!0}}class ud extends Lr{constructor(e,t){super(me.EndBeat),this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.OrnamentTrill)}paintGrouped(e,t,s,i){const r=this.renderer.smuflMetrics.glyphWidths.get(u.OrnamentTrill),o=e+this.x+r,l=this.renderer.smuflMetrics.repeatOffsetX.get(u.WiggleTrill),h=Math.ceil((s-o)/l),c=[u.OrnamentTrill];for(let d=0;d<h;d++)c.push(u.WiggleTrill);i.fillMusicFontSymbols(e+this.x-r/2,t+this.y+this.height,1,c,!1)}}class el extends Ui{get notationElement(){return fe.EffectTrill}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return ke.GroupedOnBeatToEnd}createNewGlyph(e,t){return new ud(0,0)}}var bt;(function(a){a[a.EighthEighth=0]="EighthEighth",a[a.SixteenthSixteenth=1]="SixteenthSixteenth",a[a.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",a[a.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",a[a.EighthDottedSixteenth=4]="EighthDottedSixteenth",a[a.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",a[a.SixteenthEighthDotted=6]="SixteenthEighthDotted",a[a.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"})(bt||(bt={}));class fd extends us{_tripletFeel;_tupletHeight=0;_tupletPadding=0;constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout();const e=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(u.MetNoteQuarterUp)*e,this._tupletHeight=this.renderer.smuflMetrics.glyphHeights.get(u.Tuplet3)*e,this._tupletPadding=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this._tupletHeight}paint(e,t,s){e+=this.x,t+=this.y;let i=bt.EighthEighth,r=bt.EighthEighth;switch(this._tripletFeel){case Be.NoTripletFeel:i=bt.EighthEighth,r=bt.EighthEighth;break;case Be.Triplet8th:i=bt.EighthEighth,r=bt.QuarterTripletEighthTriplet;break;case Be.Triplet16th:i=bt.SixteenthSixteenth,r=bt.EighthSixteenthTriplet;break;case Be.Dotted8th:i=bt.EighthEighth,r=bt.EighthDottedSixteenth;break;case Be.Dotted16th:i=bt.SixteenthSixteenth,r=bt.SixteenthDottedThirtySecond;break;case Be.Scottish8th:i=bt.EighthEighth,r=bt.SixteenthEighthDotted;break;case Be.Scottish16th:i=bt.SixteenthSixteenth,r=bt.ThirtySecondSixteenthDotted;break}const n=this.renderer.smuflMetrics.tempoNoteScale,o=t+this.renderer.smuflMetrics.glyphTop.get(u.MetNoteQuarterUp)*n,l=t+this.height,h=s.textBaseline;s.textBaseline=Re.Bottom,s.font=this.renderer.resources.effectFont,s.fillText("(",e,l),e+=s.measureText("( ").width,e=this._drawGroup(e,o+this._tupletHeight,s,i),s.fillText(" = ",e,l),e+=s.measureText(" = ").width,e=this._drawGroup(e,o+this._tupletHeight,s,r),s.fillText(" )",e,l),s.textBaseline=h}_drawGroup(e,t,s,i){const r=this.renderer.smuflMetrics.tempoNoteScale;let n=[],o=[];const l=[];let h=u.None;switch(i){case bt.EighthEighth:l.push(X.Center),n=[u.MetNoteQuarterUp],o=[u.MetNoteQuarterUp];break;case bt.SixteenthSixteenth:l.push(X.Center),l.push(X.Center),n=[u.MetNoteQuarterUp],o=[u.MetNoteQuarterUp];break;case bt.QuarterTripletEighthTriplet:n=[u.MetNoteQuarterUp],o=[u.MetNote8thUp],h=u.Tuplet3;break;case bt.EighthSixteenthTriplet:l.push(X.Center),l.push(X.Right),n=[u.MetNoteQuarterUp],o=[u.MetNoteQuarterUp],h=u.Tuplet3;break;case bt.EighthDottedSixteenth:l.push(X.Center),l.push(X.Right),n=[u.MetNoteQuarterUp,u.Space,u.MetAugmentationDot],o=[u.MetNoteQuarterUp];break;case bt.SixteenthDottedThirtySecond:l.push(X.Center),l.push(X.Center),l.push(X.Right),n=[u.MetNoteQuarterUp,u.Space,u.MetAugmentationDot],o=[u.MetNoteQuarterUp];break;case bt.SixteenthEighthDotted:l.push(X.Center),l.push(X.Left),n=[u.MetNoteQuarterUp],o=[u.MetNoteQuarterUp,u.Space,u.MetAugmentationDot];break;case bt.ThirtySecondSixteenthDotted:l.push(X.Center),l.push(X.Center),l.push(X.Left),n=[u.MetNoteQuarterUp],o=[u.MetNoteQuarterUp,u.Space,u.MetAugmentationDot];break}const c=this.renderer.smuflMetrics.glyphWidths.get(u.MetNoteQuarterUp)*r,d=e+c-this.renderer.smuflMetrics.stemThickness*r,f=d+c*2+this.renderer.smuflMetrics.stemThickness*r,p=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,g=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,m=this.renderer.smuflMetrics.brokenBeamWidth*r;let b=t-this.renderer.smuflMetrics.glyphHeights.get(u.MetNoteQuarterUp)*r+p;if(h!==u.None){const C=(e+f)/2,v=b-this._tupletHeight-this._tupletPadding,G=this.renderer.smuflMetrics.glyphTop.get(h)*r,W=this.renderer.smuflMetrics.glyphWidths.get(h)*r;rt.fillMusicFontSymbolSafe(s,C,v+G,r,h,!0);const w=C-W/2-this._tupletPadding,se=C+W/2+this._tupletPadding,Ne=this._tupletHeight/2,ye=s.lineWidth;s.beginPath(),s.moveTo(e,v+Ne+Ne),s.lineTo(e,v+Ne),s.lineTo(w,v+Ne),s.moveTo(se,v+Ne),s.lineTo(f,v+Ne),s.lineTo(f,v+Ne+Ne),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*r,s.stroke(),s.lineWidth=ye}s.fillMusicFontSymbols(e,t,r,n,!1),e+=c,e+=c,s.fillMusicFontSymbols(e,t,r,o,!1),e+=c,(o[o.length-1]===u.MetAugmentationDot||o[0]===u.MetNote8thUp)&&(e+=c);for(const S of l){switch(S){case X.Left:s.fillRect(d,b,m,p);break;case X.Center:s.fillRect(d,b,f-d,p);break;case X.Right:s.fillRect(f-m,b,m,p);break}b+=p+g}return e}}class pd extends nt{get notationElement(){return fe.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ke.SinglePreBeat}shouldCreateGlyph(e,t){return t.index===0&&(t.voice.bar.masterBar.index===0&&t.voice.bar.masterBar.tripletFeel!==Be.NoTripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new fd(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class xn extends gt{constructor(e){super(0,0,1,xn._getSymbol(e)),this.center=!0}static _getSymbol(e){switch(e){case Jt.Open:return u.GuitarOpenPedal;case Jt.Closed:return u.GuitarClosePedal}return u.None}paint(e,t,s){super.paint(e,t+this.height,s)}}class gd extends nt{get notationElement(){return fe.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.SingleOnBeat}shouldCreateGlyph(e,t){return t.wahPedal!==Jt.None}createNewGlyph(e,t){return new xn(t.wahPedal)}canExpand(e,t){return!1}}class md extends nt{get notationElement(){return fe.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ke.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new Gi("w/bar")}canExpand(e,t){return!0}}class tl extends nt{get notationElement(){return fe.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ke.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===be.Wide}createNewGlyph(e,t){return new Ko(0,0,be.Wide)}canExpand(e,t){return!0}}class sl extends Ui{get notationElement(){return fe.EffectWideNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===be.Wide||e.isTieDestination&&e.tieOrigin.vibrato===be.Wide}get sizingMode(){return ke.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Ti(0,0,be.Wide)}}class il{x=0;width=0;masterBars=[]}class yd extends Vi{_system=null;get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case yi.Automatic:this.systemsLayoutMode=fs.Automatic;break;case yi.UseModelLayout:this.systemsLayoutMode=fs.FromModelWithWidths;break}const e=this.renderer.score;let t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t));let s=t,i=this.renderer.settings.display.barCount;i<=0&&(i=e.masterBars.length),i=t+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];const r=this.renderer.settings.display.barCountPerPartial,n=[];let o=new il,l=0;for(;s<=i;){const c=this.multiBarRestInfo,d=c!==null&&c.has(s)?c.get(s):null,f=this._system.addBars(this.renderer.tracks,s,d);if(o.masterBars.length===0&&f.isLinkedToPrevious&&n.length>0){const p=n[n.length-1];p.masterBars.push(e.masterBars[s]),p.width+=f.width,l+=f.width,o.x+=l}else o.masterBars.push(e.masterBars[s]),o.width+=f.width,o.masterBars.length>=r&&(n.length===0&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),l+=o.width,n.push(o),E.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null),o=new il,o.x=l);s++}o.masterBars.length>0&&(n.length===0&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),n.push(o),E.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null)),this._finalizeStaffSystem(),this.height=Math.floor(this._system.y+this._system.height),this.width=this._system.x+this._system.width+this.pagePadding[2],s=0;let h=0;for(let c=0;c<n.length;c++){const d=n[c],f=new fi;f.x=h,f.y=0,f.totalWidth=this.width,f.totalHeight=this.height,f.width=d.width,f.height=this.height,f.firstMasterBarIndex=d.masterBars[0].index,f.lastMasterBarIndex=d.masterBars[d.masterBars.length-1].index,h+=d.width;const p=s,g=c;this._system.buildBoundingsLookup(0,0),this.registerPartial(f,m=>{let b=this._system.getBarX(d.masterBars[0].index)+this._system.accoladeWidth;g===0&&(b-=this._system.x+this._system.accoladeWidth),m.color=this.renderer.settings.display.resources.mainGlyphColor,m.textAlign=X.Left,E.debug(this.name,`Rendering partial from bar ${d.masterBars[0].index} to ${d.masterBars[d.masterBars.length-1].index}`,null),this._system.paintPartial(-b,this._system.y,m,p,d.masterBars.length)}),s+=d.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3],this.height*=this.renderer.settings.display.scale}_finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}}class bd extends Vi{_systems=[];_allMasterBarRenderers=[];_barsFromPreviousSystem=[];get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case yi.Automatic:this.systemsLayoutMode=fs.Automatic;break;case yi.UseModelLayout:this.systemsLayoutMode=fs.FromModelWithScale;break}let e=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this._layoutAndRenderScoreInfo(e,-1),e=this._layoutAndRenderTunings(e,-1),e=this._layoutAndRenderChordDiagrams(e,-1),e=this._layoutAndRenderScore(e),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this.pagePadding[1];this.width=this.renderer.width;const t=this.height;e=this._layoutAndRenderScoreInfo(e,t),e=this._layoutAndRenderTunings(e,t),e=this._layoutAndRenderChordDiagrams(e,t),e=this._resizeAndRenderScore(e,t),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}_layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),r=new fi;return r.x=0,r.y=e,r.width=this.scaledWidth,r.height=i,r.totalWidth=this.scaledWidth,r.totalHeight=t<0?e+r.height:t,this.registerPartial(r,n=>{n.color=s.scoreInfoColor,n.textAlign=X.Center,this.tuningGlyph.paint(0,0,n)}),e+i}_layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),r=new fi;return r.x=0,r.y=e,r.width=this.scaledWidth,r.height=i,r.totalWidth=this.scaledWidth,r.totalHeight=t<0?e+i:t,this.registerPartial(r,n=>{n.color=s.scoreInfoColor,n.textAlign=X.Center,this.chordDiagrams.paint(0,0,n)}),e+i}_layoutAndRenderScoreInfo(e,t=-1){E.debug(this.name,"Layouting score info");const s=new fi;s.x=0,s.y=e;let i=0;const r=this.renderer.settings.display.resources,n=[];for(const[o,l]of Vi.headerElements.value)if(this.headerGlyphs.has(o)){const h=this.headerGlyphs.get(o);h.y=i,this.alignScoreInfoGlyph(h);let c=h.font.size;o===O.Words&&this.headerGlyphs.has(O.Music)&&this.headerGlyphs.get(O.Music).textAlign!==h.textAlign&&(c=0),i+=c,n.push(h)}return n.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=t<0?e+s.height:t,this.registerPartial(s,o=>{o.color=r.scoreInfoColor,o.textAlign=X.Center;for(const l of n)l.paint(0,0,o)})),e+i}_resizeAndRenderScore(e,t){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===fs.FromModelWithScale)for(let i=0;i<this._systems.length;i++){const r=this._systems[i];this._fitSystem(r),e+=this._paintSystem(r,t)}else{this._systems=[];let i=0;const r=this._maxWidth;let n=this.createEmptyStaffSystem();for(n.index=this._systems.length,n.x=this.pagePadding[0],n.y=e;i<this._allMasterBarRenderers.length;){let o=this._allMasterBarRenderers[i];if(n.width+o.width<=r||n.masterBarsRenderers.length===0)n.addMasterBarRenderers(this.renderer.tracks,o),i++;else{for(;o&&!o.canWrap&&n.masterBarsRenderers.length>1;)o=n.revertLastBar(),i--;n.isFull=!0,n.isLast=this.lastBarIndex===n.lastBarIndex,this._systems.push(n),this._fitSystem(n),e+=this._paintSystem(n,t),n=this.createEmptyStaffSystem(),n.index=this._systems.length,n.x=this.pagePadding[0],n.y=e}}n.isLast=this.lastBarIndex===n.lastBarIndex,this._fitSystem(n),e+=this._paintSystem(n,t)}return e}_layoutAndRenderScore(e){let s=this.firstBarIndex;const i=this.lastBarIndex;for(this._systems=[];s<=i;){const r=this._createStaffSystem(s,i);this._systems.push(r),r.x=this.pagePadding[0],r.y=e,s=r.lastBarIndex+1,this._fitSystem(r),E.debug(this.name,`Rendering partial from bar ${r.firstBarIndex} to ${r.lastBarIndex}`,null),e+=this._paintSystem(r,e)}return e}_paintSystem(e,t){const s=Math.floor(e.height),i=new fi;return i.x=0,i.y=e.y,i.totalWidth=this.scaledWidth,i.totalHeight=t,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=e.firstBarIndex,i.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(i,r=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=X.Left,e.paint(0,-(i.y/this.renderer.settings.display.scale),r)}),s}_fitSystem(e){e.isFull||e.width>this._maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this._maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}_getBarsPerSystem(e){let t=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===fs.FromModelWithScale){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),t=e<i.length?i[e]:s}return t}_createStaffSystem(e,t){const s=this.createEmptyStaffSystem();s.index=this._systems.length;const i=this._getBarsPerSystem(s.index),r=this._maxWidth,n=t+1;let o=e;for(;o<n;){if(this._barsFromPreviousSystem.length>0)for(const d of this._barsFromPreviousSystem)s.addMasterBarRenderers(this.renderer.tracks,d),o=d.lastMasterBarIndex;else{const d=this.multiBarRestInfo,f=d!==null&&d.has(o)?d.get(o):null,p=s.addBars(this.renderer.tracks,o,f);this._allMasterBarRenderers.push(p),o=p.lastMasterBarIndex}this._barsFromPreviousSystem=[];let l=!1;if((i===-1&&s.width>=r&&s.masterBarsRenderers.length!==0||s.masterBarsRenderers.length===i+1)&&(l=!0),l){let d=s.revertLastBar();if(d)for(this._barsFromPreviousSystem.push(d);d&&!d.canWrap&&s.masterBarsRenderers.length>1;)d=s.revertLastBar(),d&&this._barsFromPreviousSystem.push(d);return s.isFull=!0,s.isLast=!1,this._barsFromPreviousSystem.reverse(),s}let h=!1,c=!0;for(const d of this.renderer.tracks)d.lineBreaks&&d.lineBreaks.has(o+1)?h=!0:c=!1;if(h&&c)return s.isFull=!0,s.isLast=!1,s;s.x=0,o++}return s.isLast=t===s.lastBarIndex,s}get _maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class ss extends ot{constructor(e,t,s){super(e,t),this.width=s}}class zi extends ot{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}}class Ar extends zi{_isRepeat;constructor(e,t,s){super(e,t),this._isRepeat=s}doLayout(){this.width=this._isRepeat?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}}class _d extends zi{paint(e,t,s){const i=this.renderer.smuflMetrics.thinBarlineThickness/2,r=this.renderer.getLineHeight(1);let n=t+this.y+r*.5+i;const o=t+this.y+this.height;for(;n<o;)s.fillCircle(e+this.x,n,i),n+=r}}class Sd extends zi{paint(e,t,s){const i=this.renderer.smuflMetrics.dashedBarlineDashLength,r=e+this.x-this.width/2,n=Math.ceil(this.height/2/i),o=t+this.y+this.height,l=this.renderer.smuflMetrics.dashedBarlineGapLength,h=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),n<1)s.moveTo(r,t+this.y),s.lineTo(r,o);else{let c=t+this.y;for(;c<o;){s.moveTo(r,c);const d=Math.min(o-c,i);s.lineTo(r,c+d),c+=i+l}}s.stroke(),s.lineWidth=h}}class Ir extends zi{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.width,this.height)}}class rl extends zi{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(u.RepeatDot)}paint(e,t,s){const i=this.renderer,r=i.heightLineCount%2===0?1:.5,n=t+this.y+this.height/2,o=i.getLineHeight(r),l=i.smuflMetrics.glyphTop.get(u.RepeatDot),h=i.smuflMetrics.glyphHeights.get(u.RepeatDot),c=l-h/2;rt.fillMusicFontSymbolSafe(s,e+this.x,n+c-o,1,u.RepeatDot),rt.fillMusicFontSymbolSafe(s,e+this.x,n+c+o,1,u.RepeatDot)}}class kd extends zi{paint(e,t,s){const i=this.renderer;if(i.drawnLineCount-1<=2)return;const o=i.smuflMetrics.staffLineThickness/2,l=(i.drawnLineCount-1)/2,h=i.getLineY(l-1)-o,c=i.getLineY(l+1)+o;s.fillRect(e+this.x,t+h,i.smuflMetrics.thinBarlineThickness,c-h)}}class wd extends zi{paint(e,t,s){const r=this.renderer.getLineHeight(1),n=-(r/2)+1;s.fillRect(e+this.x,t+this.y+n,1,r)}}class Nn extends Oi{_isRight;constructor(e){super(),this._isRight=e}doLayout(){const e=this.renderer.bar,t=e.masterBar,s=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(this.renderer.index===0),i=this._isRight&&t.isRepeatEnd||!this._isRight&&t.isRepeatStart;let r=ce.Automatic;if(!this._isRight){const d=this.renderer.previousRenderer;if(d&&d.staff===this.renderer.staff&&(r=d.bar.getActualBarLineRight(),s===r))return}switch(this._isRight&&t.isRepeatEnd&&(this.addGlyph(new rl(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case ce.Dashed:this.addGlyph(new Sd(0,0));break;case ce.Dotted:this.addGlyph(new _d(0,0));break;case ce.Heavy:r!==ce.LightHeavy&&r!==ce.HeavyHeavy&&this.addGlyph(new Ir(0,0));break;case ce.HeavyHeavy:r!==ce.LightHeavy&&r!==ce.Heavy&&this.addGlyph(new Ir(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Ir(0,0));break;case ce.HeavyLight:r!==ce.LightHeavy&&r!==ce.Heavy&&r!==ce.HeavyHeavy&&this.addGlyph(new Ir(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Ar(0,0,i));break;case ce.LightHeavy:r!==ce.HeavyLight&&r!==ce.Regular&&r!==ce.LightLight&&this.addGlyph(new Ar(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new Ir(0,0));break;case ce.LightLight:r!==ce.HeavyLight&&r!==ce.Regular&&this.addGlyph(new Ar(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new Ar(0,0,i));break;case ce.None:break;case ce.Regular:r!==ce.HeavyLight&&r!==ce.LightLight&&this.addGlyph(new Ar(0,0,i));break;case ce.Short:this.addGlyph(new kd(0,0));break;case ce.Tick:this.addGlyph(new wd(0,0));break}this._isRight||t.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new rl(0,0)));const n=this.renderer,o=n.smuflMetrics.staffLineThickness,l=this.y+n.topPadding-o,c=this.y+this.renderer.height-this.renderer.bottomPadding-l;for(const d of this.glyphs)d.y=l,d.height=c}paint(e,t,s){const i=this.renderer,r=Se.bar(s,i.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(e,t,s)}finally{r?.[Symbol.dispose]?.()}}}class Bd extends ot{_count=0;constructor(e,t,s){super(e,t),this._count=0,this._count=s}doLayout(){this.width=0}paint(e,t,s){const i=Se.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const r=this.renderer.resources,n=s.textAlign;s.font=r.barNumberFont,s.textAlign=X.Right;const o=`x${this._count}`,l=s.measureText(o).width/1.5;s.fillText(o,e+this.x-l,t+this.y),s.textAlign=n}finally{i?.[Symbol.dispose]?.()}}}class al extends ot{_number;constructor(e,t,s){super(e,t),this._number=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number).width}paint(e,t,s){if(!this.renderer.staff.isFirstInSystem)return;const i=Se.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const r=this.renderer.resources,n=s.textBaseline;s.textBaseline=Re.Top,s.font=r.barNumberFont,s.fillText(this._number,e+this.x,t+this.y),s.textBaseline=n}finally{i?.[Symbol.dispose]?.()}}}class ni extends Oa{firstLineY=0;_startSpacing=!1;tupletSize=0;get lineOffset(){return this.lineSpacing}get tupletOffset(){return this.smuflMetrics.oneStaffSpace*.5}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(e-t)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(u.Tuplet0),super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,s){super.paintBackground(e,t,s),this.paintStaffLines(e,t,s),this.paintSimileMark(e,t,s)}paintStaffLines(e,t,s){const i=Se.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const r=[];for(let l=0,h=this.drawnLineCount;l<h;l++)r.push([]);this.additionalMultiRestBars||this.collectSpaces(r);for(const l of r)l.sort((h,c)=>h[0]>c[0]?1:h[0]<c[0]?-1:0);const n=this.width,o=this.smuflMetrics.staffLineThickness/2;for(let l=0;l<this.drawnLineCount;l++){const h=this.getLineY(l)-o;let c=0;for(const d of r[l])s.fillRect(e+this.x+c,t+this.y+h,d[0]-c,this.smuflMetrics.staffLineThickness),c=d[0]+d[1];s.fillRect(e+this.x+c,t+this.y+h,n-c,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(e){}createStartSpacing(){if(this._startSpacing)return;const e=this.index===0?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new ss(0,0,e)),this._startSpacing=!0}paintTuplets(e,t,s,i,r=!1){for(const n of this.bar.voices)if(this.hasVoiceContainer(n)){const o=this.getVoiceContainer(n);for(const l of o.tupletGroups)this._paintTupletHelper(e+this.beatGlyphsStart,t,s,l,i,r)}}getTupletBeamDirection(e){return this.getBeamDirection(e)}_paintTupletHelper(e,t,s,i,r,n){const o=this.resources,l=s.textAlign,h=s.textBaseline;s.color=i.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=X.Center,s.textBaseline=Re.Middle;let c;const d=i.beats[0].tupletNumerator,f=i.beats[0].tupletDenominator;if(d===2&&f===3)c=[u.Tuplet2];else if(d===3&&f===2)c=[u.Tuplet3];else if(d===4&&f===6)c=[u.Tuplet4];else if(d===5&&f===4)c=[u.Tuplet5];else if(d===6&&f===4)c=[u.Tuplet6];else if(d===7&&f===4)c=[u.Tuplet7];else if(d===9&&f===8)c=[u.Tuplet9];else if(d===10&&f===8)c=[u.Tuplet1,u.Tuplet0];else if(d===11&&f===8)c=[u.Tuplet1,u.Tuplet1];else if(d===12&&f===8)c=[u.Tuplet1,u.Tuplet2];else if(d===13&&f===8)c=[u.Tuplet1,u.Tuplet3];else{c=[];const b=u.Tuplet0;d>10?(c.push(b+Math.floor(d/10)),c.push(b+(d-10))):c.push(b+d),c.push(u.TupletColon),f>10?(c.push(b+Math.floor(f/10)),c.push(b+(f-10))):c.push(b+f)}const p=this.tupletOffset,g=this.tupletSize,m=Se.beat(s,r,i.beats[0]);try{const b=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,i.beats.length===1||!i.isFull)for(const S of i.beats){const T=this.helpers.beamHelperLookup[i.voice.index].get(S.index);if(!T)continue;const C=this.getTupletBeamDirection(T),v=T.getBeatLineX(S);let G=this.calculateBeamYWithDirection(T,v,C);C===P.Down?G+=p+g:G-=p+g,s.fillMusicFontSymbols(e+this.x+v,t+this.y+G,1,c,!0)}else{const S=i.beats[0],T=i.beats[i.beats.length-1];let C=null,v=null;for(let Rs=0;Rs<i.beats.length;Rs++)if(!i.beats[Rs].isRest){C=i.beats[Rs];break}for(let Rs=i.beats.length-1;Rs>=0;Rs--)if(!i.beats[Rs].isRest){v=i.beats[Rs];break}let G=!1;C||(C=S,G=!0),v||(v=T);const W=this.getBeatX(S,me.OnNotes)-this.beatGlyphsStart,w=this.getBeatX(T,me.PostNotes)-this.beatGlyphsStart,se=this.helpers.beamHelperLookup[i.voice.index].get(C.index),Ne=this.helpers.beamHelperLookup[i.voice.index].get(v.index),ye=this.getTupletBeamDirection(se);let te=this.calculateBeamYWithDirection(se,W,ye),Ke=this.calculateBeamYWithDirection(Ne,w,ye);G&&(te=Math.max(te,Ke),Ke=te);const We=p+g*.5;ye===P.Down?(te+=We,Ke+=We):(te-=We,Ke-=We);const qt=c.reduce((Rs,au)=>Rs+o.engravingSettings.glyphWidths.get(au),0),Ss=o.engravingSettings.oneStaffSpace*.5,Dt=(W+w)/2,Xt=Dt-qt/2-Ss,Ci=Dt+qt/2+Ss,hi=(Ke-te)/(w-W),Ps=te-hi*W,At=hi*Xt+Ps,Xi=hi*Dt+Ps,Is=hi*Ci+Ps,ls=ye===P.Down?te-g*.5:te+g*.5,Bl=ye===P.Down?Ke-g*.5:Ke+g*.5,Tl=s.lineWidth%2===0?0:.5;e+=Tl,t+=Tl,Xt>W&&(s.beginPath(),s.moveTo(e+this.x+W,t+this.y+ls),n?s.quadraticCurveTo(e+this.x+(Xt+W)/2,t+this.y+At,e+this.x+Xt,t+this.y+At):(s.lineTo(e+this.x+W,t+this.y+te),s.lineTo(e+this.x+Xt,t+this.y+At)),s.moveTo(e+this.x+Ci,t+this.y+Is),n?s.quadraticCurveTo(e+this.x+(w+Ci)/2,t+this.y+Is,e+this.x+w,t+this.y+Bl):(s.lineTo(e+this.x+w,t+this.y+Ke),s.lineTo(e+this.x+w,t+this.y+Bl)),s.stroke()),s.fillMusicFontSymbols(e+this.x+Dt,t+this.y+Xi+g*.5,1,c,!0)}s.textAlign=l,s.textBaseline=h,s.lineWidth=b}finally{m?.[Symbol.dispose]?.()}}paintBeams(e,t,s,i,r){for(const n of this.helpers.beamHelpers)for(const o of n)this._paintBeamHelper(e+this.beatGlyphsStart,t,s,o,i,r)}drawBeamHelperAsFlags(e){return e.beats.length===1}_paintBeamHelper(e,t,s,i,r,n){s.color=i.voice.index===0?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isRestBeamHelper||(this.drawBeamHelperAsFlags(i)?this.paintFlag(e,t,s,i,r):this.paintBar(e,t,s,i,n))}shouldPaintFlag(e,t){return!(e.graceType===$.BendGrace||e.deadSlapped||!t.hasBeatLineX(e)||e.graceType!==$.None&&this.settings.notation.notationMode===Et.SongBook||e.duration===y.Whole||e.duration===y.DoubleWhole||e.duration===y.QuadrupleWhole)}paintFlag(e,t,s,i,r){for(const n of i.beats){if(!this.shouldPaintFlag(n,i))continue;const o=n.graceType!==$.None,l=i.getBeatLineX(n),h=this.getBeamDirection(i),c=t+this.y+this.getFlagTopY(n,h),d=t+this.y+this.getFlagBottomY(n,h);let f=0;if(h===P.Down?f=d:f=c,!i.hasLine(!0,n))continue;this.paintBeamingStem(n,t+this.y,e+this.x+l,c,d,s);const p=Se.beat(s,r,n);try{let g=0;if(i.hasFlag(!0,n)){const m=new Fa(e+this.x+l,f,n.duration,h,o);m.renderer=this,m.doLayout(),m.paint(0,0,s),g=m.width/2}n.graceType===$.BeforeBeat&&(h===P.Down?rt.fillMusicFontSymbolSafe(s,e+this.x+l+g/2,(c+d-this.smuflMetrics.glyphHeights.get(u.GraceNoteSlashStemDown))/2,ve.GraceScale,u.GraceNoteSlashStemDown,!0):rt.fillMusicFontSymbolSafe(s,e+this.x+l+g/2,(c+d+this.smuflMetrics.glyphHeights.get(u.GraceNoteSlashStemUp))/2,ve.GraceScale,u.GraceNoteSlashStemUp,!0))}finally{p?.[Symbol.dispose]?.()}}}getFlagStemSize(e,t=!1){let s=0;switch(e){case y.QuadrupleWhole:case y.Half:case y.Quarter:case y.Eighth:case y.Sixteenth:case y.ThirtySecond:case y.SixtyFourth:case y.OneHundredTwentyEighth:case y.TwoHundredFiftySixth:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(e);break;default:s=t?this.smuflMetrics.standardStemLength:0;break}return s}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new Nn(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new al(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();const e=this.lastBar;this.addPostBeatGlyph(new Nn(!0)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Bd(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(e,t,s,i,r){const n=this.getBeamDirection(i),l=i.graceType!==$.None?ve.GraceScale:1;let h=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*l,c=this.smuflMetrics.beamThickness*l;n===P.Down&&(h=-h,c=-c);for(let d=0,f=i.beats.length;d<f;d++){const p=i.beats[d];if(!i.hasBeatLineX(p)||p.deadSlapped)continue;const g=i.getBeatLineX(p),m=t+this.y+this.getBarLineStart(p,n),b=t+this.y+this.calculateBeamY(i,g)|0;m<b?this.paintBeamingStem(p,t+this.y,e+this.x+g,m,b,s):this.paintBeamingStem(p,t+this.y,e+this.x+g,b,m,s);const S=Se.beat(s,r,p);try{const T=this.smuflMetrics.brokenBeamWidth*l,C=L.getIndex(p.duration)-2,v=t+this.y;for(let G=0;G<C;G++){let W=0,w=0,se=0,Ne=0;const ye=v+G*h;if(d<i.beats.length-1){const te=As.isFullBarJoin(p,i.beats[d+1],G);if(G===C-1&&te&&p.beamingMode===Xe.ForceSplitOnSecondaryToNext)W=g,w=W+T,se=ye+this.calculateBeamY(i,W),Ne=ye+this.calculateBeamY(i,w),ni.paintSingleBar(s,e+this.x+W,se,e+this.x+w,Ne,c),w=i.getBeatLineX(i.beats[d+1]),W=w-T,se=ye+this.calculateBeamY(i,W),Ne=ye+this.calculateBeamY(i,w),ni.paintSingleBar(s,e+this.x+W,se,e+this.x+w,Ne,c);else{if(te)W=g,w=i.getBeatLineX(i.beats[d+1]);else if(d===0||!As.isFullBarJoin(i.beats[d-1],p,G))W=g,w=W+T;else continue;se=ye+this.calculateBeamY(i,W),Ne=ye+this.calculateBeamY(i,w),G===0&&(se=se|0,Ne=Ne|0),ni.paintSingleBar(s,e+this.x+W,se,e+this.x+w,Ne,c)}}else d>0&&!As.isFullBarJoin(p,i.beats[d-1],G)&&(W=g-T,w=g,w=g,se=ye+this.calculateBeamY(i,W),Ne=ye+this.calculateBeamY(i,w),ni.paintSingleBar(s,e+this.x+W,se,e+this.x+w,Ne,c))}}finally{S?.[Symbol.dispose]?.()}}if(i.graceType===$.BeforeBeat){const d=i.getBeatLineX(i.beats[0]),f=this.smuflMetrics.glyphWidths.get(u.Flag8thUp)*ve.GraceScale;let p=t+this.y+this.calculateBeamY(i,d)|0;p+=c+h,n===P.Down?rt.fillMusicFontSymbolSafe(s,e+this.x+d+f/2,p,ve.GraceScale,u.GraceNoteSlashStemDown,!0):rt.fillMusicFontSymbolSafe(s,e+this.x+d+f/2,p,ve.GraceScale,u.GraceNoteSlashStemUp,!0)}}static paintSingleBar(e,t,s,i,r,n){e.beginPath(),e.moveTo(t,s),e.lineTo(i,r),e.lineTo(i,r+n),e.lineTo(t,s+n),e.closePath(),e.fill()}}class St extends ot{startBeat;endBeat;yOffset=0;forEnd;startNoteRenderer=null;endNoteRenderer=null;tieDirection=P.Up;constructor(e,t,s){super(0,0),this.startBeat=e,this.endBeat=t,this.forEnd=s}_startX=0;_startY=0;_endX=0;_endY=0;_tieHeight=0;_shouldDraw=!1;doLayout(){if(this.width=0,!this.endBeat){this._shouldDraw=!1;return}const e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=e;const t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,!t||e.staff!==t.staff?(this._endX=e.x+e.width,this._endY=this._startY):(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):(!e||e.staff!==t.staff)&&(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw)if(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur())this._tieHeight=0;else{this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY);const s=St.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,this.tieDirection===P.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness);if(this.height=s.h,this.tieDirection===P.Up){const i=this.y-s.y;i>0&&(this.y-=i)}}}paint(e,t,s){this._shouldDraw&&(this.shouldDrawBendSlur()?St.drawBendSlur(s,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===P.Down,1,this.renderer.smuflMetrics.tieHeight):St.paintTie(s,1,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===P.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(e,t){return P.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,s,i,r,n,o,l){const h=St._computeBezierControlPoints(e,t,s,i,r,n,o,l);t=h[0],s=h[1];const c=h[2],d=h[3];i=h[6],r=h[7];const f=(t-c)/(t-2*c+i),p=St._calculateExtrema(t,s,c,d,i,r,f),g=p.length>0?Math.min(t,i,p[0]):Math.min(t,i),m=p.length>0?Math.max(t,i,p[0]):Math.max(t,i),b=(s-d)/(s-2*d+r),S=St._calculateExtrema(t,s,c,d,i,r,b),T=S.length>0?Math.min(s,r,S[1]):Math.min(s,r),C=S.length>0?Math.max(s,r,S[1]):Math.max(s,r),v=new Mt;return v.x=g,v.y=T,v.w=m-g,v.h=C-T,v}static _calculateExtrema(e,t,s,i,r,n,o){if(o<=0||1<=o)return[];const l=e+(s-e)*o,h=t+(i-t)*o,c=s+(r-s)*o,d=i+(n-i)*o;return[l+(c-l)*o,h+(d-h)*o]}static _computeBezierControlPoints(e,t,s,i,r,n,o,l){if(t===i&&s===r)return[];if(i<t){let G=t;t=i,i=G,G=s,s=r,r=G}o*=e,l*=e,n&&(o*=-1,l*=-1),e>=1&&(l*=1.2);const h=r-s,c=i-t,d=Math.sqrt(c*c+h*h);let f=t+d*.25,p=s-o,g=t+d*.75,m=s-o,b=t+d*.75,S=s-o-l,T=t+d*.25,C=s-o-l;const v=Math.atan2(h,c);return[f,p]=St._rotate(f,p,t,s,v),[g,m]=St._rotate(g,m,t,s,v),[b,S]=St._rotate(b,S,t,s,v),[T,C]=St._rotate(T,C,t,s,v),[t,s,f,p,g,m,i,r,b,S,T,C,t,s]}static _rotate(e,t,s,i,r){const n=e-s,o=t-i,l=n*Math.cos(r)-o*Math.sin(r),h=n*Math.sin(r)+o*Math.cos(r);return[s+l,i+h]}static paintTie(e,t,s,i,r,n,o,l,h){const c=St._computeBezierControlPoints(t,s,i,r,n,o,l,h);e.beginPath(),e.moveTo(c[0],c[1]),e.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]),e.bezierCurveTo(c[8],c[9],c[10],c[11],c[12],c[13]),e.closePath(),e.fill()}static drawBendSlur(e,t,s,i,r,n,o,l,h){let c=r-s,d=i-t;const f=Math.sqrt(c*c+d*d);n?c*=-1:d*=-1,c/=f,d/=f;const p=(i+t)/2,g=(r+s)/2;let m=l*o;i-t<20&&(m/=2);const b=p+m*c,S=g+m*d;if(e.beginPath(),e.moveTo(t,s),e.lineTo(b,S),e.lineTo(i,r),e.stroke(),h){const T=e.measureText(h).width,C=n?0:-e.font.size;e.fillText(h,b-T/2,S+C)}}}class Pn extends St{startNote;endNote;constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return P.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,R.Top)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,Qe.Center)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,Qe.Left):this.endNoteRenderer.getNoteX(this.endNote,Qe.Center)}}class oi extends St{startNote;endNote;constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return this._isLeftHandTap?P.Up:oi.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return e.string>3?P.Up:P.Down}getStartY(){return this._isLeftHandTap?this.startNoteRenderer.getNoteY(this.startNote,R.Center):this.tieDirection===P.Up?this.startNoteRenderer.getNoteY(this.startNote,R.Top):this.startNoteRenderer.getNoteY(this.startNote,R.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,Qe.Center)}getEndX(){return this._isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,Qe.Left):this.endNoteRenderer.getNoteX(this.endNote,Qe.Center)}}class nl extends oi{_direction;_forSlide;constructor(e,t,s,i=!1){super(e,t,i),this._direction=P.Up,this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id)return!1;switch(this._direction){case P.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case P.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break}return!0}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),r=this.getBeamDirection(this.startBeat,i),n=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${r}`,o=this.renderer;o.staff.getSharedLayoutData(n,!1)||(o.staff.setSharedLayoutData(n,!0),super.paint(e,t,s))}}class Td extends xs{_effectSlurs=[];createTies(e){if(e.isVisible){if(e.isTieOrigin&&e.tieDestination.isVisible){const t=new Pn(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination){const t=new Pn(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){const t=new Pn(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){const s=new nl(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(s),this.addTie(s)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){const s=new nl(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(s),this.addTie(s)}}}}}class xd extends ot{_isGrace;_beat;_number;constructor(e,t,s,i,r){super(e,t),this._isGrace=i,this._number=s,this._beat=r}paint(e,t,s){const i=this._beat.isRest?Se.beat(s,Je.NumberedRests,this._beat):this._beat.notes.length>0?Se.note(s,Vt.NumberedNumber,this._beat.notes[0]):void 0;try{const r=this.renderer.resources;s.font=this._isGrace?r.numberedNotationGraceFont:r.numberedNotationFont,s.textBaseline=Re.Middle,s.textAlign=X.Left,s.fillText(this._number.toString(),e+this.x,t+this.y)}finally{i?.[Symbol.dispose]?.()}}doLayout(){const e=this.renderer.resources,t=this._isGrace?e.numberedNotationGraceFont:e.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=t;const i=s.measureText(`${this._number}`);this.height=i.height,this.width=i.width}}class ol{x=0;y=-3e3;width=0}class Cn extends Ms{constructor(){super(0,0)}doLayout(){if(!this.glyphs||this.glyphs.length===0){this.width=0;return}this.glyphs.sort((s,i)=>s.y<i.y?-1:s.y>i.y?1:0);const e=[];e.push(new ol);for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s];r.renderer=this.renderer,r.doLayout();let n=0;for(;e[n].y>r.y;)n++,n===e.length&&e.push(new ol);r.x=n,e[n].y=r.y+r.height,e[n].width<r.width&&(e[n].width=r.width)}this.width=0;const t=this.renderer.smuflMetrics.accidentalPadding;for(const s of e)this.width+=s.width+t,s.x=this.width;for(let s=0,i=this.glyphs.length;s<i;s++){const r=this.glyphs[s],n=e[r.x];r.x=this.width-n.x}}}class Xs extends gt{constructor(e,t,s,i){super(e,t,i,Xs.getMusicSymbol(s))}static getMusicSymbol(e){switch(e){case K.Natural:return u.AccidentalNatural;case K.Sharp:return u.AccidentalSharp;case K.Flat:return u.AccidentalFlat;case K.NaturalQuarterNoteUp:return u.AccidentalQuarterToneSharpNaturalArrowUp;case K.SharpQuarterNoteUp:return u.AccidentalThreeQuarterTonesSharpArrowUp;case K.FlatQuarterNoteUp:return u.AccidentalQuarterToneFlatArrowUp;case K.DoubleSharp:return u.AccidentalDoubleSharp;case K.DoubleFlat:return u.AccidentalDoubleFlat}return u.None}}class Rr extends gt{constructor(e,t){super(e,t,1,u.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class Nd extends ot{_beat;constructor(e,t,s){super(e,t),this._beat=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(e,t,s){const i=Se.beat(s,Je.NumberedDuration,this._beat);try{const r=this.renderer.smuflMetrics.numberedDashGlyphPadding;s.fillRect(e+this.x,Math.ceil(t+this.y-this.height),this.width-r,this.height)}finally{i?.[Symbol.dispose]?.()}}}class Ua extends ot{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(u.NoteheadSlashWhiteHalf)}paint(e,t,s){const i=this.renderer,r=i.getLineHeight(i.heightLineCount-1),n=i.getLineY(0),o=i.getLineHeight(i.drawnLineCount-1),l=n+o/2-r/2,h=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(e+this.x,t+l),s.lineTo(e+this.x+this.width,t+l+r),s.moveTo(e+this.x,t+l+r),s.lineTo(e+this.x+this.width,t+l),s.stroke(),s.lineWidth=h}}class Pd extends ki{isNaturalizeAccidental=!1;accidental=K.None;get effectElement(){return Je.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const e=new Cn;if(e.renderer=this.renderer,this.container.beat.notes.length>0){const t=this.container.beat.notes[0],s=t?t.accidentalMode:re.Default,i=Rt.getNoteValue(t);let r=L.computeAccidental(this.renderer.bar.keySignature,s,i,t.hasQuarterToneOffset);if(r===K.Natural&&(r=this.renderer.bar.keySignature+7<7?K.Sharp:K.Flat,this.isNaturalizeAccidental=!0),r!==K.None){this.accidental=r;const n=this.renderer,o=Se.noteColor(n.resources,Vt.NumberedAccidentals,t),l=new Xs(0,n.getLineY(0),r,t.beat.graceType!==$.None?ve.GraceScale*ve.GraceScale:ve.GraceScale);l.colorOverride=o,l.renderer=this.renderer,e.addGlyph(l),this.addNormal(e),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}class Wr extends wi{noteHeads=null;deadSlapped=null;octaveDots=0;get effectElement(){return Je.NumberedEffects}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let i=s.x;switch(t){case Qe.Left:break;case Qe.Center:i+=s.width/2;break;case Qe.Right:i+=s.width;break}return i}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new dr;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Mt,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this._internalGetNoteY(R.Center)}getHighestNoteY(){return this._internalGetNoteY(R.Center)}getNoteY(e,t){return this._internalGetNoteY(t)}_internalGetNoteY(e){let t=null;if(this.noteHeads?t=this.noteHeads:this.deadSlapped&&(t=this.deadSlapped),t){let s=this.y+t.y;switch(e){case R.Top:case R.TopWithStem:s-=t.height/2;break;case R.Center:break;case R.Bottom:case R.BottomWithStem:s+=t.height/2;break;case R.StemUp:case R.StemDown:break}return s}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null;this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+e.x,this.container.x+this.x+e.x+e.width)}}static majorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61];static minorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];doLayout(){const e=this.renderer;e.shortestDuration<this.container.beat.duration&&(e.shortestDuration=this.container.beat.duration);const t=e.getLineY(e.getNoteLine());if(!this.container.beat.isEmpty){let s="0";if(this.container.beat.notes.length>0){const n=this.renderer.bar.keySignatureType,o=this.renderer.bar.keySignature,l=o+7,c=(n===Qt.Minor?Wr.minorKeySignatureOneValues:Wr.majorKeySignatureOneValues)[l],d=this.container.beat.notes[0];if(d.isDead)s="X";else{const f=d.displayValue-c,p=f<0?(f%12+12)%12:f%12;let g=f<0?(Math.abs(f)+12)/12|0:f/12|0;f<0&&(g*=-1),this.octaveDots=g,e.registerOctave(g);let b=(L.keySignatureIsSharp(o)||L.keySignatureIsNatural(o)?Rt.flatNoteSteps:Rt.sharpNoteSteps)[p]+1;L.accidentalNotes[p]&&!this.container.preNotes.isNaturalizeAccidental&&(l<7?b++:b--),s=b.toString()}}if(this.container.beat.deadSlapped){const n=new Ua;n.renderer=this.renderer,n.doLayout(),this.deadSlapped=n,this.addEffect(n)}else{const n=this.container.beat.graceType!==$.None,o=new xd(0,t,s,n,this.container.beat);this.noteHeads=o,this.addNormal(o)}if(this.container.beat.dots>0&&this.container.beat.duration>=y.Quarter)for(let n=0;n<this.container.beat.dots;n++){const o=new Rr(0,e.getLineY(0));o.renderer=this.renderer,this.addEffect(o)}let i=0;switch(this.container.beat.duration){case y.QuadrupleWhole:i=16;break;case y.DoubleWhole:i=8;break;case y.Whole:i=4;break;case y.Half:i=2;break}let r=i;for(let n=0;n<this.container.beat.dots;n++)r=r/2|0,i+=r;for(let n=0;n<i-1;n++){const o=new Nd(0,e.getLineY(0),this.container.beat);o.renderer=this.renderer,this.addNormal(o)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class En extends ot{_isOpen;colorOverride;constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this._isOpen?St.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y+this.height,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):St.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class ll extends Ms{_numerator=0;_denominator=0;_isCommon;_isFreeTime;barSubElement=Pe.StandardNotationTimeSignature;constructor(e,t,s,i,r,n){super(e,t),this._numerator=s,this._denominator=i,this._isCommon=r,this._isFreeTime=n}paint(e,t,s){const i=Se.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this._isCommon&&this._numerator===2&&this._denominator===2){const e=new gt(0,0,this.commonScale,u.TimeSigCutCommon);this.addGlyph(e),super.doLayout()}else if(this._isCommon&&this._numerator===4&&this._denominator===4){const e=new gt(0,0,this.commonScale,u.TimeSigCommon);this.addGlyph(e),super.doLayout()}else{const e=new or(0,0,this._numerator,Re.Top,this.numberScale),t=new or(0,0,this._denominator,Re.Bottom,this.numberScale);this.addGlyph(e),this.addGlyph(t),super.doLayout();const s=this.width;e.x=(s-e.width)/2,t.x=(s-t.width)/2,this.width=Math.max(e.x+e.width,t.x+t.width)}if(this._isFreeTime){const e=this.renderer.smuflMetrics.oneStaffSpace*2,t=new En(!0);t.renderer=this.renderer,t.y=-e,t.height=e*2,t.doLayout();for(const i of this.glyphs)i.x+=t.width;this.width+=t.width,this.addGlyph(t);const s=new En(!1);s.renderer=this.renderer,s.x=this.width,s.y=-e,s.height=e*2,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class vn extends ll{get commonScale(){return 1}get numberScale(){return 1}}class Cd extends ot{_keySignature;_keySignatureType;_text="";_accidental=K.None;_accidentalOffset=0;constructor(e,t,s,i){super(e,t),this._keySignature=s,this._keySignatureType=i}doLayout(){super.doLayout();const e="1 = ";let t="",s=K.None;switch(this._keySignatureType){case Qt.Major:switch(this._keySignature){case He.Cb:t="  C",s=K.Flat;break;case He.Gb:t="  G",s=K.Flat;break;case He.Db:t="  D",s=K.Flat;break;case He.Ab:t="  A",s=K.Flat;break;case He.Eb:t="  E",s=K.Flat;break;case He.Bb:t="  B",s=K.Flat;break;case He.F:t="F";break;case He.C:t="C",s=K.None;break;case He.G:t="G",s=K.None;break;case He.D:t="D",s=K.None;break;case He.A:t="A",s=K.None;break;case He.E:t="E",s=K.None;break;case He.B:t="B",s=K.None;break;case He.FSharp:t="  F",s=K.Sharp;break;case He.CSharp:t="  C",s=K.Sharp;break}break;case Qt.Minor:switch(this._keySignature){case He.Cb:t="  a",s=K.Flat;break;case He.Gb:t="  e",s=K.Flat;break;case He.Db:t="  b",s=K.Flat;break;case He.Ab:t="f",s=K.None;break;case He.Eb:t="c",s=K.None;break;case He.Bb:t="g",s=K.None;break;case He.F:t="d";break;case He.C:t="a",s=K.None;break;case He.G:t="e",s=K.None;break;case He.D:t="b",s=K.None;break;case He.A:t="  f",s=K.Sharp;break;case He.E:t="  c",s=K.Sharp;break;case He.B:t="  g",s=K.Sharp;break;case He.FSharp:t="  d",s=K.Sharp;break;case He.CSharp:t="  a",s=K.Sharp;break}break}this._text=e+t,this._accidental=s;const i=this.renderer.scoreRenderer.canvas,r=this.renderer.resources;i.font=r.numberedNotationFont,this._accidentalOffset=i.measureText(e).width,this.width=i.measureText(e+t).width}paint(e,t,s){const i=Se.bar(s,Pe.NumberedKeySignature,this.renderer.bar);try{const r=this.renderer.resources;s.font=r.numberedNotationFont,s.textBaseline=Re.Middle,s.fillText(this._text,e+this.x,t+this.y),this._accidental!==K.None&&rt.fillMusicFontSymbolSafe(s,e+this.x+this._accidentalOffset,t+this.y,1,Xs.getMusicSymbol(this._accidental),!1)}finally{i?.[Symbol.dispose]?.()}}}class hl extends ni{static StaffId="numbered";simpleWhammyOverflow=0;_isOnlyNumbered;shortestDuration=y.QuadrupleWhole;lowestOctave=null;highestOctave=null;get dotSpacing(){return this.smuflMetrics.glyphHeights.get(u.AugmentationDot)*2}registerOctave(e){this.lowestOctave===null?(this.lowestOctave=e,this.highestOctave=e):(e<this.lowestOctave&&(this.lowestOctave=e),e>this.highestOctave&&(this.highestOctave=e))}get repeatsBarSubElement(){return Pe.NumberedRepeats}get barNumberBarSubElement(){return Pe.NumberedBarNumber}get barLineBarSubElement(){return Pe.NumberedBarLines}get staffLineBarSubElement(){return Pe.NumberedStaffLine}constructor(e,t){super(e,t),this._isOnlyNumbered=!t.staff.showSlash&&!t.staff.showTablature&&!t.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Je.NumberedDuration,Je.NumberedDuration),this.paintTuplets(e,t,s,Je.NumberedTuplet,!0)}doLayout(){super.doLayout();let e=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}if(e&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){const t=L.getIndex(this.shortestDuration)-2,s=this.dotSpacing;if(t>0){const r=this.smuflMetrics.numberedBarRendererBarSpacing,n=this.smuflMetrics.numberedBarRendererBarSize,o=(t-1)*r+n;let l=0;const h=this.lowestOctave;h!==null&&(l=Math.abs(h)*s+this.smuflMetrics.glyphHeights.get(u.AugmentationDot)),this.registerOverflowBottom(o+l)}const i=this.highestOctave;if(i!==null){const r=Math.abs(i)*s+this.smuflMetrics.glyphHeights.get(u.AugmentationDot);this.registerOverflowTop(r)}}}paintFlag(e,t,s,i,r){this.paintBar(e,t,s,i,r)}paintBar(e,t,s,i,r){if(i.beats.length===0)return;const n=this.resources;for(let o=0,l=i.beats.length;o<l;o++){const h=i.beats[o],c=Se.beat(s,r,h);try{const d=this.smuflMetrics.numberedBarRendererBarSpacing,f=this.smuflMetrics.numberedBarRendererBarSize,p=L.getIndex(h.duration)-2,g=t+this.y,m=this.getBeatX(h,me.PreNotes)-this.beatGlyphsStart,b=this.calculateBeamY(i,m);for(let w=0;w<p;w++){let se=0,Ne=0,ye=0;const te=g+w*d;o===i.beats.length-1?(se=m,Ne=this.getBeatX(h,me.PostNotes)-this.beatGlyphsStart):(se=m,Ne=this.getBeatX(i.beats[o+1],me.PreNotes)-this.beatGlyphsStart),ye=te+b,s.fillRect(e+this.x+se,ye,Ne-se,f)}const S=this.getBeatContainer(h).onNotes;let T=S instanceof Wr?S.octaveDots:0;const C=this.dotSpacing;let v=0,G=0;T>0?(v=g+this.getLineY(0)-n.numberedNotationFont.size,G=C*-1):T<0&&(v=g+b+p*(d+f),G=C);const W=this.getBeatX(h,me.MiddleNotes)-this.beatGlyphsStart;T=Math.abs(T);for(let w=0;w<T;w++)rt.fillMusicFontSymbolSafe(s,e+this.x+W,v,1,u.AugmentationDot,!0),v+=G}finally{c?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+this.resources.numberedNotationFont.size*1.5}getFlagTopY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(e){return P.Down}getTupletBeamDirection(e){return P.Up}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){const i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size}getBarLineStart(e,t){const s=this.smuflMetrics.glyphHeights.get(u.NoteheadBlack);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(this.index===0||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new Nn(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new al(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){(!this.bar.previousBar||this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){this.addPreBeatGlyph(new Cd(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.oneStaffSpace));const e=this.bar.masterBar,t=new vn(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(e.previousMasterBar==null||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=Pe.NumberedTimeSignature,this.addPreBeatGlyph(t)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){for(const t of e.beats){const s=new Td(t,this.getVoiceContainer(e));s.preNotes=e.index===0?new Pd:new ki,s.onNotes=e.index===0?new Wr:new wi,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,r,n){}}class Ed extends vr{get staffId(){return hl.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new hl(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showNumbered}}class Dn extends gt{_clef;_clefOttava;constructor(e,t,s,i){super(e,t,1,Dn._getSymbol(s,i)),this._clef=s,this._clefOttava=i}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(u.GClef),this.offsetX=this.width/2}static _getSymbol(e,t){switch(e){case Te.Neutral:return u.UnpitchedPercussionClef1;case Te.C3:case Te.C4:switch(t){case ae._8vb:return u.CClef8vb;default:return u.CClef}case Te.F4:switch(t){case ae._15ma:return u.FClef15ma;case ae._8va:return u.FClef8va;case ae._8vb:return u.FClef8vb;case ae._15mb:return u.FClef15mb;default:return u.FClef}case Te.G2:switch(t){case ae._15ma:return u.GClef15ma;case ae._8va:return u.GClef8va;case ae._8vb:return u.GClef8vb;case ae._15mb:return u.GClef15mb;default:return u.GClef}default:return u.None}}paint(e,t,s){const i=Se.bar(s,Pe.StandardNotationClef,this.renderer.bar);try{switch(super.paint(e,t,s),this._clef){case Te.C3:case Te.C4:switch(this._clefOttava){case ae._8vb:return}break;case Te.F4:case Te.G2:return}let r,n=!1;switch(this._clefOttava){case ae._15ma:r=u.Clef15,n=!0;break;case ae._8va:r=u.Clef8,n=!0;break;case ae._8vb:r=u.Clef8;break;case ae._15mb:r=u.Clef15;break;default:return}const o=this.width/2,l=n?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(r);rt.fillMusicFontSymbolSafe(s,e+this.x+o,t+this.y-l,1,r,!0)}finally{i?.[Symbol.dispose]?.()}}}class Or extends us{_note;constructor(e,t,s){super(e,t),this._note=s}static _getSymbol(e,t){switch(e){case tt.None:return u.None;case tt.Normal:return t?u.ArticAccentAbove:u.ArticAccentBelow;case tt.Heavy:return t?u.ArticMarcatoAbove:u.ArticMarcatoBelow;case tt.Tenuto:return t?u.ArticTenutoAbove:u.ArticTenutoBelow;default:return u.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(u.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(u.ArticAccentAbove)}paint(e,t,s){const i=this.renderer.getBeatDirection(this._note.beat),r=Or._getSymbol(this._note.accentuated,i===P.Down),n=i===P.Up?t+this.y:t+this.y+this.height;rt.fillMusicFontSymbolSafe(s,e+this.x,n,1,r,!0)}}class vd extends gt{constructor(e,t,s){super(e,t,s?ve.GraceScale:1,u.NoteheadXOrnate)}}class za extends gt{constructor(e,t,s,i){super(e,t,i?ve.GraceScale:1,za._getSymbol(s))}static _getSymbol(e){switch(e){case y.QuadrupleWhole:case y.DoubleWhole:case y.Whole:case y.Half:return u.NoteheadDiamondWhiteWide;default:return u.NoteheadDiamondBlackWide}}}class cl{line=0;isGhost;color;constructor(e,t,s){this.line=e,this.isGhost=t,this.color=s}}class Ya extends ot{_isOpen;_infos=[];_glyphs=[];isEmpty=!0;constructor(e){super(0,0),this._isOpen=e}addParenthesis(e){const t=this.renderer,s=t.getNoteLine(e),i=e.isGhost||this._isTiedBend(e)&&t.settings.notation.isNotationElementVisible(fe.ParenthesisOnTiedBends),r=Se.noteColor(t.resources,Vt.Effects,e);this._add(new cl(s,i,r))}addParenthesisOnLine(e,t){const s=new cl(e,t,void 0);this._add(s)}_add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}_isTiedBend(e){return e.isTieDestination?e.tieOrigin.hasBend?!0:this._isTiedBend(e.tieOrigin):!1}doLayout(){const e=this.renderer;this._infos.sort((i,r)=>i.line-r.line);let t=null;const s=e.getScoreHeight(1);for(let i=0,r=this._infos.length;i<r;i++){let n;if(!this._infos[i].isGhost)t=null;else if(!t)n=new En(this._isOpen),n.colorOverride=this._infos[i].color,n.renderer=this.renderer,n.y=e.getScoreY(this._infos[i].line)-s,n.height=s*2,n.doLayout(),this._glyphs.push(n),t=n;else{const o=e.getScoreY(this._infos[i].line)+s;t.height=o-t.y}}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,s){super.paint(e,t,s);for(const i of this._glyphs)i.paint(e+this.x,t+this.y,s)}}class Dd{glyph;steps=0;constructor(e,t){this.glyph=e,this.steps=t}}class dl extends ot{_infos=[];minNote=null;maxNote=null;upLineX=0;downLineX=0;noteStartX=0;constructor(){super(0,0)}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(e,t){const s=new Dd(e,t);this._infos.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this._infos.sort((f,p)=>p.steps-f.steps);let e=0,t=0,s=!0,i=0,r=!1;const n=this.direction,o=this.renderer.smuflMetrics,l=this.scale,h=new Map;for(let f=0,p=this._infos.length;f<p;f++){const g=this._infos[f].glyph;if(g.renderer=this.renderer,g.doLayout(),f>0&&Math.abs(i-this._infos[f].steps)<=1?s?(s=!1,h.set(f,!1)):(r=!0,s=!0,h.set(f,!0)):(s=!1,h.set(f,!1)),o.stemUp.has(g.symbol)){const b=o.stemUp.get(g.symbol).x*l;b>e&&(e=b)}else{const m=o.glyphWidths.get(g.symbol)*l;m>e&&(e=m)}if(o.stemDown.has(g.symbol)){const b=o.stemDown.get(g.symbol).x*l;if(b>t){const S=b-t;t=b,e+=S}}i=this._infos[f].steps}const c=r||n===P.Up?e:t;let d=0;for(let f=0,p=this._infos.length;f<p;f++){const g=this._infos[f].glyph;h.get(f)?g.x=c:(g.x=t,o.stemDown.has(g.symbol)&&(g.x-=o.stemDown.get(g.symbol).x*l)),g.x+=this.noteStartX,d=Math.max(d,g.x+g.width),g instanceof ve&&g.centerOnStem&&(g.x=c)}r?(this.upLineX=c,this.downLineX=c):(this.upLineX=e,this.downLineX=t),this.width=d}paint(e,t,s){e+=this.x,t+=this.y,this._paintLedgerLines(e,t,s);const i=this._infos;for(const r of i)r.glyph.renderer=this.renderer,r.glyph.paint(e,t,s)}_paintLedgerLines(e,t,s){if(!this.minNote)return;const i=this.renderer,r=Se.bar(s,Pe.StandardNotationStaffLine,i.bar,!0);try{const n=this.scale,o=this.renderer.smuflMetrics.legerLineExtension*n,l=this.width-this.noteStartX+o*2,h=i.getLineHeight(1),c=i.getLineY(-1),d=i.getLineY(i.drawnLineCount),f=i.getLineY(this.minNote.steps/2),p=i.getLineY(this.maxNote.steps/2),g=this.renderer.smuflMetrics.legerLineThickness*n/2;let m=c;for(;m>=f;)s.fillRect(e-o+this.noteStartX,t+m-g,l,this.renderer.smuflMetrics.legerLineThickness*n),m-=h;for(m=d;m<=p;)s.fillRect(e-o+this.noteStartX,t+m-g,l,this.renderer.smuflMetrics.legerLineThickness*n),m+=h}finally{r?.[Symbol.dispose]?.()}}}class Xa extends gt{constructor(e,t,s){super(e,t,1,Xa._getSymbol(s))}static _getSymbol(e){switch(e){case y.ThirtySecond:return u.Tremolo3;case y.Sixteenth:return u.Tremolo2;case y.Eighth:return u.Tremolo1;default:return u.None}}}class Ld extends dl{_noteGlyphLookup=new Map;_notes=[];_deadSlapped=null;_tremoloPicking=null;aboveBeatEffects=new Map;belowBeatEffects=new Map;beat;beamingHelper;get direction(){return this.beamingHelper.direction}get scale(){return this.beat.graceType!==$.None?ve.GraceScale:1}getNoteX(e,t){if(this._noteGlyphLookup.has(e.id)){const s=this._noteGlyphLookup.get(e.id);let i=this.x+s.x;switch(t){case Qe.Left:break;case Qe.Center:i+=s.width/2;break;case Qe.Right:i+=s.width;break}return i}return 0}getNoteY(e,t){if(this._noteGlyphLookup.has(e.id)){const s=this._noteGlyphLookup.get(e.id);return this._internalGetNoteY(s,t)}return 0}_internalGetNoteY(e,t){let s=this.y+e.y;const i=this.beat.graceType!==$.None?ve.GraceScale:1;switch(t){case R.TopWithStem:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i,s-=this.renderer.smuflMetrics.standardStemLength*i;const r=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(r,s);case R.Top:s-=e.height/2;break;case R.Center:break;case R.Bottom:s+=e.height/2;break;case R.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i,s+=this.renderer.smuflMetrics.standardStemLength*i;const n=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(n,s);case R.StemUp:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i;break;case R.StemDown:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i;break}return s}addMainNoteGlyph(e,t,s){super.add(e,s),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}addEffectNoteGlyph(e,t){super.add(e,t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();const e=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new Ua,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);let t=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=e.getScoreY(0),t=e.getScoreY(e.heightLineCount)):this.direction===P.Up?(s=this._internalGetNoteY(this.maxNote.glyph,R.Bottom)+i,t=this._internalGetNoteY(this.minNote.glyph,R.TopWithStem)-i):(s=this._internalGetNoteY(this.maxNote.glyph,R.BottomWithStem)+i,t=this._internalGetNoteY(this.minNote.glyph,R.Top)-i);let r=null,n=null;for(const o of this.aboveBeatEffects.values())o.renderer=this.renderer,o.doLayout(),t-=o.height,o.y=t,(r===null||r>t)&&(r=t),(n===null||n<t)&&(n=t),t-=i;for(const o of this.belowBeatEffects.values())o.renderer=this.renderer,o.doLayout(),o.y=s,(r===null||r>s)&&(r=s),(n===null||n<s)&&(n=s),s+=o.height+i;if(r!==null&&e.registerBeatEffectOverflows(r,n??0),this.beat.isTremolo&&!this.beat.deadSlapped){const o=this.direction;let l=0;if(o===P.Up){const d=this._internalGetNoteY(this.minNote.glyph,R.TopWithStem),f=this._internalGetNoteY(this.minNote.glyph,R.StemUp);l=(d+f)/2}else{const d=this._internalGetNoteY(this.maxNote.glyph,R.StemDown),f=this._internalGetNoteY(this.maxNote.glyph,R.BottomWithStem);l=(d+f)/2}let h=o===P.Up?this.upLineX:this.downLineX;const c=this.beat.tremoloSpeed;this.beat.duration<y.Half&&(h=this.width/2),this._tremoloPicking=new Xa(h,l,c),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,s){for(const i of this._notes)if(this._noteGlyphLookup.has(i.id)){const r=this._noteGlyphLookup.get(i.id),n=new dr;n.note=i,n.noteHeadBounds=new Mt,n.noteHeadBounds.x=t+this.x+r.x,n.noteHeadBounds.y=s+this.y+r.y-r.height/2,n.noteHeadBounds.w=r.width,n.noteHeadBounds.h=r.height,e.addNote(n)}}paint(e,t,s){this._paintEffects(e,t,s),super.paint(e,t,s)}_paintEffects(e,t,s){const i=Se.beat(s,Je.StandardNotationEffects,this.beat);try{for(const r of this.aboveBeatEffects.values())r.paint(e+this.x+this.width/2,t+this.y,s);for(const r of this.belowBeatEffects.values())r.paint(e+this.x+this.width/2,t+this.y,s);this._tremoloPicking&&this._tremoloPicking.paint(e,t,s),this._deadSlapped&&this._deadSlapped.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}class Vr extends gt{beamingHelper;constructor(e,t,s){super(e,t,1,Vr.getSymbol(s))}static getSymbol(e){switch(e){case y.QuadrupleWhole:return u.RestLonga;case y.DoubleWhole:return u.RestDoubleWhole;case y.Whole:return u.RestWhole;case y.Half:return u.RestHalf;case y.Quarter:return u.RestQuarter;case y.Eighth:return u.Rest8th;case y.Sixteenth:return u.Rest16th;case y.ThirtySecond:return u.Rest32nd;case y.SixtyFourth:return u.Rest64th;case y.OneHundredTwentyEighth:return u.Rest128th;case y.TwoHundredFiftySixth:return u.Rest256th;default:return u.None}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){this.internalPaint(e,t,s,Je.StandardNotationRests)}internalPaint(e,t,s,i){const r=Se.beat(s,i,this.beat);try{super.paint(e,t,s)}finally{r?.[Symbol.dispose]?.()}}}class xi extends dl{_beat;_showParenthesis=!1;_noteValueLookup=new Map;_accidentals=new Cn;_preNoteParenthesis=null;_postNoteParenthesis=null;isEmpty=!0;get scale(){return ve.GraceScale}get direction(){return P.Up}noteHeadOffset=0;constructor(e,t=!1){super(),this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new Ya(!0),this._postNoteParenthesis=new Ya(!1))}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t,s){const i=this.renderer,r=new ve(0,0,y.Quarter,!0),n=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),o=i.accidentalHelper.getNoteLineForValue(e,!1);if(r.y=i.getScoreY(o),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(o,!0),this._postNoteParenthesis.addParenthesisOnLine(o,!0)),n!==K.None){const l=new Xs(0,r.y,n,ve.GraceScale);l.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(l)}this._noteValueLookup.set(e,r),this.add(r,o),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(e,t,s){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,s),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,s),this._postNoteParenthesis.paint(e+this.x,t+this.y,s)),super.paint(e,t,s)}}class ul extends ot{bendNoteHeads=[];drawBendSlur(e,t,s,i,r,n,o,l){St.drawBendSlur(e,t,s,i,r,n,o,this.renderer.smuflMetrics.tieHeight,l)}doLayout(){super.doLayout(),this.width=0;for(const e of this.bendNoteHeads)e.doLayout(),this.width+=e.width}getTieDirection(e,t){switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}}class Fd extends ul{_beat;_endGlyph=null;constructor(e){super(0,0),this._beat=e}doLayout(){const e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case Le.None:case Le.Custom:case Le.Hold:return;case Le.Dive:case Le.PrediveDive:{const t=new xi(this._beat,!1);this._endGlyph=t,t.renderer=this.renderer;const s=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const i of this._beat.notes)i.isTieOrigin||t.addGlyph(this._getBendNoteValue(i,s),s.value%2!==0,void 0);t.doLayout(),this.bendNoteHeads.push(t)}break;case Le.Dip:if(e===Et.SongBook){const t=this.renderer.resources;this.renderer.simpleWhammyOverflow=t.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{const t=new xi(this._beat,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===Et.GuitarPro){const i=this._beat.whammyBarPoints[1];for(const r of this._beat.notes)t.addGlyph(this._getBendNoteValue(r,this._beat.whammyBarPoints[1]),i.value%2!==0,void 0)}t.doLayout(),this.bendNoteHeads.push(t);const s=new xi(this._beat,!1);if(s.renderer=this.renderer,this._endGlyph=s,this.renderer.settings.notation.notationMode===Et.GuitarPro){const i=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const r of this._beat.notes)s.addGlyph(this._getBendNoteValue(r,i),i.value%2!==0,void 0)}s.doLayout(),this.bendNoteHeads.push(s)}break;case Le.Predive:break}super.doLayout()}paint(e,t,s){const i=this._beat;switch(i.whammyBarType){case Le.None:case Le.Custom:return}const r=this.renderer.settings.notation.notationMode,n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,i.voice.bar),o=Se.beat(s,Je.StandardNotationEffects,i);try{const l=e+n.x+n.getBeatX(i,me.MiddleNotes),h=this.getTieDirection(i,n);let c=this._beat.notes.length===1?h:P.Up;const d=s.textAlign,f=this.renderer.smuflMetrics.glyphHeights.get(u.NoteheadBlack);for(let p=0;p<i.notes.length;p++){const g=i.notes[p],m=Se.note(s,Vt.StandardNotationEffects,g);try{let b=t+n.y;p>0&&p>=(this._beat.notes.length/2|0)&&(c=P.Down),c===P.Down?b+=n.getNoteY(g,R.Bottom):b+=n.getNoteY(g,R.Top);let S=e+n.x;i.isLastOfVoice?S+=n.postBeatGlyphsStart:S+=n.getBeatX(i,me.EndBeat),this._endGlyph&&(S-=this._endGlyph.upLineX);const T=i.whammyStyle===ze.Gradual&&p===0?"grad.":"";let C=null;g.isTieOrigin&&(C=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,g.tieDestination.beat.voice.bar),C&&C.staff===n.staff?S=e+C.x+C.getBeatX(g.tieDestination.beat,me.MiddleNotes):C=null);let v=f*ve.GraceScale*.5;c===P.Up&&(v=-v);const G=i.whammyBarPoints.length>0?this._getBendNoteValue(g,i.whammyBarPoints[i.whammyBarPoints.length-1]):0;let W=0,w=!1;switch(this.bendNoteHeads.length>0&&this.bendNoteHeads[0].containsNoteValue(G)?(W=this.bendNoteHeads[0].getNoteValueY(G)+v,w=!0):C&&(g.isTieOrigin&&g.tieDestination.beat.hasWhammyBar||g.beat.isContinuedWhammy)?(W=t+C.y+C.getNoteY(g.tieDestination,R.Top),w=!0,c===P.Down&&(W+=f)):g.isTieOrigin&&(C?W=t+C.y+C.getNoteY(g.tieDestination,R.Top):W=b,c===P.Down&&(W+=f)),i.whammyBarType){case Le.Hold:g.isTieOrigin&&St.paintTie(s,1,l,b,S,W,h===P.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case Le.Dive:if(p===0){this.bendNoteHeads[0].x=S-this.bendNoteHeads[0].noteHeadOffset;const ye=this.bendNoteHeads[0].y;this.bendNoteHeads[0].y=t+n.y,this.bendNoteHeads[0].paint(0,0,s),this.bendNoteHeads[0].containsNoteValue(G)&&(W-=ye,W+=this.bendNoteHeads[0].y)}w?this.drawBendSlur(s,l,b,S,W,c===P.Down,1,T):g.isTieOrigin&&St.paintTie(s,1,l,b,S,W,h===P.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case Le.Dip:if(r===Et.SongBook){if(p===0){const ye=e+n.x+n.getBeatX(this._beat,me.OnNotes),te=e+n.x+n.getBeatX(this._beat,me.PostNotes),Ke=(ye+te)/2,We=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();s.font=this.renderer.resources.tablatureFont,s.fillText(We,Ke,t+this.y);const qt=t+this.y+s.font.size,Ss=qt+this.renderer.smuflMetrics.songBookWhammyDipHeight;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(s.moveTo(ye,Ss),s.lineTo(Ke,qt),s.lineTo(te,Ss)):(s.moveTo(ye,qt),s.lineTo(Ke,Ss),s.lineTo(te,qt)),s.stroke()}g.isTieOrigin&&St.paintTie(s,1,l,b,S,W,h===P.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)}else{const ye=(l+S)/2;this.bendNoteHeads[0].x=ye-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=t+n.y,this.bendNoteHeads[0].paint(0,0,s);const te=this._getBendNoteValue(g,i.whammyBarPoints[1]),Ke=this.bendNoteHeads[0].getNoteValueY(te)+v;this.drawBendSlur(s,l,b,ye,Ke,c===P.Down,1,T),this.bendNoteHeads[1].x=S-this.bendNoteHeads[1].noteHeadOffset,this.bendNoteHeads[1].y=t+n.y,this.bendNoteHeads[1].paint(0,0,s),W=this.bendNoteHeads[1].getNoteValueY(G)+v,this.drawBendSlur(s,ye,Ke,S,W,c===P.Down,1,T)}break;case Le.PrediveDive:case Le.Predive:let se=e+n.x+n.getBeatX(g.beat,me.PreNotes);se+=n.getPreNotesGlyphForBeat(g.beat).prebendNoteHeadOffset;const Ne=t+n.y+n.getScoreY(n.accidentalHelper.getNoteLineForValue(g.displayValue-(g.beat.whammyBarPoints[0].value/2|0),!1))+v;this.drawBendSlur(s,se,Ne,l,b,c===P.Down,1,T),this.bendNoteHeads.length>0&&(this.bendNoteHeads[0].x=S-this.bendNoteHeads[0].noteHeadOffset,this.bendNoteHeads[0].y=t+n.y,this.bendNoteHeads[0].paint(0,0,s),this.drawBendSlur(s,l,b,S,W,c===P.Down,1,T));break}}finally{m?.[Symbol.dispose]?.()}}s.textAlign=d}finally{o?.[Symbol.dispose]?.()}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class Md extends gt{_isGrace;_articulation;constructor(e,t,s,i,r){super(e,t,r?ve.GraceScale:1,s.getSymbol(i)),this._isGrace=r,this._articulation=s}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const r=this._isGrace?1:0;rt.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+r,this.glyphScale,this.symbol,!1),this._articulation.techniqueSymbol!==u.None&&this._articulation.techniqueSymbolPlacement===Ge.Inside&&rt.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+r,this.glyphScale,this._articulation.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),this.width===0&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(u.NoteheadBlack)),this.height===0&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(u.NoteheadBlack))}}class fl extends gt{constructor(e,t){super(e,t,ve.GraceScale,u.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class Ad extends gt{constructor(e,t){super(e,t,.5,u.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class Id extends us{_strings=new Set;addString(e){this._strings.add(e)}doLayout(){const e=this.renderer.smuflMetrics.glyphWidths.get(u.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(e+this.renderer.smuflMetrics.stringNumberCirclePadding)*this._strings.size,this.width=e}paint(e,t,s){const i=this.renderer.bar.staff.tuning.length;let r=0;const n=this.renderer.smuflMetrics.glyphWidths.get(u.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const o of this._strings){const l=i-o,h=u.GuitarString1+l;rt.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+n+r,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,h,!0),r+=n+this.renderer.smuflMetrics.stringNumberCirclePadding}}}class li extends gt{beatEffects=new Map;beamingHelper;noteHeadElement=Vt.SlashNoteHead;effectElement=Je.SlashEffects;_symbol;constructor(e,t,s,i,r){super(e,t,i?ve.GraceScale:1,li.getSymbol(s)),this._symbol=li.getSymbol(s),this.beat=r}paint(e,t,s){const i=this.beat.notes.length===0?void 0:Se.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(e,t,s),this._paintEffects(e,t,s)}finally{i?.[Symbol.dispose]?.()}}_paintEffects(e,t,s){const i=Se.beat(s,this.effectElement,this.beat);try{for(const r of this.beatEffects.values())r.paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const e=this.renderer.smuflMetrics.onNoteEffectPadding;let t=this.renderer.smuflMetrics.glyphHeights.get(this._symbol);for(const s of this.beatEffects.values())s.y+=t,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),t+=s.height+e}static getSymbol(e){switch(e){case y.QuadrupleWhole:case y.DoubleWhole:case y.Whole:return u.NoteheadSlashWhiteWhole;case y.Half:return u.NoteheadSlashWhiteHalf;default:return u.NoteheadSlashHorizontalEnds}}updateBeamingHelper(e){if(this.beamingHelper){const t=this._symbol,s=this.renderer.smuflMetrics.stemUp.has(t)?this.renderer.smuflMetrics.stemUp.get(t).x:0,i=this.renderer.smuflMetrics.stemDown.has(t)?this.renderer.smuflMetrics.stemDown.get(t).x:0;this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+s,e+this.x+i)}}}class Rd extends wi{_collisionOffset=-1e3;_skipPaint=!1;noteHeads=null;restGlyph=null;get effectElement(){return Je.StandardNotationEffects}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&this._collisionOffset===-1e3)){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;const e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}paint(e,t,s){this._skipPaint||super.paint(e,t,s)}doLayout(){const e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2)*2;this.container.beat.duration===y.Whole&&this.renderer.bar.staff.standardNotationLineCount!==1&&this.renderer.bar.staff.standardNotationLineCount!==3&&(t-=2);const s=new Vr(0,e.getScoreY(t),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(this.container.beat.voice.index===0){const i=As.computeLineHeightsForRest(this.container.beat.duration),r=s.y-e.getScoreHeight(i[0]),n=s.y+e.getScoreHeight(i[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,r,n)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),this.container.beat.dots>0)for(let i=0;i<this.container.beat.dots;i++){const r=new Ms(0,0);r.renderer=this.renderer,this._createBeatDot(t,r),this.addEffect(r)}}else{const t=new Ld;this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;const s=new Ya(!1);s.renderer=this.renderer;for(const i of this.container.beat.notes)i.isVisible&&(!i.beat.slashed||i.index===0)&&(this._createNoteGlyph(i),s.addParenthesis(i));if(this.addNormal(t),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const i=new Fd(this.container.beat);i.renderer=this.renderer,i.doLayout(),this.container.ties.push(i)}if(this.container.beat.dots>0)for(let i=0;i<this.container.beat.dots;i++){const r=new Ms(0,0);r.renderer=this.renderer;for(const n of this.container.beat.notes){const o=this._createBeatDot(e.getNoteLine(n),r);o.colorOverride=Se.noteColor(e.resources,Vt.StandardNotationEffects,n)}this.addEffect(r)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}_createBeatDot(e,t){const s=this.renderer,i=new Rr(0,s.getScoreY(e));return t.addGlyph(i),i}_createNoteHeadGlyph(e){const t=this.container.beat.graceType!==$.None,s=e.style;if(s?.noteHead!==void 0){const i=new ve(0,0,e.beat.duration,t);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(e.beat.voice.bar.staff.isPercussion){const i=ht.getArticulation(e);if(i)return new Md(0,0,i,e.beat.duration,t);E.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.beat.slashed?new li(0,0,e.beat.duration,t,e.beat):e.isDead?new vd(0,0,t):e.beat.graceType===$.BendGrace?new ve(0,0,y.Quarter,!0):e.harmonicType===Q.Natural?new za(0,0,e.beat.duration,t):new ve(0,0,e.beat.duration,t)}_createNoteGlyph(e){if(e.beat.graceType===$.BendGrace&&!e.hasBend)return;const t=this.renderer,s=this._createNoteHeadGlyph(e);s.colorOverride=Se.noteColor(t.resources,Vt.StandardNotationNoteHead,e);let i;if(e.beat.slashed?i=t.heightLineCount-1:i=t.getNoteLine(e),s.y=t.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,e,i),!e.beat.slashed&&e.harmonicType!==Q.None&&e.harmonicType!==Q.Natural){const l=e.displayValue+e.harmonicPitch,h=new za(0,0,e.beat.duration,this.container.beat.graceType!==$.None);h.colorOverride=s.colorOverride,i=t.accidentalHelper.getNoteLineForValue(l,!1),h.y=t.getScoreY(i),this.noteHeads.addEffectNoteGlyph(h,i)}const r=this.noteHeads.belowBeatEffects,n=this.noteHeads.aboveBeatEffects,o=this.beamingHelper.direction===P.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(e.isStaccato&&!r.has("Staccato")&&o.set("Staccato",new fl(0,0)),e.accentuated===tt.Normal&&!r.has("Accent")&&o.set("Accent",new Or(0,0,e)),e.accentuated===tt.Heavy&&!r.has("HAccent")&&o.set("HAccent",new Or(0,0,e)),e.accentuated===tt.Tenuto&&!r.has("Tenuto")&&o.set("Tenuto",new Or(0,0,e)),e.showStringNumber&&e.isStringed){let l;n.has("StringNumber")?l=n.get("StringNumber"):(l=new Id(0,0),n.set("StringNumber",l)),l.addString(e.string)}if(e.isPercussion){const l=ht.getArticulation(e);if(l&&l.techniqueSymbolPlacement!==Ge.Inside){let h;switch(l.techniqueSymbolPlacement){case Ge.Above:h=this.noteHeads.aboveBeatEffects;break;case Ge.Below:h=this.noteHeads.belowBeatEffects;break;case Ge.Outside:h=o;break;default:return}switch(l.techniqueSymbol){case u.PictEdgeOfCymbal:h.set("PictEdgeOfCymbal",new Ad(0,0));break;case u.ArticStaccatoAbove:h.set("ArticStaccatoAbove",new fl(0,0));break;case u.StringsUpBow:h.set("StringsUpBow",new Mr(0,0,kt.Up));break;case u.StringsDownBow:h.set("StringsDownBow",new Mr(0,0,kt.Down));break;case u.GuitarGolpe:h.set("GuitarGolpe",new Jo(0,0,!0));break}}}}}class Wd extends ot{_beat;_noteVibratoGlyph;constructor(e){super(0,0),this._beat=e}doLayout(){if(this._beat.brushType===Y.ArpeggioUp||this._beat.brushType===Y.ArpeggioDown){const e=new Ti(0,0,be.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e,this.width=e.height}else this.width=0}paint(e,t,s){if(this._beat.brushType===Y.ArpeggioUp||this._beat.brushType===Y.ArpeggioDown){const i=this.renderer,r=i.lineOffset,n=t+this.y+(i.getNoteY(this._beat.maxNote,R.Bottom)-r),o=t+this.y+i.getNoteY(this._beat.minNote,R.Top)+r,l=e+this.x+this.width/2,h=this.renderer.smuflMetrics.glyphWidths.get(u.ArrowheadBlackDown),c=this._noteVibratoGlyph;if(this._beat.brushType===Y.ArpeggioUp){const d=n+h,f=o-h;c.width=Math.abs(f-d),s.beginRotate(e+this.x,f,-90),c.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(l,o),s.lineTo(l+h/2,o-h),s.lineTo(l-h/2,o-h),s.closePath(),s.fill()}else if(this._beat.brushType===Y.ArpeggioDown){const d=n+h,f=o;c.width=Math.abs(f-d),s.beginRotate(e+this.x,d,90),c.paint(0,-c.height,s),s.endRotate(),s.beginPath(),s.moveTo(l,n),s.lineTo(l+h/2,n+h),s.lineTo(l-h/2,n+h),s.closePath(),s.fill()}}}}class Od extends ki{_prebends=null;get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return Je.StandardNotationEffects}accidentals=null;doLayout(){if(!this.container.beat.isRest){const e=new Cn;e.renderer=this.renderer;const t=new Fr;t.renderer=this.renderer;const s=new Ya(!0);s.renderer=this.renderer;const i=new xi(this.container.beat,!0);this._prebends=i,i.renderer=this.renderer;let r=!1;for(const n of this.container.beat.notes){const o=Se.noteColor(this.renderer.resources,Vt.StandardNotationEffects,n);if(n.isVisible){if(n.hasBend)switch(n.bendType){case q.PrebendBend:case q.Prebend:case q.PrebendRelease:i.addGlyph(n.displayValue-(n.bendPoints[0].value/2|0),!1,o);break}else if(n.beat.hasWhammyBar)switch(n.beat.whammyBarType){case Le.PrediveDive:case Le.Predive:this._prebends.addGlyph(n.displayValue-(n.beat.whammyBarPoints[0].value/2|0),!1,o);break}switch(this._createAccidentalGlyph(n,e),s.addParenthesis(n),t.addFingers(n),n.slideInType){case dt.IntoFromBelow:case dt.IntoFromAbove:r=!0;break}}}r&&this.addNormal(new ss(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==$.None?ve.GraceScale:1))),i.isEmpty||(this.addEffect(i),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1)))),this.container.beat.brushType!==Y.None&&(this.addEffect(new Wd(this.container.beat)),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1)))),t.isEmpty||(this.isEmpty||this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1))),this.addEffect(t),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1)))),s.isEmpty||this.addEffect(s),e.isEmpty||(this.accidentals=e,this.isEmpty||this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1))),this.addNormal(e),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==$.None?ve.GraceScale:1))))}super.doLayout()}_createAccidentalGlyph(e,t){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(e),r=s.getNoteLine(e);const n=this.container.beat.graceType!==$.None,o=Se.noteColor(s.resources,Vt.StandardNotationAccidentals,e),l=n?ve.GraceScale:1;if(i!==K.None){const h=new Xs(0,s.getScoreY(r),i,l);h.colorOverride=o,h.renderer=this.renderer,t.addGlyph(h)}if(e.harmonicType!==Q.None&&e.harmonicType!==Q.Natural){const h=e.displayValue+e.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(e.beat,h,n,!1),r=s.accidentalHelper.getNoteLineForValue(h,!1);const c=new Xs(0,s.getScoreY(r),i,l);c.colorOverride=o,c.renderer=this.renderer,t.addGlyph(c)}}}class Vd extends ul{_beat;_notes=[];_endNoteGlyph=null;_middleNoteGlyph=null;constructor(e){super(0,0),this._beat=e}addBends(e){if(this._notes.push(e),e.isTieOrigin)return;const t=Se.noteColor(this.renderer.resources,Vt.StandardNotationEffects,e);switch(e.bendType){case q.Bend:case q.PrebendRelease:case q.PrebendBend:{let s=this._endNoteGlyph;s||(s=new xi(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.bendNoteHeads.push(s));const i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this._getBendNoteValue(e,i),i.value%2!==0,t)}break;case q.Release:if(!e.isTieOrigin){let s=this._endNoteGlyph;s||(s=new xi(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.bendNoteHeads.push(s));const i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this._getBendNoteValue(e,i),i.value%2!==0,t)}break;case q.BendRelease:{let s=this._middleNoteGlyph;s||(s=new xi(e.beat,!1),this._middleNoteGlyph=s,s.renderer=this.renderer,this.bendNoteHeads.push(s));const i=e.bendPoints[1];s.addGlyph(this._getBendNoteValue(e,e.bendPoints[1]),i.value%2!==0,t);let r=this._endNoteGlyph;r||(r=new xi(e.beat,!1),r.renderer=this.renderer,this._endNoteGlyph=r,this.bendNoteHeads.push(r));const n=e.bendPoints[e.bendPoints.length-1];r.addGlyph(this._getBendNoteValue(e,n),n.value%2!==0,t)}break}}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),r=e+i.x+i.getBeatX(this._beat,me.MiddleNotes);let n=e+i.x;this._beat.isLastOfVoice?n+=i.postBeatGlyphsStart:n+=i.getBeatX(this._beat.nextBeat,me.PreNotes),this._endNoteGlyph&&(n-=this._endNoteGlyph.upLineX);const o=(r+n)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=o-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+i.y,this._middleNoteGlyph.paint(0,0,s)),this._endNoteGlyph&&(this._endNoteGlyph.x=n-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+i.y,this._endNoteGlyph.paint(0,0,s)),this._notes.sort((d,f)=>f.displayValue-d.displayValue);const l=this._beat.graceType===$.BendGrace?this._beat.nextBeat:this._beat;let h=this._notes.length===1?this.getTieDirection(l,i):P.Up;const c=this.renderer.smuflMetrics.glyphHeights.get(u.NoteheadBlack);for(let d=0;d<this._notes.length;d++){const f=this._notes[d],p=Se.note(s,Vt.StandardNotationEffects,f);try{d>0&&d>=(this._notes.length/2|0)&&(h=P.Down);let g=t+i.y+i.getNoteY(f,R.Top),m=c*ve.GraceScale*.5;h===P.Down&&(g+=c);const b=f.bendStyle===ze.Gradual?"grad.":"";if(f.isTieOrigin){const S=f.tieDestination,T=S?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,S.beat.voice.bar):null;if(!T||T.staff!==i.staff){const C=e+i.x+i.width,v=f.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(f.beat,v,!1,!0);const G=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(v,!1));f.bendType===q.Hold||f.bendType===q.Prebend?St.paintTie(s,1,r,g,C,G,h===P.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,r,g,C,G,h===P.Down,1,b)}else{const C=e+T.x+T.getBeatX(S.beat,me.MiddleNotes);let v=t+T.y+T.getNoteY(S,R.Top);h===P.Down&&(v+=c),f.bendType===q.Hold||f.bendType===q.Prebend?St.paintTie(s,1,r,g,C,v,h===P.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,r,g,C,v,h===P.Down,1,b)}switch(f.bendType){case q.Prebend:case q.PrebendBend:case q.PrebendRelease:let C=e+i.x+i.getBeatX(f.beat,me.PreNotes);C+=i.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;const v=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(f.displayValue-(f.bendPoints[0].value/2|0),!1))+m;this.drawBendSlur(s,C,v,r,g,h===P.Down,1);break}}else{h===P.Up&&(m=-m);let S=0,T=0;switch(f.bendType){case q.Bend:S=this._getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),T=this._endNoteGlyph.getNoteValueY(S)+m,this.drawBendSlur(s,r,g,n,T,h===P.Down,1,b);break;case q.BendRelease:const C=this._getBendNoteValue(f,f.bendPoints[1]),v=this._middleNoteGlyph.getNoteValueY(C)+m;this.drawBendSlur(s,r,g,o,v,h===P.Down,1,b),S=this._getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),T=this._endNoteGlyph.getNoteValueY(S)+m,this.drawBendSlur(s,o,v,n,T,h===P.Down,1,b);break;case q.Release:this.bendNoteHeads.length>0&&(S=this._getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),T=this.bendNoteHeads[0].getNoteValueY(S)+m,this.drawBendSlur(s,r,g,n,T,h===P.Down,1,b));break;case q.Prebend:case q.PrebendBend:case q.PrebendRelease:let G=e+i.x+i.getBeatX(f.beat,me.PreNotes);G+=i.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;const W=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(f.displayValue-(f.bendPoints[0].value/2|0),!1))+m;this.drawBendSlur(s,G,W,r,g,h===P.Down,1),this.bendNoteHeads.length>0&&(S=this._getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),T=this.bendNoteHeads[0].getNoteValueY(S)+m,this.drawBendSlur(s,r,g,n,T,h===P.Down,1,b));break}}}finally{p?.[Symbol.dispose]?.()}}}_getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class Ln extends St{constructor(e,t,s=!1){super(e,t,s)}doLayout(){super.doLayout()}getBeamDirection(e,t){if(e.isRest)return P.Up;switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}getStartY(){if(this.startBeat.isRest)return this.startNoteRenderer.getScoreY(9);switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this.startBeat.maxNote,R.Top);default:return this.startNoteRenderer.getNoteY(this.startBeat.minNote,R.Bottom)}}getEndY(){const e=this.endNoteRenderer;if(this.endBeat.isRest)switch(this.tieDirection){case P.Up:return e.getScoreY(9);default:return e.getScoreY(0)}const t=this.startNoteRenderer.getBeatDirection(this.startBeat),s=e.getBeatDirection(this.endBeat);if(t!==s&&this.startBeat.graceType===$.None){if(s===this.tieDirection)switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,R.TopWithStem);default:return e.getNoteY(this.endBeat.minNote,R.BottomWithStem)}switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,R.BottomWithStem);default:return e.getNoteY(this.endBeat.minNote,R.TopWithStem)}}switch(this.tieDirection){case P.Up:return e.getNoteY(this.endBeat.maxNote,R.Top);default:return e.getNoteY(this.endBeat.minNote,R.Bottom)}}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,me.MiddleNotes)}getEndX(){const e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>y.Whole&&e===this.tieDirection?me.Stem:me.MiddleNotes)}}class Hd extends ot{_outType;_inType;_startNote;_parent;constructor(e,t,s,i){super(0,0),this._outType=t,this._inType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._drawSlideOut(e,t,s)}_paintSlideIn(e,t,s){const i=this.renderer,r=i.smuflMetrics.simpleSlideWidth;let n=e+i.x+i.getNoteX(this._startNote,Qe.Left)-i.smuflMetrics.preNoteEffectPadding;const o=t+i.y+i.getNoteY(this._startNote,R.Center);let l=n-r,h=t+i.y;switch(this._inType){case dt.IntoFromBelow:h+=i.getNoteY(this._startNote,R.Bottom);break;case dt.IntoFromAbove:h+=i.getNoteY(this._startNote,R.Top);break;default:return}const c=this._getAccidentalsWidth(i,this._startNote.beat);l-=c,n-=c,this._paintSlideLine(s,!1,l,n,h,o)}_getAccidentalsWidth(e,t){const s=e.getPreNotesGlyphForBeat(t);return s&&s.accidentals?s.accidentals.width:0}_drawSlideOut(e,t,s){const i=this.renderer,r=i.smuflMetrics.simpleSlideWidth,n=i.smuflMetrics.postNoteEffectPadding;let o=0,l=0,h=0,c=0,d=!1;switch(this._outType){case ne.Shift:case ne.Legato:if(o=e+i.x+i.getBeatX(this._startNote.beat,me.PostNotes)+n,l=t+i.y+i.getNoteY(this._startNote,R.Center),this._startNote.slideTarget){const f=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);!f||f.staff!==i.staff?(h=e+i.x+i.width,this._startNote.slideTarget.realValue>this._startNote.realValue?c=t+i.y+i.getNoteY(this._startNote,R.Top):c=t+i.y+i.getNoteY(this._startNote,R.Bottom)):(h=e+f.x+f.getBeatX(this._startNote.slideTarget.beat,me.PreNotes)-n,c=t+f.y+f.getNoteY(this._startNote.slideTarget,R.Center))}else h=e+i.x+this._parent.x,c=l;break;case ne.OutUp:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+n,l=t+i.y+i.getNoteY(this._startNote,R.Center),h=o+r,c=t+i.y+i.getNoteY(this._startNote,R.Top);break;case ne.OutDown:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+n,l=t+i.y+i.getNoteY(this._startNote,R.Center),h=o+r,c=t+i.y+i.getNoteY(this._startNote,R.Bottom);break;case ne.PickSlideUp:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+n*2,l=t+i.y+i.getNoteY(this._startNote,R.Center),c=t+i.y+i.getNoteY(this._startNote,R.Top),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,me.PreNotes)),d=!0;break;case ne.PickSlideDown:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+n*2,l=t+i.y+i.getNoteY(this._startNote,R.Center),c=t+i.y+i.getNoteY(this._startNote,R.Bottom),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,me.PreNotes)),d=!0;break;default:return}this._paintSlideLine(s,d,o,h,l,c)}_paintSlideLine(e,t,s,i,r,n){if(t){const o=new Ti(0,0,be.Slight);o.renderer=this.renderer,o.doLayout(),r-=o.height/2,n-=o.height/2;const l=i-s,h=n-r,c=Math.sqrt(Math.pow(h,2)+Math.pow(l,2));o.width=l;const d=Math.asin(h/c)*(180/Math.PI);e.beginRotate(s,r,d),o.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,r),e.lineTo(i,n),e.stroke()}}class Ja extends Ln{_startNote;_endNote;constructor(e,t,s=!1){super(e.beat,t.beat,s),this._startNote=e,this._endNote=t}getTieHeight(e,t,s,i){return Math.log2(s-e+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){if(this._isStartCentered())switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this._startNote,R.Top);default:return this.startNoteRenderer.getNoteY(this._startNote,R.Bottom)}return this.startNoteRenderer.getNoteY(this._startNote,R.Center)}getEndY(){if(this._isEndCentered()){if(this._isEndOnStem())switch(this.tieDirection){case P.Up:return this.endNoteRenderer.getNoteY(this._endNote,R.TopWithStem);default:return this.endNoteRenderer.getNoteY(this._endNote,R.BottomWithStem)}switch(this.tieDirection){case P.Up:return this.endNoteRenderer.getNoteY(this._endNote,R.Top);default:return this.endNoteRenderer.getNoteY(this._endNote,R.Bottom)}}return this.endNoteRenderer.getNoteY(this._endNote,R.Center)}_isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===P.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===P.Down}_isEndCentered(){return this._startNote.beat.graceType===$.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===P.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===P.Down)}_isEndOnStem(){const e=this.endNoteRenderer,t=this.startNoteRenderer.getBeatDirection(this.startBeat),s=e.getBeatDirection(this.endBeat);return t!==s&&this.startBeat.graceType===$.None}getStartX(){return this._isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,me.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,Qe.Right)}getEndX(){return this._isEndCentered()?this._isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,me.Stem):this.endNoteRenderer.getNoteX(this._endNote,Qe.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,me.PreNotes)}}class pl extends St{startNote;endNote;constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){switch(t.getBeatDirection(e)){case P.Up:return P.Down;default:return P.Up}}getStartY(){if(this.startBeat.isRest)return this.startNoteRenderer.getScoreY(9);switch(this.tieDirection){case P.Up:return this.startNoteRenderer.getNoteY(this.startNote,R.Top);default:return this.startNoteRenderer.getNoteY(this.startNote,R.Bottom)}}getEndY(){const e=this.endNoteRenderer;if(this.endBeat.isRest)switch(this.tieDirection){case P.Up:return e.getScoreY(9);default:return e.getScoreY(0)}switch(this.tieDirection){case P.Up:return e.getNoteY(this.endNote,R.Top);default:return e.getNoteY(this.endNote,R.Bottom)}}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,me.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,me.PreNotes)}}class Gd extends xs{_bend=null;_effectSlur=null;_effectEndSlur=null;doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==$.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){const t=new pl(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){const t=new pl(e.tieOrigin,e,!0);this.addTie(t)}if(e.slideInType!==dt.None||e.slideOutType!==ne.None){const t=new Hd(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){const t=new Ja(e,e.slurDestination,!1);this.addTie(t)}if(e.isSlurDestination){const t=new Ja(e.slurOrigin,e,!0);this.addTie(t)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){const t=new Ja(e,e.effectSlurDestination,!1);this._effectSlur=t,this.addTie(t)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){const t=this.onNotes.beamingHelper.direction,s=t===P.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,i=t===P.Up?e.beat.minNote:e.beat.maxNote,r=new Ja(s,i,!0);this._effectEndSlur=r,this.addTie(r)}if(e.hasBend){if(!this._bend){const t=new Vd(e.beat);this._bend=t,t.renderer=this.renderer,this.addTie(t)}this._bend.addBends(e)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let t=this.beat.nextBeat;for(;t.nextBeat&&t.nextBeat.isLegatoDestination;)t=t.nextBeat;this.addTie(new Ln(this.beat,t,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let t=this.beat.previousBeat;for(;t.previousBeat&&t.previousBeat.isLegatoOrigin;)t=t.previousBeat;this.addTie(new Ln(t,this.beat,!0))}}}}class Ud extends Oi{paint(e,t,s){const i=Se.bar(s,Pe.StandardNotationKeySignature,this.renderer.bar);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}class Ni extends ni{static StaffId="score";static _sharpKsSteps=[-1,2,-2,1,4,0,3];static _flatKsSteps=[3,0,4,1,5,2,6];simpleWhammyOverflow=0;beatEffectsMinY=null;beatEffectsMaxY=null;accidentalHelper;constructor(e,t){super(e,t),this.accidentalHelper=new Rt(this)}get repeatsBarSubElement(){return Pe.StandardNotationRepeats}get barNumberBarSubElement(){return Pe.StandardNotationBarNumber}get barLineBarSubElement(){return Pe.StandardNotationBarLines}get staffLineBarSubElement(){return Pe.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,t){const s=this.beatEffectsMinY;(s==null||e<s)&&(this.beatEffectsMinY=e);const i=this.beatEffectsMaxY;(i==null||t>i)&&(this.beatEffectsMaxY=t)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){const e=this.getScoreY(-2),t=this.getScoreY(this.heightLineCount*2),s=this.simpleWhammyOverflow,i=this.beatEffectsMinY;if(i!==null){const h=e-i;h>0&&this.registerOverflowTop(h)}const r=this.beatEffectsMaxY;if(r!==null){const h=r-t;h>0&&this.registerOverflowBottom(h)}this.registerOverflowTop(s);const n=this.getScoreHeight(1);let o=0,l=0;for(const h of this.helpers.beamHelpers)for(const c of h)if(c.isRestBeamHelper){if(c.minRestLine){const d=this.getScoreY(c.maxRestLine)-n;d<o&&(o=d)}if(c.maxRestLine){const d=this.getScoreY(c.maxRestLine)+n;d<o&&(o=d)}}else if(c.beats.length===1)if(c.beats[0].duration>=y.Half)if(c.direction===P.Up){let d=this.getFlagTopY(c.beats[0],c.direction);c.hasTuplet&&(d-=this.tupletSize+this.tupletOffset),d<o&&(o=d);const f=this.getFlagBottomY(c.beats[0],c.direction)+n;f>l&&(l=f)}else{let d=this.getFlagBottomY(c.beats[0],c.direction);c.hasTuplet&&(d+=this.tupletSize+this.tupletOffset),d>l&&(l=d);const f=this.getFlagTopY(c.beats[0],c.direction)-n;f<o&&(o=f)}else{const d=this.getBeatContainer(c.beats[0]);if(d){let f=d.onNotes.getHighestNoteY()-n,p=d.onNotes.getLowestNoteY()+n;c.direction===P.Up?c.hasTuplet&&(f-=this.tupletSize+this.tupletOffset):c.hasTuplet&&(p+=this.tupletSize+this.tupletOffset),p>l&&(l=p),f<o&&(o=f)}}else{this._ensureDrawingInfo(c,c.direction);const d=c.drawingInfos.get(c.direction);if(c.direction===P.Up){let f=Math.min(d.startY,d.endY);c.hasTuplet&&(f-=this.tupletSize+this.tupletOffset),f<o&&(o=f);const p=this.getBarLineStart(c.beatOfLowestNote,c.direction)+n;p>l&&(l=p)}else{let f=Math.max(d.startY,d.endY);c.hasTuplet&&(f+=this.tupletSize+this.tupletOffset),f>l&&(l=f);const p=this.getBarLineStart(c.beatOfHighestNote,c.direction)-n;p<o&&(o=p)}}o<e&&this.registerOverflowTop(Math.abs(o)+s),l>t&&this.registerOverflowBottom(Math.abs(l)-t)}}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Je.StandardNotationFlags,Je.StandardNotationBeams),this.paintTuplets(e,t,s,Je.StandardNotationTuplet)}_getSlashFlagY(){const e=(this.heightLineCount-1)/2;return this.getLineY(e)}getFlagTopY(e,t){if(e.slashed){let r=this._getSlashFlagY();const n=li.getSymbol(e.duration),o=e.graceType!==$.None?ve.GraceScale:1;return t===P.Down?r-=this.smuflMetrics.stemDown.has(n)?this.smuflMetrics.stemDown.get(n).topY*o:0:(r-=this.smuflMetrics.stemUp.has(n)?this.smuflMetrics.stemUp.get(n).bottomY*o:0,r-=this.smuflMetrics.standardStemLength+o),r}const s=this.accidentalHelper.getMinLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,t===P.Up?R.TopWithStem:R.StemDown);let i=this.getScoreY(this.accidentalHelper.getMinLine(e));if(t===P.Up){const r=e.graceType!==$.None?ve.GraceScale:1;i-=this.smuflMetrics.standardStemLength*r}return i}getFlagBottomY(e,t){if(e.slashed){let r=this._getSlashFlagY();const n=li.getSymbol(e.duration),o=e.graceType!==$.None?ve.GraceScale:1;return t===P.Down?(r-=this.smuflMetrics.stemDown.has(n)?this.smuflMetrics.stemDown.get(n).topY*o:0,r+=this.smuflMetrics.standardStemLength+o):r-=this.smuflMetrics.stemUp.has(n)?this.smuflMetrics.stemUp.get(n).bottomY*o:0,r}const s=this.accidentalHelper.getMaxLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,t===P.Up?R.StemUp:R.BottomWithStem);let i=this.getScoreY(this.accidentalHelper.getMaxLine(e));if(t===P.Down){const r=e.graceType!==$.None?ve.GraceScale:1;i+=this.smuflMetrics.standardStemLength*r}return i}getBeamDirection(e){return e.direction}centerStaffStemY(e){return this.bar.staff.standardNotationLineCount===Li.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):e.direction===P.Up?this.getScoreY(this.bar.staff.standardNotationLineCount*2):this.getScoreY(0)}getStemBottomY(e){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){if(e.beat.slashed){const i=(this.heightLineCount-1)/2;return this.getLineY(i)}let s=super.getNoteY(e,t);if(Number.isNaN(s)){const i=Rt.computeLineWithoutAccidentals(this.bar,e);s=this.getScoreY(i);const r=e.beat.graceType===$.None?1:ve.GraceScale,n=this.smuflMetrics.standardStemLength*r,o=this.smuflMetrics.glyphHeights.get(ve.getSymbol(e.beat.duration))*r;switch(t){case R.TopWithStem:s-=n;break;case R.Top:s-=o/2;break;case R.Center:break;case R.Bottom:s+=o/2;break;case R.BottomWithStem:s+=n;break;case R.StemUp:break;case R.StemDown:break}}return s}applyLayoutingInfo(){const e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){const t=this.getScoreY(-2),s=this.getScoreY(this.heightLineCount*2),i=this.helpers.collisionHelper.getBeatMinMaxY();i[0]<t&&this.registerOverflowTop(Math.abs(i[0])),i[1]>s&&this.registerOverflowBottom(Math.abs(i[1])-s)}return e}calculateBeamYWithDirection(e,t,s){return e.beats.length===0?s===P.Up?this.getFlagTopY(e.beats[0],s):this.getFlagBottomY(e.beats[0],s):(this._ensureDrawingInfo(e,s),e.drawingInfos.get(s).calcY(t))}_ensureDrawingInfo(e,t){if(!e.drawingInfos.has(t)){const s=e.graceType!==$.None?ve.GraceScale:1,i=L.getIndex(e.shortestDuration)-2;let r=this.smuflMetrics.standardStemLength*s;if(e.tremoloDuration){const d=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*s;e.shortestDuration>y.Eighth?e.tremoloDuration===y.Eighth?r+=d:r+=d*1.5:e.tremoloDuration===y.ThirtySecond&&(r+=d*1.5)}const n=new fc;e.drawingInfos.set(t,n);const o=e.beats[0],l=e.beats[e.beats.length-1],h=e.isRestBeamHelper;n.startBeat=o,n.startX=e.getBeatLineX(o),h?n.startY=t===P.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):n.startY=t===P.Up?this.getFlagTopY(o,t):this.getFlagBottomY(o,t),n.endBeat=l,n.endX=e.getBeatLineX(l),h?n.endY=t===P.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):n.endY=t===P.Up?this.getFlagTopY(l,t):this.getFlagBottomY(l,t);const c=this.smuflMetrics.oneStaffSpace;if(t===P.Down&&n.startY>n.endY&&n.startY-n.endY>c&&(n.endY=n.startY-c),t===P.Down&&n.endY>n.startY&&n.endY-n.startY>c&&(n.startY=n.endY-c),t===P.Up&&n.startY<n.endY&&n.endY-n.startY>c&&(n.endY=n.startY+c),t===P.Up&&n.endY<n.startY&&n.startY-n.endY>c&&(n.startY=n.endY+c),e.beats.length>1){if(t===P.Up){const d=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-r,p=n.calcY(e.getBeatLineX(e.beatOfHighestNote))-d;p>0&&(n.startY-=p,n.endY-=p)}else{const d=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+r,f=n.calcY(e.getBeatLineX(e.beatOfLowestNote)),p=d-f;p>0&&(n.startY+=p,n.endY+=p)}if(e.minRestLine!==null||e.maxRestLine!==null){const d=e.graceType!==$.None?ve.GraceScale:1;let f=i*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*d;if(f+=this.smuflMetrics.beamSpacing,t===P.Up&&e.minRestLine!==null){const p=this.getScoreY(e.minRestLine)-f,m=n.calcY(e.getBeatLineX(e.beatOfMinRestLine))-p;m>0&&(n.startY-=m,n.endY-=m)}else if(t===P.Down&&e.maxRestLine!==null){const p=this.getScoreY(e.maxRestLine)+f,g=n.calcY(e.getBeatLineX(e.beatOfMaxRestLine)),m=p-g;m>0&&(n.startY+=m,n.endY+=m)}}if(e.slashBeats.length>0)for(const d of e.slashBeats){const f=n.calcY(e.getBeatLineX(d)),g=(e.direction===P.Up?this.getFlagTopY(d,e.direction):this.getFlagBottomY(d,e.direction))-f;g>0&&(n.startY+=g,n.endY+=g)}}if(i>2&&!h){const d=this.smuflMetrics.beamSpacing*s,f=this.smuflMetrics.beamThickness*s,p=i*f+(i-1)*d;if(t===P.Up){const m=n.startY+2*f+d-p,b=n.startY-m;b>0&&(n.startY-=b,n.endY-=b)}else{const b=n.startY-2*f+d+p-n.startY;b>0&&(n.startY+=b,n.endY+=b)}}}}getBarLineStart(e,t){if(e.slashed)return t===P.Down?this.getFlagTopY(e,t):this.getFlagBottomY(e,t);if(t===P.Up){const i=this.accidentalHelper.getMaxLineNote(e);return i?this.getBeatContainer(e).onNotes.getNoteY(i,R.StemUp):this.getScoreY(this.accidentalHelper.getMaxLine(e))}const s=this.accidentalHelper.getMinLineNote(e);return s?this.getBeatContainer(e).onNotes.getNoteY(s,R.StemDown):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let t=0;switch(this.bar.clef){case Te.Neutral:t=this.bar.staff.standardNotationLineCount-1;break;case Te.F4:t=2;break;case Te.C3:t=4;break;case Te.C4:t=2;break;case Te.G2:t=6;break}this.createStartSpacing(),this.addPreBeatGlyph(new Dn(0,this.getScoreY(t),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.preBeatGlyphSpacing)),e=!0}(e||this.index===0&&this.bar.keySignature!==He.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this._createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createKeySignatureGlyphs(){let e=0;const t=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case Te.Neutral:e=0;break;case Te.G2:e=1;break;case Te.F4:e=3;break;case Te.C3:e=2;break;case Te.C4:e=0;break}const i=new Ud;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const r=new Map,n=[];if(L.keySignatureIsSharp(t))for(let o=0;o<Math.abs(t);o++){const l=Ni._sharpKsSteps[o]+e;n.push(new Xs(0,this.getScoreY(l),K.Sharp,1)),r.set(l,!0)}else for(let o=0;o<Math.abs(t);o++){const l=Ni._flatKsSteps[o]+e;n.push(new Xs(0,this.getScoreY(l),K.Flat,1)),r.set(l,!0)}if(this.bar.keySignature===He.C){const o=Math.abs(s),l=L.keySignatureIsSharp(s)?Ni._sharpKsSteps:Ni._flatKsSteps;for(let h=0;h<o;h++){const c=l[h]+e;r.has(c)||i.addGlyph(new Xs(0,this.getScoreY(l[h]+e),K.Natural,1))}}for(const o of n)i.addGlyph(o);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.preBeatGlyphSpacing))}_createTimeSignatureGlyphs(){const e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new vn(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(e){for(const t of e.beats){const s=new Gd(t,this.getVoiceContainer(e));s.preNotes=new Od,s.onNotes=new Rd,this.addBeatGlyph(s)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let t=0,s=0,i=0;e.hasTuplet&&(i+=this.resources.effectFont.size*2),e.direction===P.Up?(t=this.getNoteY(e.highestNoteInHelper,R.TopWithStem)-i,s=this.getNoteY(e.lowestNoteInHelper,R.Bottom)):(t=this.getNoteY(e.highestNoteInHelper,R.Top),s=this.getNoteY(e.lowestNoteInHelper,R.BottomWithStem)+i);for(const r of e.beats)this.helpers.collisionHelper.reserveBeatSlot(r,t,s)}}paintBeamingStem(e,t,s,i,r,n){const o=Se.beat(n,Je.StandardNotationStem,e);try{n.fillRect(s,i,this.smuflMetrics.stemThickness,r-i)}finally{o?.[Symbol.dispose]?.()}}}class zd extends vr{get staffId(){return Ni.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new Ni(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showStandardNotation}}class gl extends St{startNote;endNote;constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get _isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this._isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return P.Down}static getBeamDirectionForNote(e){return P.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,R.Center)}getEndY(){return this.getStartY()}getStartX(){return this._isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,Qe.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,Qe.Left)}}class Yd extends xs{_tiedNoteTie=null;createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){const t=new gl(e,e.tieDestination,!1);this._tiedNoteTie=t,this.addTie(t)}if(!this._tiedNoteTie&&e.isTieDestination){const t=new gl(e.tieOrigin,e,!0);this._tiedNoteTie=t,this.addTie(t)}}}}class Xd extends Vr{updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){super.internalPaint(e,t,s,Je.SlashRests)}}class Jd extends wi{noteHeads=null;deadSlapped=null;restGlyph=null;get effectElement(){return Je.SlashEffects}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let i=s.x;switch(t){case Qe.Left:break;case Qe.Center:i+=s.width/2;break;case Qe.Right:i+=s.width;break}return i}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new dr;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Mt,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(e,t){let s=null,i=u.None;if(this.noteHeads?(s=this.noteHeads,i=li.getSymbol(e.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let r=this.y+s.y;switch(t){case R.Top:case R.TopWithStem:r-=s.height/2;break;case R.Center:break;case R.Bottom:case R.BottomWithStem:r+=s.height/2;break;case R.StemUp:r-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case R.StemDown:r-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0;break}return r}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){const e=this.renderer,t=e.getNoteLine(),s=e.getLineY(t);if(this.container.beat.deadSlapped){const i=new Ua;i.renderer=this.renderer,i.doLayout(),this.deadSlapped=i,this.addEffect(i)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const i=new Xd(0,s,this.container.beat.duration);this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const i=this.container.beat.graceType!==$.None,r=new li(0,s,this.container.beat.duration,i,this.container.beat);this.noteHeads=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addNormal(r)}if(this.container.beat.dots>0)for(let i=0;i<this.container.beat.dots;i++)this.addEffect(new Rr(0,e.getLineY(e.getNoteLine())-e.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class ml extends ni{static StaffId="slash";simpleWhammyOverflow=0;_isOnlySlash;constructor(e,t){super(e,t),this._isOnlySlash=!t.staff.showTablature&&!t.staff.showStandardNotation,this.helpers.preferredBeamDirection=P.Up}get repeatsBarSubElement(){return Pe.SlashRepeats}get barNumberBarSubElement(){return Pe.SlashBarNumber}get barLineBarSubElement(){return Pe.SlashBarLines}get staffLineBarSubElement(){return Pe.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Je.SlashFlags,Je.SlashBeams),this.paintTuplets(e,t,s,Je.SlashTuplet)}doLayout(){super.doLayout();let e=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)&&this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,t){const s=this.smuflMetrics.glyphHeights.get(u.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return t===P.Up&&(i-=this.getFlagStemSize(e.duration,!0)),i}getFlagBottomY(e,t){const s=this.smuflMetrics.glyphHeights.get(u.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return t===P.Down&&(i+=this.getFlagStemSize(e.duration,!0)),i}getBeamDirection(e){return P.Up}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){const s=this.smuflMetrics.glyphHeights.get(u.NoteheadSlashWhiteHalf);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.oneStaffSpace));const e=this.bar.masterBar,t=new vn(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(e.previousMasterBar==null||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=Pe.SlashTimeSignature,this.addPreBeatGlyph(t)}createVoiceGlyphs(e){for(const t of e.beats){const s=new Yd(t,this.getVoiceContainer(e));s.preNotes=new ki,s.onNotes=e.index===0?new Jd:new wi,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,r,n){const o=Se.beat(n,Je.SlashStem,e);try{const l=n.lineWidth;n.lineWidth=this.smuflMetrics.stemThickness,n.beginPath(),n.moveTo(s,i),n.lineTo(s,r),n.stroke(),n.lineWidth=l}finally{o?.[Symbol.dispose]?.()}}}class $d extends vr{get staffId(){return ml.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new ml(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}}class Pi extends H{lineValue=0;constructor(e=0,t=0){super(e,t),this.lineValue=t}}class $a extends ot{_notes=[];_renderPoints=new Map;_preBendMinValue=-1;_bendMiddleMinValue=-1;_bendEndMinValue=-1;_bendEndContinuedMinValue=-1;_releaseMinValue=-1;_releaseContinuedMinValue=-1;_maxBendValue=-1;constructor(){super(0,0)}addBends(e){this._notes.push(e);const t=this._createRenderingPoints(e);this._renderPoints.set(e.id,t),(this._maxBendValue===-1||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let s=0;switch(e.bendType){case q.Bend:s=t[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(this._bendEndMinValue===-1||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case q.Release:s=t[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(this._releaseMinValue===-1||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case q.BendRelease:s=t[1].value,(this._bendMiddleMinValue===-1||s<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=s),s=t[2].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(this._releaseMinValue===-1||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case q.Prebend:s=t[0].value,(this._preBendMinValue===-1||s<this._preBendMinValue)&&(this._preBendMinValue=s);break;case q.PrebendBend:s=t[0].value,(this._preBendMinValue===-1||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(this._bendEndContinuedMinValue===-1||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(this._bendEndMinValue===-1||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case q.PrebendRelease:s=t[0].value,(this._preBendMinValue===-1||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(this._releaseContinuedMinValue===-1||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(this._releaseMinValue===-1||s<this._releaseMinValue)&&(this._releaseMinValue=s);break}}doLayout(){super.doLayout();const e=this._maxBendValue*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(e);let t=0;for(const s of this._notes){const i=this._renderPoints.get(s.id);switch(s.bendType){case q.Bend:i[1].lineValue=s.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case q.Release:t=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(i[1].lineValue=t);break;case q.BendRelease:i[1].lineValue=this._bendMiddleMinValue,t=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(i[2].lineValue=t);break;case q.Prebend:i[0].lineValue=this._preBendMinValue;break;case q.PrebendBend:i[0].lineValue=this._preBendMinValue,i[1].lineValue=s.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case q.PrebendRelease:i[0].lineValue=this._preBendMinValue,t=s.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(i[1].lineValue=t);break}}this.width=0,this._notes.sort((s,i)=>s.isStringed?s.string-i.string:s.realValue-i.realValue)}_createRenderingPoints(e){const t=[];switch(e.bendType){case q.Custom:for(const s of e.bendPoints)t.push(new Pi(s.offset,s.value));break;case q.BendRelease:t.push(new Pi(0,e.bendPoints[0].value)),t.push(new Pi(H.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new Pi(H.MaxPosition,e.bendPoints[3].value));break;case q.Bend:case q.Hold:case q.Prebend:case q.PrebendBend:case q.PrebendRelease:case q.Release:t.push(new Pi(0,e.bendPoints[0].value)),t.push(new Pi(H.MaxPosition,e.bendPoints[1].value));break}return t}paint(e,t,s){const i=s.color;this._notes.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const r of this._notes){const n=this._renderPoints.get(r.id),o=this.renderer;let l=r,h=!1,c=null,d=!1;const f=r.bendStyle===ze.Gradual?"grad.":"";let p=null;for(;l.isTieOrigin;){const v=l.tieDestination;if(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,v.beat.voice.bar),!c||o.staff!==c.staff)break;if(l=v,h=!0,l.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||l.vibrato!==be.None){d=!0;break}}p=l.beat,c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,p.voice.bar),p.isLastOfVoice&&!l.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(p=null);let g=0,m=0;const b=t+o.y,S=this.renderer.smuflMetrics.glyphWidths.get(u.ArrowheadBlackDown);g=e+o.x,n[0].value>0||r.isContinuedBend?g+=o.getBeatX(r.beat,me.MiddleNotes):g+=o.getNoteX(r,Qe.Right),!p||p.isLastOfVoice&&!d?m=e+c.x+c.postBeatGlyphsStart:d||!p.nextBeat?m=e+c.x+c.getBeatX(p,me.MiddleNotes):r.bendType===q.Hold?m=e+c.x+c.getBeatX(p.nextBeat,me.OnNotes):m=e+c.x+c.getBeatX(p.nextBeat,me.PreNotes),h||(m-=S);const C=(m-g)/H.MaxPosition;s.beginPath();for(let v=0,G=n.length-1;v<G;v++){const W=n[v];let w=n[v+1];v===0&&W.value!==0&&!r.isTieDestination&&this._paintBend(r,new Pi(0,0),W,g,b,C,f,s),r.bendType!==q.Prebend?(v===0&&(g+=this.renderer.smuflMetrics.postNoteEffectPadding),this._paintBend(r,W,w,g,b,C,f,s)):r.isTieOrigin&&r.tieDestination.hasBend&&(w=new Pi(H.MaxPosition,W.value),w.lineValue=W.lineValue,this._paintBend(r,W,w,g,b,C,f,s))}if(l.vibrato!==be.None){const v=m-e+S-c.x,G=b-t-this.renderer.smuflMetrics.tabBendPerValueHeight*n[n.length-1].lineValue,W=new Ti(v,G,l.vibrato);W.beat=l.beat,W.renderer=c,W.doLayout(),W.paint(e+c.x,t,s)}s.color=i}}_paintBend(e,t,s,i,r,n,o,l){const h=this.renderer,c=this.renderer.resources,d=h.lineOffset/2,f=i+n*t.offset,p=this.renderer.smuflMetrics.tabBendPerValueHeight;let g=r-p*t.lineValue;t.value===0?s.offset===t.offset?g+=h.getNoteY(e.beat.maxStringNote,R.Top)-d/2:g+=h.getNoteY(e,R.Center):g+=d;const m=i+n*s.offset;let b=r-p*s.lineValue;s.lineValue===0?b+=h.getNoteY(e,R.Center):b+=d;let S=0;const T=this.renderer.smuflMetrics.glyphWidths.get(u.ArrowheadBlackDown);s.value>t.value?(b+T>g&&(b=g-T),l.beginPath(),l.moveTo(m,b),l.lineTo(m-T*.5,b+T),l.lineTo(m+T*.5,b+T),l.closePath(),l.fill(),S=T):s.value!==t.value&&(b<g&&(b=g+T),l.beginPath(),l.moveTo(m,b),l.lineTo(m-T*.5,b-T),l.lineTo(m+T*.5,b-T),l.closePath(),l.fill(),S=-T);const C=l.lineWidth;if(l.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,l.beginPath(),t.value===s.value){if(t.lineValue>0){let v=m;const G=this.renderer.smuflMetrics.tabBendDashSize,W=f+G;if((v-f)/(G*2)<1)l.moveTo(v,g),l.lineTo(f,g);else for(;v>W;)l.moveTo(v,g),l.lineTo(v-G,g),v-=G*2;l.stroke()}}else m>f?(l.moveTo(f,g),l.bezierCurveTo((f+m)/2,g,m,g,m,b+S),l.stroke()):(l.moveTo(f,g),l.lineTo(m,b),l.stroke());if(o&&t.offset<s.offset){l.font=c.graceFont;const v=l.measureText(o);let G=0,W=0;if(g>b){const w=Math.abs(g-b);G=w>v.height?g-w/2:g,W=(f+m-v.width)/2}else G=g,W=m-v.width;l.fillText(o,W,G)}if(s.value!==0&&t.value!==s.value){let v=s.value;const G=s.value>t.value;v=Math.abs(v);let W="";if(v===4)W="full",v-=4;else if(v>=4||v<=-4){const w=v/4|0;W+=w,v-=w*4}if(v>0&&(W+=$a.getFractionSign(v)),W!==""){b=r-p*s.value;let w=b;G||(w=g+Math.abs(b-g)*1/3),l.font=c.tablatureFont;const se=l.measureText(W),Ne=w-se.height/1.5,ye=m-se.width/2;l.fillText(W,ye,Ne-c.engravingSettings.tabBendLabelPadding)}}l.lineWidth=C}static getFractionSign(e){switch(e){case 1:return"";case 2:return"";case 3:return"";default:return`${e}/ 4`}}}class qd extends ot{_inType;_outType;_startNote;_parent;constructor(e,t,s,i){super(0,0),this._inType=e,this._outType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this._paintSlideIn(e,t,s),this._paintSlideOut(e,t,s)}_paintSlideIn(e,t,s){const i=this.renderer,r=this.renderer.smuflMetrics.simpleSlideWidth,n=this.renderer.smuflMetrics.simpleSlideHeight;let o=0,l=0,h=0,c=0;const d=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._inType){case dt.IntoFromBelow:h=e+i.x+i.getNoteX(this._startNote,Qe.Left)-d,c=t+i.y+i.getNoteY(this._startNote,R.Center)-n,o=h-r,l=t+i.y+i.getNoteY(this._startNote,R.Center)+n;break;case dt.IntoFromAbove:h=e+i.x+i.getNoteX(this._startNote,Qe.Left)-d,c=t+i.y+i.getNoteY(this._startNote,R.Center)+n,o=h-r,l=t+i.y+i.getNoteY(this._startNote,R.Center)-n;break;default:return}this._paintSlideLine(s,!1,o,h,l,c)}_paintSlideOut(e,t,s){const i=this.renderer,r=this.renderer.smuflMetrics.simpleSlideWidth,n=this.renderer.smuflMetrics.simpleSlideHeight;let o=0,l=0,h=0,c=0,d=!1;const f=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._outType){case ne.Shift:case ne.Legato:if(o=e+i.x+i.getBeatX(this._startNote.beat,me.PostNotes)+f,l=t+i.y+i.getNoteY(this._startNote,R.Center),this._startNote.slideTarget){const p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);!p||p.staff!==i.staff?(h=e+i.x+i.width,c=l):(h=e+p.x+p.getBeatX(this._startNote.slideTarget.beat,me.OnNotes)-f,c=t+p.y+p.getNoteY(this._startNote.slideTarget,R.Center)),this._startNote.slideTarget.fret>this._startNote.fret?(l+=n,c-=n):(l-=n,c+=n)}else h=e+i.x+this._parent.x,c=l;break;case ne.OutUp:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+f,l=t+i.y+i.getNoteY(this._startNote,R.Center)+n,h=o+r,c=t+i.y+i.getNoteY(this._startNote,R.Center)-n;break;case ne.OutDown:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+f,l=t+i.y+i.getNoteY(this._startNote,R.Center)-n,h=o+r,c=t+i.y+i.getNoteY(this._startNote,R.Center)+n;break;case ne.PickSlideDown:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+f*2,l=t+i.y+i.getNoteY(this._startNote,R.Center),h=e+i.x+i.width,c=l+n*3,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,me.PreNotes)),d=!0;break;case ne.PickSlideUp:o=e+i.x+i.getNoteX(this._startNote,Qe.Right)+f*2,l=t+i.y+i.getNoteY(this._startNote,R.Center),h=e+i.x+i.width,c=l-n*3,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,me.PreNotes)),d=!0;break;default:return}this._paintSlideLine(s,d,o,h,l,c)}_paintSlideLine(e,t,s,i,r,n){if(t){const o=new Ti(0,0,be.Slight);o.renderer=this.renderer,o.doLayout(),r-=o.height/2,n-=o.height/2;const l=i-s,h=n-r,c=Math.sqrt(Math.pow(h,2)+Math.pow(l,2));o.width=l;const d=Math.asin(h/c)*(180/Math.PI);e.beginRotate(s,r,d),o.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,r),e.lineTo(i,n),e.stroke()}}class yl extends oi{_direction;_forSlide;constructor(e,t,s,i=!1){super(e,t,i),this._direction=oi.getBeamDirectionForNote(e),this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==e.beat.id||this.endNote.beat.id!==t.beat.id||this._direction!==oi.getBeamDirectionForNote(e))return!1;switch(this._direction){case P.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case P.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break}return!0}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),r=this.getBeamDirection(this.startBeat,i),n=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${r}`,o=this.renderer;o.staff.getSharedLayoutData(n,!1)||(o.staff.setSharedLayoutData(n,!0),super.paint(e,t,s))}}class Qd extends xs{_bend=null;_effectSlurs=[];drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;const t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){const s=new oi(e,e.tieDestination,!1);this.addTie(s)}if(e.isTieDestination&&t.showTiedNotes){const s=new oi(e.tieOrigin,e,!0);this.addTie(s)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){const s=new oi(e,e,!1);this.addTie(s)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(e,e.effectSlurDestination,!1,!1)){s=!0;break}if(!s){const i=new yl(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(i),this.addTie(i)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(e.effectSlurOrigin,e,!1,!0)){s=!0;break}if(!s){const i=new yl(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(i),this.addTie(i)}}if(e.slideInType!==dt.None||e.slideOutType!==ne.None){const s=new qd(e.slideInType,e.slideOutType,e,this);this.addTie(s)}if(e.hasBend){if(!this._bend){const s=new $a;this._bend=s,s.renderer=this.renderer,this.addTie(s)}this._bend.addBends(e)}}}class Kd extends ot{_note;_noteString=null;_trillNoteString=null;_trillNoteStringWidth=0;isEmpty=!1;noteStringWidth=0;constructor(e,t,s){super(e,t),this._note=s}doLayout(){const e=this._note;let t=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===Q.Natural&&e.harmonicValue!==0&&(t=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)e.beat.index===0&&this.renderer.settings.notation.notationMode===Et.GuitarPro||(e.bendType===q.Bend||e.bendType===q.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(fe.TabNotesOnTiedBends)?this._noteString=`(${(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else if(this._noteString=e.isDead?"x":t.toString(),e.isGhost)this._noteString=`(${this._noteString})`;else if(e.harmonicType===Q.Natural){const s=this._noteString.indexOf(".");s>=0&&(this._noteString=this._noteString.substr(0,s+2)),this._noteString=`<${this._noteString}>`}if(e.isTrill)this._trillNoteString=`(${(e.trillFret-e.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(L.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case Q.Artificial:case Q.Pinch:case Q.Tap:case Q.Semi:case Q.Feedback:let s=(t+e.harmonicValue).toString();const i=s.indexOf(".");i>=0&&(s=s.substr(0,i+2)),this._trillNoteString=`<${s}>`;break;default:this._trillNoteString="";break}if(this.isEmpty=!this._noteString,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const s=!!this._trillNoteString;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString+(s?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,s&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth)}}paint(e,t,s){if(this.isEmpty)return;const i=this.noteStringWidth+this._trillNoteStringWidth,r=e+this.x+(this.width-i)/2;this.paintTrill(r,t,s);const n=Se.note(s,Vt.GuitarTabFretNumber,this._note);try{s.fillText(this._noteString,r,t+this.y)}finally{n?.[Symbol.dispose]?.()}}paintTrill(e,t,s){const i=Se.note(s,Vt.GuitarTabFretNumber,this._note);try{const r=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,e+this.noteStringWidth,t+this.y),this.renderer.scoreRenderer.canvas.font=r}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(e,t,s){const i=new dr;i.note=this._note,i.noteHeadBounds=new Mt,i.noteHeadBounds.x=t+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}class Zd extends ot{_notes=[];_deadSlapped=null;_isGrace;beat;beamingHelper;maxStringNote=null;minStringNote=null;beatEffects=new Map;notesPerString=new Map;noteStringWidth=0;constructor(e,t,s){super(e,t),this._isGrace=s}buildBoundingsLookup(e,t,s){for(const i of this._notes)i.buildBoundingsLookup(e,t+this.x,s+this.y)}getNoteX(e,t){if(this.notesPerString.has(e.string)){const s=this.notesPerString.get(e.string);let i=this.x+s.x;switch(t){case Qe.Left:break;case Qe.Center:i+=s.noteStringWidth/2;break;case Qe.Right:i+=s.width;break}return i}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,R.Center):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,R.Center):0}getNoteY(e,t){if(this.notesPerString.has(e.string)){const s=this.notesPerString.get(e.string);let i=this.y+s.y;switch(t){case R.Top:case R.TopWithStem:i-=s.height/2;break;case R.Center:break;case R.Bottom:case R.BottomWithStem:i+=s.height/2;break;case R.StemUp:case R.StemDown:break}return i}return 0}doLayout(){let e=0;if(this.beat.deadSlapped)this._deadSlapped=new Ua,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),e=this._deadSlapped.width,this.noteStringWidth=e;else{let t=0;for(let n=0,o=this._notes.length;n<o;n++){const l=this._notes[n];l.renderer=this.renderer,l.doLayout(),l.width>e&&(e=l.width),l.noteStringWidth>t&&(t=l.noteStringWidth)}this.noteStringWidth=t;const s=this.renderer.resources.tablatureFont.size;let i=this.getNoteY(this.minStringNote,R.Center)+s/2;const r=this.renderer.smuflMetrics.onNoteEffectPadding;for(const n of this.beatEffects.values())n.y+=i,n.x+=this.width/2,n.renderer=this.renderer,i+=n.height+r,n.doLayout()}this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t),(!this.maxStringNote||t.string>this.maxStringNote.string)&&(this.maxStringNote=t)}paint(e,t,s){if(e+=this.x,t+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(e,t,s);else{const i=this.renderer.resources,r=s.textBaseline;s.textBaseline=Re.Middle,s.font=this._isGrace?i.graceFont:i.tablatureFont;const n=this._notes,o=this.width;for(const h of n)h.renderer=this.renderer,h.width=o,h.paint(e,t,s);s.textBaseline=r;const l=Se.beat(s,Je.GuitarTabEffects,this.beat);try{for(const h of this.beatEffects.values())h.paint(e,t,s)}finally{l?.[Symbol.dispose]?.()}}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class jd extends gt{_isVisibleRest;beamingHelper;constructor(e,t,s,i){super(e,t,1,Vr.getSymbol(i)),this._isVisibleRest=s}doLayout(){super.doLayout()}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){if(this._isVisibleRest){const i=Se.beat(s,Je.GuitarTabRests,this.beat);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}}class Yi extends ot{static _topOffsetSharedDataKey="tab.whammy.topoffset";static _bottomOffsetSharedDataKey="tab.whammy.bottomffset";_beat;_renderPoints;_isSimpleDip=!1;constructor(e){super(0,0),this._beat=e,this._renderPoints=this._createRenderingPoints(e)}_createRenderingPoints(e){if(e.whammyBarType===Le.Custom)return e.whammyBarPoints;const t=[];switch(e.whammyBarType){case Le.Dive:case Le.Hold:case Le.PrediveDive:case Le.Predive:t.push(new H(0,e.whammyBarPoints[0].value)),t.push(new H(H.MaxPosition,e.whammyBarPoints[1].value));break;case Le.Dip:t.push(new H(0,e.whammyBarPoints[0].value)),t.push(new H(H.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new H(H.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value));break}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===Et.SongBook&&this._beat.whammyBarType===Le.Dip;let e=null,t=null,s=this._beat;for(;s&&s.hasWhammyBar;)(!e||e.value>s.minWhammyPoint.value)&&(e=s.minWhammyPoint),(!t||t.value<s.maxWhammyPoint.value)&&(t=s.maxWhammyPoint),s=s.nextBeat;let i=t.value>0?Math.abs(this._getOffset(t.value)):0;(i>0||this._beat.whammyBarPoints[0].value!==0||this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys))&&(i+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding);const r=e.value<0?Math.abs(this._getOffset(e.value)):0,n=this.renderer.staff.getSharedLayoutData(Yi._topOffsetSharedDataKey,-1);let o=n;i>n&&(this.renderer.staff.setSharedLayoutData(Yi._topOffsetSharedDataKey,i),o=i);const l=this.renderer.staff.getSharedLayoutData(Yi._bottomOffsetSharedDataKey,-1);let h=l;r>l&&(this.renderer.staff.setSharedLayoutData(Yi._bottomOffsetSharedDataKey,r),h=l),this.height=i+r,this.renderer.registerOverflowTop(o+h)}_getOffset(e){if(e===0)return 0;let t=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(e)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return e<0&&(t=-t),t}paint(e,t,s){const i=Se.beat(s,Je.StandardNotationEffects,this._beat);try{const r=this.renderer;let n=this._beat.nextBeat,o=null,l=me.PreNotes;n&&(o=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,n.voice.bar),!o||o.staff!==r.staff||o!==r&&!n.hasWhammyBar?(n=null,o=null):l=n.hasWhammyBar&&(r.settings.notation.notationMode!==Et.SongBook||n.whammyBarType!==Le.Dip)?me.MiddleNotes:me.PreNotes);let h=0,c=0;this._isSimpleDip?(h=e+r.x+r.getBeatX(this._beat,me.OnNotes),c=e+r.x+r.getBeatX(this._beat,me.PostNotes)):(h=e+r.x+r.getBeatX(this._beat,me.MiddleNotes),c=o?e+o.x+o.getBeatX(n,l):e+r.x+r.postBeatGlyphsStart);const d=s.textAlign,f=s.textBaseline;if(s.textAlign=X.Center,s.textBaseline=Re.Alphabetic,this._renderPoints.length>=2){const p=(c-h)/H.MaxPosition;s.beginPath();const g=this.renderer.staff.getSharedLayoutData(Yi._topOffsetSharedDataKey,0),m=t+g;let b=this._beat.whammyStyle===ze.Gradual?"grad.":"";for(let S=0,T=this._renderPoints.length-1;S<T;S++){const C=this._renderPoints[S],v=this._renderPoints[S+1];let G=S===0;S===0&&C.value!==0&&!this._beat.isContinuedWhammy&&(this._paintWhammy(!1,new H(0,0),C,h,m,p,s),G=!1),this._paintWhammy(G,C,v,h,m,p,s,b),b=""}s.stroke()}s.textAlign=d,s.textBaseline=f}finally{i?.[Symbol.dispose]?.()}}_paintWhammy(e,t,s,i,r,n,o,l){const h=i+n*t.offset,c=i+n*s.offset,d=r-this._getOffset(t.value),f=r-this._getOffset(s.value);if(t.offset===s.offset){const m=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(f-d)/(m*2)<1)o.moveTo(h,d),o.lineTo(c,f);else{const S=Math.max(d,f);let T=Math.min(d,f);for(;S>T;)o.moveTo(h,T),o.lineTo(h,T+m),T+=m*2}o.stroke()}else if(t.value===s.value){const m=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(c-h)/(m*2)<1)o.moveTo(h,d),o.lineTo(c,f);else{let S=Math.max(h,c);const T=Math.min(h,c);for(;S>T;)o.moveTo(S,d),o.lineTo(S-m,d),S-=m*2}o.stroke()}else o.moveTo(h,d),o.lineTo(c,f);const p=this.renderer.smuflMetrics.tabWhammyTextPadding;e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip&&(this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys)&&o.fillText("0",h,d-p),l&&o.fillText(l,h,d-p));let g=Math.abs(s.value);if((g!==0||this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&t.value!==s.value){let m="";if(s.value<0&&(m+="-"),g>=4){const T=g/4|0;m+=T,g-=T*4}else g===0&&(m+="0");g>0&&(m+=$a.getFractionSign(g));let b=0;this._isSimpleDip?b=Math.min(d,f):b=t.offset===s.offset?Math.min(d,f):f;const S=c;o.fillText(m,S,b-p)}}}class eu extends wi{slash=null;noteNumbers=null;restGlyph=null;get effectElement(){return Je.GuitarTabEffects}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(e,t,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,s+this.y)}doLayout(){const e=this.renderer,t=[];if(this.container.beat.isRest){const i=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),r=e.getTabY(i),n=new jd(0,r,e.showRests,this.container.beat.duration);if(this.restGlyph=n,n.beat=this.container.beat,n.beamingHelper=this.beamingHelper,this.addNormal(n),this.container.beat.dots>0&&e.showRests)for(let o=0;o<this.container.beat.dots;o++)this.addEffect(new Rr(0,r))}else{const i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==$.None;let r;if(this.container.beat.slashed&&!this.container.beat.notes.some(n=>n.isTieDestination)){const n=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),o=e.getLineY(n),l=new li(0,o,this.container.beat.duration,i,this.container.beat);l.noteHeadElement=Vt.GuitarTabFretNumber,l.effectElement=Je.GuitarTabEffects,this.slash=l,l.beat=this.container.beat,l.beamingHelper=this.beamingHelper,this.addNormal(l),r=l.beatEffects}else{const n=new Zd(0,0,i);this.noteNumbers=n,n.beat=this.container.beat,n.beamingHelper=this.beamingHelper;for(const o of this.container.beat.notes)o.isVisible&&this._createNoteGlyph(o);this.addNormal(n),r=n.beatEffects}if(this.container.beat.hasWhammyBar){const n=new Yi(this.container.beat);n.renderer=this.renderer,n.doLayout(),this.container.ties.push(n)}if(this.container.beat.isTremolo&&!r.has("tremolo")){const n=this.container.beat.tremoloSpeed,o=new Xa(0,0,n);o.offsetY=this.renderer.smuflMetrics.glyphTop.get(o.symbol),r.set("tremolo",o),t.push(o)}if(this.container.beat.dots>0&&e.rhythmMode!==ks.Hidden)for(let n=0;n<this.container.beat.dots;n++)this.addEffect(new Rr(0,e.lineOffset*e.bar.staff.tuning.length+e.settings.notation.rhythmHeight))}if(this.isEmpty)return;let s=0;for(let i=0,r=this.glyphs.length;i<r;i++){const n=this.glyphs[i];n.x=s,n.renderer=this.renderer,n.doLayout(),s+=n.width}this.width=s,this.computedWidth=s,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(const i of t)i.x=this.centerX}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}_createNoteGlyph(e){const t=this.renderer,s=new Kd(0,0,e),i=e.beat.voice.bar.staff.tuning.length-e.string;s.y=t.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,e);const r=s.y-s.height/2,n=r+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,r,n)}}class tu extends ot{_beat;_noteVibratoGlyph;constructor(e){super(0,0),this._beat=e}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(u.ArrowheadBlackDown),this._beat.brushType===Y.ArpeggioUp){const e=new Ti(0,0,be.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}else if(this._beat.brushType===Y.ArpeggioDown){const e=new Ti(0,0,be.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}}paint(e,t,s){const i=this.renderer,r=t+this.x+i.getNoteY(this._beat.maxStringNote,R.Top),n=t+this.y+i.getNoteY(this._beat.minStringNote,R.Bottom),o=e+this.x+this.width/2,l=this.renderer.smuflMetrics.glyphWidths.get(u.ArrowheadBlackDown);if(this._beat.brushType!==Y.None){if(this._beat.brushType===Y.BrushUp||this._beat.brushType===Y.BrushDown)s.beginPath(),s.moveTo(o,r),s.lineTo(o,n),s.stroke();else if(this._beat.brushType===Y.ArpeggioUp){const h=this._noteVibratoGlyph,c=r,d=n-l;h.width=Math.abs(d-c),s.beginRotate(e+this.x,d,-90),h.paint(0,(this.width-h.height)/2,s),s.endRotate()}else if(this._beat.brushType===Y.ArpeggioDown){const h=this._noteVibratoGlyph,c=r+l,d=n;h.width=Math.abs(d-c),s.beginRotate(e+this.x,c,90),h.paint(0,-(this.width-h.height/2),s),s.endRotate()}this._beat.brushType===Y.BrushUp||this._beat.brushType===Y.ArpeggioUp?(s.beginPath(),s.moveTo(o,n),s.lineTo(o+l/2,n-l),s.lineTo(o-l/2,n-l),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(o,r),s.lineTo(o+l/2,r+l),s.lineTo(o-l/2,r+l),s.closePath(),s.fill())}}}class su extends ki{doLayout(){this.container.beat.brushType!==Y.None&&!this.container.beat.isRest&&(this.addEffect(new tu(this.container.beat)),this.addNormal(new ss(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return Je.GuitarTabEffects}}class iu extends gt{constructor(e,t){super(e,t,1,u.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?u.FourStringTabClef:u.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(u.GClef),this.offsetX=this.width/2}}class ru extends ll{doLayout(){this.barSubElement=Pe.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?ve.GraceScale:1}}class Fn extends ni{static StaffId="tab";_hasTuplets=!1;showTimeSignature=!1;showRests=!1;showTiedNotes=!1;_showMultiBarRest=!1;get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return Pe.GuitarTabsRepeats}get barNumberBarSubElement(){return Pe.GuitarTabsBarNumber}get barLineBarSubElement(){return Pe.GuitarTabsBarLines}get staffLineBarSubElement(){return Pe.GuitarTabsStaffLine}constructor(e,t){super(e,t),t.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===ks.Automatic&&(e=this.bar.staff.showStandardNotation?ks.Hidden:ks.ShowWithBars),e}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){const t=this.smuflMetrics.staffLineThickness;for(const s of this.bar.voices)if(this.hasVoiceContainer(s)){const i=this.getVoiceContainer(s);for(const r of i.beatGlyphs){const n=r.onNotes,o=n.noteNumbers;if(o)for(const[l,h]of o.notesPerString)h.isEmpty||e[this.bar.staff.tuning.length-l].push(new Float32Array([i.x+r.x+n.x+o.x-t,o.width+t*2]))}}}adjustSizes(){if(this.rhythmMode!==ks.Hidden){let e=y.Whole;for(const t of this.helpers.beamHelpers)for(const s of t)s.tremoloDuration&&(!e||e<s.tremoloDuration)&&(e=s.tremoloDuration);switch(e){case y.Eighth:this.height+=this.smuflMetrics.glyphHeights.get(u.Tremolo1);break;case y.Sixteenth:this.height+=this.smuflMetrics.glyphHeights.get(u.Tremolo2);break;case y.ThirtySecond:this.height+=this.smuflMetrics.glyphHeights.get(u.Tremolo3);break}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),this.rhythmMode!==ks.Hidden){this._hasTuplets=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){const e=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new iu(0,this.getTabY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this._createTimeSignatureGlyphs())}_createTimeSignatureGlyphs(){this.addPreBeatGlyph(new ss(0,0,this.smuflMetrics.oneStaffSpace));const e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new ru(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){const t=new Wa(this.getVoiceContainer(e));this.addBeatGlyph(t)}else for(const t of e.beats){const s=new Qd(t,this.getVoiceContainer(e));s.preNotes=new su,s.onNotes=new eu,this.addBeatGlyph(s)}}paint(e,t,s){super.paint(e,t,s),this.rhythmMode!==ks.Hidden&&(this.paintBeams(e,t,s,Je.GuitarTabFlags,Je.GuitarTabBeams),this.paintTuplets(e,t,s,Je.GuitarTabTuplet))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===ks.ShowWithBeams}getFlagTopY(e,t){const s=this.getOnNotesGlyphForBeat(e);return!s.noteNumbers||e.duration===y.Half?this.height-this.settings.notation.rhythmHeight-this.tupletSize:s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,R.Bottom)+this.smuflMetrics.staffLineThickness}getFlagBottomY(e,t){return this.getFlagAndBarPos()}getFlagStemSize(e,t=!1){return 0}getBarLineStart(e,t){return this.getFlagTopY(e,t)}getBeamDirection(e){return P.Down}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,s){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!super.shouldPaintFlag(e,t)||e.graceType!==$.None?!1:this.drawBeamHelperAsFlags(t)}paintBeamingStem(e,t,s,i,r,n){if(r<i){const l=r;r=i,i=l}const o=Se.beat(n,Je.GuitarTabStem,e);try{let l=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(l=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),l.sort((c,d)=>c.topY-d.topY));let h=r;for(;h>i;){let c=i;if(l.length>0&&l[l.length-1].bottomY>c){const d=l.pop();c=t+d.bottomY,n.fillRect(s,c,this.smuflMetrics.stemThickness,h-c),h=t+d.topY}else{n.fillRect(s,c,this.smuflMetrics.stemThickness,h-c);break}}}finally{o?.[Symbol.dispose]?.()}}}class Mn extends vr{showTimeSignature=null;showRests=null;showTiedNotes=null;get staffId(){return Fn.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.hideOnPercussionTrack=!0}canCreate(e,t){return t.showTablature&&t.tuning.length>0&&super.canCreate(e,t)}create(e,t){const s=new Fn(e,t);return this.showRests!==null&&(s.showRests=this.showRests),this.showTimeSignature!==null&&(s.showTimeSignature=this.showTimeSignature),this.showTiedNotes!==null&&(s.showTiedNotes=this.showTiedNotes),s}}class bl{vertical;createLayout;constructor(e,t){this.vertical=e,this.createLayout=t}}class An{supportsWorkers;createCanvas;constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class F{static _staffIdBeforeSlashAlways="before-slash-always";static _staffIdBeforeScoreAlways="before-score-always";static _staffIdBeforeScoreHideable="before-score-hideable";static _staffIdBeforeNumberedAlways="before-numbered-always";static _staffIdBeforeTabAlways="before-tab-always";static _staffIdBeforeTabHideable="before-tab-hideable";static _staffIdBeforeEndAlways="before-end-always";static highDpiFactor=1;static _globalThis=void 0;static get globalThis(){if(F._globalThis===void 0){try{F._globalThis=globalThis}catch{}typeof F._globalThis>"u"&&(F._globalThis=self),typeof F._globalThis>"u"&&(F._globalThis=global),typeof F._globalThis>"u"&&(F._globalThis=window),typeof F._globalThis>"u"&&(F._globalThis=Function("return this")())}return F._globalThis}static webPlatform=F._detectWebPlatform();static isWebPackBundled=F._detectWebPack();static isViteBundled=F._detectVite();static scriptFile=F._detectScriptFile();static fontDirectory=F._detectFontDirectory();static get isRunningInWorker(){return"WorkerGlobalScope"in F.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in F.globalThis}static createWebWorker;static createAudioWorklet;static throttle(e,t){let s=0;return()=>{F.globalThis.clearTimeout(s),s=F.globalThis.setTimeout(e,t)}}static _detectScriptFile(){if(!F.isRunningInWorker&&F.globalThis.ALPHATAB_ROOT){let e=F.globalThis.ALPHATAB_ROOT;return e=F.ensureFullUrl(e),e=F._appendScriptName(e),e}try{const e=self.location.href;if(e&&e.indexOf("file://")===-1)return e}catch{}return"document"in F.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(e){if(!e)return"";if(!e.startsWith("http")&&!e.startsWith("https")&&!e.startsWith("file")){let t="";const s=F.globalThis.location;if(t+=s.protocol?.toString(),t+="//",s.hostname&&(t+=s.hostname?.toString()),s.port&&(t+=":",t+=s.port?.toString()),!e.startsWith("/")){const i=s.pathname.split("/").slice(0,-1).join("/");i.length>0&&(i.startsWith("/")||(t+="/"),t+=i?.toString())}return e.startsWith("/")||(t+="/"),t+=e?.toString(),t}return e}static _appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static _detectFontDirectory(){if(!F.isRunningInWorker&&F.globalThis.ALPHATAB_FONT)return F.ensureFullUrl(F.globalThis.ALPHATAB_FONT);const e=F.scriptFile;if(e){const t=e.lastIndexOf("/");if(t>=0)return`${e.substr(0,t)}/font/`}return null}static _registerJQueryPlugin(){if(!F.isRunningInWorker&&F.globalThis&&"jQuery"in F.globalThis){const e=F.globalThis.jQuery,t=new Uo;e.fn.alphaTab=function(s){const i=Array.prototype.slice.call(arguments,1);return this.length===1?t.exec(this[0],s,i):this.each((r,n)=>{t.exec(n,s,i)})},e.alphaTab={restore:Uo.restore},e.fn.alphaTab.fn=t}}static renderEngines=F._createDefaultRenderEngines();static layoutEngines=F._createDefaultLayoutEngines();static staveProfiles=F._createDefaultStaveProfiles();static getRenderEngineFactory(e){return!e||!F.renderEngines.has(e)?F.renderEngines.get("default"):F.renderEngines.get(e)}static getLayoutEngineFactory(e){return!e||!F.layoutEngines.has(e)?F.layoutEngines.get($s.Page):F.layoutEngines.get(e)}static buildImporters(){return[new pi,new Ql,new Jl,new Ue,new Hl,new Za]}static _createDefaultRenderEngines(){const e=new Map;return e.set("svg",new An(!0,()=>new cc)),e.set("default",e.get("svg")),e.set("skia",new An(!1,()=>new it)),F._createPlatformSpecificRenderEngines(e),e}static enableAlphaSkia(e,t){it.enable(e,t)}static registerAlphaSkiaCustomFont(e){return it.registerFont(e)}static _createPlatformSpecificRenderEngines(e){e.set("html5",new An(!1,()=>new Rh))}static _createDefaultRenderers(){return[new Hi(F._staffIdBeforeSlashAlways,[new cd,new pd,new jc,new Gc,new Mc,new $c,new dd,new Ic,new Wc]),new $d,new Hi(F._staffIdBeforeScoreAlways,[new Yc,new Va,new ed,new ad,new gd]),new Hi(F._staffIdBeforeScoreHideable,[new md,new el,new qo(!0),new tl,new Zo,new sl,new jo(!1),new $o,new Ga(Ht.Finger)],(e,t)=>t.showStandardNotation),new zd,new Hi(F._staffIdBeforeNumberedAlways,[new Vc,new qo(!1),new Uc,new Ga(Ht.Thumb,(e,t)=>t.voice.bar.staff.showStandardNotation),new od]),new Ed,new Hi(F._staffIdBeforeTabAlways,[new Zc]),new Hi(F._staffIdBeforeTabHideable,[new el,new tl,new Zo,new sl,new jo(!0),new ld,new zc,new Bi(Q.Natural),new Bi(Q.Artificial),new Bi(Q.Pinch),new Bi(Q.Tap),new Bi(Q.Semi),new Bi(Q.Feedback),new Qc,new Rc,new Jc,new sd,new rd,new id,new $o,new Ga(Ht.Finger,(e,t)=>!t.voice.bar.staff.showStandardNotation)],(e,t)=>t.showTablature),new Mn,new Hi(F._staffIdBeforeEndAlways,[new Ga(Ht.Thumb,(e,t)=>!t.voice.bar.staff.showStandardNotation)])]}static _createDefaultStaveProfiles(){const e=new Map,t=F._createDefaultRenderers();e.set(ii.Default,t),e.set(ii.ScoreTab,t);const s=new Set([F._staffIdBeforeSlashAlways,F._staffIdBeforeScoreAlways,F._staffIdBeforeNumberedAlways,F._staffIdBeforeTabAlways,Ni.StaffId,F._staffIdBeforeEndAlways]);e.set(ii.Score,t.filter(r=>s.has(r.staffId)));const i=new Set([F._staffIdBeforeSlashAlways,F._staffIdBeforeScoreAlways,F._staffIdBeforeNumberedAlways,F._staffIdBeforeTabAlways,Fn.StaffId,F._staffIdBeforeEndAlways]);return e.set(ii.Tab,F._createDefaultRenderers().filter(r=>{if(r instanceof Mn){const n=r;n.showTimeSignature=!0,n.showRests=!0,n.showTiedNotes=!0}return i.has(r.staffId)})),e.set(ii.TabMixed,F._createDefaultRenderers().filter(r=>{if(r instanceof Mn){const n=r;n.showTimeSignature=!1,n.showRests=!1,n.showTiedNotes=!1}return i.has(r.staffId)})),e}static _createDefaultLayoutEngines(){const e=new Map;return e.set($s.Page,new bl(!0,t=>new bd(t))),e.set($s.Horizontal,new bl(!1,t=>new yd(t))),e}static initializeMain(e,t){F.isRunningInWorker||F.isRunningInAudioWorklet||((F.webPlatform===Bs.Browser||F.webPlatform===Bs.BrowserModule)&&(F._registerJQueryPlugin(),F.highDpiFactor=window.devicePixelRatio),F.createWebWorker=e,F.createAudioWorklet=t)}static get alphaTabWorker(){return F.globalThis.Worker}static get alphaTabUrl(){return F.globalThis.URL}static initializeWorker(){if(!F.isRunningInWorker)throw new Ve(Oe.General,"Not running in worker, cannot run worker initialization");gn.init(),pn.init(),F.createWebWorker=e=>{throw new Ve(Oe.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!F.isRunningInAudioWorklet)throw new Ve(Oe.General,"Not running in audio worklet, cannot run worklet initialization");Kr.init()}static _detectWebPack(){try{if(typeof __webpack_require__=="function")return!0}catch{}return!1}static _detectVite(){try{if(typeof __BASE__=="string")return!0}catch{}return!1}static _detectWebPlatform(){if(!(typeof F.globalThis.Window<"u"&&F.globalThis instanceof F.globalThis.Window))try{if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return Bs.NodeJs}catch{}try{const t=self.location.href;if(t&&typeof t=="string"&&!t.startsWith("file://"))return Bs.BrowserModule}catch{}return Bs.Browser}static printEnvironmentInfo(e=!0){const t=e?s=>{E.log.debug("VersionInfo",s)}:s=>{E.debug("VersionInfo",s)};Ei.print(t),t(`High DPI: ${F.highDpiFactor}`),F._printPlatformInfo(t)}static _printPlatformInfo(e){e(`Platform: ${Bs[F.webPlatform]}`),e(`WebPack: ${F.isWebPackBundled}`),e(`Vite: ${F.isViteBundled}`),F.webPlatform!==Bs.NodeJs&&(e(`Browser: ${navigator.userAgent}`),e(`Window Size: ${window.outerWidth}x${window.outerHeight}`),e(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(e){if(!e)return e;if(typeof e=="object"){const t=e.__v_raw;if(t)return F.prepareForPostMessage(t)}return e}static quoteJsonString(e){return JSON.stringify(e)}}var Ns;(function(a){a[a.EmbeddedOpenType=0]="EmbeddedOpenType",a[a.Woff=1]="Woff",a[a.Woff2=2]="Woff2",a[a.OpenType=3]="OpenType",a[a.TrueType=4]="TrueType",a[a.Svg=5]="Svg"})(Ns||(Ns={}));class _l{scriptFile=null;fontDirectory=null;smuflFontSources=null;static buildDefaultSmuflFontSources(e){const t=new Map,s=e??"";return t.set(Ns.Woff2,`${s}Bravura.woff2`),t.set(Ns.Woff,`${s}Bravura.woff`),t.set(Ns.OpenType,`${s}Bravura.otf`),t}file=null;tex=!1;tracks=null;enableLazyLoading=!0;engine="default";logLevel=Es.Info;useWorkers=!0;includeNoteBounds=!1;constructor(){this.scriptFile=F.scriptFile,this.fontDirectory=F.fontDirectory}}var M;(function(a){a[a.SteelGuitar=1]="SteelGuitar",a[a.AcousticGuitar=2]="AcousticGuitar",a[a.TwelveStringGuitar=3]="TwelveStringGuitar",a[a.ElectricGuitar=4]="ElectricGuitar",a[a.Bass=5]="Bass",a[a.ClassicalGuitar=23]="ClassicalGuitar",a[a.UprightBass=6]="UprightBass",a[a.Ukulele=7]="Ukulele",a[a.Banjo=8]="Banjo",a[a.Mandolin=9]="Mandolin",a[a.Piano=10]="Piano",a[a.Synth=12]="Synth",a[a.Strings=11]="Strings",a[a.Brass=13]="Brass",a[a.Reed=14]="Reed",a[a.Woodwind=15]="Woodwind",a[a.Vocal=16]="Vocal",a[a.PitchedIdiophone=17]="PitchedIdiophone",a[a.Fx=21]="Fx",a[a.PercussionKit=18]="PercussionKit",a[a.Idiophone=19]="Idiophone",a[a.Membraphone=20]="Membraphone"})(M||(M={}));class I{icon=M.Piano;instrumentSetName;instrumentSetType;constructor(e,t,s=null){if(this.icon=e,this.instrumentSetName=t,s)this.instrumentSetType=s;else{const i=t.split(" ");i[0]=i[0].substr(0,1).toLowerCase()+i[0].substr(1),this.instrumentSetType=i.join("")}}}class _s{static _sampleRate=44100;_rhythmIdLookup=new Map;static _midiProgramInfoLookup=new Map([[0,new I(M.Piano,"Acoustic Piano")],[1,new I(M.Piano,"Acoustic Piano")],[2,new I(M.Piano,"Electric Piano")],[3,new I(M.Piano,"Acoustic Piano")],[4,new I(M.Piano,"Electric Piano")],[5,new I(M.Piano,"Electric Piano")],[6,new I(M.Piano,"Harpsichord")],[7,new I(M.Piano,"Harpsichord")],[8,new I(M.PitchedIdiophone,"Celesta")],[9,new I(M.PitchedIdiophone,"Vibraphone")],[10,new I(M.PitchedIdiophone,"Vibraphone")],[11,new I(M.PitchedIdiophone,"Vibraphone")],[12,new I(M.PitchedIdiophone,"Xylophone")],[13,new I(M.PitchedIdiophone,"Xylophone")],[14,new I(M.PitchedIdiophone,"Vibraphone")],[15,new I(M.Banjo,"Banjo")],[16,new I(M.Piano,"Electric Organ")],[17,new I(M.Piano,"Electric Organ")],[18,new I(M.Piano,"Electric Organ")],[19,new I(M.Piano,"Electric Organ")],[20,new I(M.Piano,"Electric Organ")],[21,new I(M.Piano,"Electric Organ")],[22,new I(M.Woodwind,"Recorder")],[23,new I(M.Piano,"Electric Organ")],[24,new I(M.ClassicalGuitar,"Nylon Guitar")],[25,new I(M.SteelGuitar,"Steel Guitar")],[26,new I(M.SteelGuitar,"Electric Guitar")],[27,new I(M.ElectricGuitar,"Electric Guitar")],[28,new I(M.ElectricGuitar,"Electric Guitar")],[29,new I(M.ElectricGuitar,"Electric Guitar")],[30,new I(M.SteelGuitar,"Electric Guitar")],[31,new I(M.SteelGuitar,"Electric Guitar")],[32,new I(M.Bass,"Acoustic Bass")],[33,new I(M.Bass,"Electric Bass")],[34,new I(M.Bass,"Electric Bass")],[35,new I(M.Bass,"Acoustic Bass")],[36,new I(M.Bass,"Electric Bass")],[37,new I(M.Bass,"Electric Bass")],[38,new I(M.Synth,"Synth Bass")],[39,new I(M.Synth,"Synth Bass")],[40,new I(M.Strings,"Violin")],[41,new I(M.Strings,"Viola")],[42,new I(M.Strings,"Cello")],[43,new I(M.Strings,"Contrabass")],[44,new I(M.Strings,"Violin")],[45,new I(M.Strings,"Violin")],[46,new I(M.Piano,"Harp")],[47,new I(M.Membraphone,"Timpani")],[48,new I(M.Strings,"Violin")],[49,new I(M.Strings,"Violin")],[50,new I(M.Strings,"Violin")],[51,new I(M.Strings,"Violin")],[52,new I(M.Vocal,"Voice")],[53,new I(M.Vocal,"Voice")],[54,new I(M.Vocal,"Voice")],[55,new I(M.Synth,"Pad Synthesizer")],[56,new I(M.Brass,"Trumpet")],[57,new I(M.Brass,"Trombone")],[58,new I(M.Brass,"Tuba")],[59,new I(M.Brass,"Trumpet")],[60,new I(M.Brass,"French Horn")],[61,new I(M.Brass,"Trumpet")],[62,new I(M.Brass,"Trumpet")],[63,new I(M.Brass,"Trumpet")],[64,new I(M.Reed,"Saxophone")],[65,new I(M.Reed,"Saxophone")],[66,new I(M.Reed,"Saxophone")],[67,new I(M.Reed,"Saxophone")],[68,new I(M.Reed,"Oboe")],[69,new I(M.Reed,"English Horn")],[70,new I(M.Reed,"Bassoon")],[71,new I(M.Reed,"Clarinet")],[72,new I(M.Reed,"Piccolo")],[73,new I(M.Woodwind,"Flute")],[74,new I(M.Woodwind,"Recorder")],[75,new I(M.Woodwind,"Flute")],[76,new I(M.Woodwind,"Recorder")],[77,new I(M.Woodwind,"Flute")],[78,new I(M.Woodwind,"Recorder")],[79,new I(M.Woodwind,"Flute")],[80,new I(M.Synth,"Lead Synthesizer")],[81,new I(M.Synth,"Lead Synthesizer")],[82,new I(M.Synth,"Lead Synthesizer")],[83,new I(M.Synth,"Lead Synthesizer")],[84,new I(M.Synth,"Lead Synthesizer")],[85,new I(M.Synth,"Lead Synthesizer")],[86,new I(M.Synth,"Lead Synthesizer")],[87,new I(M.Synth,"Lead Synthesizer")],[88,new I(M.Synth,"Pad Synthesizer")],[89,new I(M.Synth,"Pad Synthesizer")],[90,new I(M.Synth,"Pad Synthesizer")],[91,new I(M.Synth,"Pad Synthesizer")],[92,new I(M.Synth,"Pad Synthesizer")],[93,new I(M.Synth,"Pad Synthesizer")],[94,new I(M.Synth,"Pad Synthesizer")],[95,new I(M.Synth,"Pad Synthesizer")],[96,new I(M.Fx,"Pad Synthesizer")],[97,new I(M.Fx,"Pad Synthesizer")],[98,new I(M.Fx,"Pad Synthesizer")],[99,new I(M.Fx,"Pad Synthesizer")],[100,new I(M.Fx,"Lead Synthesizer")],[101,new I(M.Fx,"Lead Synthesizer")],[102,new I(M.Fx,"Lead Synthesizer")],[103,new I(M.Fx,"Trumpet")],[104,new I(M.ElectricGuitar,"Banjo")],[105,new I(M.Banjo,"Banjo")],[106,new I(M.Ukulele,"Ukulele")],[107,new I(M.Banjo,"Banjo")],[108,new I(M.PitchedIdiophone,"Xylophone")],[109,new I(M.Reed,"Bassoon")],[110,new I(M.Strings,"Violin")],[111,new I(M.Woodwind,"Flute")],[112,new I(M.PitchedIdiophone,"Xylophone")],[113,new I(M.Idiophone,"Celesta")],[114,new I(M.PitchedIdiophone,"Vibraphone")],[115,new I(M.Idiophone,"Xylophone")],[116,new I(M.Membraphone,"Xylophone")],[117,new I(M.Membraphone,"Xylophone")],[118,new I(M.Membraphone,"Xylophone")],[119,new I(M.Idiophone,"Celesta")],[120,new I(M.Fx,"Steel Guitar")],[121,new I(M.Fx,"Recorder")],[122,new I(M.Fx,"Recorder")],[123,new I(M.Fx,"Recorder")],[124,new I(M.Fx,"Recorder")],[125,new I(M.Fx,"Recorder")],[126,new I(M.Fx,"Recorder")],[127,new I(M.Fx,"Timpani")]]);static _drumKitProgramInfo=new I(M.PercussionKit,"Drums","drumKit");writeXml(e){const t=new fr;return this._rhythmIdLookup=new Map,this._writeDom(t,e),t.toFormattedString("",!0)}_writeDom(e,t){const s=e.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const r=s.addElement("Encoding");r.addElement("EncodingDescription").innerText="GP8";const n=new gs;n.nodeType=et.Comment,n.value=`Written by alphaTab ${Ei.version} (${Ei.commit})`,r.addChild(n),this._writeScoreNode(s,t),this._writeMasterTrackNode(s,t),this._writeBackingTrackNode(s,t),this._writeAudioTracksNode(s,t),this._writeTracksNode(s,t),this._writeMasterBarsNode(s,t),this._writeAssets(s,t);const o=s.addElement("Bars"),l=s.addElement("Voices"),h=s.addElement("Beats"),c=s.addElement("Notes"),d=s.addElement("Rhythms");for(const f of t.tracks)for(const p of f.staves)for(const g of p.bars){this._writeBarNode(o,g);for(const m of g.voices){this._writeVoiceNode(l,m);for(const b of m.beats){this._writeBeatNode(h,b,d);for(const S of b.notes)this._writeNoteNode(c,S)}}}}_writeAssets(e,t){if(!t.backingTrack?.rawAudioFile)return;const i=e.addElement("Assets").addElement("Asset");i.attributes.set("id",this._backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",i.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}_backingTrackAssetId;_backingTrackFramePadding;backingTrackAssetFileName;_writeBackingTrackNode(e,t){if(!t.backingTrack?.rawAudioFile)return;const s=e.addElement("BackingTrack"),i="0";this._backingTrackAssetId=i,s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText=i;const r=s.addElement("ChannelStrip");r.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",r.addElement("YouTubeVideoUrl").innerText="",r.addElement("Filter").innerText="6",r.addElement("FramesPerPixel").innerText="400";const n=this._backingTrackFramePadding!==void 0?this._backingTrackFramePadding:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}_writeNoteNode(e,t){const s=e.addElement("Note");s.attributes.set("id",t.id.toString()),this._writeNoteProperties(s,t),t.isGhost&&(s.addElement("AntiAccent").innerText="normal"),t.isLetRing&&s.addElement("LetRing"),t.isTrill&&(s.addElement("Trill").innerText=t.trillValue.toString());let i=0;switch(t.isStaccato&&(i|=1),t.accentuated){case tt.Normal:i|=8;break;case tt.Heavy:i|=4;break;case tt.Tenuto:i|=16;break}if(i>0&&(s.addElement("Accent").innerText=i.toString()),t.isTieOrigin||t.isTieDestination){const r=s.addElement("Tie");r.attributes.set("origin",t.isTieOrigin?"true":"false"),r.attributes.set("destination",t.isTieDestination?"true":"false")}switch(t.vibrato){case be.Slight:s.addElement("Vibrato").innerText="Slight";break;case be.Wide:s.addElement("Vibrato").innerText="Wide";break}if(t.isFingering){switch(t.leftHandFinger){case j.Thumb:s.addElement("LeftFingering").innerText="P";break;case j.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case j.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case j.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case j.LittleFinger:s.addElement("LeftFingering").innerText="C";break}switch(t.rightHandFinger){case j.Thumb:s.addElement("RightFingering").innerText="P";break;case j.IndexFinger:s.addElement("RightFingering").innerText="I";break;case j.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case j.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case j.LittleFinger:s.addElement("RightFingering").innerText="C";break}}t.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=t.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",t.ornament!==je.None&&(s.addElement("Ornament").innerText=je[t.ornament])}_writeNoteProperties(e,t){const s=e.addElement("Properties");if(this._writeConcertPitch(s,t),this._writeTransposedPitch(s,t),t.isStringed&&(this._writeSimplePropertyNode(s,"String","String",(t.string-1).toString()),this._writeSimplePropertyNode(s,"Fret","Fret",t.fret.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString()),t.showStringNumber&&this._writeSimplePropertyNode(s,"ShowStringNumber","Enable",null)),t.isPiano&&(this._writeSimplePropertyNode(s,"Octave","Number",t.octave.toString()),this._writeSimplePropertyNode(s,"Tone","Step",t.tone.toString()),this._writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString())),t.beat.tap&&this._writeSimplePropertyNode(s,"Tapped","Enable",null),t.harmonicType!==Q.None){switch(t.harmonicType){case Q.Natural:this._writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case Q.Artificial:this._writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case Q.Pinch:this._writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case Q.Tap:this._writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case Q.Semi:this._writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case Q.Feedback:this._writeSimplePropertyNode(s,"HarmonicType","HType","Feedback");break}t.harmonicValue!==0&&this._writeSimplePropertyNode(s,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this._writeSimplePropertyNode(s,"Muted","Enable",null),t.isPalmMute&&this._writeSimplePropertyNode(s,"PalmMuted","Enable",null),t.hasBend&&this._writeBend(s,t),t.isHammerPullOrigin&&this._writeSimplePropertyNode(s,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this._writeSimplePropertyNode(s,"HopoDestination","Enable",null),t.isLeftHandTapped&&this._writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(t.slideInType){case dt.IntoFromAbove:i|=32;break;case dt.IntoFromBelow:i|=16;break}switch(t.slideOutType){case ne.Shift:i|=1;break;case ne.Legato:i|=2;break;case ne.OutDown:i|=4;break;case ne.OutUp:i|=8;break;case ne.PickSlideDown:i|=64;break;case ne.PickSlideUp:i|=128;break}i>0&&this._writeSimplePropertyNode(s,"Slide","Flags",i.toString())}_writeTransposedPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode,t.beat.voice.bar.keySignature)}_writeConcertPitch(e,t){t.isPercussion?this._writePitch(e,"ConcertPitch","C","-1",""):this._writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode,t.beat.voice.bar.keySignature)}static _defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"];_writePitchForValue(e,t,s,i,r){let n=0,o=0,l="",h="";const c=()=>{switch(n=s%12,o=s/12|0,l=_s._defaultSteps[n],L.computeAccidental(r,re.Default,s,!1)){case K.None:case K.Natural:h="";break;case K.Sharp:h="#";break;case K.Flat:h="b";break;case K.DoubleSharp:h="x";break;case K.DoubleFlat:h="bb";break}};switch(c(),i){case re.Default:break;case re.ForceNone:h="";break;case re.ForceNatural:h="";break;case re.ForceSharp:h="#";break;case re.ForceDoubleSharp:h==="#"&&(s-=2,c()),h="x";break;case re.ForceFlat:h==="#"&&(s+=1,c()),h="b";break;case re.ForceDoubleFlat:h==="#"&&(s+=2,c()),h="bb";break}this._writePitch(e,t,l,o.toString(),h)}_writePitch(e,t,s,i,r){const n=e.addElement("Property");n.attributes.set("name",t);const o=n.addElement("Pitch");o.addElement("Step").innerText=s,o.addElement("Accidental").innerText=r,o.addElement("Octave").innerText=i}_writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this._writeStandardBend(e,t.bendPoints)}_writeStandardBend(e,t){this._writeSimplePropertyNode(e,"Bended","Enable",null);const s=t[0],i=t[t.length-1];let r,n;switch(t.length){case 4:r=t[1],n=t[2];break;case 3:r=t[1],n=t[1];break;default:r=new H((s.offset+i.offset)/2,(s.value+i.value)/2),n=r;break}this._writeSimplePropertyNode(e,"BendDestinationOffset","Float",this._toBendOffset(i.offset).toString()),this._writeSimplePropertyNode(e,"BendDestinationValue","Float",this._toBendValue(i.value).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this._toBendOffset(r.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this._toBendOffset(n.offset).toString()),this._writeSimplePropertyNode(e,"BendMiddleValue","Float",this._toBendValue(r.value).toString()),this._writeSimplePropertyNode(e,"BendOriginOffset","Float",this._toBendOffset(s.offset).toString()),this._writeSimplePropertyNode(e,"BendOriginValue","Float",this._toBendValue(s.value).toString())}_toBendValue(e){return e*25}_toBendOffset(e){return e/H.MaxPosition*100}_writeBeatNode(e,t,s){const i=e.addElement("Beat");if(i.attributes.set("id",t.id.toString()),i.addElement("Dynamic").innerText=Z[t.dynamics],t.fade!==ut.None&&(i.addElement("Fadding").innerText=ut[t.fade]),t.isTremolo)switch(t.tremoloSpeed){case y.Eighth:i.addElement("Tremolo").innerText="1/2";break;case y.Sixteenth:i.addElement("Tremolo").innerText="1/4";break;case y.ThirtySecond:i.addElement("Tremolo").innerText="1/8";break}switch(t.hasChord&&i.addElement("Chord").setCData(t.chordId),t.crescendo!==Lt.None&&(i.addElement("Hairpin").innerText=Lt[t.crescendo]),t.brushType){case Y.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case Y.ArpeggioDown:i.addElement("Arpeggio").innerText="Down";break}switch(t.text&&i.addElement("FreeText").setCData(t.text),t.graceType){case $.OnBeat:case $.BeforeBeat:i.addElement("GraceNotes").innerText=$[t.graceType];break}if(t.ottava!==ae.Regular&&(i.addElement("Ottavia").innerText=ae[t.ottava].substr(1)),t.hasWhammyBar&&this._writeWhammyNode(i,t),t.isLegatoOrigin||t.isLegatoDestination){const r=i.addElement("Legato");r.attributes.set("origin",t.isLegatoOrigin?"true":"false"),r.attributes.set("destination",t.isLegatoDestination?"true":"false")}if(this._writeRhythm(i,t,s),t.preferredBeamDirection!==null)switch(t.preferredBeamDirection){case P.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case P.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward";break}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.slashed&&i.addElement("Slashed"),t.deadSlapped&&i.addElement("DeadSlapped"),t.notes.length>0&&(i.addElement("Notes").innerText=t.notes.map(r=>r.id).join(" ")),t.golpe!==Ht.None&&(i.addElement("Golpe").innerText=Ht[t.golpe]),t.wahPedal!==Jt.None&&(i.addElement("Wah").innerText=Jt[t.wahPedal]),t.showTimer&&(i.addElement("Timer").innerText=(t.timer??0).toString()),this._writeBeatProperties(i,t),this._writeBeatXProperties(i,t),t.lyrics&&t.lyrics.length>0&&this._writeBeatLyrics(i,t.lyrics)}_writeBeatLyrics(e,t){const s=e.addElement("Lyrics");for(const i of t)s.addElement("Line").setCData(i)}_writeBeatXProperties(e,t){const s=e.addElement("XProperties");switch(t.brushDuration>0&&this._writeSimpleXPropertyNode(s,"687935489","Int",t.brushDuration.toString()),t.beamingMode){case Xe.ForceSplitToNext:this._writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case Xe.ForceMergeWithNext:this._writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case Xe.ForceSplitOnSecondaryToNext:this._writeSimpleXPropertyNode(s,"1124204552","Int","1");break}}_writeBeatProperties(e,t){const s=e.addElement("Properties");switch(t.brushType){case Y.BrushUp:this._writeSimplePropertyNode(s,"Brush","Direction","Up");break;case Y.BrushDown:this._writeSimplePropertyNode(s,"Brush","Direction","Down");break}switch(t.pickStroke){case kt.Up:this._writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case kt.Down:this._writeSimplePropertyNode(s,"PickStroke","Direction","Down");break}switch(t.slap&&this._writeSimplePropertyNode(s,"Slapped","Enable",null),t.pop&&this._writeSimplePropertyNode(s,"Popped","Enable",null),t.vibrato){case be.Wide:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case be.Slight:this._writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight");break}if(t.isBarre)switch(this._writeSimplePropertyNode(s,"BarreFret","Fret",t.barreFret.toString()),t.barreShape){case ps.Full:this._writeSimplePropertyNode(s,"BarreString","String","0");break;case ps.Half:this._writeSimplePropertyNode(s,"BarreString","String","1");break}if(t.rasgueado!==ie.None){let i="";switch(t.rasgueado){case ie.Ii:i="ii_1";break;case ie.Mi:i="mi_1";break;case ie.MiiTriplet:i="mii_1";break;case ie.MiiAnapaest:i="mii_2";break;case ie.PmpTriplet:i="pmp_1";break;case ie.PmpAnapaest:i="pmp_2";break;case ie.PeiTriplet:i="pei_1";break;case ie.PeiAnapaest:i="pei_2";break;case ie.PaiTriplet:i="pai_1";break;case ie.PaiAnapaest:i="pai_2";break;case ie.AmiTriplet:i="ami_1";break;case ie.AmiAnapaest:i="ami_2";break;case ie.Ppp:i="ppp_1";break;case ie.Amii:i="amii_1";break;case ie.Amip:i="amip_1";break;case ie.Eami:i="eami_1";break;case ie.Eamii:i="eamii_1";break;case ie.Peami:i="peami_1";break}this._writeSimplePropertyNode(s,"Rasgueado","Rasgueado",i)}}_writeRhythm(e,t,s){const i=`${t.duration}_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`;let r;if(this._rhythmIdLookup.has(i))r=this._rhythmIdLookup.get(i);else{r=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(i,r);const n=s.addElement("Rhythm");if(n.attributes.set("id",r),t.hasTuplet){const l=n.addElement("PrimaryTuplet");l.attributes.set("num",t.tupletNumerator.toString()),l.attributes.set("den",t.tupletDenominator.toString())}t.dots>0&&n.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let o="Quarter";switch(t.duration){case y.QuadrupleWhole:o="Long";break;case y.DoubleWhole:o="DoubleWhole";break;case y.Whole:o="Whole";break;case y.Half:o="Half";break;case y.Quarter:o="Quarter";break;case y.Eighth:o="Eighth";break;case y.Sixteenth:o="16th";break;case y.ThirtySecond:o="32nd";break;case y.SixtyFourth:o="64th";break;case y.OneHundredTwentyEighth:o="128th";break;case y.TwoHundredFiftySixth:o="256th";break}n.addElement("NoteValue").innerText=o}e.addElement("Rhythm").attributes.set("ref",r)}_writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this._writeStandardWhammy(e,t.whammyBarPoints)}_writeStandardWhammy(e,t){const s=e.addElement("Whammy"),i=t[0],r=t[t.length-1];let n,o;switch(t.length){case 4:n=t[1],o=t[2];break;case 3:n=t[1],o=t[1];break;default:n=new H((i.offset+r.offset)/2,(i.value+r.value)/2),o=n;break}s.attributes.set("destinationOffset",this._toBendOffset(r.offset).toString()),s.attributes.set("destinationValue",this._toBendValue(r.value).toString()),s.attributes.set("middleOffset1",this._toBendOffset(n.offset).toString()),s.attributes.set("middleOffset2",this._toBendOffset(o.offset).toString()),s.attributes.set("middleValue",this._toBendValue(n.value).toString()),s.attributes.set("originOffset",this._toBendOffset(i.offset).toString()),s.attributes.set("originValue",this._toBendValue(i.value).toString())}_writeScoreNode(e,t){const s=e.addElement("Score");s.addElement("Title").setCData(t.title),s.addElement("SubTitle").setCData(t.subTitle),s.addElement("Artist").setCData(t.artist),s.addElement("Album").setCData(t.album),s.addElement("Words").setCData(t.words),s.addElement("Music").setCData(t.music),s.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),s.addElement("Copyright").setCData(t.copyright),s.addElement("Tabber").setCData(t.tab),s.addElement("Instructions").setCData(t.instructions),s.addElement("Notices").setCData(t.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(t.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(t.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}_writeMasterTrackNode(e,t){const s=e.addElement("MasterTrack");s.addElement("Tracks").innerText=t.tracks.map(l=>l.index).join(" ");const i=s.addElement("Automations");if(t.masterBars.length>0&&t.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),t.masterBars[0].tempoAutomations.length===0){const l=i.addElement("Automation");l.addElement("Type").innerText="Tempo",l.addElement("Linear").innerText="false",l.addElement("Bar").innerText="0",l.addElement("Position").innerText="0",l.addElement("Visible").innerText="true",l.addElement("Value").innerText=`${t.tempo} 2`,t.tempoLabel&&(l.addElement("Text").innerText=t.tempoLabel)}const r=t.masterBars[0].syncPoints?t.masterBars[0].syncPoints.find(l=>l.ratioPosition===0&&l.syncPointValue.barOccurence===0):void 0,n=r?r.syncPointValue.millisecondOffset:0;this._backingTrackFramePadding=-1*(n/1e3*_s._sampleRate)|0;const o=new Ji(()=>we.buildModifiedTempoLookup(t));for(const l of t.masterBars){for(const h of l.tempoAutomations){const c=i.addElement("Automation");c.addElement("Type").innerText="Tempo",c.addElement("Linear").innerText=h.isLinear?"true":"false",c.addElement("Bar").innerText=l.index.toString(),c.addElement("Position").innerText=h.ratioPosition.toString(),c.addElement("Visible").innerText=h.isVisible?"true":"false",c.addElement("Value").innerText=`${h.value} 2`,h.text&&(c.addElement("Text").innerText=h.text)}if(l.syncPoints)for(const h of l.syncPoints){const c=i.addElement("Automation");c.addElement("Type").innerText="SyncPoint",c.addElement("Linear").innerText="false",c.addElement("Bar").innerText=l.index.toString(),c.addElement("Position").innerText=h.ratioPosition.toString(),c.addElement("Visible").innerText=h.isVisible?"true":"false";const d=c.addElement("Value");d.addElement("BarIndex").innerText=l.index.toString(),d.addElement("BarOccurrence").innerText=h.syncPointValue.barOccurence.toString(),d.addElement("ModifiedTempo").innerText=o.value.get(h).syncBpm.toString(),d.addElement("OriginalTempo").innerText=t.tempo.toString();let f=(h.syncPointValue.millisecondOffset-n)/1e3*_s._sampleRate;f=Math.floor(f+.5),d.addElement("FrameOffset").innerText=f.toString()}}}_writeAudioTracksNode(e,t){e.addElement("AudioTracks")}_writeTracksNode(e,t){const s=e.addElement("Tracks");for(const i of t.tracks)this._writeTrackNode(s,i)}_writeTrackNode(e,t){const s=e.addElement("Track");s.attributes.set("id",t.index.toString()),s.addElement("Name").setCData(t.name),s.addElement("ShortName").setCData(t.shortName),s.addElement("Color").innerText=`${t.color.r} ${t.color.g} ${t.color.b}`,s.addElement("SystemsDefautLayout").innerText=t.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=t.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=Zt.isGuitar(t.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=_s._getIconId(t.playbackInfo).toString(),this._writeInstrumentSetNode(s,t),this._writeTransposeNode(s,t),this._writeRseNode(s,t),s.addElement("ForcedSound").innerText="-1",this._writeMidiConnectionNode(s,t),t.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":t.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this._writeLyricsNode(s,t),this._writeStavesNode(s,t),this._writeSoundsAndAutomations(s,t)}static _getIconId(e){return e.primaryChannel===9?_s._drumKitProgramInfo.icon:_s._midiProgramInfoLookup.has(e.program)?_s._midiProgramInfoLookup.get(e.program).icon:M.SteelGuitar}_writeSoundAndAutomation(e,t,s,i,r,n,o,l,h=0){const c=e.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(r);const d=c.addElement("MIDI"),f=Zt.bankToLsbMsb(l);d.addElement("LSB").innerText=f[0].toString(),d.addElement("MSB").innerText=f[1].toString(),d.addElement("Program").innerText=o.toString();const p=t.addElement("Automation");p.addElement("Type").innerText="Sound",p.addElement("Linear").innerText="false",p.addElement("Bar").innerText=n.toString(),p.addElement("Position").innerText=h.toString(),p.addElement("Visible").innerText="true",p.addElement("Value").setCData(`${i};${s};${r}`)}_writeSoundsAndAutomations(e,t){const s=e.addElement("Sounds"),i=e.addElement("Automations");if(t.staves.length>0&&t.staves[0].bars.length>0){const r=`Track_${t.index}_Initial`,n=`Midi/${t.playbackInfo.program}`,o="Factory";let l=!1,h=t.playbackInfo.bank;for(const c of t.staves)for(const d of c.bars)for(const f of d.voices)for(const p of f.beats){const g=p.getAutomation(De.Instrument),m=d.index===0&&p.index===0,b=p.getAutomation(De.Bank);if(b&&(h=b.value),g){const S=m?r:`ProgramChange_${p.id}`,T=m?n:`Midi/${g.value}`,C=m?o:"User";!m&&!l&&(this._writeSoundAndAutomation(s,i,r,n,o,t.staves[0].bars[0].index,t.playbackInfo.program,t.playbackInfo.bank),l=!0),this._writeSoundAndAutomation(s,i,S,T,C,d.index,g.value,h,g.ratioPosition),m&&(l=!0)}}}for(const r of t.staves)for(const n of r.bars)for(const o of n.sustainPedals)if(o.pedalType!==qe.Hold){const l=i.addElement("Automation");switch(l.addElement("Type").innerText="SustainPedal",l.addElement("Linear").innerText="false",l.addElement("Bar").innerText=n.index.toString(),l.addElement("Position").innerText=o.ratioPosition.toString(),l.addElement("Visible").innerText="true",o.pedalType){case qe.Down:l.addElement("Value").innerText="0 1";break;case qe.Up:l.addElement("Value").innerText="0 3";break}}}_writeMidiConnectionNode(e,t){const s=e.addElement("MidiConnection");s.addElement("Port").innerText=t.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}_writeRseNode(e,t){const i=e.addElement("RSE").addElement("ChannelStrip");i.attributes.set("version","E56");const r=i.addElement("Parameters");r.innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}_writeStavesNode(e,t){const s=e.addElement("Staves");for(const i of t.staves)this._writeStaffNode(s,i)}_writeStaffNode(e,t){const i=e.addElement("Staff").addElement("Properties");if(this._writeSimplePropertyNode(i,"CapoFret","Fret",t.capo.toString()),this._writeSimplePropertyNode(i,"FretCount","Fret","24"),t.tuning.length>0){const r=i.addElement("Property");switch(r.attributes.set("name","Tuning"),r.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),r.addElement("Label").setCData(t.tuningName),r.addElement("LabelVisible").innerText=t.tuningName?"true":"false",r.addElement("Flat"),t.tuning.length){case 3:r.addElement("Instrument").innerText="Shamisen";break;case 4:t.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program===42?r.addElement("Instrument").innerText="Cello":t.track.playbackInfo.program===43?r.addElement("Instrument").innerText="Contrabass":t.track.playbackInfo.program===40?r.addElement("Instrument").innerText="Violin":t.track.playbackInfo.program===41?r.addElement("Instrument").innerText="Viola":r.addElement("Instrument").innerText="Bass";break;case 5:t.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":r.addElement("Instrument").innerText="Bass";break;case 6:t.track.playbackInfo.program===105?r.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?r.addElement("Instrument").innerText="Bass":r.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?r.addElement("Instrument").innerText="Bass":r.addElement("Instrument").innerText="Guitar";break;default:r.addElement("Instrument").innerText="Guitar";break}}this._writeSimplePropertyNode(i,"PartialCapoFret","Fret","0"),this._writeSimplePropertyNode(i,"PartialCapoStringFlags","Bitset",t.tuning.map(r=>"0").join("")),this._writeSimplePropertyNode(i,"TuningFlat","Enable",null),this._writeDiagramCollection(i,t,"DiagramCollection"),this._writeDiagramCollection(i,t,"DiagramWorkingSet")}_writeDiagramCollection(e,t,s){const i=e.addElement("Property");i.attributes.set("name",s);const r=i.addElement("Items"),n=t.chords;if(n)for(const[o,l]of n){const h=r.addElement("Item");h.attributes.set("id",o),h.attributes.set("name",l.name);const c=h.addElement("Diagram");c.attributes.set("stringCount",l.strings.length.toString()),c.attributes.set("fretCount","5"),c.attributes.set("baseFret",(l.firstFret-1).toString()),c.attributes.set("barStates",l.strings.map(W=>"1").join(" "));const d=[],f=new Map;for(let W=0;W<l.strings.length;W++){const w=l.strings[W];if(w!==-1){const se=c.addElement("Fret"),Ne=l.strings.length-1-W;se.attributes.set("string",Ne.toString()),se.attributes.set("fret",(w-l.firstFret+1).toString()),f.has(w)||(f.set(w,[]),d.push(w)),f.get(w).push(Ne)}}d.sort();const p=c.addElement("Fingering");if(l.barreFrets.length>0){const W=[j.LittleFinger,j.AnnularFinger,j.MiddleFinger,j.IndexFinger];for(const w of d){const se=f.get(w);if(se.length>1&&l.barreFrets.indexOf(w)>=0){const Ne=W.length>0?W.pop():j.IndexFinger;for(const ye of se){const te=p.addElement("Position");switch(Ne){case j.LittleFinger:te.attributes.set("finger","Pinky");break;case j.AnnularFinger:te.attributes.set("finger","Ring");break;case j.MiddleFinger:te.attributes.set("finger","Middle");break;case j.IndexFinger:te.attributes.set("finger","Index");break}te.attributes.set("fret",(w-l.firstFret+1).toString()),te.attributes.set("string",ye.toString())}}}}const g=c.addElement("Property");g.attributes.set("name","ShowName"),g.attributes.set("type","bool"),g.attributes.set("value",l.showName?"true":"false");const m=c.addElement("Property");m.attributes.set("name","ShowDiagram"),m.attributes.set("type","bool"),m.attributes.set("value",l.showDiagram?"true":"false");const b=c.addElement("Property");b.attributes.set("name","ShowFingering"),b.attributes.set("type","bool"),b.attributes.set("value",l.showFingering?"true":"false");const S=c.addElement("Chord"),T=S.addElement("KeyNote");T.attributes.set("step","C"),T.attributes.set("accidental","Natural");const C=S.addElement("BassNote");C.attributes.set("step","C"),C.attributes.set("accidental","Natural");const v=S.addElement("Degree");v.attributes.set("interval","Third"),v.attributes.set("alteration","Major"),v.attributes.set("omitted","false");const G=S.addElement("Degree");G.attributes.set("interval","Fifth"),G.attributes.set("alteration","Perfect"),G.attributes.set("omitted","false")}}_writeSimplePropertyNode(e,t,s,i){const r=e.addElement("Property");r.attributes.set("name",t);const n=r.addElement(s);return i!==null&&(n.innerText=i),r}_writeSimpleXPropertyNode(e,t,s,i){const r=e.addElement("XProperty");r.attributes.set("id",t);const n=r.addElement(s);return i!==null&&(n.innerText=i),r}_writeLyricsNode(e,t){const s=e.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const r of t.staves[0].bars)for(const n of r.voices)if(!n.isEmpty){for(const o of n.beats)if(o.lyrics)for(let l=0;l<o.lyrics.length;l++){for(;l>=i.length;){const c=new $t;c.startBar=r.index,c.text="[Empty]",i.push(c)}const h=i[l];h.text=h.text==="[Empty]"?o.lyrics[l]:`${h.text} ${o.lyrics[l].split(" ").join("+")}`}}for(let r=0;r<i.length;r++){const n=s.addElement("Line");n.addElement("Text").setCData(i[r].text),n.addElement("Offset").innerText=i[r].startBar.toString()}}_writeTransposeNode(e,t){const s=e.addElement("Transpose"),i=Math.floor(t.staves[0].displayTranspositionPitch/12),r=t.staves[0].displayTranspositionPitch-i*12;s.addElement("Chromatic").innerText=r.toString(),s.addElement("Octave").innerText=i.toString()}_writeInstrumentSetNode(e,t){const s=e.addElement("InstrumentSet"),i=t.staves[0];if(s.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),t.percussionArticulations.length>0||i.isPercussion){const r=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(ht.instrumentArticulations.values());s.addElement("Name").innerText=_s._drumKitProgramInfo.instrumentSetName,s.addElement("Type").innerText=_s._drumKitProgramInfo.instrumentSetType;let n="",o=new gs;const l=new Map,h=s.addElement("Elements");for(const c of r){{const f=h.addElement("Element");let p=c.elementType;if(l.has(p)){const g=l.get(p);p+=` ${g}`,l.set(p,g+1)}else l.set(p,1);n=p,f.addElement("Name").innerText=p,f.addElement("Type").innerText=c.elementType,o=f.addElement("Articulations")}const d=o.addElement("Articulation");switch(d.addElement("Name").innerText=`${n} ${o.childNodes.length}`,d.addElement("StaffLine").innerText=c.staffLine.toString(),d.addElement("Noteheads").innerText=[this._mapMusicSymbol(c.noteHeadDefault),this._mapMusicSymbol(c.noteHeadHalf),this._mapMusicSymbol(c.noteHeadWhole)].join(" "),c.techniqueSymbolPlacement){case Ge.Below:d.addElement("TechniquePlacement").innerText="below";break;case Ge.Outside:d.addElement("TechniquePlacement").innerText="outside";break;case Ge.Inside:d.addElement("TechniquePlacement").innerText="inside";break;case Ge.Above:d.addElement("TechniquePlacement").innerText="above";break}d.addElement("TechniqueSymbol").innerText=this._mapMusicSymbol(c.techniqueSymbol),d.addElement("InputMidiNumbers").innerText="",d.addElement("OutputMidiNumber").innerText=c.outputMidiNumber.toString()}}else{const r=_s._midiProgramInfoLookup.has(t.playbackInfo.program)?_s._midiProgramInfoLookup.get(t.playbackInfo.program):_s._midiProgramInfoLookup.get(0);s.addElement("Name").innerText=r.instrumentSetName,s.addElement("Type").innerText=r.instrumentSetType;const o=s.addElement("Elements").addElement("Element");o.addElement("Pitched").innerText="Pitched",o.addElement("Type").innerText="pitched",o.addElement("SoundbankName").innerText="";const h=o.addElement("Articulations").addElement("Articulation");h.addElement("Name").innerText="",h.addElement("StaffLine").innerText="0",h.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",h.addElement("TechniquePlacement").innerText="outside",h.addElement("TechniqueSymbol").innerText="",h.addElement("InputMidiNumbers").innerText="",h.addElement("OutputRSESound").innerText="",h.addElement("OutputMidiNumber").innerText="0"}}_mapMusicSymbol(e){if(e===u.None)return"";const t=u[e];return t.substring(0,1).toLowerCase()+t.substring(1)}_writeMasterBarsNode(e,t){const s=e.addElement("MasterBars");for(const i of t.masterBars)this._writeMasterBarNode(s,i)}_writeMasterBarNode(e,t){const s=e.addElement("MasterBar"),i=s.addElement("Key");let r=t.score.tracks[0].staves[0].bars[t.index].keySignature;const n=t.score.tracks[0].staves[0].bars[t.index].keySignatureType,o=L.flooredDivision(t.score.tracks[0].staves[0].displayTranspositionPitch,12);r=L.transposeKey(r,-o),i.addElement("AccidentalCount").innerText=r.toString(),i.addElement("Mode").innerText=Qt[n],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${t.timeSignatureNumerator}/${t.timeSignatureDenominator}`,t.isFreeTime&&s.addElement("FreeTime");const l=[];for(const h of t.score.tracks)for(const c of h.staves)l.push(c.bars[t.index].id.toString());if(s.addElement("Bars").innerText=l.join(" "),t.isDoubleBar&&s.addElement("DoubleBar"),t.isSectionStart){const h=s.addElement("Section");h.addElement("Letter").setCData(t.section.marker),h.addElement("Text").setCData(t.section.text)}if(t.isRepeatStart||t.isRepeatEnd){const h=s.addElement("Repeat");h.attributes.set("start",t.isRepeatStart?"true":"false"),h.attributes.set("end",t.isRepeatEnd?"true":"false"),t.isRepeatEnd&&h.attributes.set("count",t.repeatCount.toString())}if(t.alternateEndings>0){let h=t.alternateEndings;const c=[];let d=0;for(;h>0;)(h>>d&1)===1&&(c.push(d+1),h&=~(1<<d)),d++;s.addElement("AlternateEndings").innerText=c.join(" ")}if(t.tripletFeel!==Be.NoTripletFeel&&(s.addElement("TripletFeel").innerText=Be[t.tripletFeel]),t.directions&&t.directions.size>0){const h=s.addElement("Directions");for(const c of t.directions)switch(c){case z.TargetFine:h.addElement("Target").innerText="Fine";break;case z.TargetSegno:h.addElement("Target").innerText="Segno";break;case z.TargetSegnoSegno:h.addElement("Target").innerText="SegnoSegno";break;case z.TargetCoda:h.addElement("Target").innerText="Coda";break;case z.TargetDoubleCoda:h.addElement("Target").innerText="DoubleCoda";break;case z.JumpDaCapo:h.addElement("Jump").innerText="DaCapo";break;case z.JumpDaCapoAlCoda:h.addElement("Jump").innerText="DaCapoAlCoda";break;case z.JumpDaCapoAlDoubleCoda:h.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case z.JumpDaCapoAlFine:h.addElement("Jump").innerText="DaCapoAlFine";break;case z.JumpDalSegno:h.addElement("Jump").innerText="DaSegno";break;case z.JumpDalSegnoAlCoda:h.addElement("Jump").innerText="DaSegnoAlCoda";break;case z.JumpDalSegnoAlDoubleCoda:h.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case z.JumpDalSegnoAlFine:h.addElement("Jump").innerText="DaSegnoAlFine";break;case z.JumpDalSegnoSegno:h.addElement("Jump").innerText="DaSegnoSegno";break;case z.JumpDalSegnoSegnoAlCoda:h.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case z.JumpDalSegnoSegnoAlDoubleCoda:h.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case z.JumpDalSegnoSegnoAlFine:h.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case z.JumpDaCoda:h.addElement("Jump").innerText="DaCoda";break;case z.JumpDaDoubleCoda:h.addElement("Jump").innerText="DaDoubleCoda";break}}this._writeFermatas(s,t)}_writeFermatas(e,t){const s=t.fermata?.size??0;if(s!==0&&s>0){const i=e.addElement("Fermatas");for(const[r,n]of t.fermata)this._writeFermata(i,r,n)}}_writeFermata(e,t,s){let i=-1,r=1;if(t>0)for(;r<10&&(i=t/x.QuarterTime*r,i!==Math.floor(i));)i=-1,r++;else i=0,r=1;if(i===-1)return;const n=e.addElement("Fermata");n.addElement("Type").innerText=jt[s.type],n.addElement("Length").innerText=s.length.toString(),n.addElement("Offset").innerText=`${i}/${r}`}_writeBarNode(e,t){const s=e.addElement("Bar");s.attributes.set("id",t.id.toString()),s.addElement("Voices").innerText=t.voices.map(i=>i.isEmpty?"-1":i.id.toString()).join(" "),s.addElement("Clef").innerText=Te[t.clef],t.clefOttava!==ae.Regular&&(s.addElement("Ottavia").innerText=ae[t.clefOttava].substr(1)),t.simileMark!==_t.None&&(s.addElement("SimileMark").innerText=_t[t.simileMark])}_writeVoiceNode(e,t){if(t.isEmpty)return;const s=e.addElement("Voice");s.attributes.set("id",t.id.toString()),s.addElement("Beats").innerText=t.beats.map(i=>i.id).join(" ")}}class Hr{static _crc32Lookup=Hr._buildCrc32Lookup();static _buildCrc32Lookup(){const t=new Uint32Array(256);for(let s=0;s<t.length;s++){let i=s;for(let r=0;r<8;r++)i=(i&1)===1?i>>>1^3988292384:i>>>1;t[s]=i}return t}static _crcInit=4294967295;_checkValue=Hr._crcInit;get value(){return~this._checkValue}constructor(){this.reset()}update(e,t,s){for(let i=0;i<s;i++)this._checkValue=Hr._crc32Lookup[(this._checkValue^e[t+i])&255]^this._checkValue>>>8}reset(){this._checkValue=Hr._crcInit}}class os{static maxWbits=15;static wsize=1<<os.maxWbits;static wmask=os.wsize-1;static minMatch=3;static maxMatch=258;static defaultMemLevel=8;static pendingBufSize=1<<os.defaultMemLevel+8;static hashBits=os.defaultMemLevel+7;static hashSize=1<<os.hashBits;static hashShift=(os.hashBits+os.minMatch-1)/os.minMatch;static hashMask=os.hashSize-1;static minLookahead=os.maxMatch+os.minMatch+1;static maxDist=os.wsize-os.minLookahead}class Js{static _repeat3To6=16;static _repeat3To10=17;static _repeat11To138=18;freqs;length=null;minNumCodes;numCodes=0;_codes=null;_bitLengthCounts;_maxLength;_huffman;constructor(e,t,s,i){this._huffman=e,this.minNumCodes=s,this._maxLength=i,this.freqs=new Int16Array(t),this._bitLengthCounts=new Int32Array(i)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this._codes=null,this.length=null}buildTree(){const e=this.freqs.length,t=new Int32Array(e);let s=0,i=0;for(let h=0;h<e;h++){const c=this.freqs[h];if(c!==0){let d=s++;for(;d>0;){const f=Math.floor((d-1)/2);if(this.freqs[t[f]]>c)t[d]=t[f],d=f;else break}t[d]=h,i=h}}for(;s<2;){const h=i<2?++i:0;t[s++]=h}this.numCodes=Math.max(i+1,this.minNumCodes);const r=s,n=new Int32Array(4*s-2),o=new Int32Array(2*s-1);let l=r;for(let h=0;h<s;h++){const c=t[h];n[2*h]=c,n[2*h+1]=-1,o[h]=this.freqs[c]<<8,t[h]=h}do{const h=t[0];let c=t[--s],d=0,f=1;for(;f<s;)f+1<s&&o[t[f]]>o[t[f+1]]&&f++,t[d]=t[f],d=f,f=f*2+1;let p=o[c];for(;f=d,d>0;)if(d=Math.floor((f-1)/2),o[t[d]]>p)t[f]=t[d];else break;t[f]=c;const g=t[0];c=l++,n[2*c]=h,n[2*c+1]=g;const m=Math.min(o[h]&255,o[g]&255);for(p=o[h]+o[g]-m+1,o[c]=p,d=0,f=1;f<s;)f+1<s&&o[t[f]]>o[t[f+1]]&&f++,t[d]=t[f],d=f,f=d*2+1;for(;f=d,f>0;)if(d=Math.floor((f-1)/2),o[t[d]]>p)t[f]=t[d];else break;t[f]=c}while(s>1);this._buildLength(n)}_buildLength(e){this.length=new Uint8Array(this.freqs.length);const t=Math.floor(e.length/2),s=Math.floor((t+1)/2);let i=0;for(let l=0;l<this._maxLength;l++)this._bitLengthCounts[l]=0;const r=new Int32Array(t);r[t-1]=0;for(let l=t-1;l>=0;l--)if(e[2*l+1]!==-1){let h=r[l]+1;h>this._maxLength&&(h=this._maxLength,i++),r[e[2*l]]=h,r[e[2*l+1]]=h}else{const h=r[l];this._bitLengthCounts[h-1]++,this.length[e[2*l]]=r[l]}if(i===0)return;let n=this._maxLength-1;do{for(;this._bitLengthCounts[--n]===0;);do this._bitLengthCounts[n]--,this._bitLengthCounts[++n]++,i-=1<<this._maxLength-1-n;while(i>0&&n<this._maxLength-1)}while(i>0);this._bitLengthCounts[this._maxLength-1]+=i,this._bitLengthCounts[this._maxLength-2]-=i;let o=2*s;for(let l=this._maxLength;l!==0;l--){let h=this._bitLengthCounts[l-1];for(;h>0;){const c=2*e[o++];e[c+1]===-1&&(this.length[e[c]]=l,h--)}}}getEncodedLength(){let e=0;for(let t=0;t<this.freqs.length;t++)e+=this.freqs[t]*this.length[t];return e}calcBLFreq(e){let t,s,i,r=-1,n=0;for(;n<this.numCodes;){i=1;const o=this.length[n];for(o===0?(t=138,s=3):(t=6,s=3,r!==o&&(e.freqs[o]++,i=0)),r=o,n++;n<this.numCodes&&r===this.length[n]&&(n++,!(++i>=t)););i<s?e.freqs[r]+=i:r!==0?e.freqs[Js._repeat3To6]++:i<=10?e.freqs[Js._repeat3To10]++:e.freqs[Js._repeat11To138]++}}setStaticCodes(e,t){this._codes=e,this.length=t}buildCodes(){const e=new Int32Array(this._maxLength);let t=0;this._codes=new Int16Array(this.freqs.length);for(let s=0;s<this._maxLength;s++)e[s]=t,t+=this._bitLengthCounts[s]<<15-s;for(let s=0;s<this.numCodes;s++){const i=this.length[s];i>0&&(this._codes[s]=xe.bitReverse(e[i-1]),e[i-1]+=1<<16-i)}}writeTree(e){let t,s,i,r=-1,n=0;for(;n<this.numCodes;){i=1;const o=this.length[n];for(o===0?(t=138,s=3):(t=6,s=3,r!==o&&(e.writeSymbol(o),i=0)),r=o,n++;n<this.numCodes&&r===this.length[n]&&(n++,!(++i>=t)););if(i<s)for(;i-- >0;)e.writeSymbol(r);else r!==0?(e.writeSymbol(Js._repeat3To6),this._huffman.pending.writeBits(i-3,2)):i<=10?(e.writeSymbol(Js._repeat3To10),this._huffman.pending.writeBits(i-3,3)):(e.writeSymbol(Js._repeat11To138),this._huffman.pending.writeBits(i-11,7))}}writeSymbol(e){this._huffman.pending.writeBits(this._codes[e]&65535,this.length[e])}}class xe{static _bufSize=1<<os.defaultMemLevel+6;static _literalNum=286;static storedBlock=0;static staticTrees=1;static dynTrees=2;static _distNum=30;static _staticLCodes=new Int16Array(xe._literalNum);static _staticLLength=new Uint8Array(xe._literalNum);static _staticDCodes=new Int16Array(xe._distNum);static _staticDLength=new Uint8Array(xe._distNum);static staticInit(){let e=0;for(;e<144;)xe._staticLCodes[e]=xe.bitReverse(48+e<<8),xe._staticLLength[e++]=8;for(;e<256;)xe._staticLCodes[e]=xe.bitReverse(256+e<<7),xe._staticLLength[e++]=9;for(;e<280;)xe._staticLCodes[e]=xe.bitReverse(-256+e<<9),xe._staticLLength[e++]=7;for(;e<xe._literalNum;)xe._staticLCodes[e]=xe.bitReverse(-88+e<<8),xe._staticLLength[e++]=8;for(e=0;e<xe._distNum;e++)xe._staticDCodes[e]=xe.bitReverse(e<<11),xe._staticDLength[e]=5}static _blOrder=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];static _bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]);static bitReverse(e){return xe._bit4Reverse[e&15]<<12|xe._bit4Reverse[e>>4&15]<<8|xe._bit4Reverse[e>>8&15]<<4|xe._bit4Reverse[e>>12]}static _bitLenNum=19;static _eofSymbol=256;pending;_literalTree;_distTree;_blTree;_dBuf;_lBuf;_lastLit=0;_extraBits=0;constructor(e){this.pending=e,this._literalTree=new Js(this,xe._literalNum,257,15),this._distTree=new Js(this,xe._distNum,1,15),this._blTree=new Js(this,xe._bitLenNum,4,7),this._dBuf=new Int16Array(xe._bufSize),this._lBuf=new Uint8Array(xe._bufSize)}isFull(){return this._lastLit>=xe._bufSize}reset(){this._lastLit=0,this._extraBits=0,this._literalTree.reset(),this._distTree.reset(),this._blTree.reset()}flushStoredBlock(e,t,s,i){this.pending.writeBits((xe.storedBlock<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(e,t,s),this.reset()}flushBlock(e,t,s,i){this._literalTree.freqs[xe._eofSymbol]++,this._literalTree.buildTree(),this._distTree.buildTree(),this._literalTree.calcBLFreq(this._blTree),this._distTree.calcBLFreq(this._blTree),this._blTree.buildTree();let r=4;for(let l=18;l>r;l--)this._blTree.length[xe._blOrder[l]]>0&&(r=l+1);let n=14+r*3+this._blTree.getEncodedLength()+this._literalTree.getEncodedLength()+this._distTree.getEncodedLength()+this._extraBits,o=this._extraBits;for(let l=0;l<xe._literalNum;l++)o+=this._literalTree.freqs[l]*xe._staticLLength[l];for(let l=0;l<xe._distNum;l++)o+=this._distTree.freqs[l]*xe._staticDLength[l];n>=o&&(n=o),t>=0&&s+4<n>>3?this.flushStoredBlock(e,t,s,i):n===o?(this.pending.writeBits((xe.staticTrees<<1)+(i?1:0),3),this._literalTree.setStaticCodes(xe._staticLCodes,xe._staticLLength),this._distTree.setStaticCodes(xe._staticDCodes,xe._staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((xe.dynTrees<<1)+(i?1:0),3),this.sendAllTrees(r),this.compressBlock(),this.reset())}sendAllTrees(e){this._blTree.buildCodes(),this._literalTree.buildCodes(),this._distTree.buildCodes(),this.pending.writeBits(this._literalTree.numCodes-257,5),this.pending.writeBits(this._distTree.numCodes-1,5),this.pending.writeBits(e-4,4);for(let t=0;t<e;t++)this.pending.writeBits(this._blTree.length[xe._blOrder[t]],3);this._literalTree.writeTree(this._blTree),this._distTree.writeTree(this._blTree)}compressBlock(){for(let e=0;e<this._lastLit;e++){const t=this._lBuf[e]&255;let s=this._dBuf[e];if(s--!==0){const i=xe._lCode(t);this._literalTree.writeSymbol(i);let r=Math.floor((i-261)/4);r>0&&r<=5&&this.pending.writeBits(t&(1<<r)-1,r);const n=xe._dCode(s);this._distTree.writeSymbol(n),r=Math.floor(n/2)-1,r>0&&this.pending.writeBits(s&(1<<r)-1,r)}else this._literalTree.writeSymbol(t)}this._literalTree.writeSymbol(xe._eofSymbol)}tallyDist(e,t){this._dBuf[this._lastLit]=e,this._lBuf[this._lastLit++]=t-3;const s=xe._lCode(t-3);this._literalTree.freqs[s]++,s>=265&&s<285&&(this._extraBits+=Math.floor((s-261)/4));const i=xe._dCode(e-1);return this._distTree.freqs[i]++,i>=4&&(this._extraBits+=Math.floor(i/2)-1),this.isFull()}tallyLit(e){return this._dBuf[this._lastLit]=0,this._lBuf[this._lastLit++]=e,this._literalTree.freqs[e]++,this.isFull()}static _lCode(e){if(e===255)return 285;let t=257;for(;e>=8;)t+=4,e=e>>1;return t+e}static _dCode(e){let t=0;for(;e>=4;)t+=2,e=e>>1;return t+e}}xe.staticInit();var Sl;(function(a){a[a.SequenceNumber=0]="SequenceNumber",a[a.TextEvent=1]="TextEvent",a[a.CopyrightNotice=2]="CopyrightNotice",a[a.SequenceOrTrackName=3]="SequenceOrTrackName",a[a.InstrumentName=4]="InstrumentName",a[a.LyricText=5]="LyricText",a[a.MarkerText=6]="MarkerText",a[a.CuePoint=7]="CuePoint",a[a.PatchName=8]="PatchName",a[a.PortName=9]="PortName",a[a.MidiChannel=32]="MidiChannel",a[a.MidiPort=33]="MidiPort",a[a.EndOfTrack=47]="EndOfTrack",a[a.Tempo=81]="Tempo",a[a.SmpteOffset=84]="SmpteOffset",a[a.TimeSignature=88]="TimeSignature",a[a.KeySignature=89]="KeySignature",a[a.SequencerSpecific=127]="SequencerSpecific"})(Sl||(Sl={}));var kl;(function(a){a[a.SystemExclusive=240]="SystemExclusive",a[a.MtcQuarterFrame=241]="MtcQuarterFrame",a[a.SongPosition=242]="SongPosition",a[a.SongSelect=243]="SongSelect",a[a.TuneRequest=246]="TuneRequest",a[a.SystemExclusive2=247]="SystemExclusive2"})(kl||(kl={}));var wl;(function(a){a[a.MetronomeTick=0]="MetronomeTick",a[a.Rest=1]="Rest"})(wl||(wl={}));F.initializeAudioWorklet()})();
